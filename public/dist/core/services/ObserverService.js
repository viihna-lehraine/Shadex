// File: core/services/ObserverService.ts
const caller = 'ObserverService';
export class ObserverService {
    data;
    debounceOptions;
    #listeners = {};
    #debounceTimers = {};
    #errors;
    #helpers;
    #log;
    constructor(data, debounceOptions = {}, helpers, services) {
        this.data = data;
        this.debounceOptions = debounceOptions;
        try {
            services.log.debug(`Constructing Observer instance`, `${caller} constructor`);
            this.#errors = services.errors;
            this.#log = services.log;
            this.#helpers = helpers;
            this.data = this.#deepObserve(this.data);
        }
        catch (error) {
            throw new Error(`[${caller} constructor]: ${error instanceof Error ? error.message : error}`);
        }
    }
    batchUpdate(updates) {
        return this.#errors.handleSync(() => {
            this.#log.debug(`Performing batch update. Updates: ${JSON.stringify(this.#helpers.data.clone(updates))}`, `${caller}.batchUpdate`);
            Object.entries(updates).forEach(([key, value]) => {
                this.set(key, value);
            });
        }, `[${caller}]: Error performing batch update.`);
    }
    get(prop) {
        return this.#errors.handleSync(() => {
            return this.#helpers.data.clone(this.data[prop]);
        }, `[${caller}]: Error getting data.`);
    }
    getData() {
        return this.#errors.handleSync(() => {
            return this.#helpers.data.clone(this.data);
        }, `[${caller}]: Error getting data.`);
    }
    off(prop, callback) {
        return this.#errors.handleSync(() => {
            this.#listeners[prop] =
                this.#listeners[prop]?.filter(cb => cb !== callback) ?? [];
        }, `[${caller}]: Error removing listener.`);
    }
    on(prop, callback) {
        return this.#errors.handleSync(() => {
            if (!this.#listeners[prop]) {
                this.#listeners[prop] = [];
            }
            this.#listeners[prop].push(callback);
        }, `[${caller}]: Error adding listener.`);
    }
    replaceData(newData) {
        return this.#errors.handleSync(() => {
            const oldData = this.data;
            this.data = this.#deepObserve(newData);
            // notify listeners of all changed properties
            Object.keys(newData).forEach(key => {
                const prop = key;
                const newValue = newData[prop];
                const oldValue = oldData[prop];
                const clonedNewValue = this.#helpers.data.clone(newValue);
                const clonedOldValue = this.#helpers.data.clone(oldValue);
                // notify only if values differ
                if (JSON.stringify(clonedNewValue) !==
                    JSON.stringify(clonedOldValue)) {
                    this.#triggerNotify(prop, newValue, oldValue);
                }
                // notify listeners for removed properties
                Object.keys(oldData).forEach(key => {
                    if (!(key in newData)) {
                        const prop = key;
                        this.#triggerNotify(prop, undefined, oldData[prop]);
                    }
                });
            });
            this.#log.debug(`Observer data replaced and listeners notified.`, `${caller}.replaceData`);
        }, `[${caller}.replaceData]: Error replacing data.`);
    }
    set(prop, value) {
        return this.#errors.handleSync(() => {
            const oldValue = this.#helpers.data.clone(this.data[prop]);
            this.data[prop] = this.#helpers.data.clone(value);
            this.#triggerNotify(prop, this.data[prop], oldValue);
        }, `[${caller}]: Error setting data.`);
    }
    setData(newData, debounceOptions, helpers, services) {
        return new ObserverService(newData, debounceOptions, helpers, services);
    }
    #deepObserve(obj) {
        return this.#errors.handleSync(() => {
            if (typeof obj !== 'object' || obj === null) {
                return obj;
            }
            // recursively proxy nested objects
            return new Proxy(obj, {
                get: (target, prop) => {
                    const value = target[prop];
                    return typeof value === 'object' && value !== null
                        ? this.#deepObserve(value)
                        : value;
                },
                set: (target, prop, value) => {
                    if (Object.prototype.hasOwnProperty.call(target, prop)) {
                        const oldValue = target[prop];
                        target[prop] = value;
                        this.#triggerNotify(prop, value, oldValue);
                    }
                    return true;
                },
                deleteProperty: (target, prop) => {
                    if (Object.prototype.hasOwnProperty.call(target, prop)) {
                        const oldValue = target[prop];
                        delete target[prop];
                        this.#triggerNotify(prop, undefined, oldValue);
                    }
                    return true;
                }
            });
        }, `[${caller}]: Error observing data.`);
    }
    #notify(prop, newValue, oldValue) {
        return this.#errors.handleSync(() => {
            this.#listeners[prop]?.forEach(callback => callback(newValue, oldValue));
        }, `[${caller}]: Error notifying listeners.`);
    }
    #triggerNotify(prop, newValue, oldValue) {
        return this.#errors.handleSync(() => {
            const delay = this.debounceOptions.delay ?? 0;
            if (delay > 0) {
                clearTimeout(this.#debounceTimers[prop]);
                this.#debounceTimers[prop] = setTimeout(() => {
                    this.#notify(prop, newValue, oldValue);
                }, delay);
            }
            else {
                this.#notify(prop, newValue, oldValue);
            }
        }, `[${caller}]: Error triggering notification.`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2JzZXJ2ZXJTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvcmUvc2VydmljZXMvT2JzZXJ2ZXJTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHlDQUF5QztBQVV6QyxNQUFNLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQztBQUVqQyxNQUFNLE9BQU8sZUFBZTtJQVdsQjtJQUNBO0lBVFQsVUFBVSxHQUEwQyxFQUFFLENBQUM7SUFDdkQsZUFBZSxHQUE2QyxFQUFFLENBQUM7SUFFL0QsT0FBTyxDQUFxQjtJQUM1QixRQUFRLENBQVU7SUFDbEIsSUFBSSxDQUFrQjtJQUV0QixZQUNTLElBQU8sRUFDUCxrQkFBbUMsRUFBRSxFQUM3QyxPQUFnQixFQUNoQixRQUFrQjtRQUhWLFNBQUksR0FBSixJQUFJLENBQUc7UUFDUCxvQkFBZSxHQUFmLGVBQWUsQ0FBc0I7UUFJN0MsSUFBSSxDQUFDO1lBQ0osUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQ2pCLGdDQUFnQyxFQUNoQyxHQUFHLE1BQU0sY0FBYyxDQUN2QixDQUFDO1lBRUYsSUFBSSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQy9CLElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQztZQUN6QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztZQUV4QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQ2QsSUFBSSxNQUFNLGtCQUFrQixLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FDNUUsQ0FBQztRQUNILENBQUM7SUFDRixDQUFD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LENBQUMsQ0FDNUIsQ0FBQztRQUNILENBQUMsRUFBRSxJQUFJLE1BQU0sK0JBQStCLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUQsY0FBYyxDQUNiLElBQU8sRUFDUCxRQUFjLEVBQ2QsUUFBYztRQUVkLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ25DLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztZQUU5QyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDZixZQUFZLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUV6QyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7b0JBQzVDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDeEMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ1gsQ0FBQztpQkFBTSxDQUFDO2dCQUNQLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN4QyxDQUFDO1FBQ0YsQ0FBQyxFQUFFLElBQUksTUFBTSxtQ0FBbUMsQ0FBQyxDQUFDO0lBQ25ELENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IGNvcmUvc2VydmljZXMvT2JzZXJ2ZXJTZXJ2aWNlLnRzXG5cbmltcG9ydCB7XG5cdERlYm91bmNlT3B0aW9ucyxcblx0SGVscGVycyxcblx0TGlzdGVuZXIsXG5cdE9ic2VydmVyQ29udHJhY3QsXG5cdFNlcnZpY2VzXG59IGZyb20gJy4uLy4uL3R5cGVzL2luZGV4LmpzJztcblxuY29uc3QgY2FsbGVyID0gJ09ic2VydmVyU2VydmljZSc7XG5cbmV4cG9ydCBjbGFzcyBPYnNlcnZlclNlcnZpY2U8VCBleHRlbmRzIFJlY29yZDxzdHJpbmcsIHVua25vd24+PlxuXHRpbXBsZW1lbnRzIE9ic2VydmVyQ29udHJhY3Q8VD5cbntcblx0I2xpc3RlbmVyczogeyBbUCBpbiBrZXlvZiBUXT86IExpc3RlbmVyPFRbUF0+W10gfSA9IHt9O1xuXHQjZGVib3VuY2VUaW1lcnM6IFBhcnRpYWw8UmVjb3JkPGtleW9mIFQsIE5vZGVKUy5UaW1lb3V0Pj4gPSB7fTtcblxuXHQjZXJyb3JzOiBTZXJ2aWNlc1snZXJyb3JzJ107XG5cdCNoZWxwZXJzOiBIZWxwZXJzO1xuXHQjbG9nOiBTZXJ2aWNlc1snbG9nJ107XG5cblx0Y29uc3RydWN0b3IoXG5cdFx0cHJpdmF0ZSBkYXRhOiBULFxuXHRcdHByaXZhdGUgZGVib3VuY2VPcHRpb25zOiBEZWJvdW5jZU9wdGlvbnMgPSB7fSxcblx0XHRoZWxwZXJzOiBIZWxwZXJzLFxuXHRcdHNlcnZpY2VzOiBTZXJ2aWNlc1xuXHQpIHtcblx0XHR0cnkge1xuXHRcdFx0c2VydmljZXMubG9nLmRlYnVnKFxuXHRcdFx0XHRgQ29uc3RydWN0aW5nIE9ic2VydmVyIGluc3RhbmNlYCxcblx0XHRcdFx0YCR7Y2FsbGVyfSBjb25zdHJ1Y3RvcmBcblx0XHRcdCk7XG5cblx0XHRcdHRoaXMuI2Vycm9ycyA9IHNlcnZpY2VzLmVycm9ycztcblx0XHRcdHRoaXMuI2xvZyA9IHNlcnZpY2VzLmxvZztcblx0XHRcdHRoaXMuI2hlbHBlcnMgPSBoZWxwZXJzO1xuXG5cdFx0XHR0aGlzLmRhdGEgPSB0aGlzLiNkZWVwT2JzZXJ2ZSh0aGlzLmRhdGEpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXG5cdFx0XHRcdGBbJHtjYWxsZXJ9IGNvbnN0cnVjdG9yXTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yfWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0YmF0Y2hVcGRhdGUodXBkYXRlczogUGFydGlhbDxUPik6IHZvaWQge1xuXHRcdHJldHVybiB0aGlzLiNlcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHR0aGlzLiNsb2cuZGVidWcoXG5cdFx0XHRcdGBQZXJmb3JtaW5nIGJhdGNoIHVwZGF0ZS4gVXBkYXRlczogJHtKU09OLnN0cmluZ2lmeSh0aGlzLiNoZWxwZXJzLmRhdGEuY2xvbmUodXBkYXRlcykpfWAsXG5cdFx0XHRcdGAke2NhbGxlcn0uYmF0Y2hVcGRhdGVgXG5cdFx0XHQpO1xuXG5cdFx0XHRPYmplY3QuZW50cmllcyh1cGRhdGVzKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcblx0XHRcdFx0dGhpcy5zZXQoa2V5IGFzIGtleW9mIFQsIHZhbHVlIGFzIFRba2V5b2YgVF0pO1xuXHRcdFx0fSk7XG5cdFx0fSwgYFske2NhbGxlcn1dOiBFcnJvciBwZXJmb3JtaW5nIGJhdGNoIHVwZGF0ZS5gKTtcblx0fVxuXG5cdGdldDxLIGV4dGVuZHMga2V5b2YgVD4ocHJvcDogSyk6IFRbS10ge1xuXHRcdHJldHVybiB0aGlzLiNlcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHRyZXR1cm4gdGhpcy4jaGVscGVycy5kYXRhLmNsb25lKHRoaXMuZGF0YVtwcm9wXSk7XG5cdFx0fSwgYFske2NhbGxlcn1dOiBFcnJvciBnZXR0aW5nIGRhdGEuYCk7XG5cdH1cblxuXHRnZXREYXRhKCk6IFQge1xuXHRcdHJldHVybiB0aGlzLiNlcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHRyZXR1cm4gdGhpcy4jaGVscGVycy5kYXRhLmNsb25lKHRoaXMuZGF0YSk7XG5cdFx0fSwgYFske2NhbGxlcn1dOiBFcnJvciBnZXR0aW5nIGRhdGEuYCk7XG5cdH1cblxuXHRvZmY8SyBleHRlbmRzIGtleW9mIFQ+KHByb3A6IEssIGNhbGxiYWNrOiBMaXN0ZW5lcjxUW0tdPik6IHZvaWQge1xuXHRcdHJldHVybiB0aGlzLiNlcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHR0aGlzLiNsaXN0ZW5lcnNbcHJvcF0gPVxuXHRcdFx0XHR0aGlzLiNsaXN0ZW5lcnNbcHJvcF0/LmZpbHRlcihjYiA9PiBjYiAhPT0gY2FsbGJhY2spID8/IFtdO1xuXHRcdH0sIGBbJHtjYWxsZXJ9XTogRXJyb3IgcmVtb3ZpbmcgbGlzdGVuZXIuYCk7XG5cdH1cblxuXHRvbjxLIGV4dGVuZHMga2V5b2YgVD4ocHJvcDogSywgY2FsbGJhY2s6IExpc3RlbmVyPFRbS10+KTogdm9pZCB7XG5cdFx0cmV0dXJuIHRoaXMuI2Vycm9ycy5oYW5kbGVTeW5jKCgpID0+IHtcblx0XHRcdGlmICghdGhpcy4jbGlzdGVuZXJzW3Byb3BdKSB7XG5cdFx0XHRcdHRoaXMuI2xpc3RlbmVyc1twcm9wXSA9IFtdO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLiNsaXN0ZW5lcnNbcHJvcF0hLnB1c2goY2FsbGJhY2spO1xuXHRcdH0sIGBbJHtjYWxsZXJ9XTogRXJyb3IgYWRkaW5nIGxpc3RlbmVyLmApO1xuXHR9XG5cblx0cmVwbGFjZURhdGEobmV3RGF0YTogVCk6IHZvaWQge1xuXHRcdHJldHVybiB0aGlzLiNlcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHRjb25zdCBvbGREYXRhID0gdGhpcy5kYXRhO1xuXHRcdFx0dGhpcy5kYXRhID0gdGhpcy4jZGVlcE9ic2VydmUobmV3RGF0YSk7XG5cblx0XHRcdC8vIG5vdGlmeSBsaXN0ZW5lcnMgb2YgYWxsIGNoYW5nZWQgcHJvcGVydGllc1xuXHRcdFx0T2JqZWN0LmtleXMobmV3RGF0YSkuZm9yRWFjaChrZXkgPT4ge1xuXHRcdFx0XHRjb25zdCBwcm9wID0ga2V5IGFzIGtleW9mIFQ7XG5cdFx0XHRcdGNvbnN0IG5ld1ZhbHVlID0gbmV3RGF0YVtwcm9wXTtcblx0XHRcdFx0Y29uc3Qgb2xkVmFsdWUgPSBvbGREYXRhW3Byb3BdO1xuXG5cdFx0XHRcdGNvbnN0IGNsb25lZE5ld1ZhbHVlID0gdGhpcy4jaGVscGVycy5kYXRhLmNsb25lKG5ld1ZhbHVlKTtcblx0XHRcdFx0Y29uc3QgY2xvbmVkT2xkVmFsdWUgPSB0aGlzLiNoZWxwZXJzLmRhdGEuY2xvbmUob2xkVmFsdWUpO1xuXG5cdFx0XHRcdC8vIG5vdGlmeSBvbmx5IGlmIHZhbHVlcyBkaWZmZXJcblx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdEpTT04uc3RyaW5naWZ5KGNsb25lZE5ld1ZhbHVlKSAhPT1cblx0XHRcdFx0XHRKU09OLnN0cmluZ2lmeShjbG9uZWRPbGRWYWx1ZSlcblx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0dGhpcy4jdHJpZ2dlck5vdGlmeShwcm9wLCBuZXdWYWx1ZSwgb2xkVmFsdWUpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Ly8gbm90aWZ5IGxpc3RlbmVycyBmb3IgcmVtb3ZlZCBwcm9wZXJ0aWVzXG5cdFx0XHRcdE9iamVjdC5rZXlzKG9sZERhdGEpLmZvckVhY2goa2V5ID0+IHtcblx0XHRcdFx0XHRpZiAoIShrZXkgaW4gbmV3RGF0YSkpIHtcblx0XHRcdFx0XHRcdGNvbnN0IHByb3AgPSBrZXkgYXMga2V5b2YgVDtcblx0XHRcdFx0XHRcdHRoaXMuI3RyaWdnZXJOb3RpZnkoXG5cdFx0XHRcdFx0XHRcdHByb3AsXG5cdFx0XHRcdFx0XHRcdHVuZGVmaW5lZCBhcyBUW2tleW9mIFRdLFxuXHRcdFx0XHRcdFx0XHRvbGREYXRhW3Byb3BdXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0XHR9KTtcblxuXHRcdFx0dGhpcy4jbG9nLmRlYnVnKFxuXHRcdFx0XHRgT2JzZXJ2ZXIgZGF0YSByZXBsYWNlZCBhbmQgbGlzdGVuZXJzIG5vdGlmaWVkLmAsXG5cdFx0XHRcdGAke2NhbGxlcn0ucmVwbGFjZURhdGFgXG5cdFx0XHQpO1xuXHRcdH0sIGBbJHtjYWxsZXJ9LnJlcGxhY2VEYXRhXTogRXJyb3IgcmVwbGFjaW5nIGRhdGEuYCk7XG5cdH1cblxuXHRzZXQ8SyBleHRlbmRzIGtleW9mIFQ+KHByb3A6IEssIHZhbHVlOiBUW0tdKTogdm9pZCB7XG5cdFx0cmV0dXJuIHRoaXMuI2Vycm9ycy5oYW5kbGVTeW5jKCgpID0+IHtcblx0XHRcdGNvbnN0IG9sZFZhbHVlID0gdGhpcy4jaGVscGVycy5kYXRhLmNsb25lKHRoaXMuZGF0YVtwcm9wXSk7XG5cblx0XHRcdHRoaXMuZGF0YVtwcm9wXSA9IHRoaXMuI2hlbHBlcnMuZGF0YS5jbG9uZSh2YWx1ZSk7XG5cblx0XHRcdHRoaXMuI3RyaWdnZXJOb3RpZnkocHJvcCwgdGhpcy5kYXRhW3Byb3BdLCBvbGRWYWx1ZSk7XG5cdFx0fSwgYFske2NhbGxlcn1dOiBFcnJvciBzZXR0aW5nIGRhdGEuYCk7XG5cdH1cblxuXHRzZXREYXRhPFUgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPj4oXG5cdFx0bmV3RGF0YTogVSxcblx0XHRkZWJvdW5jZU9wdGlvbnM6IERlYm91bmNlT3B0aW9ucyxcblx0XHRoZWxwZXJzOiBIZWxwZXJzLFxuXHRcdHNlcnZpY2VzOiBTZXJ2aWNlc1xuXHQpOiBPYnNlcnZlclNlcnZpY2U8VT4ge1xuXHRcdHJldHVybiBuZXcgT2JzZXJ2ZXJTZXJ2aWNlKG5ld0RhdGEsIGRlYm91bmNlT3B0aW9ucywgaGVscGVycywgc2VydmljZXMpO1xuXHR9XG5cblx0I2RlZXBPYnNlcnZlKG9iajogVCk6IFQge1xuXHRcdHJldHVybiB0aGlzLiNlcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHRpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsKSB7XG5cdFx0XHRcdHJldHVybiBvYmo7XG5cdFx0XHR9XG5cblx0XHRcdC8vIHJlY3Vyc2l2ZWx5IHByb3h5IG5lc3RlZCBvYmplY3RzXG5cdFx0XHRyZXR1cm4gbmV3IFByb3h5KG9iaiBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiwge1xuXHRcdFx0XHRnZXQ6ICh0YXJnZXQsIHByb3A6IHN0cmluZykgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHZhbHVlID0gdGFyZ2V0W3Byb3BdO1xuXG5cdFx0XHRcdFx0cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgIT09IG51bGxcblx0XHRcdFx0XHRcdD8gdGhpcy4jZGVlcE9ic2VydmUodmFsdWUgYXMgVClcblx0XHRcdFx0XHRcdDogdmFsdWU7XG5cdFx0XHRcdH0sXG5cdFx0XHRcdHNldDogKHRhcmdldCwgcHJvcDogc3RyaW5nLCB2YWx1ZSkgPT4ge1xuXHRcdFx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGFyZ2V0LCBwcm9wKSkge1xuXHRcdFx0XHRcdFx0Y29uc3Qgb2xkVmFsdWUgPSB0YXJnZXRbcHJvcF07XG5cblx0XHRcdFx0XHRcdHRhcmdldFtwcm9wXSA9IHZhbHVlO1xuXG5cdFx0XHRcdFx0XHR0aGlzLiN0cmlnZ2VyTm90aWZ5KFxuXHRcdFx0XHRcdFx0XHRwcm9wIGFzIGtleW9mIFQsXG5cdFx0XHRcdFx0XHRcdHZhbHVlIGFzIFRba2V5b2YgVF0sXG5cdFx0XHRcdFx0XHRcdG9sZFZhbHVlIGFzIFRba2V5b2YgVF1cblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0XHR9LFxuXHRcdFx0XHRkZWxldGVQcm9wZXJ0eTogKHRhcmdldCwgcHJvcDogc3RyaW5nKSA9PiB7XG5cdFx0XHRcdFx0aWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0YXJnZXQsIHByb3ApKSB7XG5cdFx0XHRcdFx0XHRjb25zdCBvbGRWYWx1ZSA9IHRhcmdldFtwcm9wXTtcblxuXHRcdFx0XHRcdFx0ZGVsZXRlIHRhcmdldFtwcm9wXTtcblxuXHRcdFx0XHRcdFx0dGhpcy4jdHJpZ2dlck5vdGlmeShcblx0XHRcdFx0XHRcdFx0cHJvcCBhcyBrZXlvZiBULFxuXHRcdFx0XHRcdFx0XHR1bmRlZmluZWQgYXMgVFtrZXlvZiBUXSxcblx0XHRcdFx0XHRcdFx0b2xkVmFsdWUgYXMgVFtrZXlvZiBUXVxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHRcdH1cblx0XHRcdH0pIGFzIFQ7XG5cdFx0fSwgYFske2NhbGxlcn1dOiBFcnJvciBvYnNlcnZpbmcgZGF0YS5gKTtcblx0fVxuXG5cdCNub3RpZnk8SyBleHRlbmRzIGtleW9mIFQ+KHByb3A6IEssIG5ld1ZhbHVlOiBUW0tdLCBvbGRWYWx1ZTogVFtLXSkge1xuXHRcdHJldHVybiB0aGlzLiNlcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHR0aGlzLiNsaXN0ZW5lcnNbcHJvcF0/LmZvckVhY2goY2FsbGJhY2sgPT5cblx0XHRcdFx0Y2FsbGJhY2sobmV3VmFsdWUsIG9sZFZhbHVlKVxuXHRcdFx0KTtcblx0XHR9LCBgWyR7Y2FsbGVyfV06IEVycm9yIG5vdGlmeWluZyBsaXN0ZW5lcnMuYCk7XG5cdH1cblxuXHQjdHJpZ2dlck5vdGlmeTxLIGV4dGVuZHMga2V5b2YgVD4oXG5cdFx0cHJvcDogSyxcblx0XHRuZXdWYWx1ZTogVFtLXSxcblx0XHRvbGRWYWx1ZTogVFtLXVxuXHQpOiB2b2lkIHtcblx0XHRyZXR1cm4gdGhpcy4jZXJyb3JzLmhhbmRsZVN5bmMoKCkgPT4ge1xuXHRcdFx0Y29uc3QgZGVsYXkgPSB0aGlzLmRlYm91bmNlT3B0aW9ucy5kZWxheSA/PyAwO1xuXG5cdFx0XHRpZiAoZGVsYXkgPiAwKSB7XG5cdFx0XHRcdGNsZWFyVGltZW91dCh0aGlzLiNkZWJvdW5jZVRpbWVyc1twcm9wXSk7XG5cblx0XHRcdFx0dGhpcy4jZGVib3VuY2VUaW1lcnNbcHJvcF0gPSBzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0XHR0aGlzLiNub3RpZnkocHJvcCwgbmV3VmFsdWUsIG9sZFZhbHVlKTtcblx0XHRcdFx0fSwgZGVsYXkpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy4jbm90aWZ5KHByb3AsIG5ld1ZhbHVlLCBvbGRWYWx1ZSk7XG5cdFx0XHR9XG5cdFx0fSwgYFske2NhbGxlcn1dOiBFcnJvciB0cmlnZ2VyaW5nIG5vdGlmaWNhdGlvbi5gKTtcblx0fVxufVxuIl19