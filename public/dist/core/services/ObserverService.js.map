{"version":3,"file":"ObserverService.js","sources":["../../../../../src/core/services/ObserverService.ts"],"sourcesContent":["// File: core/services/ObserverService.ts\n\nimport {\n\tDebounceOptions,\n\tHelpers,\n\tListener,\n\tObserverContract,\n\tServices\n} from '../../types/index.js';\n\nconst caller = 'ObserverService';\n\nexport class ObserverService<T extends Record<string, unknown>>\n\timplements ObserverContract<T>\n{\n\t#listeners: { [P in keyof T]?: Listener<T[P]>[] } = {};\n\t#debounceTimers: Partial<Record<keyof T, NodeJS.Timeout>> = {};\n\n\t#errors: Services['errors'];\n\t#helpers: Helpers;\n\t#log: Services['log'];\n\n\tconstructor(\n\t\tprivate data: T,\n\t\tprivate debounceOptions: DebounceOptions = {},\n\t\thelpers: Helpers,\n\t\tservices: Services\n\t) {\n\t\ttry {\n\t\t\tservices.log.debug(\n\t\t\t\t`Constructing Observer instance`,\n\t\t\t\t`${caller} constructor`\n\t\t\t);\n\n\t\t\tthis.#errors = services.errors;\n\t\t\tthis.#log = services.log;\n\t\t\tthis.#helpers = helpers;\n\n\t\t\tthis.data = this.#deepObserve(this.data);\n\t\t} catch (error) {\n\t\t\tthrow new Error(\n\t\t\t\t`[${caller} constructor]: ${error instanceof Error ? error.message : error}`\n\t\t\t);\n\t\t}\n\t}\n\n\tbatchUpdate(updates: Partial<T>): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tthis.#log.debug(\n\t\t\t\t`Performing batch update. Updates: ${JSON.stringify(this.#helpers.data.clone(updates))}`,\n\t\t\t\t`${caller}.batchUpdate`\n\t\t\t);\n\n\t\t\tObject.entries(updates).forEach(([key, value]) => {\n\t\t\t\tthis.set(key as keyof T, value as T[keyof T]);\n\t\t\t});\n\t\t}, `[${caller}]: Error performing batch update.`);\n\t}\n\n\tget<K extends keyof T>(prop: K): T[K] {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\treturn this.#helpers.data.clone(this.data[prop]);\n\t\t}, `[${caller}]: Error getting data.`);\n\t}\n\n\tgetData(): T {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\treturn this.#helpers.data.clone(this.data);\n\t\t}, `[${caller}]: Error getting data.`);\n\t}\n\n\toff<K extends keyof T>(prop: K, callback: Listener<T[K]>): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tthis.#listeners[prop] =\n\t\t\t\tthis.#listeners[prop]?.filter(cb => cb !== callback) ?? [];\n\t\t}, `[${caller}]: Error removing listener.`);\n\t}\n\n\ton<K extends keyof T>(prop: K, callback: Listener<T[K]>): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tif (!this.#listeners[prop]) {\n\t\t\t\tthis.#listeners[prop] = [];\n\t\t\t}\n\n\t\t\tthis.#listeners[prop]!.push(callback);\n\t\t}, `[${caller}]: Error adding listener.`);\n\t}\n\n\treplaceData(newData: T): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tconst oldData = this.data;\n\t\t\tthis.data = this.#deepObserve(newData);\n\n\t\t\t// notify listeners of all changed properties\n\t\t\tObject.keys(newData).forEach(key => {\n\t\t\t\tconst prop = key as keyof T;\n\t\t\t\tconst newValue = newData[prop];\n\t\t\t\tconst oldValue = oldData[prop];\n\n\t\t\t\tconst clonedNewValue = this.#helpers.data.clone(newValue);\n\t\t\t\tconst clonedOldValue = this.#helpers.data.clone(oldValue);\n\n\t\t\t\t// notify only if values differ\n\t\t\t\tif (JSON.stringify(clonedNewValue) !== JSON.stringify(clonedOldValue)) {\n\t\t\t\t\tthis.#triggerNotify(prop, newValue, oldValue);\n\t\t\t\t}\n\n\t\t\t\t// notify listeners for removed properties\n\t\t\t\tObject.keys(oldData).forEach(key => {\n\t\t\t\t\tif (!(key in newData)) {\n\t\t\t\t\t\tconst prop = key as keyof T;\n\t\t\t\t\t\tthis.#triggerNotify(prop, undefined as T[keyof T], oldData[prop]);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.#log.debug(\n\t\t\t\t`Observer data replaced and listeners notified.`,\n\t\t\t\t`${caller}.replaceData`\n\t\t\t);\n\t\t}, `[${caller}.replaceData]: Error replacing data.`);\n\t}\n\n\tset<K extends keyof T>(prop: K, value: T[K]): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tconst oldValue = this.#helpers.data.clone(this.data[prop]);\n\n\t\t\tthis.data[prop] = this.#helpers.data.clone(value);\n\n\t\t\tthis.#triggerNotify(prop, this.data[prop], oldValue);\n\t\t}, `[${caller}]: Error setting data.`);\n\t}\n\n\tsetData<U extends Record<string, unknown>>(\n\t\tnewData: U,\n\t\tdebounceOptions: DebounceOptions,\n\t\thelpers: Helpers,\n\t\tservices: Services\n\t): ObserverService<U> {\n\t\treturn new ObserverService(newData, debounceOptions, helpers, services);\n\t}\n\n\t#deepObserve(obj: T): T {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tif (typeof obj !== 'object' || obj === null) {\n\t\t\t\treturn obj;\n\t\t\t}\n\n\t\t\t// recursively proxy nested objects\n\t\t\treturn new Proxy(obj as Record<string, unknown>, {\n\t\t\t\tget: (target, prop: string) => {\n\t\t\t\t\tconst value = target[prop];\n\n\t\t\t\t\treturn typeof value === 'object' && value !== null\n\t\t\t\t\t\t? this.#deepObserve(value as T)\n\t\t\t\t\t\t: value;\n\t\t\t\t},\n\t\t\t\tset: (target, prop: string, value) => {\n\t\t\t\t\tif (Object.prototype.hasOwnProperty.call(target, prop)) {\n\t\t\t\t\t\tconst oldValue = target[prop];\n\n\t\t\t\t\t\ttarget[prop] = value;\n\n\t\t\t\t\t\tthis.#triggerNotify(\n\t\t\t\t\t\t\tprop as keyof T,\n\t\t\t\t\t\t\tvalue as T[keyof T],\n\t\t\t\t\t\t\toldValue as T[keyof T]\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tdeleteProperty: (target, prop: string) => {\n\t\t\t\t\tif (Object.prototype.hasOwnProperty.call(target, prop)) {\n\t\t\t\t\t\tconst oldValue = target[prop];\n\n\t\t\t\t\t\tdelete target[prop];\n\n\t\t\t\t\t\tthis.#triggerNotify(\n\t\t\t\t\t\t\tprop as keyof T,\n\t\t\t\t\t\t\tundefined as T[keyof T],\n\t\t\t\t\t\t\toldValue as T[keyof T]\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}) as T;\n\t\t}, `[${caller}]: Error observing data.`);\n\t}\n\n\t#notify<K extends keyof T>(prop: K, newValue: T[K], oldValue: T[K]) {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tthis.#listeners[prop]?.forEach(callback => callback(newValue, oldValue));\n\t\t}, `[${caller}]: Error notifying listeners.`);\n\t}\n\n\t#triggerNotify<K extends keyof T>(\n\t\tprop: K,\n\t\tnewValue: T[K],\n\t\toldValue: T[K]\n\t): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tconst delay = this.debounceOptions.delay ?? 0;\n\n\t\t\tif (delay > 0) {\n\t\t\t\tclearTimeout(this.#debounceTimers[prop]);\n\n\t\t\t\tthis.#debounceTimers[prop] = setTimeout(() => {\n\t\t\t\t\tthis.#notify(prop, newValue, oldValue);\n\t\t\t\t}, delay);\n\t\t\t} else {\n\t\t\t\tthis.#notify(prop, newValue, oldValue);\n\t\t\t}\n\t\t}, `[${caller}]: Error triggering notification.`);\n\t}\n}\n"],"names":[],"mappings":"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"}