{"version":3,"file":"ErrorHandler.js","sources":["../../../../../src/common/services/ErrorHandler.ts"],"sourcesContent":["// File: common/services/ErrorHandler.ts\n\nimport { ErrorHandlerInterface } from '../../types/app.js';\nimport { AppLogger } from './AppLogger.js';\nimport { config } from '../../config/index.js';\n\nconst mode = config.mode;\n\nexport class ErrorHandler implements ErrorHandlerInterface {\n\tprivate static instance: ErrorHandler | null = null;\n\tprivate logger: AppLogger;\n\n\tprivate constructor(logger: AppLogger) {\n\t\tthis.logger = logger;\n\t}\n\n\tpublic static getInstance(logger: AppLogger): ErrorHandler {\n\t\tif (!ErrorHandler.instance) {\n\t\t\tErrorHandler.instance = new ErrorHandler(logger);\n\t\t}\n\t\treturn ErrorHandler.instance;\n\t}\n\n\tpublic handle(\n\t\terror: unknown,\n\t\terrorMessage: string,\n\t\tcontext: Record<string, unknown> = {}\n\t): void {\n\t\tconst caller = this.getCallerInfo();\n\t\tconst formattedError = this.formatError(error, errorMessage, context);\n\n\t\tthis.logger.log(formattedError, 'error', caller);\n\n\t\tif (mode.stackTrace) {\n\t\t\tthis.logger.log(\n\t\t\t\t`Stack trace:\\n${this.getStackTrace(error instanceof Error ? error : undefined)}`,\n\t\t\t\t'debug',\n\t\t\t\t'[ErrorHandler]'\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic async handleAsync<T>(\n\t\taction: () => Promise<T>,\n\t\terrorMessage: string,\n\t\tcontext: Record<string, unknown> = {}\n\t): Promise<T> {\n\t\ttry {\n\t\t\treturn await action();\n\t\t} catch (error) {\n\t\t\tthis.handle(error, errorMessage, context);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprivate formatError(\n\t\terror: unknown,\n\t\tmessage: string,\n\t\tcontext: Record<string, unknown>\n\t): string {\n\t\treturn error instanceof Error\n\t\t\t? `${message}: ${error.message}. Context: ${JSON.stringify(context)}`\n\t\t\t: `${message}: ${error}. Context: ${JSON.stringify(context)}`;\n\t}\n\n\tprivate getStackTrace(error?: Error): string {\n\t\treturn error?.stack ?? new Error().stack ?? 'No stack trace available';\n\t}\n\n\tprivate getCallerInfo(): string {\n\t\tconst stack = new Error().stack;\n\t\tif (stack) {\n\t\t\tconst stackLines = stack.split('\\n');\n\t\t\tfor (const line of stackLines) {\n\t\t\t\tif (\n\t\t\t\t\t!line.includes('AppLogger') &&\n\t\t\t\t\t!line.includes('ErrorHandler') &&\n\t\t\t\t\tline.includes('at ')\n\t\t\t\t) {\n\t\t\t\t\tconst match =\n\t\t\t\t\t\tline.match(/at\\s+(.*)\\s+\\((.*):(\\d+):(\\d+)\\)/) ||\n\t\t\t\t\t\tline.match(/at\\s+(.*):(\\d+):(\\d+)/);\n\t\t\t\t\tif (match) {\n\t\t\t\t\t\treturn match[1]\n\t\t\t\t\t\t\t? `${match[1]} (${match[2]}:${match[3]})`\n\t\t\t\t\t\t\t: `${match[2]}:${match[3]}`;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn 'Unknown caller';\n\t}\n}\n"],"names":[],"mappings":"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"}