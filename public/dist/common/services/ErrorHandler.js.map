{"version":3,"file":"ErrorHandler.js","sources":["../../../../../src/common/services/ErrorHandler.ts"],"sourcesContent":["// File: common/services/ErrorHandler.ts\n\nimport {\n\tErrorHandlerInterface,\n\tErrorHandlerOptions,\n\tHelpers\n} from '../../types/index.js';\nimport { UserFacingError } from './ErrorClasses.js';\nimport { Logger } from './Logger.js';\nimport { config } from '../../config/index.js';\n\nconst mode = config.mode;\n\nexport class ErrorHandler implements ErrorHandlerInterface {\n\tstatic #instance: ErrorHandler | null = null;\n\t#getCallerInfo: Helpers['data']['getCallerInfo'];\n\t#logger: Logger;\n\n\tprivate constructor(helpers: Helpers, logger: Logger) {\n\t\tthis.#getCallerInfo = helpers.data.getCallerInfo;\n\t\tthis.#logger = logger;\n\t}\n\n\tstatic getInstance(helpers: Helpers, logger: Logger): ErrorHandler {\n\t\tif (!ErrorHandler.#instance) {\n\t\t\tconsole.debug(\n\t\t\t\t'[ErrorHandler] No ErrorHandler instance exists yet. Creating new instance.'\n\t\t\t);\n\t\t\tErrorHandler.#instance = new ErrorHandler(helpers, logger);\n\t\t}\n\n\t\tconsole.debug(\n\t\t\t'[ErrorHandler] Returning existing ErrorHandler instance.'\n\t\t);\n\n\t\treturn ErrorHandler.#instance;\n\t}\n\n\thandleAndReturn<T>(\n\t\taction: () => T | Promise<T>,\n\t\terrorMessage: string,\n\t\toptions: ErrorHandlerOptions = {}\n\t): T | Promise<T> {\n\t\ttry {\n\t\t\tconst result = action();\n\n\t\t\tif (result instanceof Promise) {\n\t\t\t\treturn result.catch(error => {\n\t\t\t\t\tthis.#handle(error, errorMessage, options);\n\t\t\t\t\treturn (options.fallback as T) ?? Promise.reject(error);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\tthis.#handle(error, errorMessage, options);\n\t\t\treturn options.fallback as T;\n\t\t}\n\t}\n\n\tasync handleAsync<T>(\n\t\taction: () => Promise<T>,\n\t\terrorMessage: string,\n\t\toptions: ErrorHandlerOptions = {}\n\t): Promise<T> {\n\t\ttry {\n\t\t\treturn await action();\n\t\t} catch (error) {\n\t\t\tthis.#handle(error, errorMessage, options);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\thandleSync<T>(\n\t\taction: () => T,\n\t\terrorMessage: string,\n\t\toptions: ErrorHandlerOptions = {}\n\t): T {\n\t\ttry {\n\t\t\treturn action();\n\t\t} catch (error) {\n\t\t\tthis.#handle(error, errorMessage, options);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t#formatError(\n\t\terror: unknown,\n\t\tmessage: string,\n\t\tcontext: Record<string, unknown>\n\t): string {\n\t\treturn error instanceof Error\n\t\t\t? `${message}: ${error.message}. Context: ${JSON.stringify(context)}`\n\t\t\t: `${message}: ${error}. Context: ${JSON.stringify(context)}`;\n\t}\n\n\t#getStackTrace(error?: Error): string {\n\t\treturn error?.stack ?? new Error().stack ?? 'No stack trace available';\n\t}\n\n\t#handle(\n\t\terror: unknown,\n\t\terrorMessage: string,\n\t\toptions: ErrorHandlerOptions = {}\n\t): void {\n\t\tconst caller = this.#getCallerInfo();\n\t\tconst formattedError = this.#formatError(\n\t\t\terror,\n\t\t\terrorMessage,\n\t\t\toptions.context ?? {}\n\t\t);\n\n\t\tthis.#logger.log(formattedError, 'error', caller);\n\n\t\tif (mode.stackTrace) {\n\t\t\tthis.#logger.log(\n\t\t\t\t`Stack trace:\\n${this.#getStackTrace(error instanceof Error ? error : undefined)}`,\n\t\t\t\t'debug',\n\t\t\t\t'[ErrorHandler]'\n\t\t\t);\n\t\t}\n\n\t\tconst userMessage =\n\t\t\toptions.userMessage ??\n\t\t\t(error instanceof UserFacingError ? error.userMessage : undefined);\n\n\t\tif (userMessage) {\n\t\t\talert(userMessage);\n\t\t}\n\t}\n}\n"],"names":[],"mappings":"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"}