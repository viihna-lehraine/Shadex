{"version":3,"file":"Semaphore.js","sources":["../../../../../src/common/services/Semaphore.ts"],"sourcesContent":["// File: common/services/Semaphore.ts\n\nimport { SemaphoreInterface } from '../../types/index.js';\nimport { config } from '../../config/index.js';\n\nconst maxLocks = config.env.semaphoreMaxLocks;\nconst timeout = config.env.semaphoreTimeout;\n\nexport class Semaphore implements SemaphoreInterface {\n\t#isLocked: boolean = false;\n\t#waitingQueue: (() => void)[] = [];\n\t#lockCount: number = 0;\n\n\tasync acquire(): Promise<void> {\n\t\tif (this.#lockCount >= maxLocks) {\n\t\t\tthrow new Error(\n\t\t\t\t`Cannot acquire lock. Maximum number of locks (${maxLocks}) reached.`\n\t\t\t);\n\t\t}\n\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\tconst timer = setTimeout(\n\t\t\t\t() =>\n\t\t\t\t\treject(\n\t\t\t\t\t\tnew Error(\n\t\t\t\t\t\t\t`Lock acquisition timed out after ${timeout} ms`\n\t\t\t\t\t\t)\n\t\t\t\t\t),\n\t\t\t\ttimeout\n\t\t\t);\n\n\t\t\tconst tryAcquire = () => {\n\t\t\t\tif (!this.#isLocked) {\n\t\t\t\t\tclearTimeout(timer);\n\n\t\t\t\t\tthis.#isLocked = true;\n\n\t\t\t\t\tresolve();\n\t\t\t\t} else {\n\t\t\t\t\tthis.#waitingQueue.push(tryAcquire);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\ttryAcquire();\n\n\t\t\tthis.#lockCount++;\n\t\t});\n\t}\n\n\trelease(): void {\n\t\tif (!this.#isLocked) {\n\t\t\tthrow new Error(\"Cannot release a lock that isn't acquired.\");\n\t\t}\n\n\t\tthis.#isLocked = false;\n\n\t\tconst next = this.#waitingQueue.shift();\n\n\t\tthis.#lockCount--;\n\t\tif (next) {\n\t\t\tnext();\n\t\t}\n\t}\n}\n"],"names":[],"mappings":";;AAAA;AAKA,MAAM,QAAQ,GAAG,MAAM,CAAC,GAAG,CAAC,iBAAiB;AAC7C,MAAM,OAAO,GAAG,MAAM,CAAC,GAAG,CAAC,gBAAgB;MAE9B,SAAS,CAAA;IACrB,SAAS,GAAY,KAAK;IAC1B,aAAa,GAAmB,EAAE;IAClC,UAAU,GAAW,CAAC;AAEtB,IAAA,MAAM,OAAO,GAAA;AACZ,QAAA,IAAI,IAAI,CAAC,UAAU,IAAI,QAAQ,EAAE;AAChC,YAAA,MAAM,IAAI,KAAK,CACd,iDAAiD,QAAQ,CAAA,UAAA,CAAY,CACrE;;QAGF,OAAO,IAAI,OAAO,CAAO,CAAC,OAAO,EAAE,MAAM,KAAI;YAC5C,MAAM,KAAK,GAAG,UAAU,CACvB,MACC,MAAM,CACL,IAAI,KAAK,CACR,CAAA,iCAAA,EAAoC,OAAO,CAAK,GAAA,CAAA,CAChD,CACD,EACF,OAAO,CACP;YAED,MAAM,UAAU,GAAG,MAAK;AACvB,gBAAA,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE;oBACpB,YAAY,CAAC,KAAK,CAAC;AAEnB,oBAAA,IAAI,CAAC,SAAS,GAAG,IAAI;AAErB,oBAAA,OAAO,EAAE;;qBACH;AACN,oBAAA,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,UAAU,CAAC;;AAErC,aAAC;AAED,YAAA,UAAU,EAAE;YAEZ,IAAI,CAAC,UAAU,EAAE;AAClB,SAAC,CAAC;;IAGH,OAAO,GAAA;AACN,QAAA,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE;AACpB,YAAA,MAAM,IAAI,KAAK,CAAC,4CAA4C,CAAC;;AAG9D,QAAA,IAAI,CAAC,SAAS,GAAG,KAAK;QAEtB,MAAM,IAAI,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE;QAEvC,IAAI,CAAC,UAAU,EAAE;QACjB,IAAI,IAAI,EAAE;AACT,YAAA,IAAI,EAAE;;;AAGR;;;;"}