// File: app/db/services/PaletteService.js
import { configData as config } from '../../../data/config.js';
import { dbUtils } from '../dbUtils.js';
import { commonFn } from '../../../common/index.js';
const PALETTE_STORE = 'palettes';
export class PaletteService {
    static instance = null;
    dbUtils;
    utils;
    storeNames = config.db.STORE_NAMES;
    constructor() {
        this.dbUtils = dbUtils;
        this.utils = commonFn.utils;
    }
    static async getInstance() {
        if (!this.instance) {
            this.instance = new PaletteService();
        }
        return this.instance;
    }
    async getCurrentPaletteID() {
        return ((await this.dbUtils.handleAsync(() => this.dbUtils.handleData('settings', this.dbUtils.getDefaultKey('APP_SETTINGS'), 'get'), 'Failed to fetch current palette ID', 'PaletteService.getCurrentPaletteID()'))?.lastPaletteID ?? 0);
    }
    async getNextTableID() {
        const lastTableID = (await this.dbUtils.handleAsync(() => this.dbUtils.handleData(this.storeNames.SETTINGS, this.dbUtils.getDefaultKey('APP_SETTINGS'), 'get'), 'Failed to fetch last table ID', 'PaletteService.getNextTableID()'))?.lastTableID ?? 0;
        const nextID = lastTableID + 1;
        await this.dbUtils.handleAsync(() => this.dbUtils.updateData(this.storeNames.SETTINGS, this.dbUtils.getDefaultKey('APP_SETTINGS'), s => ({ ...s, lastTableID: nextID })), 'Failed to update next table ID', 'PaletteService.getNextTableID()');
        return `palette_${nextID}`;
    }
    async getPalette(id) {
        return await this.dbUtils.handleAsync(() => this.dbUtils.handleData(PALETTE_STORE, id, 'get'), `Failed to fetch palette with ID ${id}`, 'PaletteService.getPalette()');
    }
    async resetPaletteID() {
        await this.dbUtils.handleAsync(() => this.dbUtils.updateData(this.storeNames.SETTINGS, this.dbUtils.getDefaultKey('APP_SETTINGS'), s => ({ ...s, lastPaletteID: 0 })), 'Failed to reset palette ID', 'PaletteService.resetPaletteID()');
    }
    async savePalette(id, palette) {
        await this.dbUtils.handleAsync(() => this.dbUtils.handleData(PALETTE_STORE, id, 'put', palette), `Failed to save palette with ID ${id}`, 'PaletteService.savePalette()');
    }
    async savePaletteToDB(args) {
        const result = await this.dbUtils.handleAsync(async () => {
            const newPalette = this.utils.palette.createObject(args);
            const parsedPaletteFormat = Number(newPalette.id.split('_')[1]);
            if (isNaN(parsedPaletteFormat) ||
                parsedPaletteFormat <= 0 ||
                parsedPaletteFormat >= 9) {
                throw new Error(`Invalid palette ID format: ${newPalette.id}`);
            }
            await this.savePalette(newPalette.id, newPalette);
            return newPalette;
        }, 'Failed to save palette to database', 'PaletteService.savePaletteToDB()');
        if (!result) {
            throw new Error('savePaletteToDB failed and returned null.');
        }
        return result;
    }
    async updateEntryInPalette(tableID, entryIndex, newEntry) {
        const palette = await this.dbUtils.handleAsync(() => this.dbUtils.handleData(PALETTE_STORE, tableID, 'get'), `Failed to fetch palette with ID ${tableID}`, 'PaletteService.updateEntryInPalette()');
        if (!palette)
            throw new Error(`Palette ${tableID} not found.`);
        if (entryIndex >= palette.items.length)
            throw new Error(`Invalid index ${entryIndex}`);
        palette.items[entryIndex] = newEntry;
        await this.savePalette(tableID, palette);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFsZXR0ZVNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvYXBwL2RiL3NlcnZpY2VzL1BhbGV0dGVTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLDBDQUEwQztBQWExQyxPQUFPLEVBQUUsVUFBVSxJQUFJLE1BQU0sRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRXBELE1BQU0sYUFBYSxHQUFHLFVBQWlDLENBQUM7QUFFeEQsTUFBTSxPQUFPLGNBQWM7SUFDbEIsTUFBTSxDQUFDLFFBQVEsR0FBMEIsSUFBSSxDQUFDO0lBRTlDLE9BQU8sQ0FBbUI7SUFDMUIsS0FBSyxDQUFvQztJQUV6QyxVQUFVLEdBQ2pCLE1BQU0sQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDO0lBRXZCO1FBQ0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDO0lBQzdCLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVc7UUFDOUIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksY0FBYyxFQUFFLENBQUM7UUFDdEMsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN0QixDQUFDO0lBRU0sS0FBSyxDQUFDLG1CQUFtQjtRQUMvQixPQUFPLENBQ04sQ0FDQyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUM3QixHQUFHLEVBQUUsQ0FDSixJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FDdEIsVUFBVSxFQUNWLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLGNB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Q29udGVudCI6WyIvLyBGaWxlOiBhcHAvZGIvc2VydmljZXMvUGFsZXR0ZVNlcnZpY2UuanNcblxuaW1wb3J0IHtcblx0Q29tbW9uRm5fTWFzdGVySW50ZXJmYWNlLFxuXHRDb25maWdEYXRhSW50ZXJmYWNlLFxuXHREQlV0aWxzSW50ZXJmYWNlLFxuXHRQYWxldHRlLFxuXHRQYWxldHRlQXJncyxcblx0UGFsZXR0ZUl0ZW0sXG5cdFBhbGV0dGVTY2hlbWEsXG5cdFBhbGV0dGVTZXJ2aWNlX0NsYXNzSW50ZXJmYWNlLFxuXHRTZXR0aW5nc1xufSBmcm9tICcuLi8uLi8uLi90eXBlcy9pbmRleC5qcyc7XG5pbXBvcnQgeyBjb25maWdEYXRhIGFzIGNvbmZpZyB9IGZyb20gJy4uLy4uLy4uL2RhdGEvY29uZmlnLmpzJztcbmltcG9ydCB7IGRiVXRpbHMgfSBmcm9tICcuLi9kYlV0aWxzLmpzJztcbmltcG9ydCB7IGNvbW1vbkZuIH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL2luZGV4LmpzJztcblxuY29uc3QgUEFMRVRURV9TVE9SRSA9ICdwYWxldHRlcycgYXMga2V5b2YgUGFsZXR0ZVNjaGVtYTtcblxuZXhwb3J0IGNsYXNzIFBhbGV0dGVTZXJ2aWNlIGltcGxlbWVudHMgUGFsZXR0ZVNlcnZpY2VfQ2xhc3NJbnRlcmZhY2Uge1xuXHRwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogUGFsZXR0ZVNlcnZpY2UgfCBudWxsID0gbnVsbDtcblxuXHRwcml2YXRlIGRiVXRpbHM6IERCVXRpbHNJbnRlcmZhY2U7XG5cdHByaXZhdGUgdXRpbHM6IENvbW1vbkZuX01hc3RlckludGVyZmFjZVsndXRpbHMnXTtcblxuXHRwcml2YXRlIHN0b3JlTmFtZXM6IENvbmZpZ0RhdGFJbnRlcmZhY2VbJ2RiJ11bJ1NUT1JFX05BTUVTJ10gPVxuXHRcdGNvbmZpZy5kYi5TVE9SRV9OQU1FUztcblxuXHRjb25zdHJ1Y3RvcigpIHtcblx0XHR0aGlzLmRiVXRpbHMgPSBkYlV0aWxzO1xuXHRcdHRoaXMudXRpbHMgPSBjb21tb25Gbi51dGlscztcblx0fVxuXG5cdHB1YmxpYyBzdGF0aWMgYXN5bmMgZ2V0SW5zdGFuY2UoKSB7XG5cdFx0aWYgKCF0aGlzLmluc3RhbmNlKSB7XG5cdFx0XHR0aGlzLmluc3RhbmNlID0gbmV3IFBhbGV0dGVTZXJ2aWNlKCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZ2V0Q3VycmVudFBhbGV0dGVJRCgpOiBQcm9taXNlPG51bWJlcj4ge1xuXHRcdHJldHVybiAoXG5cdFx0XHQoXG5cdFx0XHRcdGF3YWl0IHRoaXMuZGJVdGlscy5oYW5kbGVBc3luYyhcblx0XHRcdFx0XHQoKSA9PlxuXHRcdFx0XHRcdFx0dGhpcy5kYlV0aWxzLmhhbmRsZURhdGE8U2V0dGluZ3M+KFxuXHRcdFx0XHRcdFx0XHQnc2V0dGluZ3MnLFxuXHRcdFx0XHRcdFx0XHR0aGlzLmRiVXRpbHMuZ2V0RGVmYXVsdEtleSgnQVBQX1NFVFRJTkdTJyksXG5cdFx0XHRcdFx0XHRcdCdnZXQnXG5cdFx0XHRcdFx0XHQpLFxuXHRcdFx0XHRcdCdGYWlsZWQgdG8gZmV0Y2ggY3VycmVudCBwYWxldHRlIElEJyxcblx0XHRcdFx0XHQnUGFsZXR0ZVNlcnZpY2UuZ2V0Q3VycmVudFBhbGV0dGVJRCgpJ1xuXHRcdFx0XHQpXG5cdFx0XHQpPy5sYXN0UGFsZXR0ZUlEID8/IDBcblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldE5leHRUYWJsZUlEKCk6IFByb21pc2U8c3RyaW5nPiB7XG5cdFx0Y29uc3QgbGFzdFRhYmxlSUQgPVxuXHRcdFx0KFxuXHRcdFx0XHRhd2FpdCB0aGlzLmRiVXRpbHMuaGFuZGxlQXN5bmMoXG5cdFx0XHRcdFx0KCkgPT5cblx0XHRcdFx0XHRcdHRoaXMuZGJVdGlscy5oYW5kbGVEYXRhPFNldHRpbmdzPihcblx0XHRcdFx0XHRcdFx0dGhpcy5zdG9yZU5hbWVzLlNFVFRJTkdTIGFzIGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0XHRcdFx0XHRcdHRoaXMuZGJVdGlscy5nZXREZWZhdWx0S2V5KCdBUFBfU0VUVElOR1MnKSxcblx0XHRcdFx0XHRcdFx0J2dldCdcblx0XHRcdFx0XHRcdCksXG5cdFx0XHRcdFx0J0ZhaWxlZCB0byBmZXRjaCBsYXN0IHRhYmxlIElEJyxcblx0XHRcdFx0XHQnUGFsZXR0ZVNlcnZpY2UuZ2V0TmV4dFRhYmxlSUQoKSdcblx0XHRcdFx0KVxuXHRcdFx0KT8ubGFzdFRhYmxlSUQgPz8gMDtcblxuXHRcdGNvbnN0IG5leHRJRCA9IGxhc3RUYWJsZUlEICsgMTtcblxuXHRcdGF3YWl0IHRoaXMuZGJVdGlscy5oYW5kbGVBc3luYyhcblx0XHRcdCgpID0+XG5cdFx0XHRcdHRoaXMuZGJVdGlscy51cGRhdGVEYXRhKFxuXHRcdFx0XHRcdHRoaXMuc3RvcmVOYW1lcy5TRVRUSU5HUyBhcyBrZXlvZiBQYWxldHRlU2NoZW1hLFxuXHRcdFx0XHRcdHRoaXMuZGJVdGlscy5nZXREZWZhdWx0S2V5KCdBUFBfU0VUVElOR1MnKSxcblx0XHRcdFx0XHRzID0+ICh7IC4uLnMsIGxhc3RUYWJsZUlEOiBuZXh0SUQgfSlcblx0XHRcdFx0KSxcblx0XHRcdCdGYWlsZWQgdG8gdXBkYXRlIG5leHQgdGFibGUgSUQnLFxuXHRcdFx0J1BhbGV0dGVTZXJ2aWNlLmdldE5leHRUYWJsZUlEKCknXG5cdFx0KTtcblxuXHRcdHJldHVybiBgcGFsZXR0ZV8ke25leHRJRH1gO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldFBhbGV0dGUoaWQ6IHN0cmluZyk6IFByb21pc2U8UGFsZXR0ZSB8IG51bGw+IHtcblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5kYlV0aWxzLmhhbmRsZUFzeW5jKFxuXHRcdFx0KCkgPT4gdGhpcy5kYlV0aWxzLmhhbmRsZURhdGE8UGFsZXR0ZT4oUEFMRVRURV9TVE9SRSwgaWQsICdnZXQnKSxcblx0XHRcdGBGYWlsZWQgdG8gZmV0Y2ggcGFsZXR0ZSB3aXRoIElEICR7aWR9YCxcblx0XHRcdCdQYWxldHRlU2VydmljZS5nZXRQYWxldHRlKCknXG5cdFx0KTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyByZXNldFBhbGV0dGVJRCgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRhd2FpdCB0aGlzLmRiVXRpbHMuaGFuZGxlQXN5bmMoXG5cdFx0XHQoKSA9PlxuXHRcdFx0XHR0aGlzLmRiVXRpbHMudXBkYXRlRGF0YShcblx0XHRcdFx0XHR0aGlzLnN0b3JlTmFtZXMuU0VUVElOR1MgYXMga2V5b2YgUGFsZXR0ZVNjaGVtYSxcblx0XHRcdFx0XHR0aGlzLmRiVXRpbHMuZ2V0RGVmYXVsdEtleSgnQVBQX1NFVFRJTkdTJyksXG5cdFx0XHRcdFx0cyA9PiAoeyAuLi5zLCBsYXN0UGFsZXR0ZUlEOiAwIH0pXG5cdFx0XHRcdCksXG5cdFx0XHQnRmFpbGVkIHRvIHJlc2V0IHBhbGV0dGUgSUQnLFxuXHRcdFx0J1BhbGV0dGVTZXJ2aWNlLnJlc2V0UGFsZXR0ZUlEKCknXG5cdFx0KTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzYXZlUGFsZXR0ZShpZDogc3RyaW5nLCBwYWxldHRlOiBQYWxldHRlKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy5kYlV0aWxzLmhhbmRsZUFzeW5jKFxuXHRcdFx0KCkgPT4gdGhpcy5kYlV0aWxzLmhhbmRsZURhdGEoUEFMRVRURV9TVE9SRSwgaWQsICdwdXQnLCBwYWxldHRlKSxcblx0XHRcdGBGYWlsZWQgdG8gc2F2ZSBwYWxldHRlIHdpdGggSUQgJHtpZH1gLFxuXHRcdFx0J1BhbGV0dGVTZXJ2aWNlLnNhdmVQYWxldHRlKCknXG5cdFx0KTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzYXZlUGFsZXR0ZVRvREIoYXJnczogUGFsZXR0ZUFyZ3MpOiBQcm9taXNlPFBhbGV0dGU+IHtcblx0XHRjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRiVXRpbHMuaGFuZGxlQXN5bmMoXG5cdFx0XHRhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IG5ld1BhbGV0dGUgPSB0aGlzLnV0aWxzLnBhbGV0dGUuY3JlYXRlT2JqZWN0KGFyZ3MpO1xuXHRcdFx0XHRjb25zdCBwYXJzZWRQYWxldHRlRm9ybWF0ID0gTnVtYmVyKG5ld1BhbGV0dGUuaWQuc3BsaXQoJ18nKVsxXSk7XG5cblx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdGlzTmFOKHBhcnNlZFBhbGV0dGVGb3JtYXQpIHx8XG5cdFx0XHRcdFx0cGFyc2VkUGFsZXR0ZUZvcm1hdCA8PSAwIHx8XG5cdFx0XHRcdFx0cGFyc2VkUGFsZXR0ZUZvcm1hdCA+PSA5XG5cdFx0XHRcdCkge1xuXHRcdFx0XHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdFx0XHRcdGBJbnZhbGlkIHBhbGV0dGUgSUQgZm9ybWF0OiAke25ld1BhbGV0dGUuaWR9YFxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRhd2FpdCB0aGlzLnNhdmVQYWxldHRlKG5ld1BhbGV0dGUuaWQsIG5ld1BhbGV0dGUpO1xuXG5cdFx0XHRcdHJldHVybiBuZXdQYWxldHRlO1xuXHRcdFx0fSxcblx0XHRcdCdGYWlsZWQgdG8gc2F2ZSBwYWxldHRlIHRvIGRhdGFiYXNlJyxcblx0XHRcdCdQYWxldHRlU2VydmljZS5zYXZlUGFsZXR0ZVRvREIoKSdcblx0XHQpO1xuXG5cdFx0aWYgKCFyZXN1bHQpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignc2F2ZVBhbGV0dGVUb0RCIGZhaWxlZCBhbmQgcmV0dXJuZWQgbnVsbC4nKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHVwZGF0ZUVudHJ5SW5QYWxldHRlKFxuXHRcdHRhYmxlSUQ6IHN0cmluZyxcblx0XHRlbnRyeUluZGV4OiBudW1iZXIsXG5cdFx0bmV3RW50cnk6IFBhbGV0dGVJdGVtXG5cdCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IHBhbGV0dGUgPSBhd2FpdCB0aGlzLmRiVXRpbHMuaGFuZGxlQXN5bmMoXG5cdFx0XHQoKSA9PlxuXHRcdFx0XHR0aGlzLmRiVXRpbHMuaGFuZGxlRGF0YTxQYWxldHRlPihQQUxFVFRFX1NUT1JFLCB0YWJsZUlELCAnZ2V0JyksXG5cdFx0XHRgRmFpbGVkIHRvIGZldGNoIHBhbGV0dGUgd2l0aCBJRCAke3RhYmxlSUR9YCxcblx0XHRcdCdQYWxldHRlU2VydmljZS51cGRhdGVFbnRyeUluUGFsZXR0ZSgpJ1xuXHRcdCk7XG5cblx0XHRpZiAoIXBhbGV0dGUpIHRocm93IG5ldyBFcnJvcihgUGFsZXR0ZSAke3RhYmxlSUR9IG5vdCBmb3VuZC5gKTtcblx0XHRpZiAoZW50cnlJbmRleCA+PSBwYWxldHRlLml0ZW1zLmxlbmd0aClcblx0XHRcdHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBpbmRleCAke2VudHJ5SW5kZXh9YCk7XG5cblx0XHRwYWxldHRlLml0ZW1zW2VudHJ5SW5kZXhdID0gbmV3RW50cnk7XG5cblx0XHRhd2FpdCB0aGlzLnNhdmVQYWxldHRlKHRhYmxlSUQsIHBhbGV0dGUpO1xuXHR9XG59XG4iXX0=