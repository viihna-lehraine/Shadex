// File: app/db/services/DBService.js
import { appUtils } from '../../appUtils.js';
import { configData as config } from '../../../data/config.js';
import { dbUtils } from '../dbUtils.js';
export class DBService {
    static instance = null;
    defaultSettings = config.db.DEFAULT_SETTINGS;
    storeNames = config.db.STORE_NAMES;
    appUtils;
    dbUtils;
    constructor() {
        this.appUtils = appUtils;
        this.dbUtils = dbUtils;
    }
    static async getInstance() {
        if (!this.instance) {
            this.instance = new DBService();
        }
        return this.instance;
    }
    async deleteDatabase() {
        await this.appUtils.handleAsync(async () => {
            const dbName = 'paletteDB';
            const dbExists = await new Promise(resolve => {
                const request = indexedDB.open(dbName);
                request.onsuccess = () => {
                    request.result.close();
                    resolve(true);
                };
                request.onerror = () => resolve(false);
            });
            if (dbExists) {
                const deleteRequest = indexedDB.deleteDatabase(dbName);
                deleteRequest.onsuccess = () => this.appUtils.log('debug', `Database "${dbName}" deleted successfully.`, 'deleteDatabase');
                deleteRequest.onerror = event => this.appUtils.log('error', `Error deleting database "${dbName}":\nEvent: ${event}`, 'deleteDatabase');
                deleteRequest.onblocked = () => this.appUtils.log('warn', `Delete operation blocked for "${dbName}".`, 'deleteDatabase');
            }
            else {
                this.appUtils.log('warn', `Database "${dbName}" does not exist.`, 'deleteDatabase');
            }
        }, 'Failed to delete database', 'DBService.deleteDatabase');
    }
    async deleteEntries(store, keys) {
        await this.appUtils.handleAsync(async () => {
            await this.dbUtils.withDB(async (db) => {
                const storeRef = db
                    .transaction(store, 'readwrite')
                    .objectStore(store);
                for (const key of keys) {
                    if ((await this.dbUtils.handleData(store, key, 'get')) !== null) {
                        await storeRef.delete(key);
                    }
                }
            });
        }, `Failed to delete entries in store "${store}"`, 'DBService.deleteEntries');
    }
    async resetDatabase() {
        await this.appUtils.handleAsync(async () => {
            await this.dbUtils.withDB(async (db) => {
                await Promise.all(Object.values(this.storeNames).map(store => db
                    .transaction(store, 'readwrite')
                    .objectStore(store)
                    .clear()));
                await this.dbUtils.handleData(this.storeNames.SETTINGS, this.dbUtils.getDefaultKey('APP_SETTINGS'), 'put', this.defaultSettings);
            });
        }, 'Failed to reset database', 'DBService.resetDatabase');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiREJTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9kYi9zZXJ2aWNlcy9EQlNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEscUNBQXFDO0FBU3JDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsVUFBVSxJQUFJLE1BQU0sRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFeEMsTUFBTSxPQUFPLFNBQVM7SUFDYixNQUFNLENBQUMsUUFBUSxHQUFxQixJQUFJLENBQUM7SUFFekMsZUFBZSxHQUN0QixNQUFNLENBQUMsRUFBRSxDQUFDLGdCQUFnQixDQUFDO0lBQ3BCLFVBQVUsR0FDakIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUM7SUFFZixRQUFRLENBQW9CO0lBQzVCLE9BQU8sQ0FBbUI7SUFFbEM7UUFDQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUN4QixDQUFDO0lBRU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXO1FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBQ2pDLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdEIsQ0FBQztJQUVNLEtBQUssQ0FBQyxjQUFjO1FBQzFCLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQzlCLEtBQUssSUFBSSxFQUFFO1lBQ1YsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDO1lBQzNCLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxPQUFPLENBQVUsT0FBTyxDQUFDLEVBQUU7Z0JBQ3JELE1B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SyxFQUFFLENBQ1QsQ0FDRCxDQUFDO2dCQUNGLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQzVCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBK0IsRUFDL0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLEVBQzFDLEtBQUssRUFDTCxJQUFJLENBQUMsZUFBZSxDQUNwQixDQUFDO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSixDQUFDLEVBQ0QsMEJBQTBCLEVBQzFCLHlCQUF5QixDQUN6QixDQUFDO0lBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IGFwcC9kYi9zZXJ2aWNlcy9EQlNlcnZpY2UuanNcblxuaW1wb3J0IHtcblx0QXBwVXRpbHNJbnRlcmZhY2UsXG5cdENvbmZpZ0RhdGFJbnRlcmZhY2UsXG5cdERCU2VydmljZV9DbGFzc0ludGVyZmFjZSxcblx0REJVdGlsc0ludGVyZmFjZSxcblx0UGFsZXR0ZVNjaGVtYVxufSBmcm9tICcuLi8uLi8uLi90eXBlcy9pbmRleC5qcyc7XG5pbXBvcnQgeyBhcHBVdGlscyB9IGZyb20gJy4uLy4uL2FwcFV0aWxzLmpzJztcbmltcG9ydCB7IGNvbmZpZ0RhdGEgYXMgY29uZmlnIH0gZnJvbSAnLi4vLi4vLi4vZGF0YS9jb25maWcuanMnO1xuaW1wb3J0IHsgZGJVdGlscyB9IGZyb20gJy4uL2RiVXRpbHMuanMnO1xuXG5leHBvcnQgY2xhc3MgREJTZXJ2aWNlIGltcGxlbWVudHMgREJTZXJ2aWNlX0NsYXNzSW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IERCU2VydmljZSB8IG51bGwgPSBudWxsO1xuXG5cdHByaXZhdGUgZGVmYXVsdFNldHRpbmdzOiBDb25maWdEYXRhSW50ZXJmYWNlWydkYiddWydERUZBVUxUX1NFVFRJTkdTJ10gPVxuXHRcdGNvbmZpZy5kYi5ERUZBVUxUX1NFVFRJTkdTO1xuXHRwcml2YXRlIHN0b3JlTmFtZXM6IENvbmZpZ0RhdGFJbnRlcmZhY2VbJ2RiJ11bJ1NUT1JFX05BTUVTJ10gPVxuXHRcdGNvbmZpZy5kYi5TVE9SRV9OQU1FUztcblxuXHRwcml2YXRlIGFwcFV0aWxzOiBBcHBVdGlsc0ludGVyZmFjZTtcblx0cHJpdmF0ZSBkYlV0aWxzOiBEQlV0aWxzSW50ZXJmYWNlO1xuXG5cdGNvbnN0cnVjdG9yKCkge1xuXHRcdHRoaXMuYXBwVXRpbHMgPSBhcHBVdGlscztcblx0XHR0aGlzLmRiVXRpbHMgPSBkYlV0aWxzO1xuXHR9XG5cblx0cHVibGljIHN0YXRpYyBhc3luYyBnZXRJbnN0YW5jZSgpIHtcblx0XHRpZiAoIXRoaXMuaW5zdGFuY2UpIHtcblx0XHRcdHRoaXMuaW5zdGFuY2UgPSBuZXcgREJTZXJ2aWNlKCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZGVsZXRlRGF0YWJhc2UoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy5hcHBVdGlscy5oYW5kbGVBc3luYyhcblx0XHRcdGFzeW5jICgpID0+IHtcblx0XHRcdFx0Y29uc3QgZGJOYW1lID0gJ3BhbGV0dGVEQic7XG5cdFx0XHRcdGNvbnN0IGRiRXhpc3RzID0gYXdhaXQgbmV3IFByb21pc2U8Ym9vbGVhbj4ocmVzb2x2ZSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgcmVxdWVzdCA9IGluZGV4ZWREQi5vcGVuKGRiTmFtZSk7XG5cblx0XHRcdFx0XHRyZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHtcblx0XHRcdFx0XHRcdHJlcXVlc3QucmVzdWx0LmNsb3NlKCk7XG5cdFx0XHRcdFx0XHRyZXNvbHZlKHRydWUpO1xuXHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0cmVxdWVzdC5vbmVycm9yID0gKCkgPT4gcmVzb2x2ZShmYWxzZSk7XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdGlmIChkYkV4aXN0cykge1xuXHRcdFx0XHRcdGNvbnN0IGRlbGV0ZVJlcXVlc3QgPSBpbmRleGVkREIuZGVsZXRlRGF0YWJhc2UoZGJOYW1lKTtcblx0XHRcdFx0XHRkZWxldGVSZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+XG5cdFx0XHRcdFx0XHR0aGlzLmFwcFV0aWxzLmxvZyhcblx0XHRcdFx0XHRcdFx0J2RlYnVnJyxcblx0XHRcdFx0XHRcdFx0YERhdGFiYXNlIFwiJHtkYk5hbWV9XCIgZGVsZXRlZCBzdWNjZXNzZnVsbHkuYCxcblx0XHRcdFx0XHRcdFx0J2RlbGV0ZURhdGFiYXNlJ1xuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRkZWxldGVSZXF1ZXN0Lm9uZXJyb3IgPSBldmVudCA9PlxuXHRcdFx0XHRcdFx0dGhpcy5hcHBVdGlscy5sb2coXG5cdFx0XHRcdFx0XHRcdCdlcnJvcicsXG5cdFx0XHRcdFx0XHRcdGBFcnJvciBkZWxldGluZyBkYXRhYmFzZSBcIiR7ZGJOYW1lfVwiOlxcbkV2ZW50OiAke2V2ZW50fWAsXG5cdFx0XHRcdFx0XHRcdCdkZWxldGVEYXRhYmFzZSdcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0ZGVsZXRlUmVxdWVzdC5vbmJsb2NrZWQgPSAoKSA9PlxuXHRcdFx0XHRcdFx0dGhpcy5hcHBVdGlscy5sb2coXG5cdFx0XHRcdFx0XHRcdCd3YXJuJyxcblx0XHRcdFx0XHRcdFx0YERlbGV0ZSBvcGVyYXRpb24gYmxvY2tlZCBmb3IgXCIke2RiTmFtZX1cIi5gLFxuXHRcdFx0XHRcdFx0XHQnZGVsZXRlRGF0YWJhc2UnXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRoaXMuYXBwVXRpbHMubG9nKFxuXHRcdFx0XHRcdFx0J3dhcm4nLFxuXHRcdFx0XHRcdFx0YERhdGFiYXNlIFwiJHtkYk5hbWV9XCIgZG9lcyBub3QgZXhpc3QuYCxcblx0XHRcdFx0XHRcdCdkZWxldGVEYXRhYmFzZSdcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9LFxuXHRcdFx0J0ZhaWxlZCB0byBkZWxldGUgZGF0YWJhc2UnLFxuXHRcdFx0J0RCU2VydmljZS5kZWxldGVEYXRhYmFzZSdcblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGRlbGV0ZUVudHJpZXMoXG5cdFx0c3RvcmU6IGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0a2V5czogc3RyaW5nW11cblx0KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy5hcHBVdGlscy5oYW5kbGVBc3luYyhcblx0XHRcdGFzeW5jICgpID0+IHtcblx0XHRcdFx0YXdhaXQgdGhpcy5kYlV0aWxzLndpdGhEQihhc3luYyBkYiA9PiB7XG5cdFx0XHRcdFx0Y29uc3Qgc3RvcmVSZWYgPSBkYlxuXHRcdFx0XHRcdFx0LnRyYW5zYWN0aW9uKHN0b3JlLCAncmVhZHdyaXRlJylcblx0XHRcdFx0XHRcdC5vYmplY3RTdG9yZShzdG9yZSk7XG5cblx0XHRcdFx0XHRmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG5cdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdChhd2FpdCB0aGlzLmRiVXRpbHMuaGFuZGxlRGF0YShcblx0XHRcdFx0XHRcdFx0XHRzdG9yZSxcblx0XHRcdFx0XHRcdFx0XHRrZXksXG5cdFx0XHRcdFx0XHRcdFx0J2dldCdcblx0XHRcdFx0XHRcdFx0KSkgIT09IG51bGxcblx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRhd2FpdCBzdG9yZVJlZi5kZWxldGUoa2V5KTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSxcblx0XHRcdGBGYWlsZWQgdG8gZGVsZXRlIGVudHJpZXMgaW4gc3RvcmUgXCIke3N0b3JlfVwiYCxcblx0XHRcdCdEQlNlcnZpY2UuZGVsZXRlRW50cmllcydcblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHJlc2V0RGF0YWJhc2UoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy5hcHBVdGlscy5oYW5kbGVBc3luYyhcblx0XHRcdGFzeW5jICgpID0+IHtcblx0XHRcdFx0YXdhaXQgdGhpcy5kYlV0aWxzLndpdGhEQihhc3luYyBkYiA9PiB7XG5cdFx0XHRcdFx0YXdhaXQgUHJvbWlzZS5hbGwoXG5cdFx0XHRcdFx0XHRPYmplY3QudmFsdWVzKHRoaXMuc3RvcmVOYW1lcykubWFwKHN0b3JlID0+XG5cdFx0XHRcdFx0XHRcdGRiXG5cdFx0XHRcdFx0XHRcdFx0LnRyYW5zYWN0aW9uKHN0b3JlLCAncmVhZHdyaXRlJylcblx0XHRcdFx0XHRcdFx0XHQub2JqZWN0U3RvcmUoc3RvcmUpXG5cdFx0XHRcdFx0XHRcdFx0LmNsZWFyKClcblx0XHRcdFx0XHRcdClcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdGF3YWl0IHRoaXMuZGJVdGlscy5oYW5kbGVEYXRhKFxuXHRcdFx0XHRcdFx0dGhpcy5zdG9yZU5hbWVzLlNFVFRJTkdTIGFzIGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0XHRcdFx0XHR0aGlzLmRiVXRpbHMuZ2V0RGVmYXVsdEtleSgnQVBQX1NFVFRJTkdTJyksXG5cdFx0XHRcdFx0XHQncHV0Jyxcblx0XHRcdFx0XHRcdHRoaXMuZGVmYXVsdFNldHRpbmdzXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9LFxuXHRcdFx0J0ZhaWxlZCB0byByZXNldCBkYXRhYmFzZScsXG5cdFx0XHQnREJTZXJ2aWNlLnJlc2V0RGF0YWJhc2UnXG5cdFx0KTtcblx0fVxufVxuIl19