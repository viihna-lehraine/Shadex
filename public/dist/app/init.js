// File: app/init.ts
import { EventManager } from '../events/EventManager.js';
import { PaletteEvents } from '../events/PaletteEvents.js';
import { PaletteManager } from '../palette/PaletteManager.js';
import { PaletteState } from '../state/PaletteState.js';
import { StateManager } from '../state/StateManager.js';
import { UIEvents } from '../events/UIEvents.js';
import { createHelpers } from '../common/factories/helpers.js';
import { createServices } from '../common/factories/services.js';
import { createUtils } from '../common/factories/utils.js';
import { generateHuesFnGroup } from '../palette/partials/hues.js';
import { generatePalette } from '../palette/generate.js';
import { generatePaletteFnGroup } from '../palette/partials/types.js';
import { data } from '../config/index.js';
const mode = data.mode;
export async function initializeApp(services) {
    const { errors, log } = services;
    return await errors.handleAsync(async () => {
        let events = null;
        // 1. create empty placeholders for utils and helpers
        log('[1] Creating placeholders for utils and helpers...');
        const utils = {};
        const helpers = {};
        // 2. initialize utils (pass placeholders)
        log('[2] Calling initializeUtils...');
        Object.assign(utils, await initializeUtils(helpers, services));
        // 3. initialize helpers (pass placeholders and utils)
        log('[3] Calling initializeHelpers...');
        Object.assign(helpers, await initializeHelpers(services, utils));
        // 4. create the Common Fns object with all properties required
        const common = {
            helpers,
            services,
            utils
        };
        log('[4] Common functions object created.');
        // 5. initialize StateManager
        log('[5] Calling initializeStateManager...');
        const stateManager = await initializeStateManager(services, utils);
        // 6. initialize PaletteState
        log('[6] Calling initializePaletteState...');
        const paletteState = await initializePaletteState(services, stateManager, utils);
        // 7. initialize PaletteManager
        log('[7] Calling initializePaletteManager...');
        const paletteManager = await initializePaletteManager(stateManager, common, generateHuesFnGroup, generatePaletteFnGroup, generatePalette);
        log('[7-D] PaletteManager initialized successfully.', 'debug', 3);
        // 8. instantiate Event Manager
        log('[8] Calling EventManager.getInstance()...');
        const eventManager = EventManager.getInstance();
        // 9. initialize Events
        log('[9] Calling initializeEvents...');
        events = (await initializeEvents(paletteManager, paletteState, services, stateManager, utils));
        // 9a. expose classes to window
        if (mode.exposeToWindow) {
            log('[9a] Calling exposeToWindow...');
            await exposeToWindow(eventManager, events.palette, paletteManager, services, stateManager, events.ui);
        }
        // 10. Ensure state is fully initialized before rendering initial palette
        log('[10] Calling stateManager.ensureStateReady()...');
        await stateManager.ensureStateReady();
        // 11. Render initial palette
        log('[11] Calling paletteManager.loadPalette()...');
        await paletteManager.loadPalette();
        log('[11-D] After paletteManager.loadPalette()...', 'debug');
        // 12. Log initialization complete
        console.log('[12] Initialization complete.');
        return {
            common,
            events,
            paletteManager: paletteManager,
            paletteState: paletteState,
            stateManager: stateManager
        };
    }, 'Error initializing application');
}
export function initializeServices() {
    try {
        console.log(`[initializeServices-1] Creating services....`);
        const services = createServices();
        services.log(`[2] Services initialized.`);
        return services;
    }
    catch (err) {
        console.error(`[initializeServices-ERR] Error: ${err}`);
        throw err;
    }
}
//
/// *********************************************
//// ******** HOISTED HELPER FUNCTIONS ********
/// *********************************************
//
async function exposeToWindow(eventManager, paletteEvents, paletteManager, services, stateManager, uiEvents) {
    const { log, errors } = services;
    await errors.handleAsync(async () => {
        log('[exposeToWindow-1] Exposing functions to window...');
        window.eventManager = eventManager;
        window.paletteEvents = paletteEvents;
        window.paletteManager = paletteManager;
        window.stateManager = stateManager;
        window.uiEvents = uiEvents;
        window.EventManager = EventManager;
        log('[exposeToWindow-2] Functions exposed to window.');
    }, 'Error exposing functions to window');
}
async function initializeEvents(paletteManager, paletteState, services, stateManager, utils) {
    const { errors, log } = services;
    log('[1] Creating event handlers...');
    await errors.handleAsync(async () => {
        const paletteEvents = new PaletteEvents(paletteManager, paletteState, services, stateManager, utils);
        const uiEvents = new UIEvents(paletteManager, services, utils);
        paletteEvents.init();
        uiEvents.init();
        uiEvents.initButtons();
        log('[2] Events initialized.');
        return { palette: paletteEvents, ui: uiEvents };
    }, 'Error initializing events');
}
async function initializeHelpers(services, utils) {
    const { log, errors } = services;
    await errors.handleAsync(async () => {
        log('[1] Creating helpers...');
        const helpers = await createHelpers(services, utils);
        log('[2] Helpers initialized.');
        return helpers;
    }, 'Error initializing helpers');
}
async function initializePaletteManager(stateManager, common, generateHuesFnGroup, generatePaletteFnGroup, generatePalette) {
    const { log, errors } = common.services;
    await errors.handleAsync(async () => {
        log('[1] Creating palette manager...');
        // Fix: Just instantiate without recursion
        const paletteManager = new PaletteManager(stateManager, common, generateHuesFnGroup, generatePaletteFnGroup, generatePalette);
        log(`[2] PaletteManager initialized.`);
        return paletteManager;
    }, 'Error initializing PaletteManager');
}
async function initializePaletteState(services, stateManager, utils) {
    const { log, errors } = services;
    await errors.handleAsync(async () => {
        log('[1] Creating palette state...');
        const palettestate = new PaletteState(stateManager, services, utils);
        log('[2] PaletteState initialized.');
        return palettestate;
    }, 'Error initializing PaletteState');
}
async function initializeStateManager(services, utils) {
    const { log, errors } = services;
    await errors.handleAsync(async () => {
        log('[1] Creating state manager...');
        const stateManager = StateManager.getInstance(services, utils);
        log('[2] StateManager initialized.');
        return stateManager;
    }, 'Error initializing StateManager');
}
async function initializeUtils(helpers, services) {
    const { log, errors } = services;
    await errors.handleAsync(async () => {
        log('[initUtils-1] Creating utils...');
        const utils = await createUtils(helpers, services);
        log('[initUtils-2] Utils initialized.');
        return utils;
    }, 'Error initializing utils');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcHAvaW5pdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxvQkFBb0I7QUFXcEIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDakQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNqRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDM0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDbEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUUxQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBRXZCLE1BQU0sQ0FBQyxLQUFLLFVBQVUsYUFBYSxDQUFDLFFBQTJCO0lBVTlELE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsUUFBUSxDQUFDO0lBRWpDLE9BQU8sTUFBTSxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQzFDLElBQUksTUFBTSxHQUFvRCxJQUFJLENBQUM7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O1FBQ25DLEdBQUcsQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sWUFBWSxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9ELEdBQUcsQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1FBQ3JDLE9BQU8sWUFBWSxDQUFDO0lBQ3JCLENBQUMsRUFBRSxpQ0FBaUMsQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxLQUFLLFVBQVUsZUFBZSxDQUM3QixPQUF5QixFQUN6QixRQUEyQjtJQUUzQixNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLFFBQVEsQ0FBQztJQUNqQyxNQUFNLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkMsR0FBRyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7UUFDdkMsTUFBTSxLQUFLLEdBQUcsTUFBTSxXQUFXLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ25ELEdBQUcsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1FBQ3hDLE9BQU8sS0FBSyxDQUFDO0lBQ2QsQ0FBQyxFQUFFLDBCQUEwQixDQUFDLENBQUM7QUFDaEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IGFwcC9pbml0LnRzXG5cbmltcG9ydCB0eXBlIHtcblx0Q29tbW9uRnVuY3Rpb25zLFxuXHRHZW5lcmF0ZUh1ZXNGbkdyb3VwLFxuXHRHZW5lcmF0ZVBhbGV0dGVGbixcblx0R2VuZXJhdGVQYWxldHRlRm5Hcm91cCxcblx0SGVscGVyc0ludGVyZmFjZSxcblx0U2VydmljZXNJbnRlcmZhY2UsXG5cdFV0aWxpdGllc0ludGVyZmFjZVxufSBmcm9tICcuLi90eXBlcy9pbmRleC5qcyc7XG5pbXBvcnQgeyBFdmVudE1hbmFnZXIgfSBmcm9tICcuLi9ldmVudHMvRXZlbnRNYW5hZ2VyLmpzJztcbmltcG9ydCB7IFBhbGV0dGVFdmVudHMgfSBmcm9tICcuLi9ldmVudHMvUGFsZXR0ZUV2ZW50cy5qcyc7XG5pbXBvcnQgeyBQYWxldHRlTWFuYWdlciB9IGZyb20gJy4uL3BhbGV0dGUvUGFsZXR0ZU1hbmFnZXIuanMnO1xuaW1wb3J0IHsgUGFsZXR0ZVN0YXRlIH0gZnJvbSAnLi4vc3RhdGUvUGFsZXR0ZVN0YXRlLmpzJztcbmltcG9ydCB7IFN0YXRlTWFuYWdlciB9IGZyb20gJy4uL3N0YXRlL1N0YXRlTWFuYWdlci5qcyc7XG5pbXBvcnQgeyBVSUV2ZW50cyB9IGZyb20gJy4uL2V2ZW50cy9VSUV2ZW50cy5qcyc7XG5pbXBvcnQgeyBjcmVhdGVIZWxwZXJzIH0gZnJvbSAnLi4vY29tbW9uL2ZhY3Rvcmllcy9oZWxwZXJzLmpzJztcbmltcG9ydCB7IGNyZWF0ZVNlcnZpY2VzIH0gZnJvbSAnLi4vY29tbW9uL2ZhY3Rvcmllcy9zZXJ2aWNlcy5qcyc7XG5pbXBvcnQgeyBjcmVhdGVVdGlscyB9IGZyb20gJy4uL2NvbW1vbi9mYWN0b3JpZXMvdXRpbHMuanMnO1xuaW1wb3J0IHsgZ2VuZXJhdGVIdWVzRm5Hcm91cCB9IGZyb20gJy4uL3BhbGV0dGUvcGFydGlhbHMvaHVlcy5qcyc7XG5pbXBvcnQgeyBnZW5lcmF0ZVBhbGV0dGUgfSBmcm9tICcuLi9wYWxldHRlL2dlbmVyYXRlLmpzJztcbmltcG9ydCB7IGdlbmVyYXRlUGFsZXR0ZUZuR3JvdXAgfSBmcm9tICcuLi9wYWxldHRlL3BhcnRpYWxzL3R5cGVzLmpzJztcbmltcG9ydCB7IGRhdGEgfSBmcm9tICcuLi9jb25maWcvaW5kZXguanMnO1xuXG5jb25zdCBtb2RlID0gZGF0YS5tb2RlO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZUFwcChzZXJ2aWNlczogU2VydmljZXNJbnRlcmZhY2UpOiBQcm9taXNlPHtcblx0Y29tbW9uOiBSZXF1aXJlZDxDb21tb25GdW5jdGlvbnM+O1xuXHRldmVudHM6IHtcblx0XHRwYWxldHRlOiBQYWxldHRlRXZlbnRzO1xuXHRcdHVpOiBVSUV2ZW50cztcblx0fTtcblx0cGFsZXR0ZU1hbmFnZXI6IFBhbGV0dGVNYW5hZ2VyO1xuXHRwYWxldHRlU3RhdGU6IFBhbGV0dGVTdGF0ZTtcblx0c3RhdGVNYW5hZ2VyOiBTdGF0ZU1hbmFnZXI7XG59IHwgdm9pZD4ge1xuXHRjb25zdCB7IGVycm9ycywgbG9nIH0gPSBzZXJ2aWNlcztcblxuXHRyZXR1cm4gYXdhaXQgZXJyb3JzLmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHtcblx0XHRsZXQgZXZlbnRzOiB7IHBhbGV0dGU6IFBhbGV0dGVFdmVudHM7IHVpOiBVSUV2ZW50cyB9IHwgbnVsbCA9IG51bGw7XG5cblx0XHQvLyAxLiBjcmVhdGUgZW1wdHkgcGxhY2Vob2xkZXJzIGZvciB1dGlscyBhbmQgaGVscGVyc1xuXHRcdGxvZygnWzFdIENyZWF0aW5nIHBsYWNlaG9sZGVycyBmb3IgdXRpbHMgYW5kIGhlbHBlcnMuLi4nKTtcblx0XHRjb25zdCB1dGlscyA9IHt9IGFzIFV0aWxpdGllc0ludGVyZmFjZTtcblx0XHRjb25zdCBoZWxwZXJzID0ge30gYXMgSGVscGVyc0ludGVyZmFjZTtcblxuXHRcdC8vIDIuIGluaXRpYWxpemUgdXRpbHMgKHBhc3MgcGxhY2Vob2xkZXJzKVxuXHRcdGxvZygnWzJdIENhbGxpbmcgaW5pdGlhbGl6ZVV0aWxzLi4uJyk7XG5cdFx0T2JqZWN0LmFzc2lnbih1dGlscywgYXdhaXQgaW5pdGlhbGl6ZVV0aWxzKGhlbHBlcnMsIHNlcnZpY2VzKSk7XG5cblx0XHQvLyAzLiBpbml0aWFsaXplIGhlbHBlcnMgKHBhc3MgcGxhY2Vob2xkZXJzIGFuZCB1dGlscylcblx0XHRsb2coJ1szXSBDYWxsaW5nIGluaXRpYWxpemVIZWxwZXJzLi4uJyk7XG5cdFx0T2JqZWN0LmFzc2lnbihoZWxwZXJzLCBhd2FpdCBpbml0aWFsaXplSGVscGVycyhzZXJ2aWNlcywgdXRpbHMpKTtcblxuXHRcdC8vIDQuIGNyZWF0ZSB0aGUgQ29tbW9uIEZucyBvYmplY3Qgd2l0aCBhbGwgcHJvcGVydGllcyByZXF1aXJlZFxuXHRcdGNvbnN0IGNvbW1vbjogUmVxdWlyZWQ8Q29tbW9uRnVuY3Rpb25zPiA9IHtcblx0XHRcdGhlbHBlcnMsXG5cdFx0XHRzZXJ2aWNlcyxcblx0XHRcdHV0aWxzXG5cdFx0fTtcblx0XHRsb2coJ1s0XSBDb21tb24gZnVuY3Rpb25zIG9iamVjdCBjcmVhdGVkLicpO1xuXG5cdFx0Ly8gNS4gaW5pdGlhbGl6ZSBTdGF0ZU1hbmFnZXJcblx0XHRsb2coJ1s1XSBDYWxsaW5nIGluaXRpYWxpemVTdGF0ZU1hbmFnZXIuLi4nKTtcblx0XHRjb25zdCBzdGF0ZU1hbmFnZXIgPSBhd2FpdCBpbml0aWFsaXplU3RhdGVNYW5hZ2VyKHNlcnZpY2VzLCB1dGlscyk7XG5cblx0XHQvLyA2LiBpbml0aWFsaXplIFBhbGV0dGVTdGF0ZVxuXHRcdGxvZygnWzZdIENhbGxpbmcgaW5pdGlhbGl6ZVBhbGV0dGVTdGF0ZS4uLicpO1xuXHRcdGNvbnN0IHBhbGV0dGVTdGF0ZSA9IGF3YWl0IGluaXRpYWxpemVQYWxldHRlU3RhdGUoXG5cdFx0XHRzZXJ2aWNlcyxcblx0XHRcdHN0YXRlTWFuYWdlciEsXG5cdFx0XHR1dGlsc1xuXHRcdCk7XG5cblx0XHQvLyA3LiBpbml0aWFsaXplIFBhbGV0dGVNYW5hZ2VyXG5cdFx0bG9nKCdbN10gQ2FsbGluZyBpbml0aWFsaXplUGFsZXR0ZU1hbmFnZXIuLi4nKTtcblx0XHRjb25zdCBwYWxldHRlTWFuYWdlciA9IGF3YWl0IGluaXRpYWxpemVQYWxldHRlTWFuYWdlcihcblx0XHRcdHN0YXRlTWFuYWdlciEsXG5cdFx0XHRjb21tb24sXG5cdFx0XHRnZW5lcmF0ZUh1ZXNGbkdyb3VwLFxuXHRcdFx0Z2VuZXJhdGVQYWxldHRlRm5Hcm91cCxcblx0XHRcdGdlbmVyYXRlUGFsZXR0ZVxuXHRcdCk7XG5cdFx0bG9nKCdbNy1EXSBQYWxldHRlTWFuYWdlciBpbml0aWFsaXplZCBzdWNjZXNzZnVsbHkuJywgJ2RlYnVnJywgMyk7XG5cblx0XHQvLyA4LiBpbnN0YW50aWF0ZSBFdmVudCBNYW5hZ2VyXG5cdFx0bG9nKCdbOF0gQ2FsbGluZyBFdmVudE1hbmFnZXIuZ2V0SW5zdGFuY2UoKS4uLicpO1xuXHRcdGNvbnN0IGV2ZW50TWFuYWdlciA9IEV2ZW50TWFuYWdlci5nZXRJbnN0YW5jZSgpO1xuXG5cdFx0Ly8gOS4gaW5pdGlhbGl6ZSBFdmVudHNcblx0XHRsb2coJ1s5XSBDYWxsaW5nIGluaXRpYWxpemVFdmVudHMuLi4nKTtcblx0XHRldmVudHMgPSAoYXdhaXQgaW5pdGlhbGl6ZUV2ZW50cyhcblx0XHRcdHBhbGV0dGVNYW5hZ2VyISxcblx0XHRcdHBhbGV0dGVTdGF0ZSEsXG5cdFx0XHRzZXJ2aWNlcyxcblx0XHRcdHN0YXRlTWFuYWdlciEsXG5cdFx0XHR1dGlsc1xuXHRcdCkpITtcblxuXHRcdC8vIDlhLiBleHBvc2UgY2xhc3NlcyB0byB3aW5kb3dcblx0XHRpZiAobW9kZS5leHBvc2VUb1dpbmRvdykge1xuXHRcdFx0bG9nKCdbOWFdIENhbGxpbmcgZXhwb3NlVG9XaW5kb3cuLi4nKTtcblx0XHRcdGF3YWl0IGV4cG9zZVRvV2luZG93KFxuXHRcdFx0XHRldmVudE1hbmFnZXIsXG5cdFx0XHRcdGV2ZW50cyEucGFsZXR0ZSxcblx0XHRcdFx0cGFsZXR0ZU1hbmFnZXIhLFxuXHRcdFx0XHRzZXJ2aWNlcyxcblx0XHRcdFx0c3RhdGVNYW5hZ2VyISxcblx0XHRcdFx0ZXZlbnRzIS51aVxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHQvLyAxMC4gRW5zdXJlIHN0YXRlIGlzIGZ1bGx5IGluaXRpYWxpemVkIGJlZm9yZSByZW5kZXJpbmcgaW5pdGlhbCBwYWxldHRlXG5cdFx0bG9nKCdbMTBdIENhbGxpbmcgc3RhdGVNYW5hZ2VyLmVuc3VyZVN0YXRlUmVhZHkoKS4uLicpO1xuXHRcdGF3YWl0IHN0YXRlTWFuYWdlciEuZW5zdXJlU3RhdGVSZWFkeSgpO1xuXG5cdFx0Ly8gMTEuIFJlbmRlciBpbml0aWFsIHBhbGV0dGVcblx0XHRsb2coJ1sxMV0gQ2FsbGluZyBwYWxldHRlTWFuYWdlci5sb2FkUGFsZXR0ZSgpLi4uJyk7XG5cdFx0YXdhaXQgcGFsZXR0ZU1hbmFnZXIhLmxvYWRQYWxldHRlKCk7XG5cdFx0bG9nKCdbMTEtRF0gQWZ0ZXIgcGFsZXR0ZU1hbmFnZXIubG9hZFBhbGV0dGUoKS4uLicsICdkZWJ1ZycpO1xuXG5cdFx0Ly8gMTIuIExvZyBpbml0aWFsaXphdGlvbiBjb21wbGV0ZVxuXHRcdGNvbnNvbGUubG9nKCdbMTJdIEluaXRpYWxpemF0aW9uIGNvbXBsZXRlLicpO1xuXG5cdFx0cmV0dXJuIHtcblx0XHRcdGNvbW1vbixcblx0XHRcdGV2ZW50cyxcblx0XHRcdHBhbGV0dGVNYW5hZ2VyOiBwYWxldHRlTWFuYWdlciEsXG5cdFx0XHRwYWxldHRlU3RhdGU6IHBhbGV0dGVTdGF0ZSEsXG5cdFx0XHRzdGF0ZU1hbmFnZXI6IHN0YXRlTWFuYWdlciFcblx0XHR9O1xuXHR9LCAnRXJyb3IgaW5pdGlhbGl6aW5nIGFwcGxpY2F0aW9uJyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplU2VydmljZXMoKTogU2VydmljZXNJbnRlcmZhY2Uge1xuXHR0cnkge1xuXHRcdGNvbnNvbGUubG9nKGBbaW5pdGlhbGl6ZVNlcnZpY2VzLTFdIENyZWF0aW5nIHNlcnZpY2VzLi4uLmApO1xuXHRcdGNvbnN0IHNlcnZpY2VzID0gY3JlYXRlU2VydmljZXMoKTtcblx0XHRzZXJ2aWNlcy5sb2coYFsyXSBTZXJ2aWNlcyBpbml0aWFsaXplZC5gKTtcblx0XHRyZXR1cm4gc2VydmljZXM7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGNvbnNvbGUuZXJyb3IoYFtpbml0aWFsaXplU2VydmljZXMtRVJSXSBFcnJvcjogJHtlcnJ9YCk7XG5cdFx0dGhyb3cgZXJyO1xuXHR9XG59XG5cbi8vXG4vLy8gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4vLy8vICoqKioqKioqIEhPSVNURUQgSEVMUEVSIEZVTkNUSU9OUyAqKioqKioqKlxuLy8vICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuLy9cblxuYXN5bmMgZnVuY3Rpb24gZXhwb3NlVG9XaW5kb3coXG5cdGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyLFxuXHRwYWxldHRlRXZlbnRzOiBQYWxldHRlRXZlbnRzLFxuXHRwYWxldHRlTWFuYWdlcjogUGFsZXR0ZU1hbmFnZXIsXG5cdHNlcnZpY2VzOiBTZXJ2aWNlc0ludGVyZmFjZSxcblx0c3RhdGVNYW5hZ2VyOiBTdGF0ZU1hbmFnZXIsXG5cdHVpRXZlbnRzOiBVSUV2ZW50c1xuKTogUHJvbWlzZTx2b2lkPiB7XG5cdGNvbnN0IHsgbG9nLCBlcnJvcnMgfSA9IHNlcnZpY2VzO1xuXG5cdGF3YWl0IGVycm9ycy5oYW5kbGVBc3luYyhhc3luYyAoKSA9PiB7XG5cdFx0bG9nKCdbZXhwb3NlVG9XaW5kb3ctMV0gRXhwb3NpbmcgZnVuY3Rpb25zIHRvIHdpbmRvdy4uLicpO1xuXHRcdHdpbmRvdy5ldmVudE1hbmFnZXIgPSBldmVudE1hbmFnZXI7XG5cdFx0d2luZG93LnBhbGV0dGVFdmVudHMgPSBwYWxldHRlRXZlbnRzO1xuXHRcdHdpbmRvdy5wYWxldHRlTWFuYWdlciA9IHBhbGV0dGVNYW5hZ2VyO1xuXHRcdHdpbmRvdy5zdGF0ZU1hbmFnZXIgPSBzdGF0ZU1hbmFnZXI7XG5cdFx0d2luZG93LnVpRXZlbnRzID0gdWlFdmVudHM7XG5cdFx0d2luZG93LkV2ZW50TWFuYWdlciA9IEV2ZW50TWFuYWdlcjtcblx0XHRsb2coJ1tleHBvc2VUb1dpbmRvdy0yXSBGdW5jdGlvbnMgZXhwb3NlZCB0byB3aW5kb3cuJyk7XG5cdH0sICdFcnJvciBleHBvc2luZyBmdW5jdGlvbnMgdG8gd2luZG93Jyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRpYWxpemVFdmVudHMoXG5cdHBhbGV0dGVNYW5hZ2VyOiBQYWxldHRlTWFuYWdlcixcblx0cGFsZXR0ZVN0YXRlOiBQYWxldHRlU3RhdGUsXG5cdHNlcnZpY2VzOiBTZXJ2aWNlc0ludGVyZmFjZSxcblx0c3RhdGVNYW5hZ2VyOiBTdGF0ZU1hbmFnZXIsXG5cdHV0aWxzOiBVdGlsaXRpZXNJbnRlcmZhY2Vcbik6IFByb21pc2U8e1xuXHRwYWxldHRlOiBQYWxldHRlRXZlbnRzO1xuXHR1aTogVUlFdmVudHM7XG59IHwgdm9pZD4ge1xuXHRjb25zdCB7IGVycm9ycywgbG9nIH0gPSBzZXJ2aWNlcztcblx0bG9nKCdbMV0gQ3JlYXRpbmcgZXZlbnQgaGFuZGxlcnMuLi4nKTtcblxuXHRhd2FpdCBlcnJvcnMuaGFuZGxlQXN5bmMoYXN5bmMgKCkgPT4ge1xuXHRcdGNvbnN0IHBhbGV0dGVFdmVudHMgPSBuZXcgUGFsZXR0ZUV2ZW50cyhcblx0XHRcdHBhbGV0dGVNYW5hZ2VyLFxuXHRcdFx0cGFsZXR0ZVN0YXRlLFxuXHRcdFx0c2VydmljZXMsXG5cdFx0XHRzdGF0ZU1hbmFnZXIsXG5cdFx0XHR1dGlsc1xuXHRcdCk7XG5cdFx0Y29uc3QgdWlFdmVudHMgPSBuZXcgVUlFdmVudHMocGFsZXR0ZU1hbmFnZXIsIHNlcnZpY2VzLCB1dGlscyk7XG5cblx0XHRwYWxldHRlRXZlbnRzLmluaXQoKTtcblxuXHRcdHVpRXZlbnRzLmluaXQoKTtcblx0XHR1aUV2ZW50cy5pbml0QnV0dG9ucygpO1xuXG5cdFx0bG9nKCdbMl0gRXZlbnRzIGluaXRpYWxpemVkLicpO1xuXG5cdFx0cmV0dXJuIHsgcGFsZXR0ZTogcGFsZXR0ZUV2ZW50cywgdWk6IHVpRXZlbnRzIH07XG5cdH0sICdFcnJvciBpbml0aWFsaXppbmcgZXZlbnRzJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRpYWxpemVIZWxwZXJzKFxuXHRzZXJ2aWNlczogU2VydmljZXNJbnRlcmZhY2UsXG5cdHV0aWxzOiBVdGlsaXRpZXNJbnRlcmZhY2Vcbik6IFByb21pc2U8SGVscGVyc0ludGVyZmFjZSB8IHZvaWQ+IHtcblx0Y29uc3QgeyBsb2csIGVycm9ycyB9ID0gc2VydmljZXM7XG5cblx0YXdhaXQgZXJyb3JzLmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHtcblx0XHRsb2coJ1sxXSBDcmVhdGluZyBoZWxwZXJzLi4uJyk7XG5cdFx0Y29uc3QgaGVscGVycyA9IGF3YWl0IGNyZWF0ZUhlbHBlcnMoc2VydmljZXMsIHV0aWxzKTtcblx0XHRsb2coJ1syXSBIZWxwZXJzIGluaXRpYWxpemVkLicpO1xuXHRcdHJldHVybiBoZWxwZXJzO1xuXHR9LCAnRXJyb3IgaW5pdGlhbGl6aW5nIGhlbHBlcnMnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZVBhbGV0dGVNYW5hZ2VyKFxuXHRzdGF0ZU1hbmFnZXI6IFN0YXRlTWFuYWdlcixcblx0Y29tbW9uOiBDb21tb25GdW5jdGlvbnMsXG5cdGdlbmVyYXRlSHVlc0ZuR3JvdXA6IEdlbmVyYXRlSHVlc0ZuR3JvdXAsXG5cdGdlbmVyYXRlUGFsZXR0ZUZuR3JvdXA6IEdlbmVyYXRlUGFsZXR0ZUZuR3JvdXAsXG5cdGdlbmVyYXRlUGFsZXR0ZTogR2VuZXJhdGVQYWxldHRlRm5cbik6IFByb21pc2U8UGFsZXR0ZU1hbmFnZXIgfCB2b2lkPiB7XG5cdGNvbnN0IHsgbG9nLCBlcnJvcnMgfSA9IGNvbW1vbi5zZXJ2aWNlcztcblxuXHRhd2FpdCBlcnJvcnMuaGFuZGxlQXN5bmMoYXN5bmMgKCkgPT4ge1xuXHRcdGxvZygnWzFdIENyZWF0aW5nIHBhbGV0dGUgbWFuYWdlci4uLicpO1xuXG5cdFx0Ly8gRml4OiBKdXN0IGluc3RhbnRpYXRlIHdpdGhvdXQgcmVjdXJzaW9uXG5cdFx0Y29uc3QgcGFsZXR0ZU1hbmFnZXIgPSBuZXcgUGFsZXR0ZU1hbmFnZXIoXG5cdFx0XHRzdGF0ZU1hbmFnZXIsXG5cdFx0XHRjb21tb24sXG5cdFx0XHRnZW5lcmF0ZUh1ZXNGbkdyb3VwLFxuXHRcdFx0Z2VuZXJhdGVQYWxldHRlRm5Hcm91cCxcblx0XHRcdGdlbmVyYXRlUGFsZXR0ZVxuXHRcdCk7XG5cblx0XHRsb2coYFsyXSBQYWxldHRlTWFuYWdlciBpbml0aWFsaXplZC5gKTtcblx0XHRyZXR1cm4gcGFsZXR0ZU1hbmFnZXI7XG5cdH0sICdFcnJvciBpbml0aWFsaXppbmcgUGFsZXR0ZU1hbmFnZXInKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZVBhbGV0dGVTdGF0ZShcblx0c2VydmljZXM6IFNlcnZpY2VzSW50ZXJmYWNlLFxuXHRzdGF0ZU1hbmFnZXI6IFN0YXRlTWFuYWdlcixcblx0dXRpbHM6IFV0aWxpdGllc0ludGVyZmFjZVxuKTogUHJvbWlzZTxQYWxldHRlU3RhdGUgfCB2b2lkPiB7XG5cdGNvbnN0IHsgbG9nLCBlcnJvcnMgfSA9IHNlcnZpY2VzO1xuXHRhd2FpdCBlcnJvcnMuaGFuZGxlQXN5bmMoYXN5bmMgKCkgPT4ge1xuXHRcdGxvZygnWzFdIENyZWF0aW5nIHBhbGV0dGUgc3RhdGUuLi4nKTtcblx0XHRjb25zdCBwYWxldHRlc3RhdGUgPSBuZXcgUGFsZXR0ZVN0YXRlKHN0YXRlTWFuYWdlciwgc2VydmljZXMsIHV0aWxzKTtcblx0XHRsb2coJ1syXSBQYWxldHRlU3RhdGUgaW5pdGlhbGl6ZWQuJyk7XG5cdFx0cmV0dXJuIHBhbGV0dGVzdGF0ZTtcblx0fSwgJ0Vycm9yIGluaXRpYWxpemluZyBQYWxldHRlU3RhdGUnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZVN0YXRlTWFuYWdlcihcblx0c2VydmljZXM6IFNlcnZpY2VzSW50ZXJmYWNlLFxuXHR1dGlsczogVXRpbGl0aWVzSW50ZXJmYWNlXG4pOiBQcm9taXNlPFN0YXRlTWFuYWdlciB8IHZvaWQ+IHtcblx0Y29uc3QgeyBsb2csIGVycm9ycyB9ID0gc2VydmljZXM7XG5cdGF3YWl0IGVycm9ycy5oYW5kbGVBc3luYyhhc3luYyAoKSA9PiB7XG5cdFx0bG9nKCdbMV0gQ3JlYXRpbmcgc3RhdGUgbWFuYWdlci4uLicpO1xuXHRcdGNvbnN0IHN0YXRlTWFuYWdlciA9IFN0YXRlTWFuYWdlci5nZXRJbnN0YW5jZShzZXJ2aWNlcywgdXRpbHMpO1xuXHRcdGxvZygnWzJdIFN0YXRlTWFuYWdlciBpbml0aWFsaXplZC4nKTtcblx0XHRyZXR1cm4gc3RhdGVNYW5hZ2VyO1xuXHR9LCAnRXJyb3IgaW5pdGlhbGl6aW5nIFN0YXRlTWFuYWdlcicpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0aWFsaXplVXRpbHMoXG5cdGhlbHBlcnM6IEhlbHBlcnNJbnRlcmZhY2UsXG5cdHNlcnZpY2VzOiBTZXJ2aWNlc0ludGVyZmFjZVxuKTogUHJvbWlzZTxVdGlsaXRpZXNJbnRlcmZhY2UgfCB2b2lkPiB7XG5cdGNvbnN0IHsgbG9nLCBlcnJvcnMgfSA9IHNlcnZpY2VzO1xuXHRhd2FpdCBlcnJvcnMuaGFuZGxlQXN5bmMoYXN5bmMgKCkgPT4ge1xuXHRcdGxvZygnW2luaXRVdGlscy0xXSBDcmVhdGluZyB1dGlscy4uLicpO1xuXHRcdGNvbnN0IHV0aWxzID0gYXdhaXQgY3JlYXRlVXRpbHMoaGVscGVycywgc2VydmljZXMpO1xuXHRcdGxvZygnW2luaXRVdGlscy0yXSBVdGlscyBpbml0aWFsaXplZC4nKTtcblx0XHRyZXR1cm4gdXRpbHM7XG5cdH0sICdFcnJvciBpbml0aWFsaXppbmcgdXRpbHMnKTtcbn1cbiJdfQ==