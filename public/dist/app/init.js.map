{"version":3,"file":"init.js","sources":["../../../../src/app/init.ts"],"sourcesContent":["// File: app/init.ts\n\nimport type {\n\tCommonFunctions,\n\tGenerateHuesFnGroup,\n\tGeneratePaletteFn,\n\tGeneratePaletteFnGroup,\n\tHelpers,\n\tServices,\n\tUtilities\n} from '../types/index.js';\nimport { EventManager } from '../events/EventManager.js';\nimport { PaletteEvents } from '../events/PaletteEvents.js';\nimport { PaletteManager } from '../palette/PaletteManager.js';\nimport { PaletteState } from '../state/PaletteState.js';\nimport { StateManager } from '../state/StateManager.js';\nimport { UIEvents } from '../events/UIEvents.js';\nimport { config, defaults } from '../config/index.js';\nimport { generateHuesFnGroup } from '../palette/partials/hues.js';\nimport { generatePalette } from '../palette/generate.js';\nimport { generatePaletteFnGroup } from '../palette/partials/types.js';\nimport { helpersFactory } from '../common/factories/helpers.js';\nimport { serviceFactory } from '../common/factories/services.js';\nimport { utilitiesFactory } from '../common/factories/utils.js';\n\nconst initialData = defaults.observerData;\nconst mode = config.mode;\n\nexport async function initializeApp(\n\thelpers: Helpers,\n\tservices: Services\n): Promise<{\n\tcommon: Required<CommonFunctions>;\n\teventManager: EventManager;\n\tevents: { palette: PaletteEvents; ui: UIEvents };\n\tpaletteManager: PaletteManager;\n\tpaletteState: PaletteState;\n\tstateManager: StateManager;\n} | void> {\n\tconst { errors, log } = services;\n\n\treturn await errors.handleAsync(async () => {\n\t\tlet events: { palette: PaletteEvents; ui: UIEvents } | null = null;\n\n\t\t// 1. create empty placeholders for utils and helpers\n\t\tlog('[1] Creating placeholders and helpers...');\n\t\tconst utils = {} as Utilities;\n\n\t\t// 2. initialize utils (pass placeholders)\n\t\tlog('[2] Calling initializeUtils...');\n\t\tObject.assign(utils, await initializeUtils(helpers, services));\n\n\t\t// 3. create the Common Fns object with all properties required\n\t\tconst common: Required<CommonFunctions> = {\n\t\t\thelpers,\n\t\t\tservices,\n\t\t\tutils\n\t\t};\n\t\tlog('[3] Common functions object created.');\n\n\t\t// 5. initialize StateManager\n\t\tlog('[4] Calling initializeStateManager...');\n\t\tconst stateManager = await initializeStateManager(\n\t\t\thelpers,\n\t\t\tservices,\n\t\t\tutils\n\t\t);\n\n\t\t// 5. initialize PaletteState\n\t\tlog('[5] Calling initializePaletteState...');\n\t\tconst paletteState = await initializePaletteState(\n\t\t\tservices,\n\t\t\tstateManager!,\n\t\t\tutils\n\t\t);\n\n\t\t// 6. initialize PaletteManager\n\t\tlog('[6] Calling initializePaletteManager...');\n\t\tconst paletteManager = await initializePaletteManager(\n\t\t\tstateManager!,\n\t\t\tcommon,\n\t\t\tgenerateHuesFnGroup,\n\t\t\tgeneratePaletteFnGroup,\n\t\t\tgeneratePalette\n\t\t);\n\t\tlog('[6-D] PaletteManager initialized successfully.', 'debug', 3);\n\n\t\t// 7. instantiate Event Manager\n\t\tlog('[7] Calling EventManager.getInstance()...');\n\t\tconst eventManager = EventManager.getInstance(services);\n\n\t\t// 8. initialize Events\n\t\tlog('[8] Calling initializeEvents...');\n\t\tevents = (await initializeEvents(\n\t\t\thelpers,\n\t\t\tpaletteManager!,\n\t\t\tpaletteState!,\n\t\t\tservices,\n\t\t\tstateManager!,\n\t\t\tutils\n\t\t))!;\n\n\t\t// 8-A. expose classes to window\n\t\tif (mode.exposeClasses) {\n\t\t\tlog('[8-A] Calling exposeToWindow...');\n\t\t\tawait exposeToWindow(\n\t\t\t\teventManager,\n\t\t\t\tevents!.palette,\n\t\t\t\tpaletteManager!,\n\t\t\t\tservices,\n\t\t\t\tstateManager!,\n\t\t\t\tevents!.ui\n\t\t\t);\n\t\t}\n\n\t\t// 9. Ensure state is fully initialized before rendering initial palette\n\t\tlog('[9] Calling stateManager.ensureStateReady()...');\n\t\tawait stateManager!.ensureStateReady();\n\n\t\t// 10. Render initial palette\n\t\tlog('[10] Calling paletteManager.loadPalette()...');\n\t\tawait paletteManager!.loadPalette();\n\t\tlog('[10-DEBUG] After paletteManager.loadPalette()...', 'debug');\n\n\t\t// 11. Log initialization complete\n\t\tlog('[12] Initialization complete.', 'info', 2);\n\n\t\treturn {\n\t\t\tcommon,\n\t\t\teventManager,\n\t\t\tevents,\n\t\t\tpaletteManager: paletteManager!,\n\t\t\tpaletteState: paletteState!,\n\t\t\tstateManager: stateManager!\n\t\t};\n\t}, 'Error initializing application');\n}\n\nexport async function initializeHelpers(): Promise<Helpers> {\n\ttry {\n\t\tconsole.log('[initializeHelpers-1] Creating helpers...');\n\t\tconst helpers = await helpersFactory();\n\t\tconsole.log('[initializeHelpers-2] Helpers initialized.');\n\t\treturn helpers;\n\t} catch (error) {\n\t\tthrow new Error(`Error initializing helpers: ${error}`);\n\t}\n}\n\nexport function initializeServices(helpers: Helpers): Services {\n\ttry {\n\t\tconsole.log(`[initializeServices-1] Creating services....`);\n\t\tconst services = serviceFactory(helpers, initialData);\n\t\tservices.log(`[initializeServices-2] Services initialized.`);\n\t\treturn services;\n\t} catch (err) {\n\t\tconsole.error(`[initializeServices-ERR] Error: ${err}`);\n\t\tthrow err;\n\t}\n}\n\n//\n/// *********************************************\n//// ******** HOISTED HELPER FUNCTIONS ********\n/// *********************************************\n//\n\nasync function exposeToWindow(\n\teventManager: EventManager,\n\tpaletteEvents: PaletteEvents,\n\tpaletteManager: PaletteManager,\n\tservices: Services,\n\tstateManager: StateManager,\n\tuiEvents: UIEvents\n): Promise<void> {\n\tconst { log, errors } = services;\n\n\tawait errors.handleAsync(async () => {\n\t\tlog('[exposeToWindow-1] Exposing functions to window...');\n\t\twindow.eventManager = eventManager;\n\t\twindow.paletteEvents = paletteEvents;\n\t\twindow.paletteManager = paletteManager;\n\t\twindow.stateManager = stateManager;\n\t\twindow.uiEvents = uiEvents;\n\t\twindow.EventManager = EventManager;\n\t\tlog('[exposeToWindow-2] Functions exposed to window.');\n\t}, 'Error exposing functions to window');\n}\n\nasync function initializeEvents(\n\thelpers: Helpers,\n\tpaletteManager: PaletteManager,\n\tpaletteState: PaletteState,\n\tservices: Services,\n\tstateManager: StateManager,\n\tutils: Utilities\n): Promise<{\n\tpalette: PaletteEvents;\n\tui: UIEvents;\n} | void> {\n\tconst { errors, log } = services;\n\tlog('[1] Creating event handlers...');\n\n\tawait errors.handleAsync(async () => {\n\t\tconst paletteEvents = new PaletteEvents(\n\t\t\thelpers,\n\t\t\tpaletteManager,\n\t\t\tpaletteState,\n\t\t\tservices,\n\t\t\tstateManager,\n\t\t\tutils\n\t\t);\n\t\tconst uiEvents = new UIEvents(helpers, paletteManager, services, utils);\n\n\t\tpaletteEvents.init();\n\n\t\tuiEvents.init();\n\t\tuiEvents.initButtons();\n\n\t\tlog('[2] Events initialized.');\n\n\t\treturn { palette: paletteEvents, ui: uiEvents };\n\t}, 'Error initializing events');\n}\n\nasync function initializePaletteManager(\n\tstateManager: StateManager,\n\tcommon: CommonFunctions,\n\tgenerateHuesFnGroup: GenerateHuesFnGroup,\n\tgeneratePaletteFnGroup: GeneratePaletteFnGroup,\n\tgeneratePalette: GeneratePaletteFn\n): Promise<PaletteManager | void> {\n\tconst { log, errors } = common.services;\n\n\tawait errors.handleAsync(async () => {\n\t\tlog('[1] Creating palette manager...');\n\n\t\t// Fix: Just instantiate without recursion\n\t\tconst paletteManager = new PaletteManager(\n\t\t\tstateManager,\n\t\t\tcommon,\n\t\t\tgenerateHuesFnGroup,\n\t\t\tgeneratePaletteFnGroup,\n\t\t\tgeneratePalette\n\t\t);\n\n\t\tlog(`[2] PaletteManager initialized.`);\n\t\treturn paletteManager;\n\t}, 'Error initializing PaletteManager');\n}\n\nasync function initializePaletteState(\n\tservices: Services,\n\tstateManager: StateManager,\n\tutils: Utilities\n): Promise<PaletteState | void> {\n\tconst { log, errors } = services;\n\tawait errors.handleAsync(async () => {\n\t\tlog('[1] Creating palette state...');\n\t\tconst palettestate = new PaletteState(stateManager, services, utils);\n\t\tlog('[2] PaletteState initialized.');\n\t\treturn palettestate;\n\t}, 'Error initializing PaletteState');\n}\n\nasync function initializeStateManager(\n\thelpers: Helpers,\n\tservices: Services,\n\tutils: Utilities\n): Promise<StateManager | void> {\n\tconst { log, errors } = services;\n\tawait errors.handleAsync(async () => {\n\t\tlog('[1] Creating state manager...');\n\t\tconst stateManager = StateManager.getInstance(helpers, services, utils);\n\t\tlog('[2] StateManager initialized.');\n\t\treturn stateManager;\n\t}, 'Error initializing StateManager');\n}\n\nasync function initializeUtils(\n\thelpers: Helpers,\n\tservices: Services\n): Promise<Utilities | void> {\n\tconst { log, errors } = services;\n\tawait errors.handleAsync(async () => {\n\t\tlog('[initUtils-1] Creating utils...');\n\t\tconst utils = await utilitiesFactory(helpers, services);\n\t\tlog('[initUtils-2] Utils initialized.');\n\t\treturn utils;\n\t}, 'Error initializing utils');\n}\n"],"names":[],"mappings":"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"}