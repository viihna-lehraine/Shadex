// File: state/StateManager.js
import { StorageManager } from '../storage/StorageManager.js';
import { data } from '../config/index.js';
const defaultState = data.defaults.state;
export class StateManager {
    static instance = null;
    onStateLoadCallback = null;
    history;
    state;
    undoStack;
    log;
    errors;
    utils;
    storage;
    constructor(services, utils) {
        this.log = services.log;
        this.errors = services.errors;
        this.utils = utils;
        this.storage = new StorageManager(services);
        this.state = {};
        this.state.paletteHistory = [];
        this.history = [this.state];
        this.undoStack = [];
        this.init();
        this.saveStateAndLog('init', 3);
    }
    static getInstance(services, utils) {
        if (!StateManager.instance) {
            StateManager.instance = new StateManager(services, utils);
        }
        return StateManager.instance;
    }
    async init() {
        this.log('Initializing State Manager', 'debug');
        await this.storage.init();
        this.state =
            (await this.errors.handleAsync(() => this.loadState(), 'Failed to load state. Generating initial state.')) ?? this.generateInitialState();
        this.log('StateManager initialized successfully.', 'debug');
        await this.saveState();
    }
    addPaletteToHistory(palette) {
        this.errors.handle(() => {
            this.trackAction();
            this.state.paletteHistory.push(palette);
            this.saveStateAndLog('paletteHistory', 3);
        }, 'Failed to add palette to history', { palette });
    }
    async ensureStateReady() {
        let attempts = 0;
        const maxAttempts = 20; // prevent infinite loop
        while (!this.state || !this.state.paletteContainer) {
            if (attempts++ >= maxAttempts) {
                this.log('State initialization timed out.', 'error');
                break;
            }
            this.log(`Waiting for state to initialize... (Attempt ${attempts})`, 'debug', 3);
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        this.log('State is now initialized.');
    }
    getState() {
        return (this.errors.handle(() => {
            if (!this.state) {
                throw new Error('State accessed before initialization.');
            }
            if (!this.state.preferences) {
                this.log('State.preferences is undefined. Adding default preferences.', 'warn');
                this.state.preferences = defaultState.preferences;
            }
            return this.state;
        }, 'Error retrieving state') ?? defaultState);
    }
    async loadState() {
        const storedState = await this.storage.getItem('appState');
        if (storedState) {
            this.state = storedState;
            if (this.onStateLoadCallback) {
                this.onStateLoadCallback();
            }
            return storedState;
        }
        else {
            this.log('No stored state found.', 'warn');
            return this.generateInitialState();
        }
    }
    redo() {
        this.errors.handle(() => {
            if (this.undoStack.length > 0) {
                const redoState = this.undoStack.pop();
                if (!redoState) {
                    this.log('Cannot redo: No redoState found.', 'debug');
                    return;
                }
                this.history.push(redoState);
                this.state = { ...redoState };
                this.log('Redo action performed.', 'debug');
                this.saveStateAndLog('redo', 3);
            }
            else {
                throw new Error('No state to redo.');
            }
        }, 'Redo operation failed');
    }
    async resetState() {
        await this.errors.handleAsync(async () => {
            this.trackAction();
            this.state = defaultState;
            await this.saveState();
            this.log('App state has been reset', 'debug');
        }, 'Failed to reset state');
    }
    setOnStateLoad(callback) {
        this.errors.handle(() => {
            this.onStateLoadCallback = callback;
        }, 'Failed to set onStateLoad callback');
    }
    async setState(state, track) {
        if (track)
            this.trackAction();
        this.state = state;
        this.log('App state has been updated', 'debug');
        await this.saveState();
    }
    undo() {
        this.errors.handle(() => {
            if (this.history.length < 1) {
                throw new Error('No previous state to revert to.');
            }
            this.trackAction();
            this.undoStack.push(this.history.pop());
            this.state = { ...this.history[this.history.length - 1] };
            this.log('Undo action performed.', 'debug');
            this.saveStateAndLog('undo', 3);
        }, 'Undo operation failed');
    }
    updateAppModeState(appMode, track) {
        this.errors.handle(() => {
            if (track)
                this.trackAction();
            this.state.appMode = appMode;
            this.log(`Updated appMode: ${appMode}`);
            this.saveStateAndLog('appMode', 3);
        }, 'Failed to update app mode state', { appMode, track });
    }
    updatePaletteColumns(columns, track, verbosity) {
        this.errors.handle(() => {
            if (!this.state || !this.state.paletteContainer) {
                throw new Error('updatePaletteColumns() called before state initialization.');
            }
            if (!this.utils.core.getElement(data.dom.ids.divs.paletteContainer)) {
                this.log('Palette Container not found in the DOM.', 'warn');
            }
            if (track)
                this.trackAction();
            this.state.paletteContainer.columns = columns;
            this.log(`Updated paletteContainer columns`, 'debug');
            this.saveStateAndLog('paletteColumns', verbosity);
        }, 'Failed to update palette columns', { columns, track, verbosity });
    }
    updatePaletteColumnSize(columnID, newSize) {
        this.errors.handle(() => {
            const columns = this.state.paletteContainer.columns;
            const columnIndex = columns.findIndex(col => col.id === columnID);
            if (columnIndex === -1)
                return;
            const minSize = data.config.ui.minColumnSize;
            const maxSize = data.config.ui.maxColumnSize;
            const adjustedSize = Math.max(minSize, Math.min(newSize, maxSize));
            const sizeDifference = adjustedSize - columns[columnIndex].size;
            columns[columnIndex].size = adjustedSize;
            const unlockedColumns = columns.filter((col, index) => index !== columnIndex && !col.isLocked);
            const distributionAmount = sizeDifference / unlockedColumns.length;
            unlockedColumns.forEach(col => (col.size -= distributionAmount));
            const finalTotalSize = columns.reduce((sum, col) => sum + col.size, 0);
            const correctionFactor = 100 / finalTotalSize;
            columns.forEach(col => (col.size *= correctionFactor));
            this.log(`Updated column size`, 'debug');
            this.saveStateAndLog('paletteColumnSize', 3);
        }, 'Failed to update palette column size', { columnID, newSize });
    }
    updatePaletteHistory(updatedHistory) {
        this.errors.handle(() => {
            this.trackAction();
            this.state.paletteHistory = updatedHistory;
            this.saveState();
            this.log('Updated palette history');
        }, 'Failed to update palette history', { updatedHistory });
    }
    updateSelections(selections, track) {
        this.errors.handle(() => {
            if (track)
                this.trackAction();
            this.state.selections = {
                ...this.state.selections,
                ...selections
            };
            this.log(`Updated selections`, 'debug');
            this.saveStateAndLog('selections', 2);
        }, 'Failed to update selections', { selections, track });
    }
    generateInitialState() {
        return (this.errors.handle(() => {
            const columnData = this.utils.dom.scanPaletteColumns();
            this.log(`Scanned ${columnData.length} columns in Palette Container element`, 'debug');
            return {
                appMode: 'edit',
                paletteContainer: { columns: columnData || [] },
                paletteHistory: [],
                preferences: {
                    colorSpace: 'hsl',
                    distributionType: 'soft',
                    maxHistory: 20,
                    maxPaletteHistory: 10,
                    theme: 'light'
                },
                selections: {
                    paletteColumnCount: columnData.length,
                    paletteType: 'complementary',
                    targetedColumnPosition: 1
                },
                timestamp: this.utils.app.getFormattedTimestamp()
            };
        }, 'Failed to generate initial state') ?? defaultState);
    }
    saveStateAndLog(property, verbosity) {
        this.log(`StateManager Updated ${property}`, 'debug', verbosity);
        this.saveState();
    }
    async saveState() {
        await this.errors.handleAsync(() => this.storage.setItem('appState', this.state), 'Failed to save app state.');
    }
    trackAction() {
        // push a copy of the current state before making changes
        this.history.push({ ...this.state });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhdGVNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3N0YXRlL1N0YXRlTWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw4QkFBOEI7QUFVOUIsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQzlELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUUxQyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztBQUV6QyxNQUFNLE9BQU8sWUFBWTtJQUNoQixNQUFNLENBQUMsUUFBUSxHQUF3QixJQUFJLENBQUM7SUFDNUMsbUJBQW1CLEdBQXdCLElBQUksQ0FBQztJQUNoRCxPQUFPLENBQVU7SUFDakIsS0FBSyxDQUFRO0lBQ2IsU0FBUyxDQUFVO0lBQ25CLEdBQUcsQ0FBMkI7SUFDOUIsTUFBTSxDQUE4QjtJQUNwQyxLQUFLLENBQXFCO0lBQzFCLE9BQU8sQ0FBaUI7SUFFaEMsWUFDQyxRQUEyQixFQUMzQixLQUF5QjtRQUV6QixJQUFJLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUM7UUFDeEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDO1FBQzlCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFNUMsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFXLENBQUM7UUFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1os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QVc7UUFDbEIseURBQXlEO1FBQ3pELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUN0QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gRmlsZTogc3RhdGUvU3RhdGVNYW5hZ2VyLmpzXG5cbmltcG9ydCB7XG5cdEhpc3RvcnksXG5cdFBhbGV0dGUsXG5cdFNlcnZpY2VzSW50ZXJmYWNlLFxuXHRTdGF0ZSxcblx0U3RhdGVNYW5hZ2VySW50ZXJmYWNlLFxuXHRVdGlsaXRpZXNJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vdHlwZXMvaW5kZXguanMnO1xuaW1wb3J0IHsgU3RvcmFnZU1hbmFnZXIgfSBmcm9tICcuLi9zdG9yYWdlL1N0b3JhZ2VNYW5hZ2VyLmpzJztcbmltcG9ydCB7IGRhdGEgfSBmcm9tICcuLi9jb25maWcvaW5kZXguanMnO1xuXG5jb25zdCBkZWZhdWx0U3RhdGUgPSBkYXRhLmRlZmF1bHRzLnN0YXRlO1xuXG5leHBvcnQgY2xhc3MgU3RhdGVNYW5hZ2VyIGltcGxlbWVudHMgU3RhdGVNYW5hZ2VySW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IFN0YXRlTWFuYWdlciB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIG9uU3RhdGVMb2FkQ2FsbGJhY2s6ICgoKSA9PiB2b2lkKSB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIGhpc3Rvcnk6IEhpc3Rvcnk7XG5cdHByaXZhdGUgc3RhdGU6IFN0YXRlO1xuXHRwcml2YXRlIHVuZG9TdGFjazogSGlzdG9yeTtcblx0cHJpdmF0ZSBsb2c6IFNlcnZpY2VzSW50ZXJmYWNlWydsb2cnXTtcblx0cHJpdmF0ZSBlcnJvcnM6IFNlcnZpY2VzSW50ZXJmYWNlWydlcnJvcnMnXTtcblx0cHJpdmF0ZSB1dGlsczogVXRpbGl0aWVzSW50ZXJmYWNlO1xuXHRwcml2YXRlIHN0b3JhZ2U6IFN0b3JhZ2VNYW5hZ2VyO1xuXG5cdHByaXZhdGUgY29uc3RydWN0b3IoXG5cdFx0c2VydmljZXM6IFNlcnZpY2VzSW50ZXJmYWNlLFxuXHRcdHV0aWxzOiBVdGlsaXRpZXNJbnRlcmZhY2Vcblx0KSB7XG5cdFx0dGhpcy5sb2cgPSBzZXJ2aWNlcy5sb2c7XG5cdFx0dGhpcy5lcnJvcnMgPSBzZXJ2aWNlcy5lcnJvcnM7XG5cdFx0dGhpcy51dGlscyA9IHV0aWxzO1xuXHRcdHRoaXMuc3RvcmFnZSA9IG5ldyBTdG9yYWdlTWFuYWdlcihzZXJ2aWNlcyk7XG5cblx0XHR0aGlzLnN0YXRlID0ge30gYXMgU3RhdGU7XG5cdFx0dGhpcy5zdGF0ZS5wYWxldHRlSGlzdG9yeSA9IFtdO1xuXHRcdHRoaXMuaGlzdG9yeSA9IFt0aGlzLnN0YXRlXTtcblx0XHR0aGlzLnVuZG9TdGFjayA9IFtdO1xuXHRcdHRoaXMuaW5pdCgpO1xuXHRcdHRoaXMuc2F2ZVN0YXRlQW5kTG9nKCdpbml0JywgMyk7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGdldEluc3RhbmNlKFxuXHRcdHNlcnZpY2VzOiBTZXJ2aWNlc0ludGVyZmFjZSxcblx0XHR1dGlsczogVXRpbGl0aWVzSW50ZXJmYWNlXG5cdCk6IFN0YXRlTWFuYWdlciB7XG5cdFx0aWYgKCFTdGF0ZU1hbmFnZXIuaW5zdGFuY2UpIHtcblx0XHRcdFN0YXRlTWFuYWdlci5pbnN0YW5jZSA9IG5ldyBTdGF0ZU1hbmFnZXIoc2VydmljZXMsIHV0aWxzKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gU3RhdGVNYW5hZ2VyLmluc3RhbmNlO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGluaXQoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dGhpcy5sb2coJ0luaXRpYWxpemluZyBTdGF0ZSBNYW5hZ2VyJywgJ2RlYnVnJyk7XG5cblx0XHRhd2FpdCB0aGlzLnN0b3JhZ2UuaW5pdCgpO1xuXG5cdFx0dGhpcy5zdGF0ZSA9XG5cdFx0XHQoYXdhaXQgdGhpcy5lcnJvcnMuaGFuZGxlQXN5bmMoXG5cdFx0XHRcdCgpID0+IHRoaXMubG9hZFN0YXRlKCksXG5cdFx0XHRcdCdGYWlsZWQgdG8gbG9hZCBzdGF0ZS4gR2VuZXJhdGluZyBpbml0aWFsIHN0YXRlLidcblx0XHRcdCkpID8/IHRoaXMuZ2VuZXJhdGVJbml0aWFsU3RhdGUoKTtcblxuXHRcdHRoaXMubG9nKCdTdGF0ZU1hbmFnZXIgaW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5LicsICdkZWJ1ZycpO1xuXG5cdFx0YXdhaXQgdGhpcy5zYXZlU3RhdGUoKTtcblx0fVxuXG5cdHB1YmxpYyBhZGRQYWxldHRlVG9IaXN0b3J5KHBhbGV0dGU6IFBhbGV0dGUpOiB2b2lkIHtcblx0XHR0aGlzLmVycm9ycy5oYW5kbGUoXG5cdFx0XHQoKSA9PiB7XG5cdFx0XHRcdHRoaXMudHJhY2tBY3Rpb24oKTtcblx0XHRcdFx0dGhpcy5zdGF0ZS5wYWxldHRlSGlzdG9yeS5wdXNoKHBhbGV0dGUpO1xuXHRcdFx0XHR0aGlzLnNhdmVTdGF0ZUFuZExvZygncGFsZXR0ZUhpc3RvcnknLCAzKTtcblx0XHRcdH0sXG5cdFx0XHQnRmFpbGVkIHRvIGFkZCBwYWxldHRlIHRvIGhpc3RvcnknLFxuXHRcdFx0eyBwYWxldHRlIH1cblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGVuc3VyZVN0YXRlUmVhZHkoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0bGV0IGF0dGVtcHRzID0gMDtcblx0XHRjb25zdCBtYXhBdHRlbXB0cyA9IDIwOyAvLyBwcmV2ZW50IGluZmluaXRlIGxvb3BcblxuXHRcdHdoaWxlICghdGhpcy5zdGF0ZSB8fCAhdGhpcy5zdGF0ZS5wYWxldHRlQ29udGFpbmVyKSB7XG5cdFx0XHRpZiAoYXR0ZW1wdHMrKyA+PSBtYXhBdHRlbXB0cykge1xuXHRcdFx0XHR0aGlzLmxvZygnU3RhdGUgaW5pdGlhbGl6YXRpb24gdGltZWQgb3V0LicsICdlcnJvcicpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5sb2coXG5cdFx0XHRcdGBXYWl0aW5nIGZvciBzdGF0ZSB0byBpbml0aWFsaXplLi4uIChBdHRlbXB0ICR7YXR0ZW1wdHN9KWAsXG5cdFx0XHRcdCdkZWJ1ZycsXG5cdFx0XHRcdDNcblx0XHRcdCk7XG5cdFx0XHRhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNTApKTtcblx0XHR9XG5cblx0XHR0aGlzLmxvZygnU3RhdGUgaXMgbm93IGluaXRpYWxpemVkLicpO1xuXHR9XG5cblx0cHVibGljIGdldFN0YXRlKCk6IFN0YXRlIHtcblx0XHRyZXR1cm4gKFxuXHRcdFx0dGhpcy5lcnJvcnMuaGFuZGxlKCgpID0+IHtcblx0XHRcdFx0aWYgKCF0aGlzLnN0YXRlKSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdTdGF0ZSBhY2Nlc3NlZCBiZWZvcmUgaW5pdGlhbGl6YXRpb24uJyk7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKCF0aGlzLnN0YXRlLnByZWZlcmVuY2VzKSB7XG5cdFx0XHRcdFx0dGhpcy5sb2coXG5cdFx0XHRcdFx0XHQnU3RhdGUucHJlZmVyZW5jZXMgaXMgdW5kZWZpbmVkLiBBZGRpbmcgZGVmYXVsdCBwcmVmZXJlbmNlcy4nLFxuXHRcdFx0XHRcdFx0J3dhcm4nXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR0aGlzLnN0YXRlLnByZWZlcmVuY2VzID0gZGVmYXVsdFN0YXRlLnByZWZlcmVuY2VzO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJldHVybiB0aGlzLnN0YXRlO1xuXHRcdFx0fSwgJ0Vycm9yIHJldHJpZXZpbmcgc3RhdGUnKSA/PyBkZWZhdWx0U3RhdGVcblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGxvYWRTdGF0ZSgpOiBQcm9taXNlPFN0YXRlPiB7XG5cdFx0Y29uc3Qgc3RvcmVkU3RhdGUgPSBhd2FpdCB0aGlzLnN0b3JhZ2UuZ2V0SXRlbTxTdGF0ZT4oJ2FwcFN0YXRlJyk7XG5cblx0XHRpZiAoc3RvcmVkU3RhdGUpIHtcblx0XHRcdHRoaXMuc3RhdGUgPSBzdG9yZWRTdGF0ZTtcblxuXHRcdFx0aWYgKHRoaXMub25TdGF0ZUxvYWRDYWxsYmFjaykge1xuXHRcdFx0XHR0aGlzLm9uU3RhdGVMb2FkQ2FsbGJhY2soKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHN0b3JlZFN0YXRlO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLmxvZygnTm8gc3RvcmVkIHN0YXRlIGZvdW5kLicsICd3YXJuJyk7XG5cdFx0XHRyZXR1cm4gdGhpcy5nZW5lcmF0ZUluaXRpYWxTdGF0ZSgpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyByZWRvKCk6IHZvaWQge1xuXHRcdHRoaXMuZXJyb3JzLmhhbmRsZSgoKSA9PiB7XG5cdFx0XHRpZiAodGhpcy51bmRvU3RhY2subGVuZ3RoID4gMCkge1xuXHRcdFx0XHRjb25zdCByZWRvU3RhdGUgPSB0aGlzLnVuZG9TdGFjay5wb3AoKTtcblx0XHRcdFx0aWYgKCFyZWRvU3RhdGUpIHtcblx0XHRcdFx0XHR0aGlzLmxvZygnQ2Fubm90IHJlZG86IE5vIHJlZG9TdGF0ZSBmb3VuZC4nLCAnZGVidWcnKTtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHRcdFx0XHR0aGlzLmhpc3RvcnkucHVzaChyZWRvU3RhdGUpO1xuXHRcdFx0XHR0aGlzLnN0YXRlID0geyAuLi5yZWRvU3RhdGUgfTtcblxuXHRcdFx0XHR0aGlzLmxvZygnUmVkbyBhY3Rpb24gcGVyZm9ybWVkLicsICdkZWJ1ZycpO1xuXHRcdFx0XHR0aGlzLnNhdmVTdGF0ZUFuZExvZygncmVkbycsIDMpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdObyBzdGF0ZSB0byByZWRvLicpO1xuXHRcdFx0fVxuXHRcdH0sICdSZWRvIG9wZXJhdGlvbiBmYWlsZWQnKTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyByZXNldFN0YXRlKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGF3YWl0IHRoaXMuZXJyb3JzLmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHtcblx0XHRcdHRoaXMudHJhY2tBY3Rpb24oKTtcblx0XHRcdHRoaXMuc3RhdGUgPSBkZWZhdWx0U3RhdGU7XG5cdFx0XHRhd2FpdCB0aGlzLnNhdmVTdGF0ZSgpO1xuXHRcdFx0dGhpcy5sb2coJ0FwcCBzdGF0ZSBoYXMgYmVlbiByZXNldCcsICdkZWJ1ZycpO1xuXHRcdH0sICdGYWlsZWQgdG8gcmVzZXQgc3RhdGUnKTtcblx0fVxuXG5cdHB1YmxpYyBzZXRPblN0YXRlTG9hZChjYWxsYmFjazogKCkgPT4gdm9pZCk6IHZvaWQge1xuXHRcdHRoaXMuZXJyb3JzLmhhbmRsZSgoKSA9PiB7XG5cdFx0XHR0aGlzLm9uU3RhdGVMb2FkQ2FsbGJhY2sgPSBjYWxsYmFjaztcblx0XHR9LCAnRmFpbGVkIHRvIHNldCBvblN0YXRlTG9hZCBjYWxsYmFjaycpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHNldFN0YXRlKHN0YXRlOiBTdGF0ZSwgdHJhY2s6IGJvb2xlYW4pOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRpZiAodHJhY2spIHRoaXMudHJhY2tBY3Rpb24oKTtcblx0XHR0aGlzLnN0YXRlID0gc3RhdGU7XG5cdFx0dGhpcy5sb2coJ0FwcCBzdGF0ZSBoYXMgYmVlbiB1cGRhdGVkJywgJ2RlYnVnJyk7XG5cdFx0YXdhaXQgdGhpcy5zYXZlU3RhdGUoKTtcblx0fVxuXG5cdHB1YmxpYyB1bmRvKCk6IHZvaWQge1xuXHRcdHRoaXMuZXJyb3JzLmhhbmRsZSgoKSA9PiB7XG5cdFx0XHRpZiAodGhpcy5oaXN0b3J5Lmxlbmd0aCA8IDEpIHtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdObyBwcmV2aW91cyBzdGF0ZSB0byByZXZlcnQgdG8uJyk7XG5cdFx0XHR9XG5cdFx0XHR0aGlzLnRyYWNrQWN0aW9uKCk7XG5cdFx0XHR0aGlzLnVuZG9TdGFjay5wdXNoKHRoaXMuaGlzdG9yeS5wb3AoKSBhcyBTdGF0ZSk7XG5cdFx0XHR0aGlzLnN0YXRlID0geyAuLi50aGlzLmhpc3RvcnlbdGhpcy5oaXN0b3J5Lmxlbmd0aCAtIDFdIH07XG5cdFx0XHR0aGlzLmxvZygnVW5kbyBhY3Rpb24gcGVyZm9ybWVkLicsICdkZWJ1ZycpO1xuXHRcdFx0dGhpcy5zYXZlU3RhdGVBbmRMb2coJ3VuZG8nLCAzKTtcblx0XHR9LCAnVW5kbyBvcGVyYXRpb24gZmFpbGVkJyk7XG5cdH1cblxuXHRwdWJsaWMgdXBkYXRlQXBwTW9kZVN0YXRlKGFwcE1vZGU6IFN0YXRlWydhcHBNb2RlJ10sIHRyYWNrOiBib29sZWFuKTogdm9pZCB7XG5cdFx0dGhpcy5lcnJvcnMuaGFuZGxlKFxuXHRcdFx0KCkgPT4ge1xuXHRcdFx0XHRpZiAodHJhY2spIHRoaXMudHJhY2tBY3Rpb24oKTtcblx0XHRcdFx0dGhpcy5zdGF0ZS5hcHBNb2RlID0gYXBwTW9kZTtcblx0XHRcdFx0dGhpcy5sb2coYFVwZGF0ZWQgYXBwTW9kZTogJHthcHBNb2RlfWApO1xuXHRcdFx0XHR0aGlzLnNhdmVTdGF0ZUFuZExvZygnYXBwTW9kZScsIDMpO1xuXHRcdFx0fSxcblx0XHRcdCdGYWlsZWQgdG8gdXBkYXRlIGFwcCBtb2RlIHN0YXRlJyxcblx0XHRcdHsgYXBwTW9kZSwgdHJhY2sgfVxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgdXBkYXRlUGFsZXR0ZUNvbHVtbnMoXG5cdFx0Y29sdW1uczogU3RhdGVbJ3BhbGV0dGVDb250YWluZXInXVsnY29sdW1ucyddLFxuXHRcdHRyYWNrOiBib29sZWFuLFxuXHRcdHZlcmJvc2l0eTogbnVtYmVyXG5cdCk6IHZvaWQge1xuXHRcdHRoaXMuZXJyb3JzLmhhbmRsZShcblx0XHRcdCgpID0+IHtcblx0XHRcdFx0aWYgKCF0aGlzLnN0YXRlIHx8ICF0aGlzLnN0YXRlLnBhbGV0dGVDb250YWluZXIpIHtcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXG5cdFx0XHRcdFx0XHQndXBkYXRlUGFsZXR0ZUNvbHVtbnMoKSBjYWxsZWQgYmVmb3JlIHN0YXRlIGluaXRpYWxpemF0aW9uLidcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdCF0aGlzLnV0aWxzLmNvcmUuZ2V0RWxlbWVudDxIVE1MRGl2RWxlbWVudD4oXG5cdFx0XHRcdFx0XHRkYXRhLmRvbS5pZHMuZGl2cy5wYWxldHRlQ29udGFpbmVyXG5cdFx0XHRcdFx0KVxuXHRcdFx0XHQpIHtcblx0XHRcdFx0XHR0aGlzLmxvZygnUGFsZXR0ZSBDb250YWluZXIgbm90IGZvdW5kIGluIHRoZSBET00uJywgJ3dhcm4nKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmICh0cmFjaykgdGhpcy50cmFja0FjdGlvbigpO1xuXHRcdFx0XHR0aGlzLnN0YXRlLnBhbGV0dGVDb250YWluZXIuY29sdW1ucyA9IGNvbHVtbnM7XG5cdFx0XHRcdHRoaXMubG9nKGBVcGRhdGVkIHBhbGV0dGVDb250YWluZXIgY29sdW1uc2AsICdkZWJ1ZycpO1xuXHRcdFx0XHR0aGlzLnNhdmVTdGF0ZUFuZExvZygncGFsZXR0ZUNvbHVtbnMnLCB2ZXJib3NpdHkpO1xuXHRcdFx0fSxcblx0XHRcdCdGYWlsZWQgdG8gdXBkYXRlIHBhbGV0dGUgY29sdW1ucycsXG5cdFx0XHR7IGNvbHVtbnMsIHRyYWNrLCB2ZXJib3NpdHkgfVxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgdXBkYXRlUGFsZXR0ZUNvbHVtblNpemUoY29sdW1uSUQ6IG51bWJlciwgbmV3U2l6ZTogbnVtYmVyKTogdm9pZCB7XG5cdFx0dGhpcy5lcnJvcnMuaGFuZGxlKFxuXHRcdFx0KCkgPT4ge1xuXHRcdFx0XHRjb25zdCBjb2x1bW5zID0gdGhpcy5zdGF0ZS5wYWxldHRlQ29udGFpbmVyLmNvbHVtbnM7XG5cdFx0XHRcdGNvbnN0IGNvbHVtbkluZGV4ID0gY29sdW1ucy5maW5kSW5kZXgoXG5cdFx0XHRcdFx0Y29sID0+IGNvbC5pZCA9PT0gY29sdW1uSURcblx0XHRcdFx0KTtcblx0XHRcdFx0aWYgKGNvbHVtbkluZGV4ID09PSAtMSkgcmV0dXJuO1xuXG5cdFx0XHRcdGNvbnN0IG1pblNpemUgPSBkYXRhLmNvbmZpZy51aS5taW5Db2x1bW5TaXplO1xuXHRcdFx0XHRjb25zdCBtYXhTaXplID0gZGF0YS5jb25maWcudWkubWF4Q29sdW1uU2l6ZTtcblx0XHRcdFx0Y29uc3QgYWRqdXN0ZWRTaXplID0gTWF0aC5tYXgoXG5cdFx0XHRcdFx0bWluU2l6ZSxcblx0XHRcdFx0XHRNYXRoLm1pbihuZXdTaXplLCBtYXhTaXplKVxuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdGNvbnN0IHNpemVEaWZmZXJlbmNlID0gYWRqdXN0ZWRTaXplIC0gY29sdW1uc1tjb2x1bW5JbmRleF0uc2l6ZTtcblx0XHRcdFx0Y29sdW1uc1tjb2x1bW5JbmRleF0uc2l6ZSA9IGFkanVzdGVkU2l6ZTtcblxuXHRcdFx0XHRjb25zdCB1bmxvY2tlZENvbHVtbnMgPSBjb2x1bW5zLmZpbHRlcihcblx0XHRcdFx0XHQoY29sLCBpbmRleCkgPT4gaW5kZXggIT09IGNvbHVtbkluZGV4ICYmICFjb2wuaXNMb2NrZWRcblx0XHRcdFx0KTtcblx0XHRcdFx0Y29uc3QgZGlzdHJpYnV0aW9uQW1vdW50ID1cblx0XHRcdFx0XHRzaXplRGlmZmVyZW5jZSAvIHVubG9ja2VkQ29sdW1ucy5sZW5ndGg7XG5cdFx0XHRcdHVubG9ja2VkQ29sdW1ucy5mb3JFYWNoKFxuXHRcdFx0XHRcdGNvbCA9PiAoY29sLnNpemUgLT0gZGlzdHJpYnV0aW9uQW1vdW50KVxuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdGNvbnN0IGZpbmFsVG90YWxTaXplID0gY29sdW1ucy5yZWR1Y2UoXG5cdFx0XHRcdFx0KHN1bSwgY29sKSA9PiBzdW0gKyBjb2wuc2l6ZSxcblx0XHRcdFx0XHQwXG5cdFx0XHRcdCk7XG5cdFx0XHRcdGNvbnN0IGNvcnJlY3Rpb25GYWN0b3IgPSAxMDAgLyBmaW5hbFRvdGFsU2l6ZTtcblx0XHRcdFx0Y29sdW1ucy5mb3JFYWNoKGNvbCA9PiAoY29sLnNpemUgKj0gY29ycmVjdGlvbkZhY3RvcikpO1xuXG5cdFx0XHRcdHRoaXMubG9nKGBVcGRhdGVkIGNvbHVtbiBzaXplYCwgJ2RlYnVnJyk7XG5cdFx0XHRcdHRoaXMuc2F2ZVN0YXRlQW5kTG9nKCdwYWxldHRlQ29sdW1uU2l6ZScsIDMpO1xuXHRcdFx0fSxcblx0XHRcdCdGYWlsZWQgdG8gdXBkYXRlIHBhbGV0dGUgY29sdW1uIHNpemUnLFxuXHRcdFx0eyBjb2x1bW5JRCwgbmV3U2l6ZSB9XG5cdFx0KTtcblx0fVxuXG5cdHB1YmxpYyB1cGRhdGVQYWxldHRlSGlzdG9yeSh1cGRhdGVkSGlzdG9yeTogUGFsZXR0ZVtdKTogdm9pZCB7XG5cdFx0dGhpcy5lcnJvcnMuaGFuZGxlKFxuXHRcdFx0KCkgPT4ge1xuXHRcdFx0XHR0aGlzLnRyYWNrQWN0aW9uKCk7XG5cdFx0XHRcdHRoaXMuc3RhdGUucGFsZXR0ZUhpc3RvcnkgPSB1cGRhdGVkSGlzdG9yeTtcblx0XHRcdFx0dGhpcy5zYXZlU3RhdGUoKTtcblx0XHRcdFx0dGhpcy5sb2coJ1VwZGF0ZWQgcGFsZXR0ZSBoaXN0b3J5Jyk7XG5cdFx0XHR9LFxuXHRcdFx0J0ZhaWxlZCB0byB1cGRhdGUgcGFsZXR0ZSBoaXN0b3J5Jyxcblx0XHRcdHsgdXBkYXRlZEhpc3RvcnkgfVxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgdXBkYXRlU2VsZWN0aW9ucyhcblx0XHRzZWxlY3Rpb25zOiBQYXJ0aWFsPFN0YXRlWydzZWxlY3Rpb25zJ10+LFxuXHRcdHRyYWNrOiBib29sZWFuXG5cdCk6IHZvaWQge1xuXHRcdHRoaXMuZXJyb3JzLmhhbmRsZShcblx0XHRcdCgpID0+IHtcblx0XHRcdFx0aWYgKHRyYWNrKSB0aGlzLnRyYWNrQWN0aW9uKCk7XG5cdFx0XHRcdHRoaXMuc3RhdGUuc2VsZWN0aW9ucyA9IHtcblx0XHRcdFx0XHQuLi50aGlzLnN0YXRlLnNlbGVjdGlvbnMsXG5cdFx0XHRcdFx0Li4uc2VsZWN0aW9uc1xuXHRcdFx0XHR9O1xuXHRcdFx0XHR0aGlzLmxvZyhgVXBkYXRlZCBzZWxlY3Rpb25zYCwgJ2RlYnVnJyk7XG5cdFx0XHRcdHRoaXMuc2F2ZVN0YXRlQW5kTG9nKCdzZWxlY3Rpb25zJywgMik7XG5cdFx0XHR9LFxuXHRcdFx0J0ZhaWxlZCB0byB1cGRhdGUgc2VsZWN0aW9ucycsXG5cdFx0XHR7IHNlbGVjdGlvbnMsIHRyYWNrIH1cblx0XHQpO1xuXHR9XG5cblx0cHJpdmF0ZSBnZW5lcmF0ZUluaXRpYWxTdGF0ZSgpOiBTdGF0ZSB7XG5cdFx0cmV0dXJuIChcblx0XHRcdHRoaXMuZXJyb3JzLmhhbmRsZSgoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IGNvbHVtbkRhdGEgPSB0aGlzLnV0aWxzLmRvbS5zY2FuUGFsZXR0ZUNvbHVtbnMoKTtcblx0XHRcdFx0dGhpcy5sb2coXG5cdFx0XHRcdFx0YFNjYW5uZWQgJHtjb2x1bW5EYXRhLmxlbmd0aH0gY29sdW1ucyBpbiBQYWxldHRlIENvbnRhaW5lciBlbGVtZW50YCxcblx0XHRcdFx0XHQnZGVidWcnXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0YXBwTW9kZTogJ2VkaXQnLFxuXHRcdFx0XHRcdHBhbGV0dGVDb250YWluZXI6IHsgY29sdW1uczogY29sdW1uRGF0YSB8fCBbXSB9LFxuXHRcdFx0XHRcdHBhbGV0dGVIaXN0b3J5OiBbXSxcblx0XHRcdFx0XHRwcmVmZXJlbmNlczoge1xuXHRcdFx0XHRcdFx0Y29sb3JTcGFjZTogJ2hzbCcsXG5cdFx0XHRcdFx0XHRkaXN0cmlidXRpb25UeXBlOiAnc29mdCcsXG5cdFx0XHRcdFx0XHRtYXhIaXN0b3J5OiAyMCxcblx0XHRcdFx0XHRcdG1heFBhbGV0dGVIaXN0b3J5OiAxMCxcblx0XHRcdFx0XHRcdHRoZW1lOiAnbGlnaHQnXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRzZWxlY3Rpb25zOiB7XG5cdFx0XHRcdFx0XHRwYWxldHRlQ29sdW1uQ291bnQ6IGNvbHVtbkRhdGEubGVuZ3RoLFxuXHRcdFx0XHRcdFx0cGFsZXR0ZVR5cGU6ICdjb21wbGVtZW50YXJ5Jyxcblx0XHRcdFx0XHRcdHRhcmdldGVkQ29sdW1uUG9zaXRpb246IDFcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdHRpbWVzdGFtcDogdGhpcy51dGlscy5hcHAuZ2V0Rm9ybWF0dGVkVGltZXN0YW1wKClcblx0XHRcdFx0fTtcblx0XHRcdH0sICdGYWlsZWQgdG8gZ2VuZXJhdGUgaW5pdGlhbCBzdGF0ZScpID8/IGRlZmF1bHRTdGF0ZVxuXHRcdCk7XG5cdH1cblxuXHRwcml2YXRlIHNhdmVTdGF0ZUFuZExvZyhwcm9wZXJ0eTogc3RyaW5nLCB2ZXJib3NpdHk/OiBudW1iZXIpOiB2b2lkIHtcblx0XHR0aGlzLmxvZyhgU3RhdGVNYW5hZ2VyIFVwZGF0ZWQgJHtwcm9wZXJ0eX1gLCAnZGVidWcnLCB2ZXJib3NpdHkpO1xuXHRcdHRoaXMuc2F2ZVN0YXRlKCk7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIHNhdmVTdGF0ZSgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRhd2FpdCB0aGlzLmVycm9ycy5oYW5kbGVBc3luYyhcblx0XHRcdCgpID0+IHRoaXMuc3RvcmFnZS5zZXRJdGVtKCdhcHBTdGF0ZScsIHRoaXMuc3RhdGUpLFxuXHRcdFx0J0ZhaWxlZCB0byBzYXZlIGFwcCBzdGF0ZS4nXG5cdFx0KTtcblx0fVxuXG5cdHByaXZhdGUgdHJhY2tBY3Rpb24oKTogdm9pZCB7XG5cdFx0Ly8gcHVzaCBhIGNvcHkgb2YgdGhlIGN1cnJlbnQgc3RhdGUgYmVmb3JlIG1ha2luZyBjaGFuZ2VzXG5cdFx0dGhpcy5oaXN0b3J5LnB1c2goeyAuLi50aGlzLnN0YXRlIH0pO1xuXHR9XG59XG4iXX0=