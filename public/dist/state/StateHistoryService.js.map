{"version":3,"file":"StateHistoryService.js","sources":["../../../../src/state/StateHistoryService.ts"],"sourcesContent":["// File: state/StateHistoryService.ts\n\nimport {\n\tHelpers,\n\tHistory,\n\tPalette,\n\tServices,\n\tState,\n\tStateHistoryContract\n} from '../types/index.js';\nimport { env } from '../config/index.js';\n\nconst caller = 'StateHistoryService';\n\nexport class StateHistoryService implements StateHistoryContract {\n\tstatic #instance: StateHistoryService | null = null;\n\n\t#history: History = [];\n\t#redoStack: History = [];\n\t#undoStack: History = [];\n\n\t#clone: Helpers['data']['clone'];\n\t#errors: Services['errors'];\n\t#log: Services['log'];\n\n\tprivate constructor(helpers: Helpers, services: Services) {\n\t\ttry {\n\t\t\tservices.log.debug(\n\t\t\t\t`Constructing ${caller} instance.`,\n\t\t\t\t`${caller} constructor`\n\t\t\t);\n\n\t\t\tthis.#clone = helpers.data.clone;\n\t\t\tthis.#errors = services.errors;\n\t\t\tthis.#log = services.log;\n\t\t} catch (error) {\n\t\t\tthrow new Error(\n\t\t\t\t`[${caller} constructor]: ${\n\t\t\t\t\terror instanceof Error ? error.message : error\n\t\t\t\t}`\n\t\t\t);\n\t\t}\n\t}\n\n\tstatic getInstance(\n\t\thelpers: Helpers,\n\t\tservices: Services\n\t): StateHistoryService {\n\t\treturn services.errors.handleSync(() => {\n\t\t\tif (!StateHistoryService.#instance) {\n\t\t\t\tservices.log.debug(\n\t\t\t\t\t'Creating StateHistory instance.',\n\t\t\t\t\t`${caller}.getInstance`\n\t\t\t\t);\n\n\t\t\t\tStateHistoryService.#instance = new StateHistoryService(\n\t\t\t\t\thelpers,\n\t\t\t\t\tservices\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tservices.log.debug(\n\t\t\t\t`Returning ${caller} instance.`,\n\t\t\t\t`${caller}.getInstance`\n\t\t\t);\n\n\t\t\treturn StateHistoryService.#instance;\n\t\t}, `[${caller}.getInstance]: Error getting instance.`);\n\t}\n\n\t/**\n\t * @description Add a palette to State's palette history and tracks the action\n\t */\n\taddPaletteToHistory(state: State, palette: Palette): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tconst newHistory = [...state.paletteHistory, palette];\n\n\t\t\tif (newHistory.length > env.app.historyLimit) {\n\t\t\t\tnewHistory.shift();\n\t\t\t}\n\n\t\t\t// TODO: state update should be handled by StateStore\n\t\t\tthis.trackAction(state);\n\n\t\t\tthis.#log.debug(`Added palette to history.`, `${caller}.addPalette`);\n\t\t}, `[${caller}.addPaletteToHistory]: Failed to add palette to history.`);\n\t}\n\n\tclearHistory(): void {\n\t\tthis.#errors.handleSync(() => {\n\t\t\tthis.#history = [];\n\t\t\tthis.#redoStack = [];\n\t\t\tthis.#undoStack = [];\n\n\t\t\tthis.#log.info(`History and undo stack cleared.`, `${caller}.clear`);\n\t\t}, `[${caller}.clearHistory]: Failed to clear history.`);\n\t}\n\n\t/**\n\t * @description Redo the previously undone action\n\t */\n\tredo(): State | null {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tif (this.#redoStack.length === 0) {\n\t\t\t\tthis.#log.info(`No redo actions avalable.`, `${caller}.redo`);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst nextState = this.#redoStack.pop();\n\n\t\t\tif (nextState) {\n\t\t\t\tconst clonedState = Object.freeze(this.#clone(nextState));\n\n\t\t\t\t// redo action becomes part of the undo history\n\t\t\t\tthis.#undoStack.push(clonedState);\n\t\t\t\tthis.#history.push(clonedState);\n\n\t\t\t\tthis.#log.debug('Performed redo action.', `${caller}.redo`);\n\n\t\t\t\treturn clonedState;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}, `[${caller}]: Failed to redo action.`);\n\t}\n\n\t/**\n\t * @description Track current state for undo/redo and enforces history limit\n\t */\n\ttrackAction(state: State): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tconst clonedState = Object.freeze(this.#clone(state));\n\t\t\tthis.#history.push(clonedState);\n\n\t\t\tif (this.#history.length > env.app.historyLimit) {\n\t\t\t\tthis.#history.shift();\n\t\t\t}\n\n\t\t\tthis.#log.debug(`Tracked new action in history.`, `${caller}.track`);\n\t\t}, `[${caller}]: Failed to track action.`);\n\t}\n\n\t/**\n\t * @description Undo the last action and return the previous state\n\t */\n\tundo(currentState: State): State | null {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tif (this.#undoStack.length <= 1) {\n\t\t\t\tthis.#log.info('No undo actions available.', `${caller}.undo`);\n\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// save current state for redo stack\n\t\t\tthis.#redoStack.push(Object.freeze(this.#clone(currentState)));\n\t\t\t// revert to the previous action\n\t\t\tconst previousState = this.#undoStack.pop();\n\n\t\t\tif (previousState) {\n\t\t\t\tthis.#log.debug(\n\t\t\t\t\t`Undo successful. Undo stack size: ${this.#undoStack.length} | Redo stack size: ${this.#redoStack.length}`,\n\t\t\t\t\t`${caller}.undo`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn previousState ?? null;\n\t\t}, `[${caller}]: Failed to undo action.`);\n\t}\n}\n"],"names":[],"mappings":"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"}