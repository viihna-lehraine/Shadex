// File: state/StateStore.ts
import { ObserverService } from '../core/services/index.js';
import { env, featureFlags } from '../config/index.js';
const caller = 'StateStore';
export class StateStore {
    static #instance;
    #debouncedSave;
    #observer;
    #state;
    #clone;
    #debounce;
    #errors;
    #log;
    #storage;
    constructor(initialState, helpers, services, storage) {
        try {
            services.log.info(`Constructing ${caller} instance.`, `${caller} constructor`);
            this.#state = Object.freeze({ ...initialState });
            this.#observer = new ObserverService(this.#state, {}, helpers, services);
            this.#storage = storage;
            this.#clone = helpers.data.clone;
            this.#debounce = helpers.time.debounce;
            this.#errors = services.errors;
            this.#log = services.log;
        }
        catch (error) {
            throw new Error(`[${caller} constructor]: ${error instanceof Error ? error.message : error}`);
        }
    }
    static getInstance(initialState, helpers, services, storage) {
        return services.errors.handleSync(() => {
            if (!StateStore.#instance) {
                StateStore.#instance = new StateStore(initialState, helpers, services, storage);
                services.log.info(`Creating new ${caller} instance`, `${caller}.getInstance`);
                return StateStore.#instance;
            }
            services.log.info(`Returning existing ${caller} instance`, `${caller}.getInstance`);
            return StateStore.#instance;
        }, `[${caller}.getInstance]: Failed to create ${caller} instance.`);
    }
    async batchUpdate(updates) {
        this.#errors.handleSync(() => {
            const oldState = this.#state;
            const updatedEntries = Object.entries(updates).filter(([key, value]) => oldState[key] !== value);
            if (updatedEntries.length === 0) {
                this.#log.debug(`No state changes detected for batch update`, `${caller}.batchUpdate`);
                return;
            }
            const newState = Object.freeze(this.#clone({ ...oldState, ...updates }));
            this.#state = newState;
            this.#log.debug(`Batch updated state with keys: ${updatedEntries.map(([k]) => k).join(', ')}`, `${caller}.batchUpdate`);
            console.debug(`[${caller}.batchUpdate]: Batch Update List:`, updates);
            this.#notifyObservers(updates);
            this.saveState(newState);
        }, `[${caller}.batchUpdate]: Failed to perform batch update`);
    }
    get(key) {
        return this.#errors.handleSync(() => {
            return this.#state[key];
        }, `[${caller}.get]: Failed to retrieve state key: ${String(key)}`);
    }
    getState() {
        return this.#errors.handleSync(() => {
            return { ...this.#state };
        }, `[${caller}.getData]: Failed to retrieve full state`);
    }
    async init() {
        this.#debouncedSave = this.#debounce((state) => this.saveState(state, { throttle: false }), env.state.saveThrottleDelay);
        if (featureFlags.loadStateFromStorage) {
            this.#log.warn('Loading state from storage is disabled.', `${caller}.init`);
            return null;
        }
        const loadedState = await this.loadState();
        loadedState
            ? this.#log.info(`State loaded from storage.`, `${caller}.init`)
            : this.#log.warn(`No saved state found.`, `${caller}.init`);
        return loadedState;
    }
    async loadState() {
        return this.#errors.handleAsync(async () => {
            const savedState = await this.#storage.getItem('state');
            if (savedState) {
                this.#state = Object.freeze(this.#clone(savedState));
                // replace observer data with the new state
                this.#observer.replaceData(this.#state);
                this.#log.info('Loaded state from storage.', `${caller}.loadState`);
                return this.#state;
            }
            this.#log.warn('No saved state found.', `${caller}.loadState`);
            return null;
        }, `[${caller}.loadState]: Failed to load state from storage.`);
    }
    off(key, callback) {
        this.#observer.off(key, callback);
    }
    on(key, callback) {
        this.#observer.on(key, callback);
    }
    async saveState(state = this.#state, options = {}) {
        return this.#errors.handleAsync(async () => {
            if (options.throttle) {
                this.#debouncedSave(state);
            }
            else {
                await this.#saveOperation(state);
            }
            this.#log.info('State saved to storage.', `${caller}.saveState`);
        }, `[${caller}.saveState]: Failed to save state to storage.`);
    }
    async set(key, value) {
        this.#errors.handleSync(() => {
            const oldValue = this.#state[key];
            if (oldValue === value) {
                this.#log.debug(`No state change detected for key: ${String(key)}`, `${caller}.set`);
                return;
            }
            this.#updateState({ [key]: value });
            this.#log.debug(`Updated state key: ${String(key)}\nOld value: ${JSON.stringify(oldValue)}\nNew value: ${JSON.stringify(value)}`, `${caller}.set`);
        }, `[${caller}.set]: Failed to update state key: ${String(key)}.`);
    }
    #notifyObservers(updates) {
        Object.entries(updates).forEach(([key, value]) => {
            this.#observer.set(key, value);
        });
    }
    async #saveOperation(state) {
        return this.#errors.handleAsync(async () => {
            for (let attempt = 1; attempt <= env.state.maxSaveRetries; attempt++) {
                try {
                    await this.#storage.setItem('state', state);
                    this.#log.info(`State saved successfully on attempt ${attempt}.`, `${caller}.#saveOperation`);
                    break;
                }
                catch (err) {
                    if (attempt < env.state.maxSaveRetries) {
                        this.#log.warn(`Save attempt ${attempt} failed. Retrying...`, `${caller}.#saveOperation`);
                    }
                    else {
                        this.#log.error('Max save attempts reached. Save failed.', `${caller}.#saveOperation`);
                    }
                }
            }
        }, `[${caller}.#saveOperation]: Save operation failed.`);
    }
    #updateState(updates) {
        const updatedState = Object.freeze(this.#clone({ ...this.#state, ...updates }));
        this.#state = updatedState;
        this.#notifyObservers(updates);
        this.saveState(updatedState);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhdGVTdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGF0ZS9TdGF0ZVN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLDRCQUE0QjtBQVM1QixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDNUQsT0FBTyxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV2RCxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUM7QUFFNUIsTUFBTSxPQUFPLFVBQVU7SUFDdEIsTUFBTSxDQUFDLFNBQVMsQ0FBYTtJQUU3QixjQUFjLENBQTBCO0lBQ3hDLFNBQVMsQ0FBeUI7SUFDbEMsTUFBTSxDQUFRO0lBRWQsTUFBTSxDQUEyQjtJQUNqQyxTQUFTLENBQThCO0lBQ3ZDLE9BQU8sQ0FBcUI7SUFDNUIsSUFBSSxDQUFrQjtJQUN0QixRQUFRLENBQWlCO0lBRXpCLFlBQ0MsWUFBbUIsRUFDbkIsT0FBZ0IsRUFDaEIsUUFBa0IsRUFDbEIsT0FBdUI7UUFFdkIsSUFBSSxDQUFDO1lBQ0osUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQ2hCLGdCQUFnQixNQUFNLFlBQVksRUFDbEMsR0FBRyxNQUFNLGNBQWMsQ0FDdkIsQ0FBQztZQUVGLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsWUFBWSxFQUFFLENBQUMsQ0FBQztZQUNqRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksZUFBZSxDQUNuQyxJQUFJLENBQUMsTUFBTSxFQUNYLEVBQUUsRUFDRixPQUFPLEVBQ1AsUUFBUSxDQUNSLENBQUM7WUFDRixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztZQUV4QixJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLElBQUks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O29CQUNILENBQUM7Z0JBQ0YsQ0FBQztZQUNGLENBQUM7UUFDRixDQUFDLEVBQUUsSUFBSSxNQUFNLDBDQUEwQyxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVELFlBQVksQ0FBQyxPQUF1QjtRQUNuQyxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUNqQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUMsQ0FDM0MsQ0FBQztRQUNGLElBQUksQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDO1FBRTNCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzlCLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IHN0YXRlL1N0YXRlU3RvcmUudHNcblxuaW1wb3J0IHtcblx0SGVscGVycyxcblx0U2VydmljZXMsXG5cdFN0YXRlLFxuXHRTdGF0ZVN0b3JlQ29udHJhY3Rcbn0gZnJvbSAnLi4vdHlwZXMvaW5kZXguanMnO1xuaW1wb3J0IHsgU3RvcmFnZU1hbmFnZXIgfSBmcm9tICcuLi9zdG9yYWdlL1N0b3JhZ2VNYW5hZ2VyLmpzJztcbmltcG9ydCB7IE9ic2VydmVyU2VydmljZSB9IGZyb20gJy4uL2NvcmUvc2VydmljZXMvaW5kZXguanMnO1xuaW1wb3J0IHsgZW52LCBmZWF0dXJlRmxhZ3MgfSBmcm9tICcuLi9jb25maWcvaW5kZXguanMnO1xuXG5jb25zdCBjYWxsZXIgPSAnU3RhdGVTdG9yZSc7XG5cbmV4cG9ydCBjbGFzcyBTdGF0ZVN0b3JlIGltcGxlbWVudHMgU3RhdGVTdG9yZUNvbnRyYWN0IHtcblx0c3RhdGljICNpbnN0YW5jZTogU3RhdGVTdG9yZTtcblxuXHQjZGVib3VuY2VkU2F2ZSE6IChzdGF0ZTogU3RhdGUpID0+IHZvaWQ7XG5cdCNvYnNlcnZlcjogT2JzZXJ2ZXJTZXJ2aWNlPFN0YXRlPjtcblx0I3N0YXRlOiBTdGF0ZTtcblxuXHQjY2xvbmU6IEhlbHBlcnNbJ2RhdGEnXVsnY2xvbmUnXTtcblx0I2RlYm91bmNlOiBIZWxwZXJzWyd0aW1lJ11bJ2RlYm91bmNlJ107XG5cdCNlcnJvcnM6IFNlcnZpY2VzWydlcnJvcnMnXTtcblx0I2xvZzogU2VydmljZXNbJ2xvZyddO1xuXHQjc3RvcmFnZTogU3RvcmFnZU1hbmFnZXI7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRpbml0aWFsU3RhdGU6IFN0YXRlLFxuXHRcdGhlbHBlcnM6IEhlbHBlcnMsXG5cdFx0c2VydmljZXM6IFNlcnZpY2VzLFxuXHRcdHN0b3JhZ2U6IFN0b3JhZ2VNYW5hZ2VyXG5cdCkge1xuXHRcdHRyeSB7XG5cdFx0XHRzZXJ2aWNlcy5sb2cuaW5mbyhcblx0XHRcdFx0YENvbnN0cnVjdGluZyAke2NhbGxlcn0gaW5zdGFuY2UuYCxcblx0XHRcdFx0YCR7Y2FsbGVyfSBjb25zdHJ1Y3RvcmBcblx0XHRcdCk7XG5cblx0XHRcdHRoaXMuI3N0YXRlID0gT2JqZWN0LmZyZWV6ZSh7IC4uLmluaXRpYWxTdGF0ZSB9KTtcblx0XHRcdHRoaXMuI29ic2VydmVyID0gbmV3IE9ic2VydmVyU2VydmljZTxTdGF0ZT4oXG5cdFx0XHRcdHRoaXMuI3N0YXRlLFxuXHRcdFx0XHR7fSxcblx0XHRcdFx0aGVscGVycyxcblx0XHRcdFx0c2VydmljZXNcblx0XHRcdCk7XG5cdFx0XHR0aGlzLiNzdG9yYWdlID0gc3RvcmFnZTtcblxuXHRcdFx0dGhpcy4jY2xvbmUgPSBoZWxwZXJzLmRhdGEuY2xvbmU7XG5cdFx0XHR0aGlzLiNkZWJvdW5jZSA9IGhlbHBlcnMudGltZS5kZWJvdW5jZTtcblx0XHRcdHRoaXMuI2Vycm9ycyA9IHNlcnZpY2VzLmVycm9ycztcblx0XHRcdHRoaXMuI2xvZyA9IHNlcnZpY2VzLmxvZztcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRgWyR7Y2FsbGVyfSBjb25zdHJ1Y3Rvcl06ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcn1gXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHN0YXRpYyBnZXRJbnN0YW5jZShcblx0XHRpbml0aWFsU3RhdGU6IFN0YXRlLFxuXHRcdGhlbHBlcnM6IEhlbHBlcnMsXG5cdFx0c2VydmljZXM6IFNlcnZpY2VzLFxuXHRcdHN0b3JhZ2U6IFN0b3JhZ2VNYW5hZ2VyXG5cdCk6IFN0YXRlU3RvcmUge1xuXHRcdHJldHVybiBzZXJ2aWNlcy5lcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHRpZiAoIVN0YXRlU3RvcmUuI2luc3RhbmNlKSB7XG5cdFx0XHRcdFN0YXRlU3RvcmUuI2luc3RhbmNlID0gbmV3IFN0YXRlU3RvcmUoXG5cdFx0XHRcdFx0aW5pdGlhbFN0YXRlLFxuXHRcdFx0XHRcdGhlbHBlcnMsXG5cdFx0XHRcdFx0c2VydmljZXMsXG5cdFx0XHRcdFx0c3RvcmFnZVxuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdHNlcnZpY2VzLmxvZy5pbmZvKFxuXHRcdFx0XHRcdGBDcmVhdGluZyBuZXcgJHtjYWxsZXJ9IGluc3RhbmNlYCxcblx0XHRcdFx0XHRgJHtjYWxsZXJ9LmdldEluc3RhbmNlYFxuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdHJldHVybiBTdGF0ZVN0b3JlLiNpbnN0YW5jZTtcblx0XHRcdH1cblxuXHRcdFx0c2VydmljZXMubG9nLmluZm8oXG5cdFx0XHRcdGBSZXR1cm5pbmcgZXhpc3RpbmcgJHtjYWxsZXJ9IGluc3RhbmNlYCxcblx0XHRcdFx0YCR7Y2FsbGVyfS5nZXRJbnN0YW5jZWBcblx0XHRcdCk7XG5cblx0XHRcdHJldHVybiBTdGF0ZVN0b3JlLiNpbnN0YW5jZTtcblx0XHR9LCBgWyR7Y2FsbGVyfS5nZXRJbnN0YW5jZV06IEZhaWxlZCB0byBjcmVhdGUgJHtjYWxsZXJ9IGluc3RhbmNlLmApO1xuXHR9XG5cblx0YXN5bmMgYmF0Y2hVcGRhdGUodXBkYXRlczogUGFydGlhbDxTdGF0ZT4pOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0aGlzLiNlcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHRjb25zdCBvbGRTdGF0ZSA9IHRoaXMuI3N0YXRlO1xuXHRcdFx0Y29uc3QgdXBkYXRlZEVudHJpZXMgPSBPYmplY3QuZW50cmllcyh1cGRhdGVzKS5maWx0ZXIoXG5cdFx0XHRcdChba2V5LCB2YWx1ZV0pID0+IG9sZFN0YXRlW2tleSBhcyBrZXlvZiBTdGF0ZV0gIT09IHZhbHVlXG5cdFx0XHQpO1xuXG5cdFx0XHRpZiAodXBkYXRlZEVudHJpZXMubGVuZ3RoID09PSAwKSB7XG5cdFx0XHRcdHRoaXMuI2xvZy5kZWJ1Zyhcblx0XHRcdFx0XHRgTm8gc3RhdGUgY2hhbmdlcyBkZXRlY3RlZCBmb3IgYmF0Y2ggdXBkYXRlYCxcblx0XHRcdFx0XHRgJHtjYWxsZXJ9LmJhdGNoVXBkYXRlYFxuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgbmV3U3RhdGUgPSBPYmplY3QuZnJlZXplKFxuXHRcdFx0XHR0aGlzLiNjbG9uZSh7IC4uLm9sZFN0YXRlLCAuLi51cGRhdGVzIH0pXG5cdFx0XHQpO1xuXG5cdFx0XHR0aGlzLiNzdGF0ZSA9IG5ld1N0YXRlO1xuXG5cdFx0XHR0aGlzLiNsb2cuZGVidWcoXG5cdFx0XHRcdGBCYXRjaCB1cGRhdGVkIHN0YXRlIHdpdGgga2V5czogJHt1cGRhdGVkRW50cmllcy5tYXAoKFtrXSkgPT4gaykuam9pbignLCAnKX1gLFxuXHRcdFx0XHRgJHtjYWxsZXJ9LmJhdGNoVXBkYXRlYFxuXHRcdFx0KTtcblx0XHRcdGNvbnNvbGUuZGVidWcoXG5cdFx0XHRcdGBbJHtjYWxsZXJ9LmJhdGNoVXBkYXRlXTogQmF0Y2ggVXBkYXRlIExpc3Q6YCxcblx0XHRcdFx0dXBkYXRlc1xuXHRcdFx0KTtcblxuXHRcdFx0dGhpcy4jbm90aWZ5T2JzZXJ2ZXJzKHVwZGF0ZXMpO1xuXG5cdFx0XHR0aGlzLnNhdmVTdGF0ZShuZXdTdGF0ZSk7XG5cdFx0fSwgYFske2NhbGxlcn0uYmF0Y2hVcGRhdGVdOiBGYWlsZWQgdG8gcGVyZm9ybSBiYXRjaCB1cGRhdGVgKTtcblx0fVxuXG5cdGdldDxLIGV4dGVuZHMga2V5b2YgU3RhdGU+KGtleTogSyk6IFN0YXRlW0tdIHtcblx0XHRyZXR1cm4gdGhpcy4jZXJyb3JzLmhhbmRsZVN5bmMoXG5cdFx0XHQoKSA9PiB7XG5cdFx0XHRcdHJldHVybiB0aGlzLiNzdGF0ZVtrZXldO1xuXHRcdFx0fSxcblx0XHRcdGBbJHtjYWxsZXJ9LmdldF06IEZhaWxlZCB0byByZXRyaWV2ZSBzdGF0ZSBrZXk6ICR7U3RyaW5nKGtleSl9YFxuXHRcdCk7XG5cdH1cblxuXHRnZXRTdGF0ZSgpOiBTdGF0ZSB7XG5cdFx0cmV0dXJuIHRoaXMuI2Vycm9ycy5oYW5kbGVTeW5jKCgpID0+IHtcblx0XHRcdHJldHVybiB7IC4uLnRoaXMuI3N0YXRlIH07XG5cdFx0fSwgYFske2NhbGxlcn0uZ2V0RGF0YV06IEZhaWxlZCB0byByZXRyaWV2ZSBmdWxsIHN0YXRlYCk7XG5cdH1cblxuXHRhc3luYyBpbml0KCk6IFByb21pc2U8U3RhdGUgfCBudWxsPiB7XG5cdFx0dGhpcy4jZGVib3VuY2VkU2F2ZSA9IHRoaXMuI2RlYm91bmNlKFxuXHRcdFx0KHN0YXRlOiBTdGF0ZSkgPT4gdGhpcy5zYXZlU3RhdGUoc3RhdGUsIHsgdGhyb3R0bGU6IGZhbHNlIH0pLFxuXHRcdFx0ZW52LnN0YXRlLnNhdmVUaHJvdHRsZURlbGF5XG5cdFx0KTtcblxuXHRcdGlmIChmZWF0dXJlRmxhZ3MubG9hZFN0YXRlRnJvbVN0b3JhZ2UpIHtcblx0XHRcdHRoaXMuI2xvZy53YXJuKFxuXHRcdFx0XHQnTG9hZGluZyBzdGF0ZSBmcm9tIHN0b3JhZ2UgaXMgZGlzYWJsZWQuJyxcblx0XHRcdFx0YCR7Y2FsbGVyfS5pbml0YFxuXHRcdFx0KTtcblxuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fVxuXG5cdFx0Y29uc3QgbG9hZGVkU3RhdGUgPSBhd2FpdCB0aGlzLmxvYWRTdGF0ZSgpO1xuXG5cdFx0bG9hZGVkU3RhdGVcblx0XHRcdD8gdGhpcy4jbG9nLmluZm8oYFN0YXRlIGxvYWRlZCBmcm9tIHN0b3JhZ2UuYCwgYCR7Y2FsbGVyfS5pbml0YClcblx0XHRcdDogdGhpcy4jbG9nLndhcm4oYE5vIHNhdmVkIHN0YXRlIGZvdW5kLmAsIGAke2NhbGxlcn0uaW5pdGApO1xuXG5cdFx0cmV0dXJuIGxvYWRlZFN0YXRlO1xuXHR9XG5cblx0YXN5bmMgbG9hZFN0YXRlKCk6IFByb21pc2U8U3RhdGUgfCBudWxsPiB7XG5cdFx0cmV0dXJuIHRoaXMuI2Vycm9ycy5oYW5kbGVBc3luYyhhc3luYyAoKSA9PiB7XG5cdFx0XHRjb25zdCBzYXZlZFN0YXRlID0gYXdhaXQgdGhpcy4jc3RvcmFnZS5nZXRJdGVtPFN0YXRlPignc3RhdGUnKTtcblxuXHRcdFx0aWYgKHNhdmVkU3RhdGUpIHtcblx0XHRcdFx0dGhpcy4jc3RhdGUgPSBPYmplY3QuZnJlZXplKHRoaXMuI2Nsb25lKHNhdmVkU3RhdGUpKTtcblxuXHRcdFx0XHQvLyByZXBsYWNlIG9ic2VydmVyIGRhdGEgd2l0aCB0aGUgbmV3IHN0YXRlXG5cdFx0XHRcdHRoaXMuI29ic2VydmVyLnJlcGxhY2VEYXRhKHRoaXMuI3N0YXRlKTtcblxuXHRcdFx0XHR0aGlzLiNsb2cuaW5mbyhcblx0XHRcdFx0XHQnTG9hZGVkIHN0YXRlIGZyb20gc3RvcmFnZS4nLFxuXHRcdFx0XHRcdGAke2NhbGxlcn0ubG9hZFN0YXRlYFxuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdHJldHVybiB0aGlzLiNzdGF0ZTtcblx0XHRcdH1cblx0XHRcdHRoaXMuI2xvZy53YXJuKCdObyBzYXZlZCBzdGF0ZSBmb3VuZC4nLCBgJHtjYWxsZXJ9LmxvYWRTdGF0ZWApO1xuXG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9LCBgWyR7Y2FsbGVyfS5sb2FkU3RhdGVdOiBGYWlsZWQgdG8gbG9hZCBzdGF0ZSBmcm9tIHN0b3JhZ2UuYCk7XG5cdH1cblxuXHRvZmY8SyBleHRlbmRzIGtleW9mIFN0YXRlPihcblx0XHRrZXk6IEssXG5cdFx0Y2FsbGJhY2s6IChuZXdWYWx1ZTogU3RhdGVbS10sIG9sZFZhbHVlOiBTdGF0ZVtLXSkgPT4gdm9pZFxuXHQpOiB2b2lkIHtcblx0XHR0aGlzLiNvYnNlcnZlci5vZmYoa2V5LCBjYWxsYmFjayk7XG5cdH1cblxuXHRvbjxLIGV4dGVuZHMga2V5b2YgU3RhdGU+KFxuXHRcdGtleTogSyxcblx0XHRjYWxsYmFjazogKG5ld1ZhbHVlOiBTdGF0ZVtLXSwgb2xkVmFsdWU6IFN0YXRlW0tdKSA9PiB2b2lkXG5cdCk6IHZvaWQge1xuXHRcdHRoaXMuI29ic2VydmVyLm9uKGtleSwgY2FsbGJhY2spO1xuXHR9XG5cblx0YXN5bmMgc2F2ZVN0YXRlKFxuXHRcdHN0YXRlOiBTdGF0ZSA9IHRoaXMuI3N0YXRlLFxuXHRcdG9wdGlvbnM6IHsgdGhyb3R0bGU/OiBib29sZWFuIH0gPSB7fVxuXHQpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRyZXR1cm4gdGhpcy4jZXJyb3JzLmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHtcblx0XHRcdGlmIChvcHRpb25zLnRocm90dGxlKSB7XG5cdFx0XHRcdHRoaXMuI2RlYm91bmNlZFNhdmUoc3RhdGUpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0YXdhaXQgdGhpcy4jc2F2ZU9wZXJhdGlvbihzdGF0ZSk7XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMuI2xvZy5pbmZvKCdTdGF0ZSBzYXZlZCB0byBzdG9yYWdlLicsIGAke2NhbGxlcn0uc2F2ZVN0YXRlYCk7XG5cdFx0fSwgYFske2NhbGxlcn0uc2F2ZVN0YXRlXTogRmFpbGVkIHRvIHNhdmUgc3RhdGUgdG8gc3RvcmFnZS5gKTtcblx0fVxuXG5cdGFzeW5jIHNldDxLIGV4dGVuZHMga2V5b2YgU3RhdGU+KGtleTogSywgdmFsdWU6IFN0YXRlW0tdKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dGhpcy4jZXJyb3JzLmhhbmRsZVN5bmMoXG5cdFx0XHQoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IG9sZFZhbHVlID0gdGhpcy4jc3RhdGVba2V5XTtcblxuXHRcdFx0XHRpZiAob2xkVmFsdWUgPT09IHZhbHVlKSB7XG5cdFx0XHRcdFx0dGhpcy4jbG9nLmRlYnVnKFxuXHRcdFx0XHRcdFx0YE5vIHN0YXRlIGNoYW5nZSBkZXRlY3RlZCBmb3Iga2V5OiAke1N0cmluZyhrZXkpfWAsXG5cdFx0XHRcdFx0XHRgJHtjYWxsZXJ9LnNldGBcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0dGhpcy4jdXBkYXRlU3RhdGUoeyBba2V5XTogdmFsdWUgfSk7XG5cblx0XHRcdFx0dGhpcy4jbG9nLmRlYnVnKFxuXHRcdFx0XHRcdGBVcGRhdGVkIHN0YXRlIGtleTogJHtTdHJpbmcoa2V5KX1cXG5PbGQgdmFsdWU6ICR7SlNPTi5zdHJpbmdpZnkob2xkVmFsdWUpfVxcbk5ldyB2YWx1ZTogJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9YCxcblx0XHRcdFx0XHRgJHtjYWxsZXJ9LnNldGBcblx0XHRcdFx0KTtcblx0XHRcdH0sXG5cdFx0XHRgWyR7Y2FsbGVyfS5zZXRdOiBGYWlsZWQgdG8gdXBkYXRlIHN0YXRlIGtleTogJHtTdHJpbmcoa2V5KX0uYFxuXHRcdCk7XG5cdH1cblxuXHQjbm90aWZ5T2JzZXJ2ZXJzKHVwZGF0ZXM6IFBhcnRpYWw8U3RhdGU+KTogdm9pZCB7XG5cdFx0T2JqZWN0LmVudHJpZXModXBkYXRlcykuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG5cdFx0XHR0aGlzLiNvYnNlcnZlci5zZXQoa2V5IGFzIGtleW9mIFN0YXRlLCB2YWx1ZSBhcyBTdGF0ZVtrZXlvZiBTdGF0ZV0pO1xuXHRcdH0pO1xuXHR9XG5cblx0YXN5bmMgI3NhdmVPcGVyYXRpb24oc3RhdGU6IFN0YXRlKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0cmV0dXJuIHRoaXMuI2Vycm9ycy5oYW5kbGVBc3luYyhhc3luYyAoKSA9PiB7XG5cdFx0XHRmb3IgKFxuXHRcdFx0XHRsZXQgYXR0ZW1wdCA9IDE7XG5cdFx0XHRcdGF0dGVtcHQgPD0gZW52LnN0YXRlLm1heFNhdmVSZXRyaWVzO1xuXHRcdFx0XHRhdHRlbXB0Kytcblx0XHRcdCkge1xuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdGF3YWl0IHRoaXMuI3N0b3JhZ2Uuc2V0SXRlbSgnc3RhdGUnLCBzdGF0ZSk7XG5cblx0XHRcdFx0XHR0aGlzLiNsb2cuaW5mbyhcblx0XHRcdFx0XHRcdGBTdGF0ZSBzYXZlZCBzdWNjZXNzZnVsbHkgb24gYXR0ZW1wdCAke2F0dGVtcHR9LmAsXG5cdFx0XHRcdFx0XHRgJHtjYWxsZXJ9LiNzYXZlT3BlcmF0aW9uYFxuXHRcdFx0XHRcdCk7XG5cblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdFx0aWYgKGF0dGVtcHQgPCBlbnYuc3RhdGUubWF4U2F2ZVJldHJpZXMpIHtcblx0XHRcdFx0XHRcdHRoaXMuI2xvZy53YXJuKFxuXHRcdFx0XHRcdFx0XHRgU2F2ZSBhdHRlbXB0ICR7YXR0ZW1wdH0gZmFpbGVkLiBSZXRyeWluZy4uLmAsXG5cdFx0XHRcdFx0XHRcdGAke2NhbGxlcn0uI3NhdmVPcGVyYXRpb25gXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHR0aGlzLiNsb2cuZXJyb3IoXG5cdFx0XHRcdFx0XHRcdCdNYXggc2F2ZSBhdHRlbXB0cyByZWFjaGVkLiBTYXZlIGZhaWxlZC4nLFxuXHRcdFx0XHRcdFx0XHRgJHtjYWxsZXJ9LiNzYXZlT3BlcmF0aW9uYFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9LCBgWyR7Y2FsbGVyfS4jc2F2ZU9wZXJhdGlvbl06IFNhdmUgb3BlcmF0aW9uIGZhaWxlZC5gKTtcblx0fVxuXG5cdCN1cGRhdGVTdGF0ZSh1cGRhdGVzOiBQYXJ0aWFsPFN0YXRlPik6IHZvaWQge1xuXHRcdGNvbnN0IHVwZGF0ZWRTdGF0ZSA9IE9iamVjdC5mcmVlemUoXG5cdFx0XHR0aGlzLiNjbG9uZSh7IC4uLnRoaXMuI3N0YXRlLCAuLi51cGRhdGVzIH0pXG5cdFx0KTtcblx0XHR0aGlzLiNzdGF0ZSA9IHVwZGF0ZWRTdGF0ZTtcblxuXHRcdHRoaXMuI25vdGlmeU9ic2VydmVycyh1cGRhdGVzKTtcblx0XHR0aGlzLnNhdmVTdGF0ZSh1cGRhdGVkU3RhdGUpO1xuXHR9XG59XG4iXX0=