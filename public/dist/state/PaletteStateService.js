// File: state/PaletteState.ts
import { domConfig } from '../config/index.js';
const caller = 'PaletteState';
export class PaletteStateService {
    static #instance = null;
    #errors;
    #log;
    #stateManager;
    constructor(services, stateManager) {
        try {
            services.log.info(`Constructing PaletteState instance`, `${caller} constructor`);
            this.#errors = services.errors;
            this.#log = services.log;
            this.#stateManager = stateManager;
        }
        catch (error) {
            throw new Error(`[${caller} constructor]: ${error instanceof Error ? error.message : error}`);
        }
    }
    static getInstance(services, stateManager) {
        return services.errors.handleSync(() => {
            if (!PaletteStateService.#instance) {
                services.log.debug('Creating PaletteState instance', `${caller}.getInstance`);
                PaletteStateService.#instance = new PaletteStateService(services, stateManager);
            }
            return PaletteStateService.#instance;
        }, `[${caller}.getInstance]: Failed to create PaletteState instance.`);
    }
    async handleColumnLock(columnID) {
        return this.#errors.handleAsync(async () => {
            const state = await this.#stateManager.getState();
            const updatedColumns = state.paletteContainer.columns.map(col => col.id === columnID ? { ...col, isLocked: !col.isLocked } : col);
            this.#stateManager.updatePaletteColumns(updatedColumns, true);
        }, `[${caller}]: Failed to toggle lock for column ${columnID}`);
    }
    async handleColumnResize(columnID, newSize) {
        return this.#errors.handleAsync(async () => {
            const currentState = await this.#stateManager.getState();
            const columns = currentState.paletteContainer.columns;
            const columnIndex = columns.findIndex(col => col.id === columnID);
            if (columnIndex === -1) {
                this.#log.warn(`Column with ID ${columnID} not found.`, `${caller}.handleColumnResize`);
                return;
            }
            const adjustedSize = Math.max(domConfig.minColumnSize, Math.min(newSize, domConfig.maxColumnSize));
            const sizeDiff = adjustedSize - columns[columnIndex].size;
            // created new columns array with updated columns
            const updatedColumns = columns.map(col => {
                if (col.id === columnID) {
                    return { ...col, size: adjustedSize };
                }
                return col;
            });
            // distribute size difference among locked columns
            const unlockedColumns = updatedColumns.filter(col => col.id !== columnID && !col.isLocked);
            const distributeAmount = unlockedColumns.length > 0
                ? sizeDiff / unlockedColumns.length
                : 0;
            const resizedColumns = updatedColumns.map(col => {
                if (col.id !== columnID && !col.isLocked) {
                    return { ...col, size: col.size - distributeAmount };
                }
                return col;
            });
            // normalize sizes to total 100%
            const totalSize = resizedColumns.reduce((sum, col) => sum + col.size, 0);
            const normalizedColumns = resizedColumns.map(col => ({
                ...col,
                size: col.size * (100 / totalSize)
            }));
            this.#stateManager.updatePaletteColumns(normalizedColumns, true);
        }, `[${caller}]: Failed to resize column ${columnID}`);
    }
    async swapColumns(draggedID, targetID) {
        return await this.#errors.handleAsync(async () => {
            const currentState = await this.#stateManager.getState();
            const columns = currentState.paletteContainer.columns;
            const draggedColumn = columns.find(col => col.id === draggedID);
            const targetColumn = columns.find(col => col.id === targetID);
            if (!draggedColumn || !targetColumn) {
                this.#log.warn(`Failed to swap columns: Column ID ${draggedID} or ${targetID} not found.`, `${caller}.swapColumns`);
                return;
            }
            // create updated columns with immutably swapped positions
            const updatedColumns = columns.map(col => {
                if (col.id === draggedID)
                    return { ...col, position: targetColumn.position };
                if (col.id === targetID)
                    return { ...col, position: draggedColumn.position };
                return col;
            });
            // sort columns based on updated positions
            const sortedColumns = [...updatedColumns].sort((a, b) => a.position - b.position);
            // update state with the new column order
            this.#stateManager.updatePaletteColumns(sortedColumns, true);
            this.#log.debug(`Swapped columns ${draggedID} and ${targetID}. New order: ${sortedColumns.map(col => col.id).join(', ')}`, `${caller}.swapColumns`);
        }, `Failed to swap columns ${draggedID} and ${targetID}`);
    }
    async updateColumnSize(columnID, newSize) {
        const currentState = await this.#stateManager.getState();
        const { columns } = currentState.paletteContainer;
        const columnIndex = columns.findIndex(col => col.id === columnID);
        if (columnIndex === -1)
            return;
        const minSize = domConfig.minColumnSize;
        const maxSize = domConfig.maxColumnSize;
        const adjustedSize = Math.max(minSize, Math.min(newSize, maxSize));
        const updatedColumns = columns.map(col => col.id === columnID ? { ...col, size: adjustedSize } : col);
        await this.#stateManager.batchUpdate({
            paletteContainer: {
                ...currentState.paletteContainer,
                columns: updatedColumns
            }
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFsZXR0ZVN0YXRlU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGF0ZS9QYWxldHRlU3RhdGVTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLDhCQUE4QjtBQUk5QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFL0MsTUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDO0FBRTlCLE1BQU0sT0FBTyxtQkFBbUI7SUFDL0IsTUFBTSxDQUFDLFNBQVMsR0FBK0IsSUFBSSxDQUFDO0lBRXBELE9BQU8sQ0FBcUI7SUFDNUIsSUFBSSxDQUFrQjtJQUN0QixhQUFhLENBQWU7SUFFNUIsWUFBb0IsUUFBa0IsRUFBRSxZQUEwQjtRQUNqRSxJQUFJLENBQUM7WUFDSixRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FDaEIsb0NBQW9DLEVBQ3BDLEdBQUcsTUFBTSxjQUFjLENBQ3ZCLENBQUM7WUFFRixJQUFJLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7WUFDL0IsSUFBSSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxhQUFhLEdBQUcsWUFBWSxDQUFDO1FBQ25DLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQ2QsSUFBSSxNQUFNLGtCQUFrQixLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FDNUUsQ0FBQztRQUNILENBQUM7SUFDRixDQUFDO0lBRUQsTUFBTSxDQUFDLFdBQVcsQ0FDakIsUUFBa0IsRUFDbEIsWUFBMEI7UUFFMUIsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDdEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxDQUFD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QUcsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FDMUQsQ0FBQztRQUVGLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUM7WUFDcEMsZ0JBQWdCLEVBQUU7Z0JBQ2pCLEdBQUcsWUFBWSxDQUFDLGdCQUFnQjtnQkFDaEMsT0FBTyxFQUFFLGNBQWM7YUFDdkI7U0FDRCxDQUFDLENBQUM7SUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gRmlsZTogc3RhdGUvUGFsZXR0ZVN0YXRlLnRzXG5cbmltcG9ydCB7IFBhbGV0dGVTdGF0ZUNvbnRyYWN0LCBTZXJ2aWNlcyB9IGZyb20gJy4uL3R5cGVzL2luZGV4LmpzJztcbmltcG9ydCB7IFN0YXRlTWFuYWdlciB9IGZyb20gJy4vU3RhdGVNYW5hZ2VyLmpzJztcbmltcG9ydCB7IGRvbUNvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9pbmRleC5qcyc7XG5cbmNvbnN0IGNhbGxlciA9ICdQYWxldHRlU3RhdGUnO1xuXG5leHBvcnQgY2xhc3MgUGFsZXR0ZVN0YXRlU2VydmljZSBpbXBsZW1lbnRzIFBhbGV0dGVTdGF0ZUNvbnRyYWN0IHtcblx0c3RhdGljICNpbnN0YW5jZTogUGFsZXR0ZVN0YXRlU2VydmljZSB8IG51bGwgPSBudWxsO1xuXG5cdCNlcnJvcnM6IFNlcnZpY2VzWydlcnJvcnMnXTtcblx0I2xvZzogU2VydmljZXNbJ2xvZyddO1xuXHQjc3RhdGVNYW5hZ2VyOiBTdGF0ZU1hbmFnZXI7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3RvcihzZXJ2aWNlczogU2VydmljZXMsIHN0YXRlTWFuYWdlcjogU3RhdGVNYW5hZ2VyKSB7XG5cdFx0dHJ5IHtcblx0XHRcdHNlcnZpY2VzLmxvZy5pbmZvKFxuXHRcdFx0XHRgQ29uc3RydWN0aW5nIFBhbGV0dGVTdGF0ZSBpbnN0YW5jZWAsXG5cdFx0XHRcdGAke2NhbGxlcn0gY29uc3RydWN0b3JgXG5cdFx0XHQpO1xuXG5cdFx0XHR0aGlzLiNlcnJvcnMgPSBzZXJ2aWNlcy5lcnJvcnM7XG5cdFx0XHR0aGlzLiNsb2cgPSBzZXJ2aWNlcy5sb2c7XG5cdFx0XHR0aGlzLiNzdGF0ZU1hbmFnZXIgPSBzdGF0ZU1hbmFnZXI7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdFx0YFske2NhbGxlcn0gY29uc3RydWN0b3JdOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3J9YFxuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRzdGF0aWMgZ2V0SW5zdGFuY2UoXG5cdFx0c2VydmljZXM6IFNlcnZpY2VzLFxuXHRcdHN0YXRlTWFuYWdlcjogU3RhdGVNYW5hZ2VyXG5cdCk6IFBhbGV0dGVTdGF0ZVNlcnZpY2Uge1xuXHRcdHJldHVybiBzZXJ2aWNlcy5lcnJvcnMuaGFuZGxlU3luYygoKSA9PiB7XG5cdFx0XHRpZiAoIVBhbGV0dGVTdGF0ZVNlcnZpY2UuI2luc3RhbmNlKSB7XG5cdFx0XHRcdHNlcnZpY2VzLmxvZy5kZWJ1Zyhcblx0XHRcdFx0XHQnQ3JlYXRpbmcgUGFsZXR0ZVN0YXRlIGluc3RhbmNlJyxcblx0XHRcdFx0XHRgJHtjYWxsZXJ9LmdldEluc3RhbmNlYFxuXHRcdFx0XHQpO1xuXHRcdFx0XHRQYWxldHRlU3RhdGVTZXJ2aWNlLiNpbnN0YW5jZSA9IG5ldyBQYWxldHRlU3RhdGVTZXJ2aWNlKFxuXHRcdFx0XHRcdHNlcnZpY2VzLFxuXHRcdFx0XHRcdHN0YXRlTWFuYWdlclxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gUGFsZXR0ZVN0YXRlU2VydmljZS4jaW5zdGFuY2U7XG5cdFx0fSwgYFske2NhbGxlcn0uZ2V0SW5zdGFuY2VdOiBGYWlsZWQgdG8gY3JlYXRlIFBhbGV0dGVTdGF0ZSBpbnN0YW5jZS5gKTtcblx0fVxuXG5cdGFzeW5jIGhhbmRsZUNvbHVtbkxvY2soY29sdW1uSUQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuXHRcdHJldHVybiB0aGlzLiNlcnJvcnMuaGFuZGxlQXN5bmMoYXN5bmMgKCkgPT4ge1xuXHRcdFx0Y29uc3Qgc3RhdGUgPSBhd2FpdCB0aGlzLiNzdGF0ZU1hbmFnZXIuZ2V0U3RhdGUoKTtcblx0XHRcdGNvbnN0IHVwZGF0ZWRDb2x1bW5zID0gc3RhdGUucGFsZXR0ZUNvbnRhaW5lci5jb2x1bW5zLm1hcChjb2wgPT5cblx0XHRcdFx0Y29sLmlkID09PSBjb2x1bW5JRCA/IHsgLi4uY29sLCBpc0xvY2tlZDogIWNvbC5pc0xvY2tlZCB9IDogY29sXG5cdFx0XHQpO1xuXG5cdFx0XHR0aGlzLiNzdGF0ZU1hbmFnZXIudXBkYXRlUGFsZXR0ZUNvbHVtbnModXBkYXRlZENvbHVtbnMsIHRydWUpO1xuXHRcdH0sIGBbJHtjYWxsZXJ9XTogRmFpbGVkIHRvIHRvZ2dsZSBsb2NrIGZvciBjb2x1bW4gJHtjb2x1bW5JRH1gKTtcblx0fVxuXG5cdGFzeW5jIGhhbmRsZUNvbHVtblJlc2l6ZShjb2x1bW5JRDogbnVtYmVyLCBuZXdTaXplOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRyZXR1cm4gdGhpcy4jZXJyb3JzLmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHtcblx0XHRcdGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGF3YWl0IHRoaXMuI3N0YXRlTWFuYWdlci5nZXRTdGF0ZSgpO1xuXHRcdFx0Y29uc3QgY29sdW1ucyA9IGN1cnJlbnRTdGF0ZS5wYWxldHRlQ29udGFpbmVyLmNvbHVtbnM7XG5cdFx0XHRjb25zdCBjb2x1bW5JbmRleCA9IGNvbHVtbnMuZmluZEluZGV4KGNvbCA9PiBjb2wuaWQgPT09IGNvbHVtbklEKTtcblxuXHRcdFx0aWYgKGNvbHVtbkluZGV4ID09PSAtMSkge1xuXHRcdFx0XHR0aGlzLiNsb2cud2Fybihcblx0XHRcdFx0XHRgQ29sdW1uIHdpdGggSUQgJHtjb2x1bW5JRH0gbm90IGZvdW5kLmAsXG5cdFx0XHRcdFx0YCR7Y2FsbGVyfS5oYW5kbGVDb2x1bW5SZXNpemVgXG5cdFx0XHRcdCk7XG5cblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBhZGp1c3RlZFNpemUgPSBNYXRoLm1heChcblx0XHRcdFx0ZG9tQ29uZmlnLm1pbkNvbHVtblNpemUsXG5cdFx0XHRcdE1hdGgubWluKG5ld1NpemUsIGRvbUNvbmZpZy5tYXhDb2x1bW5TaXplKVxuXHRcdFx0KTtcblxuXHRcdFx0Y29uc3Qgc2l6ZURpZmYgPSBhZGp1c3RlZFNpemUgLSBjb2x1bW5zW2NvbHVtbkluZGV4XS5zaXplO1xuXG5cdFx0XHQvLyBjcmVhdGVkIG5ldyBjb2x1bW5zIGFycmF5IHdpdGggdXBkYXRlZCBjb2x1bW5zXG5cdFx0XHRjb25zdCB1cGRhdGVkQ29sdW1ucyA9IGNvbHVtbnMubWFwKGNvbCA9PiB7XG5cdFx0XHRcdGlmIChjb2wuaWQgPT09IGNvbHVtbklEKSB7XG5cdFx0XHRcdFx0cmV0dXJuIHsgLi4uY29sLCBzaXplOiBhZGp1c3RlZFNpemUgfTtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gY29sO1xuXHRcdFx0fSk7XG5cblx0XHRcdC8vIGRpc3RyaWJ1dGUgc2l6ZSBkaWZmZXJlbmNlIGFtb25nIGxvY2tlZCBjb2x1bW5zXG5cdFx0XHRjb25zdCB1bmxvY2tlZENvbHVtbnMgPSB1cGRhdGVkQ29sdW1ucy5maWx0ZXIoXG5cdFx0XHRcdGNvbCA9PiBjb2wuaWQgIT09IGNvbHVtbklEICYmICFjb2wuaXNMb2NrZWRcblx0XHRcdCk7XG5cdFx0XHRjb25zdCBkaXN0cmlidXRlQW1vdW50ID1cblx0XHRcdFx0dW5sb2NrZWRDb2x1bW5zLmxlbmd0aCA+IDBcblx0XHRcdFx0XHQ/IHNpemVEaWZmIC8gdW5sb2NrZWRDb2x1bW5zLmxlbmd0aFxuXHRcdFx0XHRcdDogMDtcblxuXHRcdFx0Y29uc3QgcmVzaXplZENvbHVtbnMgPSB1cGRhdGVkQ29sdW1ucy5tYXAoY29sID0+IHtcblx0XHRcdFx0aWYgKGNvbC5pZCAhPT0gY29sdW1uSUQgJiYgIWNvbC5pc0xvY2tlZCkge1xuXHRcdFx0XHRcdHJldHVybiB7IC4uLmNvbCwgc2l6ZTogY29sLnNpemUgLSBkaXN0cmlidXRlQW1vdW50IH07XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gY29sO1xuXHRcdFx0fSk7XG5cblx0XHRcdC8vIG5vcm1hbGl6ZSBzaXplcyB0byB0b3RhbCAxMDAlXG5cdFx0XHRjb25zdCB0b3RhbFNpemUgPSByZXNpemVkQ29sdW1ucy5yZWR1Y2UoXG5cdFx0XHRcdChzdW0sIGNvbCkgPT4gc3VtICsgY29sLnNpemUsXG5cdFx0XHRcdDBcblx0XHRcdCk7XG5cdFx0XHRjb25zdCBub3JtYWxpemVkQ29sdW1ucyA9IHJlc2l6ZWRDb2x1bW5zLm1hcChjb2wgPT4gKHtcblx0XHRcdFx0Li4uY29sLFxuXHRcdFx0XHRzaXplOiBjb2wuc2l6ZSAqICgxMDAgLyB0b3RhbFNpemUpXG5cdFx0XHR9KSk7XG5cblx0XHRcdHRoaXMuI3N0YXRlTWFuYWdlci51cGRhdGVQYWxldHRlQ29sdW1ucyhub3JtYWxpemVkQ29sdW1ucywgdHJ1ZSk7XG5cdFx0fSwgYFske2NhbGxlcn1dOiBGYWlsZWQgdG8gcmVzaXplIGNvbHVtbiAke2NvbHVtbklEfWApO1xuXHR9XG5cblx0YXN5bmMgc3dhcENvbHVtbnMoZHJhZ2dlZElEOiBudW1iZXIsIHRhcmdldElEOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRyZXR1cm4gYXdhaXQgdGhpcy4jZXJyb3JzLmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHtcblx0XHRcdGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGF3YWl0IHRoaXMuI3N0YXRlTWFuYWdlci5nZXRTdGF0ZSgpO1xuXHRcdFx0Y29uc3QgY29sdW1ucyA9IGN1cnJlbnRTdGF0ZS5wYWxldHRlQ29udGFpbmVyLmNvbHVtbnM7XG5cblx0XHRcdGNvbnN0IGRyYWdnZWRDb2x1bW4gPSBjb2x1bW5zLmZpbmQoY29sID0+IGNvbC5pZCA9PT0gZHJhZ2dlZElEKTtcblx0XHRcdGNvbnN0IHRhcmdldENvbHVtbiA9IGNvbHVtbnMuZmluZChjb2wgPT4gY29sLmlkID09PSB0YXJnZXRJRCk7XG5cblx0XHRcdGlmICghZHJhZ2dlZENvbHVtbiB8fCAhdGFyZ2V0Q29sdW1uKSB7XG5cdFx0XHRcdHRoaXMuI2xvZy53YXJuKFxuXHRcdFx0XHRcdGBGYWlsZWQgdG8gc3dhcCBjb2x1bW5zOiBDb2x1bW4gSUQgJHtkcmFnZ2VkSUR9IG9yICR7dGFyZ2V0SUR9IG5vdCBmb3VuZC5gLFxuXHRcdFx0XHRcdGAke2NhbGxlcn0uc3dhcENvbHVtbnNgXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0Ly8gY3JlYXRlIHVwZGF0ZWQgY29sdW1ucyB3aXRoIGltbXV0YWJseSBzd2FwcGVkIHBvc2l0aW9uc1xuXHRcdFx0Y29uc3QgdXBkYXRlZENvbHVtbnMgPSBjb2x1bW5zLm1hcChjb2wgPT4ge1xuXHRcdFx0XHRpZiAoY29sLmlkID09PSBkcmFnZ2VkSUQpXG5cdFx0XHRcdFx0cmV0dXJuIHsgLi4uY29sLCBwb3NpdGlvbjogdGFyZ2V0Q29sdW1uLnBvc2l0aW9uIH07XG5cdFx0XHRcdGlmIChjb2wuaWQgPT09IHRhcmdldElEKVxuXHRcdFx0XHRcdHJldHVybiB7IC4uLmNvbCwgcG9zaXRpb246IGRyYWdnZWRDb2x1bW4ucG9zaXRpb24gfTtcblx0XHRcdFx0cmV0dXJuIGNvbDtcblx0XHRcdH0pO1xuXG5cdFx0XHQvLyBzb3J0IGNvbHVtbnMgYmFzZWQgb24gdXBkYXRlZCBwb3NpdGlvbnNcblx0XHRcdGNvbnN0IHNvcnRlZENvbHVtbnMgPSBbLi4udXBkYXRlZENvbHVtbnNdLnNvcnQoXG5cdFx0XHRcdChhLCBiKSA9PiBhLnBvc2l0aW9uIC0gYi5wb3NpdGlvblxuXHRcdFx0KTtcblxuXHRcdFx0Ly8gdXBkYXRlIHN0YXRlIHdpdGggdGhlIG5ldyBjb2x1bW4gb3JkZXJcblx0XHRcdHRoaXMuI3N0YXRlTWFuYWdlci51cGRhdGVQYWxldHRlQ29sdW1ucyhzb3J0ZWRDb2x1bW5zLCB0cnVlKTtcblxuXHRcdFx0dGhpcy4jbG9nLmRlYnVnKFxuXHRcdFx0XHRgU3dhcHBlZCBjb2x1bW5zICR7ZHJhZ2dlZElEfSBhbmQgJHt0YXJnZXRJRH0uIE5ldyBvcmRlcjogJHtzb3J0ZWRDb2x1bW5zLm1hcChjb2wgPT4gY29sLmlkKS5qb2luKCcsICcpfWAsXG5cdFx0XHRcdGAke2NhbGxlcn0uc3dhcENvbHVtbnNgXG5cdFx0XHQpO1xuXHRcdH0sIGBGYWlsZWQgdG8gc3dhcCBjb2x1bW5zICR7ZHJhZ2dlZElEfSBhbmQgJHt0YXJnZXRJRH1gKTtcblx0fVxuXG5cdGFzeW5jIHVwZGF0ZUNvbHVtblNpemUoY29sdW1uSUQ6IG51bWJlciwgbmV3U2l6ZTogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgY3VycmVudFN0YXRlID0gYXdhaXQgdGhpcy4jc3RhdGVNYW5hZ2VyLmdldFN0YXRlKCk7XG5cdFx0Y29uc3QgeyBjb2x1bW5zIH0gPSBjdXJyZW50U3RhdGUucGFsZXR0ZUNvbnRhaW5lcjtcblxuXHRcdGNvbnN0IGNvbHVtbkluZGV4ID0gY29sdW1ucy5maW5kSW5kZXgoY29sID0+IGNvbC5pZCA9PT0gY29sdW1uSUQpO1xuXHRcdGlmIChjb2x1bW5JbmRleCA9PT0gLTEpIHJldHVybjtcblxuXHRcdGNvbnN0IG1pblNpemUgPSBkb21Db25maWcubWluQ29sdW1uU2l6ZTtcblx0XHRjb25zdCBtYXhTaXplID0gZG9tQ29uZmlnLm1heENvbHVtblNpemU7XG5cdFx0Y29uc3QgYWRqdXN0ZWRTaXplID0gTWF0aC5tYXgobWluU2l6ZSwgTWF0aC5taW4obmV3U2l6ZSwgbWF4U2l6ZSkpO1xuXG5cdFx0Y29uc3QgdXBkYXRlZENvbHVtbnMgPSBjb2x1bW5zLm1hcChjb2wgPT5cblx0XHRcdGNvbC5pZCA9PT0gY29sdW1uSUQgPyB7IC4uLmNvbCwgc2l6ZTogYWRqdXN0ZWRTaXplIH0gOiBjb2xcblx0XHQpO1xuXG5cdFx0YXdhaXQgdGhpcy4jc3RhdGVNYW5hZ2VyLmJhdGNoVXBkYXRlKHtcblx0XHRcdHBhbGV0dGVDb250YWluZXI6IHtcblx0XHRcdFx0Li4uY3VycmVudFN0YXRlLnBhbGV0dGVDb250YWluZXIsXG5cdFx0XHRcdGNvbHVtbnM6IHVwZGF0ZWRDb2x1bW5zXG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cbn1cbiJdfQ==