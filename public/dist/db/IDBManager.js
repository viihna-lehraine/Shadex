// File: db/IDBManager.js
import { configData as config } from '../data/config.js';
import { commonFn } from '../common/index.js';
import { createLogger } from '../logger/index.js';
import { initializeDB } from './initialize.js';
import { modeData as mode } from '../data/mode.js';
const thisModule = 'db/IDBManager.js';
const logger = await createLogger();
export class IDBManager {
    static instance = null;
    dbPromise;
    dbData = config.db;
    mode = mode;
    logMode = mode.logging;
    cache = {};
    defaultKeys = config.db.DEFAULT_KEYS;
    defaultSettings = config.db.DEFAULT_SETTINGS;
    storeNames = config.db.STORE_NAMES;
    utils;
    constructor() {
        this.dbPromise = initializeDB();
        this.dbData = this.dbData;
        this.defaultKeys = config.db.DEFAULT_KEYS;
        this.defaultSettings = config.db.DEFAULT_SETTINGS;
        this.storeNames = config.db.STORE_NAMES;
        this.mode = mode;
        this.utils = commonFn.utils;
    }
    //
    ///
    //// * * * * * * * * * * * * * * * * * * * * * *
    ///// * * * * * * STATIC METHODS * * * * * * *
    //// * * * * * * * * * * * * * * * * * * * * * *
    ///
    //
    static async getInstance() {
        if (!this.instance) {
            this.instance = new IDBManager();
            await this.instance.dbPromise;
        }
        return this.instance;
    }
    static resetInstance() {
        this.instance = null;
    }
    //
    ///
    //// * * * * * * * * * * * * * * * * * * * * * *
    ///// * * * * * * * PUBLIC METHODS * * * * * * *
    //// * * * * * * * * * * * * * * * * * * * * * *
    ///
    //
    createMutationLogger(obj, key) {
        const self = this;
        return new Proxy(obj, {
            set(target, property, value) {
                const oldValue = target[property];
                const success = Reflect.set(target, property, value);
                if (success) {
                    const mutationLog = {
                        timestamp: new Date().toISOString(),
                        key,
                        action: 'update',
                        newValue: { [property]: value },
                        oldValue: { [property]: oldValue },
                        origin: 'Proxy'
                    };
                    self.log('debug', `Mutation detected: ${JSON.stringify(mutationLog)}`, `createMutationLogger()`, 2);
                    self.persistMutation(mutationLog).catch(err => {
                        if (self.logMode.error)
                            self.log('error', `Failed to persist mutation: ${err.message}`, 'createMutationLogger()');
                    });
                }
                return success;
            }
        });
    }
    async deleteDatabase() {
        await this.utils.errors.handleAsync(async () => {
            const dbName = 'paletteDB';
            const dbExists = await new Promise(resolve => {
                const request = indexedDB.open(dbName);
                request.onsuccess = () => {
                    request.result.close();
                    resolve(true);
                };
                request.onerror = () => resolve(false);
            });
            if (dbExists) {
                const deleteRequest = indexedDB.deleteDatabase(dbName);
                deleteRequest.onsuccess = () => {
                    this.log('debug', `Database "${dbName}" deleted successfully.`, `deleteDatabase()`, 1);
                };
                deleteRequest.onerror = event => {
                    this.log('error', `Error deleting database "${dbName}":\nEvent: ${event}`, `deleteDatabase()`);
                };
                deleteRequest.onblocked = () => {
                    this.log('warn', `Delete operation blocked. Ensure no open connections to "${dbName}".`, `deleteDatabase()`, 1);
                    if (this.mode.showAlerts)
                        alert(`Unable to delete database "${dbName}" because it is in use. Please close all other tabs or windows accessing this database and try again.`);
                    if (this.mode.stackTrace)
                        console.trace(`Blocked call stack:`);
                };
            }
            else {
                if (this.logMode.warn && this.logMode.verbosity >= 3)
                    this.log('warn', `Database "${dbName}" does not exist.`, `deleteDatabase()`);
            }
        }, 'IDBManager.deleteDatabase(): Error deleting database');
    }
    async deleteEntries(store, keys) {
        await this.withDB(async (db) => {
            const storeRef = db
                .transaction(store, 'readwrite')
                .objectStore(store);
            for (const key of keys) {
                if ((await this.handleData(store, key, 'get')) !== null) {
                    await storeRef.delete(key);
                }
            }
        });
    }
    async getCurrentPaletteID() {
        return this.handleData(this.storeNames.SETTINGS, this.getDefaultKey('APP_SETTINGS'), 'get').then(settings => settings?.lastPaletteID ?? 0);
    }
    async getCachedSettings() {
        if (!this.cache.settings)
            this.cache.settings = await this.getSettings();
        return this.cache.settings;
    }
    async getNextTableID() {
        const lastTableID = (await this.handleData(this.storeNames.SETTINGS, this.getDefaultKey('APP_SETTINGS'), 'get'))?.lastTableID ?? 0;
        const nextID = lastTableID + 1;
        await this.updateData(this.storeNames.SETTINGS, this.getDefaultKey('APP_SETTINGS'), s => ({ ...s, lastTableID: nextID }));
        return `palette_${nextID}`;
    }
    async getMutations() {
        return this.handleData(this.storeNames.MUTATIONS, 'mutation_logs', 'get').then(mutations => mutations ?? []);
    }
    async getPaletteHistory() {
        return ((await this.handleData(this.storeNames.SETTINGS, 'paletteHistory', 'get'))?.palettes ?? []);
    }
    async getSettings() {
        return {
            ...this.defaultSettings,
            ...(await this.handleData(this.storeNames.SETTINGS, this.getDefaultKey('APP_SETTINGS'), 'get'))
        };
    }
    async getStore(storeName, mode) {
        return this.withDB(async (db) => db.transaction(storeName, mode).objectStore(storeName));
    }
    async persistMutation(data) {
        return this.withDB(async (db) => {
            await db.put('mutations', data);
            this.log('debug', `Persisted mutation: ${JSON.stringify(data)}`, 'persistMutation', 4);
        });
    }
    async resetDatabase() {
        await this.withDB(async (db) => {
            await Promise.all(Object.values(this.storeNames).map(store => db
                .transaction(store, 'readwrite')
                .objectStore(store)
                .clear()));
            await this.handleData(this.storeNames.SETTINGS, this.getDefaultKey('APP_SETTINGS'), 'put', this.defaultSettings);
        });
    }
    async resetPaletteID() {
        await this.updateData(this.storeNames.SETTINGS, this.getDefaultKey('APP_SETTINGS'), s => ({ ...s, lastPaletteID: 0 }));
    }
    async savePalette(id, newPalette) {
        await this.handleData(this.storeNames.TABLES, id, 'put', newPalette);
    }
    async savePaletteToDB(type, items, paletteID, numBoxes, limitDark, limitGray, limitLight) {
        const newPalette = this.utils.palette.createObject(type, items, numBoxes, paletteID, limitDark, limitGray, limitLight);
        const tableID = Number(newPalette.id.split('_')[1]);
        if (isNaN(tableID))
            throw new Error(`Invalid palette ID format: ${newPalette.id}`);
        await this.savePalette(newPalette.id, { tableID, palette: newPalette });
        return newPalette;
    }
    async savePaletteHistory(paletteHistory) {
        await this.handleData(this.storeNames.SETTINGS, 'paletteHistory', 'put', { palettes: paletteHistory });
    }
    async saveSettings(newSettings) {
        await this.handleData(this.storeNames.SETTINGS, this.getDefaultKey('APP_SETTINGS'), 'put', newSettings);
    }
    async updateEntryInPalette(tableID, entryIndex, newEntry) {
        const storedPalette = await this.handleData(this.storeNames.TABLES, tableID, 'get');
        if (!storedPalette)
            throw new Error(`Palette ${tableID} not found.`);
        if (entryIndex >= storedPalette.palette.items.length)
            throw new Error(`Invalid index ${entryIndex}`);
        storedPalette.palette.items[entryIndex] = newEntry;
        await this.savePalette(tableID, storedPalette);
    }
    //
    ///
    ///// * * * *  * * * * * * * * * * * * * * * *
    ////// * * * * * * PRIVATE METHODS * * * * * *
    ///// * * * *  * * * * * * * * * * * * * * * *
    ///
    //
    getDefaultKey(key) {
        const defaultKey = this.defaultSettings[key];
        if (!defaultKey)
            throw new Error(`[getDefaultKey()]: Invalid key ${key}`);
        return defaultKey;
    }
    async handleData(store, key, action, data) {
        return this.withDB(async (db) => {
            const storeRef = db
                .transaction(store, 'readwrite')
                .objectStore(store);
            if (action === 'get')
                return (await storeRef.get(key)) ?? null;
            if (action === 'put' && data)
                await storeRef.put({ key, ...data });
            if (action === 'delete')
                await storeRef.delete(key);
        });
    }
    log(level, message, method, verbosityRequirement) {
        if (this.logMode[level] &&
            this.logMode.verbosity >= (verbosityRequirement ?? 0)) {
            logger[level](`${message}`, `${thisModule} > ${method}`);
        }
    }
    async updateData(store, key, updateFn) {
        const existing = await this.handleData(store, key, 'get');
        if (!existing)
            throw new Error(`${store} entry not found\ndb/IDBManager.js > updateData()`);
        await this.handleData(store, key, 'put', updateFn(existing));
    }
    async withDB(callback) {
        return callback(await this.dbPromise);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSURCTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kYi9JREJNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHlCQUF5QjtBQWdCekIsT0FBTyxFQUFFLFVBQVUsSUFBSSxNQUFNLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDOUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsUUFBUSxJQUFJLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRW5ELE1BQU0sVUFBVSxHQUFHLGtCQUFrQixDQUFDO0FBRXRDLE1BQU0sTUFBTSxHQUFHLE1BQU0sWUFBWSxFQUFFLENBQUM7QUFFcEMsTUFBTSxPQUFPLFVBQVU7SUFDZCxNQUFNLENBQUMsUUFBUSxHQUFzQixJQUFJLENBQUM7SUFFMUMsU0FBUyxDQUF1QztJQUVoRCxNQUFNLEdBQThCLE1BQU0sQ0FBQyxFQUFFLENBQUM7SUFDOUMsSUFBSSxHQUFzQixJQUFJLENBQUM7SUFDL0IsT0FBTyxHQUFpQyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBRXJELEtBQUssR0FFUixFQUFFLENBQUM7SUFFUixXQUFXLEdBQ1YsTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUM7SUFDaEIsZUFBZSxHQUN0QixNQUFNLENBQUMsRUFBRSxDQUFDLGdCQUFnQixDQUFDO0lBQ3BCLFVBQVUsR0FDakIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUM7SUFFZixLQUFLLENBQW9DO0lBRWpEO1FBQ0MsSUFBSSxDQUFDLFNBQVMsR0FBRyxZQUFZLEVBQUUsQ0FBQztRQUVoQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFFMUIsSUFB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bkUsSUFBSSxNQUFNLEtBQUssUUFBUTtnQkFBRSxNQUFNLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckQsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRU8sR0FBRyxDQUNWLEtBQWlDLEVBQ2pDLE9BQWUsRUFDZixNQUFjLEVBQ2Qsb0JBQTZCO1FBRTdCLElBQ0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7WUFDbkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxDQUFDLENBQUMsRUFDcEQsQ0FBQztZQUNGLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLE9BQU8sRUFBRSxFQUFFLEdBQUcsVUFBVSxNQUFNLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDMUQsQ0FBQztJQUNGLENBQUM7SUFFTyxLQUFLLENBQUMsVUFBVSxDQUN2QixLQUEwQixFQUMxQixHQUFXLEVBQ1gsUUFBNEI7UUFFNUIsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFJLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFN0QsSUFBSSxDQUFDLFFBQVE7WUFDWixNQUFNLElBQUksS0FBSyxDQUNkLEdBQUcsS0FBSyxtREFBbUQsQ0FDM0QsQ0FBQztRQUVILE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRU8sS0FBSyxDQUFDLE1BQU0sQ0FDbkIsUUFBdUM7UUFFdkMsT0FBTyxRQUFRLENBQUMsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdkMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IGRiL0lEQk1hbmFnZXIuanNcblxuaW1wb3J0IHsgSURCUERhdGFiYXNlLCBJREJQT2JqZWN0U3RvcmUgfSBmcm9tICdpZGInO1xuaW1wb3J0IHtcblx0Q29tbW9uRm5fTWFzdGVySW50ZXJmYWNlLFxuXHRDb25maWdEYXRhSW50ZXJmYWNlLFxuXHRJREJNYW5hZ2VyX0NsYXNzSW50ZXJmYWNlLFxuXHRNb2RlRGF0YUludGVyZmFjZSxcblx0TXV0YXRpb25Mb2csXG5cdFBhbGV0dGUsXG5cdFBhbGV0dGVEQixcblx0UGFsZXR0ZUl0ZW0sXG5cdFBhbGV0dGVTY2hlbWEsXG5cdFNldHRpbmdzLFxuXHRTdG9yZWRQYWxldHRlXG59IGZyb20gJy4uL3R5cGVzL2luZGV4LmpzJztcbmltcG9ydCB7IGNvbmZpZ0RhdGEgYXMgY29uZmlnIH0gZnJvbSAnLi4vZGF0YS9jb25maWcuanMnO1xuaW1wb3J0IHsgY29tbW9uRm4gfSBmcm9tICcuLi9jb21tb24vaW5kZXguanMnO1xuaW1wb3J0IHsgY3JlYXRlTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyL2luZGV4LmpzJztcbmltcG9ydCB7IGluaXRpYWxpemVEQiB9IGZyb20gJy4vaW5pdGlhbGl6ZS5qcyc7XG5pbXBvcnQgeyBtb2RlRGF0YSBhcyBtb2RlIH0gZnJvbSAnLi4vZGF0YS9tb2RlLmpzJztcblxuY29uc3QgdGhpc01vZHVsZSA9ICdkYi9JREJNYW5hZ2VyLmpzJztcblxuY29uc3QgbG9nZ2VyID0gYXdhaXQgY3JlYXRlTG9nZ2VyKCk7XG5cbmV4cG9ydCBjbGFzcyBJREJNYW5hZ2VyIGltcGxlbWVudHMgSURCTWFuYWdlcl9DbGFzc0ludGVyZmFjZSB7XG5cdHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBJREJNYW5hZ2VyIHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBkYlByb21pc2U6IFByb21pc2U8SURCUERhdGFiYXNlPFBhbGV0dGVTY2hlbWE+PjtcblxuXHRwcml2YXRlIGRiRGF0YTogQ29uZmlnRGF0YUludGVyZmFjZVsnZGInXSA9IGNvbmZpZy5kYjtcblx0cHJpdmF0ZSBtb2RlOiBNb2RlRGF0YUludGVyZmFjZSA9IG1vZGU7XG5cdHByaXZhdGUgbG9nTW9kZTogTW9kZURhdGFJbnRlcmZhY2VbJ2xvZ2dpbmcnXSA9IG1vZGUubG9nZ2luZztcblxuXHRwcml2YXRlIGNhY2hlOiBQYXJ0aWFsPHtcblx0XHRzZXR0aW5nczogU2V0dGluZ3M7XG5cdH0+ID0ge307XG5cblx0ZGVmYXVsdEtleXM6IENvbmZpZ0RhdGFJbnRlcmZhY2VbJ2RiJ11bJ0RFRkFVTFRfS0VZUyddID1cblx0XHRjb25maWcuZGIuREVGQVVMVF9LRVlTO1xuXHRwcml2YXRlIGRlZmF1bHRTZXR0aW5nczogQ29uZmlnRGF0YUludGVyZmFjZVsnZGInXVsnREVGQVVMVF9TRVRUSU5HUyddID1cblx0XHRjb25maWcuZGIuREVGQVVMVF9TRVRUSU5HUztcblx0cHJpdmF0ZSBzdG9yZU5hbWVzOiBDb25maWdEYXRhSW50ZXJmYWNlWydkYiddWydTVE9SRV9OQU1FUyddID1cblx0XHRjb25maWcuZGIuU1RPUkVfTkFNRVM7XG5cblx0cHJpdmF0ZSB1dGlsczogQ29tbW9uRm5fTWFzdGVySW50ZXJmYWNlWyd1dGlscyddO1xuXG5cdHByaXZhdGUgY29uc3RydWN0b3IoKSB7XG5cdFx0dGhpcy5kYlByb21pc2UgPSBpbml0aWFsaXplREIoKTtcblxuXHRcdHRoaXMuZGJEYXRhID0gdGhpcy5kYkRhdGE7XG5cblx0XHR0aGlzLmRlZmF1bHRLZXlzID0gY29uZmlnLmRiLkRFRkFVTFRfS0VZUztcblx0XHR0aGlzLmRlZmF1bHRTZXR0aW5ncyA9IGNvbmZpZy5kYi5ERUZBVUxUX1NFVFRJTkdTO1xuXHRcdHRoaXMuc3RvcmVOYW1lcyA9IGNvbmZpZy5kYi5TVE9SRV9OQU1FUztcblxuXHRcdHRoaXMubW9kZSA9IG1vZGU7XG5cblx0XHR0aGlzLnV0aWxzID0gY29tbW9uRm4udXRpbHM7XG5cdH1cblxuXHQvL1xuXHQvLy9cblx0Ly8vLyAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqXG5cdC8vLy8vICogKiAqICogKiAqIFNUQVRJQyBNRVRIT0RTICogKiAqICogKiAqICpcblx0Ly8vLyAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqXG5cdC8vL1xuXHQvL1xuXG5cdHB1YmxpYyBzdGF0aWMgYXN5bmMgZ2V0SW5zdGFuY2UoKTogUHJvbWlzZTxJREJNYW5hZ2VyPiB7XG5cdFx0aWYgKCF0aGlzLmluc3RhbmNlKSB7XG5cdFx0XHR0aGlzLmluc3RhbmNlID0gbmV3IElEQk1hbmFnZXIoKTtcblxuXHRcdFx0YXdhaXQgdGhpcy5pbnN0YW5jZS5kYlByb21pc2U7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIHJlc2V0SW5zdGFuY2UoKTogdm9pZCB7XG5cdFx0dGhpcy5pbnN0YW5jZSA9IG51bGw7XG5cdH1cblxuXHQvL1xuXHQvLy9cblx0Ly8vLyAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqXG5cdC8vLy8vICogKiAqICogKiAqICogUFVCTElDIE1FVEhPRFMgKiAqICogKiAqICogKlxuXHQvLy8vICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICpcblx0Ly8vXG5cdC8vXG5cblx0cHVibGljIGNyZWF0ZU11dGF0aW9uTG9nZ2VyPFQgZXh0ZW5kcyBvYmplY3Q+KG9iajogVCwga2V5OiBzdHJpbmcpOiBUIHtcblx0XHRjb25zdCBzZWxmID0gdGhpcztcblxuXHRcdHJldHVybiBuZXcgUHJveHkob2JqLCB7XG5cdFx0XHRzZXQodGFyZ2V0LCBwcm9wZXJ0eSwgdmFsdWUpIHtcblx0XHRcdFx0Y29uc3Qgb2xkVmFsdWUgPSB0YXJnZXRbcHJvcGVydHkgYXMga2V5b2YgVF07XG5cdFx0XHRcdGNvbnN0IHN1Y2Nlc3MgPSBSZWZsZWN0LnNldCh0YXJnZXQsIHByb3BlcnR5LCB2YWx1ZSk7XG5cblx0XHRcdFx0aWYgKHN1Y2Nlc3MpIHtcblx0XHRcdFx0XHRjb25zdCBtdXRhdGlvbkxvZzogTXV0YXRpb25Mb2cgPSB7XG5cdFx0XHRcdFx0XHR0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcblx0XHRcdFx0XHRcdGtleSxcblx0XHRcdFx0XHRcdGFjdGlvbjogJ3VwZGF0ZScsXG5cdFx0XHRcdFx0XHRuZXdWYWx1ZTogeyBbcHJvcGVydHldOiB2YWx1ZSB9LFxuXHRcdFx0XHRcdFx0b2xkVmFsdWU6IHsgW3Byb3BlcnR5XTogb2xkVmFsdWUgfSxcblx0XHRcdFx0XHRcdG9yaWdpbjogJ1Byb3h5J1xuXHRcdFx0XHRcdH07XG5cblx0XHRcdFx0XHRzZWxmLmxvZyhcblx0XHRcdFx0XHRcdCdkZWJ1ZycsXG5cdFx0XHRcdFx0XHRgTXV0YXRpb24gZGV0ZWN0ZWQ6ICR7SlNPTi5zdHJpbmdpZnkobXV0YXRpb25Mb2cpfWAsXG5cdFx0XHRcdFx0XHRgY3JlYXRlTXV0YXRpb25Mb2dnZXIoKWAsXG5cdFx0XHRcdFx0XHQyXG5cdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdHNlbGYucGVyc2lzdE11dGF0aW9uKG11dGF0aW9uTG9nKS5jYXRjaChlcnIgPT4ge1xuXHRcdFx0XHRcdFx0aWYgKHNlbGYubG9nTW9kZS5lcnJvcilcblx0XHRcdFx0XHRcdFx0c2VsZi5sb2coXG5cdFx0XHRcdFx0XHRcdFx0J2Vycm9yJyxcblx0XHRcdFx0XHRcdFx0XHRgRmFpbGVkIHRvIHBlcnNpc3QgbXV0YXRpb246ICR7ZXJyLm1lc3NhZ2V9YCxcblx0XHRcdFx0XHRcdFx0XHQnY3JlYXRlTXV0YXRpb25Mb2dnZXIoKSdcblx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJldHVybiBzdWNjZXNzO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGRlbGV0ZURhdGFiYXNlKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGF3YWl0IHRoaXMudXRpbHMuZXJyb3JzLmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHtcblx0XHRcdGNvbnN0IGRiTmFtZSA9ICdwYWxldHRlREInO1xuXHRcdFx0Y29uc3QgZGJFeGlzdHMgPSBhd2FpdCBuZXcgUHJvbWlzZTxib29sZWFuPihyZXNvbHZlID0+IHtcblx0XHRcdFx0Y29uc3QgcmVxdWVzdCA9IGluZGV4ZWREQi5vcGVuKGRiTmFtZSk7XG5cblx0XHRcdFx0cmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiB7XG5cdFx0XHRcdFx0cmVxdWVzdC5yZXN1bHQuY2xvc2UoKTtcblx0XHRcdFx0XHRyZXNvbHZlKHRydWUpO1xuXHRcdFx0XHR9O1xuXHRcdFx0XHRyZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZXNvbHZlKGZhbHNlKTtcblx0XHRcdH0pO1xuXG5cdFx0XHRpZiAoZGJFeGlzdHMpIHtcblx0XHRcdFx0Y29uc3QgZGVsZXRlUmVxdWVzdCA9IGluZGV4ZWREQi5kZWxldGVEYXRhYmFzZShkYk5hbWUpO1xuXG5cdFx0XHRcdGRlbGV0ZVJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4ge1xuXHRcdFx0XHRcdHRoaXMubG9nKFxuXHRcdFx0XHRcdFx0J2RlYnVnJyxcblx0XHRcdFx0XHRcdGBEYXRhYmFzZSBcIiR7ZGJOYW1lfVwiIGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5LmAsXG5cdFx0XHRcdFx0XHRgZGVsZXRlRGF0YWJhc2UoKWAsXG5cdFx0XHRcdFx0XHQxXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fTtcblx0XHRcdFx0ZGVsZXRlUmVxdWVzdC5vbmVycm9yID0gZXZlbnQgPT4ge1xuXHRcdFx0XHRcdHRoaXMubG9nKFxuXHRcdFx0XHRcdFx0J2Vycm9yJyxcblx0XHRcdFx0XHRcdGBFcnJvciBkZWxldGluZyBkYXRhYmFzZSBcIiR7ZGJOYW1lfVwiOlxcbkV2ZW50OiAke2V2ZW50fWAsXG5cdFx0XHRcdFx0XHRgZGVsZXRlRGF0YWJhc2UoKWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9O1xuXHRcdFx0XHRkZWxldGVSZXF1ZXN0Lm9uYmxvY2tlZCA9ICgpID0+IHtcblx0XHRcdFx0XHR0aGlzLmxvZyhcblx0XHRcdFx0XHRcdCd3YXJuJyxcblx0XHRcdFx0XHRcdGBEZWxldGUgb3BlcmF0aW9uIGJsb2NrZWQuIEVuc3VyZSBubyBvcGVuIGNvbm5lY3Rpb25zIHRvIFwiJHtkYk5hbWV9XCIuYCxcblx0XHRcdFx0XHRcdGBkZWxldGVEYXRhYmFzZSgpYCxcblx0XHRcdFx0XHRcdDFcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdFx0aWYgKHRoaXMubW9kZS5zaG93QWxlcnRzKVxuXHRcdFx0XHRcdFx0YWxlcnQoXG5cdFx0XHRcdFx0XHRcdGBVbmFibGUgdG8gZGVsZXRlIGRhdGFiYXNlIFwiJHtkYk5hbWV9XCIgYmVjYXVzZSBpdCBpcyBpbiB1c2UuIFBsZWFzZSBjbG9zZSBhbGwgb3RoZXIgdGFicyBvciB3aW5kb3dzIGFjY2Vzc2luZyB0aGlzIGRhdGFiYXNlIGFuZCB0cnkgYWdhaW4uYFxuXHRcdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdGlmICh0aGlzLm1vZGUuc3RhY2tUcmFjZSlcblx0XHRcdFx0XHRcdGNvbnNvbGUudHJhY2UoYEJsb2NrZWQgY2FsbCBzdGFjazpgKTtcblx0XHRcdFx0fTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGlmICh0aGlzLmxvZ01vZGUud2FybiAmJiB0aGlzLmxvZ01vZGUudmVyYm9zaXR5ID49IDMpXG5cdFx0XHRcdFx0dGhpcy5sb2coXG5cdFx0XHRcdFx0XHQnd2FybicsXG5cdFx0XHRcdFx0XHRgRGF0YWJhc2UgXCIke2RiTmFtZX1cIiBkb2VzIG5vdCBleGlzdC5gLFxuXHRcdFx0XHRcdFx0YGRlbGV0ZURhdGFiYXNlKClgXG5cdFx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9LCAnSURCTWFuYWdlci5kZWxldGVEYXRhYmFzZSgpOiBFcnJvciBkZWxldGluZyBkYXRhYmFzZScpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGRlbGV0ZUVudHJpZXMoXG5cdFx0c3RvcmU6IGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0a2V5czogc3RyaW5nW11cblx0KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy53aXRoREIoYXN5bmMgZGIgPT4ge1xuXHRcdFx0Y29uc3Qgc3RvcmVSZWYgPSBkYlxuXHRcdFx0XHQudHJhbnNhY3Rpb24oc3RvcmUsICdyZWFkd3JpdGUnKVxuXHRcdFx0XHQub2JqZWN0U3RvcmUoc3RvcmUpO1xuXG5cdFx0XHRmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG5cdFx0XHRcdGlmICgoYXdhaXQgdGhpcy5oYW5kbGVEYXRhKHN0b3JlLCBrZXksICdnZXQnKSkgIT09IG51bGwpIHtcblx0XHRcdFx0XHRhd2FpdCBzdG9yZVJlZi5kZWxldGUoa2V5KTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldEN1cnJlbnRQYWxldHRlSUQoKTogUHJvbWlzZTxudW1iZXI+IHtcblx0XHRyZXR1cm4gdGhpcy5oYW5kbGVEYXRhPFNldHRpbmdzPihcblx0XHRcdHRoaXMuc3RvcmVOYW1lcy5TRVRUSU5HUyBhcyBrZXlvZiBQYWxldHRlU2NoZW1hLFxuXHRcdFx0dGhpcy5nZXREZWZhdWx0S2V5KCdBUFBfU0VUVElOR1MnKSxcblx0XHRcdCdnZXQnXG5cdFx0KS50aGVuKHNldHRpbmdzID0+IHNldHRpbmdzPy5sYXN0UGFsZXR0ZUlEID8/IDApO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldENhY2hlZFNldHRpbmdzKCk6IFByb21pc2U8U2V0dGluZ3M+IHtcblx0XHRpZiAoIXRoaXMuY2FjaGUuc2V0dGluZ3MpXG5cdFx0XHR0aGlzLmNhY2hlLnNldHRpbmdzID0gYXdhaXQgdGhpcy5nZXRTZXR0aW5ncygpO1xuXG5cdFx0cmV0dXJuIHRoaXMuY2FjaGUuc2V0dGluZ3M7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZ2V0TmV4dFRhYmxlSUQoKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0XHRjb25zdCBsYXN0VGFibGVJRCA9XG5cdFx0XHQoXG5cdFx0XHRcdGF3YWl0IHRoaXMuaGFuZGxlRGF0YTxTZXR0aW5ncz4oXG5cdFx0XHRcdFx0dGhpcy5zdG9yZU5hbWVzLlNFVFRJTkdTIGFzIGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0XHRcdFx0dGhpcy5nZXREZWZhdWx0S2V5KCdBUFBfU0VUVElOR1MnKSxcblx0XHRcdFx0XHQnZ2V0J1xuXHRcdFx0XHQpXG5cdFx0XHQpPy5sYXN0VGFibGVJRCA/PyAwO1xuXG5cdFx0Y29uc3QgbmV4dElEID0gbGFzdFRhYmxlSUQgKyAxO1xuXG5cdFx0YXdhaXQgdGhpcy51cGRhdGVEYXRhKFxuXHRcdFx0dGhpcy5zdG9yZU5hbWVzLlNFVFRJTkdTIGFzIGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0XHR0aGlzLmdldERlZmF1bHRLZXkoJ0FQUF9TRVRUSU5HUycpLFxuXHRcdFx0cyA9PiAoeyAuLi5zLCBsYXN0VGFibGVJRDogbmV4dElEIH0pXG5cdFx0KTtcblxuXHRcdHJldHVybiBgcGFsZXR0ZV8ke25leHRJRH1gO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldE11dGF0aW9ucygpOiBQcm9taXNlPE11dGF0aW9uTG9nW10+IHtcblx0XHRyZXR1cm4gdGhpcy5oYW5kbGVEYXRhPE11dGF0aW9uTG9nW10+KFxuXHRcdFx0dGhpcy5zdG9yZU5hbWVzLk1VVEFUSU9OUyBhcyBrZXlvZiBQYWxldHRlU2NoZW1hLFxuXHRcdFx0J211dGF0aW9uX2xvZ3MnLFxuXHRcdFx0J2dldCdcblx0XHQpLnRoZW4obXV0YXRpb25zID0+IG11dGF0aW9ucyA/PyBbXSk7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZ2V0UGFsZXR0ZUhpc3RvcnkoKTogUHJvbWlzZTxQYWxldHRlW10+IHtcblx0XHRyZXR1cm4gKFxuXHRcdFx0KFxuXHRcdFx0XHRhd2FpdCB0aGlzLmhhbmRsZURhdGE8eyBwYWxldHRlczogUGFsZXR0ZVtdIH0+KFxuXHRcdFx0XHRcdHRoaXMuc3RvcmVOYW1lcy5TRVRUSU5HUyBhcyBrZXlvZiBQYWxldHRlU2NoZW1hLFxuXHRcdFx0XHRcdCdwYWxldHRlSGlzdG9yeScsXG5cdFx0XHRcdFx0J2dldCdcblx0XHRcdFx0KVxuXHRcdFx0KT8ucGFsZXR0ZXMgPz8gW11cblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldFNldHRpbmdzKCk6IFByb21pc2U8U2V0dGluZ3M+IHtcblx0XHRyZXR1cm4ge1xuXHRcdFx0Li4udGhpcy5kZWZhdWx0U2V0dGluZ3MsXG5cdFx0XHQuLi4oYXdhaXQgdGhpcy5oYW5kbGVEYXRhPFBhcnRpYWw8U2V0dGluZ3M+Pihcblx0XHRcdFx0dGhpcy5zdG9yZU5hbWVzLlNFVFRJTkdTIGFzIGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0XHRcdHRoaXMuZ2V0RGVmYXVsdEtleSgnQVBQX1NFVFRJTkdTJyksXG5cdFx0XHRcdCdnZXQnXG5cdFx0XHQpKVxuXHRcdH07XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZ2V0U3RvcmU8U3RvcmVOYW1lIGV4dGVuZHMga2V5b2YgUGFsZXR0ZVNjaGVtYT4oXG5cdFx0c3RvcmVOYW1lOiBTdG9yZU5hbWUsXG5cdFx0bW9kZTogJ3JlYWRvbmx5J1xuXHQpOiBQcm9taXNlPFxuXHRcdElEQlBPYmplY3RTdG9yZTxQYWxldHRlU2NoZW1hLCBbU3RvcmVOYW1lXSwgU3RvcmVOYW1lLCAncmVhZG9ubHknPlxuXHQ+O1xuXG5cdHB1YmxpYyBhc3luYyBnZXRTdG9yZTxTdG9yZU5hbWUgZXh0ZW5kcyBrZXlvZiBQYWxldHRlU2NoZW1hPihcblx0XHRzdG9yZU5hbWU6IFN0b3JlTmFtZSxcblx0XHRtb2RlOiAncmVhZHdyaXRlJ1xuXHQpOiBQcm9taXNlPFxuXHRcdElEQlBPYmplY3RTdG9yZTxQYWxldHRlU2NoZW1hLCBbU3RvcmVOYW1lXSwgU3RvcmVOYW1lLCAncmVhZHdyaXRlJz5cblx0PjtcblxuXHRwdWJsaWMgYXN5bmMgZ2V0U3RvcmU8U3RvcmVOYW1lIGV4dGVuZHMga2V5b2YgUGFsZXR0ZVNjaGVtYT4oXG5cdFx0c3RvcmVOYW1lOiBTdG9yZU5hbWUsXG5cdFx0bW9kZTogJ3JlYWRvbmx5JyB8ICdyZWFkd3JpdGUnXG5cdCk6IFByb21pc2U8XG5cdFx0SURCUE9iamVjdFN0b3JlPFBhbGV0dGVTY2hlbWEsIFtTdG9yZU5hbWVdLCBTdG9yZU5hbWUsIHR5cGVvZiBtb2RlPlxuXHQ+IHtcblx0XHRyZXR1cm4gdGhpcy53aXRoREIoYXN5bmMgZGIgPT5cblx0XHRcdGRiLnRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgbW9kZSkub2JqZWN0U3RvcmUoc3RvcmVOYW1lKVxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgcGVyc2lzdE11dGF0aW9uKGRhdGE6IE11dGF0aW9uTG9nKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0cmV0dXJuIHRoaXMud2l0aERCKGFzeW5jIGRiID0+IHtcblx0XHRcdGF3YWl0IGRiLnB1dCgnbXV0YXRpb25zJywgZGF0YSk7XG5cblx0XHRcdHRoaXMubG9nKFxuXHRcdFx0XHQnZGVidWcnLFxuXHRcdFx0XHRgUGVyc2lzdGVkIG11dGF0aW9uOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWAsXG5cdFx0XHRcdCdwZXJzaXN0TXV0YXRpb24nLFxuXHRcdFx0XHQ0XG5cdFx0XHQpO1xuXHRcdH0pO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHJlc2V0RGF0YWJhc2UoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy53aXRoREIoYXN5bmMgZGIgPT4ge1xuXHRcdFx0YXdhaXQgUHJvbWlzZS5hbGwoXG5cdFx0XHRcdE9iamVjdC52YWx1ZXModGhpcy5zdG9yZU5hbWVzKS5tYXAoc3RvcmUgPT5cblx0XHRcdFx0XHRkYlxuXHRcdFx0XHRcdFx0LnRyYW5zYWN0aW9uKHN0b3JlLCAncmVhZHdyaXRlJylcblx0XHRcdFx0XHRcdC5vYmplY3RTdG9yZShzdG9yZSlcblx0XHRcdFx0XHRcdC5jbGVhcigpXG5cdFx0XHRcdClcblx0XHRcdCk7XG5cdFx0XHRhd2FpdCB0aGlzLmhhbmRsZURhdGEoXG5cdFx0XHRcdHRoaXMuc3RvcmVOYW1lcy5TRVRUSU5HUyBhcyBrZXlvZiBQYWxldHRlU2NoZW1hLFxuXHRcdFx0XHR0aGlzLmdldERlZmF1bHRLZXkoJ0FQUF9TRVRUSU5HUycpLFxuXHRcdFx0XHQncHV0Jyxcblx0XHRcdFx0dGhpcy5kZWZhdWx0U2V0dGluZ3Ncblx0XHRcdCk7XG5cdFx0fSk7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgcmVzZXRQYWxldHRlSUQoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy51cGRhdGVEYXRhKFxuXHRcdFx0dGhpcy5zdG9yZU5hbWVzLlNFVFRJTkdTIGFzIGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0XHR0aGlzLmdldERlZmF1bHRLZXkoJ0FQUF9TRVRUSU5HUycpLFxuXHRcdFx0cyA9PiAoeyAuLi5zLCBsYXN0UGFsZXR0ZUlEOiAwIH0pXG5cdFx0KTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzYXZlUGFsZXR0ZShcblx0XHRpZDogc3RyaW5nLFxuXHRcdG5ld1BhbGV0dGU6IFN0b3JlZFBhbGV0dGVcblx0KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy5oYW5kbGVEYXRhKFxuXHRcdFx0dGhpcy5zdG9yZU5hbWVzLlRBQkxFUyBhcyBrZXlvZiBQYWxldHRlU2NoZW1hLFxuXHRcdFx0aWQsXG5cdFx0XHQncHV0Jyxcblx0XHRcdG5ld1BhbGV0dGVcblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHNhdmVQYWxldHRlVG9EQihcblx0XHR0eXBlOiBzdHJpbmcsXG5cdFx0aXRlbXM6IFBhbGV0dGVJdGVtW10sXG5cdFx0cGFsZXR0ZUlEOiBudW1iZXIsXG5cdFx0bnVtQm94ZXM6IG51bWJlcixcblx0XHRsaW1pdERhcms6IGJvb2xlYW4sXG5cdFx0bGltaXRHcmF5OiBib29sZWFuLFxuXHRcdGxpbWl0TGlnaHQ6IGJvb2xlYW5cblx0KTogUHJvbWlzZTxQYWxldHRlPiB7XG5cdFx0Y29uc3QgbmV3UGFsZXR0ZSA9IHRoaXMudXRpbHMucGFsZXR0ZS5jcmVhdGVPYmplY3QoXG5cdFx0XHR0eXBlLFxuXHRcdFx0aXRlbXMsXG5cdFx0XHRudW1Cb3hlcyxcblx0XHRcdHBhbGV0dGVJRCxcblx0XHRcdGxpbWl0RGFyayxcblx0XHRcdGxpbWl0R3JheSxcblx0XHRcdGxpbWl0TGlnaHRcblx0XHQpO1xuXHRcdGNvbnN0IHRhYmxlSUQgPSBOdW1iZXIobmV3UGFsZXR0ZS5pZC5zcGxpdCgnXycpWzFdKTtcblxuXHRcdGlmIChpc05hTih0YWJsZUlEKSlcblx0XHRcdHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwYWxldHRlIElEIGZvcm1hdDogJHtuZXdQYWxldHRlLmlkfWApO1xuXG5cdFx0YXdhaXQgdGhpcy5zYXZlUGFsZXR0ZShuZXdQYWxldHRlLmlkLCB7IHRhYmxlSUQsIHBhbGV0dGU6IG5ld1BhbGV0dGUgfSk7XG5cblx0XHRyZXR1cm4gbmV3UGFsZXR0ZTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzYXZlUGFsZXR0ZUhpc3RvcnkocGFsZXR0ZUhpc3Rvcnk6IFBhbGV0dGVbXSk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGF3YWl0IHRoaXMuaGFuZGxlRGF0YShcblx0XHRcdHRoaXMuc3RvcmVOYW1lcy5TRVRUSU5HUyBhcyBrZXlvZiBQYWxldHRlU2NoZW1hLFxuXHRcdFx0J3BhbGV0dGVIaXN0b3J5Jyxcblx0XHRcdCdwdXQnLFxuXHRcdFx0eyBwYWxldHRlczogcGFsZXR0ZUhpc3RvcnkgfVxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2F2ZVNldHRpbmdzKG5ld1NldHRpbmdzOiBTZXR0aW5ncyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGF3YWl0IHRoaXMuaGFuZGxlRGF0YShcblx0XHRcdHRoaXMuc3RvcmVOYW1lcy5TRVRUSU5HUyBhcyBrZXlvZiBQYWxldHRlU2NoZW1hLFxuXHRcdFx0dGhpcy5nZXREZWZhdWx0S2V5KCdBUFBfU0VUVElOR1MnKSxcblx0XHRcdCdwdXQnLFxuXHRcdFx0bmV3U2V0dGluZ3Ncblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHVwZGF0ZUVudHJ5SW5QYWxldHRlKFxuXHRcdHRhYmxlSUQ6IHN0cmluZyxcblx0XHRlbnRyeUluZGV4OiBudW1iZXIsXG5cdFx0bmV3RW50cnk6IFBhbGV0dGVJdGVtXG5cdCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IHN0b3JlZFBhbGV0dGUgPSBhd2FpdCB0aGlzLmhhbmRsZURhdGE8U3RvcmVkUGFsZXR0ZT4oXG5cdFx0XHR0aGlzLnN0b3JlTmFtZXMuVEFCTEVTIGFzIGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0XHR0YWJsZUlELFxuXHRcdFx0J2dldCdcblx0XHQpO1xuXG5cdFx0aWYgKCFzdG9yZWRQYWxldHRlKSB0aHJvdyBuZXcgRXJyb3IoYFBhbGV0dGUgJHt0YWJsZUlEfSBub3QgZm91bmQuYCk7XG5cdFx0aWYgKGVudHJ5SW5kZXggPj0gc3RvcmVkUGFsZXR0ZS5wYWxldHRlLml0ZW1zLmxlbmd0aClcblx0XHRcdHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBpbmRleCAke2VudHJ5SW5kZXh9YCk7XG5cblx0XHRzdG9yZWRQYWxldHRlLnBhbGV0dGUuaXRlbXNbZW50cnlJbmRleF0gPSBuZXdFbnRyeTtcblxuXHRcdGF3YWl0IHRoaXMuc2F2ZVBhbGV0dGUodGFibGVJRCwgc3RvcmVkUGFsZXR0ZSk7XG5cdH1cblxuXHQvL1xuXHQvLy9cblx0Ly8vLy8gKiAqICogKiAgKiAqICogKiAqICogKiAqICogKiAqICogKiAqICogKlxuXHQvLy8vLy8gKiAqICogKiAqICogUFJJVkFURSBNRVRIT0RTICogKiAqICogKiAqXG5cdC8vLy8vICogKiAqICogICogKiAqICogKiAqICogKiAqICogKiAqICogKiAqICpcblx0Ly8vXG5cdC8vXG5cblx0cHJpdmF0ZSBnZXREZWZhdWx0S2V5KFxuXHRcdGtleToga2V5b2YgQ29uZmlnRGF0YUludGVyZmFjZVsnZGInXVsnU1RPUkVfTkFNRVMnXVxuXHQpOiBzdHJpbmcge1xuXHRcdGNvbnN0IGRlZmF1bHRLZXkgPVxuXHRcdFx0dGhpcy5kZWZhdWx0U2V0dGluZ3Nba2V5IGFzIGtleW9mIHR5cGVvZiB0aGlzLmRlZmF1bHRTZXR0aW5nc107XG5cblx0XHRpZiAoIWRlZmF1bHRLZXkpXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtnZXREZWZhdWx0S2V5KCldOiBJbnZhbGlkIGtleSAke2tleX1gKTtcblxuXHRcdHJldHVybiBkZWZhdWx0S2V5IGFzIGtleW9mIFBhbGV0dGVTY2hlbWE7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGhhbmRsZURhdGE8VD4oXG5cdFx0c3RvcmU6IGtleW9mIFBhbGV0dGVTY2hlbWEsXG5cdFx0a2V5OiBzdHJpbmcsXG5cdFx0YWN0aW9uOiAnZ2V0JyB8ICdwdXQnIHwgJ2RlbGV0ZScsXG5cdFx0ZGF0YT86IFRcblx0KTogUHJvbWlzZTxUIHwgdm9pZCB8IG51bGw+IHtcblx0XHRyZXR1cm4gdGhpcy53aXRoREIoYXN5bmMgZGIgPT4ge1xuXHRcdFx0Y29uc3Qgc3RvcmVSZWYgPSBkYlxuXHRcdFx0XHQudHJhbnNhY3Rpb24oc3RvcmUsICdyZWFkd3JpdGUnKVxuXHRcdFx0XHQub2JqZWN0U3RvcmUoc3RvcmUpO1xuXG5cdFx0XHRpZiAoYWN0aW9uID09PSAnZ2V0JykgcmV0dXJuIChhd2FpdCBzdG9yZVJlZi5nZXQoa2V5KSkgPz8gbnVsbDtcblx0XHRcdGlmIChhY3Rpb24gPT09ICdwdXQnICYmIGRhdGEpIGF3YWl0IHN0b3JlUmVmLnB1dCh7IGtleSwgLi4uZGF0YSB9KTtcblx0XHRcdGlmIChhY3Rpb24gPT09ICdkZWxldGUnKSBhd2FpdCBzdG9yZVJlZi5kZWxldGUoa2V5KTtcblx0XHR9KTtcblx0fVxuXG5cdHByaXZhdGUgbG9nKFxuXHRcdGxldmVsOiAnZGVidWcnIHwgJ3dhcm4nIHwgJ2Vycm9yJyxcblx0XHRtZXNzYWdlOiBzdHJpbmcsXG5cdFx0bWV0aG9kOiBzdHJpbmcsXG5cdFx0dmVyYm9zaXR5UmVxdWlyZW1lbnQ/OiBudW1iZXJcblx0KTogdm9pZCB7XG5cdFx0aWYgKFxuXHRcdFx0dGhpcy5sb2dNb2RlW2xldmVsXSAmJlxuXHRcdFx0dGhpcy5sb2dNb2RlLnZlcmJvc2l0eSA+PSAodmVyYm9zaXR5UmVxdWlyZW1lbnQgPz8gMClcblx0XHQpIHtcblx0XHRcdGxvZ2dlcltsZXZlbF0oYCR7bWVzc2FnZX1gLCBgJHt0aGlzTW9kdWxlfSA+ICR7bWV0aG9kfWApO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgdXBkYXRlRGF0YTxUIGV4dGVuZHMgb2JqZWN0Pihcblx0XHRzdG9yZToga2V5b2YgUGFsZXR0ZVNjaGVtYSxcblx0XHRrZXk6IHN0cmluZyxcblx0XHR1cGRhdGVGbjogKGV4aXN0aW5nOiBUKSA9PiBUXG5cdCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgdGhpcy5oYW5kbGVEYXRhPFQ+KHN0b3JlLCBrZXksICdnZXQnKTtcblxuXHRcdGlmICghZXhpc3RpbmcpXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXG5cdFx0XHRcdGAke3N0b3JlfSBlbnRyeSBub3QgZm91bmRcXG5kYi9JREJNYW5hZ2VyLmpzID4gdXBkYXRlRGF0YSgpYFxuXHRcdFx0KTtcblxuXHRcdGF3YWl0IHRoaXMuaGFuZGxlRGF0YShzdG9yZSwga2V5LCAncHV0JywgdXBkYXRlRm4oZXhpc3RpbmcpKTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgd2l0aERCPFQ+KFxuXHRcdGNhbGxiYWNrOiAoZGI6IFBhbGV0dGVEQikgPT4gUHJvbWlzZTxUPlxuXHQpOiBQcm9taXNlPFQ+IHtcblx0XHRyZXR1cm4gY2FsbGJhY2soYXdhaXQgdGhpcy5kYlByb21pc2UpO1xuXHR9XG59XG4iXX0=