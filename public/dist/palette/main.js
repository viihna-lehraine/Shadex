// File: src/palette/main.js
import { IDBManager } from '../db/index.js';
import { core, helpers, utils } from '../common/index.js';
import { createLogger } from '../logger/index.js';
import { defaults, mode } from '../common/data/base.js';
import { genPalette as genPaletteType } from './main/index.js';
import { paletteHelpers } from './common/index.js';
import { transform } from '../common/transform/index.js';
const logger = await createLogger();
const defaultPalette = defaults.palette.unbranded.data;
const defaultBrandedPalete = transform.brandPalette(defaultPalette);
const limits = paletteHelpers.limits;
const logMode = mode.logging;
const isTooDark = limits.isTooDark;
const isTooGray = limits.isTooGray;
const isTooLight = limits.isTooLight;
async function genPalette(options) {
    try {
        let { swatches, customColor } = options;
        if (logMode.info && logMode.verbosity > 2)
            logger.info('Retrieving existing IDBManager instance.', 'palette > main > genPalette()');
        const idb = await IDBManager.getInstance();
        if (customColor === null || customColor === undefined) {
            if (logMode.error)
                logger.error('Custom color is null or undefined.', 'palette > main > genPalette()');
            return;
        }
        const validatedCustomColor = (await helpers.dom.validateAndConvertColor(customColor)) ??
            utils.random.hsl(options.flags.enableAlpha);
        if (mode.debug && logMode.info && logMode.verbosity > 2)
            logger.info(`Custom color: ${JSON.stringify(customColor)}`, 'palette > main > genPalette()');
        options.customColor = validatedCustomColor;
        const palette = await generate.selectedPalette(options);
        if (palette.items.length === 0) {
            if (logMode.error)
                logger.error('Colors array is empty or invalid.', 'palette > main > genPalette()');
            return;
        }
        if (!mode.quiet && logMode.info && logMode.verbosity > 0)
            logger.info(`Colors array generated: ${JSON.stringify(palette.items)}`, 'palette > main > genPalette()');
        const tableId = await idb.getNextTableID();
        if (!tableId)
            throw new Error('Table ID is null or undefined.');
        await genPaletteDOMBox(palette.items, swatches, tableId);
    }
    catch (error) {
        if (logMode.error)
            logger.error(`Error starting palette generation: ${error}`, 'palette > main > genPalette()');
    }
}
async function genPaletteDOMBox(items, numBoxes, tableId) {
    try {
        const paletteRow = document.getElementById('palette-row');
        const idbManager = await IDBManager.getInstance();
        if (!paletteRow) {
            if (logMode.error)
                logger.error('paletteRow is undefined.', 'palette > main > genPaletteDOMBox()');
            return;
        }
        paletteRow.innerHTML = '';
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < Math.min(items.length, numBoxes); i++) {
            const item = items[i];
            const color = { value: item.colors.hsl, format: 'hsl' };
            const { colorStripe } = await helpers.dom.makePaletteBox(color, i + 1);
            fragment.appendChild(colorStripe);
            utils.palette.populateOutputBox(color, i + 1);
        }
        paletteRow.appendChild(fragment);
        if (!mode.quiet && logMode.info && logMode.verbosity > 1)
            logger.info('Palette boxes generated and rendered.', 'palette > main > genPaletteDOMBox()');
        await idbManager.saveData('tables', tableId, { palette: items });
    }
    catch (error) {
        if (logMode.error)
            logger.error(`Error generating palette box: ${error}`, 'palette > main > genPaletteDOMBox()');
    }
}
export const start = {
    genPalette,
    genPaletteDOMBox
};
// ******** GENERATE ********
function limitedHSL(baseHue, limitDark, limitGray, limitLight, alphaValue) {
    let hsl;
    do {
        hsl = {
            value: {
                hue: core.brand.asRadial(baseHue),
                saturation: core.brand.asPercentile(Math.random() * 100),
                lightness: core.brand.asPercentile(Math.random() * 100),
                alpha: alphaValue
                    ? core.brand.asAlphaRange(alphaValue)
                    : core.brand.asAlphaRange(1)
            },
            format: 'hsl'
        };
    } while ((limitGray && isTooGray(hsl)) ||
        (limitDark && isTooDark(hsl)) ||
        (limitLight && isTooLight(hsl)));
    return hsl;
}
async function selectedPalette(options) {
    try {
        const { customColor, flags, swatches, type } = options;
        const args = {
            swatches,
            customColor,
            enableAlpha: flags.enableAlpha,
            limitDark: flags.limitDarkness,
            limitGray: flags.limitGrayness,
            limitLight: flags.limitLightness
        };
        switch (type) {
            case 1:
                return genPaletteType.random(args);
            case 2:
                return genPaletteType.complementary(args);
            case 3:
                return genPaletteType.triadic(args);
            case 4:
                return genPaletteType.tetradic(args);
            case 5:
                return genPaletteType.splitComplementary(args);
            case 6:
                return genPaletteType.analogous(args);
            case 7:
                return genPaletteType.hexadic(args);
            case 8:
                return genPaletteType.diadic(args);
            case 9:
                return genPaletteType.monochromatic(args);
            default:
                if (logMode.error)
                    logger.error('Invalid palette type.', 'palette > main > selectedPalette()');
                return Promise.resolve(defaultBrandedPalete);
        }
    }
    catch (error) {
        if (logMode.error)
            logger.error(`Error generating palette: ${error}`, 'palette > main > selectedPalette()');
        return Promise.resolve(defaultBrandedPalete);
    }
}
export const generate = {
    limitedHSL,
    selectedPalette
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYWxldHRlL21haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNEJBQTRCO0FBUzVCLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsVUFBVSxJQUFJLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFFekQsTUFBTSxNQUFNLEdBQUcsTUFBTSxZQUFZLEVBQUUsQ0FBQztBQUVwQyxNQUFNLGNBQWMsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7QUFDdkQsTUFBTSxvQkFBb0IsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBRXBFLE1BQU0sTUFBTSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUM7QUFDckMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztBQUU3QixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO0FBQ25DLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUM7QUFDbkMsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQztBQUVyQyxLQUFLLFVBQVUsVUFBVSxDQUFDLE9BQXVCO0lBQ2hELElBQUksQ0FBQztRQUNKLElBQUksRUFBRSxRQUFRLEVB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LE9BQU8sQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUMvQyxDQUFDO0lBQ0YsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDaEIsSUFBSSxPQUFPLENBQUMsS0FBSztZQUNoQixNQUFNLENBQUMsS0FBSyxDQUNYLDZCQUE2QixLQUFLLEVBQUUsRUFDcEMsb0NBQW9DLENBQ3BDLENBQUM7UUFFSCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUM5QyxDQUFDO0FBQ0YsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRztJQUN2QixVQUFVO0lBQ1YsZUFBZTtDQUNOLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBGaWxlOiBzcmMvcGFsZXR0ZS9tYWluLmpzXG5cbmltcG9ydCB7XG5cdEdlblBhbGV0dGVBcmdzLFxuXHRIU0wsXG5cdFBhbGV0dGUsXG5cdFBhbGV0dGVJdGVtLFxuXHRQYWxldHRlT3B0aW9uc1xufSBmcm9tICcuLi90eXBlcy9pbmRleC5qcyc7XG5pbXBvcnQgeyBJREJNYW5hZ2VyIH0gZnJvbSAnLi4vZGIvaW5kZXguanMnO1xuaW1wb3J0IHsgY29yZSwgaGVscGVycywgdXRpbHMgfSBmcm9tICcuLi9jb21tb24vaW5kZXguanMnO1xuaW1wb3J0IHsgY3JlYXRlTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyL2luZGV4LmpzJztcbmltcG9ydCB7IGRlZmF1bHRzLCBtb2RlIH0gZnJvbSAnLi4vY29tbW9uL2RhdGEvYmFzZS5qcyc7XG5pbXBvcnQgeyBnZW5QYWxldHRlIGFzIGdlblBhbGV0dGVUeXBlIH0gZnJvbSAnLi9tYWluL2luZGV4LmpzJztcbmltcG9ydCB7IHBhbGV0dGVIZWxwZXJzIH0gZnJvbSAnLi9jb21tb24vaW5kZXguanMnO1xuaW1wb3J0IHsgdHJhbnNmb3JtIH0gZnJvbSAnLi4vY29tbW9uL3RyYW5zZm9ybS9pbmRleC5qcyc7XG5cbmNvbnN0IGxvZ2dlciA9IGF3YWl0IGNyZWF0ZUxvZ2dlcigpO1xuXG5jb25zdCBkZWZhdWx0UGFsZXR0ZSA9IGRlZmF1bHRzLnBhbGV0dGUudW5icmFuZGVkLmRhdGE7XG5jb25zdCBkZWZhdWx0QnJhbmRlZFBhbGV0ZSA9IHRyYW5zZm9ybS5icmFuZFBhbGV0dGUoZGVmYXVsdFBhbGV0dGUpO1xuXG5jb25zdCBsaW1pdHMgPSBwYWxldHRlSGVscGVycy5saW1pdHM7XG5jb25zdCBsb2dNb2RlID0gbW9kZS5sb2dnaW5nO1xuXG5jb25zdCBpc1Rvb0RhcmsgPSBsaW1pdHMuaXNUb29EYXJrO1xuY29uc3QgaXNUb29HcmF5ID0gbGltaXRzLmlzVG9vR3JheTtcbmNvbnN0IGlzVG9vTGlnaHQgPSBsaW1pdHMuaXNUb29MaWdodDtcblxuYXN5bmMgZnVuY3Rpb24gZ2VuUGFsZXR0ZShvcHRpb25zOiBQYWxldHRlT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGxldCB7IHN3YXRjaGVzLCBjdXN0b21Db2xvciB9ID0gb3B0aW9ucztcblxuXHRcdGlmIChsb2dNb2RlLmluZm8gJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAyKVxuXHRcdFx0bG9nZ2VyLmluZm8oXG5cdFx0XHRcdCdSZXRyaWV2aW5nIGV4aXN0aW5nIElEQk1hbmFnZXIgaW5zdGFuY2UuJyxcblx0XHRcdFx0J3BhbGV0dGUgPiBtYWluID4gZ2VuUGFsZXR0ZSgpJ1xuXHRcdFx0KTtcblxuXHRcdGNvbnN0IGlkYiA9IGF3YWl0IElEQk1hbmFnZXIuZ2V0SW5zdGFuY2UoKTtcblxuXHRcdGlmIChjdXN0b21Db2xvciA9PT0gbnVsbCB8fCBjdXN0b21Db2xvciA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRpZiAobG9nTW9kZS5lcnJvcilcblx0XHRcdFx0bG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRcdCdDdXN0b20gY29sb3IgaXMgbnVsbCBvciB1bmRlZmluZWQuJyxcblx0XHRcdFx0XHQncGFsZXR0ZSA+IG1haW4gPiBnZW5QYWxldHRlKCknXG5cdFx0XHRcdCk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCB2YWxpZGF0ZWRDdXN0b21Db2xvcjogSFNMID1cblx0XHRcdCgoYXdhaXQgaGVscGVycy5kb20udmFsaWRhdGVBbmRDb252ZXJ0Q29sb3IoY3VzdG9tQ29sb3IpKSBhcyBIU0wpID8/XG5cdFx0XHR1dGlscy5yYW5kb20uaHNsKG9wdGlvbnMuZmxhZ3MuZW5hYmxlQWxwaGEpO1xuXG5cdFx0aWYgKG1vZGUuZGVidWcgJiYgbG9nTW9kZS5pbmZvICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMilcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHRgQ3VzdG9tIGNvbG9yOiAke0pTT04uc3RyaW5naWZ5KGN1c3RvbUNvbG9yKX1gLFxuXHRcdFx0XHQncGFsZXR0ZSA+IG1haW4gPiBnZW5QYWxldHRlKCknXG5cdFx0XHQpO1xuXG5cdFx0b3B0aW9ucy5jdXN0b21Db2xvciA9IHZhbGlkYXRlZEN1c3RvbUNvbG9yO1xuXG5cdFx0Y29uc3QgcGFsZXR0ZSA9IGF3YWl0IGdlbmVyYXRlLnNlbGVjdGVkUGFsZXR0ZShvcHRpb25zKTtcblxuXHRcdGlmIChwYWxldHRlLml0ZW1zLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0XHQnQ29sb3JzIGFycmF5IGlzIGVtcHR5IG9yIGludmFsaWQuJyxcblx0XHRcdFx0XHQncGFsZXR0ZSA+IG1haW4gPiBnZW5QYWxldHRlKCknXG5cdFx0XHRcdCk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS5pbmZvICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMClcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHRgQ29sb3JzIGFycmF5IGdlbmVyYXRlZDogJHtKU09OLnN0cmluZ2lmeShwYWxldHRlLml0ZW1zKX1gLFxuXHRcdFx0XHQncGFsZXR0ZSA+IG1haW4gPiBnZW5QYWxldHRlKCknXG5cdFx0XHQpO1xuXG5cdFx0Y29uc3QgdGFibGVJZCA9IGF3YWl0IGlkYi5nZXROZXh0VGFibGVJRCgpO1xuXG5cdFx0aWYgKCF0YWJsZUlkKSB0aHJvdyBuZXcgRXJyb3IoJ1RhYmxlIElEIGlzIG51bGwgb3IgdW5kZWZpbmVkLicpO1xuXG5cdFx0YXdhaXQgZ2VuUGFsZXR0ZURPTUJveChwYWxldHRlLml0ZW1zLCBzd2F0Y2hlcywgdGFibGVJZCk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBzdGFydGluZyBwYWxldHRlIGdlbmVyYXRpb246ICR7ZXJyb3J9YCxcblx0XHRcdFx0J3BhbGV0dGUgPiBtYWluID4gZ2VuUGFsZXR0ZSgpJ1xuXHRcdFx0KTtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZW5QYWxldHRlRE9NQm94KFxuXHRpdGVtczogUGFsZXR0ZUl0ZW1bXSxcblx0bnVtQm94ZXM6IG51bWJlcixcblx0dGFibGVJZDogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBwYWxldHRlUm93ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhbGV0dGUtcm93Jyk7XG5cdFx0Y29uc3QgaWRiTWFuYWdlciA9IGF3YWl0IElEQk1hbmFnZXIuZ2V0SW5zdGFuY2UoKTtcblxuXHRcdGlmICghcGFsZXR0ZVJvdykge1xuXHRcdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0XHQncGFsZXR0ZVJvdyBpcyB1bmRlZmluZWQuJyxcblx0XHRcdFx0XHQncGFsZXR0ZSA+IG1haW4gPiBnZW5QYWxldHRlRE9NQm94KCknXG5cdFx0XHRcdCk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRwYWxldHRlUm93LmlubmVySFRNTCA9ICcnO1xuXG5cdFx0Y29uc3QgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWluKGl0ZW1zLmxlbmd0aCwgbnVtQm94ZXMpOyBpKyspIHtcblx0XHRcdGNvbnN0IGl0ZW0gPSBpdGVtc1tpXTtcblx0XHRcdGNvbnN0IGNvbG9yOiBIU0wgPSB7IHZhbHVlOiBpdGVtLmNvbG9ycy5oc2wsIGZvcm1hdDogJ2hzbCcgfTtcblx0XHRcdGNvbnN0IHsgY29sb3JTdHJpcGUgfSA9IGF3YWl0IGhlbHBlcnMuZG9tLm1ha2VQYWxldHRlQm94KFxuXHRcdFx0XHRjb2xvcixcblx0XHRcdFx0aSArIDFcblx0XHRcdCk7XG5cblx0XHRcdGZyYWdtZW50LmFwcGVuZENoaWxkKGNvbG9yU3RyaXBlKTtcblxuXHRcdFx0dXRpbHMucGFsZXR0ZS5wb3B1bGF0ZU91dHB1dEJveChjb2xvciwgaSArIDEpO1xuXHRcdH1cblxuXHRcdHBhbGV0dGVSb3cuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpO1xuXG5cdFx0aWYgKCFtb2RlLnF1aWV0ICYmIGxvZ01vZGUuaW5mbyAmJiBsb2dNb2RlLnZlcmJvc2l0eSA+IDEpXG5cdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0J1BhbGV0dGUgYm94ZXMgZ2VuZXJhdGVkIGFuZCByZW5kZXJlZC4nLFxuXHRcdFx0XHQncGFsZXR0ZSA+IG1haW4gPiBnZW5QYWxldHRlRE9NQm94KCknXG5cdFx0XHQpO1xuXG5cdFx0YXdhaXQgaWRiTWFuYWdlci5zYXZlRGF0YSgndGFibGVzJywgdGFibGVJZCwgeyBwYWxldHRlOiBpdGVtcyB9KTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRpZiAobG9nTW9kZS5lcnJvcilcblx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0YEVycm9yIGdlbmVyYXRpbmcgcGFsZXR0ZSBib3g6ICR7ZXJyb3J9YCxcblx0XHRcdFx0J3BhbGV0dGUgPiBtYWluID4gZ2VuUGFsZXR0ZURPTUJveCgpJ1xuXHRcdFx0KTtcblx0fVxufVxuXG5leHBvcnQgY29uc3Qgc3RhcnQgPSB7XG5cdGdlblBhbGV0dGUsXG5cdGdlblBhbGV0dGVET01Cb3hcbn0gYXMgY29uc3Q7XG5cbi8vICoqKioqKioqIEdFTkVSQVRFICoqKioqKioqXG5cbmZ1bmN0aW9uIGxpbWl0ZWRIU0woXG5cdGJhc2VIdWU6IG51bWJlcixcblx0bGltaXREYXJrOiBib29sZWFuLFxuXHRsaW1pdEdyYXk6IGJvb2xlYW4sXG5cdGxpbWl0TGlnaHQ6IGJvb2xlYW4sXG5cdGFscGhhVmFsdWU6IG51bWJlciB8IG51bGxcbik6IEhTTCB7XG5cdGxldCBoc2w6IEhTTDtcblxuXHRkbyB7XG5cdFx0aHNsID0ge1xuXHRcdFx0dmFsdWU6IHtcblx0XHRcdFx0aHVlOiBjb3JlLmJyYW5kLmFzUmFkaWFsKGJhc2VIdWUpLFxuXHRcdFx0XHRzYXR1cmF0aW9uOiBjb3JlLmJyYW5kLmFzUGVyY2VudGlsZShNYXRoLnJhbmRvbSgpICogMTAwKSxcblx0XHRcdFx0bGlnaHRuZXNzOiBjb3JlLmJyYW5kLmFzUGVyY2VudGlsZShNYXRoLnJhbmRvbSgpICogMTAwKSxcblx0XHRcdFx0YWxwaGE6IGFscGhhVmFsdWVcblx0XHRcdFx0XHQ/IGNvcmUuYnJhbmQuYXNBbHBoYVJhbmdlKGFscGhhVmFsdWUpXG5cdFx0XHRcdFx0OiBjb3JlLmJyYW5kLmFzQWxwaGFSYW5nZSgxKVxuXHRcdFx0fSxcblx0XHRcdGZvcm1hdDogJ2hzbCdcblx0XHR9O1xuXHR9IHdoaWxlIChcblx0XHQobGltaXRHcmF5ICYmIGlzVG9vR3JheShoc2wpKSB8fFxuXHRcdChsaW1pdERhcmsgJiYgaXNUb29EYXJrKGhzbCkpIHx8XG5cdFx0KGxpbWl0TGlnaHQgJiYgaXNUb29MaWdodChoc2wpKVxuXHQpO1xuXG5cdHJldHVybiBoc2w7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlbGVjdGVkUGFsZXR0ZShvcHRpb25zOiBQYWxldHRlT3B0aW9ucyk6IFByb21pc2U8UGFsZXR0ZT4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IHsgY3VzdG9tQ29sb3IsIGZsYWdzLCBzd2F0Y2hlcywgdHlwZSB9ID0gb3B0aW9ucztcblxuXHRcdGNvbnN0IGFyZ3M6IEdlblBhbGV0dGVBcmdzID0ge1xuXHRcdFx0c3dhdGNoZXMsXG5cdFx0XHRjdXN0b21Db2xvcixcblx0XHRcdGVuYWJsZUFscGhhOiBmbGFncy5lbmFibGVBbHBoYSxcblx0XHRcdGxpbWl0RGFyazogZmxhZ3MubGltaXREYXJrbmVzcyxcblx0XHRcdGxpbWl0R3JheTogZmxhZ3MubGltaXRHcmF5bmVzcyxcblx0XHRcdGxpbWl0TGlnaHQ6IGZsYWdzLmxpbWl0TGlnaHRuZXNzXG5cdFx0fTtcblxuXHRcdHN3aXRjaCAodHlwZSkge1xuXHRcdFx0Y2FzZSAxOlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUucmFuZG9tKGFyZ3MpO1xuXHRcdFx0Y2FzZSAyOlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUuY29tcGxlbWVudGFyeShhcmdzKTtcblx0XHRcdGNhc2UgMzpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLnRyaWFkaWMoYXJncyk7XG5cdFx0XHRjYXNlIDQ6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS50ZXRyYWRpYyhhcmdzKTtcblx0XHRcdGNhc2UgNTpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLnNwbGl0Q29tcGxlbWVudGFyeShhcmdzKTtcblx0XHRcdGNhc2UgNjpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLmFuYWxvZ291cyhhcmdzKTtcblx0XHRcdGNhc2UgNzpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLmhleGFkaWMoYXJncyk7XG5cdFx0XHRjYXNlIDg6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5kaWFkaWMoYXJncyk7XG5cdFx0XHRjYXNlIDk6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5tb25vY2hyb21hdGljKGFyZ3MpO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRcdFx0bG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRcdFx0J0ludmFsaWQgcGFsZXR0ZSB0eXBlLicsXG5cdFx0XHRcdFx0XHQncGFsZXR0ZSA+IG1haW4gPiBzZWxlY3RlZFBhbGV0dGUoKSdcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoZGVmYXVsdEJyYW5kZWRQYWxldGUpO1xuXHRcdH1cblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRpZiAobG9nTW9kZS5lcnJvcilcblx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0YEVycm9yIGdlbmVyYXRpbmcgcGFsZXR0ZTogJHtlcnJvcn1gLFxuXHRcdFx0XHQncGFsZXR0ZSA+IG1haW4gPiBzZWxlY3RlZFBhbGV0dGUoKSdcblx0XHRcdCk7XG5cblx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRlZmF1bHRCcmFuZGVkUGFsZXRlKTtcblx0fVxufVxuXG5leHBvcnQgY29uc3QgZ2VuZXJhdGUgPSB7XG5cdGxpbWl0ZWRIU0wsXG5cdHNlbGVjdGVkUGFsZXR0ZVxufSBhcyBjb25zdDtcbiJdfQ==