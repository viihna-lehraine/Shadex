// File: palette/main.js
import { IDBManager } from '../db/IDBManager.js';
import { UIManager } from '../ui/UIManager.js';
import { coreUtils, helpers, transformUtils, utils } from '../common/index.js';
import { createLogger } from '../logger/index.js';
import { defaultData as defaults } from '../data/defaults.js';
import { genPalette as genPaletteType } from './main/index.js';
import { helpers as paletteHelpers } from './common/index.js';
import { modeData as mode } from '../data/mode.js';
const defaultPalette = defaults.palette.unbranded.data;
const defaultBrandedPalete = transformUtils.brandPalette(defaultPalette);
const limits = paletteHelpers.limits;
const logMode = mode.logging;
const thisModule = 'palette/main.js';
const logger = await createLogger();
const isTooDark = limits.isTooDark;
const isTooGray = limits.isTooGray;
const isTooLight = limits.isTooLight;
async function paletteGeneration(options) {
    const thisFunction = 'paletteGeneration()';
    try {
        let { swatches, customColor } = options;
        if (logMode.info && logMode.verbosity > 2)
            logger.info('Retrieving existing IDBManager instance.', `${thisModule} > ${thisFunction}`);
        const idb = await IDBManager.getInstance();
        if (customColor === null || customColor === undefined) {
            if (logMode.error)
                logger.error('Custom color is null or undefined.', `${thisModule} > ${thisFunction}`);
            return;
        }
        const validatedCustomColor = (await helpers.dom.validateAndConvertColor(customColor)) ??
            utils.random.hsl();
        options.customColor = validatedCustomColor;
        if (!customColor) {
            logger.error('Custom color is null or undefined.', `${thisModule} > ${thisFunction}`);
            return;
        }
        if (mode.debug && logMode.info && logMode.verbosity > 2) {
            logger.info(`Validated custom color: ${JSON.stringify(customColor)}`, `${thisModule} > ${thisFunction}`);
        }
        const palette = await generate.selectedPalette(options);
        if (palette.items.length === 0) {
            if (logMode.error)
                logger.error('Colors array is empty or invalid.', `${thisModule} > ${thisFunction}`);
            return;
        }
        if (!mode.quiet && logMode.info && logMode.verbosity > 0)
            logger.info(`Colors array generated: ${JSON.stringify(palette.items)}`, `${thisModule} > ${thisFunction}`);
        const tableId = await idb.getNextTableID();
        if (!tableId)
            throw new Error('Table ID is null or undefined.');
        const uiManager = new UIManager();
        uiManager.addPaletteToHistory(palette);
        await paletteDomBoxGeneration(palette.items, swatches, tableId);
    }
    catch (error) {
        if (logMode.error)
            logger.error(`Error starting palette generation: ${error}`, `${thisModule} > ${thisFunction}`);
    }
}
async function paletteDomBoxGeneration(items, numBoxes, tableId) {
    const thisFunction = 'paletteDomBoxGeneration()';
    try {
        const paletteRow = document.getElementById('palette-row');
        const idbManager = await IDBManager.getInstance();
        if (!paletteRow) {
            if (logMode.error)
                logger.error('paletteRow is undefined.', `${thisModule} > ${thisFunction}`);
            return;
        }
        paletteRow.innerHTML = '';
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < Math.min(items.length, numBoxes); i++) {
            const item = items[i];
            const color = { value: item.colors.main.hsl, format: 'hsl' };
            const { colorStripe } = await helpers.dom.makePaletteBox(color, i + 1);
            fragment.appendChild(colorStripe);
            utils.palette.populateOutputBox(color, i + 1);
        }
        paletteRow.appendChild(fragment);
        if (!mode.quiet && logMode.info && logMode.verbosity > 1)
            logger.info('Palette boxes generated and rendered.', `${thisModule} > ${thisFunction}`);
        await idbManager.saveData('tables', tableId, { palette: items });
    }
    catch (error) {
        if (logMode.error)
            logger.error(`Error generating palette box: ${error}`, `${thisModule} > ${thisFunction}`);
    }
}
export const start = {
    paletteDomBoxGeneration,
    paletteGeneration
};
// ******** GENERATE ********
function limitedHSL(baseHue, limitDark, limitGray, limitLight) {
    let hsl;
    do {
        hsl = {
            value: {
                hue: coreUtils.brand.asRadial(baseHue),
                saturation: coreUtils.brand.asPercentile(Math.random() * 100),
                lightness: coreUtils.brand.asPercentile(Math.random() * 100)
            },
            format: 'hsl'
        };
    } while ((limitGray && isTooGray(hsl)) ||
        (limitDark && isTooDark(hsl)) ||
        (limitLight && isTooLight(hsl)));
    return hsl;
}
async function selectedPalette(options) {
    const thisFunction = 'selectedPalette()';
    try {
        const { customColor, flags, swatches, type } = options;
        const args = {
            swatches,
            type,
            customColor,
            limitDark: flags.limitDark,
            limitGray: flags.limitGray,
            limitLight: flags.limitLight
        };
        if (!mode.quiet && logMode.debug && logMode.verbosity > 2) {
            logger.debug(`Generating palette with type #: ${type}`, `${thisModule} > ${thisFunction}`);
        }
        switch (type) {
            case 1:
                return genPaletteType.random(args);
            case 2:
                return genPaletteType.complementary(args);
            case 3:
                return genPaletteType.triadic(args);
            case 4:
                return genPaletteType.tetradic(args);
            case 5:
                return genPaletteType.splitComplementary(args);
            case 6:
                return genPaletteType.analogous(args);
            case 7:
                return genPaletteType.hexadic(args);
            case 8:
                return genPaletteType.diadic(args);
            case 9:
                return genPaletteType.monochromatic(args);
            default:
                if (logMode.error)
                    logger.error('Invalid palette type.', `${thisModule} > ${thisFunction}`);
                return Promise.resolve(defaultBrandedPalete);
        }
    }
    catch (error) {
        if (logMode.error)
            logger.error(`Error generating palette: ${error}`, `${thisModule} > ${thisFunction}`);
        return Promise.resolve(defaultBrandedPalete);
    }
}
export const generate = {
    limitedHSL,
    selectedPalette
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYWxldHRlL21haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsd0JBQXdCO0FBVXhCLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQy9FLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsV0FBVyxJQUFJLFFBQVEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlELE9BQU8sRUFBRSxVQUFVLElBQUksY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0QsT0FBTyxFQUFFLE9BQU8sSUFBSSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsUUFBUSxJQUFJLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRW5ELE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztBQUN2RCxNQUFNLG9CQUFvQixHQUFHLGNBQWMsQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLENBQUM7QUFFekUsTUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQztBQUNyQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO0FBQzdCLE1BQU0sVUFBVSxHQUFHLGlCQUFpQixDQUFDO0FBRXJDLE1BQU0sTUFBTSxHQUFHLE1BQU0sWUFBWSxFQUFFLENBQUM7QUFFcEMsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQztBQUNuQyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO0FBQ25D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QUFRLEdBQTBDO0lBQzlELFVBQVU7SUFDVixlQUFlO0NBQ04sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IHBhbGV0dGUvbWFpbi5qc1xuXG5pbXBvcnQge1xuXHRIU0wsXG5cdFBhbGV0dGUsXG5cdFBhbGV0dGVGbl9NYXN0ZXJJbnRlcmZhY2UsXG5cdFBhbGV0dGVHZW5lcmF0aW9uQXJncyxcblx0UGFsZXR0ZUl0ZW0sXG5cdFBhbGV0dGVPcHRpb25zXG59IGZyb20gJy4uL3R5cGVzL2luZGV4LmpzJztcbmltcG9ydCB7IElEQk1hbmFnZXIgfSBmcm9tICcuLi9kYi9JREJNYW5hZ2VyLmpzJztcbmltcG9ydCB7IFVJTWFuYWdlciB9IGZyb20gJy4uL3VpL1VJTWFuYWdlci5qcyc7XG5pbXBvcnQgeyBjb3JlVXRpbHMsIGhlbHBlcnMsIHRyYW5zZm9ybVV0aWxzLCB1dGlscyB9IGZyb20gJy4uL2NvbW1vbi9pbmRleC5qcyc7XG5pbXBvcnQgeyBjcmVhdGVMb2dnZXIgfSBmcm9tICcuLi9sb2dnZXIvaW5kZXguanMnO1xuaW1wb3J0IHsgZGVmYXVsdERhdGEgYXMgZGVmYXVsdHMgfSBmcm9tICcuLi9kYXRhL2RlZmF1bHRzLmpzJztcbmltcG9ydCB7IGdlblBhbGV0dGUgYXMgZ2VuUGFsZXR0ZVR5cGUgfSBmcm9tICcuL21haW4vaW5kZXguanMnO1xuaW1wb3J0IHsgaGVscGVycyBhcyBwYWxldHRlSGVscGVycyB9IGZyb20gJy4vY29tbW9uL2luZGV4LmpzJztcbmltcG9ydCB7IG1vZGVEYXRhIGFzIG1vZGUgfSBmcm9tICcuLi9kYXRhL21vZGUuanMnO1xuXG5jb25zdCBkZWZhdWx0UGFsZXR0ZSA9IGRlZmF1bHRzLnBhbGV0dGUudW5icmFuZGVkLmRhdGE7XG5jb25zdCBkZWZhdWx0QnJhbmRlZFBhbGV0ZSA9IHRyYW5zZm9ybVV0aWxzLmJyYW5kUGFsZXR0ZShkZWZhdWx0UGFsZXR0ZSk7XG5cbmNvbnN0IGxpbWl0cyA9IHBhbGV0dGVIZWxwZXJzLmxpbWl0cztcbmNvbnN0IGxvZ01vZGUgPSBtb2RlLmxvZ2dpbmc7XG5jb25zdCB0aGlzTW9kdWxlID0gJ3BhbGV0dGUvbWFpbi5qcyc7XG5cbmNvbnN0IGxvZ2dlciA9IGF3YWl0IGNyZWF0ZUxvZ2dlcigpO1xuXG5jb25zdCBpc1Rvb0RhcmsgPSBsaW1pdHMuaXNUb29EYXJrO1xuY29uc3QgaXNUb29HcmF5ID0gbGltaXRzLmlzVG9vR3JheTtcbmNvbnN0IGlzVG9vTGlnaHQgPSBsaW1pdHMuaXNUb29MaWdodDtcblxuYXN5bmMgZnVuY3Rpb24gcGFsZXR0ZUdlbmVyYXRpb24ob3B0aW9uczogUGFsZXR0ZU9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcblx0Y29uc3QgdGhpc0Z1bmN0aW9uID0gJ3BhbGV0dGVHZW5lcmF0aW9uKCknO1xuXG5cdHRyeSB7XG5cdFx0bGV0IHsgc3dhdGNoZXMsIGN1c3RvbUNvbG9yIH0gPSBvcHRpb25zO1xuXG5cdFx0aWYgKGxvZ01vZGUuaW5mbyAmJiBsb2dNb2RlLnZlcmJvc2l0eSA+IDIpXG5cdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0J1JldHJpZXZpbmcgZXhpc3RpbmcgSURCTWFuYWdlciBpbnN0YW5jZS4nLFxuXHRcdFx0XHRgJHt0aGlzTW9kdWxlfSA+ICR7dGhpc0Z1bmN0aW9ufWBcblx0XHRcdCk7XG5cblx0XHRjb25zdCBpZGIgPSBhd2FpdCBJREJNYW5hZ2VyLmdldEluc3RhbmNlKCk7XG5cblx0XHRpZiAoY3VzdG9tQ29sb3IgPT09IG51bGwgfHwgY3VzdG9tQ29sb3IgPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0XHQnQ3VzdG9tIGNvbG9yIGlzIG51bGwgb3IgdW5kZWZpbmVkLicsXG5cdFx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHRcdCk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCB2YWxpZGF0ZWRDdXN0b21Db2xvcjogSFNMID1cblx0XHRcdCgoYXdhaXQgaGVscGVycy5kb20udmFsaWRhdGVBbmRDb252ZXJ0Q29sb3IoY3VzdG9tQ29sb3IpKSBhcyBIU0wpID8/XG5cdFx0XHR1dGlscy5yYW5kb20uaHNsKCk7XG5cblx0XHRvcHRpb25zLmN1c3RvbUNvbG9yID0gdmFsaWRhdGVkQ3VzdG9tQ29sb3I7XG5cblx0XHRpZiAoIWN1c3RvbUNvbG9yKSB7XG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdCdDdXN0b20gY29sb3IgaXMgbnVsbCBvciB1bmRlZmluZWQuJyxcblx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRpZiAobW9kZS5kZWJ1ZyAmJiBsb2dNb2RlLmluZm8gJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAyKSB7XG5cdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0YFZhbGlkYXRlZCBjdXN0b20gY29sb3I6ICR7SlNPTi5zdHJpbmdpZnkoY3VzdG9tQ29sb3IpfWAsXG5cdFx0XHRcdGAke3RoaXNNb2R1bGV9ID4gJHt0aGlzRnVuY3Rpb259YFxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRjb25zdCBwYWxldHRlID0gYXdhaXQgZ2VuZXJhdGUuc2VsZWN0ZWRQYWxldHRlKG9wdGlvbnMpO1xuXG5cdFx0aWYgKHBhbGV0dGUuaXRlbXMubGVuZ3RoID09PSAwKSB7XG5cdFx0XHRpZiAobG9nTW9kZS5lcnJvcilcblx0XHRcdFx0bG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRcdCdDb2xvcnMgYXJyYXkgaXMgZW1wdHkgb3IgaW52YWxpZC4nLFxuXHRcdFx0XHRcdGAke3RoaXNNb2R1bGV9ID4gJHt0aGlzRnVuY3Rpb259YFxuXHRcdFx0XHQpO1xuXG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKCFtb2RlLnF1aWV0ICYmIGxvZ01vZGUuaW5mbyAmJiBsb2dNb2RlLnZlcmJvc2l0eSA+IDApXG5cdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0YENvbG9ycyBhcnJheSBnZW5lcmF0ZWQ6ICR7SlNPTi5zdHJpbmdpZnkocGFsZXR0ZS5pdGVtcyl9YCxcblx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHQpO1xuXG5cdFx0Y29uc3QgdGFibGVJZCA9IGF3YWl0IGlkYi5nZXROZXh0VGFibGVJRCgpO1xuXG5cdFx0aWYgKCF0YWJsZUlkKSB0aHJvdyBuZXcgRXJyb3IoJ1RhYmxlIElEIGlzIG51bGwgb3IgdW5kZWZpbmVkLicpO1xuXG5cdFx0Y29uc3QgdWlNYW5hZ2VyID0gbmV3IFVJTWFuYWdlcigpO1xuXG5cdFx0dWlNYW5hZ2VyLmFkZFBhbGV0dGVUb0hpc3RvcnkocGFsZXR0ZSk7XG5cblx0XHRhd2FpdCBwYWxldHRlRG9tQm94R2VuZXJhdGlvbihwYWxldHRlLml0ZW1zLCBzd2F0Y2hlcywgdGFibGVJZCk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBzdGFydGluZyBwYWxldHRlIGdlbmVyYXRpb246ICR7ZXJyb3J9YCxcblx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHQpO1xuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhbGV0dGVEb21Cb3hHZW5lcmF0aW9uKFxuXHRpdGVtczogUGFsZXR0ZUl0ZW1bXSxcblx0bnVtQm94ZXM6IG51bWJlcixcblx0dGFibGVJZDogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+IHtcblx0Y29uc3QgdGhpc0Z1bmN0aW9uID0gJ3BhbGV0dGVEb21Cb3hHZW5lcmF0aW9uKCknO1xuXG5cdHRyeSB7XG5cdFx0Y29uc3QgcGFsZXR0ZVJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYWxldHRlLXJvdycpO1xuXHRcdGNvbnN0IGlkYk1hbmFnZXIgPSBhd2FpdCBJREJNYW5hZ2VyLmdldEluc3RhbmNlKCk7XG5cblx0XHRpZiAoIXBhbGV0dGVSb3cpIHtcblx0XHRcdGlmIChsb2dNb2RlLmVycm9yKVxuXHRcdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdFx0J3BhbGV0dGVSb3cgaXMgdW5kZWZpbmVkLicsXG5cdFx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHRcdCk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRwYWxldHRlUm93LmlubmVySFRNTCA9ICcnO1xuXG5cdFx0Y29uc3QgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWluKGl0ZW1zLmxlbmd0aCwgbnVtQm94ZXMpOyBpKyspIHtcblx0XHRcdGNvbnN0IGl0ZW0gPSBpdGVtc1tpXTtcblx0XHRcdGNvbnN0IGNvbG9yOiBIU0wgPSB7IHZhbHVlOiBpdGVtLmNvbG9ycy5tYWluLmhzbCwgZm9ybWF0OiAnaHNsJyB9O1xuXHRcdFx0Y29uc3QgeyBjb2xvclN0cmlwZSB9ID0gYXdhaXQgaGVscGVycy5kb20ubWFrZVBhbGV0dGVCb3goXG5cdFx0XHRcdGNvbG9yLFxuXHRcdFx0XHRpICsgMVxuXHRcdFx0KTtcblxuXHRcdFx0ZnJhZ21lbnQuYXBwZW5kQ2hpbGQoY29sb3JTdHJpcGUpO1xuXG5cdFx0XHR1dGlscy5wYWxldHRlLnBvcHVsYXRlT3V0cHV0Qm94KGNvbG9yLCBpICsgMSk7XG5cdFx0fVxuXG5cdFx0cGFsZXR0ZVJvdy5hcHBlbmRDaGlsZChmcmFnbWVudCk7XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS5pbmZvICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMSlcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnUGFsZXR0ZSBib3hlcyBnZW5lcmF0ZWQgYW5kIHJlbmRlcmVkLicsXG5cdFx0XHRcdGAke3RoaXNNb2R1bGV9ID4gJHt0aGlzRnVuY3Rpb259YFxuXHRcdFx0KTtcblxuXHRcdGF3YWl0IGlkYk1hbmFnZXIuc2F2ZURhdGEoJ3RhYmxlcycsIHRhYmxlSWQsIHsgcGFsZXR0ZTogaXRlbXMgfSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBnZW5lcmF0aW5nIHBhbGV0dGUgYm94OiAke2Vycm9yfWAsXG5cdFx0XHRcdGAke3RoaXNNb2R1bGV9ID4gJHt0aGlzRnVuY3Rpb259YFxuXHRcdFx0KTtcblx0fVxufVxuXG5leHBvcnQgY29uc3Qgc3RhcnQ6IFBhbGV0dGVGbl9NYXN0ZXJJbnRlcmZhY2VbJ3N0YXJ0J10gPSB7XG5cdHBhbGV0dGVEb21Cb3hHZW5lcmF0aW9uLFxuXHRwYWxldHRlR2VuZXJhdGlvblxufSBhcyBjb25zdDtcblxuLy8gKioqKioqKiogR0VORVJBVEUgKioqKioqKipcblxuZnVuY3Rpb24gbGltaXRlZEhTTChcblx0YmFzZUh1ZTogbnVtYmVyLFxuXHRsaW1pdERhcms6IGJvb2xlYW4sXG5cdGxpbWl0R3JheTogYm9vbGVhbixcblx0bGltaXRMaWdodDogYm9vbGVhblxuKTogSFNMIHtcblx0bGV0IGhzbDogSFNMO1xuXG5cdGRvIHtcblx0XHRoc2wgPSB7XG5cdFx0XHR2YWx1ZToge1xuXHRcdFx0XHRodWU6IGNvcmVVdGlscy5icmFuZC5hc1JhZGlhbChiYXNlSHVlKSxcblx0XHRcdFx0c2F0dXJhdGlvbjogY29yZVV0aWxzLmJyYW5kLmFzUGVyY2VudGlsZShNYXRoLnJhbmRvbSgpICogMTAwKSxcblx0XHRcdFx0bGlnaHRuZXNzOiBjb3JlVXRpbHMuYnJhbmQuYXNQZXJjZW50aWxlKE1hdGgucmFuZG9tKCkgKiAxMDApXG5cdFx0XHR9LFxuXHRcdFx0Zm9ybWF0OiAnaHNsJ1xuXHRcdH07XG5cdH0gd2hpbGUgKFxuXHRcdChsaW1pdEdyYXkgJiYgaXNUb29HcmF5KGhzbCkpIHx8XG5cdFx0KGxpbWl0RGFyayAmJiBpc1Rvb0RhcmsoaHNsKSkgfHxcblx0XHQobGltaXRMaWdodCAmJiBpc1Rvb0xpZ2h0KGhzbCkpXG5cdCk7XG5cblx0cmV0dXJuIGhzbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VsZWN0ZWRQYWxldHRlKG9wdGlvbnM6IFBhbGV0dGVPcHRpb25zKTogUHJvbWlzZTxQYWxldHRlPiB7XG5cdGNvbnN0IHRoaXNGdW5jdGlvbiA9ICdzZWxlY3RlZFBhbGV0dGUoKSc7XG5cblx0dHJ5IHtcblx0XHRjb25zdCB7IGN1c3RvbUNvbG9yLCBmbGFncywgc3dhdGNoZXMsIHR5cGUgfSA9IG9wdGlvbnM7XG5cblx0XHRjb25zdCBhcmdzOiBQYWxldHRlR2VuZXJhdGlvbkFyZ3MgPSB7XG5cdFx0XHRzd2F0Y2hlcyxcblx0XHRcdHR5cGUsXG5cdFx0XHRjdXN0b21Db2xvcixcblx0XHRcdGxpbWl0RGFyazogZmxhZ3MubGltaXREYXJrLFxuXHRcdFx0bGltaXRHcmF5OiBmbGFncy5saW1pdEdyYXksXG5cdFx0XHRsaW1pdExpZ2h0OiBmbGFncy5saW1pdExpZ2h0XG5cdFx0fTtcblxuXHRcdGlmICghbW9kZS5xdWlldCAmJiBsb2dNb2RlLmRlYnVnICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMikge1xuXHRcdFx0bG9nZ2VyLmRlYnVnKFxuXHRcdFx0XHRgR2VuZXJhdGluZyBwYWxldHRlIHdpdGggdHlwZSAjOiAke3R5cGV9YCxcblx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdHN3aXRjaCAodHlwZSkge1xuXHRcdFx0Y2FzZSAxOlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUucmFuZG9tKGFyZ3MpO1xuXHRcdFx0Y2FzZSAyOlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUuY29tcGxlbWVudGFyeShhcmdzKTtcblx0XHRcdGNhc2UgMzpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLnRyaWFkaWMoYXJncyk7XG5cdFx0XHRjYXNlIDQ6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS50ZXRyYWRpYyhhcmdzKTtcblx0XHRcdGNhc2UgNTpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLnNwbGl0Q29tcGxlbWVudGFyeShhcmdzKTtcblx0XHRcdGNhc2UgNjpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLmFuYWxvZ291cyhhcmdzKTtcblx0XHRcdGNhc2UgNzpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLmhleGFkaWMoYXJncyk7XG5cdFx0XHRjYXNlIDg6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5kaWFkaWMoYXJncyk7XG5cdFx0XHRjYXNlIDk6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5tb25vY2hyb21hdGljKGFyZ3MpO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRcdFx0bG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRcdFx0J0ludmFsaWQgcGFsZXR0ZSB0eXBlLicsXG5cdFx0XHRcdFx0XHRgJHt0aGlzTW9kdWxlfSA+ICR7dGhpc0Z1bmN0aW9ufWBcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoZGVmYXVsdEJyYW5kZWRQYWxldGUpO1xuXHRcdH1cblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRpZiAobG9nTW9kZS5lcnJvcilcblx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0YEVycm9yIGdlbmVyYXRpbmcgcGFsZXR0ZTogJHtlcnJvcn1gLFxuXHRcdFx0XHRgJHt0aGlzTW9kdWxlfSA+ICR7dGhpc0Z1bmN0aW9ufWBcblx0XHRcdCk7XG5cblx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRlZmF1bHRCcmFuZGVkUGFsZXRlKTtcblx0fVxufVxuXG5leHBvcnQgY29uc3QgZ2VuZXJhdGU6IFBhbGV0dGVGbl9NYXN0ZXJJbnRlcmZhY2VbJ2dlbmVyYXRlJ10gPSB7XG5cdGxpbWl0ZWRIU0wsXG5cdHNlbGVjdGVkUGFsZXR0ZVxufSBhcyBjb25zdDtcbiJdfQ==