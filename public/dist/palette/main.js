// File: palette/main.js
import { IDBManager } from '../db/index.js';
import { coreUtils, helpers, transformUtils, utils } from '../common/index.js';
import { createLogger } from '../logger/index.js';
import { defaultData as defaults } from '../data/defaults.js';
import { genPalette as genPaletteType } from './main/index.js';
import { helpers as paletteHelpers } from './common/index.js';
import { modeData as mode } from '../data/mode.js';
const defaultPalette = defaults.palette.unbranded.data;
const defaultBrandedPalete = transformUtils.brandPalette(defaultPalette);
const limits = paletteHelpers.limits;
const logMode = mode.logging;
const thisModule = 'palette/main.js';
const logger = await createLogger();
const isTooDark = limits.isTooDark;
const isTooGray = limits.isTooGray;
const isTooLight = limits.isTooLight;
async function genPalette(options) {
    const thisFunction = 'genPalette()';
    try {
        let { swatches, customColor } = options;
        if (logMode.info && logMode.verbosity > 2)
            logger.info('Retrieving existing IDBManager instance.', `${thisModule} > ${thisFunction}`);
        const idb = await IDBManager.getInstance();
        if (customColor === null || customColor === undefined) {
            if (logMode.error)
                logger.error('Custom color is null or undefined.', `${thisModule} > ${thisFunction}`);
            return;
        }
        const validatedCustomColor = (await helpers.dom.validateAndConvertColor(customColor)) ??
            utils.random.hsl(options.flags.enableAlpha);
        if (mode.debug && logMode.info && logMode.verbosity > 2)
            logger.info(`Custom color: ${JSON.stringify(customColor)}`, `${thisModule} > ${thisFunction}`);
        options.customColor = validatedCustomColor;
        const palette = await generate.selectedPalette(options);
        if (palette.items.length === 0) {
            if (logMode.error)
                logger.error('Colors array is empty or invalid.', `${thisModule} > ${thisFunction}`);
            return;
        }
        if (!mode.quiet && logMode.info && logMode.verbosity > 0)
            logger.info(`Colors array generated: ${JSON.stringify(palette.items)}`, `${thisModule} > ${thisFunction}`);
        const tableId = await idb.getNextTableID();
        if (!tableId)
            throw new Error('Table ID is null or undefined.');
        await genPaletteDOMBox(palette.items, swatches, tableId);
    }
    catch (error) {
        if (logMode.error)
            logger.error(`Error starting palette generation: ${error}`, `${thisModule} > ${thisFunction}`);
    }
}
async function genPaletteDOMBox(items, numBoxes, tableId) {
    const thisFunction = 'genPaletteDOMBox()';
    try {
        const paletteRow = document.getElementById('palette-row');
        const idbManager = await IDBManager.getInstance();
        if (!paletteRow) {
            if (logMode.error)
                logger.error('paletteRow is undefined.', `${thisModule} > ${thisFunction}`);
            return;
        }
        paletteRow.innerHTML = '';
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < Math.min(items.length, numBoxes); i++) {
            const item = items[i];
            const color = { value: item.colors.main.hsl, format: 'hsl' };
            const { colorStripe } = await helpers.dom.makePaletteBox(color, i + 1);
            fragment.appendChild(colorStripe);
            utils.palette.populateOutputBox(color, i + 1);
        }
        paletteRow.appendChild(fragment);
        if (!mode.quiet && logMode.info && logMode.verbosity > 1)
            logger.info('Palette boxes generated and rendered.', `${thisModule} > ${thisFunction}`);
        await idbManager.saveData('tables', tableId, { palette: items });
    }
    catch (error) {
        if (logMode.error)
            logger.error(`Error generating palette box: ${error}`, `${thisModule} > ${thisFunction}`);
    }
}
export const start = {
    genPalette,
    genPaletteDOMBox
};
// ******** GENERATE ********
function limitedHSL(baseHue, limitDark, limitGray, limitLight, alphaValue) {
    let hsl;
    do {
        hsl = {
            value: {
                hue: coreUtils.brand.asRadial(baseHue),
                saturation: coreUtils.brand.asPercentile(Math.random() * 100),
                lightness: coreUtils.brand.asPercentile(Math.random() * 100),
                alpha: alphaValue
                    ? coreUtils.brand.asAlphaRange(alphaValue)
                    : coreUtils.brand.asAlphaRange(1)
            },
            format: 'hsl'
        };
    } while ((limitGray && isTooGray(hsl)) ||
        (limitDark && isTooDark(hsl)) ||
        (limitLight && isTooLight(hsl)));
    return hsl;
}
async function selectedPalette(options) {
    const thisFunction = 'selectedPalette()';
    try {
        const { customColor, flags, swatches, type } = options;
        const args = {
            swatches,
            type,
            customColor,
            enableAlpha: flags.enableAlpha,
            limitDark: flags.limitDarkness,
            limitGray: flags.limitGrayness,
            limitLight: flags.limitLightness
        };
        if (!mode.quiet && logMode.debug && logMode.verbosity > 2) {
            logger.debug(`Generating palette with type #: ${type}`, `${thisModule} > ${thisFunction}`);
        }
        switch (type) {
            case 1:
                return genPaletteType.random(args);
            case 2:
                return genPaletteType.complementary(args);
            case 3:
                return genPaletteType.triadic(args);
            case 4:
                return genPaletteType.tetradic(args);
            case 5:
                return genPaletteType.splitComplementary(args);
            case 6:
                return genPaletteType.analogous(args);
            case 7:
                return genPaletteType.hexadic(args);
            case 8:
                return genPaletteType.diadic(args);
            case 9:
                return genPaletteType.monochromatic(args);
            default:
                if (logMode.error)
                    logger.error('Invalid palette type.', `${thisModule} > ${thisFunction}`);
                return Promise.resolve(defaultBrandedPalete);
        }
    }
    catch (error) {
        if (logMode.error)
            logger.error(`Error generating palette: ${error}`, `${thisModule} > ${thisFunction}`);
        return Promise.resolve(defaultBrandedPalete);
    }
}
export const generate = {
    limitedHSL,
    selectedPalette
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYWxldHRlL21haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsd0JBQXdCO0FBVXhCLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxXQUFXLElBQUksUUFBUSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFVBQVUsSUFBSSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsT0FBTyxJQUFJLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlELE9BQU8sRUFBRSxRQUFRLElBQUksSUFBSSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFbkQsTUFBTSxjQUFjLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDO0FBQ3ZELE1BQU0sb0JBQW9CLEdBQUcsY0FBYyxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUV6RSxNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDO0FBQ3JDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7QUFDN0IsTUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUM7QUFFckMsTUFBTSxNQUFNLEdBQUcsTUFBTSxZQUFZLEVBQUUsQ0FBQztBQUVwQyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO0FBQ25DLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUM7QUFDbkMsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQztBQUVyQyxL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cGFsZXR0ZS9tYWluLmpzXG5cbmltcG9ydCB7XG5cdEdlblBhbGV0dGVBcmdzLFxuXHRIU0wsXG5cdFBhbGV0dGUsXG5cdFBhbGV0dGVGbl9NYXN0ZXJJbnRlcmZhY2UsXG5cdFBhbGV0dGVJdGVtLFxuXHRQYWxldHRlT3B0aW9uc1xufSBmcm9tICcuLi90eXBlcy9pbmRleC5qcyc7XG5pbXBvcnQgeyBJREJNYW5hZ2VyIH0gZnJvbSAnLi4vZGIvaW5kZXguanMnO1xuaW1wb3J0IHsgY29yZVV0aWxzLCBoZWxwZXJzLCB0cmFuc2Zvcm1VdGlscywgdXRpbHMgfSBmcm9tICcuLi9jb21tb24vaW5kZXguanMnO1xuaW1wb3J0IHsgY3JlYXRlTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyL2luZGV4LmpzJztcbmltcG9ydCB7IGRlZmF1bHREYXRhIGFzIGRlZmF1bHRzIH0gZnJvbSAnLi4vZGF0YS9kZWZhdWx0cy5qcyc7XG5pbXBvcnQgeyBnZW5QYWxldHRlIGFzIGdlblBhbGV0dGVUeXBlIH0gZnJvbSAnLi9tYWluL2luZGV4LmpzJztcbmltcG9ydCB7IGhlbHBlcnMgYXMgcGFsZXR0ZUhlbHBlcnMgfSBmcm9tICcuL2NvbW1vbi9pbmRleC5qcyc7XG5pbXBvcnQgeyBtb2RlRGF0YSBhcyBtb2RlIH0gZnJvbSAnLi4vZGF0YS9tb2RlLmpzJztcblxuY29uc3QgZGVmYXVsdFBhbGV0dGUgPSBkZWZhdWx0cy5wYWxldHRlLnVuYnJhbmRlZC5kYXRhO1xuY29uc3QgZGVmYXVsdEJyYW5kZWRQYWxldGUgPSB0cmFuc2Zvcm1VdGlscy5icmFuZFBhbGV0dGUoZGVmYXVsdFBhbGV0dGUpO1xuXG5jb25zdCBsaW1pdHMgPSBwYWxldHRlSGVscGVycy5saW1pdHM7XG5jb25zdCBsb2dNb2RlID0gbW9kZS5sb2dnaW5nO1xuY29uc3QgdGhpc01vZHVsZSA9ICdwYWxldHRlL21haW4uanMnO1xuXG5jb25zdCBsb2dnZXIgPSBhd2FpdCBjcmVhdGVMb2dnZXIoKTtcblxuY29uc3QgaXNUb29EYXJrID0gbGltaXRzLmlzVG9vRGFyaztcbmNvbnN0IGlzVG9vR3JheSA9IGxpbWl0cy5pc1Rvb0dyYXk7XG5jb25zdCBpc1Rvb0xpZ2h0ID0gbGltaXRzLmlzVG9vTGlnaHQ7XG5cbmFzeW5jIGZ1bmN0aW9uIGdlblBhbGV0dGUob3B0aW9uczogUGFsZXR0ZU9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcblx0Y29uc3QgdGhpc0Z1bmN0aW9uID0gJ2dlblBhbGV0dGUoKSc7XG5cblx0dHJ5IHtcblx0XHRsZXQgeyBzd2F0Y2hlcywgY3VzdG9tQ29sb3IgfSA9IG9wdGlvbnM7XG5cblx0XHRpZiAobG9nTW9kZS5pbmZvICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMilcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnUmV0cmlldmluZyBleGlzdGluZyBJREJNYW5hZ2VyIGluc3RhbmNlLicsXG5cdFx0XHRcdGAke3RoaXNNb2R1bGV9ID4gJHt0aGlzRnVuY3Rpb259YFxuXHRcdFx0KTtcblxuXHRcdGNvbnN0IGlkYiA9IGF3YWl0IElEQk1hbmFnZXIuZ2V0SW5zdGFuY2UoKTtcblxuXHRcdGlmIChjdXN0b21Db2xvciA9PT0gbnVsbCB8fCBjdXN0b21Db2xvciA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRpZiAobG9nTW9kZS5lcnJvcilcblx0XHRcdFx0bG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRcdCdDdXN0b20gY29sb3IgaXMgbnVsbCBvciB1bmRlZmluZWQuJyxcblx0XHRcdFx0XHRgJHt0aGlzTW9kdWxlfSA+ICR7dGhpc0Z1bmN0aW9ufWBcblx0XHRcdFx0KTtcblxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnN0IHZhbGlkYXRlZEN1c3RvbUNvbG9yOiBIU0wgPVxuXHRcdFx0KChhd2FpdCBoZWxwZXJzLmRvbS52YWxpZGF0ZUFuZENvbnZlcnRDb2xvcihjdXN0b21Db2xvcikpIGFzIEhTTCkgPz9cblx0XHRcdHV0aWxzLnJhbmRvbS5oc2wob3B0aW9ucy5mbGFncy5lbmFibGVBbHBoYSk7XG5cblx0XHRpZiAobW9kZS5kZWJ1ZyAmJiBsb2dNb2RlLmluZm8gJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAyKVxuXHRcdFx0bG9nZ2VyLmluZm8oXG5cdFx0XHRcdGBDdXN0b20gY29sb3I6ICR7SlNPTi5zdHJpbmdpZnkoY3VzdG9tQ29sb3IpfWAsXG5cdFx0XHRcdGAke3RoaXNNb2R1bGV9ID4gJHt0aGlzRnVuY3Rpb259YFxuXHRcdFx0KTtcblxuXHRcdG9wdGlvbnMuY3VzdG9tQ29sb3IgPSB2YWxpZGF0ZWRDdXN0b21Db2xvcjtcblxuXHRcdGNvbnN0IHBhbGV0dGUgPSBhd2FpdCBnZW5lcmF0ZS5zZWxlY3RlZFBhbGV0dGUob3B0aW9ucyk7XG5cblx0XHRpZiAocGFsZXR0ZS5pdGVtcy5sZW5ndGggPT09IDApIHtcblx0XHRcdGlmIChsb2dNb2RlLmVycm9yKVxuXHRcdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdFx0J0NvbG9ycyBhcnJheSBpcyBlbXB0eSBvciBpbnZhbGlkLicsXG5cdFx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHRcdCk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS5pbmZvICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMClcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHRgQ29sb3JzIGFycmF5IGdlbmVyYXRlZDogJHtKU09OLnN0cmluZ2lmeShwYWxldHRlLml0ZW1zKX1gLFxuXHRcdFx0XHRgJHt0aGlzTW9kdWxlfSA+ICR7dGhpc0Z1bmN0aW9ufWBcblx0XHRcdCk7XG5cblx0XHRjb25zdCB0YWJsZUlkID0gYXdhaXQgaWRiLmdldE5leHRUYWJsZUlEKCk7XG5cblx0XHRpZiAoIXRhYmxlSWQpIHRocm93IG5ldyBFcnJvcignVGFibGUgSUQgaXMgbnVsbCBvciB1bmRlZmluZWQuJyk7XG5cblx0XHRhd2FpdCBnZW5QYWxldHRlRE9NQm94KHBhbGV0dGUuaXRlbXMsIHN3YXRjaGVzLCB0YWJsZUlkKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRpZiAobG9nTW9kZS5lcnJvcilcblx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0YEVycm9yIHN0YXJ0aW5nIHBhbGV0dGUgZ2VuZXJhdGlvbjogJHtlcnJvcn1gLFxuXHRcdFx0XHRgJHt0aGlzTW9kdWxlfSA+ICR7dGhpc0Z1bmN0aW9ufWBcblx0XHRcdCk7XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2VuUGFsZXR0ZURPTUJveChcblx0aXRlbXM6IFBhbGV0dGVJdGVtW10sXG5cdG51bUJveGVzOiBudW1iZXIsXG5cdHRhYmxlSWQ6IHN0cmluZ1xuKTogUHJvbWlzZTx2b2lkPiB7XG5cdGNvbnN0IHRoaXNGdW5jdGlvbiA9ICdnZW5QYWxldHRlRE9NQm94KCknO1xuXG5cdHRyeSB7XG5cdFx0Y29uc3QgcGFsZXR0ZVJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYWxldHRlLXJvdycpO1xuXHRcdGNvbnN0IGlkYk1hbmFnZXIgPSBhd2FpdCBJREJNYW5hZ2VyLmdldEluc3RhbmNlKCk7XG5cblx0XHRpZiAoIXBhbGV0dGVSb3cpIHtcblx0XHRcdGlmIChsb2dNb2RlLmVycm9yKVxuXHRcdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdFx0J3BhbGV0dGVSb3cgaXMgdW5kZWZpbmVkLicsXG5cdFx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHRcdCk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRwYWxldHRlUm93LmlubmVySFRNTCA9ICcnO1xuXG5cdFx0Y29uc3QgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWluKGl0ZW1zLmxlbmd0aCwgbnVtQm94ZXMpOyBpKyspIHtcblx0XHRcdGNvbnN0IGl0ZW0gPSBpdGVtc1tpXTtcblx0XHRcdGNvbnN0IGNvbG9yOiBIU0wgPSB7IHZhbHVlOiBpdGVtLmNvbG9ycy5tYWluLmhzbCwgZm9ybWF0OiAnaHNsJyB9O1xuXHRcdFx0Y29uc3QgeyBjb2xvclN0cmlwZSB9ID0gYXdhaXQgaGVscGVycy5kb20ubWFrZVBhbGV0dGVCb3goXG5cdFx0XHRcdGNvbG9yLFxuXHRcdFx0XHRpICsgMVxuXHRcdFx0KTtcblxuXHRcdFx0ZnJhZ21lbnQuYXBwZW5kQ2hpbGQoY29sb3JTdHJpcGUpO1xuXG5cdFx0XHR1dGlscy5wYWxldHRlLnBvcHVsYXRlT3V0cHV0Qm94KGNvbG9yLCBpICsgMSk7XG5cdFx0fVxuXG5cdFx0cGFsZXR0ZVJvdy5hcHBlbmRDaGlsZChmcmFnbWVudCk7XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS5pbmZvICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMSlcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnUGFsZXR0ZSBib3hlcyBnZW5lcmF0ZWQgYW5kIHJlbmRlcmVkLicsXG5cdFx0XHRcdGAke3RoaXNNb2R1bGV9ID4gJHt0aGlzRnVuY3Rpb259YFxuXHRcdFx0KTtcblxuXHRcdGF3YWl0IGlkYk1hbmFnZXIuc2F2ZURhdGEoJ3RhYmxlcycsIHRhYmxlSWQsIHsgcGFsZXR0ZTogaXRlbXMgfSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBnZW5lcmF0aW5nIHBhbGV0dGUgYm94OiAke2Vycm9yfWAsXG5cdFx0XHRcdGAke3RoaXNNb2R1bGV9ID4gJHt0aGlzRnVuY3Rpb259YFxuXHRcdFx0KTtcblx0fVxufVxuXG5leHBvcnQgY29uc3Qgc3RhcnQ6IFBhbGV0dGVGbl9NYXN0ZXJJbnRlcmZhY2VbJ3N0YXJ0J10gPSB7XG5cdGdlblBhbGV0dGUsXG5cdGdlblBhbGV0dGVET01Cb3hcbn0gYXMgY29uc3Q7XG5cbi8vICoqKioqKioqIEdFTkVSQVRFICoqKioqKioqXG5cbmZ1bmN0aW9uIGxpbWl0ZWRIU0woXG5cdGJhc2VIdWU6IG51bWJlcixcblx0bGltaXREYXJrOiBib29sZWFuLFxuXHRsaW1pdEdyYXk6IGJvb2xlYW4sXG5cdGxpbWl0TGlnaHQ6IGJvb2xlYW4sXG5cdGFscGhhVmFsdWU6IG51bWJlciB8IG51bGxcbik6IEhTTCB7XG5cdGxldCBoc2w6IEhTTDtcblxuXHRkbyB7XG5cdFx0aHNsID0ge1xuXHRcdFx0dmFsdWU6IHtcblx0XHRcdFx0aHVlOiBjb3JlVXRpbHMuYnJhbmQuYXNSYWRpYWwoYmFzZUh1ZSksXG5cdFx0XHRcdHNhdHVyYXRpb246IGNvcmVVdGlscy5icmFuZC5hc1BlcmNlbnRpbGUoTWF0aC5yYW5kb20oKSAqIDEwMCksXG5cdFx0XHRcdGxpZ2h0bmVzczogY29yZVV0aWxzLmJyYW5kLmFzUGVyY2VudGlsZShNYXRoLnJhbmRvbSgpICogMTAwKSxcblx0XHRcdFx0YWxwaGE6IGFscGhhVmFsdWVcblx0XHRcdFx0XHQ/IGNvcmVVdGlscy5icmFuZC5hc0FscGhhUmFuZ2UoYWxwaGFWYWx1ZSlcblx0XHRcdFx0XHQ6IGNvcmVVdGlscy5icmFuZC5hc0FscGhhUmFuZ2UoMSlcblx0XHRcdH0sXG5cdFx0XHRmb3JtYXQ6ICdoc2wnXG5cdFx0fTtcblx0fSB3aGlsZSAoXG5cdFx0KGxpbWl0R3JheSAmJiBpc1Rvb0dyYXkoaHNsKSkgfHxcblx0XHQobGltaXREYXJrICYmIGlzVG9vRGFyayhoc2wpKSB8fFxuXHRcdChsaW1pdExpZ2h0ICYmIGlzVG9vTGlnaHQoaHNsKSlcblx0KTtcblxuXHRyZXR1cm4gaHNsO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZWxlY3RlZFBhbGV0dGUob3B0aW9uczogUGFsZXR0ZU9wdGlvbnMpOiBQcm9taXNlPFBhbGV0dGU+IHtcblx0Y29uc3QgdGhpc0Z1bmN0aW9uID0gJ3NlbGVjdGVkUGFsZXR0ZSgpJztcblxuXHR0cnkge1xuXHRcdGNvbnN0IHsgY3VzdG9tQ29sb3IsIGZsYWdzLCBzd2F0Y2hlcywgdHlwZSB9ID0gb3B0aW9ucztcblxuXHRcdGNvbnN0IGFyZ3M6IEdlblBhbGV0dGVBcmdzID0ge1xuXHRcdFx0c3dhdGNoZXMsXG5cdFx0XHR0eXBlLFxuXHRcdFx0Y3VzdG9tQ29sb3IsXG5cdFx0XHRlbmFibGVBbHBoYTogZmxhZ3MuZW5hYmxlQWxwaGEsXG5cdFx0XHRsaW1pdERhcms6IGZsYWdzLmxpbWl0RGFya25lc3MsXG5cdFx0XHRsaW1pdEdyYXk6IGZsYWdzLmxpbWl0R3JheW5lc3MsXG5cdFx0XHRsaW1pdExpZ2h0OiBmbGFncy5saW1pdExpZ2h0bmVzc1xuXHRcdH07XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS5kZWJ1ZyAmJiBsb2dNb2RlLnZlcmJvc2l0eSA+IDIpIHtcblx0XHRcdGxvZ2dlci5kZWJ1Zyhcblx0XHRcdFx0YEdlbmVyYXRpbmcgcGFsZXR0ZSB3aXRoIHR5cGUgIzogJHt0eXBlfWAsXG5cdFx0XHRcdGAke3RoaXNNb2R1bGV9ID4gJHt0aGlzRnVuY3Rpb259YFxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRzd2l0Y2ggKHR5cGUpIHtcblx0XHRcdGNhc2UgMTpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLnJhbmRvbShhcmdzKTtcblx0XHRcdGNhc2UgMjpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLmNvbXBsZW1lbnRhcnkoYXJncyk7XG5cdFx0XHRjYXNlIDM6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS50cmlhZGljKGFyZ3MpO1xuXHRcdFx0Y2FzZSA0OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUudGV0cmFkaWMoYXJncyk7XG5cdFx0XHRjYXNlIDU6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5zcGxpdENvbXBsZW1lbnRhcnkoYXJncyk7XG5cdFx0XHRjYXNlIDY6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5hbmFsb2dvdXMoYXJncyk7XG5cdFx0XHRjYXNlIDc6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5oZXhhZGljKGFyZ3MpO1xuXHRcdFx0Y2FzZSA4OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUuZGlhZGljKGFyZ3MpO1xuXHRcdFx0Y2FzZSA5OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUubW9ub2Nocm9tYXRpYyhhcmdzKTtcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdGlmIChsb2dNb2RlLmVycm9yKVxuXHRcdFx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0XHRcdCdJbnZhbGlkIHBhbGV0dGUgdHlwZS4nLFxuXHRcdFx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRlZmF1bHRCcmFuZGVkUGFsZXRlKTtcblx0XHR9XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3IpXG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBnZW5lcmF0aW5nIHBhbGV0dGU6ICR7ZXJyb3J9YCxcblx0XHRcdFx0YCR7dGhpc01vZHVsZX0gPiAke3RoaXNGdW5jdGlvbn1gXG5cdFx0XHQpO1xuXG5cdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShkZWZhdWx0QnJhbmRlZFBhbGV0ZSk7XG5cdH1cbn1cblxuZXhwb3J0IGNvbnN0IGdlbmVyYXRlOiBQYWxldHRlRm5fTWFzdGVySW50ZXJmYWNlWydnZW5lcmF0ZSddID0ge1xuXHRsaW1pdGVkSFNMLFxuXHRzZWxlY3RlZFBhbGV0dGVcbn0gYXMgY29uc3Q7XG4iXX0=