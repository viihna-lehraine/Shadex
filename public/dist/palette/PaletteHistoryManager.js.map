{"version":3,"file":"PaletteHistoryManager.js","sources":["../../../../src/palette/PaletteHistoryManager.ts"],"sourcesContent":["import {\n\tHelpers,\n\tPalette,\n\tPaletteHistoryManagerContract,\n\tServices\n} from '../types/index.js';\nimport { StorageManager } from '../storage/StorageManager.js';\nimport { env } from '../config/index.js';\n\nconst caller = 'PaletteHistoryManager';\nconst paletteHistoryLimit = env.app.paletteHistoryLimit;\n\nexport class PaletteHistoryManager implements PaletteHistoryManagerContract {\n\tstatic #instance: PaletteHistoryManager | null = null;\n\n\t#paletteHistory: Palette[];\n\t#redoStack: Palette[];\n\t#undoStack: Palette[];\n\n\t#deepFreeze: Helpers['data']['deepFreeze'];\n\t#errors: Services['errors'];\n\t#log: Services['log'];\n\t#storage!: StorageManager;\n\n\tprivate constructor(helpers: Helpers, services: Services) {\n\t\ttry {\n\t\t\tservices.log.info(\n\t\t\t\t`Constructing ${caller} instance`,\n\t\t\t\t`[${caller} constructor]`\n\t\t\t);\n\n\t\t\tthis.#paletteHistory = [];\n\t\t\tthis.#redoStack = [];\n\t\t\tthis.#undoStack = [];\n\n\t\t\tthis.#deepFreeze = helpers.data.deepFreeze;\n\t\t\tthis.#errors = services.errors;\n\t\t\tthis.#log = services.log;\n\n\t\t\tthis.init(services).catch(error => {\n\t\t\t\tthis.#log.error(\n\t\t\t\t\t`${caller} initialization failed.`,\n\t\t\t\t\t`[${caller} constructor]`\n\t\t\t\t);\n\t\t\t\tconsole.error(error);\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tthrow new Error(\n\t\t\t\t`[${caller} constructor]: ${error instanceof Error ? error.message : error}`\n\t\t\t);\n\t\t}\n\t}\n\n\tstatic getInstance(\n\t\thelpers: Helpers,\n\t\tservices: Services\n\t): PaletteHistoryManager {\n\t\treturn services.errors.handleSync(() => {\n\t\t\tif (!PaletteHistoryManager.#instance) {\n\t\t\t\tservices.log.debug(\n\t\t\t\t\t`Creating ${caller} instance.`,\n\t\t\t\t\t`${caller}.getInstance`\n\t\t\t\t);\n\n\t\t\t\tPaletteHistoryManager.#instance = new PaletteHistoryManager(\n\t\t\t\t\thelpers,\n\t\t\t\t\tservices\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tservices.log.debug(\n\t\t\t\t`Retrieving ${caller} instance`,\n\t\t\t\t`${caller}.getInstance`\n\t\t\t);\n\t\t\treturn PaletteHistoryManager.#instance;\n\t\t}, `[${caller}.getInstance]: Failed to get instance.`);\n\t}\n\n\tasync init(services: Services): Promise<void> {\n\t\treturn this.#errors.handleAsync(async () => {\n\t\t\tthis.#log.debug(`Initializing ${caller}.`, `[${caller}.init]`);\n\t\t\tthis.#storage = await StorageManager.getInstance(services);\n\t\t\tthis.#paletteHistory = await this.#loadPaletteHistory();\n\t\t}, `[${caller}.init]: Initialization error.`);\n\t}\n\n\taddPalette(palette: Palette): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tif (this.#paletteHistory.length >= paletteHistoryLimit) {\n\t\t\t\tthis.#paletteHistory.shift();\n\t\t\t}\n\n\t\t\tthis.#paletteHistory.push(this.#deepFreeze(palette));\n\t\t\tthis.#redoStack = [];\n\t\t\tthis.#savePaletteHistory();\n\n\t\t\tthis.#log.info(\n\t\t\t\t`Palette added to history.`,\n\t\t\t\t`[${caller}.addPalette]`\n\t\t\t);\n\t\t}, `[${caller}.addPalette]: Failed to add palette to history.`);\n\t}\n\n\tclearHistory(): void {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tthis.#paletteHistory = [];\n\t\t\tthis.#undoStack = [];\n\t\t\tthis.#redoStack = [];\n\n\t\t\tthis.#savePaletteHistory();\n\n\t\t\tthis.#log.info(\n\t\t\t\t`Palette history cleared.`,\n\t\t\t\t`[${caller}.clearHistory]`\n\t\t\t);\n\t\t}, `[${caller}.clearHistory]: Failed to clear palette history.`);\n\t}\n\n\tgetCurrentPalette(): Palette | null {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\treturn this.#paletteHistory.length\n\t\t\t\t? this.#paletteHistory[this.#paletteHistory.length - 1]\n\t\t\t\t: null;\n\t\t}, `[${caller}.getCurrentPalette]: Palette retrieval error.`);\n\t}\n\n\tgetHistory(): Palette[] {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\treturn this.#paletteHistory.map(palette =>\n\t\t\t\tthis.#deepFreeze(palette)\n\t\t\t);\n\t\t}, `[${caller}.getHistory]: Failed to retrieve palette history.`);\n\t}\n\n\tredo(): Palette | null {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tif (this.#redoStack.length) {\n\t\t\t\tconst redoPalette = this.#redoStack.pop();\n\t\t\t\tif (!redoPalette) {\n\t\t\t\t\tthis.#log.info(`No palette to redo.`, `[${caller}.redo]`);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tthis.#paletteHistory.push(redoPalette);\n\t\t\t\tthis.#savePaletteHistory();\n\n\t\t\t\treturn redoPalette;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}, `[${caller}.redo]: Failed to redo palette.`);\n\t}\n\n\tundo(): Palette | null {\n\t\treturn this.#errors.handleSync(() => {\n\t\t\tif (this.#paletteHistory.length > 1) {\n\t\t\t\tconst lastPalette = this.#paletteHistory.pop();\n\t\t\t\tif (!lastPalette) {\n\t\t\t\t\tthis.#log.info(`No palette to undo.`, `[${caller}.undo]`);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tthis.#undoStack.push(lastPalette);\n\t\t\t\tthis.#redoStack.push(lastPalette);\n\n\t\t\t\tthis.#savePaletteHistory();\n\t\t\t\treturn this.getCurrentPalette();\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}, `[${caller}.undo]: Failed to undo palette.`);\n\t}\n\n\tasync #loadPaletteHistory(): Promise<Palette[]> {\n\t\treturn this.#errors.handleAsync(async () => {\n\t\t\tconst storedHistory =\n\t\t\t\tawait this.#storage.getItem<Palette[]>('paletteHistory');\n\t\t\tif (storedHistory) {\n\t\t\t\tthis.#log.info(\n\t\t\t\t\t`Loaded palette history from storage.`,\n\t\t\t\t\t`[${caller}.#loadPaletteHistory]`\n\t\t\t\t);\n\t\t\t\treturn storedHistory;\n\t\t\t}\n\n\t\t\tthis.#log.debug(\n\t\t\t\t`No saved palette history found.`,\n\t\t\t\t`[${caller}.#loadPaletteHistory]`\n\t\t\t);\n\t\t\treturn [];\n\t\t}, `[${caller}.#loadPaletteHistory]: Failed to load palette history.`);\n\t}\n\n\tasync #savePaletteHistory(): Promise<void> {\n\t\treturn this.#errors.handleAsync(async () => {\n\t\t\tawait this.#storage.setItem('paletteHistory', this.#paletteHistory);\n\t\t\tthis.#log.info(\n\t\t\t\t`Palette history saved to storage.`,\n\t\t\t\t`[${caller}.#savePaletteHistory]`\n\t\t\t);\n\t\t}, `[${caller}.#savePaletteHistory]: Failed to save palette history.`);\n\t}\n}\n"],"names":[],"mappings":"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"}