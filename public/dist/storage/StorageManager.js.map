{"version":3,"file":"StorageManager.js","sources":["../../../../src/storage/StorageManager.ts"],"sourcesContent":["// File: storage/StorageManager.js\n\nimport { Services, StorageManagerInterface } from '../types/index.js';\nimport { IDBManager } from './IDBManager.js';\nimport { LocalStorageManager } from './LocalStorageManager.js';\n\nexport class StorageManager implements StorageManagerInterface {\n\t#idbManager: IDBManager | null = null;\n\t#localStorageManager!: LocalStorageManager;\n\t#services!: Services;\n\t#log!: Services['log'];\n\t#errors!: Services['errors'];\n\t#useLocalStorage = false;\n\n\tconstructor(services: Services) {\n\t\tservices.errors.handleSync(() => {\n\t\t\tthis.#services = services;\n\t\t\tthis.#log = services.log;\n\t\t\tthis.#errors = services.errors;\n\t\t\tthis.#localStorageManager = LocalStorageManager.getInstance(\n\t\t\t\tthis.#services\n\t\t\t);\n\t\t}, 'Failed to initialize StorageManager');\n\n\t\tthis.#log('Storage Manager initialized');\n\t}\n\n\tasync init(): Promise<boolean> {\n\t\treturn this.#errors.handleAsync(async () => {\n\t\t\tthis.#log('Initializing Storage Manager');\n\t\t\tthis.#idbManager = IDBManager.getInstance(this.#services);\n\n\t\t\tconst idbAvailable = await this.#idbManager.init();\n\t\t\tif (idbAvailable) {\n\t\t\t\tthis.#log('Using IndexedDB for storage.');\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tthis.#useLocalStorage = true;\n\t\t\tawait this.#localStorageManager.init();\n\t\t\treturn true;\n\t\t}, 'StorageManager initialization failed');\n\t}\n\n\tasync clear(): Promise<void> {\n\t\tawait this.#errors.handleAsync(async () => {\n\t\t\tif (!this.#useLocalStorage && this.#idbManager) {\n\t\t\t\tconst success = await this.#idbManager.clear();\n\t\t\t\tif (success !== null) return;\n\t\t\t}\n\t\t\tawait this.#localStorageManager.clear();\n\t\t}, 'Failed to clear storage');\n\t}\n\n\tasync getItem<T>(key: string): Promise<T | null> {\n\t\treturn this.#errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.#useLocalStorage && this.#idbManager) {\n\t\t\t\t\tconst value = await this.#idbManager.getItem<T>(key);\n\t\t\t\t\tif (value !== null) return value;\n\t\t\t\t}\n\t\t\t\treturn await this.#localStorageManager.getItem<T>(key);\n\t\t\t},\n\t\t\t`Failed to get item ${key} from storage`,\n\t\t\t{ key }\n\t\t);\n\t}\n\n\tasync removeItem(key: string): Promise<void> {\n\t\tawait this.#errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.#useLocalStorage && this.#idbManager) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.#idbManager.removeItem(key);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} catch {}\n\t\t\t\t}\n\t\t\t\tawait this.#localStorageManager.removeItem(key);\n\t\t\t},\n\t\t\t`Failed to remove item ${key} from storage`,\n\t\t\t{ key }\n\t\t);\n\t}\n\n\tasync setItem(key: string, value: unknown): Promise<void> {\n\t\tawait this.#errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.#useLocalStorage && this.#idbManager) {\n\t\t\t\t\tawait this.#idbManager.ensureDBReady();\n\t\t\t\t\tawait this.#idbManager.setItem(key, value);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.#log(\n\t\t\t\t\t`Falling back to LocalStorage for key: ${key}`,\n\t\t\t\t\t'warn'\n\t\t\t\t);\n\t\t\t\tawait this.#localStorageManager.setItem(key, value);\n\t\t\t},\n\t\t\t`Failed to set item ${key} in storage`,\n\t\t\t{ key, value }\n\t\t);\n\t}\n}\n"],"names":[],"mappings":"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"}