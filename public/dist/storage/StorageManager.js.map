{"version":3,"file":"StorageManager.js","sources":["../../../../src/storage/StorageManager.ts"],"sourcesContent":["// File: storage/StorageManager.js\n\nimport { ServicesInterface } from '../types/index.js';\nimport { IDBManager } from './IDBManager.js';\nimport { LocalStorageManager } from './LocalStorageManager.js';\n\nexport class StorageManager {\n\tprivate idbManager: IDBManager | null = null;\n\tprivate localStorageManager: LocalStorageManager;\n\tprivate services: ServicesInterface;\n\tprivate log: ServicesInterface['log'];\n\tprivate useLocalStorage = false;\n\n\tconstructor(services: ServicesInterface) {\n\t\tthis.services = services;\n\t\tthis.log = services.log;\n\t\tthis.localStorageManager = LocalStorageManager.getInstance(\n\t\t\tthis.services\n\t\t);\n\t}\n\n\tpublic async init(): Promise<boolean> {\n\t\tthis.log(\n\t\t\t'info',\n\t\t\t'Initializing Storage Manager',\n\t\t\t'StorageManager.init()'\n\t\t);\n\t\ttry {\n\t\t\tthis.idbManager = IDBManager.getInstance(this.services);\n\t\t\tconst idbAvailable = await this.idbManager.init();\n\t\t\tif (idbAvailable) {\n\t\t\t\tthis.log(\n\t\t\t\t\t'info',\n\t\t\t\t\t'Using IndexedDB for storage.',\n\t\t\t\t\t'StorageManager.init()'\n\t\t\t\t);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.log(\n\t\t\t\t'warn',\n\t\t\t\t'IndexedDB initialization failed, falling back to LocalStorage',\n\t\t\t\t'StorageManager.init()'\n\t\t\t);\n\t\t}\n\n\t\tthis.useLocalStorage = true;\n\t\tawait this.localStorageManager.init();\n\t\treturn true;\n\t}\n\n\tpublic async clear(): Promise<void> {\n\t\tif (!this.useLocalStorage && this.idbManager) {\n\t\t\ttry {\n\t\t\t\tawait this.idbManager.clear();\n\t\t\t\treturn;\n\t\t\t} catch (error) {\n\t\t\t\tthis.log(\n\t\t\t\t\t'warn',\n\t\t\t\t\t'Failed to clear IndexedDB, falling back to LocalStorage',\n\t\t\t\t\t'StorageManager.clear()'\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tawait this.localStorageManager.clear();\n\t}\n\n\tpublic async getItem<T>(key: string): Promise<T | null> {\n\t\tif (!this.useLocalStorage && this.idbManager) {\n\t\t\ttry {\n\t\t\t\tconst value = await this.idbManager.getItem<T>(key);\n\t\t\t\tif (value !== null) return value;\n\t\t\t} catch (error) {\n\t\t\t\tthis.log(\n\t\t\t\t\t'warn',\n\t\t\t\t\t`Failed to get item ${key} from IndexedDB, trying LocalStorage`,\n\t\t\t\t\t'StorageManager.getItem()'\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\treturn await this.localStorageManager.getItem<T>(key);\n\t}\n\n\tpublic async removeItem(key: string): Promise<void> {\n\t\tif (!this.useLocalStorage && this.idbManager) {\n\t\t\ttry {\n\t\t\t\tawait this.idbManager.removeItem(key);\n\t\t\t\treturn;\n\t\t\t} catch (error) {\n\t\t\t\tthis.log(\n\t\t\t\t\t'error',\n\t\t\t\t\t`Failed to remove item ${key} from IndexedDB, trying LocalStorage`,\n\t\t\t\t\t'StorageManager.removeItem()'\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tawait this.localStorageManager.removeItem(key);\n\t}\n\n\tpublic async setItem(key: string, value: unknown): Promise<void> {\n\t\tif (!this.useLocalStorage && this.idbManager) {\n\t\t\ttry {\n\t\t\t\tawait this.idbManager.ensureDBReady();\n\t\t\t\tawait this.idbManager.setItem(key, value);\n\t\t\t\treturn;\n\t\t\t} catch (error) {\n\t\t\t\tthis.log(\n\t\t\t\t\t'error',\n\t\t\t\t\t`Failed to set item ${key} in IndexedDB, using LocalStorage`,\n\t\t\t\t\t'StorageManager.setItem()'\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tawait this.localStorageManager.setItem(key, value);\n\t}\n}\n"],"names":[],"mappings":"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"}