{"version":3,"file":"StorageManager.js","sources":["../../../../src/storage/StorageManager.ts"],"sourcesContent":["// File: storage/StorageManager.ts\n\nimport { Services, StorageManagerInterface } from '../types/index.js';\nimport { IDBManager } from './IDBManager.js';\nimport { LocalStorageManager } from './LocalStorageManager.js';\n\nconst caller = 'StorageManager';\n\nexport class StorageManager implements StorageManagerInterface {\n\t#idbManager: IDBManager | null = null;\n\t#localStorageManager!: LocalStorageManager;\n\t#useLocalStorage = false;\n\n\t#services!: Services;\n\t#errors!: Services['errors'];\n\t#log!: Services['log'];\n\n\tconstructor(services: Services) {\n\t\ttry {\n\t\t\tthis.#services = services;\n\t\t\tthis.#log = services.log;\n\t\t\tthis.#errors = services.errors;\n\n\t\t\tthis.#localStorageManager = LocalStorageManager.getInstance(\n\t\t\t\tthis.#services\n\t\t\t);\n\n\t\t\tthis.#log('Storage Manager initialized', {\n\t\t\t\tcaller: `${caller}.constructor`\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tthrow new Error(\n\t\t\t\t`[${caller}.constructor]: ${\n\t\t\t\t\terror instanceof Error ? error.message : error\n\t\t\t\t}`\n\t\t\t);\n\t\t}\n\t}\n\n\tasync init(): Promise<boolean> {\n\t\treturn this.#errors.handleAsync(async () => {\n\t\t\tthis.#log('Initializing Storage Manager.', {\n\t\t\t\tcaller: `[${caller}.init]`\n\t\t\t});\n\n\t\t\tthis.#idbManager = await IDBManager.getInstance(this.#services);\n\n\t\t\tconst idbAvailable = await this.#idbManager.init();\n\n\t\t\tif (idbAvailable) {\n\t\t\t\tthis.#log('Using IndexedDB for storage!', {\n\t\t\t\t\tcaller: `${caller}.init`\n\t\t\t\t});\n\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tthis.#useLocalStorage = true;\n\n\t\t\tawait this.#localStorageManager.init();\n\n\t\t\treturn true;\n\t\t}, `[${caller}]: Initialization failed`);\n\t}\n\n\tasync clear(): Promise<void> {\n\t\treturn await this.#errors.handleAsync(async () => {\n\t\t\tif (!this.#useLocalStorage && this.#idbManager) {\n\t\t\t\tconst success = await this.#idbManager.clear();\n\n\t\t\t\tif (success !== null) return;\n\t\t\t}\n\n\t\t\tawait this.#localStorageManager.clear();\n\t\t}, `[${caller}]: Failed to clear storage.`);\n\t}\n\n\tasync getItem<T>(key: string): Promise<T | null> {\n\t\treturn this.#errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.#useLocalStorage && this.#idbManager) {\n\t\t\t\t\tconst value = await this.#idbManager.getItem<T>(key);\n\n\t\t\t\t\tif (value !== null) return value;\n\t\t\t\t}\n\n\t\t\t\treturn await this.#localStorageManager.getItem<T>(key);\n\t\t\t},\n\t\t\t`[${caller}]: Failed to get item ${key} from storage`,\n\t\t\t{ context: { key } }\n\t\t);\n\t}\n\n\tasync removeItem(key: string): Promise<void> {\n\t\treturn await this.#errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.#useLocalStorage && this.#idbManager) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.#idbManager.removeItem(key);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} catch {}\n\t\t\t\t}\n\t\t\t\tawait this.#localStorageManager.removeItem(key);\n\t\t\t},\n\t\t\t`[${caller}]: Failed to remove item ${key} from storage`,\n\t\t\t{ context: { key } }\n\t\t);\n\t}\n\n\tasync setItem(key: string, value: unknown): Promise<void> {\n\t\treturn await this.#errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.#useLocalStorage && this.#idbManager) {\n\t\t\t\t\tawait this.#idbManager.ensureDBReady();\n\n\t\t\t\t\tawait this.#idbManager.setItem(key, value);\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.#log(`Falling back to LocalStorage for key: ${key}`, {\n\t\t\t\t\tcaller: `${caller}.setItem`,\n\t\t\t\t\tlevel: 'warn'\n\t\t\t\t});\n\n\t\t\t\tawait this.#localStorageManager.setItem(key, value);\n\t\t\t},\n\t\t\t`[${caller}]: Failed to set item ${key} in storage`,\n\t\t\t{ context: { key, value } }\n\t\t);\n\t}\n}\n"],"names":[],"mappings":"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"}