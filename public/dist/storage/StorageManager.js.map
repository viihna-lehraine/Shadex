{"version":3,"file":"StorageManager.js","sources":["../../../../src/storage/StorageManager.ts"],"sourcesContent":["// File: storage/StorageManager.js\n\nimport {\n\tServicesInterface,\n\tStorageManagerClassInterface\n} from '../types/index.js';\nimport { IDBManager } from './IDBManager.js';\nimport { LocalStorageManager } from './LocalStorageManager.js';\n\nexport class StorageManager implements StorageManagerClassInterface {\n\tprivate idbManager: IDBManager | null = null;\n\tprivate localStorageManager!: LocalStorageManager;\n\tprivate services!: ServicesInterface;\n\tprivate log!: ServicesInterface['log'];\n\tprivate errors!: ServicesInterface['errors'];\n\tprivate useLocalStorage = false;\n\n\tconstructor(services: ServicesInterface) {\n\t\tservices.errors.handle(\n\t\t\t() => {\n\t\t\t\tthis.services = services;\n\t\t\t\tthis.log = services.log;\n\t\t\t\tthis.errors = services.errors;\n\t\t\t\tthis.localStorageManager = LocalStorageManager.getInstance(\n\t\t\t\t\tthis.services\n\t\t\t\t);\n\t\t\t},\n\t\t\t'Failed to initialize StorageManager',\n\t\t\t'StorageManager.constructor'\n\t\t);\n\n\t\tthis.log(\n\t\t\t'info',\n\t\t\t'Storage Manager initialized',\n\t\t\t'StorageManager.constructor'\n\t\t);\n\t}\n\n\tpublic async init(): Promise<boolean> {\n\t\treturn this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tthis.log(\n\t\t\t\t\t'info',\n\t\t\t\t\t'Initializing Storage Manager',\n\t\t\t\t\t'StorageManager.init()'\n\t\t\t\t);\n\t\t\t\tthis.idbManager = IDBManager.getInstance(this.services);\n\n\t\t\t\tconst idbAvailable = await this.idbManager.init();\n\t\t\t\tif (idbAvailable) {\n\t\t\t\t\tthis.log(\n\t\t\t\t\t\t'info',\n\t\t\t\t\t\t'Using IndexedDB for storage.',\n\t\t\t\t\t\t'StorageManager.init()'\n\t\t\t\t\t);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tthis.useLocalStorage = true;\n\t\t\t\tawait this.localStorageManager.init();\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\t'StorageManager initialization failed',\n\t\t\t'StorageManager.init()'\n\t\t);\n\t}\n\n\tpublic async clear(): Promise<void> {\n\t\tawait this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.useLocalStorage && this.idbManager) {\n\t\t\t\t\tconst success = await this.idbManager.clear();\n\t\t\t\t\tif (success !== null) return;\n\t\t\t\t}\n\t\t\t\tawait this.localStorageManager.clear();\n\t\t\t},\n\t\t\t'Failed to clear storage',\n\t\t\t'StorageManager.clear()'\n\t\t);\n\t}\n\n\tpublic async getItem<T>(key: string): Promise<T | null> {\n\t\treturn this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.useLocalStorage && this.idbManager) {\n\t\t\t\t\tconst value = await this.idbManager.getItem<T>(key);\n\t\t\t\t\tif (value !== null) return value;\n\t\t\t\t}\n\t\t\t\treturn await this.localStorageManager.getItem<T>(key);\n\t\t\t},\n\t\t\t`Failed to get item ${key} from storage`,\n\t\t\t'StorageManager.getItem()',\n\t\t\t{ key }\n\t\t);\n\t}\n\n\tpublic async removeItem(key: string): Promise<void> {\n\t\tawait this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.useLocalStorage && this.idbManager) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.idbManager.removeItem(key);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} catch {}\n\t\t\t\t}\n\t\t\t\tawait this.localStorageManager.removeItem(key);\n\t\t\t},\n\t\t\t`Failed to remove item ${key} from storage`,\n\t\t\t'StorageManager.removeItem()',\n\t\t\t{ key }\n\t\t);\n\t}\n\n\tpublic async setItem(key: string, value: unknown): Promise<void> {\n\t\tawait this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.useLocalStorage && this.idbManager) {\n\t\t\t\t\tawait this.idbManager.ensureDBReady();\n\t\t\t\t\tawait this.idbManager.setItem(key, value);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.log(\n\t\t\t\t\t'warn',\n\t\t\t\t\t`Falling back to LocalStorage for key: ${key}`,\n\t\t\t\t\t'StorageManager.setItem()'\n\t\t\t\t);\n\t\t\t\tawait this.localStorageManager.setItem(key, value);\n\t\t\t},\n\t\t\t`Failed to set item ${key} in storage`,\n\t\t\t'StorageManager.setItem()',\n\t\t\t{ key, value }\n\t\t);\n\t}\n}\n"],"names":[],"mappings":"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"}