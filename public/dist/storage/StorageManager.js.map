{"version":3,"file":"StorageManager.js","sources":["../../../../src/storage/StorageManager.ts"],"sourcesContent":["// File: storage/StorageManager.ts\n\nimport { Services, StorageManagerContract } from '../types/index.js';\nimport { IDBStorageService } from './IDBStorageService.js';\nimport { LocalStorageService } from './LocalStorageService.js';\n\nconst caller = 'StorageManager';\n\nexport class StorageManager implements StorageManagerContract {\n\tstatic #instance: StorageManager | null = null;\n\n\t#idbStorageService: IDBStorageService | null = null;\n\t#localStorageService!: LocalStorageService;\n\t#useLocalStorage = false;\n\n\t#services!: Services;\n\t#errors!: Services['errors'];\n\t#log!: Services['log'];\n\n\tprivate constructor(services: Services) {\n\t\ttry {\n\t\t\tthis.#services = services;\n\t\t\tthis.#log = services.log;\n\t\t\tthis.#errors = services.errors;\n\n\t\t\tthis.#localStorageService = LocalStorageService.getInstance(\n\t\t\t\tthis.#services\n\t\t\t);\n\n\t\t\tthis.init();\n\n\t\t\tthis.#log.info(`${caller} initialized.`, `${caller}.constructor`);\n\t\t} catch (error) {\n\t\t\tthrow new Error(\n\t\t\t\t`[${caller}.constructor]: ${\n\t\t\t\t\terror instanceof Error ? error.message : error\n\t\t\t\t}`\n\t\t\t);\n\t\t}\n\t}\n\n\tstatic async getInstance(services: Services): Promise<StorageManager> {\n\t\treturn services.errors.handleAsync(async () => {\n\t\t\tif (!StorageManager.#instance) {\n\t\t\t\tservices.log.debug(\n\t\t\t\t\t`Creating StorageManager instance.`,\n\t\t\t\t\t`${caller}.getInstance`\n\t\t\t\t);\n\n\t\t\t\tStorageManager.#instance = new StorageManager(services);\n\t\t\t}\n\n\t\t\treturn StorageManager.#instance;\n\t\t}, `[${caller}.getInstance]: Failed to create StorageManager instance.`);\n\t}\n\n\tasync init(): Promise<boolean> {\n\t\treturn this.#errors.handleAsync(async () => {\n\t\t\tthis.#log.info('Initializing Storage Manager.', `${caller}.init`);\n\n\t\t\tthis.#idbStorageService = await IDBStorageService.getInstance(\n\t\t\t\tthis.#services\n\t\t\t);\n\n\t\t\tconst idbAvailable = await this.#idbStorageService.init();\n\n\t\t\tif (!idbAvailable) {\n\t\t\t\tthis.#log.warn(\n\t\t\t\t\t'IndexedDB is unavailable. Falling back to LocalStorage.',\n\t\t\t\t\t`${caller}.init`\n\t\t\t\t);\n\t\t\t\tthis.#useLocalStorage = true;\n\t\t\t\tawait this.#localStorageService.init();\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tthis.#log.info('Using IndexedDB for storage.', `${caller}.init`);\n\t\t\treturn true;\n\t\t}, `[${caller}]: Initialization failed`);\n\t}\n\n\tasync clear(): Promise<void> {\n\t\treturn await this.#errors.handleAsync(async () => {\n\t\t\tif (!this.#useLocalStorage && this.#idbStorageService) {\n\t\t\t\tconst success = await this.#idbStorageService.clear();\n\n\t\t\t\tif (success !== null) return;\n\t\t\t}\n\n\t\t\tawait this.#localStorageService.clear();\n\t\t}, `[${caller}]: Failed to clear storage.`);\n\t}\n\n\tasync getItem<T>(key: string): Promise<T | null> {\n\t\treturn this.#errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.#useLocalStorage && this.#idbStorageService) {\n\t\t\t\t\tconst value = await this.#idbStorageService.getItem<T>(key);\n\n\t\t\t\t\tif (value !== null) return value;\n\t\t\t\t}\n\n\t\t\t\treturn await this.#localStorageService.getItem<T>(key);\n\t\t\t},\n\t\t\t`[${caller}]: Failed to get item ${key} from storage`,\n\t\t\t{ context: { key } }\n\t\t);\n\t}\n\n\tasync removeItem(key: string): Promise<void> {\n\t\treturn await this.#errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.#useLocalStorage && this.#idbStorageService) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.#idbStorageService.removeItem(key);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} catch {}\n\t\t\t\t}\n\t\t\t\tawait this.#localStorageService.removeItem(key);\n\t\t\t},\n\t\t\t`[${caller}]: Failed to remove item ${key} from storage`,\n\t\t\t{ context: { key } }\n\t\t);\n\t}\n\n\tasync setItem(key: string, value: unknown): Promise<void> {\n\t\treturn await this.#errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!this.#useLocalStorage && this.#idbStorageService) {\n\t\t\t\t\tawait this.#idbStorageService.ensureDBReady();\n\n\t\t\t\t\tawait this.#idbStorageService.setItem(key, value);\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.#log.warn(\n\t\t\t\t\t`Falling back to LocalStorage for key: ${key}`,\n\t\t\t\t\t`${caller}.setItem`\n\t\t\t\t);\n\n\t\t\t\tawait this.#localStorageService.setItem(key, value);\n\t\t\t},\n\t\t\t`[${caller}]: Failed to set item ${key} in storage`,\n\t\t\t{ context: { key, value } }\n\t\t);\n\t}\n}\n"],"names":[],"mappings":"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"}