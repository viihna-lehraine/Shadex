// File: storage/IDBManager.js
import { data } from '../config/index.js';
const dbName = data.storage.idb.dbName;
const defaultVerson = data.storage.idb.defaultVersion;
const storeName = data.storage.idb.storeName;
export class IDBManager {
    static instance = null;
    defaultVersion;
    version;
    db = null;
    log;
    errors;
    constructor(services) {
        this.defaultVersion = defaultVerson;
        this.version = this.defaultVersion;
        this.log = services.log;
        this.errors = services.errors;
    }
    static getInstance(services) {
        if (!IDBManager.instance) {
            IDBManager.instance = new IDBManager(services);
        }
        return IDBManager.instance;
    }
    async init() {
        return this.errors.handleAsync(async () => {
            if (!window.indexedDB) {
                throw new Error('IndexedDB is not supported in this browser');
            }
            console.log('[IDBManager.init] Opening IndexedDB...');
            const request = indexedDB.open(dbName, this.version);
            return await new Promise((resolve, reject) => {
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        console.log(`[IDBManager.init] Created object store: ${storeName}`);
                    }
                };
                request.onsuccess = event => {
                    this.db = event.target.result;
                    this.db.onversionchange = () => {
                        this.db?.close();
                        this.log('IndexedDB version changed, closing database', 'warn');
                    };
                    resolve(true);
                };
                request.onerror = event => {
                    reject(event.target.error?.message ||
                        'Unknown IDBManager.init() error');
                };
            });
        }, 'Failed to initialize IndexedDB');
    }
    async ensureDBReady() {
        while (!this.db) {
            this.log('Waiting for IndexedDB to initialize...', 'warn');
            await new Promise(resolve => setTimeout(resolve, 50));
        }
    }
    async clear() {
        await this.errors.handleAsync(async () => {
            const store = this.getTransaction('readwrite');
            if (!store)
                throw new Error('IndexedDB is not initialized.');
            await new Promise((resolve, reject) => {
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = event => reject(event.target.error?.message ||
                    'Unknown IDBManager.clear() error');
            });
        }, 'Failed to clear IndexedDB');
    }
    async getItem(key) {
        await this.ensureDBReady();
        return this.errors.handleAsync(async () => {
            const store = this.getTransaction('readonly');
            if (!store)
                throw new Error('IndexedDB is not initialized.');
            return await new Promise((resolve, reject) => {
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result?.value ?? null);
                request.onerror = event => reject(event.target.error?.message ||
                    'Unknown IDBManager.getItem() error');
            });
        }, `Failed to retrieve item ${key} from IndexedDB`);
    }
    async setItem(key, value) {
        await this.errors.handleAsync(async () => {
            const store = this.getTransaction('readwrite');
            if (!store)
                throw new Error('IndexedDB is not initialized.');
            await new Promise((resolve, reject) => {
                const request = store.put({ id: key, value });
                request.onsuccess = () => resolve();
                request.onerror = event => reject(event.target.error?.message ||
                    'Unknown IDBManager.setItem() error');
            });
        }, `Failed to store item ${key} in IndexedDB`);
    }
    async removeItem(key) {
        await this.errors.handleAsync(async () => {
            const store = this.getTransaction('readwrite');
            if (!store)
                throw new Error('IndexedDB is not initialized.');
            await new Promise((resolve, reject) => {
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = event => reject(event.target.error?.message ||
                    'Unknown IDBManager.removeItem() error');
            });
        }, `Failed to remove item ${key} from IndexedDB`);
    }
    getTransaction(mode) {
        return this.errors.handle(() => {
            if (!this.db)
                throw new Error('IndexedDB is not initialized.');
            const transaction = this.db.transaction(storeName, mode);
            return transaction.objectStore(storeName);
        }, `Failed to get IndexedDB transaction (${mode})`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSURCTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yYWdlL0lEQk1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsOEJBQThCO0FBRzlCLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUUxQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7QUFDdkMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDO0FBQ3RELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztBQUU3QyxNQUFNLE9BQU8sVUFBVTtJQUNkLE1BQU0sQ0FBQyxRQUFRLEdBQXNCLElBQUksQ0FBQztJQUMxQyxjQUFjLENBQVM7SUFDdkIsT0FBTyxDQUFTO0lBQ2hCLEVBQUUsR0FBdUIsSUFBSSxDQUFDO0lBQzlCLEdBQUcsQ0FBMkI7SUFDOUIsTUFBTSxDQUE4QjtJQUU1QyxZQUFvQixRQUEyQjtRQUM5QyxJQUFJLENBQUMsY0FBYyxHQUFHLGFBQWEsQ0FBQztRQUNwQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUM7UUFDbkMsSUFBSSxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQztJQUMvQixDQUFDO0lBRU0sTUFBTSxDQUFDLFdBQVcsQ0FBQyxRQUEyQjtRQUNwRCxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzFCLFVBQVUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDaEQsQ0FBQztRQUVELE9BQU8sVUFBVSxDQUFDLFFBQVEsQ0FBQztJQUM1QixDQUFDO0lBRU0s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LENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQ3pCLE1BQU0sQ0FDSixLQUFLLENBQUMsTUFBcUIsQ0FBQyxLQUFLLEVBQUUsT0FBTztvQkFDMUMsdUNBQXVDLENBQ3hDLENBQUM7WUFDSixDQUFDLENBQUMsQ0FBQztRQUNKLENBQUMsRUFBRSx5QkFBeUIsR0FBRyxpQkFBaUIsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFTyxjQUFjLENBQUMsSUFBd0I7UUFDOUMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7WUFDOUIsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztZQUMvRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDekQsT0FBTyxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzNDLENBQUMsRUFBRSx3Q0FBd0MsSUFBSSxHQUFHLENBQUMsQ0FBQztJQUNyRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gRmlsZTogc3RvcmFnZS9JREJNYW5hZ2VyLmpzXG5cbmltcG9ydCB7IElEQk1hbmFnZXJJbnRlcmZhY2UsIFNlcnZpY2VzSW50ZXJmYWNlIH0gZnJvbSAnLi4vdHlwZXMvaW5kZXguanMnO1xuaW1wb3J0IHsgZGF0YSB9IGZyb20gJy4uL2NvbmZpZy9pbmRleC5qcyc7XG5cbmNvbnN0IGRiTmFtZSA9IGRhdGEuc3RvcmFnZS5pZGIuZGJOYW1lO1xuY29uc3QgZGVmYXVsdFZlcnNvbiA9IGRhdGEuc3RvcmFnZS5pZGIuZGVmYXVsdFZlcnNpb247XG5jb25zdCBzdG9yZU5hbWUgPSBkYXRhLnN0b3JhZ2UuaWRiLnN0b3JlTmFtZTtcblxuZXhwb3J0IGNsYXNzIElEQk1hbmFnZXIgaW1wbGVtZW50cyBJREJNYW5hZ2VySW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IElEQk1hbmFnZXIgfCBudWxsID0gbnVsbDtcblx0cHJpdmF0ZSBkZWZhdWx0VmVyc2lvbjogbnVtYmVyO1xuXHRwcml2YXRlIHZlcnNpb246IG51bWJlcjtcblx0cHJpdmF0ZSBkYjogSURCRGF0YWJhc2UgfCBudWxsID0gbnVsbDtcblx0cHJpdmF0ZSBsb2c6IFNlcnZpY2VzSW50ZXJmYWNlWydsb2cnXTtcblx0cHJpdmF0ZSBlcnJvcnM6IFNlcnZpY2VzSW50ZXJmYWNlWydlcnJvcnMnXTtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKHNlcnZpY2VzOiBTZXJ2aWNlc0ludGVyZmFjZSkge1xuXHRcdHRoaXMuZGVmYXVsdFZlcnNpb24gPSBkZWZhdWx0VmVyc29uO1xuXHRcdHRoaXMudmVyc2lvbiA9IHRoaXMuZGVmYXVsdFZlcnNpb247XG5cdFx0dGhpcy5sb2cgPSBzZXJ2aWNlcy5sb2c7XG5cdFx0dGhpcy5lcnJvcnMgPSBzZXJ2aWNlcy5lcnJvcnM7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGdldEluc3RhbmNlKHNlcnZpY2VzOiBTZXJ2aWNlc0ludGVyZmFjZSk6IElEQk1hbmFnZXIge1xuXHRcdGlmICghSURCTWFuYWdlci5pbnN0YW5jZSkge1xuXHRcdFx0SURCTWFuYWdlci5pbnN0YW5jZSA9IG5ldyBJREJNYW5hZ2VyKHNlcnZpY2VzKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gSURCTWFuYWdlci5pbnN0YW5jZTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBpbml0KCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdHJldHVybiB0aGlzLmVycm9ycy5oYW5kbGVBc3luYyhhc3luYyAoKSA9PiB7XG5cdFx0XHRpZiAoIXdpbmRvdy5pbmRleGVkREIpIHtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdJbmRleGVkREIgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGlzIGJyb3dzZXInKTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc29sZS5sb2coJ1tJREJNYW5hZ2VyLmluaXRdIE9wZW5pbmcgSW5kZXhlZERCLi4uJyk7XG5cdFx0XHRjb25zdCByZXF1ZXN0ID0gaW5kZXhlZERCLm9wZW4oZGJOYW1lLCB0aGlzLnZlcnNpb24pO1xuXG5cdFx0XHRyZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHRyZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IGV2ZW50ID0+IHtcblx0XHRcdFx0XHRjb25zdCBkYiA9IChldmVudC50YXJnZXQgYXMgSURCT3BlbkRCUmVxdWVzdCkucmVzdWx0O1xuXHRcdFx0XHRcdGlmICghZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhzdG9yZU5hbWUpKSB7XG5cdFx0XHRcdFx0XHRkYi5jcmVhdGVPYmplY3RTdG9yZShzdG9yZU5hbWUsIHtcblx0XHRcdFx0XHRcdFx0a2V5UGF0aDogJ2lkJyxcblx0XHRcdFx0XHRcdFx0YXV0b0luY3JlbWVudDogdHJ1ZVxuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhcblx0XHRcdFx0XHRcdFx0YFtJREJNYW5hZ2VyLmluaXRdIENyZWF0ZWQgb2JqZWN0IHN0b3JlOiAke3N0b3JlTmFtZX1gXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fTtcblxuXHRcdFx0XHRyZXF1ZXN0Lm9uc3VjY2VzcyA9IGV2ZW50ID0+IHtcblx0XHRcdFx0XHR0aGlzLmRiID0gKGV2ZW50LnRhcmdldCBhcyBJREJPcGVuREJSZXF1ZXN0KS5yZXN1bHQ7XG5cdFx0XHRcdFx0dGhpcy5kYi5vbnZlcnNpb25jaGFuZ2UgPSAoKSA9PiB7XG5cdFx0XHRcdFx0XHR0aGlzLmRiPy5jbG9zZSgpO1xuXHRcdFx0XHRcdFx0dGhpcy5sb2coXG5cdFx0XHRcdFx0XHRcdCdJbmRleGVkREIgdmVyc2lvbiBjaGFuZ2VkLCBjbG9zaW5nIGRhdGFiYXNlJyxcblx0XHRcdFx0XHRcdFx0J3dhcm4nXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0cmVzb2x2ZSh0cnVlKTtcblx0XHRcdFx0fTtcblxuXHRcdFx0XHRyZXF1ZXN0Lm9uZXJyb3IgPSBldmVudCA9PiB7XG5cdFx0XHRcdFx0cmVqZWN0KFxuXHRcdFx0XHRcdFx0KGV2ZW50LnRhcmdldCBhcyBJREJPcGVuREJSZXF1ZXN0KS5lcnJvcj8ubWVzc2FnZSB8fFxuXHRcdFx0XHRcdFx0XHQnVW5rbm93biBJREJNYW5hZ2VyLmluaXQoKSBlcnJvcidcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9O1xuXHRcdFx0fSk7XG5cdFx0fSwgJ0ZhaWxlZCB0byBpbml0aWFsaXplIEluZGV4ZWREQicpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGVuc3VyZURCUmVhZHkoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0d2hpbGUgKCF0aGlzLmRiKSB7XG5cdFx0XHR0aGlzLmxvZygnV2FpdGluZyBmb3IgSW5kZXhlZERCIHRvIGluaXRpYWxpemUuLi4nLCAnd2FybicpO1xuXHRcdFx0YXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwKSk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGNsZWFyKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGF3YWl0IHRoaXMuZXJyb3JzLmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHtcblx0XHRcdGNvbnN0IHN0b3JlID0gdGhpcy5nZXRUcmFuc2FjdGlvbigncmVhZHdyaXRlJyk7XG5cdFx0XHRpZiAoIXN0b3JlKSB0aHJvdyBuZXcgRXJyb3IoJ0luZGV4ZWREQiBpcyBub3QgaW5pdGlhbGl6ZWQuJyk7XG5cblx0XHRcdGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdFx0Y29uc3QgcmVxdWVzdCA9IHN0b3JlLmNsZWFyKCk7XG5cdFx0XHRcdHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4gcmVzb2x2ZSgpO1xuXHRcdFx0XHRyZXF1ZXN0Lm9uZXJyb3IgPSBldmVudCA9PlxuXHRcdFx0XHRcdHJlamVjdChcblx0XHRcdFx0XHRcdChldmVudC50YXJnZXQgYXMgSURCUmVxdWVzdCkuZXJyb3I/Lm1lc3NhZ2UgfHxcblx0XHRcdFx0XHRcdFx0J1Vua25vd24gSURCTWFuYWdlci5jbGVhcigpIGVycm9yJ1xuXHRcdFx0XHRcdCk7XG5cdFx0XHR9KTtcblx0XHR9LCAnRmFpbGVkIHRvIGNsZWFyIEluZGV4ZWREQicpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldEl0ZW08VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCBudWxsPiB7XG5cdFx0YXdhaXQgdGhpcy5lbnN1cmVEQlJlYWR5KCk7XG5cblx0XHRyZXR1cm4gdGhpcy5lcnJvcnMuaGFuZGxlQXN5bmMoYXN5bmMgKCkgPT4ge1xuXHRcdFx0Y29uc3Qgc3RvcmUgPSB0aGlzLmdldFRyYW5zYWN0aW9uKCdyZWFkb25seScpO1xuXHRcdFx0aWYgKCFzdG9yZSkgdGhyb3cgbmV3IEVycm9yKCdJbmRleGVkREIgaXMgbm90IGluaXRpYWxpemVkLicpO1xuXG5cdFx0XHRyZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8VCB8IG51bGw+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdFx0Y29uc3QgcmVxdWVzdCA9IHN0b3JlLmdldChrZXkpO1xuXHRcdFx0XHRyZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+XG5cdFx0XHRcdFx0cmVzb2x2ZShyZXF1ZXN0LnJlc3VsdD8udmFsdWUgPz8gbnVsbCk7XG5cdFx0XHRcdHJlcXVlc3Qub25lcnJvciA9IGV2ZW50ID0+XG5cdFx0XHRcdFx0cmVqZWN0KFxuXHRcdFx0XHRcdFx0KGV2ZW50LnRhcmdldCBhcyBJREJSZXF1ZXN0KS5lcnJvcj8ubWVzc2FnZSB8fFxuXHRcdFx0XHRcdFx0XHQnVW5rbm93biBJREJNYW5hZ2VyLmdldEl0ZW0oKSBlcnJvcidcblx0XHRcdFx0XHQpO1xuXHRcdFx0fSk7XG5cdFx0fSwgYEZhaWxlZCB0byByZXRyaWV2ZSBpdGVtICR7a2V5fSBmcm9tIEluZGV4ZWREQmApO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHNldEl0ZW0oa2V5OiBzdHJpbmcsIHZhbHVlOiB1bmtub3duKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy5lcnJvcnMuaGFuZGxlQXN5bmMoYXN5bmMgKCkgPT4ge1xuXHRcdFx0Y29uc3Qgc3RvcmUgPSB0aGlzLmdldFRyYW5zYWN0aW9uKCdyZWFkd3JpdGUnKTtcblx0XHRcdGlmICghc3RvcmUpIHRocm93IG5ldyBFcnJvcignSW5kZXhlZERCIGlzIG5vdCBpbml0aWFsaXplZC4nKTtcblxuXHRcdFx0YXdhaXQgbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHRjb25zdCByZXF1ZXN0ID0gc3RvcmUucHV0KHsgaWQ6IGtleSwgdmFsdWUgfSk7XG5cdFx0XHRcdHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4gcmVzb2x2ZSgpO1xuXHRcdFx0XHRyZXF1ZXN0Lm9uZXJyb3IgPSBldmVudCA9PlxuXHRcdFx0XHRcdHJlamVjdChcblx0XHRcdFx0XHRcdChldmVudC50YXJnZXQgYXMgSURCUmVxdWVzdCkuZXJyb3I/Lm1lc3NhZ2UgfHxcblx0XHRcdFx0XHRcdFx0J1Vua25vd24gSURCTWFuYWdlci5zZXRJdGVtKCkgZXJyb3InXG5cdFx0XHRcdFx0KTtcblx0XHRcdH0pO1xuXHRcdH0sIGBGYWlsZWQgdG8gc3RvcmUgaXRlbSAke2tleX0gaW4gSW5kZXhlZERCYCk7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgcmVtb3ZlSXRlbShrZXk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGF3YWl0IHRoaXMuZXJyb3JzLmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHtcblx0XHRcdGNvbnN0IHN0b3JlID0gdGhpcy5nZXRUcmFuc2FjdGlvbigncmVhZHdyaXRlJyk7XG5cdFx0XHRpZiAoIXN0b3JlKSB0aHJvdyBuZXcgRXJyb3IoJ0luZGV4ZWREQiBpcyBub3QgaW5pdGlhbGl6ZWQuJyk7XG5cblx0XHRcdGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdFx0Y29uc3QgcmVxdWVzdCA9IHN0b3JlLmRlbGV0ZShrZXkpO1xuXHRcdFx0XHRyZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHJlc29sdmUoKTtcblx0XHRcdFx0cmVxdWVzdC5vbmVycm9yID0gZXZlbnQgPT5cblx0XHRcdFx0XHRyZWplY3QoXG5cdFx0XHRcdFx0XHQoZXZlbnQudGFyZ2V0IGFzIElEQlJlcXVlc3QpLmVycm9yPy5tZXNzYWdlIHx8XG5cdFx0XHRcdFx0XHRcdCdVbmtub3duIElEQk1hbmFnZXIucmVtb3ZlSXRlbSgpIGVycm9yJ1xuXHRcdFx0XHRcdCk7XG5cdFx0XHR9KTtcblx0XHR9LCBgRmFpbGVkIHRvIHJlbW92ZSBpdGVtICR7a2V5fSBmcm9tIEluZGV4ZWREQmApO1xuXHR9XG5cblx0cHJpdmF0ZSBnZXRUcmFuc2FjdGlvbihtb2RlOiBJREJUcmFuc2FjdGlvbk1vZGUpOiBJREJPYmplY3RTdG9yZSB8IHZvaWQge1xuXHRcdHJldHVybiB0aGlzLmVycm9ycy5oYW5kbGUoKCkgPT4ge1xuXHRcdFx0aWYgKCF0aGlzLmRiKSB0aHJvdyBuZXcgRXJyb3IoJ0luZGV4ZWREQiBpcyBub3QgaW5pdGlhbGl6ZWQuJyk7XG5cdFx0XHRjb25zdCB0cmFuc2FjdGlvbiA9IHRoaXMuZGIudHJhbnNhY3Rpb24oc3RvcmVOYW1lLCBtb2RlKTtcblx0XHRcdHJldHVybiB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpO1xuXHRcdH0sIGBGYWlsZWQgdG8gZ2V0IEluZGV4ZWREQiB0cmFuc2FjdGlvbiAoJHttb2RlfSlgKTtcblx0fVxufVxuIl19