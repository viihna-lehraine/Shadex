{"version":3,"file":"IDBManager.js","sources":["../../../../src/storage/IDBManager.ts"],"sourcesContent":["// File: storage/IDBManager.js\n\nimport { IDBManagerClassInterface, ServicesInterface } from '../types/index.js';\nimport { data } from '../data/index.js';\n\nconst dbName = data.storage.idb.dbName;\nconst defaultVerson = data.storage.idb.defaultVersion;\nconst storeName = data.storage.idb.storeName;\n\nexport class IDBManager implements IDBManagerClassInterface {\n\tprivate static instance: IDBManager | null = null;\n\tprivate defaultVersion: number;\n\tprivate version: number;\n\tprivate db: IDBDatabase | null = null;\n\tprivate log: ServicesInterface['log'];\n\tprivate errors: ServicesInterface['errors'];\n\n\tprivate constructor(services: ServicesInterface) {\n\t\tthis.defaultVersion = defaultVerson;\n\t\tthis.version = this.defaultVersion;\n\t\tthis.log = services.log;\n\t\tthis.errors = services.errors;\n\t}\n\n\tpublic static getInstance(services: ServicesInterface): IDBManager {\n\t\tif (!IDBManager.instance) {\n\t\t\tIDBManager.instance = new IDBManager(services);\n\t\t}\n\n\t\treturn IDBManager.instance;\n\t}\n\n\tpublic async init(): Promise<boolean> {\n\t\treturn this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tif (!window.indexedDB) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t'IndexedDB is not supported in this browser'\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconsole.log('[IDBManager.init] Opening IndexedDB...');\n\t\t\t\tconst request = indexedDB.open(dbName, this.version);\n\n\t\t\t\treturn await new Promise((resolve, reject) => {\n\t\t\t\t\trequest.onupgradeneeded = event => {\n\t\t\t\t\t\tconst db = (event.target as IDBOpenDBRequest).result;\n\t\t\t\t\t\tif (!db.objectStoreNames.contains(storeName)) {\n\t\t\t\t\t\t\tdb.createObjectStore(storeName, {\n\t\t\t\t\t\t\t\tkeyPath: 'id',\n\t\t\t\t\t\t\t\tautoIncrement: true\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`[IDBManager.init] Created object store: ${storeName}`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\trequest.onsuccess = event => {\n\t\t\t\t\t\tthis.db = (event.target as IDBOpenDBRequest).result;\n\t\t\t\t\t\tthis.db.onversionchange = () => {\n\t\t\t\t\t\t\tthis.db?.close();\n\t\t\t\t\t\t\tthis.log(\n\t\t\t\t\t\t\t\t'warn',\n\t\t\t\t\t\t\t\t'IndexedDB version changed, closing database',\n\t\t\t\t\t\t\t\t'IDBManager.init()'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t};\n\t\t\t\t\t\tresolve(true);\n\t\t\t\t\t};\n\n\t\t\t\t\trequest.onerror = event => {\n\t\t\t\t\t\treject(\n\t\t\t\t\t\t\t(event.target as IDBOpenDBRequest).error?.message ||\n\t\t\t\t\t\t\t\t'Unknown error'\n\t\t\t\t\t\t);\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t},\n\t\t\t'Failed to initialize IndexedDB',\n\t\t\t'IDBManager.init()'\n\t\t);\n\t}\n\n\tpublic async ensureDBReady(): Promise<void> {\n\t\twhile (!this.db) {\n\t\t\tthis.log(\n\t\t\t\t'warn',\n\t\t\t\t'Waiting for IndexedDB to initialize...',\n\t\t\t\t'IDBManager.ensureDBReady()'\n\t\t\t);\n\t\t\tawait new Promise(resolve => setTimeout(resolve, 50));\n\t\t}\n\t}\n\n\tpublic async clear(): Promise<void> {\n\t\tawait this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tconst store = this.getTransaction('readwrite');\n\t\t\t\tif (!store) throw new Error('IndexedDB is not initialized.');\n\n\t\t\t\tawait new Promise<void>((resolve, reject) => {\n\t\t\t\t\tconst request = store.clear();\n\t\t\t\t\trequest.onsuccess = () => resolve();\n\t\t\t\t\trequest.onerror = event =>\n\t\t\t\t\t\treject(\n\t\t\t\t\t\t\t(event.target as IDBRequest).error?.message ||\n\t\t\t\t\t\t\t\t'Unknown error'\n\t\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t},\n\t\t\t'Failed to clear IndexedDB',\n\t\t\t'IDBManager.clear()'\n\t\t);\n\t}\n\n\tpublic async getItem<T>(key: string): Promise<T | null> {\n\t\tawait this.ensureDBReady();\n\n\t\treturn this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tconst store = this.getTransaction('readonly');\n\t\t\t\tif (!store) throw new Error('IndexedDB is not initialized.');\n\n\t\t\t\treturn await new Promise<T | null>((resolve, reject) => {\n\t\t\t\t\tconst request = store.get(key);\n\t\t\t\t\trequest.onsuccess = () =>\n\t\t\t\t\t\tresolve(request.result?.value ?? null);\n\t\t\t\t\trequest.onerror = event =>\n\t\t\t\t\t\treject(\n\t\t\t\t\t\t\t(event.target as IDBRequest).error?.message ||\n\t\t\t\t\t\t\t\t'Unknown error'\n\t\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t},\n\t\t\t`Failed to retrieve item ${key} from IndexedDB`,\n\t\t\t'IDBManager.getItem()'\n\t\t);\n\t}\n\n\tpublic async setItem(key: string, value: unknown): Promise<void> {\n\t\tawait this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tconst store = this.getTransaction('readwrite');\n\t\t\t\tif (!store) throw new Error('IndexedDB is not initialized.');\n\n\t\t\t\tawait new Promise<void>((resolve, reject) => {\n\t\t\t\t\tconst request = store.put({ id: key, value });\n\t\t\t\t\trequest.onsuccess = () => resolve();\n\t\t\t\t\trequest.onerror = event =>\n\t\t\t\t\t\treject(\n\t\t\t\t\t\t\t(event.target as IDBRequest).error?.message ||\n\t\t\t\t\t\t\t\t'Unknown error'\n\t\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t},\n\t\t\t`Failed to store item ${key} in IndexedDB`,\n\t\t\t'IDBManager.setItem()'\n\t\t);\n\t}\n\n\tpublic async removeItem(key: string): Promise<void> {\n\t\tawait this.errors.handleAsync(\n\t\t\tasync () => {\n\t\t\t\tconst store = this.getTransaction('readwrite');\n\t\t\t\tif (!store) throw new Error('IndexedDB is not initialized.');\n\n\t\t\t\tawait new Promise<void>((resolve, reject) => {\n\t\t\t\t\tconst request = store.delete(key);\n\t\t\t\t\trequest.onsuccess = () => resolve();\n\t\t\t\t\trequest.onerror = event =>\n\t\t\t\t\t\treject(\n\t\t\t\t\t\t\t(event.target as IDBRequest).error?.message ||\n\t\t\t\t\t\t\t\t'Unknown error'\n\t\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t},\n\t\t\t`Failed to remove item ${key} from IndexedDB`,\n\t\t\t'IDBManager.removeItem()'\n\t\t);\n\t}\n\n\tprivate getTransaction(mode: IDBTransactionMode): IDBObjectStore | void {\n\t\treturn this.errors.handle(\n\t\t\t() => {\n\t\t\t\tif (!this.db) throw new Error('IndexedDB is not initialized.');\n\t\t\t\tconst transaction = this.db.transaction(storeName, mode);\n\t\t\t\treturn transaction.objectStore(storeName);\n\t\t\t},\n\t\t\t`Failed to get IndexedDB transaction (${mode})`,\n\t\t\t'IDBManager.getTransaction'\n\t\t);\n\t}\n}\n"],"names":[],"mappings":"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"}