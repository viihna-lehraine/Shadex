import { guards } from '../utils/type-guards.js';
import { convert } from '../color-conversion/conversion-index.js';
import { random } from '../utils/color-randomizer.js';
import { parseCustomColor } from '../utils/transforms.js';
import { getConversionFn } from '../color-conversion/conversion.js';
import { startPaletteGen } from '../palette-gen/generate.js';
export function applyFirstColorToUI(initialColorSpace) {
    const color = random.randomColor(initialColorSpace);
    const colorBox1 = document.getElementById('color-box-1');
    if (colorBox1) {
        let colorString;
        if (guards.isCMYK(color)) {
            colorString = `cmyk(${color.value.cyan}, ${color.value.magenta}, ${color.value.yellow}, ${color.value.key})`;
        }
        else if (guards.isHex(color)) {
            colorString = color.value.hex;
        }
        else if (guards.isRGB(color)) {
            colorString = `rgb(${color.value.red}, ${color.value.green}, ${color.value.blue})`;
        }
        else if (guards.isHSL(color)) {
            colorString = `hsl(${color.value.hue}, ${color.value.saturation}%, ${color.value.lightness}%)`;
        }
        else if (guards.isHSV(color)) {
            colorString = `hsv(${color.value.hue}, ${color.value.saturation}%, ${color.value.value}%)`;
        }
        else if (guards.isLAB(color)) {
            colorString = `lab(${color.value.l}, ${color.value.a}, ${color.value.b})`;
        }
        else {
            console.error('Unexpected color format');
            return color;
        }
        colorBox1.style.backgroundColor = colorString;
        if (color.format === 'hsl') {
            populateColorTextOutputBox(color, 1);
        }
        else {
            console.error('Logic not yet implemented for cases where intiialColorSpace !== hsl!');
        }
    }
    else {
        console.error('color-box-1 is null');
    }
    return color;
}
export function populateColorTextOutputBox(color, boxNumber) {
    const colorTextOutputBox = document.getElementById(`color-text-output-box-${boxNumber}`);
    if (!colorTextOutputBox)
        return;
    // convert color to Hex for display purposes
    let hexColor = null;
    if (color.format === 'cmyk') {
        hexColor = convert.cmykToHex(color);
    }
    else if (color.format === 'hex') {
        hexColor = color;
    }
    else if (color.format === 'hsl') {
        hexColor = convert.hslToHex(color);
    }
    else if (color.format === 'hsv') {
        hexColor = convert.hsvToHex(color);
    }
    else if (color.format === 'lab') {
        hexColor = convert.labToHex(color);
    }
    else if (color.format === 'rgb') {
        hexColor = convert.rgbToHex(color);
    }
    else {
        console.error('Unexpected color format');
        return;
    }
    if (hexColor) {
        colorTextOutputBox.value = hexColor.value.hex;
        colorTextOutputBox.setAttribute('data-format', 'hex');
    }
}
export function getElementsForSelectedColor(selectedColor) {
    return {
        selectedColorTextOutputBox: document.getElementById(`color-text-output-box-${selectedColor}`),
        selectedColorBox: document.getElementById(`color-box-${selectedColor}`),
        selectedColorStripe: document.getElementById(`color-stripe-${selectedColor}`)
    };
}
// *DEV NOTE: add saturation logic and function type
export function saturateColor(selectedColor) {
    getElementsForSelectedColor(selectedColor);
}
// *DEV NOTE: add desaturation logic and function type
export function desaturateColor(selectedColor) {
    getElementsForSelectedColor(selectedColor);
}
export function showTooltip(tooltipElement) {
    const tooltip = tooltipElement.querySelector('.tooltiptext');
    if (tooltip) {
        tooltip.style.visibility = 'visible';
        tooltip.style.opacity = '1';
        setTimeout(() => {
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
        }, 1000);
    }
    console.log('execution of showTooltip complete');
}
export function showCustomColorPopupDiv() {
    const popup = document.getElementById('popup-div');
    if (popup) {
        popup.classList.toggle('show');
    }
    else {
        console.error("document.getElementById('popup-div') is undefined");
        return;
    }
}
export function applyCustomColor() {
    const customHexBase = document.getElementById('custom-color-picker').value;
    const customHex = {
        value: { hex: customHexBase },
        format: 'hex'
    };
    if (!guards.isHexColor(customHexBase)) {
        throw new Error('Invalid hex color');
    }
    const customHSL = convert.hexToHSL(customHex);
    return customHSL;
}
export function applyInitialColorSpace() {
    const initialColorSpaceValue = document.getElementById('initial-colorspace-options').value;
    return guards.isColorSpace(initialColorSpaceValue)
        ? initialColorSpaceValue
        : 'hex';
}
export function copyToClipboard(text, tooltipElement) {
    const colorValue = text.replace('Copied to clipboard!', '').trim();
    navigator.clipboard
        .writeText(colorValue)
        .then(() => {
        showTooltip(tooltipElement);
        console.log(`Copied color value: ${colorValue}`);
    })
        .catch(err => {
        console.error('Error copying to clipboard:', err);
    });
}
export function convertColors(targetFormat) {
    const colorTextOutputBoxes = document.querySelectorAll('.color-text-output-box');
    colorTextOutputBoxes.forEach(box => {
        if (!(box instanceof HTMLInputElement)) {
            console.error('Invalid input element.');
            return;
        }
        const inputBox = box;
        const colorValues = inputBox.colorValues;
        if (!colorValues) {
            console.error('Missing color values.');
            return;
        }
        const currentFormat = inputBox.getAttribute('data-format');
        if (!guards.isColorSpace(currentFormat) ||
            !guards.isColorSpace(targetFormat)) {
            console.error(`Invalid format: ${currentFormat} or ${targetFormat}`);
            return;
        }
        const convertFn = getConversionFn(currentFormat, targetFormat);
        if (!convertFn) {
            console.error(`Conversion from ${currentFormat} to ${targetFormat} is not supported.`);
            return;
        }
        if (guards.isConvertibleColor(colorValues)) {
            const newColor = convertFn(colorValues);
            if (!newColor) {
                console.error(`Conversion to ${targetFormat} failed.`);
                return;
            }
            inputBox.value = String(newColor);
            inputBox.setAttribute('data-format', targetFormat);
        }
        else {
            console.error(`Invalid color type for conversion.`);
        }
    });
}
export function getGenerateButtonParams() {
    const paletteTypeOptions = document.getElementById('palette-type-options');
    const paletteNumberOptions = document.getElementById('palette-number-options');
    const colorSpaceValue = document.getElementById('initial-colorspace-options')?.value;
    const initialColorSpace = guards.isColorSpace(colorSpaceValue)
        ? colorSpaceValue
        : 'hex';
    const customColorRaw = document.getElementById('custom-color')?.value;
    const customColor = parseCustomColor(initialColorSpace, customColorRaw);
    return {
        numBoxes: parseInt(paletteNumberOptions.value, 10),
        paletteType: parseInt(paletteTypeOptions.value, 10),
        initialColorSpace,
        customColor
    };
}
export function handleGenButtonClick() {
    const { paletteType, numBoxes, initialColorSpace: space, customColor } = getGenerateButtonParams();
    if (!paletteType || !numBoxes) {
        console.error('paletteType and/or numBoxes are undefined');
        return;
    }
    const initialColorSpace = space ?? 'hex';
    startPaletteGen(paletteType, numBoxes, initialColorSpace, customColor);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLW1haW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZG9tL2RvbS1tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDL0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNqRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFMUQsTUFBTSxVQUFVLG1CQUFtQixDQUNsQyxpQkFBbUM7SUFFbkMsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQ3BELE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLENBQUM7SUFFekQsSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUNmLElBQUksV0FBbUIsQ0FBQztRQUV4QixJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUMxQixXQUFXLEdBQUcsUUFBUSxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sS0FBSyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQzlHLENBQUM7YUFBTSxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUNoQyxXQUFXLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7UUFDL0IsQ0FBQzthQUFNLElBQUksTUFB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QixLQUFLLElBQUksS0FBSyxDQUFDO0lBRTNELGVBQWUsQ0FBQyxXQUFXLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ3hFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB0eXBlcyBmcm9tICcuLi9pbmRleCc7XG5pbXBvcnQgeyBndWFyZHMgfSBmcm9tICcuLi91dGlscy90eXBlLWd1YXJkcyc7XG5pbXBvcnQgeyBjb252ZXJ0IH0gZnJvbSAnLi4vY29sb3ItY29udmVyc2lvbi9jb252ZXJzaW9uLWluZGV4JztcbmltcG9ydCB7IHJhbmRvbSB9IGZyb20gJy4uL3V0aWxzL2NvbG9yLXJhbmRvbWl6ZXInO1xuaW1wb3J0IHsgcGFyc2VDdXN0b21Db2xvciB9IGZyb20gJy4uL3V0aWxzL3RyYW5zZm9ybXMnO1xuaW1wb3J0IHsgZ2V0Q29udmVyc2lvbkZuIH0gZnJvbSAnLi4vY29sb3ItY29udmVyc2lvbi9jb252ZXJzaW9uJztcbmltcG9ydCB7IHN0YXJ0UGFsZXR0ZUdlbiB9IGZyb20gJy4uL3BhbGV0dGUtZ2VuL2dlbmVyYXRlJztcblxuZXhwb3J0IGZ1bmN0aW9uIGFwcGx5Rmlyc3RDb2xvclRvVUkoXG5cdGluaXRpYWxDb2xvclNwYWNlOiB0eXBlcy5Db2xvclNwYWNlXG4pOiB0eXBlcy5Db2xvciB7XG5cdGNvbnN0IGNvbG9yID0gcmFuZG9tLnJhbmRvbUNvbG9yKGluaXRpYWxDb2xvclNwYWNlKTtcblx0Y29uc3QgY29sb3JCb3gxID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbG9yLWJveC0xJyk7XG5cblx0aWYgKGNvbG9yQm94MSkge1xuXHRcdGxldCBjb2xvclN0cmluZzogc3RyaW5nO1xuXG5cdFx0aWYgKGd1YXJkcy5pc0NNWUsoY29sb3IpKSB7XG5cdFx0XHRjb2xvclN0cmluZyA9IGBjbXlrKCR7Y29sb3IudmFsdWUuY3lhbn0sICR7Y29sb3IudmFsdWUubWFnZW50YX0sICR7Y29sb3IudmFsdWUueWVsbG93fSwgJHtjb2xvci52YWx1ZS5rZXl9KWA7XG5cdFx0fSBlbHNlIGlmIChndWFyZHMuaXNIZXgoY29sb3IpKSB7XG5cdFx0XHRjb2xvclN0cmluZyA9IGNvbG9yLnZhbHVlLmhleDtcblx0XHR9IGVsc2UgaWYgKGd1YXJkcy5pc1JHQihjb2xvcikpIHtcblx0XHRcdGNvbG9yU3RyaW5nID0gYHJnYigke2NvbG9yLnZhbHVlLnJlZH0sICR7Y29sb3IudmFsdWUuZ3JlZW59LCAke2NvbG9yLnZhbHVlLmJsdWV9KWA7XG5cdFx0fSBlbHNlIGlmIChndWFyZHMuaXNIU0woY29sb3IpKSB7XG5cdFx0XHRjb2xvclN0cmluZyA9IGBoc2woJHtjb2xvci52YWx1ZS5odWV9LCAke2NvbG9yLnZhbHVlLnNhdHVyYXRpb259JSwgJHtjb2xvci52YWx1ZS5saWdodG5lc3N9JSlgO1xuXHRcdH0gZWxzZSBpZiAoZ3VhcmRzLmlzSFNWKGNvbG9yKSkge1xuXHRcdFx0Y29sb3JTdHJpbmcgPSBgaHN2KCR7Y29sb3IudmFsdWUuaHVlfSwgJHtjb2xvci52YWx1ZS5zYXR1cmF0aW9ufSUsICR7Y29sb3IudmFsdWUudmFsdWV9JSlgO1xuXHRcdH0gZWxzZSBpZiAoZ3VhcmRzLmlzTEFCKGNvbG9yKSkge1xuXHRcdFx0Y29sb3JTdHJpbmcgPSBgbGFiKCR7Y29sb3IudmFsdWUubH0sICR7Y29sb3IudmFsdWUuYX0sICR7Y29sb3IudmFsdWUuYn0pYDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS5lcnJvcignVW5leHBlY3RlZCBjb2xvciBmb3JtYXQnKTtcblx0XHRcdHJldHVybiBjb2xvcjtcblx0XHR9XG5cblx0XHRjb2xvckJveDEuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3JTdHJpbmc7XG5cdFx0aWYgKGNvbG9yLmZvcm1hdCA9PT0gJ2hzbCcpIHtcblx0XHRcdHBvcHVsYXRlQ29sb3JUZXh0T3V0cHV0Qm94KGNvbG9yLCAxKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0J0xvZ2ljIG5vdCB5ZXQgaW1wbGVtZW50ZWQgZm9yIGNhc2VzIHdoZXJlIGludGlpYWxDb2xvclNwYWNlICE9PSBoc2whJ1xuXHRcdFx0KTtcblx0XHR9XG5cdH0gZWxzZSB7XG5cdFx0Y29uc29sZS5lcnJvcignY29sb3ItYm94LTEgaXMgbnVsbCcpO1xuXHR9XG5cblx0cmV0dXJuIGNvbG9yO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcG9wdWxhdGVDb2xvclRleHRPdXRwdXRCb3goXG5cdGNvbG9yOiBFeGNsdWRlPHR5cGVzLkNvbG9yLCB0eXBlcy5YWVo+LFxuXHRib3hOdW1iZXI6IG51bWJlclxuKTogdm9pZCB7XG5cdGNvbnN0IGNvbG9yVGV4dE91dHB1dEJveCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdGBjb2xvci10ZXh0LW91dHB1dC1ib3gtJHtib3hOdW1iZXJ9YFxuXHQpIGFzIEhUTUxJbnB1dEVsZW1lbnQgfCBudWxsO1xuXG5cdGlmICghY29sb3JUZXh0T3V0cHV0Qm94KSByZXR1cm47XG5cblx0Ly8gY29udmVydCBjb2xvciB0byBIZXggZm9yIGRpc3BsYXkgcHVycG9zZXNcblx0bGV0IGhleENvbG9yOiB0eXBlcy5IZXggfCBudWxsID0gbnVsbDtcblxuXHRpZiAoY29sb3IuZm9ybWF0ID09PSAnY215aycpIHtcblx0XHRoZXhDb2xvciA9IGNvbnZlcnQuY215a1RvSGV4KGNvbG9yIGFzIHR5cGVzLkNNWUspO1xuXHR9IGVsc2UgaWYgKGNvbG9yLmZvcm1hdCA9PT0gJ2hleCcpIHtcblx0XHRoZXhDb2xvciA9IGNvbG9yO1xuXHR9IGVsc2UgaWYgKGNvbG9yLmZvcm1hdCA9PT0gJ2hzbCcpIHtcblx0XHRoZXhDb2xvciA9IGNvbnZlcnQuaHNsVG9IZXgoY29sb3IgYXMgdHlwZXMuSFNMKTtcblx0fSBlbHNlIGlmIChjb2xvci5mb3JtYXQgPT09ICdoc3YnKSB7XG5cdFx0aGV4Q29sb3IgPSBjb252ZXJ0LmhzdlRvSGV4KGNvbG9yIGFzIHR5cGVzLkhTVik7XG5cdH0gZWxzZSBpZiAoY29sb3IuZm9ybWF0ID09PSAnbGFiJykge1xuXHRcdGhleENvbG9yID0gY29udmVydC5sYWJUb0hleChjb2xvciBhcyB0eXBlcy5MQUIpO1xuXHR9IGVsc2UgaWYgKGNvbG9yLmZvcm1hdCA9PT0gJ3JnYicpIHtcblx0XHRoZXhDb2xvciA9IGNvbnZlcnQucmdiVG9IZXgoY29sb3IgYXMgdHlwZXMuUkdCKTtcblx0fSBlbHNlIHtcblx0XHRjb25zb2xlLmVycm9yKCdVbmV4cGVjdGVkIGNvbG9yIGZvcm1hdCcpO1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGlmIChoZXhDb2xvcikge1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC52YWx1ZSA9IGhleENvbG9yLnZhbHVlLmhleDtcblx0XHRjb2xvclRleHRPdXRwdXRCb3guc2V0QXR0cmlidXRlKCdkYXRhLWZvcm1hdCcsICdoZXgnKTtcblx0fVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RWxlbWVudHNGb3JTZWxlY3RlZENvbG9yKFxuXHRzZWxlY3RlZENvbG9yOiBudW1iZXJcbik6IHR5cGVzLkdldEVsZW1lbnRzRm9yU2VsZWN0ZWRDb2xvciB7XG5cdHJldHVybiB7XG5cdFx0c2VsZWN0ZWRDb2xvclRleHRPdXRwdXRCb3g6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdFx0YGNvbG9yLXRleHQtb3V0cHV0LWJveC0ke3NlbGVjdGVkQ29sb3J9YFxuXHRcdCksXG5cdFx0c2VsZWN0ZWRDb2xvckJveDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGNvbG9yLWJveC0ke3NlbGVjdGVkQ29sb3J9YCksXG5cdFx0c2VsZWN0ZWRDb2xvclN0cmlwZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXG5cdFx0XHRgY29sb3Itc3RyaXBlLSR7c2VsZWN0ZWRDb2xvcn1gXG5cdFx0KVxuXHR9O1xufVxuXG4vLyAqREVWIE5PVEU6IGFkZCBzYXR1cmF0aW9uIGxvZ2ljIGFuZCBmdW5jdGlvbiB0eXBlXG5leHBvcnQgZnVuY3Rpb24gc2F0dXJhdGVDb2xvcihzZWxlY3RlZENvbG9yOiBudW1iZXIpIHtcblx0Z2V0RWxlbWVudHNGb3JTZWxlY3RlZENvbG9yKHNlbGVjdGVkQ29sb3IpO1xufVxuXG4vLyAqREVWIE5PVEU6IGFkZCBkZXNhdHVyYXRpb24gbG9naWMgYW5kIGZ1bmN0aW9uIHR5cGVcbmV4cG9ydCBmdW5jdGlvbiBkZXNhdHVyYXRlQ29sb3Ioc2VsZWN0ZWRDb2xvcjogbnVtYmVyKSB7XG5cdGdldEVsZW1lbnRzRm9yU2VsZWN0ZWRDb2xvcihzZWxlY3RlZENvbG9yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNob3dUb29sdGlwKHRvb2x0aXBFbGVtZW50OiBIVE1MRWxlbWVudCk6IHZvaWQge1xuXHRjb25zdCB0b29sdGlwID0gdG9vbHRpcEVsZW1lbnQucXVlcnlTZWxlY3RvcjxIVE1MRWxlbWVudD4oJy50b29sdGlwdGV4dCcpO1xuXHRpZiAodG9vbHRpcCkge1xuXHRcdHRvb2x0aXAuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJztcblx0XHR0b29sdGlwLnN0eWxlLm9wYWNpdHkgPSAnMSc7XG5cdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHR0b29sdGlwLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJztcblx0XHRcdHRvb2x0aXAuc3R5bGUub3BhY2l0eSA9ICcwJztcblx0XHR9LCAxMDAwKTtcblx0fVxuXG5cdGNvbnNvbGUubG9nKCdleGVjdXRpb24gb2Ygc2hvd1Rvb2x0aXAgY29tcGxldGUnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNob3dDdXN0b21Db2xvclBvcHVwRGl2KCk6IHZvaWQge1xuXHRjb25zdCBwb3B1cCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwb3B1cC1kaXYnKTtcblxuXHRpZiAocG9wdXApIHtcblx0XHRwb3B1cC5jbGFzc0xpc3QudG9nZ2xlKCdzaG93Jyk7XG5cdH0gZWxzZSB7XG5cdFx0Y29uc29sZS5lcnJvcihcImRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwb3B1cC1kaXYnKSBpcyB1bmRlZmluZWRcIik7XG5cdFx0cmV0dXJuO1xuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhcHBseUN1c3RvbUNvbG9yKCk6IHR5cGVzLkhTTCB7XG5cdGNvbnN0IGN1c3RvbUhleEJhc2UgPSAoXG5cdFx0ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1c3RvbS1jb2xvci1waWNrZXInKSBhcyBIVE1MSW5wdXRFbGVtZW50XG5cdCkudmFsdWU7XG5cdGNvbnN0IGN1c3RvbUhleDogdHlwZXMuSGV4ID0ge1xuXHRcdHZhbHVlOiB7IGhleDogY3VzdG9tSGV4QmFzZSB9LFxuXHRcdGZvcm1hdDogJ2hleCdcblx0fTtcblxuXHRpZiAoIWd1YXJkcy5pc0hleENvbG9yKGN1c3RvbUhleEJhc2UpKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGhleCBjb2xvcicpO1xuXHR9XG5cblx0Y29uc3QgY3VzdG9tSFNMID0gY29udmVydC5oZXhUb0hTTChjdXN0b21IZXgpO1xuXG5cdHJldHVybiBjdXN0b21IU0w7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhcHBseUluaXRpYWxDb2xvclNwYWNlKCk6IHR5cGVzLkNvbG9yU3BhY2Uge1xuXHRjb25zdCBpbml0aWFsQ29sb3JTcGFjZVZhbHVlID0gKFxuXHRcdGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdFx0J2luaXRpYWwtY29sb3JzcGFjZS1vcHRpb25zJ1xuXHRcdCkgYXMgSFRNTFNlbGVjdEVsZW1lbnRcblx0KS52YWx1ZTtcblxuXHRyZXR1cm4gZ3VhcmRzLmlzQ29sb3JTcGFjZShpbml0aWFsQ29sb3JTcGFjZVZhbHVlKVxuXHRcdD8gaW5pdGlhbENvbG9yU3BhY2VWYWx1ZVxuXHRcdDogJ2hleCc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb3B5VG9DbGlwYm9hcmQoXG5cdHRleHQ6IHN0cmluZyxcblx0dG9vbHRpcEVsZW1lbnQ6IEhUTUxFbGVtZW50XG4pOiB2b2lkIHtcblx0Y29uc3QgY29sb3JWYWx1ZSA9IHRleHQucmVwbGFjZSgnQ29waWVkIHRvIGNsaXBib2FyZCEnLCAnJykudHJpbSgpO1xuXG5cdG5hdmlnYXRvci5jbGlwYm9hcmRcblx0XHQud3JpdGVUZXh0KGNvbG9yVmFsdWUpXG5cdFx0LnRoZW4oKCkgPT4ge1xuXHRcdFx0c2hvd1Rvb2x0aXAodG9vbHRpcEVsZW1lbnQpO1xuXHRcdFx0Y29uc29sZS5sb2coYENvcGllZCBjb2xvciB2YWx1ZTogJHtjb2xvclZhbHVlfWApO1xuXHRcdH0pXG5cdFx0LmNhdGNoKGVyciA9PiB7XG5cdFx0XHRjb25zb2xlLmVycm9yKCdFcnJvciBjb3B5aW5nIHRvIGNsaXBib2FyZDonLCBlcnIpO1xuXHRcdH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29udmVydENvbG9ycyh0YXJnZXRGb3JtYXQ6IHR5cGVzLkNvbG9yU3BhY2UpOiB2b2lkIHtcblx0Y29uc3QgY29sb3JUZXh0T3V0cHV0Qm94ZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsPEhUTUxJbnB1dEVsZW1lbnQ+KFxuXHRcdCcuY29sb3ItdGV4dC1vdXRwdXQtYm94J1xuXHQpO1xuXG5cdGNvbG9yVGV4dE91dHB1dEJveGVzLmZvckVhY2goYm94ID0+IHtcblx0XHRpZiAoIShib3ggaW5zdGFuY2VvZiBIVE1MSW5wdXRFbGVtZW50KSkge1xuXHRcdFx0Y29uc29sZS5lcnJvcignSW52YWxpZCBpbnB1dCBlbGVtZW50LicpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnN0IGlucHV0Qm94ID0gYm94IGFzIHR5cGVzLkNvbG9ySW5wdXRFbGVtZW50O1xuXHRcdGNvbnN0IGNvbG9yVmFsdWVzID0gaW5wdXRCb3guY29sb3JWYWx1ZXM7XG5cblx0XHRpZiAoIWNvbG9yVmFsdWVzKSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKCdNaXNzaW5nIGNvbG9yIHZhbHVlcy4nKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBjdXJyZW50Rm9ybWF0ID0gaW5wdXRCb3guZ2V0QXR0cmlidXRlKFxuXHRcdFx0J2RhdGEtZm9ybWF0J1xuXHRcdCkgYXMgdHlwZXMuQ29sb3JTcGFjZTtcblxuXHRcdGlmIChcblx0XHRcdCFndWFyZHMuaXNDb2xvclNwYWNlKGN1cnJlbnRGb3JtYXQpIHx8XG5cdFx0XHQhZ3VhcmRzLmlzQ29sb3JTcGFjZSh0YXJnZXRGb3JtYXQpXG5cdFx0KSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKFxuXHRcdFx0XHRgSW52YWxpZCBmb3JtYXQ6ICR7Y3VycmVudEZvcm1hdH0gb3IgJHt0YXJnZXRGb3JtYXR9YFxuXHRcdFx0KTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBjb252ZXJ0Rm4gPSBnZXRDb252ZXJzaW9uRm4oY3VycmVudEZvcm1hdCwgdGFyZ2V0Rm9ybWF0KTtcblx0XHRpZiAoIWNvbnZlcnRGbikge1xuXHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0YENvbnZlcnNpb24gZnJvbSAke2N1cnJlbnRGb3JtYXR9IHRvICR7dGFyZ2V0Rm9ybWF0fSBpcyBub3Qgc3VwcG9ydGVkLmBcblx0XHRcdCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKGd1YXJkcy5pc0NvbnZlcnRpYmxlQ29sb3IoY29sb3JWYWx1ZXMpKSB7XG5cdFx0XHRjb25zdCBuZXdDb2xvciA9IGNvbnZlcnRGbihjb2xvclZhbHVlcyk7XG5cdFx0XHRpZiAoIW5ld0NvbG9yKSB7XG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoYENvbnZlcnNpb24gdG8gJHt0YXJnZXRGb3JtYXR9IGZhaWxlZC5gKTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRpbnB1dEJveC52YWx1ZSA9IFN0cmluZyhuZXdDb2xvcik7XG5cdFx0XHRpbnB1dEJveC5zZXRBdHRyaWJ1dGUoJ2RhdGEtZm9ybWF0JywgdGFyZ2V0Rm9ybWF0KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS5lcnJvcihgSW52YWxpZCBjb2xvciB0eXBlIGZvciBjb252ZXJzaW9uLmApO1xuXHRcdH1cblx0fSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRHZW5lcmF0ZUJ1dHRvblBhcmFtcygpOiB0eXBlcy5HZW5CdXR0b25QYXJhbXMge1xuXHRjb25zdCBwYWxldHRlVHlwZU9wdGlvbnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcblx0XHQncGFsZXR0ZS10eXBlLW9wdGlvbnMnXG5cdCkgYXMgSFRNTFNlbGVjdEVsZW1lbnQ7XG5cdGNvbnN0IHBhbGV0dGVOdW1iZXJPcHRpb25zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXG5cdFx0J3BhbGV0dGUtbnVtYmVyLW9wdGlvbnMnXG5cdCkgYXMgSFRNTElucHV0RWxlbWVudDtcblx0Y29uc3QgY29sb3JTcGFjZVZhbHVlID0gKFxuXHRcdGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdFx0J2luaXRpYWwtY29sb3JzcGFjZS1vcHRpb25zJ1xuXHRcdCkgYXMgSFRNTFNlbGVjdEVsZW1lbnRcblx0KT8udmFsdWU7XG5cdGNvbnN0IGluaXRpYWxDb2xvclNwYWNlOiB0eXBlcy5Db2xvclNwYWNlID0gZ3VhcmRzLmlzQ29sb3JTcGFjZShcblx0XHRjb2xvclNwYWNlVmFsdWVcblx0KVxuXHRcdD8gY29sb3JTcGFjZVZhbHVlXG5cdFx0OiAnaGV4Jztcblx0Y29uc3QgY3VzdG9tQ29sb3JSYXcgPSAoXG5cdFx0ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1c3RvbS1jb2xvcicpIGFzIEhUTUxJbnB1dEVsZW1lbnRcblx0KT8udmFsdWU7XG5cdGNvbnN0IGN1c3RvbUNvbG9yID0gcGFyc2VDdXN0b21Db2xvcihpbml0aWFsQ29sb3JTcGFjZSwgY3VzdG9tQ29sb3JSYXcpO1xuXG5cdHJldHVybiB7XG5cdFx0bnVtQm94ZXM6IHBhcnNlSW50KHBhbGV0dGVOdW1iZXJPcHRpb25zLnZhbHVlLCAxMCksXG5cdFx0cGFsZXR0ZVR5cGU6IHBhcnNlSW50KHBhbGV0dGVUeXBlT3B0aW9ucy52YWx1ZSwgMTApLFxuXHRcdGluaXRpYWxDb2xvclNwYWNlLFxuXHRcdGN1c3RvbUNvbG9yXG5cdH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYW5kbGVHZW5CdXR0b25DbGljaygpOiB2b2lkIHtcblx0Y29uc3Qge1xuXHRcdHBhbGV0dGVUeXBlLFxuXHRcdG51bUJveGVzLFxuXHRcdGluaXRpYWxDb2xvclNwYWNlOiBzcGFjZSxcblx0XHRjdXN0b21Db2xvclxuXHR9ID0gZ2V0R2VuZXJhdGVCdXR0b25QYXJhbXMoKTtcblxuXHRpZiAoIXBhbGV0dGVUeXBlIHx8ICFudW1Cb3hlcykge1xuXHRcdGNvbnNvbGUuZXJyb3IoJ3BhbGV0dGVUeXBlIGFuZC9vciBudW1Cb3hlcyBhcmUgdW5kZWZpbmVkJyk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0Y29uc3QgaW5pdGlhbENvbG9yU3BhY2U6IHR5cGVzLkNvbG9yU3BhY2UgPSBzcGFjZSA/PyAnaGV4JztcblxuXHRzdGFydFBhbGV0dGVHZW4ocGFsZXR0ZVR5cGUsIG51bUJveGVzLCBpbml0aWFsQ29sb3JTcGFjZSwgY3VzdG9tQ29sb3IpO1xufVxuIl19