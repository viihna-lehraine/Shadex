// File: src/dom/elements.js
import { core, superUtils, utils } from '../common/index.js';
import { data } from '../data/index.js';
import { dom } from '../dom/index.js'; // *DEV-NOTE* this might cause a circular dependency
import { IDBManager } from '../idb/index.js';
import { mode } from '../data/mode/index.js';
import { start } from '../palette/index.js';
const buttonDebounce = data.consts.debounce.button || 300;
const domElements = data.consts.dom.elements;
const domIDs = data.consts.dom.ids;
const idb = IDBManager.getInstance();
function addEventListener(id, eventType, callback) {
    const element = document.getElementById(id);
    if (element) {
        element.addEventListener(eventType, callback);
    }
    else if (mode.warnLogs) {
        if ((mode.debug || mode.verbose) && mode.warnLogs)
            console.warn(`Element with id "${id}" not found.`);
    }
}
const handlePaletteGen = core.base.debounce(() => {
    try {
        const params = superUtils.dom.getGenButtonArgs();
        if (!params) {
            console.error('Failed to retrieve generateButton parameters');
            return;
        }
        const { numBoxes, customColor, paletteType, enableAlpha, limitDarkness, limitGrayness, limitLightness } = params;
        if (!paletteType || !numBoxes) {
            console.error('paletteType and/or numBoxes are undefined');
            return;
        }
        const options = {
            numBoxes,
            customColor,
            paletteType,
            enableAlpha,
            limitDarkness,
            limitGrayness,
            limitLightness
        };
        start.genPalette(options);
    }
    catch (error) {
        console.error(`Failed to handle generate button click: ${error}`);
    }
}, buttonDebounce);
function initializeEventListeners() {
    const addConversionListener = (id, colorSpace) => {
        const button = document.getElementById(id);
        if (button) {
            if (core.guards.isColorSpace(colorSpace)) {
                button.addEventListener('click', () => superUtils.dom.switchColorSpace(colorSpace));
            }
        }
        else {
            if (mode.warnLogs)
                console.warn(`Element with id "${id}" not found.`);
        }
    };
    addConversionListener('show-as-cmyk-button', 'cmyk');
    addConversionListener('show-as-hex-button', 'hex');
    addConversionListener('show-as-hsl-button', 'hsl');
    addConversionListener('show-as-hsv-button', 'hsv');
    addConversionListener('show-as-lab-button', 'lab');
    addConversionListener('show-as-rgb-button', 'rgb');
    addEventListener(domIDs.advancedMenuButton, 'click', async (e) => {
        e.preventDefault();
        const advancedMenuContent = document.querySelector('.advanced-menu-content');
        if (advancedMenuContent) {
            const isHidden = getComputedStyle(advancedMenuContent).display === 'none';
            advancedMenuContent.style.display = isHidden ? 'flex' : 'none';
        }
        if (!mode.quiet)
            console.log('advancedMenuButton clicked');
    });
    addEventListener(domIDs.applyCustomColorButton, 'click', async (e) => {
        e.preventDefault();
        const customHSLColor = dom.applyCustomColor();
        const customHSLColorClone = core.base.clone(customHSLColor);
        await idb.saveData('customColor', 'appSettings', customHSLColorClone);
        if (!mode.quiet)
            console.log('Custom color saved to IndexedDB');
        // *DEV-NOTE* unfinished
    });
    addEventListener(domIDs.clearCustomColorButton, 'click', async (e) => {
        e.preventDefault();
        domElements.customColorInput.value = '#ff0000';
        if (!mode.quiet)
            console.log('Custom color cleared');
    });
    addEventListener(domIDs.closeCustomColorMenuButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('closeCustomColorMenuButton clicked');
        domElements.customColorMenu?.classList.add('hidden');
    });
    addEventListener(domIDs.closeHelpMenuButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('closeHelpMenuButton clicked');
        domElements.advancedMenu?.classList.add('hidden');
    });
    addEventListener(domIDs.closeHistoryMenuButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('closeHistoryMenuButton clicked');
        domElements.historyMenu?.classList.add('hidden');
    });
    addEventListener(domIDs.customColorMenuButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('customColorMenuButton clicked');
        domElements.customColorMenu?.classList.remove('hidden');
    });
    if (!domElements.customColorInput)
        throw new Error('Custom color input element not found');
    domElements.customColorInput.addEventListener('input', () => {
        if (!domElements.customColorDisplay)
            throw new Error('Custom color display element not found');
        domElements.customColorDisplay.textContent =
            domElements.customColorInput.value;
    });
    addEventListener(domIDs.desaturateButton, 'click', async (e) => {
        e.preventDefault();
        const selectedColor = domElements.selectedColorOption
            ? parseInt(domElements.selectedColorOption.value, 10)
            : 0;
        if (!mode.quiet)
            console.log('desaturateButton clicked');
        dom.desaturateColor(selectedColor); // *DEV-NOTE* possible circular dependency
    });
    dom.elements.addEventListener(domIDs.generateButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('generateButton clicked');
        const { paletteType, numBoxes, enableAlpha, limitDarkness, limitGrayness, limitLightness } = dom.pullParamsFromUI();
        let customColor = (await idb.getCustomColor());
        if (!customColor) {
            if (!mode.quiet)
                console.info('No custom color found. Using a random color');
            customColor = utils.random.hsl(true);
        }
        const paletteOptions = {
            paletteType,
            numBoxes,
            customColor: core.base.clone(customColor),
            enableAlpha,
            limitDarkness,
            limitGrayness,
            limitLightness
        };
        await start.genPalette(paletteOptions);
    });
    dom.elements.addEventListener(domIDs.helpMenuButton, 'click', async (e) => {
        e.preventDefault();
        const helpMenuContent = document.querySelector('.help-menu-content');
        if (helpMenuContent) {
            const isHidden = getComputedStyle(helpMenuContent).display === 'none';
            helpMenuContent.style.display = isHidden ? 'flex' : 'none';
            if (!mode.quiet)
                console.log('helpMenuButton clicked');
        }
    });
    addEventListener(domIDs.historyMenuButton, 'click', async (e) => {
        e.preventDefault();
        const historyMenuContent = document.querySelector('.history-menu-content');
        if (historyMenuContent) {
            const isHidden = getComputedStyle(historyMenuContent).display === 'none';
            historyMenuContent.style.display = isHidden ? 'flex' : 'none';
        }
        if (!mode.quiet)
            console.log('historyMenuToggleButton clicked');
    });
    addEventListener(domIDs.saturateButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('saturateButton clicked');
        const selectedColor = domElements.selectedColorOption
            ? parseInt(domElements.selectedColorOption.value, 10)
            : 0;
        dom.saturateColor(selectedColor);
    });
    window.addEventListener('click', async (e) => {
        if (domElements.customColorMenu)
            if (e.target === domElements.customColorMenu)
                domElements.customColorMenu.classList.add('hidden');
    });
}
export const elements = {
    addEventListener,
    handlePaletteGen,
    initializeEventListeners
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWxlbWVudHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZG9tL2VsZW1lbnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLDRCQUE0QjtBQUc1QixPQUFPLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM3RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGlCQUFpQixDQUFDLENBQUMsb0RBQW9EO0FBQzNGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDN0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTVDLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUM7QUFDMUQsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO0FBQzdDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztBQUVuQyxNQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUM7QUFFckMsU0FBUyxnQkFBZ0IsQ0FDeEIsRUFBVSxFQUNWLFNBQVksRUFDWixRQUE4QztJQUU5QyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRTVDLElBQUksT0FBTyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQy9DLENBQUM7U0FBTSxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUMxQixJQUFJLENB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bUJBQW1CO1lBQ3BELENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLG1CQUFtQixDQUFDLEtBQUssRUFBRSxFQUFFLENBQUM7WUFDckQsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVMLEdBQUcsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFhLEVBQUUsRUFBRTtRQUN4RCxJQUFJLFdBQVcsQ0FBQyxlQUFlO1lBQzlCLElBQUksQ0FBQyxDQUFDLE1BQU0sS0FBSyxXQUFXLENBQUMsZUFBZTtnQkFDM0MsV0FBVyxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3ZELENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBeUI7SUFDN0MsZ0JBQWdCO0lBQ2hCLGdCQUFnQjtJQUNoQix3QkFBd0I7Q0FDeEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IHNyYy9kb20vZWxlbWVudHMuanNcblxuaW1wb3J0IHsgRE9NRWxlbWVudHNJbnRlcmZhY2UsIEhTTCwgUGFsZXR0ZU9wdGlvbnMgfSBmcm9tICcuLi9pbmRleC9pbmRleC5qcyc7XG5pbXBvcnQgeyBjb3JlLCBzdXBlclV0aWxzLCB1dGlscyB9IGZyb20gJy4uL2NvbW1vbi9pbmRleC5qcyc7XG5pbXBvcnQgeyBkYXRhIH0gZnJvbSAnLi4vZGF0YS9pbmRleC5qcyc7XG5pbXBvcnQgeyBkb20gfSBmcm9tICcuLi9kb20vaW5kZXguanMnOyAvLyAqREVWLU5PVEUqIHRoaXMgbWlnaHQgY2F1c2UgYSBjaXJjdWxhciBkZXBlbmRlbmN5XG5pbXBvcnQgeyBJREJNYW5hZ2VyIH0gZnJvbSAnLi4vaWRiL2luZGV4LmpzJztcbmltcG9ydCB7IG1vZGUgfSBmcm9tICcuLi9kYXRhL21vZGUvaW5kZXguanMnO1xuaW1wb3J0IHsgc3RhcnQgfSBmcm9tICcuLi9wYWxldHRlL2luZGV4LmpzJztcblxuY29uc3QgYnV0dG9uRGVib3VuY2UgPSBkYXRhLmNvbnN0cy5kZWJvdW5jZS5idXR0b24gfHwgMzAwO1xuY29uc3QgZG9tRWxlbWVudHMgPSBkYXRhLmNvbnN0cy5kb20uZWxlbWVudHM7XG5jb25zdCBkb21JRHMgPSBkYXRhLmNvbnN0cy5kb20uaWRzO1xuXG5jb25zdCBpZGIgPSBJREJNYW5hZ2VyLmdldEluc3RhbmNlKCk7XG5cbmZ1bmN0aW9uIGFkZEV2ZW50TGlzdGVuZXI8SyBleHRlbmRzIGtleW9mIEhUTUxFbGVtZW50RXZlbnRNYXA+KFxuXHRpZDogc3RyaW5nLFxuXHRldmVudFR5cGU6IEssXG5cdGNhbGxiYWNrOiAoZXY6IEhUTUxFbGVtZW50RXZlbnRNYXBbS10pID0+IHZvaWRcbik6IHZvaWQge1xuXHRjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpO1xuXG5cdGlmIChlbGVtZW50KSB7XG5cdFx0ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgY2FsbGJhY2spO1xuXHR9IGVsc2UgaWYgKG1vZGUud2FybkxvZ3MpIHtcblx0XHRpZiAoKG1vZGUuZGVidWcgfHwgbW9kZS52ZXJib3NlKSAmJiBtb2RlLndhcm5Mb2dzKVxuXHRcdFx0Y29uc29sZS53YXJuKGBFbGVtZW50IHdpdGggaWQgXCIke2lkfVwiIG5vdCBmb3VuZC5gKTtcblx0fVxufVxuXG5jb25zdCBoYW5kbGVQYWxldHRlR2VuID0gY29yZS5iYXNlLmRlYm91bmNlKCgpID0+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBwYXJhbXMgPSBzdXBlclV0aWxzLmRvbS5nZXRHZW5CdXR0b25BcmdzKCk7XG5cblx0XHRpZiAoIXBhcmFtcykge1xuXHRcdFx0Y29uc29sZS5lcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIGdlbmVyYXRlQnV0dG9uIHBhcmFtZXRlcnMnKTtcblxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnN0IHtcblx0XHRcdG51bUJveGVzLFxuXHRcdFx0Y3VzdG9tQ29sb3IsXG5cdFx0XHRwYWxldHRlVHlwZSxcblx0XHRcdGVuYWJsZUFscGhhLFxuXHRcdFx0bGltaXREYXJrbmVzcyxcblx0XHRcdGxpbWl0R3JheW5lc3MsXG5cdFx0XHRsaW1pdExpZ2h0bmVzc1xuXHRcdH0gPSBwYXJhbXM7XG5cblx0XHRpZiAoIXBhbGV0dGVUeXBlIHx8ICFudW1Cb3hlcykge1xuXHRcdFx0Y29uc29sZS5lcnJvcigncGFsZXR0ZVR5cGUgYW5kL29yIG51bUJveGVzIGFyZSB1bmRlZmluZWQnKTtcblxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnN0IG9wdGlvbnM6IFBhbGV0dGVPcHRpb25zID0ge1xuXHRcdFx0bnVtQm94ZXMsXG5cdFx0XHRjdXN0b21Db2xvcixcblx0XHRcdHBhbGV0dGVUeXBlLFxuXHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRsaW1pdERhcmtuZXNzLFxuXHRcdFx0bGltaXRHcmF5bmVzcyxcblx0XHRcdGxpbWl0TGlnaHRuZXNzXG5cdFx0fTtcblxuXHRcdHN0YXJ0LmdlblBhbGV0dGUob3B0aW9ucyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGhhbmRsZSBnZW5lcmF0ZSBidXR0b24gY2xpY2s6ICR7ZXJyb3J9YCk7XG5cdH1cbn0sIGJ1dHRvbkRlYm91bmNlKTtcblxuZnVuY3Rpb24gaW5pdGlhbGl6ZUV2ZW50TGlzdGVuZXJzKCk6IHZvaWQge1xuXHRjb25zdCBhZGRDb252ZXJzaW9uTGlzdGVuZXIgPSAoaWQ6IHN0cmluZywgY29sb3JTcGFjZTogc3RyaW5nKSA9PiB7XG5cdFx0Y29uc3QgYnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpIGFzIEhUTUxCdXR0b25FbGVtZW50IHwgbnVsbDtcblxuXHRcdGlmIChidXR0b24pIHtcblx0XHRcdGlmIChjb3JlLmd1YXJkcy5pc0NvbG9yU3BhY2UoY29sb3JTcGFjZSkpIHtcblx0XHRcdFx0YnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT5cblx0XHRcdFx0XHRzdXBlclV0aWxzLmRvbS5zd2l0Y2hDb2xvclNwYWNlKGNvbG9yU3BhY2UpXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdGlmIChtb2RlLndhcm5Mb2dzKVxuXHRcdFx0XHRjb25zb2xlLndhcm4oYEVsZW1lbnQgd2l0aCBpZCBcIiR7aWR9XCIgbm90IGZvdW5kLmApO1xuXHRcdH1cblx0fTtcblxuXHRhZGRDb252ZXJzaW9uTGlzdGVuZXIoJ3Nob3ctYXMtY215ay1idXR0b24nLCAnY215aycpO1xuXHRhZGRDb252ZXJzaW9uTGlzdGVuZXIoJ3Nob3ctYXMtaGV4LWJ1dHRvbicsICdoZXgnKTtcblx0YWRkQ29udmVyc2lvbkxpc3RlbmVyKCdzaG93LWFzLWhzbC1idXR0b24nLCAnaHNsJyk7XG5cdGFkZENvbnZlcnNpb25MaXN0ZW5lcignc2hvdy1hcy1oc3YtYnV0dG9uJywgJ2hzdicpO1xuXHRhZGRDb252ZXJzaW9uTGlzdGVuZXIoJ3Nob3ctYXMtbGFiLWJ1dHRvbicsICdsYWInKTtcblx0YWRkQ29udmVyc2lvbkxpc3RlbmVyKCdzaG93LWFzLXJnYi1idXR0b24nLCAncmdiJyk7XG5cblx0YWRkRXZlbnRMaXN0ZW5lcihcblx0XHRkb21JRHMuYWR2YW5jZWRNZW51QnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0Y29uc3QgYWR2YW5jZWRNZW51Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXG5cdFx0XHRcdCcuYWR2YW5jZWQtbWVudS1jb250ZW50J1xuXHRcdFx0KSBhcyBIVE1MRWxlbWVudCB8IG51bGw7XG5cblx0XHRcdGlmIChhZHZhbmNlZE1lbnVDb250ZW50KSB7XG5cdFx0XHRcdGNvbnN0IGlzSGlkZGVuID1cblx0XHRcdFx0XHRnZXRDb21wdXRlZFN0eWxlKGFkdmFuY2VkTWVudUNvbnRlbnQpLmRpc3BsYXkgPT09ICdub25lJztcblxuXHRcdFx0XHRhZHZhbmNlZE1lbnVDb250ZW50LnN0eWxlLmRpc3BsYXkgPSBpc0hpZGRlbiA/ICdmbGV4JyA6ICdub25lJztcblx0XHRcdH1cblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnYWR2YW5jZWRNZW51QnV0dG9uIGNsaWNrZWQnKTtcblx0XHR9XG5cdCk7XG5cblx0YWRkRXZlbnRMaXN0ZW5lcihcblx0XHRkb21JRHMuYXBwbHlDdXN0b21Db2xvckJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGNvbnN0IGN1c3RvbUhTTENvbG9yID0gZG9tLmFwcGx5Q3VzdG9tQ29sb3IoKTtcblx0XHRcdGNvbnN0IGN1c3RvbUhTTENvbG9yQ2xvbmUgPSBjb3JlLmJhc2UuY2xvbmUoY3VzdG9tSFNMQ29sb3IpO1xuXG5cdFx0XHRhd2FpdCBpZGIuc2F2ZURhdGEoXG5cdFx0XHRcdCdjdXN0b21Db2xvcicsXG5cdFx0XHRcdCdhcHBTZXR0aW5ncycsXG5cdFx0XHRcdGN1c3RvbUhTTENvbG9yQ2xvbmVcblx0XHRcdCk7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ0N1c3RvbSBjb2xvciBzYXZlZCB0byBJbmRleGVkREInKTtcblxuXHRcdFx0Ly8gKkRFVi1OT1RFKiB1bmZpbmlzaGVkXG5cdFx0fVxuXHQpO1xuXG5cdGFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0ZG9tSURzLmNsZWFyQ3VzdG9tQ29sb3JCdXR0b24sXG5cdFx0J2NsaWNrJyxcblx0XHRhc3luYyAoZTogTW91c2VFdmVudCkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0XHRkb21FbGVtZW50cy5jdXN0b21Db2xvcklucHV0IS52YWx1ZSA9ICcjZmYwMDAwJztcblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnQ3VzdG9tIGNvbG9yIGNsZWFyZWQnKTtcblx0XHR9XG5cdCk7XG5cblx0YWRkRXZlbnRMaXN0ZW5lcihcblx0XHRkb21JRHMuY2xvc2VDdXN0b21Db2xvck1lbnVCdXR0b24sXG5cdFx0J2NsaWNrJyxcblx0XHRhc3luYyAoZTogTW91c2VFdmVudCkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0XHRpZiAoIW1vZGUucXVpZXQpIGNvbnNvbGUubG9nKCdjbG9zZUN1c3RvbUNvbG9yTWVudUJ1dHRvbiBjbGlja2VkJyk7XG5cblx0XHRcdGRvbUVsZW1lbnRzLmN1c3RvbUNvbG9yTWVudT8uY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XG5cdFx0fVxuXHQpO1xuXG5cdGFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0ZG9tSURzLmNsb3NlSGVscE1lbnVCdXR0b24sXG5cdFx0J2NsaWNrJyxcblx0XHRhc3luYyAoZTogTW91c2VFdmVudCkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0XHRpZiAoIW1vZGUucXVpZXQpIGNvbnNvbGUubG9nKCdjbG9zZUhlbHBNZW51QnV0dG9uIGNsaWNrZWQnKTtcblxuXHRcdFx0ZG9tRWxlbWVudHMuYWR2YW5jZWRNZW51Py5jbGFzc0xpc3QuYWRkKCdoaWRkZW4nKTtcblx0XHR9XG5cdCk7XG5cblx0YWRkRXZlbnRMaXN0ZW5lcihcblx0XHRkb21JRHMuY2xvc2VIaXN0b3J5TWVudUJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ2Nsb3NlSGlzdG9yeU1lbnVCdXR0b24gY2xpY2tlZCcpO1xuXG5cdFx0XHRkb21FbGVtZW50cy5oaXN0b3J5TWVudT8uY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XG5cdFx0fVxuXHQpO1xuXG5cdGFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0ZG9tSURzLmN1c3RvbUNvbG9yTWVudUJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ2N1c3RvbUNvbG9yTWVudUJ1dHRvbiBjbGlja2VkJyk7XG5cblx0XHRcdGRvbUVsZW1lbnRzLmN1c3RvbUNvbG9yTWVudT8uY2xhc3NMaXN0LnJlbW92ZSgnaGlkZGVuJyk7XG5cdFx0fVxuXHQpO1xuXG5cdGlmICghZG9tRWxlbWVudHMuY3VzdG9tQ29sb3JJbnB1dClcblx0XHR0aHJvdyBuZXcgRXJyb3IoJ0N1c3RvbSBjb2xvciBpbnB1dCBlbGVtZW50IG5vdCBmb3VuZCcpO1xuXG5cdGRvbUVsZW1lbnRzLmN1c3RvbUNvbG9ySW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKSA9PiB7XG5cdFx0aWYgKCFkb21FbGVtZW50cy5jdXN0b21Db2xvckRpc3BsYXkpXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0N1c3RvbSBjb2xvciBkaXNwbGF5IGVsZW1lbnQgbm90IGZvdW5kJyk7XG5cblx0XHRkb21FbGVtZW50cy5jdXN0b21Db2xvckRpc3BsYXkudGV4dENvbnRlbnQgPVxuXHRcdFx0ZG9tRWxlbWVudHMuY3VzdG9tQ29sb3JJbnB1dCEudmFsdWU7XG5cdH0pO1xuXG5cdGFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0ZG9tSURzLmRlc2F0dXJhdGVCdXR0b24sXG5cdFx0J2NsaWNrJyxcblx0XHRhc3luYyAoZTogTW91c2VFdmVudCkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0XHRjb25zdCBzZWxlY3RlZENvbG9yID0gZG9tRWxlbWVudHMuc2VsZWN0ZWRDb2xvck9wdGlvblxuXHRcdFx0XHQ/IHBhcnNlSW50KGRvbUVsZW1lbnRzLnNlbGVjdGVkQ29sb3JPcHRpb24udmFsdWUsIDEwKVxuXHRcdFx0XHQ6IDA7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ2Rlc2F0dXJhdGVCdXR0b24gY2xpY2tlZCcpO1xuXG5cdFx0XHRkb20uZGVzYXR1cmF0ZUNvbG9yKHNlbGVjdGVkQ29sb3IpOyAvLyAqREVWLU5PVEUqIHBvc3NpYmxlIGNpcmN1bGFyIGRlcGVuZGVuY3lcblx0XHR9XG5cdCk7XG5cblx0ZG9tLmVsZW1lbnRzLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0ZG9tSURzLmdlbmVyYXRlQnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnZ2VuZXJhdGVCdXR0b24gY2xpY2tlZCcpO1xuXG5cdFx0XHRjb25zdCB7XG5cdFx0XHRcdHBhbGV0dGVUeXBlLFxuXHRcdFx0XHRudW1Cb3hlcyxcblx0XHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRcdGxpbWl0RGFya25lc3MsXG5cdFx0XHRcdGxpbWl0R3JheW5lc3MsXG5cdFx0XHRcdGxpbWl0TGlnaHRuZXNzXG5cdFx0XHR9ID0gZG9tLnB1bGxQYXJhbXNGcm9tVUkoKTtcblxuXHRcdFx0bGV0IGN1c3RvbUNvbG9yID0gKGF3YWl0IGlkYi5nZXRDdXN0b21Db2xvcigpKSBhcyBIU0wgfCBudWxsO1xuXG5cdFx0XHRpZiAoIWN1c3RvbUNvbG9yKSB7XG5cdFx0XHRcdGlmICghbW9kZS5xdWlldClcblx0XHRcdFx0XHRjb25zb2xlLmluZm8oJ05vIGN1c3RvbSBjb2xvciBmb3VuZC4gVXNpbmcgYSByYW5kb20gY29sb3InKTtcblxuXHRcdFx0XHRjdXN0b21Db2xvciA9IHV0aWxzLnJhbmRvbS5oc2wodHJ1ZSk7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IHBhbGV0dGVPcHRpb25zOiBQYWxldHRlT3B0aW9ucyA9IHtcblx0XHRcdFx0cGFsZXR0ZVR5cGUsXG5cdFx0XHRcdG51bUJveGVzLFxuXHRcdFx0XHRjdXN0b21Db2xvcjogY29yZS5iYXNlLmNsb25lKGN1c3RvbUNvbG9yKSxcblx0XHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRcdGxpbWl0RGFya25lc3MsXG5cdFx0XHRcdGxpbWl0R3JheW5lc3MsXG5cdFx0XHRcdGxpbWl0TGlnaHRuZXNzXG5cdFx0XHR9O1xuXG5cdFx0XHRhd2FpdCBzdGFydC5nZW5QYWxldHRlKHBhbGV0dGVPcHRpb25zKTtcblx0XHR9XG5cdCk7XG5cblx0ZG9tLmVsZW1lbnRzLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0ZG9tSURzLmhlbHBNZW51QnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0Y29uc3QgaGVscE1lbnVDb250ZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihcblx0XHRcdFx0Jy5oZWxwLW1lbnUtY29udGVudCdcblx0XHRcdCkgYXMgSFRNTEVsZW1lbnQgfCBudWxsO1xuXG5cdFx0XHRpZiAoaGVscE1lbnVDb250ZW50KSB7XG5cdFx0XHRcdGNvbnN0IGlzSGlkZGVuID1cblx0XHRcdFx0XHRnZXRDb21wdXRlZFN0eWxlKGhlbHBNZW51Q29udGVudCkuZGlzcGxheSA9PT0gJ25vbmUnO1xuXG5cdFx0XHRcdGhlbHBNZW51Q29udGVudC5zdHlsZS5kaXNwbGF5ID0gaXNIaWRkZW4gPyAnZmxleCcgOiAnbm9uZSc7XG5cblx0XHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnaGVscE1lbnVCdXR0b24gY2xpY2tlZCcpO1xuXHRcdFx0fVxuXHRcdH1cblx0KTtcblxuXHRhZGRFdmVudExpc3RlbmVyKFxuXHRcdGRvbUlEcy5oaXN0b3J5TWVudUJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGNvbnN0IGhpc3RvcnlNZW51Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXG5cdFx0XHRcdCcuaGlzdG9yeS1tZW51LWNvbnRlbnQnXG5cdFx0XHQpIGFzIEhUTUxFbGVtZW50IHwgbnVsbDtcblxuXHRcdFx0aWYgKGhpc3RvcnlNZW51Q29udGVudCkge1xuXHRcdFx0XHRjb25zdCBpc0hpZGRlbiA9XG5cdFx0XHRcdFx0Z2V0Q29tcHV0ZWRTdHlsZShoaXN0b3J5TWVudUNvbnRlbnQpLmRpc3BsYXkgPT09ICdub25lJztcblxuXHRcdFx0XHRoaXN0b3J5TWVudUNvbnRlbnQuc3R5bGUuZGlzcGxheSA9IGlzSGlkZGVuID8gJ2ZsZXgnIDogJ25vbmUnO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIW1vZGUucXVpZXQpIGNvbnNvbGUubG9nKCdoaXN0b3J5TWVudVRvZ2dsZUJ1dHRvbiBjbGlja2VkJyk7XG5cdFx0fVxuXHQpO1xuXG5cdGFkZEV2ZW50TGlzdGVuZXIoZG9tSURzLnNhdHVyYXRlQnV0dG9uLCAnY2xpY2snLCBhc3luYyAoZTogTW91c2VFdmVudCkgPT4ge1xuXHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ3NhdHVyYXRlQnV0dG9uIGNsaWNrZWQnKTtcblxuXHRcdGNvbnN0IHNlbGVjdGVkQ29sb3IgPSBkb21FbGVtZW50cy5zZWxlY3RlZENvbG9yT3B0aW9uXG5cdFx0XHQ/IHBhcnNlSW50KGRvbUVsZW1lbnRzLnNlbGVjdGVkQ29sb3JPcHRpb24udmFsdWUsIDEwKVxuXHRcdFx0OiAwO1xuXG5cdFx0ZG9tLnNhdHVyYXRlQ29sb3Ioc2VsZWN0ZWRDb2xvcik7XG5cdH0pO1xuXG5cdHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0aWYgKGRvbUVsZW1lbnRzLmN1c3RvbUNvbG9yTWVudSlcblx0XHRcdGlmIChlLnRhcmdldCA9PT0gZG9tRWxlbWVudHMuY3VzdG9tQ29sb3JNZW51KVxuXHRcdFx0XHRkb21FbGVtZW50cy5jdXN0b21Db2xvck1lbnUuY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XG5cdH0pO1xufVxuXG5leHBvcnQgY29uc3QgZWxlbWVudHM6IERPTUVsZW1lbnRzSW50ZXJmYWNlID0ge1xuXHRhZGRFdmVudExpc3RlbmVyLFxuXHRoYW5kbGVQYWxldHRlR2VuLFxuXHRpbml0aWFsaXplRXZlbnRMaXN0ZW5lcnNcbn07XG4iXX0=