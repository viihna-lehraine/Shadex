// File: src/ui/exportPalette.ts
import { dom } from '../dom/index.js';
import { serialize } from '../palette/io/serialize.js';
const exportPalette = {
    asCSS(palette, colorSpace = 'hsl') {
        try {
            const css = serialize.toCSS(palette, colorSpace);
            dom.fileUtils.download(css, `palette_${palette.id}.css`, 'text/css');
        }
        catch (error) {
            throw new Error(`Failed to export palette as CSS: ${error}`);
        }
    },
    asJSON(palette) {
        try {
            const json = serialize.toJSON(palette);
            dom.fileUtils.download(json, `palette_${palette.id}.json`, 'application/json');
        }
        catch (error) {
            throw new Error(`Failed to export palette as JSON: ${error}`);
        }
    },
    asXML(palette) {
        try {
            const xml = serialize.toXML(palette);
            dom.fileUtils.download(xml, `palette_${palette.id}.xml`, 'application/xml');
        }
        catch (error) {
            throw new Error(`Failed to export palette as XML: ${error}`);
        }
    }
};
const importPalette = {
    fromCSS(cssString) {
        try {
            const lines = cssString.split('\n');
            const items = [];
            let currentId = '';
            let colors = {};
            for (const line of lines) {
                const classMatch = line.match(/\.color-(\d+)/);
                if (classMatch) {
                    if (currentId) {
                        items.push({ id: currentId, colors });
                        colors = {};
                    }
                    currentId = classMatch[1];
                }
                const propertyMatch = line.match(/(\w+-color):\s*(.+);/);
                if (propertyMatch) {
                    const [, key, value] = propertyMatch;
                    colors[key.replace('-color', '')] = value.trim();
                }
            }
            if (currentId) {
                items.push({ id: currentId, colors });
            }
            return {
                id: 'imported',
                items,
                flags: {},
                metadata: {}
            };
        }
        catch (error) {
            throw new Error(`Failed to import palette from CSS: ${error}`);
        }
    },
    fromJSON(jsonString) {
        try {
            const parsed = JSON.parse(jsonString);
            if (!parsed.items || !Array.isArray(parsed.items)) {
                throw new Error('Invalid JSON format for Palette');
            }
            return parsed;
        }
        catch (error) {
            throw new Error(`Failed to import palette from JSON: ${error}`);
        }
    },
    fromXML(xmlString) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, 'application/xml');
        const parseError = xmlDoc.querySelector('parsererror');
        if (parseError) {
            throw new Error('Invalid XML format');
        }
        const paletteElement = xmlDoc.querySelector('Palette');
        if (!paletteElement) {
            throw new Error('Missing <Palette> root element');
        }
        const items = Array.from(paletteElement.querySelectorAll('PaletteItem')).map(item => {
            const id = item.getAttribute('id');
            const colors = {
                cmyk: item.querySelector('CMYK')?.textContent || '',
                hex: item.querySelector('Hex')?.textContent || '',
                hsl: item.querySelector('HSL')?.textContent || '',
                hsv: item.querySelector('HSV')?.textContent || '',
                lab: item.querySelector('LAB')?.textContent || '',
                rgb: item.querySelector('RGB')?.textContent || ''
            };
            return { id, colors };
        });
        const flags = {
            enableAlpha: paletteElement.querySelector('EnableAlpha')?.textContent ===
                'true',
            limitDarkness: paletteElement.querySelector('LimitDarkness')?.textContent ===
                'true',
            limitGrayness: paletteElement.querySelector('LimitGrayness')?.textContent ===
                'true',
            limitLightness: paletteElement.querySelector('LimitLightness')?.textContent ===
                'true'
        };
        const metadata = {
            customColor: {
                hslColor: paletteElement.querySelector('HSLColor')?.textContent ||
                    null,
                convertedColors: paletteElement.querySelector('ConvertedColors')
                    ?.textContent || null
            },
            numBoxes: parseInt(paletteElement.querySelector('NumBoxes')?.textContent || '0', 10),
            paletteType: parseInt(paletteElement.querySelector('PaletteType')?.textContent || '0', 10)
        };
        return {
            id: paletteElement.getAttribute('id'),
            items,
            flags,
            metadata
        };
    }
};
export const io = {
    exportPalette,
    importPalette
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvdWkvaW8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsZ0NBQWdDO0FBR2hDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFdkQsTUFBTSxhQUFhLEdBQUc7SUFDckIsS0FBSyxDQUFDLE9BQWdCLEVBQUUsYUFBeUIsS0FBSztRQUNyRCxJQUFJLENBQUM7WUFDSixNQUFNLEdBQUcsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQztZQUVqRCxHQUFHLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FDckIsR0FBRyxFQUNILFdBQVcsT0FBTyxDQUFDLEVBQUUsTUFBTSxFQUMzQixVQUFVLENBQ1YsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDOUQsQ0FBQztJQUNGLENBQUM7SUFDRCxNQUFNLENBQUMsT0FBZ0I7UUFDdEIsSUFBSSxDQUFDO1lBQ0osTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUV2QyxHQUFHLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FDckIsSUFBSSxFQUNKLFdBQVcsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUM1QixrQkFBa0IsQ0FDbEIsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDL0QsQ0FBQztJQUNGLENBQUM7SUFDRCxLQUFLLENBQUMsT0FBZ0I7UUFDckIsSUFBSSxDQUFDO1lBQ0osTUFBTSxHQUFHLEdBQUcsU0FB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QUFhO0lBQ2IsYUFBYTtDQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBGaWxlOiBzcmMvdWkvZXhwb3J0UGFsZXR0ZS50c1xuXG5pbXBvcnQgeyBDb2xvclNwYWNlLCBQYWxldHRlLCBVSUZuSU9JbnRlcmZhY2UgfSBmcm9tICcuLi9pbmRleC9pbmRleC5qcyc7XG5pbXBvcnQgeyBkb20gfSBmcm9tICcuLi9kb20vaW5kZXguanMnO1xuaW1wb3J0IHsgc2VyaWFsaXplIH0gZnJvbSAnLi4vcGFsZXR0ZS9pby9zZXJpYWxpemUuanMnO1xuXG5jb25zdCBleHBvcnRQYWxldHRlID0ge1xuXHRhc0NTUyhwYWxldHRlOiBQYWxldHRlLCBjb2xvclNwYWNlOiBDb2xvclNwYWNlID0gJ2hzbCcpOiB2b2lkIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgY3NzID0gc2VyaWFsaXplLnRvQ1NTKHBhbGV0dGUsIGNvbG9yU3BhY2UpO1xuXG5cdFx0XHRkb20uZmlsZVV0aWxzLmRvd25sb2FkKFxuXHRcdFx0XHRjc3MsXG5cdFx0XHRcdGBwYWxldHRlXyR7cGFsZXR0ZS5pZH0uY3NzYCxcblx0XHRcdFx0J3RleHQvY3NzJ1xuXHRcdFx0KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZXhwb3J0IHBhbGV0dGUgYXMgQ1NTOiAke2Vycm9yfWApO1xuXHRcdH1cblx0fSxcblx0YXNKU09OKHBhbGV0dGU6IFBhbGV0dGUpOiB2b2lkIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QganNvbiA9IHNlcmlhbGl6ZS50b0pTT04ocGFsZXR0ZSk7XG5cblx0XHRcdGRvbS5maWxlVXRpbHMuZG93bmxvYWQoXG5cdFx0XHRcdGpzb24sXG5cdFx0XHRcdGBwYWxldHRlXyR7cGFsZXR0ZS5pZH0uanNvbmAsXG5cdFx0XHRcdCdhcHBsaWNhdGlvbi9qc29uJ1xuXHRcdFx0KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZXhwb3J0IHBhbGV0dGUgYXMgSlNPTjogJHtlcnJvcn1gKTtcblx0XHR9XG5cdH0sXG5cdGFzWE1MKHBhbGV0dGU6IFBhbGV0dGUpOiB2b2lkIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgeG1sID0gc2VyaWFsaXplLnRvWE1MKHBhbGV0dGUpO1xuXG5cdFx0XHRkb20uZmlsZVV0aWxzLmRvd25sb2FkKFxuXHRcdFx0XHR4bWwsXG5cdFx0XHRcdGBwYWxldHRlXyR7cGFsZXR0ZS5pZH0ueG1sYCxcblx0XHRcdFx0J2FwcGxpY2F0aW9uL3htbCdcblx0XHRcdCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGV4cG9ydCBwYWxldHRlIGFzIFhNTDogJHtlcnJvcn1gKTtcblx0XHR9XG5cdH1cbn07XG5cbmNvbnN0IGltcG9ydFBhbGV0dGUgPSB7XG5cdGZyb21DU1MoY3NzU3RyaW5nOiBzdHJpbmcpOiBQYWxldHRlIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgbGluZXMgPSBjc3NTdHJpbmcuc3BsaXQoJ1xcbicpO1xuXHRcdFx0Y29uc3QgaXRlbXMgPSBbXTtcblxuXHRcdFx0bGV0IGN1cnJlbnRJZCA9ICcnO1xuXHRcdFx0bGV0IGNvbG9yczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG5cdFx0XHRmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcblx0XHRcdFx0Y29uc3QgY2xhc3NNYXRjaCA9IGxpbmUubWF0Y2goL1xcLmNvbG9yLShcXGQrKS8pO1xuXHRcdFx0XHRpZiAoY2xhc3NNYXRjaCkge1xuXHRcdFx0XHRcdGlmIChjdXJyZW50SWQpIHtcblx0XHRcdFx0XHRcdGl0ZW1zLnB1c2goeyBpZDogY3VycmVudElkLCBjb2xvcnMgfSk7XG5cdFx0XHRcdFx0XHRjb2xvcnMgPSB7fTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0Y3VycmVudElkID0gY2xhc3NNYXRjaFsxXTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGNvbnN0IHByb3BlcnR5TWF0Y2ggPSBsaW5lLm1hdGNoKC8oXFx3Ky1jb2xvcik6XFxzKiguKyk7Lyk7XG5cblx0XHRcdFx0aWYgKHByb3BlcnR5TWF0Y2gpIHtcblx0XHRcdFx0XHRjb25zdCBbLCBrZXksIHZhbHVlXSA9IHByb3BlcnR5TWF0Y2g7XG5cdFx0XHRcdFx0Y29sb3JzW2tleS5yZXBsYWNlKCctY29sb3InLCAnJyldID0gdmFsdWUudHJpbSgpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmIChjdXJyZW50SWQpIHtcblx0XHRcdFx0aXRlbXMucHVzaCh7IGlkOiBjdXJyZW50SWQsIGNvbG9ycyB9KTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0aWQ6ICdpbXBvcnRlZCcsXG5cdFx0XHRcdGl0ZW1zLFxuXHRcdFx0XHRmbGFnczoge30sXG5cdFx0XHRcdG1ldGFkYXRhOiB7fVxuXHRcdFx0fSBhcyBQYWxldHRlO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBpbXBvcnQgcGFsZXR0ZSBmcm9tIENTUzogJHtlcnJvcn1gKTtcblx0XHR9XG5cdH0sXG5cdGZyb21KU09OKGpzb25TdHJpbmc6IHN0cmluZyk6IFBhbGV0dGUge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKGpzb25TdHJpbmcpO1xuXHRcdFx0aWYgKCFwYXJzZWQuaXRlbXMgfHwgIUFycmF5LmlzQXJyYXkocGFyc2VkLml0ZW1zKSkge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgSlNPTiBmb3JtYXQgZm9yIFBhbGV0dGUnKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHBhcnNlZCBhcyBQYWxldHRlO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBpbXBvcnQgcGFsZXR0ZSBmcm9tIEpTT046ICR7ZXJyb3J9YCk7XG5cdFx0fVxuXHR9LFxuXHRmcm9tWE1MKHhtbFN0cmluZzogc3RyaW5nKTogUGFsZXR0ZSB7XG5cdFx0Y29uc3QgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpO1xuXHRcdGNvbnN0IHhtbERvYyA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoeG1sU3RyaW5nLCAnYXBwbGljYXRpb24veG1sJyk7XG5cdFx0Y29uc3QgcGFyc2VFcnJvciA9IHhtbERvYy5xdWVyeVNlbGVjdG9yKCdwYXJzZXJlcnJvcicpO1xuXG5cdFx0aWYgKHBhcnNlRXJyb3IpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignSW52YWxpZCBYTUwgZm9ybWF0Jyk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgcGFsZXR0ZUVsZW1lbnQgPSB4bWxEb2MucXVlcnlTZWxlY3RvcignUGFsZXR0ZScpO1xuXG5cdFx0aWYgKCFwYWxldHRlRWxlbWVudCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIDxQYWxldHRlPiByb290IGVsZW1lbnQnKTtcblx0XHR9XG5cblx0XHRjb25zdCBpdGVtcyA9IEFycmF5LmZyb20oXG5cdFx0XHRwYWxldHRlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdQYWxldHRlSXRlbScpXG5cdFx0KS5tYXAoaXRlbSA9PiB7XG5cdFx0XHRjb25zdCBpZCA9IGl0ZW0uZ2V0QXR0cmlidXRlKCdpZCcpO1xuXHRcdFx0Y29uc3QgY29sb3JzID0ge1xuXHRcdFx0XHRjbXlrOiBpdGVtLnF1ZXJ5U2VsZWN0b3IoJ0NNWUsnKT8udGV4dENvbnRlbnQgfHwgJycsXG5cdFx0XHRcdGhleDogaXRlbS5xdWVyeVNlbGVjdG9yKCdIZXgnKT8udGV4dENvbnRlbnQgfHwgJycsXG5cdFx0XHRcdGhzbDogaXRlbS5xdWVyeVNlbGVjdG9yKCdIU0wnKT8udGV4dENvbnRlbnQgfHwgJycsXG5cdFx0XHRcdGhzdjogaXRlbS5xdWVyeVNlbGVjdG9yKCdIU1YnKT8udGV4dENvbnRlbnQgfHwgJycsXG5cdFx0XHRcdGxhYjogaXRlbS5xdWVyeVNlbGVjdG9yKCdMQUInKT8udGV4dENvbnRlbnQgfHwgJycsXG5cdFx0XHRcdHJnYjogaXRlbS5xdWVyeVNlbGVjdG9yKCdSR0InKT8udGV4dENvbnRlbnQgfHwgJydcblx0XHRcdH07XG5cblx0XHRcdHJldHVybiB7IGlkLCBjb2xvcnMgfTtcblx0XHR9KTtcblxuXHRcdGNvbnN0IGZsYWdzID0ge1xuXHRcdFx0ZW5hYmxlQWxwaGE6XG5cdFx0XHRcdHBhbGV0dGVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ0VuYWJsZUFscGhhJyk/LnRleHRDb250ZW50ID09PVxuXHRcdFx0XHQndHJ1ZScsXG5cdFx0XHRsaW1pdERhcmtuZXNzOlxuXHRcdFx0XHRwYWxldHRlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdMaW1pdERhcmtuZXNzJyk/LnRleHRDb250ZW50ID09PVxuXHRcdFx0XHQndHJ1ZScsXG5cdFx0XHRsaW1pdEdyYXluZXNzOlxuXHRcdFx0XHRwYWxldHRlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdMaW1pdEdyYXluZXNzJyk/LnRleHRDb250ZW50ID09PVxuXHRcdFx0XHQndHJ1ZScsXG5cdFx0XHRsaW1pdExpZ2h0bmVzczpcblx0XHRcdFx0cGFsZXR0ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignTGltaXRMaWdodG5lc3MnKT8udGV4dENvbnRlbnQgPT09XG5cdFx0XHRcdCd0cnVlJ1xuXHRcdH07XG5cblx0XHRjb25zdCBtZXRhZGF0YSA9IHtcblx0XHRcdGN1c3RvbUNvbG9yOiB7XG5cdFx0XHRcdGhzbENvbG9yOlxuXHRcdFx0XHRcdHBhbGV0dGVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ0hTTENvbG9yJyk/LnRleHRDb250ZW50IHx8XG5cdFx0XHRcdFx0bnVsbCxcblx0XHRcdFx0Y29udmVydGVkQ29sb3JzOlxuXHRcdFx0XHRcdHBhbGV0dGVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ0NvbnZlcnRlZENvbG9ycycpXG5cdFx0XHRcdFx0XHQ/LnRleHRDb250ZW50IHx8IG51bGxcblx0XHRcdH0sXG5cdFx0XHRudW1Cb3hlczogcGFyc2VJbnQoXG5cdFx0XHRcdHBhbGV0dGVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ051bUJveGVzJyk/LnRleHRDb250ZW50IHx8ICcwJyxcblx0XHRcdFx0MTBcblx0XHRcdCksXG5cdFx0XHRwYWxldHRlVHlwZTogcGFyc2VJbnQoXG5cdFx0XHRcdHBhbGV0dGVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ1BhbGV0dGVUeXBlJyk/LnRleHRDb250ZW50IHx8ICcwJyxcblx0XHRcdFx0MTBcblx0XHRcdClcblx0XHR9O1xuXG5cdFx0cmV0dXJuIHtcblx0XHRcdGlkOiBwYWxldHRlRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2lkJyksXG5cdFx0XHRpdGVtcyxcblx0XHRcdGZsYWdzLFxuXHRcdFx0bWV0YWRhdGFcblx0XHR9IGFzIFBhbGV0dGU7XG5cdH1cbn07XG5cbmV4cG9ydCBjb25zdCBpbzogVUlGbklPSW50ZXJmYWNlID0ge1xuXHRleHBvcnRQYWxldHRlLFxuXHRpbXBvcnRQYWxldHRlXG59O1xuIl19