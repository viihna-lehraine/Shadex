// File: src/io/deserialize.ts
import { data } from '../data/index.js';
import { logger } from '../logger/index.js';
const logMode = data.mode.logging;
const mode = data.mode;
async function toCSS(palette) {
    return new Promise((resolve, reject) => {
        try {
            // 1. serialize metadata
            const metadata = `
				/* Palette Metadata */
				.palette {
					--id: "${palette.id}";
					--name: "${palette.metadata.name ?? 'Unnamed Palette'}";
					--swatches: ${palette.metadata.swatches};
					--type: "${palette.metadata.type}";
					--timestamp: "${palette.metadata.timestamp}";
					--enableAlpha: ${palette.metadata.flags.enableAlpha};
					--limitDarkness: ${palette.metadata.flags.limitDarkness};
					--limitGrayness: ${palette.metadata.flags.limitGrayness};
					--limitLightness: ${palette.metadata.flags.limitLightness};
				}`.trim();
            // 2. serialize custom color if present
            const customColor = palette.metadata.customColor
                ? `
				/* Optional Custom Color */
				.palette-custom {
					--custom-hsl-color: "hsl(${palette.metadata.customColor.hslColor.value.hue}, ${palette.metadata.customColor.hslColor.value.saturation}%, ${palette.metadata.customColor.hslColor.value.lightness}%)";
					--custom-cmyk-color: "${palette.metadata.customColor.convertedColors.cmyk}";
					--custom-hex-color: "${palette.metadata.customColor.convertedColors.hex}";
					--custom-hsv-color: "${palette.metadata.customColor.convertedColors.hsv}";
					--custom-lab-color: "${palette.metadata.customColor.convertedColors.lab}";
					--custom-rgb-color: "${palette.metadata.customColor.convertedColors.rgb}";
					--custom-xyz-color: "${palette.metadata.customColor.convertedColors.xyz}";
				}`.trim()
                : '';
            // 3. serialize palette items
            const items = palette.items
                .map(item => {
                const backgroundColor = item.cssStrings.hslCSSString;
                return `
					/* Palette Item: ${item.id} */
					.color-${item.id} {
						--id: "${item.id}";
						--cmyk-color: "${item.cssStrings.cmykCSSString}";
						--hex-color: "${item.cssStrings.hexCSSString}";
						--hsl-color: "${item.cssStrings.hslCSSString}";
						--hsv-color: "${item.cssStrings.hsvCSSString}";
						--lab-color: "${item.cssStrings.labCSSString}";
						--rgb-color: "${item.cssStrings.rgbCSSString}";
						--xyz-color: "${item.cssStrings.xyzCSSString}";
						background-color: ${backgroundColor};
					}`.trim();
            })
                .join('\n\n');
            // 4. combine CSS data
            const cssData = [metadata, customColor, items]
                .filter(Boolean)
                .join('\n\n');
            // 5. resolve serialized CSS data
            resolve(cssData.trim());
        }
        catch (error) {
            if (!mode.quiet && logMode.errors) {
                if (logMode.verbosity > 1) {
                    logger.error(`Failed to convert palette to CSS: ${error}`);
                }
                else {
                    logger.error('Failed to convert palette to CSS');
                }
            }
            if (mode.stackTrace) {
                console.trace('Stack Trace:');
            }
            reject(new Error(`Failed to convert palette to CSS: ${error}`));
        }
    });
}
async function toJSON(palette) {
    return new Promise((resolve, reject) => {
        try {
            const jsonData = JSON.stringify(palette, null, 2);
            resolve(jsonData);
        }
        catch (error) {
            if (!mode.quiet && logMode.errors) {
                if (logMode.verbosity > 1) {
                    logger.error(`Failed to convert palette to JSON: ${error}`);
                }
                else {
                    logger.error('Failed to convert palette to JSON');
                }
            }
            if (mode.stackTrace) {
                console.trace('Stack Trace:');
            }
            reject(new Error(`Failed to convert palette to JSON: ${error}`));
        }
    });
}
async function toXML(palette) {
    return new Promise((resolve, reject) => {
        try {
            // 1. serialize palette metadata
            const customColorXML = palette.metadata.customColor
                ? `
				<CustomColor>
					<CMYK>${palette.metadata.customColor.convertedColors.cmyk}</CMYK>
					<Hex>${palette.metadata.customColor.convertedColors.hex}</Hex>
					<HSL>${palette.metadata.customColor.convertedColors.hsl}</HSL>
					<HSV>${palette.metadata.customColor.convertedColors.hsv}</HSV>
					<LAB>${palette.metadata.customColor.convertedColors.lab}</LAB>
					<RGB>${palette.metadata.customColor.convertedColors.rgb}</RGB>
					<XYZ>${palette.metadata.customColor.convertedColors.xyz}</XYZ>
				</CustomColor>`.trim()
                : '<CustomColor>false</CustomColor>';
            const metadata = `
				<Metadata>
					<Name>${palette.metadata.name ?? 'Unnamed Palette'}</Name>
					<Timestamp>${palette.metadata.timestamp}</Timestamp>
					<Swatches>${palette.metadata.swatches}</Swatches>
					<Type>${palette.metadata.type}</Type>
					${customColorXML}
					<Flags>
						<EnableAlpha>${palette.metadata.flags.enableAlpha}</EnableAlpha>
						<LimitDarkness>${palette.metadata.flags.limitDarkness}</LimitDarkness>
						<LimitGrayness>${palette.metadata.flags.limitGrayness}</LimitGrayness>
						<LimitLightness>${palette.metadata.flags.limitLightness}</LimitLightness>
					</Flags>
				</Metadata>`.trim();
            // 2. serialize palette items
            const xmlItems = palette.items
                .map((item, index) => `
					<PaletteItem id="${index + 1}">
						<Colors>
							<CMYK>${item.colors.cmyk}</CMYK>
							<Hex>${item.colors.hex}</Hex>
							<HSL>${item.colors.hsl}</HSL>
							<HSV>${item.colors.hsv}</HSV>
							<LAB>${item.colors.lab}</LAB>
							<RGB>${item.colors.rgb}</RGB>
							<XYZ>${item.colors.xyz}</XYZ>
						</Colors>
						<CSS_Colors>
							<CMYK_CSS>${item.cssStrings.cmykCSSString}</CMYK_CSS>
							<Hex_CSS>${item.cssStrings.hexCSSString}</Hex_CSS>
							<HSL_CSS>${item.cssStrings.hslCSSString}</HSL_CSS>
							<HSV_CSS>${item.cssStrings.hsvCSSString}</HSV_CSS>
							<LAB_CSS>${item.cssStrings.labCSSString}</LAB_CSS>
							<RGB_CSS>${item.cssStrings.rgbCSSString}</RGB_CSS>
							<XYZ_CSS>${item.cssStrings.xyzCSSString}</XYZ_CSS>
						</CSS_Colors>
					</PaletteItem>`.trim())
                .join('\n');
            // 3. combine metadata and items into the palette XML
            const xmlData = `
				<Palette id=${palette.id}>
					${metadata}
					<Items>
						${xmlItems}
					</Items>
				</Palette>`.trim();
            resolve(xmlData.trim());
        }
        catch (error) {
            if (!mode.quiet && logMode.errors) {
                if (logMode.verbosity > 1) {
                    logger.error(`Failed to convert palette to XML: ${error}`);
                }
                else {
                    logger.error('Failed to convert palette to XML');
                }
            }
            if (mode.stackTrace) {
                console.trace('Stack Trace:');
            }
            reject(new Error(`Failed to convert palette to XML: ${error}`));
        }
    });
}
export const serialize = {
    toCSS,
    toJSON,
    toXML
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VyaWFsaXplLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2lvL3NlcmlhbGl6ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw4QkFBOEI7QUFHOUIsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUU1QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztBQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBRXZCLEtBQUssVUFBVSxLQUFLLENBQUMsT0FBZ0I7SUFDcEMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUN0QyxJQUFJLENBQUM7WUFDSix3QkFBd0I7WUFDeEIsTUFBTSxRQUFRLEdBQUc7OztjQUdOLE9BQU8sQ0FBQyxFQUFFO2dCQUNSLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLGlCQUFpQjttQkFDdkMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRO2dCQUM1QixPQUFPLENBQUMsUUFBUSxDQUFDLElBQUk7cUJBQ2hCLE9BQU8sQ0FBQyxRQUFRLENBQUMsU0FBUztzQkFDekIsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsV0FBVzt3QkFDaEMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsYUFBYTt3QkFDcEMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsYUFBYTt5QkFDbkMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsY0FBYztNQUN4RCxDQUFDLElBQUksRUFBRSxDQUFDO1lBRVgsdUNBQXVDO1lBQ3ZDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVztnQkFDL0MsQ0FBQyxDQUFDOzs7Z0NBRzBCLE9BQU8sQ0FBQyxRQUFRLENB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QUFDLHFDQUFxQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDakUsQ0FBQztJQUNGLENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBOEI7SUFDbkQsS0FBSztJQUNMLE1BQU07SUFDTixLQUFLO0NBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IHNyYy9pby9kZXNlcmlhbGl6ZS50c1xuXG5pbXBvcnQgeyBJT19JbnRlcmZhY2UsIFBhbGV0dGUgfSBmcm9tICcuLi9pbmRleC9pbmRleC5qcyc7XG5pbXBvcnQgeyBkYXRhIH0gZnJvbSAnLi4vZGF0YS9pbmRleC5qcyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi9sb2dnZXIvaW5kZXguanMnO1xuXG5jb25zdCBsb2dNb2RlID0gZGF0YS5tb2RlLmxvZ2dpbmc7XG5jb25zdCBtb2RlID0gZGF0YS5tb2RlO1xuXG5hc3luYyBmdW5jdGlvbiB0b0NTUyhwYWxldHRlOiBQYWxldHRlKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHR0cnkge1xuXHRcdFx0Ly8gMS4gc2VyaWFsaXplIG1ldGFkYXRhXG5cdFx0XHRjb25zdCBtZXRhZGF0YSA9IGBcblx0XHRcdFx0LyogUGFsZXR0ZSBNZXRhZGF0YSAqL1xuXHRcdFx0XHQucGFsZXR0ZSB7XG5cdFx0XHRcdFx0LS1pZDogXCIke3BhbGV0dGUuaWR9XCI7XG5cdFx0XHRcdFx0LS1uYW1lOiBcIiR7cGFsZXR0ZS5tZXRhZGF0YS5uYW1lID8/ICdVbm5hbWVkIFBhbGV0dGUnfVwiO1xuXHRcdFx0XHRcdC0tc3dhdGNoZXM6ICR7cGFsZXR0ZS5tZXRhZGF0YS5zd2F0Y2hlc307XG5cdFx0XHRcdFx0LS10eXBlOiBcIiR7cGFsZXR0ZS5tZXRhZGF0YS50eXBlfVwiO1xuXHRcdFx0XHRcdC0tdGltZXN0YW1wOiBcIiR7cGFsZXR0ZS5tZXRhZGF0YS50aW1lc3RhbXB9XCI7XG5cdFx0XHRcdFx0LS1lbmFibGVBbHBoYTogJHtwYWxldHRlLm1ldGFkYXRhLmZsYWdzLmVuYWJsZUFscGhhfTtcblx0XHRcdFx0XHQtLWxpbWl0RGFya25lc3M6ICR7cGFsZXR0ZS5tZXRhZGF0YS5mbGFncy5saW1pdERhcmtuZXNzfTtcblx0XHRcdFx0XHQtLWxpbWl0R3JheW5lc3M6ICR7cGFsZXR0ZS5tZXRhZGF0YS5mbGFncy5saW1pdEdyYXluZXNzfTtcblx0XHRcdFx0XHQtLWxpbWl0TGlnaHRuZXNzOiAke3BhbGV0dGUubWV0YWRhdGEuZmxhZ3MubGltaXRMaWdodG5lc3N9O1xuXHRcdFx0XHR9YC50cmltKCk7XG5cblx0XHRcdC8vIDIuIHNlcmlhbGl6ZSBjdXN0b20gY29sb3IgaWYgcHJlc2VudFxuXHRcdFx0Y29uc3QgY3VzdG9tQ29sb3IgPSBwYWxldHRlLm1ldGFkYXRhLmN1c3RvbUNvbG9yXG5cdFx0XHRcdD8gYFxuXHRcdFx0XHQvKiBPcHRpb25hbCBDdXN0b20gQ29sb3IgKi9cblx0XHRcdFx0LnBhbGV0dGUtY3VzdG9tIHtcblx0XHRcdFx0XHQtLWN1c3RvbS1oc2wtY29sb3I6IFwiaHNsKCR7cGFsZXR0ZS5tZXRhZGF0YS5jdXN0b21Db2xvci5oc2xDb2xvci52YWx1ZS5odWV9LCAke1xuXHRcdFx0XHRcdFx0cGFsZXR0ZS5tZXRhZGF0YS5jdXN0b21Db2xvci5oc2xDb2xvci52YWx1ZS5zYXR1cmF0aW9uXG5cdFx0XHRcdFx0fSUsICR7cGFsZXR0ZS5tZXRhZGF0YS5jdXN0b21Db2xvci5oc2xDb2xvci52YWx1ZS5saWdodG5lc3N9JSlcIjtcblx0XHRcdFx0XHQtLWN1c3RvbS1jbXlrLWNvbG9yOiBcIiR7cGFsZXR0ZS5tZXRhZGF0YS5jdXN0b21Db2xvci5jb252ZXJ0ZWRDb2xvcnMuY215a31cIjtcblx0XHRcdFx0XHQtLWN1c3RvbS1oZXgtY29sb3I6IFwiJHtwYWxldHRlLm1ldGFkYXRhLmN1c3RvbUNvbG9yLmNvbnZlcnRlZENvbG9ycy5oZXh9XCI7XG5cdFx0XHRcdFx0LS1jdXN0b20taHN2LWNvbG9yOiBcIiR7cGFsZXR0ZS5tZXRhZGF0YS5jdXN0b21Db2xvci5jb252ZXJ0ZWRDb2xvcnMuaHN2fVwiO1xuXHRcdFx0XHRcdC0tY3VzdG9tLWxhYi1jb2xvcjogXCIke3BhbGV0dGUubWV0YWRhdGEuY3VzdG9tQ29sb3IuY29udmVydGVkQ29sb3JzLmxhYn1cIjtcblx0XHRcdFx0XHQtLWN1c3RvbS1yZ2ItY29sb3I6IFwiJHtwYWxldHRlLm1ldGFkYXRhLmN1c3RvbUNvbG9yLmNvbnZlcnRlZENvbG9ycy5yZ2J9XCI7XG5cdFx0XHRcdFx0LS1jdXN0b20teHl6LWNvbG9yOiBcIiR7cGFsZXR0ZS5tZXRhZGF0YS5jdXN0b21Db2xvci5jb252ZXJ0ZWRDb2xvcnMueHl6fVwiO1xuXHRcdFx0XHR9YC50cmltKClcblx0XHRcdFx0OiAnJztcblxuXHRcdFx0Ly8gMy4gc2VyaWFsaXplIHBhbGV0dGUgaXRlbXNcblx0XHRcdGNvbnN0IGl0ZW1zID0gcGFsZXR0ZS5pdGVtc1xuXHRcdFx0XHQubWFwKGl0ZW0gPT4ge1xuXHRcdFx0XHRcdGNvbnN0IGJhY2tncm91bmRDb2xvciA9IGl0ZW0uY3NzU3RyaW5ncy5oc2xDU1NTdHJpbmc7XG5cblx0XHRcdFx0XHRyZXR1cm4gYFxuXHRcdFx0XHRcdC8qIFBhbGV0dGUgSXRlbTogJHtpdGVtLmlkfSAqL1xuXHRcdFx0XHRcdC5jb2xvci0ke2l0ZW0uaWR9IHtcblx0XHRcdFx0XHRcdC0taWQ6IFwiJHtpdGVtLmlkfVwiO1xuXHRcdFx0XHRcdFx0LS1jbXlrLWNvbG9yOiBcIiR7aXRlbS5jc3NTdHJpbmdzLmNteWtDU1NTdHJpbmd9XCI7XG5cdFx0XHRcdFx0XHQtLWhleC1jb2xvcjogXCIke2l0ZW0uY3NzU3RyaW5ncy5oZXhDU1NTdHJpbmd9XCI7XG5cdFx0XHRcdFx0XHQtLWhzbC1jb2xvcjogXCIke2l0ZW0uY3NzU3RyaW5ncy5oc2xDU1NTdHJpbmd9XCI7XG5cdFx0XHRcdFx0XHQtLWhzdi1jb2xvcjogXCIke2l0ZW0uY3NzU3RyaW5ncy5oc3ZDU1NTdHJpbmd9XCI7XG5cdFx0XHRcdFx0XHQtLWxhYi1jb2xvcjogXCIke2l0ZW0uY3NzU3RyaW5ncy5sYWJDU1NTdHJpbmd9XCI7XG5cdFx0XHRcdFx0XHQtLXJnYi1jb2xvcjogXCIke2l0ZW0uY3NzU3RyaW5ncy5yZ2JDU1NTdHJpbmd9XCI7XG5cdFx0XHRcdFx0XHQtLXh5ei1jb2xvcjogXCIke2l0ZW0uY3NzU3RyaW5ncy54eXpDU1NTdHJpbmd9XCI7XG5cdFx0XHRcdFx0XHRiYWNrZ3JvdW5kLWNvbG9yOiAke2JhY2tncm91bmRDb2xvcn07XG5cdFx0XHRcdFx0fWAudHJpbSgpO1xuXHRcdFx0XHR9KVxuXHRcdFx0XHQuam9pbignXFxuXFxuJyk7XG5cblx0XHRcdC8vIDQuIGNvbWJpbmUgQ1NTIGRhdGFcblx0XHRcdGNvbnN0IGNzc0RhdGEgPSBbbWV0YWRhdGEsIGN1c3RvbUNvbG9yLCBpdGVtc11cblx0XHRcdFx0LmZpbHRlcihCb29sZWFuKVxuXHRcdFx0XHQuam9pbignXFxuXFxuJyk7XG5cblx0XHRcdC8vIDUuIHJlc29sdmUgc2VyaWFsaXplZCBDU1MgZGF0YVxuXHRcdFx0cmVzb2x2ZShjc3NEYXRhLnRyaW0oKSk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGlmICghbW9kZS5xdWlldCAmJiBsb2dNb2RlLmVycm9ycykge1xuXHRcdFx0XHRpZiAobG9nTW9kZS52ZXJib3NpdHkgPiAxKSB7XG5cdFx0XHRcdFx0bG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gY29udmVydCBwYWxldHRlIHRvIENTUzogJHtlcnJvcn1gKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBjb252ZXJ0IHBhbGV0dGUgdG8gQ1NTJyk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0aWYgKG1vZGUuc3RhY2tUcmFjZSkge1xuXHRcdFx0XHRjb25zb2xlLnRyYWNlKCdTdGFjayBUcmFjZTonKTtcblx0XHRcdH1cblxuXHRcdFx0cmVqZWN0KG5ldyBFcnJvcihgRmFpbGVkIHRvIGNvbnZlcnQgcGFsZXR0ZSB0byBDU1M6ICR7ZXJyb3J9YCkpO1xuXHRcdH1cblx0fSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHRvSlNPTihwYWxldHRlOiBQYWxldHRlKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QganNvbkRhdGEgPSBKU09OLnN0cmluZ2lmeShwYWxldHRlLCBudWxsLCAyKTtcblxuXHRcdFx0cmVzb2x2ZShqc29uRGF0YSk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGlmICghbW9kZS5xdWlldCAmJiBsb2dNb2RlLmVycm9ycykge1xuXHRcdFx0XHRpZiAobG9nTW9kZS52ZXJib3NpdHkgPiAxKSB7XG5cdFx0XHRcdFx0bG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gY29udmVydCBwYWxldHRlIHRvIEpTT046ICR7ZXJyb3J9YCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0bG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gY29udmVydCBwYWxldHRlIHRvIEpTT04nKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRpZiAobW9kZS5zdGFja1RyYWNlKSB7XG5cdFx0XHRcdGNvbnNvbGUudHJhY2UoJ1N0YWNrIFRyYWNlOicpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZWplY3QobmV3IEVycm9yKGBGYWlsZWQgdG8gY29udmVydCBwYWxldHRlIHRvIEpTT046ICR7ZXJyb3J9YCkpO1xuXHRcdH1cblx0fSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHRvWE1MKHBhbGV0dGU6IFBhbGV0dGUpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdHRyeSB7XG5cdFx0XHQvLyAxLiBzZXJpYWxpemUgcGFsZXR0ZSBtZXRhZGF0YVxuXHRcdFx0Y29uc3QgY3VzdG9tQ29sb3JYTUwgPSBwYWxldHRlLm1ldGFkYXRhLmN1c3RvbUNvbG9yXG5cdFx0XHRcdD8gYFxuXHRcdFx0XHQ8Q3VzdG9tQ29sb3I+XG5cdFx0XHRcdFx0PENNWUs+JHtwYWxldHRlLm1ldGFkYXRhLmN1c3RvbUNvbG9yLmNvbnZlcnRlZENvbG9ycy5jbXlrfTwvQ01ZSz5cblx0XHRcdFx0XHQ8SGV4PiR7cGFsZXR0ZS5tZXRhZGF0YS5jdXN0b21Db2xvci5jb252ZXJ0ZWRDb2xvcnMuaGV4fTwvSGV4PlxuXHRcdFx0XHRcdDxIU0w+JHtwYWxldHRlLm1ldGFkYXRhLmN1c3RvbUNvbG9yLmNvbnZlcnRlZENvbG9ycy5oc2x9PC9IU0w+XG5cdFx0XHRcdFx0PEhTVj4ke3BhbGV0dGUubWV0YWRhdGEuY3VzdG9tQ29sb3IuY29udmVydGVkQ29sb3JzLmhzdn08L0hTVj5cblx0XHRcdFx0XHQ8TEFCPiR7cGFsZXR0ZS5tZXRhZGF0YS5jdXN0b21Db2xvci5jb252ZXJ0ZWRDb2xvcnMubGFifTwvTEFCPlxuXHRcdFx0XHRcdDxSR0I+JHtwYWxldHRlLm1ldGFkYXRhLmN1c3RvbUNvbG9yLmNvbnZlcnRlZENvbG9ycy5yZ2J9PC9SR0I+XG5cdFx0XHRcdFx0PFhZWj4ke3BhbGV0dGUubWV0YWRhdGEuY3VzdG9tQ29sb3IuY29udmVydGVkQ29sb3JzLnh5en08L1hZWj5cblx0XHRcdFx0PC9DdXN0b21Db2xvcj5gLnRyaW0oKVxuXHRcdFx0XHQ6ICc8Q3VzdG9tQ29sb3I+ZmFsc2U8L0N1c3RvbUNvbG9yPic7XG5cblx0XHRcdGNvbnN0IG1ldGFkYXRhID0gYFxuXHRcdFx0XHQ8TWV0YWRhdGE+XG5cdFx0XHRcdFx0PE5hbWU+JHtwYWxldHRlLm1ldGFkYXRhLm5hbWUgPz8gJ1VubmFtZWQgUGFsZXR0ZSd9PC9OYW1lPlxuXHRcdFx0XHRcdDxUaW1lc3RhbXA+JHtwYWxldHRlLm1ldGFkYXRhLnRpbWVzdGFtcH08L1RpbWVzdGFtcD5cblx0XHRcdFx0XHQ8U3dhdGNoZXM+JHtwYWxldHRlLm1ldGFkYXRhLnN3YXRjaGVzfTwvU3dhdGNoZXM+XG5cdFx0XHRcdFx0PFR5cGU+JHtwYWxldHRlLm1ldGFkYXRhLnR5cGV9PC9UeXBlPlxuXHRcdFx0XHRcdCR7Y3VzdG9tQ29sb3JYTUx9XG5cdFx0XHRcdFx0PEZsYWdzPlxuXHRcdFx0XHRcdFx0PEVuYWJsZUFscGhhPiR7cGFsZXR0ZS5tZXRhZGF0YS5mbGFncy5lbmFibGVBbHBoYX08L0VuYWJsZUFscGhhPlxuXHRcdFx0XHRcdFx0PExpbWl0RGFya25lc3M+JHtwYWxldHRlLm1ldGFkYXRhLmZsYWdzLmxpbWl0RGFya25lc3N9PC9MaW1pdERhcmtuZXNzPlxuXHRcdFx0XHRcdFx0PExpbWl0R3JheW5lc3M+JHtwYWxldHRlLm1ldGFkYXRhLmZsYWdzLmxpbWl0R3JheW5lc3N9PC9MaW1pdEdyYXluZXNzPlxuXHRcdFx0XHRcdFx0PExpbWl0TGlnaHRuZXNzPiR7cGFsZXR0ZS5tZXRhZGF0YS5mbGFncy5saW1pdExpZ2h0bmVzc308L0xpbWl0TGlnaHRuZXNzPlxuXHRcdFx0XHRcdDwvRmxhZ3M+XG5cdFx0XHRcdDwvTWV0YWRhdGE+YC50cmltKCk7XG5cblx0XHRcdC8vIDIuIHNlcmlhbGl6ZSBwYWxldHRlIGl0ZW1zXG5cdFx0XHRjb25zdCB4bWxJdGVtcyA9IHBhbGV0dGUuaXRlbXNcblx0XHRcdFx0Lm1hcCgoaXRlbSwgaW5kZXgpID0+XG5cdFx0XHRcdFx0YFxuXHRcdFx0XHRcdDxQYWxldHRlSXRlbSBpZD1cIiR7aW5kZXggKyAxfVwiPlxuXHRcdFx0XHRcdFx0PENvbG9ycz5cblx0XHRcdFx0XHRcdFx0PENNWUs+JHtpdGVtLmNvbG9ycy5jbXlrfTwvQ01ZSz5cblx0XHRcdFx0XHRcdFx0PEhleD4ke2l0ZW0uY29sb3JzLmhleH08L0hleD5cblx0XHRcdFx0XHRcdFx0PEhTTD4ke2l0ZW0uY29sb3JzLmhzbH08L0hTTD5cblx0XHRcdFx0XHRcdFx0PEhTVj4ke2l0ZW0uY29sb3JzLmhzdn08L0hTVj5cblx0XHRcdFx0XHRcdFx0PExBQj4ke2l0ZW0uY29sb3JzLmxhYn08L0xBQj5cblx0XHRcdFx0XHRcdFx0PFJHQj4ke2l0ZW0uY29sb3JzLnJnYn08L1JHQj5cblx0XHRcdFx0XHRcdFx0PFhZWj4ke2l0ZW0uY29sb3JzLnh5en08L1hZWj5cblx0XHRcdFx0XHRcdDwvQ29sb3JzPlxuXHRcdFx0XHRcdFx0PENTU19Db2xvcnM+XG5cdFx0XHRcdFx0XHRcdDxDTVlLX0NTUz4ke2l0ZW0uY3NzU3RyaW5ncy5jbXlrQ1NTU3RyaW5nfTwvQ01ZS19DU1M+XG5cdFx0XHRcdFx0XHRcdDxIZXhfQ1NTPiR7aXRlbS5jc3NTdHJpbmdzLmhleENTU1N0cmluZ308L0hleF9DU1M+XG5cdFx0XHRcdFx0XHRcdDxIU0xfQ1NTPiR7aXRlbS5jc3NTdHJpbmdzLmhzbENTU1N0cmluZ308L0hTTF9DU1M+XG5cdFx0XHRcdFx0XHRcdDxIU1ZfQ1NTPiR7aXRlbS5jc3NTdHJpbmdzLmhzdkNTU1N0cmluZ308L0hTVl9DU1M+XG5cdFx0XHRcdFx0XHRcdDxMQUJfQ1NTPiR7aXRlbS5jc3NTdHJpbmdzLmxhYkNTU1N0cmluZ308L0xBQl9DU1M+XG5cdFx0XHRcdFx0XHRcdDxSR0JfQ1NTPiR7aXRlbS5jc3NTdHJpbmdzLnJnYkNTU1N0cmluZ308L1JHQl9DU1M+XG5cdFx0XHRcdFx0XHRcdDxYWVpfQ1NTPiR7aXRlbS5jc3NTdHJpbmdzLnh5ekNTU1N0cmluZ308L1hZWl9DU1M+XG5cdFx0XHRcdFx0XHQ8L0NTU19Db2xvcnM+XG5cdFx0XHRcdFx0PC9QYWxldHRlSXRlbT5gLnRyaW0oKVxuXHRcdFx0XHQpXG5cdFx0XHRcdC5qb2luKCdcXG4nKTtcblxuXHRcdFx0Ly8gMy4gY29tYmluZSBtZXRhZGF0YSBhbmQgaXRlbXMgaW50byB0aGUgcGFsZXR0ZSBYTUxcblx0XHRcdGNvbnN0IHhtbERhdGEgPSBgXG5cdFx0XHRcdDxQYWxldHRlIGlkPSR7cGFsZXR0ZS5pZH0+XG5cdFx0XHRcdFx0JHttZXRhZGF0YX1cblx0XHRcdFx0XHQ8SXRlbXM+XG5cdFx0XHRcdFx0XHQke3htbEl0ZW1zfVxuXHRcdFx0XHRcdDwvSXRlbXM+XG5cdFx0XHRcdDwvUGFsZXR0ZT5gLnRyaW0oKTtcblxuXHRcdFx0cmVzb2x2ZSh4bWxEYXRhLnRyaW0oKSk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGlmICghbW9kZS5xdWlldCAmJiBsb2dNb2RlLmVycm9ycykge1xuXHRcdFx0XHRpZiAobG9nTW9kZS52ZXJib3NpdHkgPiAxKSB7XG5cdFx0XHRcdFx0bG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gY29udmVydCBwYWxldHRlIHRvIFhNTDogJHtlcnJvcn1gKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBjb252ZXJ0IHBhbGV0dGUgdG8gWE1MJyk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0aWYgKG1vZGUuc3RhY2tUcmFjZSkge1xuXHRcdFx0XHRjb25zb2xlLnRyYWNlKCdTdGFjayBUcmFjZTonKTtcblx0XHRcdH1cblxuXHRcdFx0cmVqZWN0KG5ldyBFcnJvcihgRmFpbGVkIHRvIGNvbnZlcnQgcGFsZXR0ZSB0byBYTUw6ICR7ZXJyb3J9YCkpO1xuXHRcdH1cblx0fSk7XG59XG5cbmV4cG9ydCBjb25zdCBzZXJpYWxpemU6IElPX0ludGVyZmFjZVsnc2VyaWFsaXplJ10gPSB7XG5cdHRvQ1NTLFxuXHR0b0pTT04sXG5cdHRvWE1MXG59O1xuIl19