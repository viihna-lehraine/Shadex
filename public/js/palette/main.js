// File: src/palette/main.js
import { IDBManager } from '../classes/idb/index.js';
import { core, helpers, utils } from '../common/index.js';
import { data } from '../data/index.js';
import { genPalette as genPaletteType } from './main/index.js';
import { log } from '../classes/logger/index.js';
import { paletteHelpers } from './common/index.js';
import { transform } from '../common/transform/index.js';
const defaultPalette = data.defaults.palette.unbrandedData;
const defaultBrandedPalete = transform.brandPalette(defaultPalette);
const limits = paletteHelpers.limits;
const logMode = data.mode.logging;
const mode = data.mode;
const idb = IDBManager.getInstance();
const isTooDark = limits.isTooDark;
const isTooGray = limits.isTooGray;
const isTooLight = limits.isTooLight;
async function genPalette(options) {
    try {
        let { numBoxes, customColor } = options;
        if (logMode.info && logMode.verbosity > 2)
            log.info('Retrieving existing IDBManager instance.');
        const idb = IDBManager.getInstance();
        if (customColor === null || customColor === undefined) {
            if (logMode.errors)
                log.error('Custom color is null or undefined.');
            return;
        }
        const validatedCustomColor = helpers.dom.validateAndConvertColor(customColor) ??
            utils.random.hsl(options.enableAlpha);
        if (mode.debug && logMode.info && logMode.verbosity > 2)
            log.info(`Custom color: ${JSON.stringify(customColor)}`);
        options.customColor = validatedCustomColor;
        const palette = await generate.selectedPalette(options);
        if (palette.items.length === 0) {
            if (logMode.errors)
                log.error('Colors array is empty or invalid.');
            return;
        }
        if (!mode.quiet && logMode.info && logMode.verbosity > 0)
            log.info(`Colors array generated: ${JSON.stringify(palette.items)}`);
        const tableId = await idb.getNextTableID();
        if (!tableId)
            throw new Error('Table ID is null or undefined.');
        await genPaletteDOMBox(palette.items, numBoxes, tableId);
    }
    catch (error) {
        if (logMode.errors)
            log.error(`Error starting palette generation: ${error}`);
    }
}
async function genPaletteDOMBox(items, numBoxes, tableId) {
    try {
        const paletteRow = document.getElementById('palette-row');
        if (!paletteRow) {
            if (logMode.errors)
                log.error('paletteRow is undefined.');
            return;
        }
        paletteRow.innerHTML = '';
        const fragment = document.createDocumentFragment();
        items.slice(0, numBoxes).forEach((item, i) => {
            const color = { value: item.colors.hsl, format: 'hsl' };
            const { colorStripe } = helpers.dom.makePaletteBox(color, i + 1);
            fragment.appendChild(colorStripe);
            utils.palette.populateOutputBox(color, i + 1);
        });
        paletteRow.appendChild(fragment);
        if (!mode.quiet && logMode.info && logMode.verbosity > 1)
            log.info('Palette boxes generated and rendered.');
        await idb.saveData('tables', tableId, { palette: items });
    }
    catch (error) {
        if (logMode.errors)
            log.error(`Error generating palette box: ${error}`);
    }
}
export const start = {
    genPalette,
    genPaletteDOMBox
};
// ******** GENERATE ********
function limitedHSL(baseHue, limitDark, limitGray, limitLight, alphaValue) {
    let hsl;
    do {
        hsl = {
            value: {
                hue: core.brand.asRadial(baseHue),
                saturation: core.brand.asPercentile(Math.random() * 100),
                lightness: core.brand.asPercentile(Math.random() * 100),
                alpha: alphaValue
                    ? core.brand.asAlphaRange(alphaValue)
                    : core.brand.asAlphaRange(1)
            },
            format: 'hsl'
        };
    } while ((limitGray && isTooGray(hsl)) ||
        (limitDark && isTooDark(hsl)) ||
        (limitLight && isTooLight(hsl)));
    return hsl;
}
async function selectedPalette(options) {
    try {
        const { paletteType, numBoxes, customColor, enableAlpha, limitDarkness, limitGrayness, limitLightness } = options;
        const args = {
            numBoxes,
            customColor,
            enableAlpha,
            limitDark: limitDarkness,
            limitGray: limitGrayness,
            limitLight: limitLightness
        };
        switch (paletteType) {
            case 1:
                return genPaletteType.random(args);
            case 2:
                return genPaletteType.complementary(args);
            case 3:
                return genPaletteType.triadic(args);
            case 4:
                return genPaletteType.tetradic(args);
            case 5:
                return genPaletteType.splitComplementary(args);
            case 6:
                return genPaletteType.analogous(args);
            case 7:
                return genPaletteType.hexadic(args);
            case 8:
                return genPaletteType.diadic(args);
            case 9:
                return genPaletteType.monochromatic(args);
            default:
                if (logMode.errors)
                    log.error('Invalid palette type.');
                return Promise.resolve(defaultBrandedPalete);
        }
    }
    catch (error) {
        if (logMode.errors)
            console.error(`Error generating palette: ${error}`);
        return Promise.resolve(defaultBrandedPalete);
    }
}
export const generate = {
    limitedHSL,
    selectedPalette
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYWxldHRlL21haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNEJBQTRCO0FBVzVCLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFFLFVBQVUsSUFBSSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUV6RCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUM7QUFDM0QsTUFBTSxvQkFBb0IsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBRXBFLE1BQU0sTUFBTSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUM7QUFDckMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7QUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztBQUV2QixNQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUM7QUFFckMsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQztBQUNuQyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO0FBQ25DLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7QUFFckMsS0FBSyxVQUFVLFVBQVUsQ0FB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O0lBQ25ELFVBQVU7SUFDVixlQUFlO0NBQ04sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZpbGU6IHNyYy9wYWxldHRlL21haW4uanNcblxuaW1wb3J0IHtcblx0R2VuUGFsZXR0ZUFyZ3MsXG5cdEhTTCxcblx0UGFsZXR0ZSxcblx0UGFsZXR0ZUdlbmVyYXRlRm5JbnRlcmZhY2UsXG5cdFBhbGV0dGVJdGVtLFxuXHRQYWxldHRlT3B0aW9ucyxcblx0UGFsZXR0ZVN0YXJ0Rm5JbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW5kZXguanMnO1xuaW1wb3J0IHsgSURCTWFuYWdlciB9IGZyb20gJy4uL2NsYXNzZXMvaWRiL2luZGV4LmpzJztcbmltcG9ydCB7IGNvcmUsIGhlbHBlcnMsIHV0aWxzIH0gZnJvbSAnLi4vY29tbW9uL2luZGV4LmpzJztcbmltcG9ydCB7IGRhdGEgfSBmcm9tICcuLi9kYXRhL2luZGV4LmpzJztcbmltcG9ydCB7IGdlblBhbGV0dGUgYXMgZ2VuUGFsZXR0ZVR5cGUgfSBmcm9tICcuL21haW4vaW5kZXguanMnO1xuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vY2xhc3Nlcy9sb2dnZXIvaW5kZXguanMnO1xuaW1wb3J0IHsgcGFsZXR0ZUhlbHBlcnMgfSBmcm9tICcuL2NvbW1vbi9pbmRleC5qcyc7XG5pbXBvcnQgeyB0cmFuc2Zvcm0gfSBmcm9tICcuLi9jb21tb24vdHJhbnNmb3JtL2luZGV4LmpzJztcblxuY29uc3QgZGVmYXVsdFBhbGV0dGUgPSBkYXRhLmRlZmF1bHRzLnBhbGV0dGUudW5icmFuZGVkRGF0YTtcbmNvbnN0IGRlZmF1bHRCcmFuZGVkUGFsZXRlID0gdHJhbnNmb3JtLmJyYW5kUGFsZXR0ZShkZWZhdWx0UGFsZXR0ZSk7XG5cbmNvbnN0IGxpbWl0cyA9IHBhbGV0dGVIZWxwZXJzLmxpbWl0cztcbmNvbnN0IGxvZ01vZGUgPSBkYXRhLm1vZGUubG9nZ2luZztcbmNvbnN0IG1vZGUgPSBkYXRhLm1vZGU7XG5cbmNvbnN0IGlkYiA9IElEQk1hbmFnZXIuZ2V0SW5zdGFuY2UoKTtcblxuY29uc3QgaXNUb29EYXJrID0gbGltaXRzLmlzVG9vRGFyaztcbmNvbnN0IGlzVG9vR3JheSA9IGxpbWl0cy5pc1Rvb0dyYXk7XG5jb25zdCBpc1Rvb0xpZ2h0ID0gbGltaXRzLmlzVG9vTGlnaHQ7XG5cbmFzeW5jIGZ1bmN0aW9uIGdlblBhbGV0dGUob3B0aW9uczogUGFsZXR0ZU9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcblx0dHJ5IHtcblx0XHRsZXQgeyBudW1Cb3hlcywgY3VzdG9tQ29sb3IgfSA9IG9wdGlvbnM7XG5cblx0XHRpZiAobG9nTW9kZS5pbmZvICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMilcblx0XHRcdGxvZy5pbmZvKCdSZXRyaWV2aW5nIGV4aXN0aW5nIElEQk1hbmFnZXIgaW5zdGFuY2UuJyk7XG5cblx0XHRjb25zdCBpZGIgPSBJREJNYW5hZ2VyLmdldEluc3RhbmNlKCk7XG5cblx0XHRpZiAoY3VzdG9tQ29sb3IgPT09IG51bGwgfHwgY3VzdG9tQ29sb3IgPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0aWYgKGxvZ01vZGUuZXJyb3JzKSBsb2cuZXJyb3IoJ0N1c3RvbSBjb2xvciBpcyBudWxsIG9yIHVuZGVmaW5lZC4nKTtcblxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnN0IHZhbGlkYXRlZEN1c3RvbUNvbG9yOiBIU0wgPVxuXHRcdFx0KGhlbHBlcnMuZG9tLnZhbGlkYXRlQW5kQ29udmVydENvbG9yKGN1c3RvbUNvbG9yKSBhcyBIU0wpID8/XG5cdFx0XHR1dGlscy5yYW5kb20uaHNsKG9wdGlvbnMuZW5hYmxlQWxwaGEpO1xuXG5cdFx0aWYgKG1vZGUuZGVidWcgJiYgbG9nTW9kZS5pbmZvICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMilcblx0XHRcdGxvZy5pbmZvKGBDdXN0b20gY29sb3I6ICR7SlNPTi5zdHJpbmdpZnkoY3VzdG9tQ29sb3IpfWApO1xuXG5cdFx0b3B0aW9ucy5jdXN0b21Db2xvciA9IHZhbGlkYXRlZEN1c3RvbUNvbG9yO1xuXG5cdFx0Y29uc3QgcGFsZXR0ZSA9IGF3YWl0IGdlbmVyYXRlLnNlbGVjdGVkUGFsZXR0ZShvcHRpb25zKTtcblxuXHRcdGlmIChwYWxldHRlLml0ZW1zLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0aWYgKGxvZ01vZGUuZXJyb3JzKSBsb2cuZXJyb3IoJ0NvbG9ycyBhcnJheSBpcyBlbXB0eSBvciBpbnZhbGlkLicpO1xuXG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKCFtb2RlLnF1aWV0ICYmIGxvZ01vZGUuaW5mbyAmJiBsb2dNb2RlLnZlcmJvc2l0eSA+IDApXG5cdFx0XHRsb2cuaW5mbyhcblx0XHRcdFx0YENvbG9ycyBhcnJheSBnZW5lcmF0ZWQ6ICR7SlNPTi5zdHJpbmdpZnkocGFsZXR0ZS5pdGVtcyl9YFxuXHRcdFx0KTtcblxuXHRcdGNvbnN0IHRhYmxlSWQgPSBhd2FpdCBpZGIuZ2V0TmV4dFRhYmxlSUQoKTtcblxuXHRcdGlmICghdGFibGVJZCkgdGhyb3cgbmV3IEVycm9yKCdUYWJsZSBJRCBpcyBudWxsIG9yIHVuZGVmaW5lZC4nKTtcblxuXHRcdGF3YWl0IGdlblBhbGV0dGVET01Cb3gocGFsZXR0ZS5pdGVtcywgbnVtQm94ZXMsIHRhYmxlSWQpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGlmIChsb2dNb2RlLmVycm9ycylcblx0XHRcdGxvZy5lcnJvcihgRXJyb3Igc3RhcnRpbmcgcGFsZXR0ZSBnZW5lcmF0aW9uOiAke2Vycm9yfWApO1xuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlblBhbGV0dGVET01Cb3goXG5cdGl0ZW1zOiBQYWxldHRlSXRlbVtdLFxuXHRudW1Cb3hlczogbnVtYmVyLFxuXHR0YWJsZUlkOiBzdHJpbmdcbik6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IHBhbGV0dGVSb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFsZXR0ZS1yb3cnKTtcblxuXHRcdGlmICghcGFsZXR0ZVJvdykge1xuXHRcdFx0aWYgKGxvZ01vZGUuZXJyb3JzKSBsb2cuZXJyb3IoJ3BhbGV0dGVSb3cgaXMgdW5kZWZpbmVkLicpO1xuXG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0cGFsZXR0ZVJvdy5pbm5lckhUTUwgPSAnJztcblxuXHRcdGNvbnN0IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO1xuXG5cdFx0aXRlbXMuc2xpY2UoMCwgbnVtQm94ZXMpLmZvckVhY2goKGl0ZW0sIGkpID0+IHtcblx0XHRcdGNvbnN0IGNvbG9yOiBIU0wgPSB7IHZhbHVlOiBpdGVtLmNvbG9ycy5oc2wsIGZvcm1hdDogJ2hzbCcgfTtcblx0XHRcdGNvbnN0IHsgY29sb3JTdHJpcGUgfSA9IGhlbHBlcnMuZG9tLm1ha2VQYWxldHRlQm94KGNvbG9yLCBpICsgMSk7XG5cblx0XHRcdGZyYWdtZW50LmFwcGVuZENoaWxkKGNvbG9yU3RyaXBlKTtcblxuXHRcdFx0dXRpbHMucGFsZXR0ZS5wb3B1bGF0ZU91dHB1dEJveChjb2xvciwgaSArIDEpO1xuXHRcdH0pO1xuXG5cdFx0cGFsZXR0ZVJvdy5hcHBlbmRDaGlsZChmcmFnbWVudCk7XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS5pbmZvICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMSlcblx0XHRcdGxvZy5pbmZvKCdQYWxldHRlIGJveGVzIGdlbmVyYXRlZCBhbmQgcmVuZGVyZWQuJyk7XG5cblx0XHRhd2FpdCBpZGIuc2F2ZURhdGEoJ3RhYmxlcycsIHRhYmxlSWQsIHsgcGFsZXR0ZTogaXRlbXMgfSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3JzKSBsb2cuZXJyb3IoYEVycm9yIGdlbmVyYXRpbmcgcGFsZXR0ZSBib3g6ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuZXhwb3J0IGNvbnN0IHN0YXJ0OiBQYWxldHRlU3RhcnRGbkludGVyZmFjZSA9IHtcblx0Z2VuUGFsZXR0ZSxcblx0Z2VuUGFsZXR0ZURPTUJveFxufSBhcyBjb25zdDtcblxuLy8gKioqKioqKiogR0VORVJBVEUgKioqKioqKipcblxuZnVuY3Rpb24gbGltaXRlZEhTTChcblx0YmFzZUh1ZTogbnVtYmVyLFxuXHRsaW1pdERhcms6IGJvb2xlYW4sXG5cdGxpbWl0R3JheTogYm9vbGVhbixcblx0bGltaXRMaWdodDogYm9vbGVhbixcblx0YWxwaGFWYWx1ZTogbnVtYmVyIHwgbnVsbFxuKTogSFNMIHtcblx0bGV0IGhzbDogSFNMO1xuXG5cdGRvIHtcblx0XHRoc2wgPSB7XG5cdFx0XHR2YWx1ZToge1xuXHRcdFx0XHRodWU6IGNvcmUuYnJhbmQuYXNSYWRpYWwoYmFzZUh1ZSksXG5cdFx0XHRcdHNhdHVyYXRpb246IGNvcmUuYnJhbmQuYXNQZXJjZW50aWxlKE1hdGgucmFuZG9tKCkgKiAxMDApLFxuXHRcdFx0XHRsaWdodG5lc3M6IGNvcmUuYnJhbmQuYXNQZXJjZW50aWxlKE1hdGgucmFuZG9tKCkgKiAxMDApLFxuXHRcdFx0XHRhbHBoYTogYWxwaGFWYWx1ZVxuXHRcdFx0XHRcdD8gY29yZS5icmFuZC5hc0FscGhhUmFuZ2UoYWxwaGFWYWx1ZSlcblx0XHRcdFx0XHQ6IGNvcmUuYnJhbmQuYXNBbHBoYVJhbmdlKDEpXG5cdFx0XHR9LFxuXHRcdFx0Zm9ybWF0OiAnaHNsJ1xuXHRcdH07XG5cdH0gd2hpbGUgKFxuXHRcdChsaW1pdEdyYXkgJiYgaXNUb29HcmF5KGhzbCkpIHx8XG5cdFx0KGxpbWl0RGFyayAmJiBpc1Rvb0RhcmsoaHNsKSkgfHxcblx0XHQobGltaXRMaWdodCAmJiBpc1Rvb0xpZ2h0KGhzbCkpXG5cdCk7XG5cblx0cmV0dXJuIGhzbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VsZWN0ZWRQYWxldHRlKG9wdGlvbnM6IFBhbGV0dGVPcHRpb25zKTogUHJvbWlzZTxQYWxldHRlPiB7XG5cdHRyeSB7XG5cdFx0Y29uc3Qge1xuXHRcdFx0cGFsZXR0ZVR5cGUsXG5cdFx0XHRudW1Cb3hlcyxcblx0XHRcdGN1c3RvbUNvbG9yLFxuXHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRsaW1pdERhcmtuZXNzLFxuXHRcdFx0bGltaXRHcmF5bmVzcyxcblx0XHRcdGxpbWl0TGlnaHRuZXNzXG5cdFx0fSA9IG9wdGlvbnM7XG5cblx0XHRjb25zdCBhcmdzOiBHZW5QYWxldHRlQXJncyA9IHtcblx0XHRcdG51bUJveGVzLFxuXHRcdFx0Y3VzdG9tQ29sb3IsXG5cdFx0XHRlbmFibGVBbHBoYSxcblx0XHRcdGxpbWl0RGFyazogbGltaXREYXJrbmVzcyxcblx0XHRcdGxpbWl0R3JheTogbGltaXRHcmF5bmVzcyxcblx0XHRcdGxpbWl0TGlnaHQ6IGxpbWl0TGlnaHRuZXNzXG5cdFx0fTtcblxuXHRcdHN3aXRjaCAocGFsZXR0ZVR5cGUpIHtcblx0XHRcdGNhc2UgMTpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLnJhbmRvbShhcmdzKTtcblx0XHRcdGNhc2UgMjpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLmNvbXBsZW1lbnRhcnkoYXJncyk7XG5cdFx0XHRjYXNlIDM6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS50cmlhZGljKGFyZ3MpO1xuXHRcdFx0Y2FzZSA0OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUudGV0cmFkaWMoYXJncyk7XG5cdFx0XHRjYXNlIDU6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5zcGxpdENvbXBsZW1lbnRhcnkoYXJncyk7XG5cdFx0XHRjYXNlIDY6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5hbmFsb2dvdXMoYXJncyk7XG5cdFx0XHRjYXNlIDc6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5oZXhhZGljKGFyZ3MpO1xuXHRcdFx0Y2FzZSA4OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUuZGlhZGljKGFyZ3MpO1xuXHRcdFx0Y2FzZSA5OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUubW9ub2Nocm9tYXRpYyhhcmdzKTtcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdGlmIChsb2dNb2RlLmVycm9ycykgbG9nLmVycm9yKCdJbnZhbGlkIHBhbGV0dGUgdHlwZS4nKTtcblxuXHRcdFx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRlZmF1bHRCcmFuZGVkUGFsZXRlKTtcblx0XHR9XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3JzKSBjb25zb2xlLmVycm9yKGBFcnJvciBnZW5lcmF0aW5nIHBhbGV0dGU6ICR7ZXJyb3J9YCk7XG5cblx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRlZmF1bHRCcmFuZGVkUGFsZXRlKTtcblx0fVxufVxuXG5leHBvcnQgY29uc3QgZ2VuZXJhdGU6IFBhbGV0dGVHZW5lcmF0ZUZuSW50ZXJmYWNlID0ge1xuXHRsaW1pdGVkSFNMLFxuXHRzZWxlY3RlZFBhbGV0dGVcbn0gYXMgY29uc3Q7XG4iXX0=