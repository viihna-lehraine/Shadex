// File: src/palette/main.js
import { IDBManager } from '../idb/index.js';
import { core, helpers, utils } from '../common/index.js';
import { data } from '../data/index.js';
import { genPalette as genPaletteType } from './main/index.js';
import { paletteHelpers } from './common/index.js';
import { transform } from '../common/transform/index.js';
const defaultPalette = data.defaults.palette.unbrandedData;
const defaultBrandedPalete = transform.brandPalette(defaultPalette);
const limits = paletteHelpers.limits;
const mode = data.mode;
const idb = IDBManager.getInstance();
const isTooDark = limits.isTooDark;
const isTooGray = limits.isTooGray;
const isTooLight = limits.isTooLight;
async function genPalette(options) {
    try {
        let { numBoxes, customColor } = options;
        if (mode.verbose)
            console.log('Retrieving existing IDBManager instance.');
        const idb = IDBManager.getInstance();
        if (customColor === null || customColor === undefined) {
            if (mode.errorLogs)
                console.error('Custom color is null or undefined.');
            return;
        }
        const validatedCustomColor = helpers.dom.validateAndConvertColor(customColor) ??
            utils.random.hsl(options.enableAlpha);
        if (mode.debug)
            console.log(`Custom color: ${JSON.stringify(customColor)}`);
        options.customColor = validatedCustomColor;
        const palette = await generate.selectedPalette(options);
        if (palette.items.length === 0) {
            if (mode.errorLogs)
                console.error('Colors array is empty or invalid.');
            return;
        }
        if (!mode.quiet)
            console.log(`Colors array generated: ${JSON.stringify(palette.items)}`);
        const tableId = await idb.getNextTableID();
        if (!tableId)
            throw new Error('Table ID is null or undefined.');
        await genPaletteDOMBox(palette.items, numBoxes, tableId);
    }
    catch (error) {
        if (mode.errorLogs)
            console.error(`Error starting palette generation: ${error}`);
    }
}
async function genPaletteDOMBox(items, numBoxes, tableId) {
    try {
        const paletteRow = document.getElementById('palette-row');
        if (!paletteRow) {
            if (mode.errorLogs)
                console.error('paletteRow is undefined.');
            return;
        }
        paletteRow.innerHTML = '';
        const fragment = document.createDocumentFragment();
        items.slice(0, numBoxes).forEach((item, i) => {
            const color = { value: item.colors.hsl, format: 'hsl' };
            const { colorStripe } = helpers.dom.makePaletteBox(color, i + 1);
            fragment.appendChild(colorStripe);
            utils.palette.populateOutputBox(color, i + 1);
        });
        paletteRow.appendChild(fragment);
        if (!mode.quiet)
            console.log('Palette boxes generated and rendered.');
        await idb.saveData('tables', tableId, { palette: items });
    }
    catch (error) {
        if (mode.errorLogs)
            console.error(`Error generating palette box: ${error}`);
    }
}
export const start = {
    genPalette,
    genPaletteDOMBox
};
// ******** GENERATE ********
function limitedHSL(baseHue, limitDark, limitGray, limitLight, alphaValue) {
    let hsl;
    do {
        hsl = {
            value: {
                hue: core.brand.asRadial(baseHue),
                saturation: core.brand.asPercentile(Math.random() * 100),
                lightness: core.brand.asPercentile(Math.random() * 100),
                alpha: alphaValue
                    ? core.brand.asAlphaRange(alphaValue)
                    : core.brand.asAlphaRange(1)
            },
            format: 'hsl'
        };
    } while ((limitGray && isTooGray(hsl)) ||
        (limitDark && isTooDark(hsl)) ||
        (limitLight && isTooLight(hsl)));
    return hsl;
}
async function selectedPalette(options) {
    try {
        const { paletteType, numBoxes, customColor, enableAlpha, limitDarkness, limitGrayness, limitLightness } = options;
        const args = {
            numBoxes,
            customColor,
            enableAlpha,
            limitDark: limitDarkness,
            limitGray: limitGrayness,
            limitLight: limitLightness
        };
        switch (paletteType) {
            case 1:
                return genPaletteType.random(args);
            case 2:
                return genPaletteType.complementary(args);
            case 3:
                return genPaletteType.triadic(args);
            case 4:
                return genPaletteType.tetradic(args);
            case 5:
                return genPaletteType.splitComplementary(args);
            case 6:
                return genPaletteType.analogous(args);
            case 7:
                return genPaletteType.hexadic(args);
            case 8:
                return genPaletteType.diadic(args);
            case 9:
                return genPaletteType.monochromatic(args);
            default:
                if (mode.errorLogs)
                    console.error('Invalid palette type.');
                return Promise.resolve(defaultBrandedPalete);
        }
    }
    catch (error) {
        if (mode.errorLogs)
            console.error(`Error generating palette: ${error}`);
        return Promise.resolve(defaultBrandedPalete);
    }
}
export const generate = {
    limitedHSL,
    selectedPalette
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYWxldHRlL21haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNEJBQTRCO0FBVzVCLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFFLFVBQVUsSUFBSSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRXpELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztBQUMzRCxNQUFNLG9CQUFvQixHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLENBQUM7QUFFcEUsTUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQztBQUNyQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBRXZCLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUVyQyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO0FBQ25DLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUM7QUFDbkMsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQztBQUVyQyxLQUFLLFVBQVUsVUFBVSxDQUFDLE9BQXVCO0lBQ2hELElBQUksQ0FBQztRQUNKLElBQUksRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLEdBQUcsT0FBTyxDQUFDO1FBRXhDLElBQUksSUFBSSxDQUFD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QUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEQsS0FBSyxDQUFDO2dCQUNMLE9BQU8sY0FBYyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN2QyxLQUFLLENBQUM7Z0JBQ0wsT0FBTyxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3JDLEtBQUssQ0FBQztnQkFDTCxPQUFPLGNBQWMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDcEMsS0FBSyxDQUFDO2dCQUNMLE9BQU8sY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMzQztnQkFDQyxJQUFJLElBQUksQ0FBQyxTQUFTO29CQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLENBQUMsQ0FBQztnQkFFM0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDL0MsQ0FBQztJQUNGLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2hCLElBQUksSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLDZCQUE2QixLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRXhFLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBQzlDLENBQUM7QUFDRixDQUFDO0FBRUQsTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUErQjtJQUNuRCxVQUFVO0lBQ1YsZUFBZTtDQUNOLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBGaWxlOiBzcmMvcGFsZXR0ZS9tYWluLmpzXG5cbmltcG9ydCB7XG5cdEdlblBhbGV0dGVBcmdzLFxuXHRIU0wsXG5cdFBhbGV0dGUsXG5cdFBhbGV0dGVHZW5lcmF0ZUZuSW50ZXJmYWNlLFxuXHRQYWxldHRlSXRlbSxcblx0UGFsZXR0ZU9wdGlvbnMsXG5cdFBhbGV0dGVTdGFydEZuSW50ZXJmYWNlXG59IGZyb20gJy4uL2luZGV4L2luZGV4LmpzJztcbmltcG9ydCB7IElEQk1hbmFnZXIgfSBmcm9tICcuLi9pZGIvaW5kZXguanMnO1xuaW1wb3J0IHsgY29yZSwgaGVscGVycywgdXRpbHMgfSBmcm9tICcuLi9jb21tb24vaW5kZXguanMnO1xuaW1wb3J0IHsgZGF0YSB9IGZyb20gJy4uL2RhdGEvaW5kZXguanMnO1xuaW1wb3J0IHsgZ2VuUGFsZXR0ZSBhcyBnZW5QYWxldHRlVHlwZSB9IGZyb20gJy4vbWFpbi9pbmRleC5qcyc7XG5pbXBvcnQgeyBwYWxldHRlSGVscGVycyB9IGZyb20gJy4vY29tbW9uL2luZGV4LmpzJztcbmltcG9ydCB7IHRyYW5zZm9ybSB9IGZyb20gJy4uL2NvbW1vbi90cmFuc2Zvcm0vaW5kZXguanMnO1xuXG5jb25zdCBkZWZhdWx0UGFsZXR0ZSA9IGRhdGEuZGVmYXVsdHMucGFsZXR0ZS51bmJyYW5kZWREYXRhO1xuY29uc3QgZGVmYXVsdEJyYW5kZWRQYWxldGUgPSB0cmFuc2Zvcm0uYnJhbmRQYWxldHRlKGRlZmF1bHRQYWxldHRlKTtcblxuY29uc3QgbGltaXRzID0gcGFsZXR0ZUhlbHBlcnMubGltaXRzO1xuY29uc3QgbW9kZSA9IGRhdGEubW9kZTtcblxuY29uc3QgaWRiID0gSURCTWFuYWdlci5nZXRJbnN0YW5jZSgpO1xuXG5jb25zdCBpc1Rvb0RhcmsgPSBsaW1pdHMuaXNUb29EYXJrO1xuY29uc3QgaXNUb29HcmF5ID0gbGltaXRzLmlzVG9vR3JheTtcbmNvbnN0IGlzVG9vTGlnaHQgPSBsaW1pdHMuaXNUb29MaWdodDtcblxuYXN5bmMgZnVuY3Rpb24gZ2VuUGFsZXR0ZShvcHRpb25zOiBQYWxldHRlT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGxldCB7IG51bUJveGVzLCBjdXN0b21Db2xvciB9ID0gb3B0aW9ucztcblxuXHRcdGlmIChtb2RlLnZlcmJvc2UpXG5cdFx0XHRjb25zb2xlLmxvZygnUmV0cmlldmluZyBleGlzdGluZyBJREJNYW5hZ2VyIGluc3RhbmNlLicpO1xuXG5cdFx0Y29uc3QgaWRiID0gSURCTWFuYWdlci5nZXRJbnN0YW5jZSgpO1xuXG5cdFx0aWYgKGN1c3RvbUNvbG9yID09PSBudWxsIHx8IGN1c3RvbUNvbG9yID09PSB1bmRlZmluZWQpIHtcblx0XHRcdGlmIChtb2RlLmVycm9yTG9ncylcblx0XHRcdFx0Y29uc29sZS5lcnJvcignQ3VzdG9tIGNvbG9yIGlzIG51bGwgb3IgdW5kZWZpbmVkLicpO1xuXG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Y29uc3QgdmFsaWRhdGVkQ3VzdG9tQ29sb3I6IEhTTCA9XG5cdFx0XHQoaGVscGVycy5kb20udmFsaWRhdGVBbmRDb252ZXJ0Q29sb3IoY3VzdG9tQ29sb3IpIGFzIEhTTCkgPz9cblx0XHRcdHV0aWxzLnJhbmRvbS5oc2wob3B0aW9ucy5lbmFibGVBbHBoYSk7XG5cblx0XHRpZiAobW9kZS5kZWJ1Zylcblx0XHRcdGNvbnNvbGUubG9nKGBDdXN0b20gY29sb3I6ICR7SlNPTi5zdHJpbmdpZnkoY3VzdG9tQ29sb3IpfWApO1xuXG5cdFx0b3B0aW9ucy5jdXN0b21Db2xvciA9IHZhbGlkYXRlZEN1c3RvbUNvbG9yO1xuXG5cdFx0Y29uc3QgcGFsZXR0ZSA9IGF3YWl0IGdlbmVyYXRlLnNlbGVjdGVkUGFsZXR0ZShvcHRpb25zKTtcblxuXHRcdGlmIChwYWxldHRlLml0ZW1zLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0aWYgKG1vZGUuZXJyb3JMb2dzKVxuXHRcdFx0XHRjb25zb2xlLmVycm9yKCdDb2xvcnMgYXJyYXkgaXMgZW1wdHkgb3IgaW52YWxpZC4nKTtcblxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmICghbW9kZS5xdWlldClcblx0XHRcdGNvbnNvbGUubG9nKFxuXHRcdFx0XHRgQ29sb3JzIGFycmF5IGdlbmVyYXRlZDogJHtKU09OLnN0cmluZ2lmeShwYWxldHRlLml0ZW1zKX1gXG5cdFx0XHQpO1xuXG5cdFx0Y29uc3QgdGFibGVJZCA9IGF3YWl0IGlkYi5nZXROZXh0VGFibGVJRCgpO1xuXG5cdFx0aWYgKCF0YWJsZUlkKSB0aHJvdyBuZXcgRXJyb3IoJ1RhYmxlIElEIGlzIG51bGwgb3IgdW5kZWZpbmVkLicpO1xuXG5cdFx0YXdhaXQgZ2VuUGFsZXR0ZURPTUJveChwYWxldHRlLml0ZW1zLCBudW1Cb3hlcywgdGFibGVJZCk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKG1vZGUuZXJyb3JMb2dzKVxuXHRcdFx0Y29uc29sZS5lcnJvcihgRXJyb3Igc3RhcnRpbmcgcGFsZXR0ZSBnZW5lcmF0aW9uOiAke2Vycm9yfWApO1xuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlblBhbGV0dGVET01Cb3goXG5cdGl0ZW1zOiBQYWxldHRlSXRlbVtdLFxuXHRudW1Cb3hlczogbnVtYmVyLFxuXHR0YWJsZUlkOiBzdHJpbmdcbik6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IHBhbGV0dGVSb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFsZXR0ZS1yb3cnKTtcblxuXHRcdGlmICghcGFsZXR0ZVJvdykge1xuXHRcdFx0aWYgKG1vZGUuZXJyb3JMb2dzKSBjb25zb2xlLmVycm9yKCdwYWxldHRlUm93IGlzIHVuZGVmaW5lZC4nKTtcblxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdHBhbGV0dGVSb3cuaW5uZXJIVE1MID0gJyc7XG5cblx0XHRjb25zdCBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTtcblxuXHRcdGl0ZW1zLnNsaWNlKDAsIG51bUJveGVzKS5mb3JFYWNoKChpdGVtLCBpKSA9PiB7XG5cdFx0XHRjb25zdCBjb2xvcjogSFNMID0geyB2YWx1ZTogaXRlbS5jb2xvcnMuaHNsLCBmb3JtYXQ6ICdoc2wnIH07XG5cdFx0XHRjb25zdCB7IGNvbG9yU3RyaXBlIH0gPSBoZWxwZXJzLmRvbS5tYWtlUGFsZXR0ZUJveChjb2xvciwgaSArIDEpO1xuXG5cdFx0XHRmcmFnbWVudC5hcHBlbmRDaGlsZChjb2xvclN0cmlwZSk7XG5cblx0XHRcdHV0aWxzLnBhbGV0dGUucG9wdWxhdGVPdXRwdXRCb3goY29sb3IsIGkgKyAxKTtcblx0XHR9KTtcblxuXHRcdHBhbGV0dGVSb3cuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpO1xuXG5cdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnUGFsZXR0ZSBib3hlcyBnZW5lcmF0ZWQgYW5kIHJlbmRlcmVkLicpO1xuXG5cdFx0YXdhaXQgaWRiLnNhdmVEYXRhKCd0YWJsZXMnLCB0YWJsZUlkLCB7IHBhbGV0dGU6IGl0ZW1zIH0pO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGlmIChtb2RlLmVycm9yTG9ncylcblx0XHRcdGNvbnNvbGUuZXJyb3IoYEVycm9yIGdlbmVyYXRpbmcgcGFsZXR0ZSBib3g6ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuZXhwb3J0IGNvbnN0IHN0YXJ0OiBQYWxldHRlU3RhcnRGbkludGVyZmFjZSA9IHtcblx0Z2VuUGFsZXR0ZSxcblx0Z2VuUGFsZXR0ZURPTUJveFxufSBhcyBjb25zdDtcblxuLy8gKioqKioqKiogR0VORVJBVEUgKioqKioqKipcblxuZnVuY3Rpb24gbGltaXRlZEhTTChcblx0YmFzZUh1ZTogbnVtYmVyLFxuXHRsaW1pdERhcms6IGJvb2xlYW4sXG5cdGxpbWl0R3JheTogYm9vbGVhbixcblx0bGltaXRMaWdodDogYm9vbGVhbixcblx0YWxwaGFWYWx1ZTogbnVtYmVyIHwgbnVsbFxuKTogSFNMIHtcblx0bGV0IGhzbDogSFNMO1xuXG5cdGRvIHtcblx0XHRoc2wgPSB7XG5cdFx0XHR2YWx1ZToge1xuXHRcdFx0XHRodWU6IGNvcmUuYnJhbmQuYXNSYWRpYWwoYmFzZUh1ZSksXG5cdFx0XHRcdHNhdHVyYXRpb246IGNvcmUuYnJhbmQuYXNQZXJjZW50aWxlKE1hdGgucmFuZG9tKCkgKiAxMDApLFxuXHRcdFx0XHRsaWdodG5lc3M6IGNvcmUuYnJhbmQuYXNQZXJjZW50aWxlKE1hdGgucmFuZG9tKCkgKiAxMDApLFxuXHRcdFx0XHRhbHBoYTogYWxwaGFWYWx1ZVxuXHRcdFx0XHRcdD8gY29yZS5icmFuZC5hc0FscGhhUmFuZ2UoYWxwaGFWYWx1ZSlcblx0XHRcdFx0XHQ6IGNvcmUuYnJhbmQuYXNBbHBoYVJhbmdlKDEpXG5cdFx0XHR9LFxuXHRcdFx0Zm9ybWF0OiAnaHNsJ1xuXHRcdH07XG5cdH0gd2hpbGUgKFxuXHRcdChsaW1pdEdyYXkgJiYgaXNUb29HcmF5KGhzbCkpIHx8XG5cdFx0KGxpbWl0RGFyayAmJiBpc1Rvb0RhcmsoaHNsKSkgfHxcblx0XHQobGltaXRMaWdodCAmJiBpc1Rvb0xpZ2h0KGhzbCkpXG5cdCk7XG5cblx0cmV0dXJuIGhzbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VsZWN0ZWRQYWxldHRlKG9wdGlvbnM6IFBhbGV0dGVPcHRpb25zKTogUHJvbWlzZTxQYWxldHRlPiB7XG5cdHRyeSB7XG5cdFx0Y29uc3Qge1xuXHRcdFx0cGFsZXR0ZVR5cGUsXG5cdFx0XHRudW1Cb3hlcyxcblx0XHRcdGN1c3RvbUNvbG9yLFxuXHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRsaW1pdERhcmtuZXNzLFxuXHRcdFx0bGltaXRHcmF5bmVzcyxcblx0XHRcdGxpbWl0TGlnaHRuZXNzXG5cdFx0fSA9IG9wdGlvbnM7XG5cblx0XHRjb25zdCBhcmdzOiBHZW5QYWxldHRlQXJncyA9IHtcblx0XHRcdG51bUJveGVzLFxuXHRcdFx0Y3VzdG9tQ29sb3IsXG5cdFx0XHRlbmFibGVBbHBoYSxcblx0XHRcdGxpbWl0RGFyazogbGltaXREYXJrbmVzcyxcblx0XHRcdGxpbWl0R3JheTogbGltaXRHcmF5bmVzcyxcblx0XHRcdGxpbWl0TGlnaHQ6IGxpbWl0TGlnaHRuZXNzXG5cdFx0fTtcblxuXHRcdHN3aXRjaCAocGFsZXR0ZVR5cGUpIHtcblx0XHRcdGNhc2UgMTpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLnJhbmRvbShhcmdzKTtcblx0XHRcdGNhc2UgMjpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGVUeXBlLmNvbXBsZW1lbnRhcnkoYXJncyk7XG5cdFx0XHRjYXNlIDM6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS50cmlhZGljKGFyZ3MpO1xuXHRcdFx0Y2FzZSA0OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUudGV0cmFkaWMoYXJncyk7XG5cdFx0XHRjYXNlIDU6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5zcGxpdENvbXBsZW1lbnRhcnkoYXJncyk7XG5cdFx0XHRjYXNlIDY6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5hbmFsb2dvdXMoYXJncyk7XG5cdFx0XHRjYXNlIDc6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlVHlwZS5oZXhhZGljKGFyZ3MpO1xuXHRcdFx0Y2FzZSA4OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUuZGlhZGljKGFyZ3MpO1xuXHRcdFx0Y2FzZSA5OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZVR5cGUubW9ub2Nocm9tYXRpYyhhcmdzKTtcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdGlmIChtb2RlLmVycm9yTG9ncykgY29uc29sZS5lcnJvcignSW52YWxpZCBwYWxldHRlIHR5cGUuJyk7XG5cblx0XHRcdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShkZWZhdWx0QnJhbmRlZFBhbGV0ZSk7XG5cdFx0fVxuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGlmIChtb2RlLmVycm9yTG9ncykgY29uc29sZS5lcnJvcihgRXJyb3IgZ2VuZXJhdGluZyBwYWxldHRlOiAke2Vycm9yfWApO1xuXG5cdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShkZWZhdWx0QnJhbmRlZFBhbGV0ZSk7XG5cdH1cbn1cblxuZXhwb3J0IGNvbnN0IGdlbmVyYXRlOiBQYWxldHRlR2VuZXJhdGVGbkludGVyZmFjZSA9IHtcblx0bGltaXRlZEhTTCxcblx0c2VsZWN0ZWRQYWxldHRlXG59IGFzIGNvbnN0O1xuIl19