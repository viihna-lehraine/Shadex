// File: src/common/helpers/dom.js
import { core } from '../core/index.js';
import { data } from '../../data/index.js';
import { logger } from '../../logger/index.js';
const logMode = data.mode.logging;
const mode = data.mode;
const timeouts = data.consts.timeouts;
let dragSrcEl = null;
function attachDragAndDropListeners(element) {
    try {
        if (element) {
            element.addEventListener('dragstart', dragStart);
            element.addEventListener('dragover', dragOver);
            element.addEventListener('drop', drop);
            element.addEventListener('dragend', dragEnd);
        }
        if (!mode.quiet)
            logger.info('Drag and drop event listeners successfully attached');
    }
    catch (error) {
        if (!logMode.errors)
            logger.error(`Failed to execute attachDragAndDropEventListeners: ${error}`);
    }
}
function dragStart(e) {
    try {
        dragSrcEl = e.currentTarget;
        if (e.dataTransfer) {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', dragSrcEl.outerHTML);
        }
        if (!mode.quiet && mode.debug && logMode.verbosity > 3)
            logger.info('handleDragStart complete');
    }
    catch (error) {
        if (logMode.errors)
            logger.error(`Error in handleDragStart: ${error}`);
    }
}
function dragOver(e) {
    try {
        e.preventDefault();
        if (e.dataTransfer) {
            e.dataTransfer.dropEffect = 'move';
        }
        if (!mode.quiet && mode.debug && logMode.verbosity > 3)
            logger.info('handleDragOver complete');
        return false;
    }
    catch (error) {
        if (logMode.errors)
            logger.error(`Error in handleDragOver: ${error}`);
        return false;
    }
}
function dragEnd(e) {
    try {
        const target = e.currentTarget;
        target.classList.remove('dragging');
        document.querySelectorAll('.color-stripe').forEach(el => {
            el.classList.remove('dragging');
        });
        if (!mode.quiet && mode.debug && logMode.verbosity > 3)
            logger.info('handleDragEnd complete');
    }
    catch (error) {
        if (logMode.errors)
            console.error(`Error in handleDragEnd: ${error}`);
    }
}
function drop(e) {
    try {
        e.stopPropagation();
        const target = e.currentTarget;
        if (dragSrcEl && dragSrcEl !== target) {
            const dragSrcId = dragSrcEl.id;
            const dropTargetId = target.id;
            const dragSrcText = dragSrcEl.querySelector('.color-text-output-box').value;
            const dropTargetText = target.querySelector('.color-text-output-box').value;
            const dragSrcOuterHTML = dragSrcEl.outerHTML;
            const dropTargetOuterHTML = target.outerHTML;
            dragSrcEl.outerHTML = dropTargetOuterHTML;
            target.outerHTML = dragSrcOuterHTML;
            const newDragSrcEl = document.getElementById(dropTargetId);
            const newDropTargetEl = document.getElementById(dragSrcId);
            newDragSrcEl.id = dragSrcId;
            newDropTargetEl.id = dropTargetId;
            newDragSrcEl.querySelector('.color-text-output-box').value = dropTargetText;
            newDropTargetEl.querySelector('.color-text-output-box').value = dragSrcText;
            if (!mode.quiet && mode.debug && logMode.verbosity > 3)
                logger.info('calling attachDragAndDropEventListeners for new elements');
            attachDragAndDropListeners(newDragSrcEl);
            attachDragAndDropListeners(newDropTargetEl);
        }
        if (!mode.quiet && mode.debug && logMode.verbosity > 3)
            logger.info('handleDrop complete');
    }
    catch (error) {
        if (!logMode.errors)
            logger.error(`Error in handleDrop: ${error}`);
    }
}
function makePaletteBox(color, paletteBoxCount) {
    try {
        if (!core.validate.colorValues(color)) {
            if (!logMode.errors)
                console.error(`Invalid ${color.format} color value ${JSON.stringify(color)}`);
            return {
                colorStripe: document.createElement('div'),
                paletteBoxCount
            };
        }
        const clonedColor = core.base.clone(color);
        const paletteBox = document.createElement('div');
        paletteBox.className = 'palette-box';
        paletteBox.id = `palette-box-${paletteBoxCount}`;
        const paletteBoxTopHalf = document.createElement('div');
        paletteBoxTopHalf.className = 'palette-box-half palette-box-top-half';
        paletteBoxTopHalf.id = `palette-box-top-half-${paletteBoxCount}`;
        const colorTextOutputBox = document.createElement('input');
        colorTextOutputBox.type = 'text';
        colorTextOutputBox.className = 'color-text-output-box tooltip';
        colorTextOutputBox.id = `color-text-output-box-${paletteBoxCount}`;
        colorTextOutputBox.setAttribute('data-format', 'hex');
        const colorString = core.convert.colorToCSSColorString(clonedColor);
        colorTextOutputBox.value = colorString || '';
        colorTextOutputBox.colorValues = clonedColor;
        colorTextOutputBox.readOnly = false;
        colorTextOutputBox.style.cursor = 'text';
        colorTextOutputBox.style.pointerEvents = 'none';
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.textContent = 'Copy';
        const tooltipText = document.createElement('span');
        tooltipText.className = 'tooltiptext';
        tooltipText.textContent = 'Copied to clipboard!';
        copyButton.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(colorTextOutputBox.value);
                showTooltip(colorTextOutputBox);
                clearTimeout(data.consts.timeouts.tooltip || 1000);
                copyButton.textContent = 'Copied!';
                setTimeout(() => (copyButton.textContent = 'Copy'), data.consts.timeouts.copyButtonText || 1000);
            }
            catch (error) {
                if (!logMode.errors)
                    logger.error(`Failed to copy: ${error}`);
            }
        });
        colorTextOutputBox.addEventListener('input', core.base.debounce((e) => {
            const target = e.target;
            if (target) {
                const cssColor = target.value.trim();
                const boxElement = document.getElementById(`color-box-${paletteBoxCount}`);
                const stripeElement = document.getElementById(`color-stripe-${paletteBoxCount}`);
                if (boxElement)
                    boxElement.style.backgroundColor = cssColor;
                if (stripeElement)
                    stripeElement.style.backgroundColor = cssColor;
            }
        }, data.consts.debounce.input || 200));
        paletteBoxTopHalf.appendChild(colorTextOutputBox);
        paletteBoxTopHalf.appendChild(copyButton);
        const paletteBoxBottomHalf = document.createElement('div');
        paletteBoxBottomHalf.className =
            'palette-box-half palette-box-bottom-half';
        paletteBoxBottomHalf.id = `palette-box-bottom-half-${paletteBoxCount}`;
        const colorBox = document.createElement('div');
        colorBox.className = 'color-box';
        colorBox.id = `color-box-${paletteBoxCount}`;
        colorBox.style.backgroundColor = colorString || '#ffffff';
        paletteBoxBottomHalf.appendChild(colorBox);
        paletteBox.appendChild(paletteBoxTopHalf);
        paletteBox.appendChild(paletteBoxBottomHalf);
        const colorStripe = document.createElement('div');
        colorStripe.className = 'color-stripe';
        colorStripe.id = `color-stripe-${paletteBoxCount}`;
        colorStripe.style.backgroundColor = colorString || '#ffffff';
        colorStripe.setAttribute('draggable', 'true');
        attachDragAndDropListeners(colorStripe);
        colorStripe.appendChild(paletteBox);
        return {
            colorStripe,
            paletteBoxCount: paletteBoxCount + 1
        };
    }
    catch (error) {
        if (!logMode.errors)
            logger.error(`Failed to execute makePaletteBox: ${error}`);
        return {
            colorStripe: document.createElement('div'),
            paletteBoxCount
        };
    }
}
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    document.body.appendChild(toast);
    if (!mode.quiet && logMode.verbosity > 3)
        logger.info('Toast message added');
    setTimeout(() => {
        toast.classList.add('fade-out');
        if (!mode.quiet && logMode.verbosity > 3)
            logger.info('Toast message faded out');
        toast.addEventListener('transitioned', () => toast.remove());
    }, timeouts.toast || 3000);
}
function showTooltip(tooltipElement) {
    try {
        const tooltip = tooltipElement.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
            setTimeout(() => {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            }, data.consts.timeouts.tooltip || 1000);
        }
        if (!mode.quiet && logMode.verbosity > 3)
            logger.info('showTooltip executed');
    }
    catch (error) {
        if (logMode.errors)
            logger.error(`Failed to execute showTooltip: ${error}`);
    }
}
function validateAndConvertColor(color) {
    if (!color)
        return null;
    const convertedColor = core.guards.isColorString(color)
        ? core.convert.colorStringToColor(color)
        : color;
    if (!core.validate.colorValues(convertedColor)) {
        if (logMode.errors)
            logger.error(`Invalid color: ${JSON.stringify(convertedColor)}`);
        return null;
    }
    return convertedColor;
}
const handle = {
    dragStart,
    dragOver,
    dragEnd,
    drop
};
export const dom = {
    attachDragAndDropListeners,
    handle,
    makePaletteBox,
    showToast,
    showTooltip,
    validateAndConvertColor
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbW1vbi9oZWxwZXJzL2RvbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxrQ0FBa0M7QUFVbEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFL0MsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7QUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztBQUN2QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUV0QyxJQUFJLFNBQVMsR0FBdUIsSUFBSSxDQUFDO0FBRXpDLFNBQVMsMEJBQTBCLENBQUMsT0FBMkI7SUFDOUQsSUFBSSxDQUFDO1FBQ0osSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDakQsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUMvQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3ZDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSztZQUNkLE1BQU0sQ0FBQyxJQUFJLENBQUMscURBQXFELENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU07WUFDbEIsTUFBTSxDQUFDLEtBQUssQ0FDWCxzREFBc0Qs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LENBQUMsS0FBSyxDQUFDO0lBRVQsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUM7UUFDaEQsSUFBSSxPQUFPLENBQUMsTUFBTTtZQUNqQixNQUFNLENBQUMsS0FBSyxDQUFDLGtCQUFrQixJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVsRSxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxPQUFPLGNBQWMsQ0FBQztBQUN2QixDQUFDO0FBRUQsTUFBTSxNQUFNLEdBQTRCO0lBQ3ZDLFNBQVM7SUFDVCxRQUFRO0lBQ1IsT0FBTztJQUNQLElBQUk7Q0FDSixDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0sR0FBRyxHQUFxQjtJQUNwQywwQkFBMEI7SUFDMUIsTUFBTTtJQUNOLGNBQWM7SUFDZCxTQUFTO0lBQ1QsV0FBVztJQUNYLHVCQUF1QjtDQUNkLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBGaWxlOiBzcmMvY29tbW9uL2hlbHBlcnMvZG9tLmpzXG5cbmltcG9ydCB7XG5cdENvbG9yLFxuXHRDb2xvcklucHV0RWxlbWVudCxcblx0Q29sb3JTdHJpbmcsXG5cdENvbW1vbkhlbHBlcnNET00sXG5cdENvbW1vbkhlbHBlcnNET01fSGFuZGxlLFxuXHRNYWtlUGFsZXR0ZUJveFxufSBmcm9tICcuLi8uLi9pbmRleC9pbmRleC5qcyc7XG5pbXBvcnQgeyBjb3JlIH0gZnJvbSAnLi4vY29yZS9pbmRleC5qcyc7XG5pbXBvcnQgeyBkYXRhIH0gZnJvbSAnLi4vLi4vZGF0YS9pbmRleC5qcyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi8uLi9sb2dnZXIvaW5kZXguanMnO1xuXG5jb25zdCBsb2dNb2RlID0gZGF0YS5tb2RlLmxvZ2dpbmc7XG5jb25zdCBtb2RlID0gZGF0YS5tb2RlO1xuY29uc3QgdGltZW91dHMgPSBkYXRhLmNvbnN0cy50aW1lb3V0cztcblxubGV0IGRyYWdTcmNFbDogSFRNTEVsZW1lbnQgfCBudWxsID0gbnVsbDtcblxuZnVuY3Rpb24gYXR0YWNoRHJhZ0FuZERyb3BMaXN0ZW5lcnMoZWxlbWVudDogSFRNTEVsZW1lbnQgfCBudWxsKTogdm9pZCB7XG5cdHRyeSB7XG5cdFx0aWYgKGVsZW1lbnQpIHtcblx0XHRcdGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ3N0YXJ0JywgZHJhZ1N0YXJ0KTtcblx0XHRcdGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ292ZXInLCBkcmFnT3Zlcik7XG5cdFx0XHRlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Ryb3AnLCBkcm9wKTtcblx0XHRcdGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2VuZCcsIGRyYWdFbmQpO1xuXHRcdH1cblxuXHRcdGlmICghbW9kZS5xdWlldClcblx0XHRcdGxvZ2dlci5pbmZvKCdEcmFnIGFuZCBkcm9wIGV2ZW50IGxpc3RlbmVycyBzdWNjZXNzZnVsbHkgYXR0YWNoZWQnKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRpZiAoIWxvZ01vZGUuZXJyb3JzKVxuXHRcdFx0bG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRgRmFpbGVkIHRvIGV4ZWN1dGUgYXR0YWNoRHJhZ0FuZERyb3BFdmVudExpc3RlbmVyczogJHtlcnJvcn1gXG5cdFx0XHQpO1xuXHR9XG59XG5cbmZ1bmN0aW9uIGRyYWdTdGFydChlOiBEcmFnRXZlbnQpOiB2b2lkIHtcblx0dHJ5IHtcblx0XHRkcmFnU3JjRWwgPSBlLmN1cnJlbnRUYXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG5cblx0XHRpZiAoZS5kYXRhVHJhbnNmZXIpIHtcblx0XHRcdGUuZGF0YVRyYW5zZmVyLmVmZmVjdEFsbG93ZWQgPSAnbW92ZSc7XG5cdFx0XHRlLmRhdGFUcmFuc2Zlci5zZXREYXRhKCd0ZXh0L2h0bWwnLCBkcmFnU3JjRWwub3V0ZXJIVE1MKTtcblx0XHR9XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbW9kZS5kZWJ1ZyAmJiBsb2dNb2RlLnZlcmJvc2l0eSA+IDMpXG5cdFx0XHRsb2dnZXIuaW5mbygnaGFuZGxlRHJhZ1N0YXJ0IGNvbXBsZXRlJyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3JzKSBsb2dnZXIuZXJyb3IoYEVycm9yIGluIGhhbmRsZURyYWdTdGFydDogJHtlcnJvcn1gKTtcblx0fVxufVxuXG5mdW5jdGlvbiBkcmFnT3ZlcihlOiBEcmFnRXZlbnQpOiBib29sZWFuIHtcblx0dHJ5IHtcblx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRpZiAoZS5kYXRhVHJhbnNmZXIpIHtcblx0XHRcdGUuZGF0YVRyYW5zZmVyLmRyb3BFZmZlY3QgPSAnbW92ZSc7XG5cdFx0fVxuXG5cdFx0aWYgKCFtb2RlLnF1aWV0ICYmIG1vZGUuZGVidWcgJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAzKVxuXHRcdFx0bG9nZ2VyLmluZm8oJ2hhbmRsZURyYWdPdmVyIGNvbXBsZXRlJyk7XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3JzKSBsb2dnZXIuZXJyb3IoYEVycm9yIGluIGhhbmRsZURyYWdPdmVyOiAke2Vycm9yfWApO1xuXG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG59XG5cbmZ1bmN0aW9uIGRyYWdFbmQoZTogRHJhZ0V2ZW50KTogdm9pZCB7XG5cdHRyeSB7XG5cdFx0Y29uc3QgdGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0IGFzIEhUTUxFbGVtZW50O1xuXG5cdFx0dGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoJ2RyYWdnaW5nJyk7XG5cblx0XHRkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuY29sb3Itc3RyaXBlJykuZm9yRWFjaChlbCA9PiB7XG5cdFx0XHRlbC5jbGFzc0xpc3QucmVtb3ZlKCdkcmFnZ2luZycpO1xuXHRcdH0pO1xuXG5cdFx0aWYgKCFtb2RlLnF1aWV0ICYmIG1vZGUuZGVidWcgJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAzKVxuXHRcdFx0bG9nZ2VyLmluZm8oJ2hhbmRsZURyYWdFbmQgY29tcGxldGUnKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRpZiAobG9nTW9kZS5lcnJvcnMpIGNvbnNvbGUuZXJyb3IoYEVycm9yIGluIGhhbmRsZURyYWdFbmQ6ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gZHJvcChlOiBEcmFnRXZlbnQpOiB2b2lkIHtcblx0dHJ5IHtcblx0XHRlLnN0b3BQcm9wYWdhdGlvbigpO1xuXG5cdFx0Y29uc3QgdGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0IGFzIEhUTUxFbGVtZW50O1xuXG5cdFx0aWYgKGRyYWdTcmNFbCAmJiBkcmFnU3JjRWwgIT09IHRhcmdldCkge1xuXHRcdFx0Y29uc3QgZHJhZ1NyY0lkID0gZHJhZ1NyY0VsLmlkO1xuXHRcdFx0Y29uc3QgZHJvcFRhcmdldElkID0gdGFyZ2V0LmlkO1xuXHRcdFx0Y29uc3QgZHJhZ1NyY1RleHQgPSAoXG5cdFx0XHRcdGRyYWdTcmNFbC5xdWVyeVNlbGVjdG9yKFxuXHRcdFx0XHRcdCcuY29sb3ItdGV4dC1vdXRwdXQtYm94J1xuXHRcdFx0XHQpIGFzIEhUTUxJbnB1dEVsZW1lbnRcblx0XHRcdCkudmFsdWU7XG5cdFx0XHRjb25zdCBkcm9wVGFyZ2V0VGV4dCA9IChcblx0XHRcdFx0dGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoXG5cdFx0XHRcdFx0Jy5jb2xvci10ZXh0LW91dHB1dC1ib3gnXG5cdFx0XHRcdCkgYXMgSFRNTElucHV0RWxlbWVudFxuXHRcdFx0KS52YWx1ZTtcblx0XHRcdGNvbnN0IGRyYWdTcmNPdXRlckhUTUwgPSBkcmFnU3JjRWwub3V0ZXJIVE1MO1xuXHRcdFx0Y29uc3QgZHJvcFRhcmdldE91dGVySFRNTCA9IHRhcmdldC5vdXRlckhUTUw7XG5cblx0XHRcdGRyYWdTcmNFbC5vdXRlckhUTUwgPSBkcm9wVGFyZ2V0T3V0ZXJIVE1MO1xuXHRcdFx0dGFyZ2V0Lm91dGVySFRNTCA9IGRyYWdTcmNPdXRlckhUTUw7XG5cblx0XHRcdGNvbnN0IG5ld0RyYWdTcmNFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdFx0XHRkcm9wVGFyZ2V0SWRcblx0XHRcdCkgYXMgSFRNTEVsZW1lbnQ7XG5cdFx0XHRjb25zdCBuZXdEcm9wVGFyZ2V0RWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcblx0XHRcdFx0ZHJhZ1NyY0lkXG5cdFx0XHQpIGFzIEhUTUxFbGVtZW50O1xuXG5cdFx0XHRuZXdEcmFnU3JjRWwuaWQgPSBkcmFnU3JjSWQ7XG5cdFx0XHRuZXdEcm9wVGFyZ2V0RWwuaWQgPSBkcm9wVGFyZ2V0SWQ7XG5cblx0XHRcdChcblx0XHRcdFx0bmV3RHJhZ1NyY0VsLnF1ZXJ5U2VsZWN0b3IoXG5cdFx0XHRcdFx0Jy5jb2xvci10ZXh0LW91dHB1dC1ib3gnXG5cdFx0XHRcdCkgYXMgSFRNTElucHV0RWxlbWVudFxuXHRcdFx0KS52YWx1ZSA9IGRyb3BUYXJnZXRUZXh0O1xuXHRcdFx0KFxuXHRcdFx0XHRuZXdEcm9wVGFyZ2V0RWwucXVlcnlTZWxlY3Rvcihcblx0XHRcdFx0XHQnLmNvbG9yLXRleHQtb3V0cHV0LWJveCdcblx0XHRcdFx0KSBhcyBIVE1MSW5wdXRFbGVtZW50XG5cdFx0XHQpLnZhbHVlID0gZHJhZ1NyY1RleHQ7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCAmJiBtb2RlLmRlYnVnICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMylcblx0XHRcdFx0bG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0J2NhbGxpbmcgYXR0YWNoRHJhZ0FuZERyb3BFdmVudExpc3RlbmVycyBmb3IgbmV3IGVsZW1lbnRzJ1xuXHRcdFx0XHQpO1xuXG5cdFx0XHRhdHRhY2hEcmFnQW5kRHJvcExpc3RlbmVycyhuZXdEcmFnU3JjRWwpO1xuXG5cdFx0XHRhdHRhY2hEcmFnQW5kRHJvcExpc3RlbmVycyhuZXdEcm9wVGFyZ2V0RWwpO1xuXHRcdH1cblxuXHRcdGlmICghbW9kZS5xdWlldCAmJiBtb2RlLmRlYnVnICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMylcblx0XHRcdGxvZ2dlci5pbmZvKCdoYW5kbGVEcm9wIGNvbXBsZXRlJyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKCFsb2dNb2RlLmVycm9ycykgbG9nZ2VyLmVycm9yKGBFcnJvciBpbiBoYW5kbGVEcm9wOiAke2Vycm9yfWApO1xuXHR9XG59XG5cbmZ1bmN0aW9uIG1ha2VQYWxldHRlQm94KGNvbG9yOiBDb2xvciwgcGFsZXR0ZUJveENvdW50OiBudW1iZXIpOiBNYWtlUGFsZXR0ZUJveCB7XG5cdHRyeSB7XG5cdFx0aWYgKCFjb3JlLnZhbGlkYXRlLmNvbG9yVmFsdWVzKGNvbG9yKSkge1xuXHRcdFx0aWYgKCFsb2dNb2RlLmVycm9ycylcblx0XHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0XHRgSW52YWxpZCAke2NvbG9yLmZvcm1hdH0gY29sb3IgdmFsdWUgJHtKU09OLnN0cmluZ2lmeShjb2xvcil9YFxuXHRcdFx0XHQpO1xuXG5cdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRjb2xvclN0cmlwZTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksXG5cdFx0XHRcdHBhbGV0dGVCb3hDb3VudFxuXHRcdFx0fTtcblx0XHR9XG5cblx0XHRjb25zdCBjbG9uZWRDb2xvciA9IGNvcmUuYmFzZS5jbG9uZShjb2xvcik7XG5cblx0XHRjb25zdCBwYWxldHRlQm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cdFx0cGFsZXR0ZUJveC5jbGFzc05hbWUgPSAncGFsZXR0ZS1ib3gnO1xuXHRcdHBhbGV0dGVCb3guaWQgPSBgcGFsZXR0ZS1ib3gtJHtwYWxldHRlQm94Q291bnR9YDtcblxuXHRcdGNvbnN0IHBhbGV0dGVCb3hUb3BIYWxmID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cdFx0cGFsZXR0ZUJveFRvcEhhbGYuY2xhc3NOYW1lID0gJ3BhbGV0dGUtYm94LWhhbGYgcGFsZXR0ZS1ib3gtdG9wLWhhbGYnO1xuXHRcdHBhbGV0dGVCb3hUb3BIYWxmLmlkID0gYHBhbGV0dGUtYm94LXRvcC1oYWxmLSR7cGFsZXR0ZUJveENvdW50fWA7XG5cblx0XHRjb25zdCBjb2xvclRleHRPdXRwdXRCb3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFxuXHRcdFx0J2lucHV0J1xuXHRcdCkgYXMgQ29sb3JJbnB1dEVsZW1lbnQ7XG5cdFx0Y29sb3JUZXh0T3V0cHV0Qm94LnR5cGUgPSAndGV4dCc7XG5cdFx0Y29sb3JUZXh0T3V0cHV0Qm94LmNsYXNzTmFtZSA9ICdjb2xvci10ZXh0LW91dHB1dC1ib3ggdG9vbHRpcCc7XG5cdFx0Y29sb3JUZXh0T3V0cHV0Qm94LmlkID0gYGNvbG9yLXRleHQtb3V0cHV0LWJveC0ke3BhbGV0dGVCb3hDb3VudH1gO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5zZXRBdHRyaWJ1dGUoJ2RhdGEtZm9ybWF0JywgJ2hleCcpO1xuXG5cdFx0Y29uc3QgY29sb3JTdHJpbmcgPSBjb3JlLmNvbnZlcnQuY29sb3JUb0NTU0NvbG9yU3RyaW5nKGNsb25lZENvbG9yKTtcblxuXHRcdGNvbG9yVGV4dE91dHB1dEJveC52YWx1ZSA9IGNvbG9yU3RyaW5nIHx8ICcnO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5jb2xvclZhbHVlcyA9IGNsb25lZENvbG9yO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5yZWFkT25seSA9IGZhbHNlO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5zdHlsZS5jdXJzb3IgPSAndGV4dCc7XG5cdFx0Y29sb3JUZXh0T3V0cHV0Qm94LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnbm9uZSc7XG5cblx0XHRjb25zdCBjb3B5QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XG5cdFx0Y29weUJ1dHRvbi5jbGFzc05hbWUgPSAnY29weS1idXR0b24nO1xuXHRcdGNvcHlCdXR0b24udGV4dENvbnRlbnQgPSAnQ29weSc7XG5cblx0XHRjb25zdCB0b29sdGlwVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcblx0XHR0b29sdGlwVGV4dC5jbGFzc05hbWUgPSAndG9vbHRpcHRleHQnO1xuXHRcdHRvb2x0aXBUZXh0LnRleHRDb250ZW50ID0gJ0NvcGllZCB0byBjbGlwYm9hcmQhJztcblxuXHRcdGNvcHlCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dChjb2xvclRleHRPdXRwdXRCb3gudmFsdWUpO1xuXG5cdFx0XHRcdHNob3dUb29sdGlwKGNvbG9yVGV4dE91dHB1dEJveCk7XG5cblx0XHRcdFx0Y2xlYXJUaW1lb3V0KGRhdGEuY29uc3RzLnRpbWVvdXRzLnRvb2x0aXAgfHwgMTAwMCk7XG5cblx0XHRcdFx0Y29weUJ1dHRvbi50ZXh0Q29udGVudCA9ICdDb3BpZWQhJztcblx0XHRcdFx0c2V0VGltZW91dChcblx0XHRcdFx0XHQoKSA9PiAoY29weUJ1dHRvbi50ZXh0Q29udGVudCA9ICdDb3B5JyksXG5cdFx0XHRcdFx0ZGF0YS5jb25zdHMudGltZW91dHMuY29weUJ1dHRvblRleHQgfHwgMTAwMFxuXHRcdFx0XHQpO1xuXHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0aWYgKCFsb2dNb2RlLmVycm9ycykgbG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gY29weTogJHtlcnJvcn1gKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5hZGRFdmVudExpc3RlbmVyKFxuXHRcdFx0J2lucHV0Jyxcblx0XHRcdGNvcmUuYmFzZS5kZWJvdW5jZSgoZTogRXZlbnQpID0+IHtcblx0XHRcdFx0Y29uc3QgdGFyZ2V0ID0gZS50YXJnZXQgYXMgSFRNTElucHV0RWxlbWVudCB8IG51bGw7XG5cdFx0XHRcdGlmICh0YXJnZXQpIHtcblx0XHRcdFx0XHRjb25zdCBjc3NDb2xvciA9IHRhcmdldC52YWx1ZS50cmltKCk7XG5cdFx0XHRcdFx0Y29uc3QgYm94RWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdFx0XHRcdFx0YGNvbG9yLWJveC0ke3BhbGV0dGVCb3hDb3VudH1gXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRjb25zdCBzdHJpcGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXG5cdFx0XHRcdFx0XHRgY29sb3Itc3RyaXBlLSR7cGFsZXR0ZUJveENvdW50fWBcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdFx0aWYgKGJveEVsZW1lbnQpIGJveEVsZW1lbnQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY3NzQ29sb3I7XG5cdFx0XHRcdFx0aWYgKHN0cmlwZUVsZW1lbnQpXG5cdFx0XHRcdFx0XHRzdHJpcGVFbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNzc0NvbG9yO1xuXHRcdFx0XHR9XG5cdFx0XHR9LCBkYXRhLmNvbnN0cy5kZWJvdW5jZS5pbnB1dCB8fCAyMDApXG5cdFx0KTtcblxuXHRcdHBhbGV0dGVCb3hUb3BIYWxmLmFwcGVuZENoaWxkKGNvbG9yVGV4dE91dHB1dEJveCk7XG5cdFx0cGFsZXR0ZUJveFRvcEhhbGYuYXBwZW5kQ2hpbGQoY29weUJ1dHRvbik7XG5cblx0XHRjb25zdCBwYWxldHRlQm94Qm90dG9tSGFsZiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXHRcdHBhbGV0dGVCb3hCb3R0b21IYWxmLmNsYXNzTmFtZSA9XG5cdFx0XHQncGFsZXR0ZS1ib3gtaGFsZiBwYWxldHRlLWJveC1ib3R0b20taGFsZic7XG5cdFx0cGFsZXR0ZUJveEJvdHRvbUhhbGYuaWQgPSBgcGFsZXR0ZS1ib3gtYm90dG9tLWhhbGYtJHtwYWxldHRlQm94Q291bnR9YDtcblxuXHRcdGNvbnN0IGNvbG9yQm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cdFx0Y29sb3JCb3guY2xhc3NOYW1lID0gJ2NvbG9yLWJveCc7XG5cdFx0Y29sb3JCb3guaWQgPSBgY29sb3ItYm94LSR7cGFsZXR0ZUJveENvdW50fWA7XG5cdFx0Y29sb3JCb3guc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3JTdHJpbmcgfHwgJyNmZmZmZmYnO1xuXG5cdFx0cGFsZXR0ZUJveEJvdHRvbUhhbGYuYXBwZW5kQ2hpbGQoY29sb3JCb3gpO1xuXHRcdHBhbGV0dGVCb3guYXBwZW5kQ2hpbGQocGFsZXR0ZUJveFRvcEhhbGYpO1xuXHRcdHBhbGV0dGVCb3guYXBwZW5kQ2hpbGQocGFsZXR0ZUJveEJvdHRvbUhhbGYpO1xuXG5cdFx0Y29uc3QgY29sb3JTdHJpcGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblx0XHRjb2xvclN0cmlwZS5jbGFzc05hbWUgPSAnY29sb3Itc3RyaXBlJztcblx0XHRjb2xvclN0cmlwZS5pZCA9IGBjb2xvci1zdHJpcGUtJHtwYWxldHRlQm94Q291bnR9YDtcblx0XHRjb2xvclN0cmlwZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvclN0cmluZyB8fCAnI2ZmZmZmZic7XG5cblx0XHRjb2xvclN0cmlwZS5zZXRBdHRyaWJ1dGUoJ2RyYWdnYWJsZScsICd0cnVlJyk7XG5cblx0XHRhdHRhY2hEcmFnQW5kRHJvcExpc3RlbmVycyhjb2xvclN0cmlwZSk7XG5cblx0XHRjb2xvclN0cmlwZS5hcHBlbmRDaGlsZChwYWxldHRlQm94KTtcblxuXHRcdHJldHVybiB7XG5cdFx0XHRjb2xvclN0cmlwZSxcblx0XHRcdHBhbGV0dGVCb3hDb3VudDogcGFsZXR0ZUJveENvdW50ICsgMVxuXHRcdH07XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKCFsb2dNb2RlLmVycm9ycylcblx0XHRcdGxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIGV4ZWN1dGUgbWFrZVBhbGV0dGVCb3g6ICR7ZXJyb3J9YCk7XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0Y29sb3JTdHJpcGU6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLFxuXHRcdFx0cGFsZXR0ZUJveENvdW50XG5cdFx0fTtcblx0fVxufVxuXG5mdW5jdGlvbiBzaG93VG9hc3QobWVzc2FnZTogc3RyaW5nKTogdm9pZCB7XG5cdGNvbnN0IHRvYXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cblx0dG9hc3QuY2xhc3NOYW1lID0gJ3RvYXN0LW1lc3NhZ2UnO1xuXG5cdHRvYXN0LnRleHRDb250ZW50ID0gbWVzc2FnZTtcblxuXHRkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRvYXN0KTtcblxuXHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAzKVxuXHRcdGxvZ2dlci5pbmZvKCdUb2FzdCBtZXNzYWdlIGFkZGVkJyk7XG5cblx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0dG9hc3QuY2xhc3NMaXN0LmFkZCgnZmFkZS1vdXQnKTtcblxuXHRcdGlmICghbW9kZS5xdWlldCAmJiBsb2dNb2RlLnZlcmJvc2l0eSA+IDMpXG5cdFx0XHRsb2dnZXIuaW5mbygnVG9hc3QgbWVzc2FnZSBmYWRlZCBvdXQnKTtcblxuXHRcdHRvYXN0LmFkZEV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lZCcsICgpID0+IHRvYXN0LnJlbW92ZSgpKTtcblx0fSwgdGltZW91dHMudG9hc3QgfHwgMzAwMCk7XG59XG5cbmZ1bmN0aW9uIHNob3dUb29sdGlwKHRvb2x0aXBFbGVtZW50OiBIVE1MRWxlbWVudCk6IHZvaWQge1xuXHR0cnkge1xuXHRcdGNvbnN0IHRvb2x0aXAgPVxuXHRcdFx0dG9vbHRpcEVsZW1lbnQucXVlcnlTZWxlY3RvcjxIVE1MRWxlbWVudD4oJy50b29sdGlwdGV4dCcpO1xuXG5cdFx0aWYgKHRvb2x0aXApIHtcblx0XHRcdHRvb2x0aXAuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJztcblx0XHRcdHRvb2x0aXAuc3R5bGUub3BhY2l0eSA9ICcxJztcblx0XHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHR0b29sdGlwLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJztcblx0XHRcdFx0dG9vbHRpcC5zdHlsZS5vcGFjaXR5ID0gJzAnO1xuXHRcdFx0fSwgZGF0YS5jb25zdHMudGltZW91dHMudG9vbHRpcCB8fCAxMDAwKTtcblx0XHR9XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAzKVxuXHRcdFx0bG9nZ2VyLmluZm8oJ3Nob3dUb29sdGlwIGV4ZWN1dGVkJyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3JzKVxuXHRcdFx0bG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gZXhlY3V0ZSBzaG93VG9vbHRpcDogJHtlcnJvcn1gKTtcblx0fVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUFuZENvbnZlcnRDb2xvcihcblx0Y29sb3I6IENvbG9yIHwgQ29sb3JTdHJpbmcgfCBudWxsXG4pOiBDb2xvciB8IG51bGwge1xuXHRpZiAoIWNvbG9yKSByZXR1cm4gbnVsbDtcblxuXHRjb25zdCBjb252ZXJ0ZWRDb2xvciA9IGNvcmUuZ3VhcmRzLmlzQ29sb3JTdHJpbmcoY29sb3IpXG5cdFx0PyBjb3JlLmNvbnZlcnQuY29sb3JTdHJpbmdUb0NvbG9yKGNvbG9yKVxuXHRcdDogY29sb3I7XG5cblx0aWYgKCFjb3JlLnZhbGlkYXRlLmNvbG9yVmFsdWVzKGNvbnZlcnRlZENvbG9yKSkge1xuXHRcdGlmIChsb2dNb2RlLmVycm9ycylcblx0XHRcdGxvZ2dlci5lcnJvcihgSW52YWxpZCBjb2xvcjogJHtKU09OLnN0cmluZ2lmeShjb252ZXJ0ZWRDb2xvcil9YCk7XG5cblx0XHRyZXR1cm4gbnVsbDtcblx0fVxuXG5cdHJldHVybiBjb252ZXJ0ZWRDb2xvcjtcbn1cblxuY29uc3QgaGFuZGxlOiBDb21tb25IZWxwZXJzRE9NX0hhbmRsZSA9IHtcblx0ZHJhZ1N0YXJ0LFxuXHRkcmFnT3Zlcixcblx0ZHJhZ0VuZCxcblx0ZHJvcFxufTtcblxuZXhwb3J0IGNvbnN0IGRvbTogQ29tbW9uSGVscGVyc0RPTSA9IHtcblx0YXR0YWNoRHJhZ0FuZERyb3BMaXN0ZW5lcnMsXG5cdGhhbmRsZSxcblx0bWFrZVBhbGV0dGVCb3gsXG5cdHNob3dUb2FzdCxcblx0c2hvd1Rvb2x0aXAsXG5cdHZhbGlkYXRlQW5kQ29udmVydENvbG9yXG59IGFzIGNvbnN0O1xuIl19