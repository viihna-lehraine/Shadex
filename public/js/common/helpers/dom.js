// File: src/common/helpers/dom.js
import { core } from '../core/index.js';
import { data } from '../../data/index.js';
import { log } from '../../classes/logger/index.js';
const logMode = data.mode.logging;
const mode = data.mode;
const timeouts = data.consts.timeouts;
let dragSrcEl = null;
function attachDragAndDropListeners(element) {
    try {
        if (element) {
            element.addEventListener('dragstart', dragStart);
            element.addEventListener('dragover', dragOver);
            element.addEventListener('drop', drop);
            element.addEventListener('dragend', dragEnd);
        }
        if (!mode.quiet)
            log.info('Drag and drop event listeners successfully attached');
    }
    catch (error) {
        if (!logMode.errors)
            log.error(`Failed to execute attachDragAndDropEventListeners: ${error}`);
    }
}
function dragStart(e) {
    try {
        dragSrcEl = e.currentTarget;
        if (e.dataTransfer) {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', dragSrcEl.outerHTML);
        }
        if (!mode.quiet && mode.debug && logMode.verbosity > 3)
            log.info('handleDragStart complete');
    }
    catch (error) {
        if (logMode.errors)
            log.error(`Error in handleDragStart: ${error}`);
    }
}
function dragOver(e) {
    try {
        e.preventDefault();
        if (e.dataTransfer) {
            e.dataTransfer.dropEffect = 'move';
        }
        if (!mode.quiet && mode.debug && logMode.verbosity > 3)
            log.info('handleDragOver complete');
        return false;
    }
    catch (error) {
        if (logMode.errors)
            log.error(`Error in handleDragOver: ${error}`);
        return false;
    }
}
function dragEnd(e) {
    try {
        const target = e.currentTarget;
        target.classList.remove('dragging');
        document.querySelectorAll('.color-stripe').forEach(el => {
            el.classList.remove('dragging');
        });
        if (!mode.quiet && mode.debug && logMode.verbosity > 3)
            log.info('handleDragEnd complete');
    }
    catch (error) {
        if (logMode.errors)
            console.error(`Error in handleDragEnd: ${error}`);
    }
}
function drop(e) {
    try {
        e.stopPropagation();
        const target = e.currentTarget;
        if (dragSrcEl && dragSrcEl !== target) {
            const dragSrcId = dragSrcEl.id;
            const dropTargetId = target.id;
            const dragSrcText = dragSrcEl.querySelector('.color-text-output-box').value;
            const dropTargetText = target.querySelector('.color-text-output-box').value;
            const dragSrcOuterHTML = dragSrcEl.outerHTML;
            const dropTargetOuterHTML = target.outerHTML;
            dragSrcEl.outerHTML = dropTargetOuterHTML;
            target.outerHTML = dragSrcOuterHTML;
            const newDragSrcEl = document.getElementById(dropTargetId);
            const newDropTargetEl = document.getElementById(dragSrcId);
            newDragSrcEl.id = dragSrcId;
            newDropTargetEl.id = dropTargetId;
            newDragSrcEl.querySelector('.color-text-output-box').value = dropTargetText;
            newDropTargetEl.querySelector('.color-text-output-box').value = dragSrcText;
            if (!mode.quiet && mode.debug && logMode.verbosity > 3)
                log.info('calling attachDragAndDropEventListeners for new elements');
            attachDragAndDropListeners(newDragSrcEl);
            attachDragAndDropListeners(newDropTargetEl);
        }
        if (!mode.quiet && mode.debug && logMode.verbosity > 3)
            log.info('handleDrop complete');
    }
    catch (error) {
        if (!logMode.errors)
            log.error(`Error in handleDrop: ${error}`);
    }
}
function makePaletteBox(color, paletteBoxCount) {
    try {
        if (!core.validate.colorValues(color)) {
            if (!logMode.errors)
                console.error(`Invalid ${color.format} color value ${JSON.stringify(color)}`);
            return {
                colorStripe: document.createElement('div'),
                paletteBoxCount
            };
        }
        const clonedColor = core.base.clone(color);
        const paletteBox = document.createElement('div');
        paletteBox.className = 'palette-box';
        paletteBox.id = `palette-box-${paletteBoxCount}`;
        const paletteBoxTopHalf = document.createElement('div');
        paletteBoxTopHalf.className = 'palette-box-half palette-box-top-half';
        paletteBoxTopHalf.id = `palette-box-top-half-${paletteBoxCount}`;
        const colorTextOutputBox = document.createElement('input');
        colorTextOutputBox.type = 'text';
        colorTextOutputBox.className = 'color-text-output-box tooltip';
        colorTextOutputBox.id = `color-text-output-box-${paletteBoxCount}`;
        colorTextOutputBox.setAttribute('data-format', 'hex');
        const colorString = core.convert.toCSSColorString(clonedColor);
        colorTextOutputBox.value = colorString || '';
        colorTextOutputBox.colorValues = clonedColor;
        colorTextOutputBox.readOnly = false;
        colorTextOutputBox.style.cursor = 'text';
        colorTextOutputBox.style.pointerEvents = 'none';
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.textContent = 'Copy';
        const tooltipText = document.createElement('span');
        tooltipText.className = 'tooltiptext';
        tooltipText.textContent = 'Copied to clipboard!';
        copyButton.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(colorTextOutputBox.value);
                showTooltip(colorTextOutputBox);
                clearTimeout(data.consts.timeouts.tooltip || 1000);
                copyButton.textContent = 'Copied!';
                setTimeout(() => (copyButton.textContent = 'Copy'), data.consts.timeouts.copyButtonText || 1000);
            }
            catch (error) {
                if (!logMode.errors)
                    log.error(`Failed to copy: ${error}`);
            }
        });
        colorTextOutputBox.addEventListener('input', core.base.debounce((e) => {
            const target = e.target;
            if (target) {
                const cssColor = target.value.trim();
                const boxElement = document.getElementById(`color-box-${paletteBoxCount}`);
                const stripeElement = document.getElementById(`color-stripe-${paletteBoxCount}`);
                if (boxElement)
                    boxElement.style.backgroundColor = cssColor;
                if (stripeElement)
                    stripeElement.style.backgroundColor = cssColor;
            }
        }, data.consts.debounce.input || 200));
        paletteBoxTopHalf.appendChild(colorTextOutputBox);
        paletteBoxTopHalf.appendChild(copyButton);
        const paletteBoxBottomHalf = document.createElement('div');
        paletteBoxBottomHalf.className =
            'palette-box-half palette-box-bottom-half';
        paletteBoxBottomHalf.id = `palette-box-bottom-half-${paletteBoxCount}`;
        const colorBox = document.createElement('div');
        colorBox.className = 'color-box';
        colorBox.id = `color-box-${paletteBoxCount}`;
        colorBox.style.backgroundColor = colorString || '#ffffff';
        paletteBoxBottomHalf.appendChild(colorBox);
        paletteBox.appendChild(paletteBoxTopHalf);
        paletteBox.appendChild(paletteBoxBottomHalf);
        const colorStripe = document.createElement('div');
        colorStripe.className = 'color-stripe';
        colorStripe.id = `color-stripe-${paletteBoxCount}`;
        colorStripe.style.backgroundColor = colorString || '#ffffff';
        colorStripe.setAttribute('draggable', 'true');
        attachDragAndDropListeners(colorStripe);
        colorStripe.appendChild(paletteBox);
        return {
            colorStripe,
            paletteBoxCount: paletteBoxCount + 1
        };
    }
    catch (error) {
        if (!logMode.errors)
            log.error(`Failed to execute makePaletteBox: ${error}`);
        return {
            colorStripe: document.createElement('div'),
            paletteBoxCount
        };
    }
}
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    document.body.appendChild(toast);
    if (!mode.quiet && logMode.verbosity > 3)
        log.info('Toast message added');
    setTimeout(() => {
        toast.classList.add('fade-out');
        if (!mode.quiet && logMode.verbosity > 3)
            log.info('Toast message faded out');
        toast.addEventListener('transitioned', () => toast.remove());
    }, timeouts.toast || 3000);
}
function showTooltip(tooltipElement) {
    try {
        const tooltip = tooltipElement.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
            setTimeout(() => {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            }, data.consts.timeouts.tooltip || 1000);
        }
        if (!mode.quiet && logMode.verbosity > 3)
            log.info('showTooltip executed');
    }
    catch (error) {
        if (logMode.errors)
            log.error(`Failed to execute showTooltip: ${error}`);
    }
}
function validateAndConvertColor(color) {
    if (!color)
        return null;
    const convertedColor = core.guards.isColorString(color)
        ? core.convert.toColor(color)
        : color;
    if (!core.validate.colorValues(convertedColor)) {
        if (logMode.errors)
            log.error(`Invalid color: ${JSON.stringify(convertedColor)}`);
        return null;
    }
    return convertedColor;
}
const handle = {
    dragStart,
    dragOver,
    dragEnd,
    drop
};
export const dom = {
    attachDragAndDropListeners,
    handle,
    makePaletteBox,
    showToast,
    showTooltip,
    validateAndConvertColor
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbW1vbi9oZWxwZXJzL2RvbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxrQ0FBa0M7QUFVbEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFFcEQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7QUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztBQUN2QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUV0QyxJQUFJLFNBQVMsR0FBdUIsSUFBSSxDQUFDO0FBRXpDLFNBQVMsMEJBQTBCLENBQUMsT0FBMkI7SUFDOUQsSUFBSSxDQUFDO1FBQ0osSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDakQsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUMvQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3ZDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSztZQUNkLEdBQUcsQ0FBQyxJQUFJLENBQUMscURBQXFELENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU07WUFDbEIsR0FBRyxDQUFDLEtBQUssQ0FDUixzREFBc0Qs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QUMsS0FBSyxDQUFDO0lBRVQsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUM7UUFDaEQsSUFBSSxPQUFPLENBQUMsTUFBTTtZQUNqQixHQUFHLENBQUMsS0FBSyxDQUFDLGtCQUFrQixJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUvRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxPQUFPLGNBQWMsQ0FBQztBQUN2QixDQUFDO0FBRUQsTUFBTSxNQUFNLEdBQTRCO0lBQ3ZDLFNBQVM7SUFDVCxRQUFRO0lBQ1IsT0FBTztJQUNQLElBQUk7Q0FDSixDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0sR0FBRyxHQUFxQjtJQUNwQywwQkFBMEI7SUFDMUIsTUFBTTtJQUNOLGNBQWM7SUFDZCxTQUFTO0lBQ1QsV0FBVztJQUNYLHVCQUF1QjtDQUNkLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBGaWxlOiBzcmMvY29tbW9uL2hlbHBlcnMvZG9tLmpzXG5cbmltcG9ydCB7XG5cdENvbG9yLFxuXHRDb2xvcklucHV0RWxlbWVudCxcblx0Q29sb3JTdHJpbmcsXG5cdENvbW1vbkhlbHBlcnNET00sXG5cdENvbW1vbkhlbHBlcnNET01fSGFuZGxlLFxuXHRNYWtlUGFsZXR0ZUJveFxufSBmcm9tICcuLi8uLi9pbmRleC9pbmRleC5qcyc7XG5pbXBvcnQgeyBjb3JlIH0gZnJvbSAnLi4vY29yZS9pbmRleC5qcyc7XG5pbXBvcnQgeyBkYXRhIH0gZnJvbSAnLi4vLi4vZGF0YS9pbmRleC5qcyc7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLi8uLi9jbGFzc2VzL2xvZ2dlci9pbmRleC5qcyc7XG5cbmNvbnN0IGxvZ01vZGUgPSBkYXRhLm1vZGUubG9nZ2luZztcbmNvbnN0IG1vZGUgPSBkYXRhLm1vZGU7XG5jb25zdCB0aW1lb3V0cyA9IGRhdGEuY29uc3RzLnRpbWVvdXRzO1xuXG5sZXQgZHJhZ1NyY0VsOiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsO1xuXG5mdW5jdGlvbiBhdHRhY2hEcmFnQW5kRHJvcExpc3RlbmVycyhlbGVtZW50OiBIVE1MRWxlbWVudCB8IG51bGwpOiB2b2lkIHtcblx0dHJ5IHtcblx0XHRpZiAoZWxlbWVudCkge1xuXHRcdFx0ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdkcmFnc3RhcnQnLCBkcmFnU3RhcnQpO1xuXHRcdFx0ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdkcmFnb3ZlcicsIGRyYWdPdmVyKTtcblx0XHRcdGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIGRyb3ApO1xuXHRcdFx0ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdkcmFnZW5kJywgZHJhZ0VuZCk7XG5cdFx0fVxuXG5cdFx0aWYgKCFtb2RlLnF1aWV0KVxuXHRcdFx0bG9nLmluZm8oJ0RyYWcgYW5kIGRyb3AgZXZlbnQgbGlzdGVuZXJzIHN1Y2Nlc3NmdWxseSBhdHRhY2hlZCcpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGlmICghbG9nTW9kZS5lcnJvcnMpXG5cdFx0XHRsb2cuZXJyb3IoXG5cdFx0XHRcdGBGYWlsZWQgdG8gZXhlY3V0ZSBhdHRhY2hEcmFnQW5kRHJvcEV2ZW50TGlzdGVuZXJzOiAke2Vycm9yfWBcblx0XHRcdCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gZHJhZ1N0YXJ0KGU6IERyYWdFdmVudCk6IHZvaWQge1xuXHR0cnkge1xuXHRcdGRyYWdTcmNFbCA9IGUuY3VycmVudFRhcmdldCBhcyBIVE1MRWxlbWVudDtcblxuXHRcdGlmIChlLmRhdGFUcmFuc2Zlcikge1xuXHRcdFx0ZS5kYXRhVHJhbnNmZXIuZWZmZWN0QWxsb3dlZCA9ICdtb3ZlJztcblx0XHRcdGUuZGF0YVRyYW5zZmVyLnNldERhdGEoJ3RleHQvaHRtbCcsIGRyYWdTcmNFbC5vdXRlckhUTUwpO1xuXHRcdH1cblxuXHRcdGlmICghbW9kZS5xdWlldCAmJiBtb2RlLmRlYnVnICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMylcblx0XHRcdGxvZy5pbmZvKCdoYW5kbGVEcmFnU3RhcnQgY29tcGxldGUnKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRpZiAobG9nTW9kZS5lcnJvcnMpIGxvZy5lcnJvcihgRXJyb3IgaW4gaGFuZGxlRHJhZ1N0YXJ0OiAke2Vycm9yfWApO1xuXHR9XG59XG5cbmZ1bmN0aW9uIGRyYWdPdmVyKGU6IERyYWdFdmVudCk6IGJvb2xlYW4ge1xuXHR0cnkge1xuXHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdGlmIChlLmRhdGFUcmFuc2Zlcikge1xuXHRcdFx0ZS5kYXRhVHJhbnNmZXIuZHJvcEVmZmVjdCA9ICdtb3ZlJztcblx0XHR9XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbW9kZS5kZWJ1ZyAmJiBsb2dNb2RlLnZlcmJvc2l0eSA+IDMpXG5cdFx0XHRsb2cuaW5mbygnaGFuZGxlRHJhZ092ZXIgY29tcGxldGUnKTtcblxuXHRcdHJldHVybiBmYWxzZTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRpZiAobG9nTW9kZS5lcnJvcnMpIGxvZy5lcnJvcihgRXJyb3IgaW4gaGFuZGxlRHJhZ092ZXI6ICR7ZXJyb3J9YCk7XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cbn1cblxuZnVuY3Rpb24gZHJhZ0VuZChlOiBEcmFnRXZlbnQpOiB2b2lkIHtcblx0dHJ5IHtcblx0XHRjb25zdCB0YXJnZXQgPSBlLmN1cnJlbnRUYXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG5cblx0XHR0YXJnZXQuY2xhc3NMaXN0LnJlbW92ZSgnZHJhZ2dpbmcnKTtcblxuXHRcdGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5jb2xvci1zdHJpcGUnKS5mb3JFYWNoKGVsID0+IHtcblx0XHRcdGVsLmNsYXNzTGlzdC5yZW1vdmUoJ2RyYWdnaW5nJyk7XG5cdFx0fSk7XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbW9kZS5kZWJ1ZyAmJiBsb2dNb2RlLnZlcmJvc2l0eSA+IDMpXG5cdFx0XHRsb2cuaW5mbygnaGFuZGxlRHJhZ0VuZCBjb21wbGV0ZScpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGlmIChsb2dNb2RlLmVycm9ycykgY29uc29sZS5lcnJvcihgRXJyb3IgaW4gaGFuZGxlRHJhZ0VuZDogJHtlcnJvcn1gKTtcblx0fVxufVxuXG5mdW5jdGlvbiBkcm9wKGU6IERyYWdFdmVudCk6IHZvaWQge1xuXHR0cnkge1xuXHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XG5cblx0XHRjb25zdCB0YXJnZXQgPSBlLmN1cnJlbnRUYXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG5cblx0XHRpZiAoZHJhZ1NyY0VsICYmIGRyYWdTcmNFbCAhPT0gdGFyZ2V0KSB7XG5cdFx0XHRjb25zdCBkcmFnU3JjSWQgPSBkcmFnU3JjRWwuaWQ7XG5cdFx0XHRjb25zdCBkcm9wVGFyZ2V0SWQgPSB0YXJnZXQuaWQ7XG5cdFx0XHRjb25zdCBkcmFnU3JjVGV4dCA9IChcblx0XHRcdFx0ZHJhZ1NyY0VsLnF1ZXJ5U2VsZWN0b3IoXG5cdFx0XHRcdFx0Jy5jb2xvci10ZXh0LW91dHB1dC1ib3gnXG5cdFx0XHRcdCkgYXMgSFRNTElucHV0RWxlbWVudFxuXHRcdFx0KS52YWx1ZTtcblx0XHRcdGNvbnN0IGRyb3BUYXJnZXRUZXh0ID0gKFxuXHRcdFx0XHR0YXJnZXQucXVlcnlTZWxlY3Rvcihcblx0XHRcdFx0XHQnLmNvbG9yLXRleHQtb3V0cHV0LWJveCdcblx0XHRcdFx0KSBhcyBIVE1MSW5wdXRFbGVtZW50XG5cdFx0XHQpLnZhbHVlO1xuXHRcdFx0Y29uc3QgZHJhZ1NyY091dGVySFRNTCA9IGRyYWdTcmNFbC5vdXRlckhUTUw7XG5cdFx0XHRjb25zdCBkcm9wVGFyZ2V0T3V0ZXJIVE1MID0gdGFyZ2V0Lm91dGVySFRNTDtcblxuXHRcdFx0ZHJhZ1NyY0VsLm91dGVySFRNTCA9IGRyb3BUYXJnZXRPdXRlckhUTUw7XG5cdFx0XHR0YXJnZXQub3V0ZXJIVE1MID0gZHJhZ1NyY091dGVySFRNTDtcblxuXHRcdFx0Y29uc3QgbmV3RHJhZ1NyY0VsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXG5cdFx0XHRcdGRyb3BUYXJnZXRJZFxuXHRcdFx0KSBhcyBIVE1MRWxlbWVudDtcblx0XHRcdGNvbnN0IG5ld0Ryb3BUYXJnZXRFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdFx0XHRkcmFnU3JjSWRcblx0XHRcdCkgYXMgSFRNTEVsZW1lbnQ7XG5cblx0XHRcdG5ld0RyYWdTcmNFbC5pZCA9IGRyYWdTcmNJZDtcblx0XHRcdG5ld0Ryb3BUYXJnZXRFbC5pZCA9IGRyb3BUYXJnZXRJZDtcblxuXHRcdFx0KFxuXHRcdFx0XHRuZXdEcmFnU3JjRWwucXVlcnlTZWxlY3Rvcihcblx0XHRcdFx0XHQnLmNvbG9yLXRleHQtb3V0cHV0LWJveCdcblx0XHRcdFx0KSBhcyBIVE1MSW5wdXRFbGVtZW50XG5cdFx0XHQpLnZhbHVlID0gZHJvcFRhcmdldFRleHQ7XG5cdFx0XHQoXG5cdFx0XHRcdG5ld0Ryb3BUYXJnZXRFbC5xdWVyeVNlbGVjdG9yKFxuXHRcdFx0XHRcdCcuY29sb3ItdGV4dC1vdXRwdXQtYm94J1xuXHRcdFx0XHQpIGFzIEhUTUxJbnB1dEVsZW1lbnRcblx0XHRcdCkudmFsdWUgPSBkcmFnU3JjVGV4dDtcblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0ICYmIG1vZGUuZGVidWcgJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAzKVxuXHRcdFx0XHRsb2cuaW5mbyhcblx0XHRcdFx0XHQnY2FsbGluZyBhdHRhY2hEcmFnQW5kRHJvcEV2ZW50TGlzdGVuZXJzIGZvciBuZXcgZWxlbWVudHMnXG5cdFx0XHRcdCk7XG5cblx0XHRcdGF0dGFjaERyYWdBbmREcm9wTGlzdGVuZXJzKG5ld0RyYWdTcmNFbCk7XG5cblx0XHRcdGF0dGFjaERyYWdBbmREcm9wTGlzdGVuZXJzKG5ld0Ryb3BUYXJnZXRFbCk7XG5cdFx0fVxuXG5cdFx0aWYgKCFtb2RlLnF1aWV0ICYmIG1vZGUuZGVidWcgJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAzKVxuXHRcdFx0bG9nLmluZm8oJ2hhbmRsZURyb3AgY29tcGxldGUnKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRpZiAoIWxvZ01vZGUuZXJyb3JzKSBsb2cuZXJyb3IoYEVycm9yIGluIGhhbmRsZURyb3A6ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gbWFrZVBhbGV0dGVCb3goY29sb3I6IENvbG9yLCBwYWxldHRlQm94Q291bnQ6IG51bWJlcik6IE1ha2VQYWxldHRlQm94IHtcblx0dHJ5IHtcblx0XHRpZiAoIWNvcmUudmFsaWRhdGUuY29sb3JWYWx1ZXMoY29sb3IpKSB7XG5cdFx0XHRpZiAoIWxvZ01vZGUuZXJyb3JzKVxuXHRcdFx0XHRjb25zb2xlLmVycm9yKFxuXHRcdFx0XHRcdGBJbnZhbGlkICR7Y29sb3IuZm9ybWF0fSBjb2xvciB2YWx1ZSAke0pTT04uc3RyaW5naWZ5KGNvbG9yKX1gXG5cdFx0XHRcdCk7XG5cblx0XHRcdHJldHVybiB7XG5cdFx0XHRcdGNvbG9yU3RyaXBlOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcblx0XHRcdFx0cGFsZXR0ZUJveENvdW50XG5cdFx0XHR9O1xuXHRcdH1cblxuXHRcdGNvbnN0IGNsb25lZENvbG9yID0gY29yZS5iYXNlLmNsb25lKGNvbG9yKTtcblxuXHRcdGNvbnN0IHBhbGV0dGVCb3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblx0XHRwYWxldHRlQm94LmNsYXNzTmFtZSA9ICdwYWxldHRlLWJveCc7XG5cdFx0cGFsZXR0ZUJveC5pZCA9IGBwYWxldHRlLWJveC0ke3BhbGV0dGVCb3hDb3VudH1gO1xuXG5cdFx0Y29uc3QgcGFsZXR0ZUJveFRvcEhhbGYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblx0XHRwYWxldHRlQm94VG9wSGFsZi5jbGFzc05hbWUgPSAncGFsZXR0ZS1ib3gtaGFsZiBwYWxldHRlLWJveC10b3AtaGFsZic7XG5cdFx0cGFsZXR0ZUJveFRvcEhhbGYuaWQgPSBgcGFsZXR0ZS1ib3gtdG9wLWhhbGYtJHtwYWxldHRlQm94Q291bnR9YDtcblxuXHRcdGNvbnN0IGNvbG9yVGV4dE91dHB1dEJveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXG5cdFx0XHQnaW5wdXQnXG5cdFx0KSBhcyBDb2xvcklucHV0RWxlbWVudDtcblx0XHRjb2xvclRleHRPdXRwdXRCb3gudHlwZSA9ICd0ZXh0Jztcblx0XHRjb2xvclRleHRPdXRwdXRCb3guY2xhc3NOYW1lID0gJ2NvbG9yLXRleHQtb3V0cHV0LWJveCB0b29sdGlwJztcblx0XHRjb2xvclRleHRPdXRwdXRCb3guaWQgPSBgY29sb3ItdGV4dC1vdXRwdXQtYm94LSR7cGFsZXR0ZUJveENvdW50fWA7XG5cdFx0Y29sb3JUZXh0T3V0cHV0Qm94LnNldEF0dHJpYnV0ZSgnZGF0YS1mb3JtYXQnLCAnaGV4Jyk7XG5cblx0XHRjb25zdCBjb2xvclN0cmluZyA9IGNvcmUuY29udmVydC50b0NTU0NvbG9yU3RyaW5nKGNsb25lZENvbG9yKTtcblxuXHRcdGNvbG9yVGV4dE91dHB1dEJveC52YWx1ZSA9IGNvbG9yU3RyaW5nIHx8ICcnO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5jb2xvclZhbHVlcyA9IGNsb25lZENvbG9yO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5yZWFkT25seSA9IGZhbHNlO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5zdHlsZS5jdXJzb3IgPSAndGV4dCc7XG5cdFx0Y29sb3JUZXh0T3V0cHV0Qm94LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnbm9uZSc7XG5cblx0XHRjb25zdCBjb3B5QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XG5cdFx0Y29weUJ1dHRvbi5jbGFzc05hbWUgPSAnY29weS1idXR0b24nO1xuXHRcdGNvcHlCdXR0b24udGV4dENvbnRlbnQgPSAnQ29weSc7XG5cblx0XHRjb25zdCB0b29sdGlwVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcblx0XHR0b29sdGlwVGV4dC5jbGFzc05hbWUgPSAndG9vbHRpcHRleHQnO1xuXHRcdHRvb2x0aXBUZXh0LnRleHRDb250ZW50ID0gJ0NvcGllZCB0byBjbGlwYm9hcmQhJztcblxuXHRcdGNvcHlCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dChjb2xvclRleHRPdXRwdXRCb3gudmFsdWUpO1xuXG5cdFx0XHRcdHNob3dUb29sdGlwKGNvbG9yVGV4dE91dHB1dEJveCk7XG5cblx0XHRcdFx0Y2xlYXJUaW1lb3V0KGRhdGEuY29uc3RzLnRpbWVvdXRzLnRvb2x0aXAgfHwgMTAwMCk7XG5cblx0XHRcdFx0Y29weUJ1dHRvbi50ZXh0Q29udGVudCA9ICdDb3BpZWQhJztcblx0XHRcdFx0c2V0VGltZW91dChcblx0XHRcdFx0XHQoKSA9PiAoY29weUJ1dHRvbi50ZXh0Q29udGVudCA9ICdDb3B5JyksXG5cdFx0XHRcdFx0ZGF0YS5jb25zdHMudGltZW91dHMuY29weUJ1dHRvblRleHQgfHwgMTAwMFxuXHRcdFx0XHQpO1xuXHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0aWYgKCFsb2dNb2RlLmVycm9ycykgbG9nLmVycm9yKGBGYWlsZWQgdG8gY29weTogJHtlcnJvcn1gKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5hZGRFdmVudExpc3RlbmVyKFxuXHRcdFx0J2lucHV0Jyxcblx0XHRcdGNvcmUuYmFzZS5kZWJvdW5jZSgoZTogRXZlbnQpID0+IHtcblx0XHRcdFx0Y29uc3QgdGFyZ2V0ID0gZS50YXJnZXQgYXMgSFRNTElucHV0RWxlbWVudCB8IG51bGw7XG5cdFx0XHRcdGlmICh0YXJnZXQpIHtcblx0XHRcdFx0XHRjb25zdCBjc3NDb2xvciA9IHRhcmdldC52YWx1ZS50cmltKCk7XG5cdFx0XHRcdFx0Y29uc3QgYm94RWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdFx0XHRcdFx0YGNvbG9yLWJveC0ke3BhbGV0dGVCb3hDb3VudH1gXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRjb25zdCBzdHJpcGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXG5cdFx0XHRcdFx0XHRgY29sb3Itc3RyaXBlLSR7cGFsZXR0ZUJveENvdW50fWBcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdFx0aWYgKGJveEVsZW1lbnQpIGJveEVsZW1lbnQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY3NzQ29sb3I7XG5cdFx0XHRcdFx0aWYgKHN0cmlwZUVsZW1lbnQpXG5cdFx0XHRcdFx0XHRzdHJpcGVFbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNzc0NvbG9yO1xuXHRcdFx0XHR9XG5cdFx0XHR9LCBkYXRhLmNvbnN0cy5kZWJvdW5jZS5pbnB1dCB8fCAyMDApXG5cdFx0KTtcblxuXHRcdHBhbGV0dGVCb3hUb3BIYWxmLmFwcGVuZENoaWxkKGNvbG9yVGV4dE91dHB1dEJveCk7XG5cdFx0cGFsZXR0ZUJveFRvcEhhbGYuYXBwZW5kQ2hpbGQoY29weUJ1dHRvbik7XG5cblx0XHRjb25zdCBwYWxldHRlQm94Qm90dG9tSGFsZiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXHRcdHBhbGV0dGVCb3hCb3R0b21IYWxmLmNsYXNzTmFtZSA9XG5cdFx0XHQncGFsZXR0ZS1ib3gtaGFsZiBwYWxldHRlLWJveC1ib3R0b20taGFsZic7XG5cdFx0cGFsZXR0ZUJveEJvdHRvbUhhbGYuaWQgPSBgcGFsZXR0ZS1ib3gtYm90dG9tLWhhbGYtJHtwYWxldHRlQm94Q291bnR9YDtcblxuXHRcdGNvbnN0IGNvbG9yQm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cdFx0Y29sb3JCb3guY2xhc3NOYW1lID0gJ2NvbG9yLWJveCc7XG5cdFx0Y29sb3JCb3guaWQgPSBgY29sb3ItYm94LSR7cGFsZXR0ZUJveENvdW50fWA7XG5cdFx0Y29sb3JCb3guc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3JTdHJpbmcgfHwgJyNmZmZmZmYnO1xuXG5cdFx0cGFsZXR0ZUJveEJvdHRvbUhhbGYuYXBwZW5kQ2hpbGQoY29sb3JCb3gpO1xuXHRcdHBhbGV0dGVCb3guYXBwZW5kQ2hpbGQocGFsZXR0ZUJveFRvcEhhbGYpO1xuXHRcdHBhbGV0dGVCb3guYXBwZW5kQ2hpbGQocGFsZXR0ZUJveEJvdHRvbUhhbGYpO1xuXG5cdFx0Y29uc3QgY29sb3JTdHJpcGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblx0XHRjb2xvclN0cmlwZS5jbGFzc05hbWUgPSAnY29sb3Itc3RyaXBlJztcblx0XHRjb2xvclN0cmlwZS5pZCA9IGBjb2xvci1zdHJpcGUtJHtwYWxldHRlQm94Q291bnR9YDtcblx0XHRjb2xvclN0cmlwZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvclN0cmluZyB8fCAnI2ZmZmZmZic7XG5cblx0XHRjb2xvclN0cmlwZS5zZXRBdHRyaWJ1dGUoJ2RyYWdnYWJsZScsICd0cnVlJyk7XG5cblx0XHRhdHRhY2hEcmFnQW5kRHJvcExpc3RlbmVycyhjb2xvclN0cmlwZSk7XG5cblx0XHRjb2xvclN0cmlwZS5hcHBlbmRDaGlsZChwYWxldHRlQm94KTtcblxuXHRcdHJldHVybiB7XG5cdFx0XHRjb2xvclN0cmlwZSxcblx0XHRcdHBhbGV0dGVCb3hDb3VudDogcGFsZXR0ZUJveENvdW50ICsgMVxuXHRcdH07XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKCFsb2dNb2RlLmVycm9ycylcblx0XHRcdGxvZy5lcnJvcihgRmFpbGVkIHRvIGV4ZWN1dGUgbWFrZVBhbGV0dGVCb3g6ICR7ZXJyb3J9YCk7XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0Y29sb3JTdHJpcGU6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLFxuXHRcdFx0cGFsZXR0ZUJveENvdW50XG5cdFx0fTtcblx0fVxufVxuXG5mdW5jdGlvbiBzaG93VG9hc3QobWVzc2FnZTogc3RyaW5nKTogdm9pZCB7XG5cdGNvbnN0IHRvYXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cblx0dG9hc3QuY2xhc3NOYW1lID0gJ3RvYXN0LW1lc3NhZ2UnO1xuXG5cdHRvYXN0LnRleHRDb250ZW50ID0gbWVzc2FnZTtcblxuXHRkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRvYXN0KTtcblxuXHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAzKSBsb2cuaW5mbygnVG9hc3QgbWVzc2FnZSBhZGRlZCcpO1xuXG5cdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdHRvYXN0LmNsYXNzTGlzdC5hZGQoJ2ZhZGUtb3V0Jyk7XG5cblx0XHRpZiAoIW1vZGUucXVpZXQgJiYgbG9nTW9kZS52ZXJib3NpdHkgPiAzKVxuXHRcdFx0bG9nLmluZm8oJ1RvYXN0IG1lc3NhZ2UgZmFkZWQgb3V0Jyk7XG5cblx0XHR0b2FzdC5hZGRFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZWQnLCAoKSA9PiB0b2FzdC5yZW1vdmUoKSk7XG5cdH0sIHRpbWVvdXRzLnRvYXN0IHx8IDMwMDApO1xufVxuXG5mdW5jdGlvbiBzaG93VG9vbHRpcCh0b29sdGlwRWxlbWVudDogSFRNTEVsZW1lbnQpOiB2b2lkIHtcblx0dHJ5IHtcblx0XHRjb25zdCB0b29sdGlwID1cblx0XHRcdHRvb2x0aXBFbGVtZW50LnF1ZXJ5U2VsZWN0b3I8SFRNTEVsZW1lbnQ+KCcudG9vbHRpcHRleHQnKTtcblxuXHRcdGlmICh0b29sdGlwKSB7XG5cdFx0XHR0b29sdGlwLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7XG5cdFx0XHR0b29sdGlwLnN0eWxlLm9wYWNpdHkgPSAnMSc7XG5cdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0dG9vbHRpcC5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7XG5cdFx0XHRcdHRvb2x0aXAuc3R5bGUub3BhY2l0eSA9ICcwJztcblx0XHRcdH0sIGRhdGEuY29uc3RzLnRpbWVvdXRzLnRvb2x0aXAgfHwgMTAwMCk7XG5cdFx0fVxuXG5cdFx0aWYgKCFtb2RlLnF1aWV0ICYmIGxvZ01vZGUudmVyYm9zaXR5ID4gMylcblx0XHRcdGxvZy5pbmZvKCdzaG93VG9vbHRpcCBleGVjdXRlZCcpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGlmIChsb2dNb2RlLmVycm9ycylcblx0XHRcdGxvZy5lcnJvcihgRmFpbGVkIHRvIGV4ZWN1dGUgc2hvd1Rvb2x0aXA6ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVBbmRDb252ZXJ0Q29sb3IoXG5cdGNvbG9yOiBDb2xvciB8IENvbG9yU3RyaW5nIHwgbnVsbFxuKTogQ29sb3IgfCBudWxsIHtcblx0aWYgKCFjb2xvcikgcmV0dXJuIG51bGw7XG5cblx0Y29uc3QgY29udmVydGVkQ29sb3IgPSBjb3JlLmd1YXJkcy5pc0NvbG9yU3RyaW5nKGNvbG9yKVxuXHRcdD8gY29yZS5jb252ZXJ0LnRvQ29sb3IoY29sb3IpXG5cdFx0OiBjb2xvcjtcblxuXHRpZiAoIWNvcmUudmFsaWRhdGUuY29sb3JWYWx1ZXMoY29udmVydGVkQ29sb3IpKSB7XG5cdFx0aWYgKGxvZ01vZGUuZXJyb3JzKVxuXHRcdFx0bG9nLmVycm9yKGBJbnZhbGlkIGNvbG9yOiAke0pTT04uc3RyaW5naWZ5KGNvbnZlcnRlZENvbG9yKX1gKTtcblxuXHRcdHJldHVybiBudWxsO1xuXHR9XG5cblx0cmV0dXJuIGNvbnZlcnRlZENvbG9yO1xufVxuXG5jb25zdCBoYW5kbGU6IENvbW1vbkhlbHBlcnNET01fSGFuZGxlID0ge1xuXHRkcmFnU3RhcnQsXG5cdGRyYWdPdmVyLFxuXHRkcmFnRW5kLFxuXHRkcm9wXG59O1xuXG5leHBvcnQgY29uc3QgZG9tOiBDb21tb25IZWxwZXJzRE9NID0ge1xuXHRhdHRhY2hEcmFnQW5kRHJvcExpc3RlbmVycyxcblx0aGFuZGxlLFxuXHRtYWtlUGFsZXR0ZUJveCxcblx0c2hvd1RvYXN0LFxuXHRzaG93VG9vbHRpcCxcblx0dmFsaWRhdGVBbmRDb252ZXJ0Q29sb3Jcbn0gYXMgY29uc3Q7XG4iXX0=