// File: src/common/helpers/dom.js
import { core } from '../core/index.js';
import { data } from '../../data/index.js';
const timeouts = data.consts.timeouts;
const mode = data.mode;
let dragSrcEl = null;
function attachDragAndDropListeners(element) {
    try {
        if (element) {
            element.addEventListener('dragstart', dragStart);
            element.addEventListener('dragover', dragOver);
            element.addEventListener('drop', drop);
            element.addEventListener('dragend', dragEnd);
        }
        if (!mode.quiet)
            console.log('Drag and drop event listeners successfully attached');
    }
    catch (error) {
        if (!mode.errorLogs)
            console.error(`Failed to execute attachDragAndDropEventListeners: ${error}`);
    }
}
function dragStart(e) {
    try {
        dragSrcEl = e.currentTarget;
        if (e.dataTransfer) {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', dragSrcEl.outerHTML);
        }
        if (!mode.quiet)
            console.log('handleDragStart complete');
    }
    catch (error) {
        if (!mode.errorLogs)
            console.error(`Error in handleDragStart: ${error}`);
    }
}
function dragOver(e) {
    try {
        e.preventDefault();
        if (e.dataTransfer) {
            e.dataTransfer.dropEffect = 'move';
        }
        if (!mode.quiet)
            console.log('handleDragOver complete');
        return false;
    }
    catch (error) {
        if (!mode.errorLogs)
            console.error(`Error in handleDragOver: ${error}`);
        return false;
    }
}
function dragEnd(e) {
    try {
        const target = e.currentTarget;
        target.classList.remove('dragging');
        document.querySelectorAll('.color-stripe').forEach(el => {
            el.classList.remove('dragging');
        });
        if (!mode.quiet)
            console.log('handleDragEnd complete');
    }
    catch (error) {
        if (!mode.errorLogs)
            console.error(`Error in handleDragEnd: ${error}`);
    }
}
function drop(e) {
    try {
        e.stopPropagation();
        const target = e.currentTarget;
        if (dragSrcEl && dragSrcEl !== target) {
            const dragSrcId = dragSrcEl.id;
            const dropTargetId = target.id;
            const dragSrcText = dragSrcEl.querySelector('.color-text-output-box').value;
            const dropTargetText = target.querySelector('.color-text-output-box').value;
            const dragSrcOuterHTML = dragSrcEl.outerHTML;
            const dropTargetOuterHTML = target.outerHTML;
            dragSrcEl.outerHTML = dropTargetOuterHTML;
            target.outerHTML = dragSrcOuterHTML;
            const newDragSrcEl = document.getElementById(dropTargetId);
            const newDropTargetEl = document.getElementById(dragSrcId);
            newDragSrcEl.id = dragSrcId;
            newDropTargetEl.id = dropTargetId;
            newDragSrcEl.querySelector('.color-text-output-box').value = dropTargetText;
            newDropTargetEl.querySelector('.color-text-output-box').value = dragSrcText;
            if (!mode.quiet)
                console.log('calling attachDragAndDropEventListeners for new elements');
            attachDragAndDropListeners(newDragSrcEl);
            attachDragAndDropListeners(newDropTargetEl);
        }
        if (!mode.quiet)
            console.log('handleDrop complete');
    }
    catch (error) {
        if (!mode.errorLogs)
            console.error(`Error in handleDrop: ${error}`);
    }
}
function makePaletteBox(color, paletteBoxCount) {
    try {
        if (!core.validate.colorValues(color)) {
            if (!mode.errorLogs)
                console.error(`Invalid ${color.format} color value ${JSON.stringify(color)}`);
            return {
                colorStripe: document.createElement('div'),
                paletteBoxCount
            };
        }
        const clonedColor = core.base.clone(color);
        const paletteBox = document.createElement('div');
        paletteBox.className = 'palette-box';
        paletteBox.id = `palette-box-${paletteBoxCount}`;
        const paletteBoxTopHalf = document.createElement('div');
        paletteBoxTopHalf.className = 'palette-box-half palette-box-top-half';
        paletteBoxTopHalf.id = `palette-box-top-half-${paletteBoxCount}`;
        const colorTextOutputBox = document.createElement('input');
        colorTextOutputBox.type = 'text';
        colorTextOutputBox.className = 'color-text-output-box tooltip';
        colorTextOutputBox.id = `color-text-output-box-${paletteBoxCount}`;
        colorTextOutputBox.setAttribute('data-format', 'hex');
        const colorString = core.convert.toCSSColorString(clonedColor);
        colorTextOutputBox.value = colorString || '';
        colorTextOutputBox.colorValues = clonedColor;
        colorTextOutputBox.readOnly = false;
        colorTextOutputBox.style.cursor = 'text';
        colorTextOutputBox.style.pointerEvents = 'none';
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.textContent = 'Copy';
        const tooltipText = document.createElement('span');
        tooltipText.className = 'tooltiptext';
        tooltipText.textContent = 'Copied to clipboard!';
        copyButton.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(colorTextOutputBox.value);
                showTooltip(colorTextOutputBox);
                clearTimeout(data.consts.timeouts.tooltip || 1000);
                copyButton.textContent = 'Copied!';
                setTimeout(() => (copyButton.textContent = 'Copy'), data.consts.timeouts.copyButtonText || 1000);
            }
            catch (error) {
                if (!mode.errorLogs)
                    console.error(`Failed to copy: ${error}`);
            }
        });
        colorTextOutputBox.addEventListener('input', core.base.debounce((e) => {
            const target = e.target;
            if (target) {
                const cssColor = target.value.trim();
                const boxElement = document.getElementById(`color-box-${paletteBoxCount}`);
                const stripeElement = document.getElementById(`color-stripe-${paletteBoxCount}`);
                if (boxElement)
                    boxElement.style.backgroundColor = cssColor;
                if (stripeElement)
                    stripeElement.style.backgroundColor = cssColor;
            }
        }, data.consts.debounce.input || 200));
        paletteBoxTopHalf.appendChild(colorTextOutputBox);
        paletteBoxTopHalf.appendChild(copyButton);
        const paletteBoxBottomHalf = document.createElement('div');
        paletteBoxBottomHalf.className =
            'palette-box-half palette-box-bottom-half';
        paletteBoxBottomHalf.id = `palette-box-bottom-half-${paletteBoxCount}`;
        const colorBox = document.createElement('div');
        colorBox.className = 'color-box';
        colorBox.id = `color-box-${paletteBoxCount}`;
        colorBox.style.backgroundColor = colorString || '#ffffff';
        paletteBoxBottomHalf.appendChild(colorBox);
        paletteBox.appendChild(paletteBoxTopHalf);
        paletteBox.appendChild(paletteBoxBottomHalf);
        const colorStripe = document.createElement('div');
        colorStripe.className = 'color-stripe';
        colorStripe.id = `color-stripe-${paletteBoxCount}`;
        colorStripe.style.backgroundColor = colorString || '#ffffff';
        colorStripe.setAttribute('draggable', 'true');
        attachDragAndDropListeners(colorStripe);
        colorStripe.appendChild(paletteBox);
        return {
            colorStripe,
            paletteBoxCount: paletteBoxCount + 1
        };
    }
    catch (error) {
        if (!mode.errorLogs)
            console.error(`Failed to execute makePaletteBox: ${error}`);
        return {
            colorStripe: document.createElement('div'),
            paletteBoxCount
        };
    }
}
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    document.body.appendChild(toast);
    if (!mode.quiet)
        console.log('Toast message added');
    setTimeout(() => {
        toast.classList.add('fade-out');
        if (!mode.quiet)
            console.log('Toast message faded out');
        toast.addEventListener('transitioned', () => toast.remove());
    }, timeouts.toast || 3000);
}
function showTooltip(tooltipElement) {
    try {
        const tooltip = tooltipElement.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
            setTimeout(() => {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            }, data.consts.timeouts.tooltip || 1000);
        }
        console.log('showTooltip executed');
    }
    catch (error) {
        console.error(`Failed to execute showTooltip: ${error}`);
    }
}
function validateAndConvertColor(color) {
    if (!color)
        return null;
    const convertedColor = core.guards.isColorString(color)
        ? core.convert.toColor(color)
        : color;
    if (!core.validate.colorValues(convertedColor)) {
        if (mode.errorLogs)
            console.error(`Invalid color: ${JSON.stringify(convertedColor)}`);
        return null;
    }
    return convertedColor;
}
const handle = {
    dragStart,
    dragOver,
    dragEnd,
    drop
};
export const dom = {
    attachDragAndDropListeners,
    handle,
    makePaletteBox,
    showToast,
    showTooltip,
    validateAndConvertColor
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbW1vbi9oZWxwZXJzL2RvbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxrQ0FBa0M7QUFVbEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUUzQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUN0QyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBRXZCLElBQUksU0FBUyxHQUF1QixJQUFJLENBQUM7QUFFekMsU0FBUywwQkFBMEIsQ0FBQyxPQUEyQjtJQUM5RCxJQUFJLENBQUM7UUFDSixJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQ2IsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUNqRCxPQUFPLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQy9DLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDdkMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM5QyxDQUFDO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLO1lBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUztZQUNsQixPQUFPLENBQUMsS0FBSyxDQUNaLHNEQUFzRCxLQUFLLEVBQUUsQ0FDN0QsQ0FBQztJQUNKLENBQUM7QUFDRixDQUFDO0FBRUQsU0FBUyxTQUFTLENBQUMsQ0FBWTtJQUM5QixJQUFJLENBQUM7UUFDSixTQUFTLEdB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aW1wb3J0IHtcblx0Q29sb3IsXG5cdENvbG9ySW5wdXRFbGVtZW50LFxuXHRDb2xvclN0cmluZyxcblx0Q29tbW9uSGVscGVyc0RPTSxcblx0Q29tbW9uSGVscGVyc0RPTV9IYW5kbGUsXG5cdE1ha2VQYWxldHRlQm94XG59IGZyb20gJy4uLy4uL2luZGV4L2luZGV4LmpzJztcbmltcG9ydCB7IGNvcmUgfSBmcm9tICcuLi9jb3JlL2luZGV4LmpzJztcbmltcG9ydCB7IGRhdGEgfSBmcm9tICcuLi8uLi9kYXRhL2luZGV4LmpzJztcblxuY29uc3QgdGltZW91dHMgPSBkYXRhLmNvbnN0cy50aW1lb3V0cztcbmNvbnN0IG1vZGUgPSBkYXRhLm1vZGU7XG5cbmxldCBkcmFnU3JjRWw6IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGw7XG5cbmZ1bmN0aW9uIGF0dGFjaERyYWdBbmREcm9wTGlzdGVuZXJzKGVsZW1lbnQ6IEhUTUxFbGVtZW50IHwgbnVsbCk6IHZvaWQge1xuXHR0cnkge1xuXHRcdGlmIChlbGVtZW50KSB7XG5cdFx0XHRlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdzdGFydCcsIGRyYWdTdGFydCk7XG5cdFx0XHRlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdvdmVyJywgZHJhZ092ZXIpO1xuXHRcdFx0ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdkcm9wJywgZHJvcCk7XG5cdFx0XHRlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdlbmQnLCBkcmFnRW5kKTtcblx0XHR9XG5cblx0XHRpZiAoIW1vZGUucXVpZXQpXG5cdFx0XHRjb25zb2xlLmxvZygnRHJhZyBhbmQgZHJvcCBldmVudCBsaXN0ZW5lcnMgc3VjY2Vzc2Z1bGx5IGF0dGFjaGVkJyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKCFtb2RlLmVycm9yTG9ncylcblx0XHRcdGNvbnNvbGUuZXJyb3IoXG5cdFx0XHRcdGBGYWlsZWQgdG8gZXhlY3V0ZSBhdHRhY2hEcmFnQW5kRHJvcEV2ZW50TGlzdGVuZXJzOiAke2Vycm9yfWBcblx0XHRcdCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gZHJhZ1N0YXJ0KGU6IERyYWdFdmVudCk6IHZvaWQge1xuXHR0cnkge1xuXHRcdGRyYWdTcmNFbCA9IGUuY3VycmVudFRhcmdldCBhcyBIVE1MRWxlbWVudDtcblxuXHRcdGlmIChlLmRhdGFUcmFuc2Zlcikge1xuXHRcdFx0ZS5kYXRhVHJhbnNmZXIuZWZmZWN0QWxsb3dlZCA9ICdtb3ZlJztcblx0XHRcdGUuZGF0YVRyYW5zZmVyLnNldERhdGEoJ3RleHQvaHRtbCcsIGRyYWdTcmNFbC5vdXRlckhUTUwpO1xuXHRcdH1cblxuXHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ2hhbmRsZURyYWdTdGFydCBjb21wbGV0ZScpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGlmICghbW9kZS5lcnJvckxvZ3MpXG5cdFx0XHRjb25zb2xlLmVycm9yKGBFcnJvciBpbiBoYW5kbGVEcmFnU3RhcnQ6ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gZHJhZ092ZXIoZTogRHJhZ0V2ZW50KTogYm9vbGVhbiB7XG5cdHRyeSB7XG5cdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0aWYgKGUuZGF0YVRyYW5zZmVyKSB7XG5cdFx0XHRlLmRhdGFUcmFuc2Zlci5kcm9wRWZmZWN0ID0gJ21vdmUnO1xuXHRcdH1cblxuXHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ2hhbmRsZURyYWdPdmVyIGNvbXBsZXRlJyk7XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKCFtb2RlLmVycm9yTG9ncykgY29uc29sZS5lcnJvcihgRXJyb3IgaW4gaGFuZGxlRHJhZ092ZXI6ICR7ZXJyb3J9YCk7XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cbn1cblxuZnVuY3Rpb24gZHJhZ0VuZChlOiBEcmFnRXZlbnQpOiB2b2lkIHtcblx0dHJ5IHtcblx0XHRjb25zdCB0YXJnZXQgPSBlLmN1cnJlbnRUYXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG5cblx0XHR0YXJnZXQuY2xhc3NMaXN0LnJlbW92ZSgnZHJhZ2dpbmcnKTtcblxuXHRcdGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5jb2xvci1zdHJpcGUnKS5mb3JFYWNoKGVsID0+IHtcblx0XHRcdGVsLmNsYXNzTGlzdC5yZW1vdmUoJ2RyYWdnaW5nJyk7XG5cdFx0fSk7XG5cblx0XHRpZiAoIW1vZGUucXVpZXQpIGNvbnNvbGUubG9nKCdoYW5kbGVEcmFnRW5kIGNvbXBsZXRlJyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKCFtb2RlLmVycm9yTG9ncykgY29uc29sZS5lcnJvcihgRXJyb3IgaW4gaGFuZGxlRHJhZ0VuZDogJHtlcnJvcn1gKTtcblx0fVxufVxuXG5mdW5jdGlvbiBkcm9wKGU6IERyYWdFdmVudCk6IHZvaWQge1xuXHR0cnkge1xuXHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XG5cblx0XHRjb25zdCB0YXJnZXQgPSBlLmN1cnJlbnRUYXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG5cblx0XHRpZiAoZHJhZ1NyY0VsICYmIGRyYWdTcmNFbCAhPT0gdGFyZ2V0KSB7XG5cdFx0XHRjb25zdCBkcmFnU3JjSWQgPSBkcmFnU3JjRWwuaWQ7XG5cdFx0XHRjb25zdCBkcm9wVGFyZ2V0SWQgPSB0YXJnZXQuaWQ7XG5cdFx0XHRjb25zdCBkcmFnU3JjVGV4dCA9IChcblx0XHRcdFx0ZHJhZ1NyY0VsLnF1ZXJ5U2VsZWN0b3IoXG5cdFx0XHRcdFx0Jy5jb2xvci10ZXh0LW91dHB1dC1ib3gnXG5cdFx0XHRcdCkgYXMgSFRNTElucHV0RWxlbWVudFxuXHRcdFx0KS52YWx1ZTtcblx0XHRcdGNvbnN0IGRyb3BUYXJnZXRUZXh0ID0gKFxuXHRcdFx0XHR0YXJnZXQucXVlcnlTZWxlY3Rvcihcblx0XHRcdFx0XHQnLmNvbG9yLXRleHQtb3V0cHV0LWJveCdcblx0XHRcdFx0KSBhcyBIVE1MSW5wdXRFbGVtZW50XG5cdFx0XHQpLnZhbHVlO1xuXHRcdFx0Y29uc3QgZHJhZ1NyY091dGVySFRNTCA9IGRyYWdTcmNFbC5vdXRlckhUTUw7XG5cdFx0XHRjb25zdCBkcm9wVGFyZ2V0T3V0ZXJIVE1MID0gdGFyZ2V0Lm91dGVySFRNTDtcblxuXHRcdFx0ZHJhZ1NyY0VsLm91dGVySFRNTCA9IGRyb3BUYXJnZXRPdXRlckhUTUw7XG5cdFx0XHR0YXJnZXQub3V0ZXJIVE1MID0gZHJhZ1NyY091dGVySFRNTDtcblxuXHRcdFx0Y29uc3QgbmV3RHJhZ1NyY0VsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXG5cdFx0XHRcdGRyb3BUYXJnZXRJZFxuXHRcdFx0KSBhcyBIVE1MRWxlbWVudDtcblx0XHRcdGNvbnN0IG5ld0Ryb3BUYXJnZXRFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdFx0XHRkcmFnU3JjSWRcblx0XHRcdCkgYXMgSFRNTEVsZW1lbnQ7XG5cblx0XHRcdG5ld0RyYWdTcmNFbC5pZCA9IGRyYWdTcmNJZDtcblx0XHRcdG5ld0Ryb3BUYXJnZXRFbC5pZCA9IGRyb3BUYXJnZXRJZDtcblxuXHRcdFx0KFxuXHRcdFx0XHRuZXdEcmFnU3JjRWwucXVlcnlTZWxlY3Rvcihcblx0XHRcdFx0XHQnLmNvbG9yLXRleHQtb3V0cHV0LWJveCdcblx0XHRcdFx0KSBhcyBIVE1MSW5wdXRFbGVtZW50XG5cdFx0XHQpLnZhbHVlID0gZHJvcFRhcmdldFRleHQ7XG5cdFx0XHQoXG5cdFx0XHRcdG5ld0Ryb3BUYXJnZXRFbC5xdWVyeVNlbGVjdG9yKFxuXHRcdFx0XHRcdCcuY29sb3ItdGV4dC1vdXRwdXQtYm94J1xuXHRcdFx0XHQpIGFzIEhUTUxJbnB1dEVsZW1lbnRcblx0XHRcdCkudmFsdWUgPSBkcmFnU3JjVGV4dDtcblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KVxuXHRcdFx0XHRjb25zb2xlLmxvZyhcblx0XHRcdFx0XHQnY2FsbGluZyBhdHRhY2hEcmFnQW5kRHJvcEV2ZW50TGlzdGVuZXJzIGZvciBuZXcgZWxlbWVudHMnXG5cdFx0XHRcdCk7XG5cblx0XHRcdGF0dGFjaERyYWdBbmREcm9wTGlzdGVuZXJzKG5ld0RyYWdTcmNFbCk7XG5cblx0XHRcdGF0dGFjaERyYWdBbmREcm9wTGlzdGVuZXJzKG5ld0Ryb3BUYXJnZXRFbCk7XG5cdFx0fVxuXG5cdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnaGFuZGxlRHJvcCBjb21wbGV0ZScpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGlmICghbW9kZS5lcnJvckxvZ3MpIGNvbnNvbGUuZXJyb3IoYEVycm9yIGluIGhhbmRsZURyb3A6ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gbWFrZVBhbGV0dGVCb3goY29sb3I6IENvbG9yLCBwYWxldHRlQm94Q291bnQ6IG51bWJlcik6IE1ha2VQYWxldHRlQm94IHtcblx0dHJ5IHtcblx0XHRpZiAoIWNvcmUudmFsaWRhdGUuY29sb3JWYWx1ZXMoY29sb3IpKSB7XG5cdFx0XHRpZiAoIW1vZGUuZXJyb3JMb2dzKVxuXHRcdFx0XHRjb25zb2xlLmVycm9yKFxuXHRcdFx0XHRcdGBJbnZhbGlkICR7Y29sb3IuZm9ybWF0fSBjb2xvciB2YWx1ZSAke0pTT04uc3RyaW5naWZ5KGNvbG9yKX1gXG5cdFx0XHRcdCk7XG5cblx0XHRcdHJldHVybiB7XG5cdFx0XHRcdGNvbG9yU3RyaXBlOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcblx0XHRcdFx0cGFsZXR0ZUJveENvdW50XG5cdFx0XHR9O1xuXHRcdH1cblxuXHRcdGNvbnN0IGNsb25lZENvbG9yID0gY29yZS5iYXNlLmNsb25lKGNvbG9yKTtcblxuXHRcdGNvbnN0IHBhbGV0dGVCb3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblx0XHRwYWxldHRlQm94LmNsYXNzTmFtZSA9ICdwYWxldHRlLWJveCc7XG5cdFx0cGFsZXR0ZUJveC5pZCA9IGBwYWxldHRlLWJveC0ke3BhbGV0dGVCb3hDb3VudH1gO1xuXG5cdFx0Y29uc3QgcGFsZXR0ZUJveFRvcEhhbGYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblx0XHRwYWxldHRlQm94VG9wSGFsZi5jbGFzc05hbWUgPSAncGFsZXR0ZS1ib3gtaGFsZiBwYWxldHRlLWJveC10b3AtaGFsZic7XG5cdFx0cGFsZXR0ZUJveFRvcEhhbGYuaWQgPSBgcGFsZXR0ZS1ib3gtdG9wLWhhbGYtJHtwYWxldHRlQm94Q291bnR9YDtcblxuXHRcdGNvbnN0IGNvbG9yVGV4dE91dHB1dEJveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXG5cdFx0XHQnaW5wdXQnXG5cdFx0KSBhcyBDb2xvcklucHV0RWxlbWVudDtcblx0XHRjb2xvclRleHRPdXRwdXRCb3gudHlwZSA9ICd0ZXh0Jztcblx0XHRjb2xvclRleHRPdXRwdXRCb3guY2xhc3NOYW1lID0gJ2NvbG9yLXRleHQtb3V0cHV0LWJveCB0b29sdGlwJztcblx0XHRjb2xvclRleHRPdXRwdXRCb3guaWQgPSBgY29sb3ItdGV4dC1vdXRwdXQtYm94LSR7cGFsZXR0ZUJveENvdW50fWA7XG5cdFx0Y29sb3JUZXh0T3V0cHV0Qm94LnNldEF0dHJpYnV0ZSgnZGF0YS1mb3JtYXQnLCAnaGV4Jyk7XG5cblx0XHRjb25zdCBjb2xvclN0cmluZyA9IGNvcmUuY29udmVydC50b0NTU0NvbG9yU3RyaW5nKGNsb25lZENvbG9yKTtcblxuXHRcdGNvbG9yVGV4dE91dHB1dEJveC52YWx1ZSA9IGNvbG9yU3RyaW5nIHx8ICcnO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5jb2xvclZhbHVlcyA9IGNsb25lZENvbG9yO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5yZWFkT25seSA9IGZhbHNlO1xuXHRcdGNvbG9yVGV4dE91dHB1dEJveC5zdHlsZS5jdXJzb3IgPSAndGV4dCc7XG5cdFx0Y29sb3JUZXh0T3V0cHV0Qm94LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnbm9uZSc7XG5cblx0XHRjb25zdCBjb3B5QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XG5cdFx0Y29weUJ1dHRvbi5jbGFzc05hbWUgPSAnY29weS1idXR0b24nO1xuXHRcdGNvcHlCdXR0b24udGV4dENvbnRlbnQgPSAnQ29weSc7XG5cblx0XHRjb25zdCB0b29sdGlwVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcblx0XHR0b29sdGlwVGV4dC5jbGFzc05hbWUgPSAndG9vbHRpcHRleHQnO1xuXHRcdHRvb2x0aXBUZXh0LnRleHRDb250ZW50ID0gJ0NvcGllZCB0byBjbGlwYm9hcmQhJztcblxuXHRcdGNvcHlCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dChjb2xvclRleHRPdXRwdXRCb3gudmFsdWUpO1xuXG5cdFx0XHRcdHNob3dUb29sdGlwKGNvbG9yVGV4dE91dHB1dEJveCk7XG5cblx0XHRcdFx0Y2xlYXJUaW1lb3V0KGRhdGEuY29uc3RzLnRpbWVvdXRzLnRvb2x0aXAgfHwgMTAwMCk7XG5cblx0XHRcdFx0Y29weUJ1dHRvbi50ZXh0Q29udGVudCA9ICdDb3BpZWQhJztcblx0XHRcdFx0c2V0VGltZW91dChcblx0XHRcdFx0XHQoKSA9PiAoY29weUJ1dHRvbi50ZXh0Q29udGVudCA9ICdDb3B5JyksXG5cdFx0XHRcdFx0ZGF0YS5jb25zdHMudGltZW91dHMuY29weUJ1dHRvblRleHQgfHwgMTAwMFxuXHRcdFx0XHQpO1xuXHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0aWYgKCFtb2RlLmVycm9yTG9ncykgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGNvcHk6ICR7ZXJyb3J9YCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRjb2xvclRleHRPdXRwdXRCb3guYWRkRXZlbnRMaXN0ZW5lcihcblx0XHRcdCdpbnB1dCcsXG5cdFx0XHRjb3JlLmJhc2UuZGVib3VuY2UoKGU6IEV2ZW50KSA9PiB7XG5cdFx0XHRcdGNvbnN0IHRhcmdldCA9IGUudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQgfCBudWxsO1xuXHRcdFx0XHRpZiAodGFyZ2V0KSB7XG5cdFx0XHRcdFx0Y29uc3QgY3NzQ29sb3IgPSB0YXJnZXQudmFsdWUudHJpbSgpO1xuXHRcdFx0XHRcdGNvbnN0IGJveEVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcblx0XHRcdFx0XHRcdGBjb2xvci1ib3gtJHtwYWxldHRlQm94Q291bnR9YFxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0Y29uc3Qgc3RyaXBlRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuXHRcdFx0XHRcdFx0YGNvbG9yLXN0cmlwZS0ke3BhbGV0dGVCb3hDb3VudH1gXG5cdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdGlmIChib3hFbGVtZW50KSBib3hFbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNzc0NvbG9yO1xuXHRcdFx0XHRcdGlmIChzdHJpcGVFbGVtZW50KVxuXHRcdFx0XHRcdFx0c3RyaXBlRWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjc3NDb2xvcjtcblx0XHRcdFx0fVxuXHRcdFx0fSwgZGF0YS5jb25zdHMuZGVib3VuY2UuaW5wdXQgfHwgMjAwKVxuXHRcdCk7XG5cblx0XHRwYWxldHRlQm94VG9wSGFsZi5hcHBlbmRDaGlsZChjb2xvclRleHRPdXRwdXRCb3gpO1xuXHRcdHBhbGV0dGVCb3hUb3BIYWxmLmFwcGVuZENoaWxkKGNvcHlCdXR0b24pO1xuXG5cdFx0Y29uc3QgcGFsZXR0ZUJveEJvdHRvbUhhbGYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblx0XHRwYWxldHRlQm94Qm90dG9tSGFsZi5jbGFzc05hbWUgPVxuXHRcdFx0J3BhbGV0dGUtYm94LWhhbGYgcGFsZXR0ZS1ib3gtYm90dG9tLWhhbGYnO1xuXHRcdHBhbGV0dGVCb3hCb3R0b21IYWxmLmlkID0gYHBhbGV0dGUtYm94LWJvdHRvbS1oYWxmLSR7cGFsZXR0ZUJveENvdW50fWA7XG5cblx0XHRjb25zdCBjb2xvckJveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXHRcdGNvbG9yQm94LmNsYXNzTmFtZSA9ICdjb2xvci1ib3gnO1xuXHRcdGNvbG9yQm94LmlkID0gYGNvbG9yLWJveC0ke3BhbGV0dGVCb3hDb3VudH1gO1xuXHRcdGNvbG9yQm94LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yU3RyaW5nIHx8ICcjZmZmZmZmJztcblxuXHRcdHBhbGV0dGVCb3hCb3R0b21IYWxmLmFwcGVuZENoaWxkKGNvbG9yQm94KTtcblx0XHRwYWxldHRlQm94LmFwcGVuZENoaWxkKHBhbGV0dGVCb3hUb3BIYWxmKTtcblx0XHRwYWxldHRlQm94LmFwcGVuZENoaWxkKHBhbGV0dGVCb3hCb3R0b21IYWxmKTtcblxuXHRcdGNvbnN0IGNvbG9yU3RyaXBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cdFx0Y29sb3JTdHJpcGUuY2xhc3NOYW1lID0gJ2NvbG9yLXN0cmlwZSc7XG5cdFx0Y29sb3JTdHJpcGUuaWQgPSBgY29sb3Itc3RyaXBlLSR7cGFsZXR0ZUJveENvdW50fWA7XG5cdFx0Y29sb3JTdHJpcGUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3JTdHJpbmcgfHwgJyNmZmZmZmYnO1xuXG5cdFx0Y29sb3JTdHJpcGUuc2V0QXR0cmlidXRlKCdkcmFnZ2FibGUnLCAndHJ1ZScpO1xuXG5cdFx0YXR0YWNoRHJhZ0FuZERyb3BMaXN0ZW5lcnMoY29sb3JTdHJpcGUpO1xuXG5cdFx0Y29sb3JTdHJpcGUuYXBwZW5kQ2hpbGQocGFsZXR0ZUJveCk7XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0Y29sb3JTdHJpcGUsXG5cdFx0XHRwYWxldHRlQm94Q291bnQ6IHBhbGV0dGVCb3hDb3VudCArIDFcblx0XHR9O1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGlmICghbW9kZS5lcnJvckxvZ3MpXG5cdFx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gZXhlY3V0ZSBtYWtlUGFsZXR0ZUJveDogJHtlcnJvcn1gKTtcblxuXHRcdHJldHVybiB7XG5cdFx0XHRjb2xvclN0cmlwZTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksXG5cdFx0XHRwYWxldHRlQm94Q291bnRcblx0XHR9O1xuXHR9XG59XG5cbmZ1bmN0aW9uIHNob3dUb2FzdChtZXNzYWdlOiBzdHJpbmcpOiB2b2lkIHtcblx0Y29uc3QgdG9hc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblxuXHR0b2FzdC5jbGFzc05hbWUgPSAndG9hc3QtbWVzc2FnZSc7XG5cblx0dG9hc3QudGV4dENvbnRlbnQgPSBtZXNzYWdlO1xuXG5cdGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodG9hc3QpO1xuXG5cdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ1RvYXN0IG1lc3NhZ2UgYWRkZWQnKTtcblxuXHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHR0b2FzdC5jbGFzc0xpc3QuYWRkKCdmYWRlLW91dCcpO1xuXG5cdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnVG9hc3QgbWVzc2FnZSBmYWRlZCBvdXQnKTtcblxuXHRcdHRvYXN0LmFkZEV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lZCcsICgpID0+IHRvYXN0LnJlbW92ZSgpKTtcblx0fSwgdGltZW91dHMudG9hc3QgfHwgMzAwMCk7XG59XG5cbmZ1bmN0aW9uIHNob3dUb29sdGlwKHRvb2x0aXBFbGVtZW50OiBIVE1MRWxlbWVudCk6IHZvaWQge1xuXHR0cnkge1xuXHRcdGNvbnN0IHRvb2x0aXAgPVxuXHRcdFx0dG9vbHRpcEVsZW1lbnQucXVlcnlTZWxlY3RvcjxIVE1MRWxlbWVudD4oJy50b29sdGlwdGV4dCcpO1xuXG5cdFx0aWYgKHRvb2x0aXApIHtcblx0XHRcdHRvb2x0aXAuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJztcblx0XHRcdHRvb2x0aXAuc3R5bGUub3BhY2l0eSA9ICcxJztcblx0XHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHR0b29sdGlwLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJztcblx0XHRcdFx0dG9vbHRpcC5zdHlsZS5vcGFjaXR5ID0gJzAnO1xuXHRcdFx0fSwgZGF0YS5jb25zdHMudGltZW91dHMudG9vbHRpcCB8fCAxMDAwKTtcblx0XHR9XG5cblx0XHRjb25zb2xlLmxvZygnc2hvd1Rvb2x0aXAgZXhlY3V0ZWQnKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gZXhlY3V0ZSBzaG93VG9vbHRpcDogJHtlcnJvcn1gKTtcblx0fVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUFuZENvbnZlcnRDb2xvcihcblx0Y29sb3I6IENvbG9yIHwgQ29sb3JTdHJpbmcgfCBudWxsXG4pOiBDb2xvciB8IG51bGwge1xuXHRpZiAoIWNvbG9yKSByZXR1cm4gbnVsbDtcblxuXHRjb25zdCBjb252ZXJ0ZWRDb2xvciA9IGNvcmUuZ3VhcmRzLmlzQ29sb3JTdHJpbmcoY29sb3IpXG5cdFx0PyBjb3JlLmNvbnZlcnQudG9Db2xvcihjb2xvcilcblx0XHQ6IGNvbG9yO1xuXG5cdGlmICghY29yZS52YWxpZGF0ZS5jb2xvclZhbHVlcyhjb252ZXJ0ZWRDb2xvcikpIHtcblx0XHRpZiAobW9kZS5lcnJvckxvZ3MpXG5cdFx0XHRjb25zb2xlLmVycm9yKGBJbnZhbGlkIGNvbG9yOiAke0pTT04uc3RyaW5naWZ5KGNvbnZlcnRlZENvbG9yKX1gKTtcblxuXHRcdHJldHVybiBudWxsO1xuXHR9XG5cblx0cmV0dXJuIGNvbnZlcnRlZENvbG9yO1xufVxuXG5jb25zdCBoYW5kbGU6IENvbW1vbkhlbHBlcnNET01fSGFuZGxlID0ge1xuXHRkcmFnU3RhcnQsXG5cdGRyYWdPdmVyLFxuXHRkcmFnRW5kLFxuXHRkcm9wXG59O1xuXG5leHBvcnQgY29uc3QgZG9tOiBDb21tb25IZWxwZXJzRE9NID0ge1xuXHRhdHRhY2hEcmFnQW5kRHJvcExpc3RlbmVycyxcblx0aGFuZGxlLFxuXHRtYWtlUGFsZXR0ZUJveCxcblx0c2hvd1RvYXN0LFxuXHRzaG93VG9vbHRpcCxcblx0dmFsaWRhdGVBbmRDb252ZXJ0Q29sb3Jcbn0gYXMgY29uc3Q7XG4iXX0=