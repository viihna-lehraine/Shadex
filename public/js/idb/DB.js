// File: src/idb/DB.ts
import { openDB } from 'idb';
import { config } from '../config';
import { utils } from '../common';
export class DB {
    static instance;
    dbPromise;
    defaultSettings;
    mode;
    constructor() {
        this.defaultSettings = config.defaults.idb.settings;
        this.mode = config.mode;
        this.dbPromise = openDB('paletteDB', 1, {
            upgrade(db) {
                const stores = [
                    'customColor',
                    'mutations',
                    'settings',
                    'tables'
                ];
                stores.forEach(store => {
                    if (!db.objectStoreNames.contains(store)) {
                        db.createObjectStore(store, {
                            keyPath: store === 'mutations' ? 'timestamp' : 'key'
                        });
                    }
                });
            }
        });
    }
    static getInstance() {
        if (!DB.instance) {
            DB.instance = new DB();
        }
        return DB.instance;
    }
    createMutationLogger(obj, key) {
        const logMutation = this.logMutation.bind(this); // Bind the class context
        return new Proxy(obj, {
            set(target, property, value) {
                const oldValue = target[property];
                const success = Reflect.set(target, property, value);
                if (success) {
                    logMutation({
                        timestamp: new Date().toISOString(),
                        key,
                        action: 'update',
                        newValue: { [property]: value },
                        oldValue: { [property]: oldValue },
                        origin: 'Proxy'
                    });
                }
                return success;
            }
        });
    }
    async getCustomColor() {
        const db = await this.getDB();
        const entry = await db.get('customColor', 'customColor');
        return entry?.color
            ? this.createMutationLogger(entry.color, 'customColor')
            : null;
    }
    getLoggedObject(obj, key) {
        if (obj) {
            return this.createMutationLogger(obj, key);
        }
        return null;
    }
    async getNextTableID() {
        const settings = await this.getSettings();
        const nextID = settings.lastTableID + 1;
        await this.saveData('settings', 'appSettings', {
            ...settings,
            lastTableID: nextID
        });
        return `palette_${nextID}`;
    }
    async getSettings() {
        try {
            const db = await this.getDB();
            const settings = await db.get('settings', 'appSettings');
            return settings ?? this.defaultSettings;
        }
        catch (error) {
            if (this.mode.logErrors)
                console.error('Error fetching settings:', error);
            return { colorSpace: 'hex', lastTableID: 0 };
        }
    }
    async getStore(storeName, mode) {
        const db = await this.getDB();
        return db.transaction(storeName, mode).objectStore(storeName);
    }
    async logMutation(log) {
        const db = await this.getDB();
        await db.put('mutations', log);
        if (!this.mode.quiet)
            console.log(`Logged mutation: ${JSON.stringify(log)}`);
    }
    async updateEntryInPalette(tableID, entryIndex, newEntry) {
        try {
            const storedPalette = await this.getTable(tableID);
            if (!storedPalette)
                throw new Error(`Palette ${tableID} not found.`);
            const { items } = storedPalette.palette;
            if (entryIndex >= items.length) {
                if (!this.mode.gracefulErrors)
                    throw new Error(`Entry ${entryIndex} not found in palette ${tableID}.`);
                if (this.mode.logErrors)
                    console.error(`Entry ${entryIndex} not found in palette ${tableID}.`);
                if (!this.mode.quiet)
                    console.log('updateEntryInPalette: Entry not found.');
            }
            const oldEntry = items[entryIndex];
            items[entryIndex] = newEntry;
            await this.saveData('tables', tableID, storedPalette);
            await this.logMutation({
                timestamp: new Date().toISOString(),
                key: `${tableID}-${entryIndex}]`,
                action: 'update',
                newValue: newEntry,
                oldValue: oldEntry,
                origin: 'updateEntryInPalette'
            });
            if (!this.mode.quiet)
                console.log(`Entry ${entryIndex} in palette ${tableID} updated.`);
        }
        catch (error) {
            if (this.mode.logErrors)
                console.error(`Failed to update entry in palette: ${error}`);
            throw error;
        }
    }
    async renderPalette(tableId) {
        try {
            const storedPalette = await this.getTable(tableId);
            const paletteRow = document.getElementById('palette-row');
            if (!storedPalette)
                throw new Error(`Palette ${tableId} not found.`);
            if (!paletteRow)
                throw new Error('Palette row element not found.');
            paletteRow.innerHTML = '';
            const fragment = document.createDocumentFragment();
            const table = document.createElement('table');
            table.classList.add('palette-table');
            storedPalette.palette.items.forEach((item, index) => {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                const colorBox = document.createElement('div');
                cell.textContent = `Color ${index + 1}`;
                colorBox.classList.add('color-box');
                colorBox.style.backgroundColor = item.cssStrings.hexCSSString;
                row.appendChild(colorBox);
                row.appendChild(cell);
                table.appendChild(row);
            });
            fragment.appendChild(table);
            paletteRow.appendChild(fragment);
            if (!this.mode.quiet)
                console.log(`Rendered palette ${tableId}.`);
        }
        catch (error) {
            if (this.mode.logErrors)
                console.error(`Failed to render palette: ${error}`);
        }
    }
    async saveData(storeName, key, data, oldValue) {
        try {
            const db = await this.getDB();
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            await store.put({ key, ...data });
            await tx.done;
            console.log(`${key} saved to ${storeName}.`);
            await this.logMutation({
                timestamp: new Date().toISOString(),
                key,
                action: 'update',
                newValue: data,
                oldValue: oldValue ? oldValue : null,
                origin: 'saveData'
            });
        }
        catch (error) {
            if (this.mode.logErrors)
                console.error(`Failed to save data to ${storeName}:`, error);
            throw error;
        }
    }
    async savePalette(id, newPalette) {
        try {
            const store = await this.getStore('tables', 'readwrite');
            const paletteToSave = {
                tableID: newPalette.tableID,
                palette: newPalette.palette
            };
            await store.put({ key: id, ...paletteToSave });
            if (!this.mode.quiet)
                console.log(`Palette ${id} saved successfully.`);
        }
        catch (error) {
            if (this.mode.logErrors)
                console.error(`Failed to save palette ${id}: ${error}`);
            throw error;
        }
    }
    async savePaletteToDB(type, items, baseColor, numBoxes, enableAlpha, limitDark, limitGray, limitLight) {
        const paletteID = await this.getNextPaletteID();
        const newPalette = utils.palette.createObject(type, items, baseColor, paletteID, numBoxes, enableAlpha, limitDark, limitGray, limitLight);
        await this.savePalette(newPalette.id, {
            tableID: parseInt(newPalette.id.split('_')[1]),
            palette: newPalette
        });
        if (!this.mode.quiet)
            console.log(`Saved ${type} palette: ${JSON.stringify(newPalette)}`);
        return newPalette;
    }
    async saveSettings(newSettings) {
        try {
            await this.saveData('settings', 'appSettings', newSettings);
            if (!this.mode.quiet)
                console.log('Settings updated');
        }
        catch (error) {
            if (this.mode.logErrors)
                console.error(`Failed to save settings: ${error}`);
            throw error;
        }
    }
    async trackedTransaction(storeName, mode, callback) {
        const db = await this.getDB();
        const tx = db.transaction(storeName, mode);
        const store = tx.objectStore(storeName);
        try {
            await callback(store);
            await tx.done;
            if (!this.mode.quiet)
                console.log(`Transaction on ${storeName} completed.`);
        }
        catch (error) {
            if (this.mode.logErrors)
                console.error(`Transaction on ${storeName} failed: ${error}`);
            throw error;
        }
    }
    async getCurrentPaletteID() {
        const db = await this.getDB();
        const settings = await db.get('settings', 'appSettings');
        return settings?.lastPaletteID ?? 0;
    }
    async getDB() {
        return this.dbPromise;
    }
    async getNextPaletteID() {
        const currentID = await this.getCurrentPaletteID();
        const newID = currentID + 1;
        await this.updateCurrentPaletteID(newID);
        return newID;
    }
    async getTable(id) {
        const db = await this.getDB();
        const result = await db.get('tables', id);
        if (!result) {
            if (this.mode.logErrors)
                console.warn(`Table with ID ${id} not found.`);
        }
        return result;
    }
    async updateCurrentPaletteID(newID) {
        const db = await this.getDB();
        const tx = db.transaction('settings', 'readwrite');
        const store = tx.objectStore('settings');
        await store.put({ key: 'appSettings', lastPaletteID: newID });
        await tx.done;
        if (!this.mode.quiet)
            console.log(`Current palette ID updated to ${newID}`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiREIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaWRiL0RCLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHNCQUFzQjtBQUV0QixPQUFPLEVBQWlDLE1BQU0sRUFBRSxNQUFNLEtBQUssQ0FBQztBQVk1RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25DLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFbEMsTUFBTSxPQUFPLEVBQUU7SUFDTixNQUFNLENBQUMsUUFBUSxDQUFLO0lBRXBCLFNBQVMsQ0FBdUM7SUFDaEQsZUFBZSxDQUFXO0lBQzFCLElBQUksQ0FBMEI7SUFFdEM7UUFDQyxJQUFJLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUNwRCxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQWdCLFdBQVcsRUFBRSxDQUFDLEVBQUU7WUFDdEQsT0FBTyxDQUFDLEVBQUU7Z0JBQ1QsTUFBTSxNQUFNLEdBQUc7b0JBQ2QsYUFBYTtvQkFDYixXQUFXO29CQUNYLFVBQVU7b0JBQ1YsUUFBUTtpQkFDUixDQUFDO2dCQUVGLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7b0JBQ3RCLElBQUksQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7d0JBQzFDLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUU7NEJBQzNCLE9BQU8sRUFBRSxLQUFLLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUs7eUJBQ3BELENBQUMsQ0FBQztvQkFDSixDQUFDO2dCQUNGLENBQUMsQ0FBQyxDQUFDO1lBQ0osQ0FBQztTQUNELENBQUMsQ0FB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QUFHLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzlELE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQztRQUVkLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUs7WUFDbkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUN4RCxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBGaWxlOiBzcmMvaWRiL0RCLnRzXG5cbmltcG9ydCB7IElEQlBEYXRhYmFzZSwgSURCUE9iamVjdFN0b3JlLCBvcGVuREIgfSBmcm9tICdpZGInO1xuaW1wb3J0IHtcblx0REJJbnRlcmZhY2UsXG5cdEhTTCxcblx0TXV0YXRpb25Mb2csXG5cdFBhbGV0dGUsXG5cdFBhbGV0dGVEQixcblx0UGFsZXR0ZUl0ZW0sXG5cdFBhbGV0dGVTY2hlbWEsXG5cdFNldHRpbmdzLFxuXHRTdG9yZWRQYWxldHRlXG59IGZyb20gJy4uL2luZGV4JztcbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgeyB1dGlscyB9IGZyb20gJy4uL2NvbW1vbic7XG5cbmV4cG9ydCBjbGFzcyBEQiBpbXBsZW1lbnRzIERCSW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IERCO1xuXG5cdHByaXZhdGUgZGJQcm9taXNlOiBQcm9taXNlPElEQlBEYXRhYmFzZTxQYWxldHRlU2NoZW1hPj47XG5cdHByaXZhdGUgZGVmYXVsdFNldHRpbmdzOiBTZXR0aW5ncztcblx0cHJpdmF0ZSBtb2RlOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPjtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKCkge1xuXHRcdHRoaXMuZGVmYXVsdFNldHRpbmdzID0gY29uZmlnLmRlZmF1bHRzLmlkYi5zZXR0aW5ncztcblx0XHR0aGlzLm1vZGUgPSBjb25maWcubW9kZTtcblx0XHR0aGlzLmRiUHJvbWlzZSA9IG9wZW5EQjxQYWxldHRlU2NoZW1hPigncGFsZXR0ZURCJywgMSwge1xuXHRcdFx0dXBncmFkZShkYikge1xuXHRcdFx0XHRjb25zdCBzdG9yZXMgPSBbXG5cdFx0XHRcdFx0J2N1c3RvbUNvbG9yJyxcblx0XHRcdFx0XHQnbXV0YXRpb25zJyxcblx0XHRcdFx0XHQnc2V0dGluZ3MnLFxuXHRcdFx0XHRcdCd0YWJsZXMnXG5cdFx0XHRcdF07XG5cblx0XHRcdFx0c3RvcmVzLmZvckVhY2goc3RvcmUgPT4ge1xuXHRcdFx0XHRcdGlmICghZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhzdG9yZSkpIHtcblx0XHRcdFx0XHRcdGRiLmNyZWF0ZU9iamVjdFN0b3JlKHN0b3JlLCB7XG5cdFx0XHRcdFx0XHRcdGtleVBhdGg6IHN0b3JlID09PSAnbXV0YXRpb25zJyA/ICd0aW1lc3RhbXAnIDogJ2tleSdcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGdldEluc3RhbmNlKCk6IERCIHtcblx0XHRpZiAoIURCLmluc3RhbmNlKSB7XG5cdFx0XHREQi5pbnN0YW5jZSA9IG5ldyBEQigpO1xuXHRcdH1cblxuXHRcdHJldHVybiBEQi5pbnN0YW5jZTtcblx0fVxuXG5cdHB1YmxpYyBjcmVhdGVNdXRhdGlvbkxvZ2dlcjxUIGV4dGVuZHMgb2JqZWN0PihvYmo6IFQsIGtleTogc3RyaW5nKTogVCB7XG5cdFx0Y29uc3QgbG9nTXV0YXRpb24gPSB0aGlzLmxvZ011dGF0aW9uLmJpbmQodGhpcyk7IC8vIEJpbmQgdGhlIGNsYXNzIGNvbnRleHRcblxuXHRcdHJldHVybiBuZXcgUHJveHkob2JqLCB7XG5cdFx0XHRzZXQodGFyZ2V0LCBwcm9wZXJ0eSwgdmFsdWUpIHtcblx0XHRcdFx0Y29uc3Qgb2xkVmFsdWUgPSB0YXJnZXRbcHJvcGVydHkgYXMga2V5b2YgVF07XG5cdFx0XHRcdGNvbnN0IHN1Y2Nlc3MgPSBSZWZsZWN0LnNldCh0YXJnZXQsIHByb3BlcnR5LCB2YWx1ZSk7XG5cblx0XHRcdFx0aWYgKHN1Y2Nlc3MpIHtcblx0XHRcdFx0XHRsb2dNdXRhdGlvbih7XG5cdFx0XHRcdFx0XHR0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcblx0XHRcdFx0XHRcdGtleSxcblx0XHRcdFx0XHRcdGFjdGlvbjogJ3VwZGF0ZScsXG5cdFx0XHRcdFx0XHRuZXdWYWx1ZTogeyBbcHJvcGVydHldOiB2YWx1ZSB9LFxuXHRcdFx0XHRcdFx0b2xkVmFsdWU6IHsgW3Byb3BlcnR5XTogb2xkVmFsdWUgfSxcblx0XHRcdFx0XHRcdG9yaWdpbjogJ1Byb3h5J1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIHN1Y2Nlc3M7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZ2V0Q3VzdG9tQ29sb3IoKTogUHJvbWlzZTxIU0wgfCBudWxsPiB7XG5cdFx0Y29uc3QgZGIgPSBhd2FpdCB0aGlzLmdldERCKCk7XG5cdFx0Y29uc3QgZW50cnkgPSBhd2FpdCBkYi5nZXQoJ2N1c3RvbUNvbG9yJywgJ2N1c3RvbUNvbG9yJyk7XG5cblx0XHRyZXR1cm4gZW50cnk/LmNvbG9yXG5cdFx0XHQ/IHRoaXMuY3JlYXRlTXV0YXRpb25Mb2dnZXIoZW50cnkuY29sb3IsICdjdXN0b21Db2xvcicpXG5cdFx0XHQ6IG51bGw7XG5cdH1cblxuXHRwdWJsaWMgZ2V0TG9nZ2VkT2JqZWN0PFQgZXh0ZW5kcyBvYmplY3Q+KFxuXHRcdG9iajogVCB8IG51bGwsXG5cdFx0a2V5OiBzdHJpbmdcblx0KTogVCB8IG51bGwge1xuXHRcdGlmIChvYmopIHtcblx0XHRcdHJldHVybiB0aGlzLmNyZWF0ZU11dGF0aW9uTG9nZ2VyKG9iaiwga2V5KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gbnVsbDtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBnZXROZXh0VGFibGVJRCgpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRcdGNvbnN0IHNldHRpbmdzID0gYXdhaXQgdGhpcy5nZXRTZXR0aW5ncygpO1xuXHRcdGNvbnN0IG5leHRJRCA9IHNldHRpbmdzLmxhc3RUYWJsZUlEICsgMTtcblxuXHRcdGF3YWl0IHRoaXMuc2F2ZURhdGEoJ3NldHRpbmdzJywgJ2FwcFNldHRpbmdzJywge1xuXHRcdFx0Li4uc2V0dGluZ3MsXG5cdFx0XHRsYXN0VGFibGVJRDogbmV4dElEXG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gYHBhbGV0dGVfJHtuZXh0SUR9YDtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBnZXRTZXR0aW5ncygpOiBQcm9taXNlPFNldHRpbmdzPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IGRiID0gYXdhaXQgdGhpcy5nZXREQigpO1xuXHRcdFx0Y29uc3Qgc2V0dGluZ3MgPSBhd2FpdCBkYi5nZXQoJ3NldHRpbmdzJywgJ2FwcFNldHRpbmdzJyk7XG5cblx0XHRcdHJldHVybiBzZXR0aW5ncyA/PyB0aGlzLmRlZmF1bHRTZXR0aW5ncztcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0aWYgKHRoaXMubW9kZS5sb2dFcnJvcnMpXG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIHNldHRpbmdzOicsIGVycm9yKTtcblxuXHRcdFx0cmV0dXJuIHsgY29sb3JTcGFjZTogJ2hleCcsIGxhc3RUYWJsZUlEOiAwIH07XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldFN0b3JlPFN0b3JlTmFtZSBleHRlbmRzIGtleW9mIFBhbGV0dGVTY2hlbWE+KFxuXHRcdHN0b3JlTmFtZTogU3RvcmVOYW1lLFxuXHRcdG1vZGU6ICdyZWFkb25seSdcblx0KTogUHJvbWlzZTxcblx0XHRJREJQT2JqZWN0U3RvcmU8UGFsZXR0ZVNjaGVtYSwgW1N0b3JlTmFtZV0sIFN0b3JlTmFtZSwgJ3JlYWRvbmx5Jz5cblx0PjtcblxuXHRwdWJsaWMgYXN5bmMgZ2V0U3RvcmU8U3RvcmVOYW1lIGV4dGVuZHMga2V5b2YgUGFsZXR0ZVNjaGVtYT4oXG5cdFx0c3RvcmVOYW1lOiBTdG9yZU5hbWUsXG5cdFx0bW9kZTogJ3JlYWR3cml0ZSdcblx0KTogUHJvbWlzZTxcblx0XHRJREJQT2JqZWN0U3RvcmU8UGFsZXR0ZVNjaGVtYSwgW1N0b3JlTmFtZV0sIFN0b3JlTmFtZSwgJ3JlYWR3cml0ZSc+XG5cdD47XG5cblx0cHVibGljIGFzeW5jIGdldFN0b3JlPFN0b3JlTmFtZSBleHRlbmRzIGtleW9mIFBhbGV0dGVTY2hlbWE+KFxuXHRcdHN0b3JlTmFtZTogU3RvcmVOYW1lLFxuXHRcdG1vZGU6ICdyZWFkb25seScgfCAncmVhZHdyaXRlJ1xuXHQpIHtcblx0XHRjb25zdCBkYiA9IGF3YWl0IHRoaXMuZ2V0REIoKTtcblxuXHRcdHJldHVybiBkYi50cmFuc2FjdGlvbihzdG9yZU5hbWUsIG1vZGUpLm9iamVjdFN0b3JlKHN0b3JlTmFtZSk7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgbG9nTXV0YXRpb24obG9nOiBNdXRhdGlvbkxvZyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IGRiID0gYXdhaXQgdGhpcy5nZXREQigpO1xuXG5cdFx0YXdhaXQgZGIucHV0KCdtdXRhdGlvbnMnLCBsb2cpO1xuXG5cdFx0aWYgKCF0aGlzLm1vZGUucXVpZXQpXG5cdFx0XHRjb25zb2xlLmxvZyhgTG9nZ2VkIG11dGF0aW9uOiAke0pTT04uc3RyaW5naWZ5KGxvZyl9YCk7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgdXBkYXRlRW50cnlJblBhbGV0dGUoXG5cdFx0dGFibGVJRDogc3RyaW5nLFxuXHRcdGVudHJ5SW5kZXg6IG51bWJlcixcblx0XHRuZXdFbnRyeTogUGFsZXR0ZUl0ZW1cblx0KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHN0b3JlZFBhbGV0dGUgPSBhd2FpdCB0aGlzLmdldFRhYmxlKHRhYmxlSUQpO1xuXG5cdFx0XHRpZiAoIXN0b3JlZFBhbGV0dGUpXG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihgUGFsZXR0ZSAke3RhYmxlSUR9IG5vdCBmb3VuZC5gKTtcblxuXHRcdFx0Y29uc3QgeyBpdGVtcyB9ID0gc3RvcmVkUGFsZXR0ZS5wYWxldHRlO1xuXG5cdFx0XHRpZiAoZW50cnlJbmRleCA+PSBpdGVtcy5sZW5ndGgpIHtcblx0XHRcdFx0aWYgKCF0aGlzLm1vZGUuZ3JhY2VmdWxFcnJvcnMpXG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRcdFx0YEVudHJ5ICR7ZW50cnlJbmRleH0gbm90IGZvdW5kIGluIHBhbGV0dGUgJHt0YWJsZUlEfS5gXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0aWYgKHRoaXMubW9kZS5sb2dFcnJvcnMpXG5cdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0XHRcdGBFbnRyeSAke2VudHJ5SW5kZXh9IG5vdCBmb3VuZCBpbiBwYWxldHRlICR7dGFibGVJRH0uYFxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdGlmICghdGhpcy5tb2RlLnF1aWV0KVxuXHRcdFx0XHRcdGNvbnNvbGUubG9nKCd1cGRhdGVFbnRyeUluUGFsZXR0ZTogRW50cnkgbm90IGZvdW5kLicpO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBvbGRFbnRyeSA9IGl0ZW1zW2VudHJ5SW5kZXhdO1xuXHRcdFx0aXRlbXNbZW50cnlJbmRleF0gPSBuZXdFbnRyeTtcblxuXHRcdFx0YXdhaXQgdGhpcy5zYXZlRGF0YSgndGFibGVzJywgdGFibGVJRCwgc3RvcmVkUGFsZXR0ZSk7XG5cdFx0XHRhd2FpdCB0aGlzLmxvZ011dGF0aW9uKHtcblx0XHRcdFx0dGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG5cdFx0XHRcdGtleTogYCR7dGFibGVJRH0tJHtlbnRyeUluZGV4fV1gLFxuXHRcdFx0XHRhY3Rpb246ICd1cGRhdGUnLFxuXHRcdFx0XHRuZXdWYWx1ZTogbmV3RW50cnksXG5cdFx0XHRcdG9sZFZhbHVlOiBvbGRFbnRyeSxcblx0XHRcdFx0b3JpZ2luOiAndXBkYXRlRW50cnlJblBhbGV0dGUnXG5cdFx0XHR9KTtcblxuXHRcdFx0aWYgKCF0aGlzLm1vZGUucXVpZXQpXG5cdFx0XHRcdGNvbnNvbGUubG9nKFxuXHRcdFx0XHRcdGBFbnRyeSAke2VudHJ5SW5kZXh9IGluIHBhbGV0dGUgJHt0YWJsZUlEfSB1cGRhdGVkLmBcblx0XHRcdFx0KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0aWYgKHRoaXMubW9kZS5sb2dFcnJvcnMpXG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byB1cGRhdGUgZW50cnkgaW4gcGFsZXR0ZTogJHtlcnJvcn1gKTtcblxuXHRcdFx0dGhyb3cgZXJyb3I7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHJlbmRlclBhbGV0dGUodGFibGVJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHN0b3JlZFBhbGV0dGUgPSBhd2FpdCB0aGlzLmdldFRhYmxlKHRhYmxlSWQpO1xuXHRcdFx0Y29uc3QgcGFsZXR0ZVJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYWxldHRlLXJvdycpO1xuXG5cdFx0XHRpZiAoIXN0b3JlZFBhbGV0dGUpXG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihgUGFsZXR0ZSAke3RhYmxlSWR9IG5vdCBmb3VuZC5gKTtcblx0XHRcdGlmICghcGFsZXR0ZVJvdykgdGhyb3cgbmV3IEVycm9yKCdQYWxldHRlIHJvdyBlbGVtZW50IG5vdCBmb3VuZC4nKTtcblxuXHRcdFx0cGFsZXR0ZVJvdy5pbm5lckhUTUwgPSAnJztcblxuXHRcdFx0Y29uc3QgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG5cdFx0XHRjb25zdCB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7XG5cdFx0XHR0YWJsZS5jbGFzc0xpc3QuYWRkKCdwYWxldHRlLXRhYmxlJyk7XG5cblx0XHRcdHN0b3JlZFBhbGV0dGUucGFsZXR0ZS5pdGVtcy5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuXHRcdFx0XHRjb25zdCByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpO1xuXHRcdFx0XHRjb25zdCBjZWxsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTtcblx0XHRcdFx0Y29uc3QgY29sb3JCb3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblxuXHRcdFx0XHRjZWxsLnRleHRDb250ZW50ID0gYENvbG9yICR7aW5kZXggKyAxfWA7XG5cdFx0XHRcdGNvbG9yQm94LmNsYXNzTGlzdC5hZGQoJ2NvbG9yLWJveCcpO1xuXHRcdFx0XHRjb2xvckJveC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBpdGVtLmNzc1N0cmluZ3MuaGV4Q1NTU3RyaW5nO1xuXG5cdFx0XHRcdHJvdy5hcHBlbmRDaGlsZChjb2xvckJveCk7XG5cdFx0XHRcdHJvdy5hcHBlbmRDaGlsZChjZWxsKTtcblx0XHRcdFx0dGFibGUuYXBwZW5kQ2hpbGQocm93KTtcblx0XHRcdH0pO1xuXG5cdFx0XHRmcmFnbWVudC5hcHBlbmRDaGlsZCh0YWJsZSk7XG5cdFx0XHRwYWxldHRlUm93LmFwcGVuZENoaWxkKGZyYWdtZW50KTtcblxuXHRcdFx0aWYgKCF0aGlzLm1vZGUucXVpZXQpIGNvbnNvbGUubG9nKGBSZW5kZXJlZCBwYWxldHRlICR7dGFibGVJZH0uYCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGlmICh0aGlzLm1vZGUubG9nRXJyb3JzKVxuXHRcdFx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gcmVuZGVyIHBhbGV0dGU6ICR7ZXJyb3J9YCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHNhdmVEYXRhPFQ+KFxuXHRcdHN0b3JlTmFtZToga2V5b2YgUGFsZXR0ZVNjaGVtYSxcblx0XHRrZXk6IHN0cmluZyxcblx0XHRkYXRhOiBULFxuXHRcdG9sZFZhbHVlPzogVFxuXHQpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgZGIgPSBhd2FpdCB0aGlzLmdldERCKCk7XG5cdFx0XHRjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgJ3JlYWR3cml0ZScpO1xuXHRcdFx0Y29uc3Qgc3RvcmUgPSB0eC5vYmplY3RTdG9yZShzdG9yZU5hbWUpO1xuXG5cdFx0XHRhd2FpdCBzdG9yZS5wdXQoeyBrZXksIC4uLmRhdGEgfSk7XG5cdFx0XHRhd2FpdCB0eC5kb25lO1xuXG5cdFx0XHRjb25zb2xlLmxvZyhgJHtrZXl9IHNhdmVkIHRvICR7c3RvcmVOYW1lfS5gKTtcblxuXHRcdFx0YXdhaXQgdGhpcy5sb2dNdXRhdGlvbih7XG5cdFx0XHRcdHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuXHRcdFx0XHRrZXksXG5cdFx0XHRcdGFjdGlvbjogJ3VwZGF0ZScsXG5cdFx0XHRcdG5ld1ZhbHVlOiBkYXRhLFxuXHRcdFx0XHRvbGRWYWx1ZTogb2xkVmFsdWUgPyBvbGRWYWx1ZSA6IG51bGwsXG5cdFx0XHRcdG9yaWdpbjogJ3NhdmVEYXRhJ1xuXHRcdFx0fSk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGlmICh0aGlzLm1vZGUubG9nRXJyb3JzKVxuXHRcdFx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gc2F2ZSBkYXRhIHRvICR7c3RvcmVOYW1lfTpgLCBlcnJvcik7XG5cblx0XHRcdHRocm93IGVycm9yO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzYXZlUGFsZXR0ZShcblx0XHRpZDogc3RyaW5nLFxuXHRcdG5ld1BhbGV0dGU6IFN0b3JlZFBhbGV0dGVcblx0KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHN0b3JlID0gYXdhaXQgdGhpcy5nZXRTdG9yZSgndGFibGVzJywgJ3JlYWR3cml0ZScpO1xuXHRcdFx0Y29uc3QgcGFsZXR0ZVRvU2F2ZTogU3RvcmVkUGFsZXR0ZSA9IHtcblx0XHRcdFx0dGFibGVJRDogbmV3UGFsZXR0ZS50YWJsZUlELFxuXHRcdFx0XHRwYWxldHRlOiBuZXdQYWxldHRlLnBhbGV0dGVcblx0XHRcdH07XG5cblx0XHRcdGF3YWl0IHN0b3JlLnB1dCh7IGtleTogaWQsIC4uLnBhbGV0dGVUb1NhdmUgfSk7XG5cblx0XHRcdGlmICghdGhpcy5tb2RlLnF1aWV0KVxuXHRcdFx0XHRjb25zb2xlLmxvZyhgUGFsZXR0ZSAke2lkfSBzYXZlZCBzdWNjZXNzZnVsbHkuYCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGlmICh0aGlzLm1vZGUubG9nRXJyb3JzKVxuXHRcdFx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gc2F2ZSBwYWxldHRlICR7aWR9OiAke2Vycm9yfWApO1xuXG5cdFx0XHR0aHJvdyBlcnJvcjtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2F2ZVBhbGV0dGVUb0RCKFxuXHRcdHR5cGU6IHN0cmluZyxcblx0XHRpdGVtczogUGFsZXR0ZUl0ZW1bXSxcblx0XHRiYXNlQ29sb3I6IEhTTCxcblx0XHRudW1Cb3hlczogbnVtYmVyLFxuXHRcdGVuYWJsZUFscGhhOiBib29sZWFuLFxuXHRcdGxpbWl0RGFyazogYm9vbGVhbixcblx0XHRsaW1pdEdyYXk6IGJvb2xlYW4sXG5cdFx0bGltaXRMaWdodDogYm9vbGVhblxuXHQpOiBQcm9taXNlPFBhbGV0dGU+IHtcblx0XHRjb25zdCBwYWxldHRlSUQgPSBhd2FpdCB0aGlzLmdldE5leHRQYWxldHRlSUQoKTtcblxuXHRcdGNvbnN0IG5ld1BhbGV0dGUgPSB1dGlscy5wYWxldHRlLmNyZWF0ZU9iamVjdChcblx0XHRcdHR5cGUsXG5cdFx0XHRpdGVtcyxcblx0XHRcdGJhc2VDb2xvcixcblx0XHRcdHBhbGV0dGVJRCxcblx0XHRcdG51bUJveGVzLFxuXHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRsaW1pdERhcmssXG5cdFx0XHRsaW1pdEdyYXksXG5cdFx0XHRsaW1pdExpZ2h0XG5cdFx0KTtcblxuXHRcdGF3YWl0IHRoaXMuc2F2ZVBhbGV0dGUobmV3UGFsZXR0ZS5pZCwge1xuXHRcdFx0dGFibGVJRDogcGFyc2VJbnQobmV3UGFsZXR0ZS5pZC5zcGxpdCgnXycpWzFdKSxcblx0XHRcdHBhbGV0dGU6IG5ld1BhbGV0dGVcblx0XHR9KTtcblxuXHRcdGlmICghdGhpcy5tb2RlLnF1aWV0KVxuXHRcdFx0Y29uc29sZS5sb2coYFNhdmVkICR7dHlwZX0gcGFsZXR0ZTogJHtKU09OLnN0cmluZ2lmeShuZXdQYWxldHRlKX1gKTtcblxuXHRcdHJldHVybiBuZXdQYWxldHRlO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHNhdmVTZXR0aW5ncyhuZXdTZXR0aW5nczogU2V0dGluZ3MpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0YXdhaXQgdGhpcy5zYXZlRGF0YSgnc2V0dGluZ3MnLCAnYXBwU2V0dGluZ3MnLCBuZXdTZXR0aW5ncyk7XG5cblx0XHRcdGlmICghdGhpcy5tb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnU2V0dGluZ3MgdXBkYXRlZCcpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRpZiAodGhpcy5tb2RlLmxvZ0Vycm9ycylcblx0XHRcdFx0Y29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHNhdmUgc2V0dGluZ3M6ICR7ZXJyb3J9YCk7XG5cblx0XHRcdHRocm93IGVycm9yO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyB0cmFja2VkVHJhbnNhY3Rpb248U3RvcmVOYW1lIGV4dGVuZHMga2V5b2YgUGFsZXR0ZVNjaGVtYT4oXG5cdFx0c3RvcmVOYW1lOiBTdG9yZU5hbWUsXG5cdFx0bW9kZTogJ3JlYWRvbmx5JyB8ICdyZWFkd3JpdGUnLFxuXHRcdGNhbGxiYWNrOiAoXG5cdFx0XHRzdG9yZTogSURCUE9iamVjdFN0b3JlPFxuXHRcdFx0XHRQYWxldHRlU2NoZW1hLFxuXHRcdFx0XHRbU3RvcmVOYW1lXSxcblx0XHRcdFx0U3RvcmVOYW1lLFxuXHRcdFx0XHQncmVhZG9ubHknIHwgJ3JlYWR3cml0ZSdcblx0XHRcdD5cblx0XHQpID0+IFByb21pc2U8dm9pZD5cblx0KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgZGIgPSBhd2FpdCB0aGlzLmdldERCKCk7XG5cdFx0Y29uc3QgdHggPSBkYi50cmFuc2FjdGlvbihzdG9yZU5hbWUsIG1vZGUpO1xuXHRcdGNvbnN0IHN0b3JlID0gdHgub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcblxuXHRcdHRyeSB7XG5cdFx0XHRhd2FpdCBjYWxsYmFjayhzdG9yZSk7XG5cdFx0XHRhd2FpdCB0eC5kb25lO1xuXG5cdFx0XHRpZiAoIXRoaXMubW9kZS5xdWlldClcblx0XHRcdFx0Y29uc29sZS5sb2coYFRyYW5zYWN0aW9uIG9uICR7c3RvcmVOYW1lfSBjb21wbGV0ZWQuYCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGlmICh0aGlzLm1vZGUubG9nRXJyb3JzKVxuXHRcdFx0XHRjb25zb2xlLmVycm9yKGBUcmFuc2FjdGlvbiBvbiAke3N0b3JlTmFtZX0gZmFpbGVkOiAke2Vycm9yfWApO1xuXG5cdFx0XHR0aHJvdyBlcnJvcjtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGdldEN1cnJlbnRQYWxldHRlSUQoKTogUHJvbWlzZTxudW1iZXI+IHtcblx0XHRjb25zdCBkYiA9IGF3YWl0IHRoaXMuZ2V0REIoKTtcblx0XHRjb25zdCBzZXR0aW5ncyA9IGF3YWl0IGRiLmdldCgnc2V0dGluZ3MnLCAnYXBwU2V0dGluZ3MnKTtcblxuXHRcdHJldHVybiBzZXR0aW5ncz8ubGFzdFBhbGV0dGVJRCA/PyAwO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBnZXREQigpOiBQcm9taXNlPFBhbGV0dGVEQj4ge1xuXHRcdHJldHVybiB0aGlzLmRiUHJvbWlzZTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgZ2V0TmV4dFBhbGV0dGVJRCgpOiBQcm9taXNlPG51bWJlcj4ge1xuXHRcdGNvbnN0IGN1cnJlbnRJRCA9IGF3YWl0IHRoaXMuZ2V0Q3VycmVudFBhbGV0dGVJRCgpO1xuXHRcdGNvbnN0IG5ld0lEID0gY3VycmVudElEICsgMTtcblxuXHRcdGF3YWl0IHRoaXMudXBkYXRlQ3VycmVudFBhbGV0dGVJRChuZXdJRCk7XG5cblx0XHRyZXR1cm4gbmV3SUQ7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGdldFRhYmxlKGlkOiBzdHJpbmcpOiBQcm9taXNlPFN0b3JlZFBhbGV0dGUgfCBudWxsPiB7XG5cdFx0Y29uc3QgZGIgPSBhd2FpdCB0aGlzLmdldERCKCk7XG5cdFx0Y29uc3QgcmVzdWx0ID0gYXdhaXQgZGIuZ2V0KCd0YWJsZXMnLCBpZCk7XG5cblx0XHRpZiAoIXJlc3VsdCkge1xuXHRcdFx0aWYgKHRoaXMubW9kZS5sb2dFcnJvcnMpXG5cdFx0XHRcdGNvbnNvbGUud2FybihgVGFibGUgd2l0aCBJRCAke2lkfSBub3QgZm91bmQuYCk7XG5cdFx0fVxuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIHVwZGF0ZUN1cnJlbnRQYWxldHRlSUQobmV3SUQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IGRiID0gYXdhaXQgdGhpcy5nZXREQigpO1xuXHRcdGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3NldHRpbmdzJywgJ3JlYWR3cml0ZScpO1xuXHRcdGNvbnN0IHN0b3JlID0gdHgub2JqZWN0U3RvcmUoJ3NldHRpbmdzJyk7XG5cblx0XHRhd2FpdCBzdG9yZS5wdXQoeyBrZXk6ICdhcHBTZXR0aW5ncycsIGxhc3RQYWxldHRlSUQ6IG5ld0lEIH0pO1xuXHRcdGF3YWl0IHR4LmRvbmU7XG5cblx0XHRpZiAoIXRoaXMubW9kZS5xdWlldClcblx0XHRcdGNvbnNvbGUubG9nKGBDdXJyZW50IHBhbGV0dGUgSUQgdXBkYXRlZCB0byAke25ld0lEfWApO1xuXHR9XG59XG4iXX0=