// File: src/idb/main.ts
import { openDB } from 'idb';
import { utils } from '../common.js';
import { config } from '../config.js';
const defaultSettings = config.defaults.idb.settings;
function createMutationLogger(obj, key) {
    return new Proxy(obj, {
        set(target, property, value) {
            const oldValue = target[property];
            const success = Reflect.set(target, property, value);
            if (success) {
                logMutation({
                    timestamp: new Date().toISOString(),
                    key,
                    action: 'update',
                    newValue: { [property]: value },
                    oldValue: { [property]: oldValue },
                    origin: 'Proxy'
                });
            }
            return success;
        }
    });
}
const dbPromise = openDB('paletteDatabase', 1, {
    upgrade(db) {
        try {
            const stores = [
                'customColor',
                'mutations',
                'settings',
                'tables'
            ];
            stores.forEach(store => {
                if (!db.objectStoreNames.contains(store)) {
                    db.createObjectStore(store, {
                        keyPath: store === 'mutations' ? 'timestamp' : 'key'
                    });
                }
            });
        }
        catch (error) {
            console.error('Error during IndexedDB upgrade:', error);
            throw error;
        }
    }
});
async function getDB() {
    return dbPromise;
}
async function getCurrentPaletteID() {
    const db = await getDB();
    const settings = await db.get('settings', 'appSettings');
    return settings?.lastPaletteID ?? 0;
}
async function getCustomColor() {
    const db = await getDB();
    const entry = await db.get('customColor', 'customColor');
    return entry?.color
        ? createMutationLogger(entry.color, 'customColor')
        : null;
}
function getLoggedObject(obj, key) {
    if (obj) {
        return createMutationLogger(obj, key);
    }
    return null;
}
async function getNextPaletteID() {
    const currentID = await getCurrentPaletteID();
    const newID = currentID + 1;
    await updateCurrentPaletteID(newID);
    return newID;
}
async function getNextTableID() {
    const settings = await getSettings();
    const nextID = settings.lastTableID + 1;
    await saveData('settings', 'appSettings', {
        ...settings,
        lastTableID: nextID
    });
    return `palette_${nextID}`;
}
async function getSettings() {
    try {
        const db = await getDB();
        const settings = await db.get('settings', 'appSettings');
        return settings ?? defaultSettings;
    }
    catch (error) {
        console.error('Error fetching settings:', error);
        return { colorSpace: 'hex', lastTableID: 0 };
    }
}
async function getTable(id) {
    const db = await getDB();
    const result = await db.get('tables', id);
    if (!result)
        console.warn(`Table with ID ${id} not found.`);
    return result;
}
async function getStore(storeName, mode) {
    const db = await getDB();
    return db.transaction(storeName, mode).objectStore(storeName);
}
async function logMutation(log) {
    const db = await getDB();
    await db.put('mutations', log);
    console.log(`Logged mutation: ${JSON.stringify(log)}`);
}
async function renderPalette(tableId) {
    try {
        const storedPalette = await getTable(tableId);
        const paletteRow = document.getElementById('palette-row');
        if (!storedPalette)
            throw new Error(`Palette ${tableId} not found.`);
        if (!paletteRow)
            throw new Error('Palette row element not found.');
        paletteRow.innerHTML = '';
        const fragment = document.createDocumentFragment();
        const table = document.createElement('table');
        table.classList.add('palette-table');
        storedPalette.palette.items.forEach((item, index) => {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            const colorBox = document.createElement('div');
            cell.textContent = `Color ${index + 1}`;
            colorBox.classList.add('color-box');
            colorBox.style.backgroundColor = item.cssStrings.hexCSSString;
            row.appendChild(colorBox);
            row.appendChild(cell);
            table.appendChild(row);
        });
        fragment.appendChild(table);
        paletteRow.appendChild(fragment);
        console.log(`Rendered palette ${tableId}.`);
    }
    catch (error) {
        console.error(`Failed to render palette: ${error}`);
    }
}
async function saveData(storeName, key, data, oldValue) {
    try {
        const db = await getDB();
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        await store.put({ key, ...data });
        await tx.done;
        console.log(`${key} saved to ${storeName}.`);
        await logMutation({
            timestamp: new Date().toISOString(),
            key,
            action: 'update',
            newValue: data,
            oldValue: oldValue ? oldValue : null,
            origin: 'saveData'
        });
    }
    catch (error) {
        console.error(`Failed to save data to ${storeName}:`, error);
        throw error;
    }
}
async function savePalette(id, newPalette) {
    try {
        const store = await getStore('tables', 'readwrite');
        const paletteToSave = {
            tableID: newPalette.tableID,
            palette: newPalette.palette
        };
        await store.put({ key: id, ...paletteToSave });
        console.log(`Palette ${id} saved successfully.`);
    }
    catch (error) {
        console.error(`Failed to save palette ${id}: ${error}`);
        throw error;
    }
}
async function savePaletteToDB(type, items, baseColor, numBoxes, enableAlpha, limitBright, limitDark, limitGray) {
    const paletteID = await getNextPaletteID();
    const newPalette = utils.palette.createObject(type, items, baseColor, paletteID, numBoxes, enableAlpha, limitBright, limitDark, limitGray);
    await savePalette(newPalette.id, {
        tableID: parseInt(newPalette.id.split('_')[1]),
        palette: newPalette
    });
    console.log(`Saved ${type} palette: ${JSON.stringify(newPalette)}`);
    return newPalette;
}
async function saveSettings(newSettings) {
    try {
        await saveData('settings', 'appSettings', newSettings);
        console.log('Settings updated');
    }
    catch (error) {
        console.error(`Failed to save settings: ${error}`);
        throw error;
    }
}
async function trackedTransaction(storeName, mode, callback) {
    const db = await getDB();
    const tx = db.transaction(storeName, mode);
    const store = tx.objectStore(storeName);
    try {
        await callback(store);
        await tx.done;
        console.log(`Transaction on ${storeName} completed.`);
    }
    catch (error) {
        console.error(`Transaction on ${storeName} failed: ${error}`);
        throw error;
    }
}
async function updateCurrentPaletteID(newID) {
    const db = await getDB();
    const tx = db.transaction('settings', 'readwrite');
    const store = tx.objectStore('settings');
    await store.put({ key: 'appSettings', lastPaletteID: newID });
    await tx.done;
    console.log(`Current palette ID updated to ${newID}`);
}
async function updateEntryInPalette(tableID, entryIndex, newEntry) {
    try {
        const storedPalette = await getTable(tableID);
        if (!storedPalette)
            throw new Error(`Palette ${tableID} not found.`);
        const { items } = storedPalette.palette;
        if (entryIndex >= items.length)
            throw new Error(`Entry ${entryIndex} not found in palette ${tableID}.`);
        const oldEntry = items[entryIndex];
        items[entryIndex] = newEntry;
        await saveData('tables', tableID, storedPalette);
        await logMutation({
            timestamp: new Date().toISOString(),
            key: `${tableID}-${entryIndex}]`,
            action: 'update',
            newValue: newEntry,
            oldValue: oldEntry,
            origin: 'updateEntryInPalette'
        });
        console.log(`Entry ${entryIndex} in palette ${tableID} updated.`);
    }
    catch (error) {
        console.error(`Failed to update entry in palette: ${error}`);
        throw error;
    }
}
export const idb = {
    createMutationLogger,
    deleteTable: async (id) => {
        const db = await getDB();
        await db.delete('tables', id);
        console.log(`Table ${id} deleted.`);
    },
    getCurrentPaletteID,
    getCustomColor,
    getDB,
    getLoggedObject,
    getNextPaletteID,
    getNextTableID,
    getSettings,
    getStore,
    getTable,
    listTables: async () => {
        const db = await getDB();
        const keys = await db.getAllKeys('tables');
        return keys.map(String);
    },
    logMutation,
    renderPalette,
    saveData,
    savePalette,
    savePaletteToDB,
    saveSettings,
    trackedTransaction,
    updateCurrentPaletteID,
    updateEntryInPalette
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pZGIvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx3QkFBd0I7QUFFeEIsT0FBTyxFQUFtQixNQUFNLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFXOUMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNsQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRW5DLE1BQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQztBQUVyRCxTQUFTLG9CQUFvQixDQUFtQixHQUFNLEVBQUUsR0FBVztJQUNsRSxPQUFPLElBQUksS0FBSyxDQUFDLEdBQUcsRUFBRTtRQUNyQixHQUFHLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLO1lBQzFCLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFtQixDQUFDLENBQUM7WUFDN0MsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRXJELElBQUksT0FBTyxFQUFFLENBQUM7Z0JBQ2IsV0FBVyxDQUFDO29CQUNYLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtvQkFDbkMsR0FBRztvQkFDSCxNQUFNLEVBQUUsUUFBUTtvQkFDaEIsUUFBUSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLEVBQUU7b0JBQy9CLFFBQVEsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsUUFBUSxFQUFFO29CQUNsQyxNQUFNLEVBQUUsT0FBTztpQkFDZixDQUFDLENBQUM7WUFDSixDQUFDO1lBRUQsT0FBTyxPQUFPLENBQUM7UUFDaEIsQ0FBQztLQUNELENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRCxNQUFNLFNBQVMsR0FBdUIsTUFBTSxDQUMzQyxpQkFBaUIsRUFDakIsQ0FBQyxFQUNEO0lBQ0MsT0FBTyxDQUFDLEVBQUU7UUFDVCxJQUFJLENBQUM7WUFDSixNQUFNLE1BQU0sR0FBRztnQkFDZCxhQUFhO2dCQUNiLFdBQVc7Z0JBQ1gsVUFBVTtnQkFDVixRQUFRO2FBQ1IsQ0FBQztZQUVGLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7b0JBQzFDLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUU7d0JBQzNCLE9BQU8sRUFBRSxLQUFLLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUs7cUJBQ3BELENBQUMsQ0FBQztnQkFDSixDQUFDO1lBQ0YsQ0FBQyxDQUFDLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRXhELE1BQU0sS0FBSyxDQUFDO1FBQ2IsQ0FBQztJQUNGLENBQUM7Q0FDRCxDQUNELENBQUM7QUFFRixLQUFLLFVBQVUsS0FBSztJQUNuQixPQUFPLFNBQVMsQ0FBQztBQUNsQixDQUFDO0FBRUQsS0FBSyxVQUFVLG1CQUFtQjtJQUNqQyxNQUFNLEVBQUUsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO0lBQ3pCLE1BQU0sUUFBUSxHQUFHLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFFekQsT0FBTyxRQUFRLEVBQUUsYUFBYSxJQUFJLENBQUMsQ0FBQztBQUNyQyxDQUFDO0FBRUQsS0FBSyxVQUFVLGNBQWM7SUFDNUIsTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztJQUN6QixNQUFNLEtBQUssR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBRXpELE9BQU8sS0FBSyxFQUFFLEtBQUs7UUFDbEIsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsYUFBYSxDQUFDO1FBQ2xELENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDVCxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQ3ZCLEdBQWEsRUFDYixHQUFXO0lBRVgsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNULE9BQU8sb0JBQW9CLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxPQUFPLElBQUksQ0FBQztBQUNiLENBQUM7QUFFRCxLQUFLLFVBQVUsZ0JBQWdCO0lBQzlCLE1BQU0sU0FBUyxHQUFHLE1BQU0sbUJBQW1CLEVBQUUsQ0FBQztJQUM5QyxNQUFNLEtBQUssR0FBRyxTQUFTLEdBQUcsQ0FBQyxDQUFDO0lBRTVCLE1BQU0sc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFcEMsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDO0FBRUQsS0FBSyxVQUFVLGNBQWM7SUFDNUIsTUFBTSxRQUFRLEdBQUcsTUFBTSxXQUFXLEVBQUUsQ0FBQztJQUNyQyxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztJQUV4QyxNQUFNLFFBQVEsQ0FBQyxVQUFVLEVBQUUsYUFBYSxFQUFFO1FBQ3pDLEdBQUcsUUFBUTtRQUNYLFdBQVcsRUFBRSxNQUFNO0tBQ25CLENBQUMsQ0FBQztJQUVILE9BQU8sV0FBVyxNQUFNLEVBQUUsQ0FBQztBQUM1QixDQUFDO0FBRUQsS0FBSyxVQUFVLFdBQVc7SUFDekIsSUFBSSxDQUFDO1FBQ0osTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztRQUN6QixNQUFNLFFBQVEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRXpELE9BQU8sUUFBUSxJQUFJLGVBQWUsQ0FBQztJQUNwQyxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLDBCQUEwQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRWpELE9BQU8sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxDQUFDLEVBQUUsQ0FBQztJQUM5QyxDQUFDO0FBQ0YsQ0FBQztBQUVELEtBQUssVUFBVSxRQUFRLENBQUMsRUFBVTtJQUNqQyxNQUFNLEVBQUUsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO0lBQ3pCLE1BQU0sTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFMUMsSUFBSSxDQUFDLE1BQU07UUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQzVELE9BQU8sTUFBTSxDQUFDO0FBQ2YsQ0FBQztBQVlELEtBQUssVUFBVSxRQUFRLENBQ3RCLFNBQW9CLEVBQ3BCLElBQThCO0lBRTlCLE1BQU0sRUFBRSxHQUFHLE1BQU0sS0FBSyxFQUFFLENBQUM7SUFFekIsT0FBTyxFQUFFLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0QsQ0FBQztBQUVELEtBQUssVUFBVSxXQUFXLENBQUMsR0FBZ0I7SUFDMUMsTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztJQUV6QixNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBRS9CLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3hELENBQUM7QUFFRCxLQUFLLFVBQVUsYUFBYSxDQUFDLE9BQWU7SUFDM0MsSUFBSSxDQUFDO1FBQ0osTUFBTSxhQUFhLEdBQUcsTUFBTSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUMsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUUxRCxJQUFJLENBQUMsYUFBYTtZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsV0FBVyxPQUFPLGFBQWEsQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxVQUFVO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBRW5FLFVBQVUsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBRTFCLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBQ25ELE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFckMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ25ELE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekMsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMxQyxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRS9DLElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDeEMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDcEMsUUFBUSxDQUFDLEtBQUssQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUM7WUFFOUQsR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMxQixHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3RCLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxRQUFRLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVCLFVBQVUsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFakMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsT0FBTyxHQUFHLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLDZCQUE2QixLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ3JELENBQUM7QUFDRixDQUFDO0FBRUQsS0FBSyxVQUFVLFFBQVEsQ0FDdEIsU0FBOEIsRUFDOUIsR0FBVyxFQUNYLElBQU8sRUFDUCxRQUFZO0lBRVosSUFBSSxDQUFDO1FBQ0osTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztRQUN6QixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNsRCxNQUFNLEtBQUssR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXhDLE1BQU0sS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxDQUFDLENBQUM7UUFDbEMsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDO1FBRWQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsYUFBYSxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBRTdDLE1BQU0sV0FBVyxDQUFDO1lBQ2pCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtZQUNuQyxHQUFHO1lBQ0gsTUFBTSxFQUFFLFFBQVE7WUFDaEIsUUFBUSxFQUFFLElBQUk7WUFDZCxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUk7WUFDcEMsTUFBTSxFQUFFLFVBQVU7U0FDbEIsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDaEIsT0FBTyxDQUFDLEtBQUssQ0FBQywwQkFBMEIsU0FBUyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFN0QsTUFBTSxLQUFLLENBQUM7SUFDYixDQUFDO0FBQ0YsQ0FBQztBQUVELEtBQUssVUFBVSxXQUFXLENBQ3pCLEVBQVUsRUFDVixVQUF5QjtJQUV6QixJQUFJLENBQUM7UUFDSixNQUFNLEtBQUssR0FBRyxNQUFNLFFBQVEsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDcEQsTUFBTSxhQUFhLEdBQWtCO1lBQ3BDLE9BQU8sRUFBRSxVQUFVLENBQUMsT0FBTztZQUMzQixPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU87U0FDM0IsQ0FBQztRQUVGLE1BQU0sS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxhQUFhLEVBQUUsQ0FBQyxDQUFDO1FBRS9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLHNCQUFzQixDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDaEIsT0FBTyxDQUFDLEtBQUssQ0FBQywwQkFBMEIsRUFBRSxLQUFLLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDeEQsTUFBTSxLQUFLLENBQUM7SUFDYixDQUFDO0FBQ0YsQ0FBQztBQUVELEtBQUssVUFBVSxlQUFlLENBQzdCLElBQVksRUFDWixLQUFvQixFQUNwQixTQUFjLEVBQ2QsUUFBZ0IsRUFDaEIsV0FBb0IsRUFDcEIsV0FBb0IsRUFDcEIsU0FBa0IsRUFDbEIsU0FBa0I7SUFFbEIsTUFBTSxTQUFTLEdBQUcsTUFBTSxnQkFBZ0IsRUFBRSxDQUFDO0lBRTNDLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUM1QyxJQUFJLEVBQ0osS0FBSyxFQUNMLFNBQVMsRUFDVCxTQUFTLEVBQ1QsUUFBUSxFQUNSLFdBQVcsRUFDWCxXQUFXLEVBQ1gsU0FBUyxFQUNULFNBQVMsQ0FDVCxDQUFDO0lBRUYsTUFBTSxXQUFXLENBQUMsVUFBVSxDQUFDLEVBQUUsRUFBRTtRQUNoQyxPQUFPLEVBQUUsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlDLE9BQU8sRUFBRSxVQUFVO0tBQ25CLENBQUMsQ0FBQztJQUVILE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLGFBQWEsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFcEUsT0FBTyxVQUFVLENBQUM7QUFDbkIsQ0FBQztBQUVELEtBQUssVUFBVSxZQUFZLENBQUMsV0FBcUI7SUFDaEQsSUFBSSxDQUFDO1FBQ0osTUFBTSxRQUFRLENBQUMsVUFBVSxFQUFFLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUV2RCxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDakMsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDaEIsT0FBTyxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUVuRCxNQUFNLEtBQUssQ0FBQztJQUNiLENBQUM7QUFDRixDQUFDO0FBRUQsS0FBSyxVQUFVLGtCQUFrQixDQUNoQyxTQUFvQixFQUNwQixJQUE4QixFQUM5QixRQU9rQjtJQUVsQixNQUFNLEVBQUUsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO0lBQ3pCLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzNDLE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7SUFFeEMsSUFBSSxDQUFDO1FBQ0osTUFBTSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEIsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDO1FBRWQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsU0FBUyxhQUFhLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixTQUFTLFlBQVksS0FBSyxFQUFFLENBQUMsQ0FBQztRQUU5RCxNQUFNLEtBQUssQ0FBQztJQUNiLENBQUM7QUFDRixDQUFDO0FBRUQsS0FBSyxVQUFVLHNCQUFzQixDQUFDLEtBQWE7SUFDbEQsTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztJQUN6QixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNuRCxNQUFNLEtBQUssR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRXpDLE1BQU0sS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDOUQsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDO0lBRWQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsS0FBSyxFQUFFLENBQUMsQ0FBQztBQUN2RCxDQUFDO0FBRUQsS0FBSyxVQUFVLG9CQUFvQixDQUNsQyxPQUFlLEVBQ2YsVUFBa0IsRUFDbEIsUUFBcUI7SUFFckIsSUFBSSxDQUFDO1FBQ0osTUFBTSxhQUFhLEdBQUcsTUFBTSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFOUMsSUFBSSxDQUFDLGFBQWE7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsT0FBTyxhQUFhLENBQUMsQ0FBQztRQUVyRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQztRQUV4QyxJQUFJLFVBQVUsSUFBSSxLQUFLLENBQUMsTUFBTTtZQUM3QixNQUFNLElBQUksS0FBSyxDQUNkLFNBQVMsVUFBVSx5QkFBeUIsT0FBTyxHQUFHLENBQ3RELENBQUM7UUFFSCxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDbkMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUU3QixNQUFNLFFBQVEsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQ2pELE1BQU0sV0FBVyxDQUFDO1lBQ2pCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtZQUNuQyxHQUFHLEVBQUUsR0FBRyxPQUFPLElBQUksVUFBVSxHQUFHO1lBQ2hDLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLFFBQVEsRUFBRSxRQUFRO1lBQ2xCLFFBQVEsRUFBRSxRQUFRO1lBQ2xCLE1BQU0sRUFBRSxzQkFBc0I7U0FDOUIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLFVBQVUsZUFBZSxPQUFPLFdBQVcsQ0FBQyxDQUFDO0lBQ25FLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2hCLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0NBQXNDLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFN0QsTUFBTSxLQUFLLENBQUM7SUFDYixDQUFDO0FBQ0YsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLEdBQUcsR0FBRztJQUNsQixvQkFBb0I7SUFDcEIsV0FBVyxFQUFFLEtBQUssRUFBRSxFQUFVLEVBQUUsRUFBRTtRQUNqQyxNQUFNLEVBQUUsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO1FBQ3pCLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUNELG1CQUFtQjtJQUNuQixjQUFjO0lBQ2QsS0FBSztJQUNMLGVBQWU7SUFDZixnQkFBZ0I7SUFDaEIsY0FBYztJQUNkLFdBQVc7SUFDWCxRQUFRO0lBQ1IsUUFBUTtJQUNSLFVBQVUsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN0QixNQUFNLEVBQUUsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO1FBQ3pCLE1BQU0sSUFBSSxHQUFHLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUNELFdBQVc7SUFDWCxhQUFhO0lBQ2IsUUFBUTtJQUNSLFdBQVc7SUFDWCxlQUFlO0lBQ2YsWUFBWTtJQUNaLGtCQUFrQjtJQUNsQixzQkFBc0I7SUFDdEIsb0JBQW9CO0NBQ3BCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBGaWxlOiBzcmMvaWRiL21haW4udHNcblxuaW1wb3J0IHsgSURCUE9iamVjdFN0b3JlLCBvcGVuREIgfSBmcm9tICdpZGInO1xuaW1wb3J0IHtcblx0SFNMLFxuXHRNdXRhdGlvbkxvZyxcblx0UGFsZXR0ZSxcblx0UGFsZXR0ZURCLFxuXHRQYWxldHRlSXRlbSxcblx0UGFsZXR0ZVNjaGVtYSxcblx0U2V0dGluZ3MsXG5cdFN0b3JlZFBhbGV0dGVcbn0gZnJvbSAnLi4vaW5kZXgvaW5kZXgnO1xuaW1wb3J0IHsgdXRpbHMgfSBmcm9tICcuLi9jb21tb24nO1xuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSAnLi4vY29uZmlnJztcblxuY29uc3QgZGVmYXVsdFNldHRpbmdzID0gY29uZmlnLmRlZmF1bHRzLmlkYi5zZXR0aW5ncztcblxuZnVuY3Rpb24gY3JlYXRlTXV0YXRpb25Mb2dnZXI8VCBleHRlbmRzIG9iamVjdD4ob2JqOiBULCBrZXk6IHN0cmluZyk6IFQge1xuXHRyZXR1cm4gbmV3IFByb3h5KG9iaiwge1xuXHRcdHNldCh0YXJnZXQsIHByb3BlcnR5LCB2YWx1ZSkge1xuXHRcdFx0Y29uc3Qgb2xkVmFsdWUgPSB0YXJnZXRbcHJvcGVydHkgYXMga2V5b2YgVF07XG5cdFx0XHRjb25zdCBzdWNjZXNzID0gUmVmbGVjdC5zZXQodGFyZ2V0LCBwcm9wZXJ0eSwgdmFsdWUpO1xuXG5cdFx0XHRpZiAoc3VjY2Vzcykge1xuXHRcdFx0XHRsb2dNdXRhdGlvbih7XG5cdFx0XHRcdFx0dGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG5cdFx0XHRcdFx0a2V5LFxuXHRcdFx0XHRcdGFjdGlvbjogJ3VwZGF0ZScsXG5cdFx0XHRcdFx0bmV3VmFsdWU6IHsgW3Byb3BlcnR5XTogdmFsdWUgfSxcblx0XHRcdFx0XHRvbGRWYWx1ZTogeyBbcHJvcGVydHldOiBvbGRWYWx1ZSB9LFxuXHRcdFx0XHRcdG9yaWdpbjogJ1Byb3h5J1xuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHN1Y2Nlc3M7XG5cdFx0fVxuXHR9KTtcbn1cblxuY29uc3QgZGJQcm9taXNlOiBQcm9taXNlPFBhbGV0dGVEQj4gPSBvcGVuREI8UGFsZXR0ZVNjaGVtYT4oXG5cdCdwYWxldHRlRGF0YWJhc2UnLFxuXHQxLFxuXHR7XG5cdFx0dXBncmFkZShkYikge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0Y29uc3Qgc3RvcmVzID0gW1xuXHRcdFx0XHRcdCdjdXN0b21Db2xvcicsXG5cdFx0XHRcdFx0J211dGF0aW9ucycsXG5cdFx0XHRcdFx0J3NldHRpbmdzJyxcblx0XHRcdFx0XHQndGFibGVzJ1xuXHRcdFx0XHRdO1xuXG5cdFx0XHRcdHN0b3Jlcy5mb3JFYWNoKHN0b3JlID0+IHtcblx0XHRcdFx0XHRpZiAoIWRiLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoc3RvcmUpKSB7XG5cdFx0XHRcdFx0XHRkYi5jcmVhdGVPYmplY3RTdG9yZShzdG9yZSwge1xuXHRcdFx0XHRcdFx0XHRrZXlQYXRoOiBzdG9yZSA9PT0gJ211dGF0aW9ucycgPyAndGltZXN0YW1wJyA6ICdrZXknXG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0Y29uc29sZS5lcnJvcignRXJyb3IgZHVyaW5nIEluZGV4ZWREQiB1cGdyYWRlOicsIGVycm9yKTtcblxuXHRcdFx0XHR0aHJvdyBlcnJvcjtcblx0XHRcdH1cblx0XHR9XG5cdH1cbik7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERCKCk6IFByb21pc2U8UGFsZXR0ZURCPiB7XG5cdHJldHVybiBkYlByb21pc2U7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEN1cnJlbnRQYWxldHRlSUQoKTogUHJvbWlzZTxudW1iZXI+IHtcblx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXHRjb25zdCBzZXR0aW5ncyA9IGF3YWl0IGRiLmdldCgnc2V0dGluZ3MnLCAnYXBwU2V0dGluZ3MnKTtcblxuXHRyZXR1cm4gc2V0dGluZ3M/Lmxhc3RQYWxldHRlSUQgPz8gMDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0Q3VzdG9tQ29sb3IoKTogUHJvbWlzZTxIU0wgfCBudWxsPiB7XG5cdGNvbnN0IGRiID0gYXdhaXQgZ2V0REIoKTtcblx0Y29uc3QgZW50cnkgPSBhd2FpdCBkYi5nZXQoJ2N1c3RvbUNvbG9yJywgJ2N1c3RvbUNvbG9yJyk7XG5cblx0cmV0dXJuIGVudHJ5Py5jb2xvclxuXHRcdD8gY3JlYXRlTXV0YXRpb25Mb2dnZXIoZW50cnkuY29sb3IsICdjdXN0b21Db2xvcicpXG5cdFx0OiBudWxsO1xufVxuXG5mdW5jdGlvbiBnZXRMb2dnZWRPYmplY3Q8VCBleHRlbmRzIG9iamVjdD4oXG5cdG9iajogVCB8IG51bGwsXG5cdGtleTogc3RyaW5nXG4pOiBUIHwgbnVsbCB7XG5cdGlmIChvYmopIHtcblx0XHRyZXR1cm4gY3JlYXRlTXV0YXRpb25Mb2dnZXIob2JqLCBrZXkpO1xuXHR9XG5cblx0cmV0dXJuIG51bGw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE5leHRQYWxldHRlSUQoKTogUHJvbWlzZTxudW1iZXI+IHtcblx0Y29uc3QgY3VycmVudElEID0gYXdhaXQgZ2V0Q3VycmVudFBhbGV0dGVJRCgpO1xuXHRjb25zdCBuZXdJRCA9IGN1cnJlbnRJRCArIDE7XG5cblx0YXdhaXQgdXBkYXRlQ3VycmVudFBhbGV0dGVJRChuZXdJRCk7XG5cblx0cmV0dXJuIG5ld0lEO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXROZXh0VGFibGVJRCgpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRjb25zdCBzZXR0aW5ncyA9IGF3YWl0IGdldFNldHRpbmdzKCk7XG5cdGNvbnN0IG5leHRJRCA9IHNldHRpbmdzLmxhc3RUYWJsZUlEICsgMTtcblxuXHRhd2FpdCBzYXZlRGF0YSgnc2V0dGluZ3MnLCAnYXBwU2V0dGluZ3MnLCB7XG5cdFx0Li4uc2V0dGluZ3MsXG5cdFx0bGFzdFRhYmxlSUQ6IG5leHRJRFxuXHR9KTtcblxuXHRyZXR1cm4gYHBhbGV0dGVfJHtuZXh0SUR9YDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2V0dGluZ3MoKTogUHJvbWlzZTxTZXR0aW5ncz4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IGRiID0gYXdhaXQgZ2V0REIoKTtcblx0XHRjb25zdCBzZXR0aW5ncyA9IGF3YWl0IGRiLmdldCgnc2V0dGluZ3MnLCAnYXBwU2V0dGluZ3MnKTtcblxuXHRcdHJldHVybiBzZXR0aW5ncyA/PyBkZWZhdWx0U2V0dGluZ3M7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgc2V0dGluZ3M6JywgZXJyb3IpO1xuXG5cdFx0cmV0dXJuIHsgY29sb3JTcGFjZTogJ2hleCcsIGxhc3RUYWJsZUlEOiAwIH07XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VGFibGUoaWQ6IHN0cmluZyk6IFByb21pc2U8U3RvcmVkUGFsZXR0ZSB8IG51bGw+IHtcblx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXHRjb25zdCByZXN1bHQgPSBhd2FpdCBkYi5nZXQoJ3RhYmxlcycsIGlkKTtcblxuXHRpZiAoIXJlc3VsdCkgY29uc29sZS53YXJuKGBUYWJsZSB3aXRoIElEICR7aWR9IG5vdCBmb3VuZC5gKTtcblx0cmV0dXJuIHJlc3VsdDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U3RvcmU8U3RvcmVOYW1lIGV4dGVuZHMga2V5b2YgUGFsZXR0ZVNjaGVtYT4oXG5cdHN0b3JlTmFtZTogU3RvcmVOYW1lLFxuXHRtb2RlOiAncmVhZG9ubHknXG4pOiBQcm9taXNlPElEQlBPYmplY3RTdG9yZTxQYWxldHRlU2NoZW1hLCBbU3RvcmVOYW1lXSwgU3RvcmVOYW1lLCAncmVhZG9ubHknPj47XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFN0b3JlPFN0b3JlTmFtZSBleHRlbmRzIGtleW9mIFBhbGV0dGVTY2hlbWE+KFxuXHRzdG9yZU5hbWU6IFN0b3JlTmFtZSxcblx0bW9kZTogJ3JlYWR3cml0ZSdcbik6IFByb21pc2U8SURCUE9iamVjdFN0b3JlPFBhbGV0dGVTY2hlbWEsIFtTdG9yZU5hbWVdLCBTdG9yZU5hbWUsICdyZWFkd3JpdGUnPj47XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFN0b3JlPFN0b3JlTmFtZSBleHRlbmRzIGtleW9mIFBhbGV0dGVTY2hlbWE+KFxuXHRzdG9yZU5hbWU6IFN0b3JlTmFtZSxcblx0bW9kZTogJ3JlYWRvbmx5JyB8ICdyZWFkd3JpdGUnXG4pIHtcblx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXG5cdHJldHVybiBkYi50cmFuc2FjdGlvbihzdG9yZU5hbWUsIG1vZGUpLm9iamVjdFN0b3JlKHN0b3JlTmFtZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvZ011dGF0aW9uKGxvZzogTXV0YXRpb25Mb2cpOiBQcm9taXNlPHZvaWQ+IHtcblx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXG5cdGF3YWl0IGRiLnB1dCgnbXV0YXRpb25zJywgbG9nKTtcblxuXHRjb25zb2xlLmxvZyhgTG9nZ2VkIG11dGF0aW9uOiAke0pTT04uc3RyaW5naWZ5KGxvZyl9YCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlbmRlclBhbGV0dGUodGFibGVJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG5cdHRyeSB7XG5cdFx0Y29uc3Qgc3RvcmVkUGFsZXR0ZSA9IGF3YWl0IGdldFRhYmxlKHRhYmxlSWQpO1xuXHRcdGNvbnN0IHBhbGV0dGVSb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFsZXR0ZS1yb3cnKTtcblxuXHRcdGlmICghc3RvcmVkUGFsZXR0ZSkgdGhyb3cgbmV3IEVycm9yKGBQYWxldHRlICR7dGFibGVJZH0gbm90IGZvdW5kLmApO1xuXHRcdGlmICghcGFsZXR0ZVJvdykgdGhyb3cgbmV3IEVycm9yKCdQYWxldHRlIHJvdyBlbGVtZW50IG5vdCBmb3VuZC4nKTtcblxuXHRcdHBhbGV0dGVSb3cuaW5uZXJIVE1MID0gJyc7XG5cblx0XHRjb25zdCBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTtcblx0XHRjb25zdCB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7XG5cdFx0dGFibGUuY2xhc3NMaXN0LmFkZCgncGFsZXR0ZS10YWJsZScpO1xuXG5cdFx0c3RvcmVkUGFsZXR0ZS5wYWxldHRlLml0ZW1zLmZvckVhY2goKGl0ZW0sIGluZGV4KSA9PiB7XG5cdFx0XHRjb25zdCByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpO1xuXHRcdFx0Y29uc3QgY2VsbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7XG5cdFx0XHRjb25zdCBjb2xvckJveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG5cdFx0XHRjZWxsLnRleHRDb250ZW50ID0gYENvbG9yICR7aW5kZXggKyAxfWA7XG5cdFx0XHRjb2xvckJveC5jbGFzc0xpc3QuYWRkKCdjb2xvci1ib3gnKTtcblx0XHRcdGNvbG9yQm94LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGl0ZW0uY3NzU3RyaW5ncy5oZXhDU1NTdHJpbmc7XG5cblx0XHRcdHJvdy5hcHBlbmRDaGlsZChjb2xvckJveCk7XG5cdFx0XHRyb3cuYXBwZW5kQ2hpbGQoY2VsbCk7XG5cdFx0XHR0YWJsZS5hcHBlbmRDaGlsZChyb3cpO1xuXHRcdH0pO1xuXG5cdFx0ZnJhZ21lbnQuYXBwZW5kQ2hpbGQodGFibGUpO1xuXHRcdHBhbGV0dGVSb3cuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpO1xuXG5cdFx0Y29uc29sZS5sb2coYFJlbmRlcmVkIHBhbGV0dGUgJHt0YWJsZUlkfS5gKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gcmVuZGVyIHBhbGV0dGU6ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2F2ZURhdGE8VD4oXG5cdHN0b3JlTmFtZToga2V5b2YgUGFsZXR0ZVNjaGVtYSxcblx0a2V5OiBzdHJpbmcsXG5cdGRhdGE6IFQsXG5cdG9sZFZhbHVlPzogVFxuKTogUHJvbWlzZTx2b2lkPiB7XG5cdHRyeSB7XG5cdFx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXHRcdGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oc3RvcmVOYW1lLCAncmVhZHdyaXRlJyk7XG5cdFx0Y29uc3Qgc3RvcmUgPSB0eC5vYmplY3RTdG9yZShzdG9yZU5hbWUpO1xuXG5cdFx0YXdhaXQgc3RvcmUucHV0KHsga2V5LCAuLi5kYXRhIH0pO1xuXHRcdGF3YWl0IHR4LmRvbmU7XG5cblx0XHRjb25zb2xlLmxvZyhgJHtrZXl9IHNhdmVkIHRvICR7c3RvcmVOYW1lfS5gKTtcblxuXHRcdGF3YWl0IGxvZ011dGF0aW9uKHtcblx0XHRcdHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuXHRcdFx0a2V5LFxuXHRcdFx0YWN0aW9uOiAndXBkYXRlJyxcblx0XHRcdG5ld1ZhbHVlOiBkYXRhLFxuXHRcdFx0b2xkVmFsdWU6IG9sZFZhbHVlID8gb2xkVmFsdWUgOiBudWxsLFxuXHRcdFx0b3JpZ2luOiAnc2F2ZURhdGEnXG5cdFx0fSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHNhdmUgZGF0YSB0byAke3N0b3JlTmFtZX06YCwgZXJyb3IpO1xuXG5cdFx0dGhyb3cgZXJyb3I7XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2F2ZVBhbGV0dGUoXG5cdGlkOiBzdHJpbmcsXG5cdG5ld1BhbGV0dGU6IFN0b3JlZFBhbGV0dGVcbik6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IHN0b3JlID0gYXdhaXQgZ2V0U3RvcmUoJ3RhYmxlcycsICdyZWFkd3JpdGUnKTtcblx0XHRjb25zdCBwYWxldHRlVG9TYXZlOiBTdG9yZWRQYWxldHRlID0ge1xuXHRcdFx0dGFibGVJRDogbmV3UGFsZXR0ZS50YWJsZUlELFxuXHRcdFx0cGFsZXR0ZTogbmV3UGFsZXR0ZS5wYWxldHRlXG5cdFx0fTtcblxuXHRcdGF3YWl0IHN0b3JlLnB1dCh7IGtleTogaWQsIC4uLnBhbGV0dGVUb1NhdmUgfSk7XG5cblx0XHRjb25zb2xlLmxvZyhgUGFsZXR0ZSAke2lkfSBzYXZlZCBzdWNjZXNzZnVsbHkuYCk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHNhdmUgcGFsZXR0ZSAke2lkfTogJHtlcnJvcn1gKTtcblx0XHR0aHJvdyBlcnJvcjtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBzYXZlUGFsZXR0ZVRvREIoXG5cdHR5cGU6IHN0cmluZyxcblx0aXRlbXM6IFBhbGV0dGVJdGVtW10sXG5cdGJhc2VDb2xvcjogSFNMLFxuXHRudW1Cb3hlczogbnVtYmVyLFxuXHRlbmFibGVBbHBoYTogYm9vbGVhbixcblx0bGltaXRCcmlnaHQ6IGJvb2xlYW4sXG5cdGxpbWl0RGFyazogYm9vbGVhbixcblx0bGltaXRHcmF5OiBib29sZWFuXG4pOiBQcm9taXNlPFBhbGV0dGU+IHtcblx0Y29uc3QgcGFsZXR0ZUlEID0gYXdhaXQgZ2V0TmV4dFBhbGV0dGVJRCgpO1xuXG5cdGNvbnN0IG5ld1BhbGV0dGUgPSB1dGlscy5wYWxldHRlLmNyZWF0ZU9iamVjdChcblx0XHR0eXBlLFxuXHRcdGl0ZW1zLFxuXHRcdGJhc2VDb2xvcixcblx0XHRwYWxldHRlSUQsXG5cdFx0bnVtQm94ZXMsXG5cdFx0ZW5hYmxlQWxwaGEsXG5cdFx0bGltaXRCcmlnaHQsXG5cdFx0bGltaXREYXJrLFxuXHRcdGxpbWl0R3JheVxuXHQpO1xuXG5cdGF3YWl0IHNhdmVQYWxldHRlKG5ld1BhbGV0dGUuaWQsIHtcblx0XHR0YWJsZUlEOiBwYXJzZUludChuZXdQYWxldHRlLmlkLnNwbGl0KCdfJylbMV0pLFxuXHRcdHBhbGV0dGU6IG5ld1BhbGV0dGVcblx0fSk7XG5cblx0Y29uc29sZS5sb2coYFNhdmVkICR7dHlwZX0gcGFsZXR0ZTogJHtKU09OLnN0cmluZ2lmeShuZXdQYWxldHRlKX1gKTtcblxuXHRyZXR1cm4gbmV3UGFsZXR0ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2F2ZVNldHRpbmdzKG5ld1NldHRpbmdzOiBTZXR0aW5ncyk6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGF3YWl0IHNhdmVEYXRhKCdzZXR0aW5ncycsICdhcHBTZXR0aW5ncycsIG5ld1NldHRpbmdzKTtcblxuXHRcdGNvbnNvbGUubG9nKCdTZXR0aW5ncyB1cGRhdGVkJyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHNhdmUgc2V0dGluZ3M6ICR7ZXJyb3J9YCk7XG5cblx0XHR0aHJvdyBlcnJvcjtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiB0cmFja2VkVHJhbnNhY3Rpb248U3RvcmVOYW1lIGV4dGVuZHMga2V5b2YgUGFsZXR0ZVNjaGVtYT4oXG5cdHN0b3JlTmFtZTogU3RvcmVOYW1lLFxuXHRtb2RlOiAncmVhZG9ubHknIHwgJ3JlYWR3cml0ZScsXG5cdGNhbGxiYWNrOiAoXG5cdFx0c3RvcmU6IElEQlBPYmplY3RTdG9yZTxcblx0XHRcdFBhbGV0dGVTY2hlbWEsXG5cdFx0XHRbU3RvcmVOYW1lXSxcblx0XHRcdFN0b3JlTmFtZSxcblx0XHRcdCdyZWFkb25seScgfCAncmVhZHdyaXRlJ1xuXHRcdD5cblx0KSA9PiBQcm9taXNlPHZvaWQ+XG4pOiBQcm9taXNlPHZvaWQ+IHtcblx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXHRjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgbW9kZSk7XG5cdGNvbnN0IHN0b3JlID0gdHgub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcblxuXHR0cnkge1xuXHRcdGF3YWl0IGNhbGxiYWNrKHN0b3JlKTtcblx0XHRhd2FpdCB0eC5kb25lO1xuXG5cdFx0Y29uc29sZS5sb2coYFRyYW5zYWN0aW9uIG9uICR7c3RvcmVOYW1lfSBjb21wbGV0ZWQuYCk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgVHJhbnNhY3Rpb24gb24gJHtzdG9yZU5hbWV9IGZhaWxlZDogJHtlcnJvcn1gKTtcblxuXHRcdHRocm93IGVycm9yO1xuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUN1cnJlbnRQYWxldHRlSUQobmV3SUQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuXHRjb25zdCBkYiA9IGF3YWl0IGdldERCKCk7XG5cdGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3NldHRpbmdzJywgJ3JlYWR3cml0ZScpO1xuXHRjb25zdCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdzZXR0aW5ncycpO1xuXG5cdGF3YWl0IHN0b3JlLnB1dCh7IGtleTogJ2FwcFNldHRpbmdzJywgbGFzdFBhbGV0dGVJRDogbmV3SUQgfSk7XG5cdGF3YWl0IHR4LmRvbmU7XG5cblx0Y29uc29sZS5sb2coYEN1cnJlbnQgcGFsZXR0ZSBJRCB1cGRhdGVkIHRvICR7bmV3SUR9YCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUVudHJ5SW5QYWxldHRlKFxuXHR0YWJsZUlEOiBzdHJpbmcsXG5cdGVudHJ5SW5kZXg6IG51bWJlcixcblx0bmV3RW50cnk6IFBhbGV0dGVJdGVtXG4pOiBQcm9taXNlPHZvaWQ+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBzdG9yZWRQYWxldHRlID0gYXdhaXQgZ2V0VGFibGUodGFibGVJRCk7XG5cblx0XHRpZiAoIXN0b3JlZFBhbGV0dGUpIHRocm93IG5ldyBFcnJvcihgUGFsZXR0ZSAke3RhYmxlSUR9IG5vdCBmb3VuZC5gKTtcblxuXHRcdGNvbnN0IHsgaXRlbXMgfSA9IHN0b3JlZFBhbGV0dGUucGFsZXR0ZTtcblxuXHRcdGlmIChlbnRyeUluZGV4ID49IGl0ZW1zLmxlbmd0aClcblx0XHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdFx0YEVudHJ5ICR7ZW50cnlJbmRleH0gbm90IGZvdW5kIGluIHBhbGV0dGUgJHt0YWJsZUlEfS5gXG5cdFx0XHQpO1xuXG5cdFx0Y29uc3Qgb2xkRW50cnkgPSBpdGVtc1tlbnRyeUluZGV4XTtcblx0XHRpdGVtc1tlbnRyeUluZGV4XSA9IG5ld0VudHJ5O1xuXG5cdFx0YXdhaXQgc2F2ZURhdGEoJ3RhYmxlcycsIHRhYmxlSUQsIHN0b3JlZFBhbGV0dGUpO1xuXHRcdGF3YWl0IGxvZ011dGF0aW9uKHtcblx0XHRcdHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuXHRcdFx0a2V5OiBgJHt0YWJsZUlEfS0ke2VudHJ5SW5kZXh9XWAsXG5cdFx0XHRhY3Rpb246ICd1cGRhdGUnLFxuXHRcdFx0bmV3VmFsdWU6IG5ld0VudHJ5LFxuXHRcdFx0b2xkVmFsdWU6IG9sZEVudHJ5LFxuXHRcdFx0b3JpZ2luOiAndXBkYXRlRW50cnlJblBhbGV0dGUnXG5cdFx0fSk7XG5cblx0XHRjb25zb2xlLmxvZyhgRW50cnkgJHtlbnRyeUluZGV4fSBpbiBwYWxldHRlICR7dGFibGVJRH0gdXBkYXRlZC5gKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gdXBkYXRlIGVudHJ5IGluIHBhbGV0dGU6ICR7ZXJyb3J9YCk7XG5cblx0XHR0aHJvdyBlcnJvcjtcblx0fVxufVxuXG5leHBvcnQgY29uc3QgaWRiID0ge1xuXHRjcmVhdGVNdXRhdGlvbkxvZ2dlcixcblx0ZGVsZXRlVGFibGU6IGFzeW5jIChpZDogc3RyaW5nKSA9PiB7XG5cdFx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXHRcdGF3YWl0IGRiLmRlbGV0ZSgndGFibGVzJywgaWQpO1xuXHRcdGNvbnNvbGUubG9nKGBUYWJsZSAke2lkfSBkZWxldGVkLmApO1xuXHR9LFxuXHRnZXRDdXJyZW50UGFsZXR0ZUlELFxuXHRnZXRDdXN0b21Db2xvcixcblx0Z2V0REIsXG5cdGdldExvZ2dlZE9iamVjdCxcblx0Z2V0TmV4dFBhbGV0dGVJRCxcblx0Z2V0TmV4dFRhYmxlSUQsXG5cdGdldFNldHRpbmdzLFxuXHRnZXRTdG9yZSxcblx0Z2V0VGFibGUsXG5cdGxpc3RUYWJsZXM6IGFzeW5jICgpID0+IHtcblx0XHRjb25zdCBkYiA9IGF3YWl0IGdldERCKCk7XG5cdFx0Y29uc3Qga2V5cyA9IGF3YWl0IGRiLmdldEFsbEtleXMoJ3RhYmxlcycpO1xuXHRcdHJldHVybiBrZXlzLm1hcChTdHJpbmcpO1xuXHR9LFxuXHRsb2dNdXRhdGlvbixcblx0cmVuZGVyUGFsZXR0ZSxcblx0c2F2ZURhdGEsXG5cdHNhdmVQYWxldHRlLFxuXHRzYXZlUGFsZXR0ZVRvREIsXG5cdHNhdmVTZXR0aW5ncyxcblx0dHJhY2tlZFRyYW5zYWN0aW9uLFxuXHR1cGRhdGVDdXJyZW50UGFsZXR0ZUlELFxuXHR1cGRhdGVFbnRyeUluUGFsZXR0ZVxufTtcbiJdfQ==