import { openDB } from 'idb';
import { defaults } from '../config/defaults.js';
import { paletteUtils } from '../utils/palette-utils.js';
//
// ******** DB Initialization ********
const dbPromise = openDB('paletteDatabase', 1, {
    upgrade(db) {
        try {
            const stores = [
                'customColor',
                'mutations',
                'settings',
                'tables'
            ];
            stores.forEach(store => {
                if (!db.objectStoreNames.contains(store)) {
                    db.createObjectStore(store, {
                        keyPath: store === 'mutations' ? 'timestamp' : 'key'
                    });
                }
            });
        }
        catch (error) {
            console.error('Error during IndexedDB upgrade:', error);
            throw error;
        }
    }
});
//
// ******** Utility Functions ********
function createMutationLogger(obj, key) {
    return new Proxy(obj, {
        set(target, property, value) {
            const oldValue = target[property];
            const success = Reflect.set(target, property, value);
            if (success) {
                logMutation({
                    timestamp: new Date().toISOString(),
                    key,
                    action: 'update',
                    newValue: { [property]: value },
                    oldValue: { [property]: oldValue },
                    origin: 'Proxy'
                });
            }
            return success;
        }
    });
}
async function getDB() {
    return dbPromise;
}
async function getNextTableID() {
    const settings = await getSettings();
    const nextID = settings.lastTableID + 1;
    await saveData('settings', 'appSettings', {
        ...settings,
        lastTableID: nextID
    });
    return `palette_${nextID}`;
}
async function getCurrentPaletteID() {
    const db = await getDB();
    const settings = await db.get('settings', 'appSettings');
    return settings?.lastPaletteID ?? 0;
}
async function getCustomColor() {
    const db = await getDB();
    const entry = await db.get('customColor', 'customColor');
    return entry?.color
        ? createMutationLogger(entry.color, 'customColor')
        : null;
}
function getLoggedObject(obj, key) {
    if (obj) {
        return createMutationLogger(obj, key);
    }
    return null;
}
async function getSettings() {
    try {
        const db = await getDB();
        const settings = await db.get('settings', 'appSettings');
        return settings ?? defaults.settings;
    }
    catch (error) {
        console.error('Error fetching settings:', error);
        return { colorSpace: 'hex', lastTableID: 0 };
    }
}
async function getTable(id) {
    const db = await getDB();
    const result = await db.get('tables', id);
    if (!result)
        console.warn(`Table with ID ${id} not found.`);
    return result;
}
async function getStore(storeName, mode) {
    const db = await getDB();
    return db.transaction(storeName, mode).objectStore(storeName);
}
async function logMutation(log) {
    const db = await getDB();
    await db.put('mutations', log);
    console.log(`Logged mutation: ${JSON.stringify(log)}`);
}
async function renderPalette(tableId) {
    try {
        const storedPalette = await getTable(tableId);
        const paletteRow = document.getElementById('palette-row');
        if (!storedPalette)
            throw new Error(`Palette ${tableId} not found.`);
        if (!paletteRow)
            throw new Error('Palette row element not found.');
        paletteRow.innerHTML = '';
        const fragment = document.createDocumentFragment();
        const table = document.createElement('table');
        table.classList.add('palette-table');
        storedPalette.palette.items.forEach((item, index) => {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            const colorBox = document.createElement('div');
            cell.textContent = `Color ${index + 1}`;
            colorBox.classList.add('color-box');
            colorBox.style.backgroundColor = item.cssStrings.hexCSSString;
            row.appendChild(colorBox);
            row.appendChild(cell);
            table.appendChild(row);
        });
        fragment.appendChild(table);
        paletteRow.appendChild(fragment);
        console.log(`Rendered palette ${tableId}.`);
    }
    catch (error) {
        console.error(`Failed to render palette: ${error}`);
    }
}
async function saveData(storeName, key, data, oldValue) {
    try {
        const db = await getDB();
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        await store.put({ key, ...data });
        await tx.done;
        console.log(`${key} saved to ${storeName}.`);
        await logMutation({
            timestamp: new Date().toISOString(),
            key,
            action: 'update',
            newValue: data,
            oldValue: oldValue ? oldValue : null,
            origin: 'saveData'
        });
    }
    catch (error) {
        console.error(`Failed to save data to ${storeName}:`, error);
        throw error;
    }
}
async function savePalette(id, newPalette) {
    try {
        const store = await getStore('tables', 'readwrite');
        const paletteToSave = {
            tableID: newPalette.tableID,
            palette: newPalette.palette
        };
        await store.put({ key: id, ...paletteToSave });
        console.log(`Palette ${id} saved successfully.`);
    }
    catch (error) {
        console.error(`Failed to save palette ${id}: ${error}`);
        throw error;
    }
}
async function savePaletteToDB(type, items, baseColor, numBoxes, enableAlpha, limitBright, limitDark, limitGray) {
    const paletteID = await getNextPaletteID();
    const newPalette = paletteUtils.createPaletteObject(type, items, baseColor, paletteID, numBoxes, enableAlpha, limitBright, limitDark, limitGray);
    await savePalette(newPalette.id, {
        tableID: parseInt(newPalette.id.split('_')[1]),
        palette: newPalette
    });
    console.log(`Saved ${type} palette: ${JSON.stringify(newPalette)}`);
    return newPalette;
}
async function saveSettings(newSettings) {
    try {
        await saveData('settings', 'appSettings', newSettings);
        console.log('Settings updated');
    }
    catch (error) {
        console.error(`Failed to save settings: ${error}`);
        throw error;
    }
}
async function trackedTransaction(storeName, mode, callback) {
    try {
        const store = mode === 'readonly'
            ? await getStore(storeName, 'readonly')
            : await getStore(storeName, 'readwrite');
        await callback(store);
        console.log(`Transaction on ${storeName} completed.`);
    }
    catch (error) {
        console.error(`Transaction on ${storeName} failed: ${error}`);
        throw error;
    }
}
async function getNextPaletteID() {
    const currentID = await getCurrentPaletteID();
    const newID = currentID + 1;
    await updateCurrentPaletteID(newID);
    return newID;
}
async function initializeCurrentPaletteID() {
    return getCurrentPaletteID();
}
async function updateCurrentPaletteID(newID) {
    const db = await getDB();
    const tx = db.transaction('settings', 'readwrite');
    const store = tx.objectStore('settings');
    await store.put({ key: 'appSettings', lastPaletteID: newID });
    await tx.done;
    console.log(`Current palette ID updated to ${newID}`);
}
async function updateEntryInPalette(tableID, entryIndex, newEntry) {
    try {
        const storedPalette = await getTable(tableID);
        if (!storedPalette)
            throw new Error(`Palette ${tableID} not found.`);
        const { items } = storedPalette.palette;
        if (entryIndex >= items.length)
            throw new Error(`Entry ${entryIndex} not found in palette ${tableID}.`);
        const oldEntry = items[entryIndex];
        items[entryIndex] = newEntry;
        await saveData('tables', tableID, storedPalette);
        await logMutation({
            timestamp: new Date().toISOString(),
            key: `${tableID}-${entryIndex}]`,
            action: 'update',
            newValue: newEntry,
            oldValue: oldEntry,
            origin: 'updateEntryInPalette'
        });
        console.log(`Entry ${entryIndex} in palette ${tableID} updated.`);
    }
    catch (error) {
        console.error(`Failed to update entry in palette: ${error}`);
        throw error;
    }
}
export const database = {
    createMutationLogger,
    deleteTable: async (id) => {
        const db = await getDB();
        await db.delete('tables', id);
        console.log(`Table ${id} deleted.`);
    },
    getCurrentPaletteID,
    getCustomColor,
    getDB,
    getLoggedObject,
    getNextPaletteID,
    getNextTableID,
    getSettings,
    getStore,
    getTable,
    initializeCurrentPaletteID,
    listTables: async () => {
        const db = await getDB();
        const keys = await db.getAllKeys('tables');
        return keys.map(String);
    },
    logMutation,
    renderPalette,
    saveData,
    savePalette,
    savePaletteToDB,
    saveSettings,
    trackedTransaction,
    updateCurrentPaletteID,
    updateEntryInPalette
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZGF0YWJhc2UvZGF0YWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFtQixNQUFNLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDOUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBSzlDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUV0RCxFQUFFO0FBQ0Ysc0NBQXNDO0FBRXRDLE1BQU0sU0FBUyxHQUEyQixNQUFNLENBQy9DLGlCQUFpQixFQUNqQixDQUFDLEVBQ0Q7SUFDQyxPQUFPLENBQUMsRUFBRTtRQUNULElBQUksQ0FBQztZQUNKLE1BQU0sTUFBTSxHQUFHO2dCQUNkLGFBQWE7Z0JBQ2IsV0FBVztnQkFDWCxVQUFVO2dCQUNWLFFBQVE7YUFDUixDQUFDO1lBRUYsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDdEIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztvQkFDMUMsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEtBQUssRUFBRTt3QkFDM0IsT0FBTyxFQUFFLEtBQUssS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSztxQkFDcEQsQ0FBQyxDQUFDO2dCQUNKLENBQUM7WUFDRixDQUFDLENBQUMsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFeEQsTUFBTSxLQUFLLENBQUM7UUFDYixDQUFDO0lBQ0YsQ0FBQztDQUNELENBQ0QsQ0FBQztBQUVGLEVBQUU7QUFDRixzQ0FBc0M7QUFFdEMsU0FBUyxvQkFBb0IsQ0FBbUIsR0FBTSxFQUFFLEdBQVc7SUFDbEUsT0FBTyxJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUU7UUFDckIsR0FBRyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSztZQUMxQixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBbUIsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUVyRCxJQUFJLE9BQU8sRUFBRSxDQUFDO2dCQUNiLFdBQVcsQ0FBQztvQkFDWCxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7b0JBQ25DLEdBQUc7b0JBQ0gsTUFBTSxFQUFFLFFBQVE7b0JBQ2hCLFFBQVEsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFO29CQUMvQixRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLFFBQVEsRUFBRTtvQkFDbEMsTUFBTSxFQUFFLE9BQU87aUJBQ2YsQ0FBQyxDQUFDO1lBQ0osQ0FBQztZQUVELE9BQU8sT0FBTyxDQUFDO1FBQ2hCLENBQUM7S0FDRCxDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsS0FBSyxVQUFVLEtBQUs7SUFDbkIsT0FBTyxTQUFTLENBQUM7QUFDbEIsQ0FBQztBQUVELEtBQUssVUFBVSxjQUFjO0lBQzVCLE1BQU0sUUFBUSxHQUFHLE1BQU0sV0FBVyxFQUFFLENBQUM7SUFDckMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7SUFFeEMsTUFBTSxRQUFRLENBQUMsVUFBVSxFQUFFLGFBQWEsRUFBRTtRQUN6QyxHQUFHLFFBQVE7UUFDWCxXQUFXLEVBQUUsTUFBTTtLQUNuQixDQUFDLENBQUM7SUFFSCxPQUFPLFdBQVcsTUFBTSxFQUFFLENBQUM7QUFDNUIsQ0FBQztBQUVELEtBQUssVUFBVSxtQkFBbUI7SUFDakMsTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztJQUN6QixNQUFNLFFBQVEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBRXpELE9BQU8sUUFBUSxFQUFFLGFBQWEsSUFBSSxDQUFDLENBQUM7QUFDckMsQ0FBQztBQUVELEtBQUssVUFBVSxjQUFjO0lBQzVCLE1BQU0sRUFBRSxHQUFHLE1BQU0sS0FBSyxFQUFFLENBQUM7SUFDekIsTUFBTSxLQUFLLEdBQUcsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUV6RCxPQUFPLEtBQUssRUFBRSxLQUFLO1FBQ2xCLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLGFBQWEsQ0FBQztRQUNsRCxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ1QsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUN2QixHQUFhLEVBQ2IsR0FBVztJQUVYLElBQUksR0FBRyxFQUFFLENBQUM7UUFDVCxPQUFPLG9CQUFvQixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQsT0FBTyxJQUFJLENBQUM7QUFDYixDQUFDO0FBRUQsS0FBSyxVQUFVLFdBQVc7SUFDekIsSUFBSSxDQUFDO1FBQ0osTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztRQUN6QixNQUFNLFFBQVEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRXpELE9BQU8sUUFBUSxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUM7SUFDdEMsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDaEIsT0FBTyxDQUFDLEtBQUssQ0FBQywwQkFBMEIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUVqRCxPQUFPLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFLENBQUM7SUFDOUMsQ0FBQztBQUNGLENBQUM7QUFFRCxLQUFLLFVBQVUsUUFBUSxDQUFDLEVBQVU7SUFDakMsTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztJQUN6QixNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRTFDLElBQUksQ0FBQyxNQUFNO1FBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUM1RCxPQUFPLE1BQU0sQ0FBQztBQUNmLENBQUM7QUFnQkQsS0FBSyxVQUFVLFFBQVEsQ0FDdEIsU0FBb0IsRUFDcEIsSUFBOEI7SUFFOUIsTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztJQUN6QixPQUFPLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMvRCxDQUFDO0FBRUQsS0FBSyxVQUFVLFdBQVcsQ0FBQyxHQUFvQjtJQUM5QyxNQUFNLEVBQUUsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO0lBRXpCLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFFL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQUVELEtBQUssVUFBVSxhQUFhLENBQUMsT0FBZTtJQUMzQyxJQUFJLENBQUM7UUFDSixNQUFNLGFBQWEsR0FBRyxNQUFNLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5QyxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTFELElBQUksQ0FBQyxhQUFhO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLE9BQU8sYUFBYSxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLFVBQVU7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7UUFFbkUsVUFBVSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFFMUIsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLHNCQUFzQixFQUFFLENBQUM7UUFDbkQsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5QyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUVyQyxhQUFhLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDbkQsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6QyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzFDLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFL0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxTQUFTLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN4QyxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNwQyxRQUFRLENBQUMsS0FBSyxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQztZQUU5RCxHQUFHLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzFCLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEIsS0FBSyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FBQztRQUVILFFBQVEsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDNUIsVUFBVSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVqQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixPQUFPLEdBQUcsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2hCLE9BQU8sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDckQsQ0FBQztBQUNGLENBQUM7QUFFRCxLQUFLLFVBQVUsUUFBUSxDQUN0QixTQUFrQyxFQUNsQyxHQUFXLEVBQ1gsSUFBTyxFQUNQLFFBQVk7SUFFWixJQUFJLENBQUM7UUFDSixNQUFNLEVBQUUsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO1FBQ3pCLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ2xELE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFeEMsTUFBTSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNsQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUM7UUFFZCxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxhQUFhLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFFN0MsTUFBTSxXQUFXLENBQUM7WUFDakIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1lBQ25DLEdBQUc7WUFDSCxNQUFNLEVBQUUsUUFBUTtZQUNoQixRQUFRLEVBQUUsSUFBSTtZQUNkLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUNwQyxNQUFNLEVBQUUsVUFBVTtTQUNsQixDQUFDLENBQUM7SUFDSixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLDBCQUEwQixTQUFTLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM3RCxNQUFNLEtBQUssQ0FBQztJQUNiLENBQUM7QUFDRixDQUFDO0FBRUQsS0FBSyxVQUFVLFdBQVcsQ0FDekIsRUFBVSxFQUNWLFVBQTZCO0lBRTdCLElBQUksQ0FBQztRQUNKLE1BQU0sS0FBSyxHQUFHLE1BQU0sUUFBUSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNwRCxNQUFNLGFBQWEsR0FBc0I7WUFDeEMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxPQUFPO1lBQzNCLE9BQU8sRUFBRSxVQUFVLENBQUMsT0FBTztTQUMzQixDQUFDO1FBRUYsTUFBTSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxHQUFHLGFBQWEsRUFBRSxDQUFDLENBQUM7UUFFL0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLDBCQUEwQixFQUFFLEtBQUssS0FBSyxFQUFFLENBQUMsQ0FBQztRQUN4RCxNQUFNLEtBQUssQ0FBQztJQUNiLENBQUM7QUFDRixDQUFDO0FBRUQsS0FBSyxVQUFVLGVBQWUsQ0FDN0IsSUFBWSxFQUNaLEtBQTRCLEVBQzVCLFNBQXFCLEVBQ3JCLFFBQWdCLEVBQ2hCLFdBQW9CLEVBQ3BCLFdBQW9CLEVBQ3BCLFNBQWtCLEVBQ2xCLFNBQWtCO0lBRWxCLE1BQU0sU0FBUyxHQUFHLE1BQU0sZ0JBQWdCLEVBQUUsQ0FBQztJQUUzQyxNQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsbUJBQW1CLENBQ2xELElBQUksRUFDSixLQUFLLEVBQ0wsU0FBUyxFQUNULFNBQVMsRUFDVCxRQUFRLEVBQ1IsV0FBVyxFQUNYLFdBQVcsRUFDWCxTQUFTLEVBQ1QsU0FBUyxDQUNULENBQUM7SUFFRixNQUFNLFdBQVcsQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFO1FBQ2hDLE9BQU8sRUFBRSxRQUFRLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUMsT0FBTyxFQUFFLFVBQVU7S0FDbkIsQ0FBQyxDQUFDO0lBRUgsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksYUFBYSxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUVwRSxPQUFPLFVBQVUsQ0FBQztBQUNuQixDQUFDO0FBRUQsS0FBSyxVQUFVLFlBQVksQ0FBQyxXQUF5QjtJQUNwRCxJQUFJLENBQUM7UUFDSixNQUFNLFFBQVEsQ0FBQyxVQUFVLEVBQUUsYUFBYSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBRXZELE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRW5ELE1BQU0sS0FBSyxDQUFDO0lBQ2IsQ0FBQztBQUNGLENBQUM7QUFFRCxLQUFLLFVBQVUsa0JBQWtCLENBQ2hDLFNBQW9CLEVBQ3BCLElBQThCLEVBQzlCLFFBT2tCO0lBRWxCLElBQUksQ0FBQztRQUNKLE1BQU0sS0FBSyxHQUNWLElBQUksS0FBSyxVQUFVO1lBQ2xCLENBQUMsQ0FBQyxNQUFNLFFBQVEsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDO1lBQ3ZDLENBQUMsQ0FBQyxNQUFNLFFBQVEsQ0FBQyxTQUFTLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFFM0MsTUFBTSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsU0FBUyxhQUFhLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixTQUFTLFlBQVksS0FBSyxFQUFFLENBQUMsQ0FBQztRQUU5RCxNQUFNLEtBQUssQ0FBQztJQUNiLENBQUM7QUFDRixDQUFDO0FBRUQsS0FBSyxVQUFVLGdCQUFnQjtJQUM5QixNQUFNLFNBQVMsR0FBRyxNQUFNLG1CQUFtQixFQUFFLENBQUM7SUFDOUMsTUFBTSxLQUFLLEdBQUcsU0FBUyxHQUFHLENBQUMsQ0FBQztJQUU1QixNQUFNLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRXBDLE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQztBQUVELEtBQUssVUFBVSwwQkFBMEI7SUFDeEMsT0FBTyxtQkFBbUIsRUFBRSxDQUFDO0FBQzlCLENBQUM7QUFFRCxLQUFLLFVBQVUsc0JBQXNCLENBQUMsS0FBYTtJQUNsRCxNQUFNLEVBQUUsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO0lBQ3pCLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ25ELE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7SUFFekMsTUFBTSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLGFBQWEsRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM5RCxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUM7SUFFZCxPQUFPLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZELENBQUM7QUFFRCxLQUFLLFVBQVUsb0JBQW9CLENBQ2xDLE9BQWUsRUFDZixVQUFrQixFQUNsQixRQUE2QjtJQUU3QixJQUFJLENBQUM7UUFDSixNQUFNLGFBQWEsR0FBRyxNQUFNLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU5QyxJQUFJLENBQUMsYUFBYTtZQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsV0FBVyxPQUFPLGFBQWEsQ0FBQyxDQUFDO1FBRXJFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDO1FBRXhDLElBQUksVUFBVSxJQUFJLEtBQUssQ0FBQyxNQUFNO1lBQzdCLE1BQU0sSUFBSSxLQUFLLENBQ2QsU0FBUyxVQUFVLHlCQUF5QixPQUFPLEdBQUcsQ0FDdEQsQ0FBQztRQUVILE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNuQyxLQUFLLENBQUMsVUFBVSxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBRTdCLE1BQU0sUUFBUSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDakQsTUFBTSxXQUFXLENBQUM7WUFDakIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1lBQ25DLEdBQUcsRUFBRSxHQUFHLE9BQU8sSUFBSSxVQUFVLEdBQUc7WUFDaEMsTUFBTSxFQUFFLFFBQVE7WUFDaEIsUUFBUSxFQUFFLFFBQVE7WUFDbEIsUUFBUSxFQUFFLFFBQVE7WUFDbEIsTUFBTSxFQUFFLHNCQUFzQjtTQUM5QixDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsVUFBVSxlQUFlLE9BQU8sV0FBVyxDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDaEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUU3RCxNQUFNLEtBQUssQ0FBQztJQUNiLENBQUM7QUFDRixDQUFDO0FBRUQsTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUF1QjtJQUMzQyxvQkFBb0I7SUFDcEIsV0FBVyxFQUFFLEtBQUssRUFBRSxFQUFVLEVBQUUsRUFBRTtRQUNqQyxNQUFNLEVBQUUsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO1FBQ3pCLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUNELG1CQUFtQjtJQUNuQixjQUFjO0lBQ2QsS0FBSztJQUNMLGVBQWU7SUFDZixnQkFBZ0I7SUFDaEIsY0FBYztJQUNkLFdBQVc7SUFDWCxRQUFRO0lBQ1IsUUFBUTtJQUNSLDBCQUEwQjtJQUMxQixVQUFVLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDdEIsTUFBTSxFQUFFLEdBQUcsTUFBTSxLQUFLLEVBQUUsQ0FBQztRQUN6QixNQUFNLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFDRCxXQUFXO0lBQ1gsYUFBYTtJQUNiLFFBQVE7SUFDUixXQUFXO0lBQ1gsZUFBZTtJQUNmLFlBQVk7SUFDWixrQkFBa0I7SUFDbEIsc0JBQXNCO0lBQ3RCLG9CQUFvQjtDQUNwQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSURCUE9iamVjdFN0b3JlLCBvcGVuREIgfSBmcm9tICdpZGInO1xuaW1wb3J0IHsgZGVmYXVsdHMgfSBmcm9tICcuLi9jb25maWcvZGVmYXVsdHMnO1xuaW1wb3J0ICogYXMgY29sb3JzIGZyb20gJy4uL2luZGV4L2NvbG9ycyc7XG5pbXBvcnQgKiBhcyBmbk9iamVjdHMgZnJvbSAnLi4vaW5kZXgvZm4tb2JqZWN0cyc7XG5pbXBvcnQgKiBhcyBpZGIgZnJvbSAnLi4vaW5kZXgvZGF0YWJhc2UnO1xuaW1wb3J0ICogYXMgcGFsZXR0ZSBmcm9tICcuLi9pbmRleC9wYWxldHRlJztcbmltcG9ydCB7IHBhbGV0dGVVdGlscyB9IGZyb20gJy4uL3V0aWxzL3BhbGV0dGUtdXRpbHMnO1xuXG4vL1xuLy8gKioqKioqKiogREIgSW5pdGlhbGl6YXRpb24gKioqKioqKipcblxuY29uc3QgZGJQcm9taXNlOiBQcm9taXNlPGlkYi5QYWxldHRlREI+ID0gb3BlbkRCPGlkYi5QYWxldHRlU2NoZW1hPihcblx0J3BhbGV0dGVEYXRhYmFzZScsXG5cdDEsXG5cdHtcblx0XHR1cGdyYWRlKGRiKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRjb25zdCBzdG9yZXMgPSBbXG5cdFx0XHRcdFx0J2N1c3RvbUNvbG9yJyxcblx0XHRcdFx0XHQnbXV0YXRpb25zJyxcblx0XHRcdFx0XHQnc2V0dGluZ3MnLFxuXHRcdFx0XHRcdCd0YWJsZXMnXG5cdFx0XHRcdF07XG5cblx0XHRcdFx0c3RvcmVzLmZvckVhY2goc3RvcmUgPT4ge1xuXHRcdFx0XHRcdGlmICghZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhzdG9yZSkpIHtcblx0XHRcdFx0XHRcdGRiLmNyZWF0ZU9iamVjdFN0b3JlKHN0b3JlLCB7XG5cdFx0XHRcdFx0XHRcdGtleVBhdGg6IHN0b3JlID09PSAnbXV0YXRpb25zJyA/ICd0aW1lc3RhbXAnIDogJ2tleSdcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRjb25zb2xlLmVycm9yKCdFcnJvciBkdXJpbmcgSW5kZXhlZERCIHVwZ3JhZGU6JywgZXJyb3IpO1xuXG5cdFx0XHRcdHRocm93IGVycm9yO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuKTtcblxuLy9cbi8vICoqKioqKioqIFV0aWxpdHkgRnVuY3Rpb25zICoqKioqKioqXG5cbmZ1bmN0aW9uIGNyZWF0ZU11dGF0aW9uTG9nZ2VyPFQgZXh0ZW5kcyBvYmplY3Q+KG9iajogVCwga2V5OiBzdHJpbmcpOiBUIHtcblx0cmV0dXJuIG5ldyBQcm94eShvYmosIHtcblx0XHRzZXQodGFyZ2V0LCBwcm9wZXJ0eSwgdmFsdWUpIHtcblx0XHRcdGNvbnN0IG9sZFZhbHVlID0gdGFyZ2V0W3Byb3BlcnR5IGFzIGtleW9mIFRdO1xuXHRcdFx0Y29uc3Qgc3VjY2VzcyA9IFJlZmxlY3Quc2V0KHRhcmdldCwgcHJvcGVydHksIHZhbHVlKTtcblxuXHRcdFx0aWYgKHN1Y2Nlc3MpIHtcblx0XHRcdFx0bG9nTXV0YXRpb24oe1xuXHRcdFx0XHRcdHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuXHRcdFx0XHRcdGtleSxcblx0XHRcdFx0XHRhY3Rpb246ICd1cGRhdGUnLFxuXHRcdFx0XHRcdG5ld1ZhbHVlOiB7IFtwcm9wZXJ0eV06IHZhbHVlIH0sXG5cdFx0XHRcdFx0b2xkVmFsdWU6IHsgW3Byb3BlcnR5XTogb2xkVmFsdWUgfSxcblx0XHRcdFx0XHRvcmlnaW46ICdQcm94eSdcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBzdWNjZXNzO1xuXHRcdH1cblx0fSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERCKCk6IFByb21pc2U8aWRiLlBhbGV0dGVEQj4ge1xuXHRyZXR1cm4gZGJQcm9taXNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXROZXh0VGFibGVJRCgpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRjb25zdCBzZXR0aW5ncyA9IGF3YWl0IGdldFNldHRpbmdzKCk7XG5cdGNvbnN0IG5leHRJRCA9IHNldHRpbmdzLmxhc3RUYWJsZUlEICsgMTtcblxuXHRhd2FpdCBzYXZlRGF0YSgnc2V0dGluZ3MnLCAnYXBwU2V0dGluZ3MnLCB7XG5cdFx0Li4uc2V0dGluZ3MsXG5cdFx0bGFzdFRhYmxlSUQ6IG5leHRJRFxuXHR9KTtcblxuXHRyZXR1cm4gYHBhbGV0dGVfJHtuZXh0SUR9YDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0Q3VycmVudFBhbGV0dGVJRCgpOiBQcm9taXNlPG51bWJlcj4ge1xuXHRjb25zdCBkYiA9IGF3YWl0IGdldERCKCk7XG5cdGNvbnN0IHNldHRpbmdzID0gYXdhaXQgZGIuZ2V0KCdzZXR0aW5ncycsICdhcHBTZXR0aW5ncycpO1xuXG5cdHJldHVybiBzZXR0aW5ncz8ubGFzdFBhbGV0dGVJRCA/PyAwO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRDdXN0b21Db2xvcigpOiBQcm9taXNlPGNvbG9ycy5IU0wgfCBudWxsPiB7XG5cdGNvbnN0IGRiID0gYXdhaXQgZ2V0REIoKTtcblx0Y29uc3QgZW50cnkgPSBhd2FpdCBkYi5nZXQoJ2N1c3RvbUNvbG9yJywgJ2N1c3RvbUNvbG9yJyk7XG5cblx0cmV0dXJuIGVudHJ5Py5jb2xvclxuXHRcdD8gY3JlYXRlTXV0YXRpb25Mb2dnZXIoZW50cnkuY29sb3IsICdjdXN0b21Db2xvcicpXG5cdFx0OiBudWxsO1xufVxuXG5mdW5jdGlvbiBnZXRMb2dnZWRPYmplY3Q8VCBleHRlbmRzIG9iamVjdD4oXG5cdG9iajogVCB8IG51bGwsXG5cdGtleTogc3RyaW5nXG4pOiBUIHwgbnVsbCB7XG5cdGlmIChvYmopIHtcblx0XHRyZXR1cm4gY3JlYXRlTXV0YXRpb25Mb2dnZXIob2JqLCBrZXkpO1xuXHR9XG5cblx0cmV0dXJuIG51bGw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNldHRpbmdzKCk6IFByb21pc2U8aWRiLlNldHRpbmdzPiB7XG5cdHRyeSB7XG5cdFx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXHRcdGNvbnN0IHNldHRpbmdzID0gYXdhaXQgZGIuZ2V0KCdzZXR0aW5ncycsICdhcHBTZXR0aW5ncycpO1xuXG5cdFx0cmV0dXJuIHNldHRpbmdzID8/IGRlZmF1bHRzLnNldHRpbmdzO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIHNldHRpbmdzOicsIGVycm9yKTtcblxuXHRcdHJldHVybiB7IGNvbG9yU3BhY2U6ICdoZXgnLCBsYXN0VGFibGVJRDogMCB9O1xuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFRhYmxlKGlkOiBzdHJpbmcpOiBQcm9taXNlPGlkYi5TdG9yZWRQYWxldHRlIHwgbnVsbD4ge1xuXHRjb25zdCBkYiA9IGF3YWl0IGdldERCKCk7XG5cdGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRiLmdldCgndGFibGVzJywgaWQpO1xuXG5cdGlmICghcmVzdWx0KSBjb25zb2xlLndhcm4oYFRhYmxlIHdpdGggSUQgJHtpZH0gbm90IGZvdW5kLmApO1xuXHRyZXR1cm4gcmVzdWx0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTdG9yZTxTdG9yZU5hbWUgZXh0ZW5kcyBrZXlvZiBpZGIuUGFsZXR0ZVNjaGVtYT4oXG5cdHN0b3JlTmFtZTogU3RvcmVOYW1lLFxuXHRtb2RlOiAncmVhZG9ubHknXG4pOiBQcm9taXNlPFxuXHRJREJQT2JqZWN0U3RvcmU8aWRiLlBhbGV0dGVTY2hlbWEsIFtTdG9yZU5hbWVdLCBTdG9yZU5hbWUsICdyZWFkb25seSc+XG4+O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRTdG9yZTxTdG9yZU5hbWUgZXh0ZW5kcyBrZXlvZiBpZGIuUGFsZXR0ZVNjaGVtYT4oXG5cdHN0b3JlTmFtZTogU3RvcmVOYW1lLFxuXHRtb2RlOiAncmVhZHdyaXRlJ1xuKTogUHJvbWlzZTxcblx0SURCUE9iamVjdFN0b3JlPGlkYi5QYWxldHRlU2NoZW1hLCBbU3RvcmVOYW1lXSwgU3RvcmVOYW1lLCAncmVhZHdyaXRlJz5cbj47XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFN0b3JlPFN0b3JlTmFtZSBleHRlbmRzIGtleW9mIGlkYi5QYWxldHRlU2NoZW1hPihcblx0c3RvcmVOYW1lOiBTdG9yZU5hbWUsXG5cdG1vZGU6ICdyZWFkb25seScgfCAncmVhZHdyaXRlJ1xuKSB7XG5cdGNvbnN0IGRiID0gYXdhaXQgZ2V0REIoKTtcblx0cmV0dXJuIGRiLnRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgbW9kZSkub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbG9nTXV0YXRpb24obG9nOiBpZGIuTXV0YXRpb25Mb2cpOiBQcm9taXNlPHZvaWQ+IHtcblx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXG5cdGF3YWl0IGRiLnB1dCgnbXV0YXRpb25zJywgbG9nKTtcblxuXHRjb25zb2xlLmxvZyhgTG9nZ2VkIG11dGF0aW9uOiAke0pTT04uc3RyaW5naWZ5KGxvZyl9YCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlbmRlclBhbGV0dGUodGFibGVJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG5cdHRyeSB7XG5cdFx0Y29uc3Qgc3RvcmVkUGFsZXR0ZSA9IGF3YWl0IGdldFRhYmxlKHRhYmxlSWQpO1xuXHRcdGNvbnN0IHBhbGV0dGVSb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFsZXR0ZS1yb3cnKTtcblxuXHRcdGlmICghc3RvcmVkUGFsZXR0ZSkgdGhyb3cgbmV3IEVycm9yKGBQYWxldHRlICR7dGFibGVJZH0gbm90IGZvdW5kLmApO1xuXHRcdGlmICghcGFsZXR0ZVJvdykgdGhyb3cgbmV3IEVycm9yKCdQYWxldHRlIHJvdyBlbGVtZW50IG5vdCBmb3VuZC4nKTtcblxuXHRcdHBhbGV0dGVSb3cuaW5uZXJIVE1MID0gJyc7XG5cblx0XHRjb25zdCBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTtcblx0XHRjb25zdCB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7XG5cdFx0dGFibGUuY2xhc3NMaXN0LmFkZCgncGFsZXR0ZS10YWJsZScpO1xuXG5cdFx0c3RvcmVkUGFsZXR0ZS5wYWxldHRlLml0ZW1zLmZvckVhY2goKGl0ZW0sIGluZGV4KSA9PiB7XG5cdFx0XHRjb25zdCByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpO1xuXHRcdFx0Y29uc3QgY2VsbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7XG5cdFx0XHRjb25zdCBjb2xvckJveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG5cdFx0XHRjZWxsLnRleHRDb250ZW50ID0gYENvbG9yICR7aW5kZXggKyAxfWA7XG5cdFx0XHRjb2xvckJveC5jbGFzc0xpc3QuYWRkKCdjb2xvci1ib3gnKTtcblx0XHRcdGNvbG9yQm94LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGl0ZW0uY3NzU3RyaW5ncy5oZXhDU1NTdHJpbmc7XG5cblx0XHRcdHJvdy5hcHBlbmRDaGlsZChjb2xvckJveCk7XG5cdFx0XHRyb3cuYXBwZW5kQ2hpbGQoY2VsbCk7XG5cdFx0XHR0YWJsZS5hcHBlbmRDaGlsZChyb3cpO1xuXHRcdH0pO1xuXG5cdFx0ZnJhZ21lbnQuYXBwZW5kQ2hpbGQodGFibGUpO1xuXHRcdHBhbGV0dGVSb3cuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpO1xuXG5cdFx0Y29uc29sZS5sb2coYFJlbmRlcmVkIHBhbGV0dGUgJHt0YWJsZUlkfS5gKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gcmVuZGVyIHBhbGV0dGU6ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2F2ZURhdGE8VD4oXG5cdHN0b3JlTmFtZToga2V5b2YgaWRiLlBhbGV0dGVTY2hlbWEsXG5cdGtleTogc3RyaW5nLFxuXHRkYXRhOiBULFxuXHRvbGRWYWx1ZT86IFRcbik6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IGRiID0gYXdhaXQgZ2V0REIoKTtcblx0XHRjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgJ3JlYWR3cml0ZScpO1xuXHRcdGNvbnN0IHN0b3JlID0gdHgub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcblxuXHRcdGF3YWl0IHN0b3JlLnB1dCh7IGtleSwgLi4uZGF0YSB9KTtcblx0XHRhd2FpdCB0eC5kb25lO1xuXG5cdFx0Y29uc29sZS5sb2coYCR7a2V5fSBzYXZlZCB0byAke3N0b3JlTmFtZX0uYCk7XG5cblx0XHRhd2FpdCBsb2dNdXRhdGlvbih7XG5cdFx0XHR0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcblx0XHRcdGtleSxcblx0XHRcdGFjdGlvbjogJ3VwZGF0ZScsXG5cdFx0XHRuZXdWYWx1ZTogZGF0YSxcblx0XHRcdG9sZFZhbHVlOiBvbGRWYWx1ZSA/IG9sZFZhbHVlIDogbnVsbCxcblx0XHRcdG9yaWdpbjogJ3NhdmVEYXRhJ1xuXHRcdH0pO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBzYXZlIGRhdGEgdG8gJHtzdG9yZU5hbWV9OmAsIGVycm9yKTtcblx0XHR0aHJvdyBlcnJvcjtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBzYXZlUGFsZXR0ZShcblx0aWQ6IHN0cmluZyxcblx0bmV3UGFsZXR0ZTogaWRiLlN0b3JlZFBhbGV0dGVcbik6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IHN0b3JlID0gYXdhaXQgZ2V0U3RvcmUoJ3RhYmxlcycsICdyZWFkd3JpdGUnKTtcblx0XHRjb25zdCBwYWxldHRlVG9TYXZlOiBpZGIuU3RvcmVkUGFsZXR0ZSA9IHtcblx0XHRcdHRhYmxlSUQ6IG5ld1BhbGV0dGUudGFibGVJRCxcblx0XHRcdHBhbGV0dGU6IG5ld1BhbGV0dGUucGFsZXR0ZVxuXHRcdH07XG5cblx0XHRhd2FpdCBzdG9yZS5wdXQoeyBrZXk6IGlkLCAuLi5wYWxldHRlVG9TYXZlIH0pO1xuXG5cdFx0Y29uc29sZS5sb2coYFBhbGV0dGUgJHtpZH0gc2F2ZWQgc3VjY2Vzc2Z1bGx5LmApO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBzYXZlIHBhbGV0dGUgJHtpZH06ICR7ZXJyb3J9YCk7XG5cdFx0dGhyb3cgZXJyb3I7XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2F2ZVBhbGV0dGVUb0RCKFxuXHR0eXBlOiBzdHJpbmcsXG5cdGl0ZW1zOiBwYWxldHRlLlBhbGV0dGVJdGVtW10sXG5cdGJhc2VDb2xvcjogY29sb3JzLkhTTCxcblx0bnVtQm94ZXM6IG51bWJlcixcblx0ZW5hYmxlQWxwaGE6IGJvb2xlYW4sXG5cdGxpbWl0QnJpZ2h0OiBib29sZWFuLFxuXHRsaW1pdERhcms6IGJvb2xlYW4sXG5cdGxpbWl0R3JheTogYm9vbGVhblxuKTogUHJvbWlzZTxwYWxldHRlLlBhbGV0dGU+IHtcblx0Y29uc3QgcGFsZXR0ZUlEID0gYXdhaXQgZ2V0TmV4dFBhbGV0dGVJRCgpO1xuXG5cdGNvbnN0IG5ld1BhbGV0dGUgPSBwYWxldHRlVXRpbHMuY3JlYXRlUGFsZXR0ZU9iamVjdChcblx0XHR0eXBlLFxuXHRcdGl0ZW1zLFxuXHRcdGJhc2VDb2xvcixcblx0XHRwYWxldHRlSUQsXG5cdFx0bnVtQm94ZXMsXG5cdFx0ZW5hYmxlQWxwaGEsXG5cdFx0bGltaXRCcmlnaHQsXG5cdFx0bGltaXREYXJrLFxuXHRcdGxpbWl0R3JheVxuXHQpO1xuXG5cdGF3YWl0IHNhdmVQYWxldHRlKG5ld1BhbGV0dGUuaWQsIHtcblx0XHR0YWJsZUlEOiBwYXJzZUludChuZXdQYWxldHRlLmlkLnNwbGl0KCdfJylbMV0pLFxuXHRcdHBhbGV0dGU6IG5ld1BhbGV0dGVcblx0fSk7XG5cblx0Y29uc29sZS5sb2coYFNhdmVkICR7dHlwZX0gcGFsZXR0ZTogJHtKU09OLnN0cmluZ2lmeShuZXdQYWxldHRlKX1gKTtcblxuXHRyZXR1cm4gbmV3UGFsZXR0ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2F2ZVNldHRpbmdzKG5ld1NldHRpbmdzOiBpZGIuU2V0dGluZ3MpOiBQcm9taXNlPHZvaWQ+IHtcblx0dHJ5IHtcblx0XHRhd2FpdCBzYXZlRGF0YSgnc2V0dGluZ3MnLCAnYXBwU2V0dGluZ3MnLCBuZXdTZXR0aW5ncyk7XG5cblx0XHRjb25zb2xlLmxvZygnU2V0dGluZ3MgdXBkYXRlZCcpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBzYXZlIHNldHRpbmdzOiAke2Vycm9yfWApO1xuXG5cdFx0dGhyb3cgZXJyb3I7XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdHJhY2tlZFRyYW5zYWN0aW9uPFN0b3JlTmFtZSBleHRlbmRzIGtleW9mIGlkYi5QYWxldHRlU2NoZW1hPihcblx0c3RvcmVOYW1lOiBTdG9yZU5hbWUsXG5cdG1vZGU6ICdyZWFkb25seScgfCAncmVhZHdyaXRlJyxcblx0Y2FsbGJhY2s6IChcblx0XHRzdG9yZTogSURCUE9iamVjdFN0b3JlPFxuXHRcdFx0aWRiLlBhbGV0dGVTY2hlbWEsXG5cdFx0XHRbU3RvcmVOYW1lXSxcblx0XHRcdFN0b3JlTmFtZSxcblx0XHRcdCdyZWFkb25seScgfCAncmVhZHdyaXRlJ1xuXHRcdD5cblx0KSA9PiBQcm9taXNlPHZvaWQ+XG4pOiBQcm9taXNlPHZvaWQ+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBzdG9yZSA9XG5cdFx0XHRtb2RlID09PSAncmVhZG9ubHknXG5cdFx0XHRcdD8gYXdhaXQgZ2V0U3RvcmUoc3RvcmVOYW1lLCAncmVhZG9ubHknKVxuXHRcdFx0XHQ6IGF3YWl0IGdldFN0b3JlKHN0b3JlTmFtZSwgJ3JlYWR3cml0ZScpO1xuXG5cdFx0YXdhaXQgY2FsbGJhY2soc3RvcmUpO1xuXG5cdFx0Y29uc29sZS5sb2coYFRyYW5zYWN0aW9uIG9uICR7c3RvcmVOYW1lfSBjb21wbGV0ZWQuYCk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgVHJhbnNhY3Rpb24gb24gJHtzdG9yZU5hbWV9IGZhaWxlZDogJHtlcnJvcn1gKTtcblxuXHRcdHRocm93IGVycm9yO1xuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE5leHRQYWxldHRlSUQoKTogUHJvbWlzZTxudW1iZXI+IHtcblx0Y29uc3QgY3VycmVudElEID0gYXdhaXQgZ2V0Q3VycmVudFBhbGV0dGVJRCgpO1xuXHRjb25zdCBuZXdJRCA9IGN1cnJlbnRJRCArIDE7XG5cblx0YXdhaXQgdXBkYXRlQ3VycmVudFBhbGV0dGVJRChuZXdJRCk7XG5cblx0cmV0dXJuIG5ld0lEO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0aWFsaXplQ3VycmVudFBhbGV0dGVJRCgpOiBQcm9taXNlPG51bWJlcj4ge1xuXHRyZXR1cm4gZ2V0Q3VycmVudFBhbGV0dGVJRCgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVDdXJyZW50UGFsZXR0ZUlEKG5ld0lEOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcblx0Y29uc3QgZGIgPSBhd2FpdCBnZXREQigpO1xuXHRjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdzZXR0aW5ncycsICdyZWFkd3JpdGUnKTtcblx0Y29uc3Qgc3RvcmUgPSB0eC5vYmplY3RTdG9yZSgnc2V0dGluZ3MnKTtcblxuXHRhd2FpdCBzdG9yZS5wdXQoeyBrZXk6ICdhcHBTZXR0aW5ncycsIGxhc3RQYWxldHRlSUQ6IG5ld0lEIH0pO1xuXHRhd2FpdCB0eC5kb25lO1xuXG5cdGNvbnNvbGUubG9nKGBDdXJyZW50IHBhbGV0dGUgSUQgdXBkYXRlZCB0byAke25ld0lEfWApO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVFbnRyeUluUGFsZXR0ZShcblx0dGFibGVJRDogc3RyaW5nLFxuXHRlbnRyeUluZGV4OiBudW1iZXIsXG5cdG5ld0VudHJ5OiBwYWxldHRlLlBhbGV0dGVJdGVtXG4pOiBQcm9taXNlPHZvaWQ+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBzdG9yZWRQYWxldHRlID0gYXdhaXQgZ2V0VGFibGUodGFibGVJRCk7XG5cblx0XHRpZiAoIXN0b3JlZFBhbGV0dGUpIHRocm93IG5ldyBFcnJvcihgUGFsZXR0ZSAke3RhYmxlSUR9IG5vdCBmb3VuZC5gKTtcblxuXHRcdGNvbnN0IHsgaXRlbXMgfSA9IHN0b3JlZFBhbGV0dGUucGFsZXR0ZTtcblxuXHRcdGlmIChlbnRyeUluZGV4ID49IGl0ZW1zLmxlbmd0aClcblx0XHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdFx0YEVudHJ5ICR7ZW50cnlJbmRleH0gbm90IGZvdW5kIGluIHBhbGV0dGUgJHt0YWJsZUlEfS5gXG5cdFx0XHQpO1xuXG5cdFx0Y29uc3Qgb2xkRW50cnkgPSBpdGVtc1tlbnRyeUluZGV4XTtcblx0XHRpdGVtc1tlbnRyeUluZGV4XSA9IG5ld0VudHJ5O1xuXG5cdFx0YXdhaXQgc2F2ZURhdGEoJ3RhYmxlcycsIHRhYmxlSUQsIHN0b3JlZFBhbGV0dGUpO1xuXHRcdGF3YWl0IGxvZ011dGF0aW9uKHtcblx0XHRcdHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuXHRcdFx0a2V5OiBgJHt0YWJsZUlEfS0ke2VudHJ5SW5kZXh9XWAsXG5cdFx0XHRhY3Rpb246ICd1cGRhdGUnLFxuXHRcdFx0bmV3VmFsdWU6IG5ld0VudHJ5LFxuXHRcdFx0b2xkVmFsdWU6IG9sZEVudHJ5LFxuXHRcdFx0b3JpZ2luOiAndXBkYXRlRW50cnlJblBhbGV0dGUnXG5cdFx0fSk7XG5cblx0XHRjb25zb2xlLmxvZyhgRW50cnkgJHtlbnRyeUluZGV4fSBpbiBwYWxldHRlICR7dGFibGVJRH0gdXBkYXRlZC5gKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gdXBkYXRlIGVudHJ5IGluIHBhbGV0dGU6ICR7ZXJyb3J9YCk7XG5cblx0XHR0aHJvdyBlcnJvcjtcblx0fVxufVxuXG5leHBvcnQgY29uc3QgZGF0YWJhc2U6IGZuT2JqZWN0cy5EYXRhYmFzZSA9IHtcblx0Y3JlYXRlTXV0YXRpb25Mb2dnZXIsXG5cdGRlbGV0ZVRhYmxlOiBhc3luYyAoaWQ6IHN0cmluZykgPT4ge1xuXHRcdGNvbnN0IGRiID0gYXdhaXQgZ2V0REIoKTtcblx0XHRhd2FpdCBkYi5kZWxldGUoJ3RhYmxlcycsIGlkKTtcblx0XHRjb25zb2xlLmxvZyhgVGFibGUgJHtpZH0gZGVsZXRlZC5gKTtcblx0fSxcblx0Z2V0Q3VycmVudFBhbGV0dGVJRCxcblx0Z2V0Q3VzdG9tQ29sb3IsXG5cdGdldERCLFxuXHRnZXRMb2dnZWRPYmplY3QsXG5cdGdldE5leHRQYWxldHRlSUQsXG5cdGdldE5leHRUYWJsZUlELFxuXHRnZXRTZXR0aW5ncyxcblx0Z2V0U3RvcmUsXG5cdGdldFRhYmxlLFxuXHRpbml0aWFsaXplQ3VycmVudFBhbGV0dGVJRCxcblx0bGlzdFRhYmxlczogYXN5bmMgKCkgPT4ge1xuXHRcdGNvbnN0IGRiID0gYXdhaXQgZ2V0REIoKTtcblx0XHRjb25zdCBrZXlzID0gYXdhaXQgZGIuZ2V0QWxsS2V5cygndGFibGVzJyk7XG5cdFx0cmV0dXJuIGtleXMubWFwKFN0cmluZyk7XG5cdH0sXG5cdGxvZ011dGF0aW9uLFxuXHRyZW5kZXJQYWxldHRlLFxuXHRzYXZlRGF0YSxcblx0c2F2ZVBhbGV0dGUsXG5cdHNhdmVQYWxldHRlVG9EQixcblx0c2F2ZVNldHRpbmdzLFxuXHR0cmFja2VkVHJhbnNhY3Rpb24sXG5cdHVwZGF0ZUN1cnJlbnRQYWxldHRlSUQsXG5cdHVwZGF0ZUVudHJ5SW5QYWxldHRlXG59O1xuIl19