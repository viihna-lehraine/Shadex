import { limits } from './limits.js';
import { genPalette } from './palettes.js';
import { defaults } from '../config/defaults.js';
import { database } from '../database/database.js';
import * as colors from '../index/colors.js';
import { colorUtils } from '../utils/color-utils.js';
import { commonUtils } from '../utils/common-utils.js';
import { domUtils } from '../utils/dom-utils.js';
import { randomHSL } from '../utils/random-color-utils.js';
function genLimitedHSL(baseHue, limitDark, limitLight, limitGray, alpha) {
    let hsl;
    do {
        hsl = {
            value: {
                hue: baseHue,
                saturation: Math.random() * 100,
                lightness: Math.random() * 100,
                alpha: alpha ?? 1
            },
            format: 'hsl'
        };
    } while ((limitGray && limits.isTooGray(hsl)) ||
        (limitDark && limits.isTooDark(hsl)) ||
        (limitLight && limits.isTooBright(hsl)));
    return hsl;
}
async function genSelectedPalette(options) {
    try {
        const { paletteType, numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray } = options;
        const palette = await genPalette();
        switch (paletteType) {
            case 1:
                return palette.random(numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray);
            case 2:
                return palette.complementary(numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray);
            case 3:
                return palette.triadic(numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray);
            case 4:
                return palette.tetradic(numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray);
            case 5:
                return palette.splitComplementary(numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray);
            case 6:
                return palette.analogous(numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray);
            case 7:
                return palette.hexadic(numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray);
            case 8:
                return palette.diadic(numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray);
            case 9:
                return palette.monochromatic(numBoxes, customColor, enableAlpha, limitBright, limitDark, limitGray);
            default:
                console.error('Invalid palette type.');
                return Promise.resolve(defaults.paletteData);
        }
    }
    catch (error) {
        console.error(`Error generating palette: ${error}`);
        return Promise.resolve(defaults.paletteData);
    }
}
async function startPaletteGen(options) {
    try {
        let { numBoxes, customColor } = options;
        if (customColor === null || customColor === undefined) {
            console.error('Custom color is null or undefined.');
            return;
        }
        const validatedCustomColor = validateAndConvertColor(customColor) ??
            randomHSL(options.enableAlpha);
        options.customColor = validatedCustomColor;
        const palette = await genSelectedPalette(options);
        if (palette.items.length === 0) {
            console.error('Colors array is empty or invalid.');
            return;
        }
        console.log(`Colors array generated: ${JSON.stringify(colors)}`);
        const tableId = await database.getNextTableID();
        await domUtils.genPaletteBox(palette.items, numBoxes, tableId);
    }
    catch (error) {
        console.error(`Error starting palette generation: ${error}`);
    }
}
function validateAndConvertColor(color) {
    if (!color)
        return null;
    const convertedColor = colorUtils.isColorString(color)
        ? colorUtils.colorStringToColor(color)
        : color;
    if (!commonUtils.validateColorValues(convertedColor)) {
        console.error(`Invalid color: ${JSON.stringify(convertedColor)}`);
        return null;
    }
    return convertedColor;
}
export const generate = {
    genLimitedHSL,
    genSelectedPalette,
    startPaletteGen,
    validateAndConvertColor
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcGFsZXR0ZS1nZW4vZ2VuZXJhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxLQUFLLE1BQU0sTUFBTSxpQkFBaUIsQ0FBQztBQUcxQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFeEQsU0FBUyxhQUFhLENBQ3JCLE9BQWUsRUFDZixTQUFrQixFQUNsQixVQUFtQixFQUNuQixTQUFrQixFQUNsQixLQUFvQjtJQUVwQixJQUFJLEdBQWUsQ0FBQztJQUVwQixHQUFHLENBQUM7UUFDSCxHQUFHLEdBQUc7WUFDTCxLQUFLLEVBQUU7Z0JBQ04sR0FBRyxFQUFFLE9BQU87Z0JBQ1osVUFBVSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxHQUFHO2dCQUMvQixTQUFTLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEdBQUc7Z0JBQzlCLEtBQUssRUFBRSxLQUFLLElBQUksQ0FBQzthQUNqQjtZQUNELE1BQU0sRUFBRSxLQUFLO1NBQ2IsQ0FBQztJQUNILENBQUMsUUFDQSxDQUFDLFNBQVMsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3BDLENBQUMs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LENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQztRQUN0RCxPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVsRSxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxPQUFPLGNBQWMsQ0FBQztBQUN2QixDQUFDO0FBRUQsTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUF1QjtJQUMzQyxhQUFhO0lBQ2Isa0JBQWtCO0lBQ2xCLGVBQWU7SUFDZix1QkFBdUI7Q0FDdkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxpbWl0cyB9IGZyb20gJy4vbGltaXRzJztcbmltcG9ydCB7IGdlblBhbGV0dGUgfSBmcm9tICcuL3BhbGV0dGVzJztcbmltcG9ydCB7IGRlZmF1bHRzIH0gZnJvbSAnLi4vY29uZmlnL2RlZmF1bHRzJztcbmltcG9ydCB7IGRhdGFiYXNlIH0gZnJvbSAnLi4vZGF0YWJhc2UvZGF0YWJhc2UnO1xuaW1wb3J0ICogYXMgY29sb3JzIGZyb20gJy4uL2luZGV4L2NvbG9ycyc7XG5pbXBvcnQgKiBhcyBmbk9iamVjdHMgZnJvbSAnLi4vaW5kZXgvZm4tb2JqZWN0cyc7XG5pbXBvcnQgKiBhcyBwYWxldHRlIGZyb20gJy4uL2luZGV4L3BhbGV0dGUnO1xuaW1wb3J0IHsgY29sb3JVdGlscyB9IGZyb20gJy4uL3V0aWxzL2NvbG9yLXV0aWxzJztcbmltcG9ydCB7IGNvbW1vblV0aWxzIH0gZnJvbSAnLi4vdXRpbHMvY29tbW9uLXV0aWxzJztcbmltcG9ydCB7IGRvbVV0aWxzIH0gZnJvbSAnLi4vdXRpbHMvZG9tLXV0aWxzJztcbmltcG9ydCB7IHJhbmRvbUhTTCB9IGZyb20gJy4uL3V0aWxzL3JhbmRvbS1jb2xvci11dGlscyc7XG5cbmZ1bmN0aW9uIGdlbkxpbWl0ZWRIU0woXG5cdGJhc2VIdWU6IG51bWJlcixcblx0bGltaXREYXJrOiBib29sZWFuLFxuXHRsaW1pdExpZ2h0OiBib29sZWFuLFxuXHRsaW1pdEdyYXk6IGJvb2xlYW4sXG5cdGFscGhhOiBudW1iZXIgfCBudWxsXG4pOiBjb2xvcnMuSFNMIHtcblx0bGV0IGhzbDogY29sb3JzLkhTTDtcblxuXHRkbyB7XG5cdFx0aHNsID0ge1xuXHRcdFx0dmFsdWU6IHtcblx0XHRcdFx0aHVlOiBiYXNlSHVlLFxuXHRcdFx0XHRzYXR1cmF0aW9uOiBNYXRoLnJhbmRvbSgpICogMTAwLFxuXHRcdFx0XHRsaWdodG5lc3M6IE1hdGgucmFuZG9tKCkgKiAxMDAsXG5cdFx0XHRcdGFscGhhOiBhbHBoYSA/PyAxXG5cdFx0XHR9LFxuXHRcdFx0Zm9ybWF0OiAnaHNsJ1xuXHRcdH07XG5cdH0gd2hpbGUgKFxuXHRcdChsaW1pdEdyYXkgJiYgbGltaXRzLmlzVG9vR3JheShoc2wpKSB8fFxuXHRcdChsaW1pdERhcmsgJiYgbGltaXRzLmlzVG9vRGFyayhoc2wpKSB8fFxuXHRcdChsaW1pdExpZ2h0ICYmIGxpbWl0cy5pc1Rvb0JyaWdodChoc2wpKVxuXHQpO1xuXG5cdHJldHVybiBoc2w7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlblNlbGVjdGVkUGFsZXR0ZShcblx0b3B0aW9uczogY29sb3JzLlBhbGV0dGVPcHRpb25zXG4pOiBQcm9taXNlPHBhbGV0dGUuUGFsZXR0ZT4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IHtcblx0XHRcdHBhbGV0dGVUeXBlLFxuXHRcdFx0bnVtQm94ZXMsXG5cdFx0XHRjdXN0b21Db2xvcixcblx0XHRcdGVuYWJsZUFscGhhLFxuXHRcdFx0bGltaXRCcmlnaHQsXG5cdFx0XHRsaW1pdERhcmssXG5cdFx0XHRsaW1pdEdyYXlcblx0XHR9ID0gb3B0aW9ucztcblxuXHRcdGNvbnN0IHBhbGV0dGUgPSBhd2FpdCBnZW5QYWxldHRlKCk7XG5cblx0XHRzd2l0Y2ggKHBhbGV0dGVUeXBlKSB7XG5cdFx0XHRjYXNlIDE6XG5cdFx0XHRcdHJldHVybiBwYWxldHRlLnJhbmRvbShcblx0XHRcdFx0XHRudW1Cb3hlcyxcblx0XHRcdFx0XHRjdXN0b21Db2xvcixcblx0XHRcdFx0XHRlbmFibGVBbHBoYSxcblx0XHRcdFx0XHRsaW1pdEJyaWdodCxcblx0XHRcdFx0XHRsaW1pdERhcmssXG5cdFx0XHRcdFx0bGltaXRHcmF5XG5cdFx0XHRcdCk7XG5cdFx0XHRjYXNlIDI6XG5cdFx0XHRcdHJldHVybiBwYWxldHRlLmNvbXBsZW1lbnRhcnkoXG5cdFx0XHRcdFx0bnVtQm94ZXMsXG5cdFx0XHRcdFx0Y3VzdG9tQ29sb3IsXG5cdFx0XHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRcdFx0bGltaXRCcmlnaHQsXG5cdFx0XHRcdFx0bGltaXREYXJrLFxuXHRcdFx0XHRcdGxpbWl0R3JheVxuXHRcdFx0XHQpO1xuXHRcdFx0Y2FzZSAzOlxuXHRcdFx0XHRyZXR1cm4gcGFsZXR0ZS50cmlhZGljKFxuXHRcdFx0XHRcdG51bUJveGVzLFxuXHRcdFx0XHRcdGN1c3RvbUNvbG9yLFxuXHRcdFx0XHRcdGVuYWJsZUFscGhhLFxuXHRcdFx0XHRcdGxpbWl0QnJpZ2h0LFxuXHRcdFx0XHRcdGxpbWl0RGFyayxcblx0XHRcdFx0XHRsaW1pdEdyYXlcblx0XHRcdFx0KTtcblx0XHRcdGNhc2UgNDpcblx0XHRcdFx0cmV0dXJuIHBhbGV0dGUudGV0cmFkaWMoXG5cdFx0XHRcdFx0bnVtQm94ZXMsXG5cdFx0XHRcdFx0Y3VzdG9tQ29sb3IsXG5cdFx0XHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRcdFx0bGltaXRCcmlnaHQsXG5cdFx0XHRcdFx0bGltaXREYXJrLFxuXHRcdFx0XHRcdGxpbWl0R3JheVxuXHRcdFx0XHQpO1xuXHRcdFx0Y2FzZSA1OlxuXHRcdFx0XHRyZXR1cm4gcGFsZXR0ZS5zcGxpdENvbXBsZW1lbnRhcnkoXG5cdFx0XHRcdFx0bnVtQm94ZXMsXG5cdFx0XHRcdFx0Y3VzdG9tQ29sb3IsXG5cdFx0XHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRcdFx0bGltaXRCcmlnaHQsXG5cdFx0XHRcdFx0bGltaXREYXJrLFxuXHRcdFx0XHRcdGxpbWl0R3JheVxuXHRcdFx0XHQpO1xuXHRcdFx0Y2FzZSA2OlxuXHRcdFx0XHRyZXR1cm4gcGFsZXR0ZS5hbmFsb2dvdXMoXG5cdFx0XHRcdFx0bnVtQm94ZXMsXG5cdFx0XHRcdFx0Y3VzdG9tQ29sb3IsXG5cdFx0XHRcdFx0ZW5hYmxlQWxwaGEsXG5cdFx0XHRcdFx0bGltaXRCcmlnaHQsXG5cdFx0XHRcdFx0bGltaXREYXJrLFxuXHRcdFx0XHRcdGxpbWl0R3JheVxuXHRcdFx0XHQpO1xuXHRcdFx0Y2FzZSA3OlxuXHRcdFx0XHRyZXR1cm4gcGFsZXR0ZS5oZXhhZGljKFxuXHRcdFx0XHRcdG51bUJveGVzLFxuXHRcdFx0XHRcdGN1c3RvbUNvbG9yLFxuXHRcdFx0XHRcdGVuYWJsZUFscGhhLFxuXHRcdFx0XHRcdGxpbWl0QnJpZ2h0LFxuXHRcdFx0XHRcdGxpbWl0RGFyayxcblx0XHRcdFx0XHRsaW1pdEdyYXlcblx0XHRcdFx0KTtcblx0XHRcdGNhc2UgODpcblx0XHRcdFx0cmV0dXJuIHBhbGV0dGUuZGlhZGljKFxuXHRcdFx0XHRcdG51bUJveGVzLFxuXHRcdFx0XHRcdGN1c3RvbUNvbG9yLFxuXHRcdFx0XHRcdGVuYWJsZUFscGhhLFxuXHRcdFx0XHRcdGxpbWl0QnJpZ2h0LFxuXHRcdFx0XHRcdGxpbWl0RGFyayxcblx0XHRcdFx0XHRsaW1pdEdyYXlcblx0XHRcdFx0KTtcblx0XHRcdGNhc2UgOTpcblx0XHRcdFx0cmV0dXJuIHBhbGV0dGUubW9ub2Nocm9tYXRpYyhcblx0XHRcdFx0XHRudW1Cb3hlcyxcblx0XHRcdFx0XHRjdXN0b21Db2xvcixcblx0XHRcdFx0XHRlbmFibGVBbHBoYSxcblx0XHRcdFx0XHRsaW1pdEJyaWdodCxcblx0XHRcdFx0XHRsaW1pdERhcmssXG5cdFx0XHRcdFx0bGltaXRHcmF5XG5cdFx0XHRcdCk7XG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRjb25zb2xlLmVycm9yKCdJbnZhbGlkIHBhbGV0dGUgdHlwZS4nKTtcblxuXHRcdFx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRlZmF1bHRzLnBhbGV0dGVEYXRhKTtcblx0XHR9XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgRXJyb3IgZ2VuZXJhdGluZyBwYWxldHRlOiAke2Vycm9yfWApO1xuXG5cdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZShkZWZhdWx0cy5wYWxldHRlRGF0YSk7XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc3RhcnRQYWxldHRlR2VuKG9wdGlvbnM6IGNvbG9ycy5QYWxldHRlT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGxldCB7IG51bUJveGVzLCBjdXN0b21Db2xvciB9ID0gb3B0aW9ucztcblxuXHRcdGlmIChjdXN0b21Db2xvciA9PT0gbnVsbCB8fCBjdXN0b21Db2xvciA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKCdDdXN0b20gY29sb3IgaXMgbnVsbCBvciB1bmRlZmluZWQuJyk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCB2YWxpZGF0ZWRDdXN0b21Db2xvcjogY29sb3JzLkhTTCA9XG5cdFx0XHQodmFsaWRhdGVBbmRDb252ZXJ0Q29sb3IoY3VzdG9tQ29sb3IpIGFzIGNvbG9ycy5IU0wpID8/XG5cdFx0XHRyYW5kb21IU0wob3B0aW9ucy5lbmFibGVBbHBoYSk7XG5cblx0XHRvcHRpb25zLmN1c3RvbUNvbG9yID0gdmFsaWRhdGVkQ3VzdG9tQ29sb3I7XG5cblx0XHRjb25zdCBwYWxldHRlID0gYXdhaXQgZ2VuU2VsZWN0ZWRQYWxldHRlKG9wdGlvbnMpO1xuXG5cdFx0aWYgKHBhbGV0dGUuaXRlbXMubGVuZ3RoID09PSAwKSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKCdDb2xvcnMgYXJyYXkgaXMgZW1wdHkgb3IgaW52YWxpZC4nKTtcblxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnNvbGUubG9nKGBDb2xvcnMgYXJyYXkgZ2VuZXJhdGVkOiAke0pTT04uc3RyaW5naWZ5KGNvbG9ycyl9YCk7XG5cblx0XHRjb25zdCB0YWJsZUlkID0gYXdhaXQgZGF0YWJhc2UuZ2V0TmV4dFRhYmxlSUQoKTtcblxuXHRcdGF3YWl0IGRvbVV0aWxzLmdlblBhbGV0dGVCb3gocGFsZXR0ZS5pdGVtcywgbnVtQm94ZXMsIHRhYmxlSWQpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGNvbnNvbGUuZXJyb3IoYEVycm9yIHN0YXJ0aW5nIHBhbGV0dGUgZ2VuZXJhdGlvbjogJHtlcnJvcn1gKTtcblx0fVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUFuZENvbnZlcnRDb2xvcihcblx0Y29sb3I6IGNvbG9ycy5Db2xvciB8IGNvbG9ycy5Db2xvclN0cmluZyB8IG51bGxcbik6IGNvbG9ycy5Db2xvciB8IG51bGwge1xuXHRpZiAoIWNvbG9yKSByZXR1cm4gbnVsbDtcblxuXHRjb25zdCBjb252ZXJ0ZWRDb2xvciA9IGNvbG9yVXRpbHMuaXNDb2xvclN0cmluZyhjb2xvcilcblx0XHQ/IGNvbG9yVXRpbHMuY29sb3JTdHJpbmdUb0NvbG9yKGNvbG9yKVxuXHRcdDogY29sb3I7XG5cblx0aWYgKCFjb21tb25VdGlscy52YWxpZGF0ZUNvbG9yVmFsdWVzKGNvbnZlcnRlZENvbG9yKSkge1xuXHRcdGNvbnNvbGUuZXJyb3IoYEludmFsaWQgY29sb3I6ICR7SlNPTi5zdHJpbmdpZnkoY29udmVydGVkQ29sb3IpfWApO1xuXG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblxuXHRyZXR1cm4gY29udmVydGVkQ29sb3I7XG59XG5cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZTogZm5PYmplY3RzLkdlbmVyYXRlID0ge1xuXHRnZW5MaW1pdGVkSFNMLFxuXHRnZW5TZWxlY3RlZFBhbGV0dGUsXG5cdHN0YXJ0UGFsZXR0ZUdlbixcblx0dmFsaWRhdGVBbmRDb252ZXJ0Q29sb3Jcbn07XG4iXX0=