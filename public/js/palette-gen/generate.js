import { genPalette } from './palettes.js';
import { defaults } from '../config/defaults.js';
import { domFn } from '../dom/dom-main.js';
import { idbFn } from '../dom/idb-fn.js';
import { domHelpers } from '../helpers/dom.js';
import { paletteHelpers } from '../helpers/palette.js';
import * as colors from '../index/colors.js';
import { genRandomColor } from '../utils/color-randomizer.js';
import { transform } from '../utils/transform.js';
import { guards } from '../utils/type-guards.js';
async function genPaletteBox(items, numBoxes, tableId) {
    try {
        const paletteRow = document.getElementById('palette-row');
        if (!paletteRow) {
            console.error('paletteRow is undefined.');
            return;
        }
        paletteRow.innerHTML = '';
        const fragment = document.createDocumentFragment();
        items.slice(0, numBoxes).forEach((item, i) => {
            const { color } = item;
            const { colorStripe } = domHelpers.makePaletteBox(color, i + 1);
            fragment.appendChild(colorStripe);
            domFn.populateColorTextOutputBox(color, i + 1);
        });
        paletteRow.appendChild(fragment);
        console.log('Palette boxes generated and rendered.');
        await idbFn.saveData('tables', tableId, { palette: items });
    }
    catch (error) {
        console.error(`Error generating palette box: ${error}`);
    }
}
function genSelectedPalette(options) {
    try {
        const { paletteType, numBoxes, customColor, colorSpace } = options;
        if (customColor === null || customColor === undefined) {
            console.error('Custom color is null or undefined.');
            return Promise.resolve(defaults.defaultPalette);
        }
        switch (paletteType) {
            case 1:
                return genPalette().random(numBoxes, customColor, colorSpace);
            case 2:
                return genPalette().complementary(numBoxes, customColor, colorSpace);
            case 3:
                return genPalette().triadic(numBoxes, customColor, colorSpace);
            case 4:
                return genPalette().tetradic(numBoxes, customColor, colorSpace);
            case 5:
                return genPalette().splitComplementary(numBoxes, customColor, colorSpace);
            case 6:
                return genPalette().analogous(numBoxes, customColor, colorSpace);
            case 7:
                return genPalette().hexadic(numBoxes, customColor, colorSpace);
            case 8:
                return genPalette().diadic(numBoxes, customColor, colorSpace);
            case 9:
                return genPalette().monochromatic(numBoxes, customColor, colorSpace);
            default:
                console.error('Invalid palette type.');
                return Promise.resolve(defaults.defaultPalette);
        }
    }
    catch (error) {
        console.error(`Error generating palette: ${error}`);
        return Promise.resolve(defaults.defaultPalette);
    }
}
async function startPaletteGen(options) {
    try {
        const { paletteType, numBoxes, colorSpace, customColor } = options;
        if (customColor === null || customColor === undefined) {
            console.error('Custom color is null or undefined.');
            return;
        }
        const validatedCustomColor = validateAndConvertColor(customColor) ?? genRandomColor(colorSpace);
        const palette = await genSelectedPalette({
            paletteType,
            numBoxes,
            customColor: validatedCustomColor,
            colorSpace
        });
        if (palette.items.length === 0) {
            console.error('Colors array is empty or invalid.');
            return;
        }
        console.log(`Colors array generated: ${JSON.stringify(colors)}`);
        const tableId = await idbFn.getNextTableID();
        await genPaletteBox(palette.items, numBoxes, tableId);
    }
    catch (error) {
        console.error(`Error starting palette generation: ${error}`);
    }
}
function validateAndConvertColor(color) {
    if (!color)
        return null;
    const convertedColor = guards.isColorString(color)
        ? transform.colorStringToColor(color)
        : color;
    if (!paletteHelpers.validateColorValues(convertedColor)) {
        console.error(`Invalid color: ${JSON.stringify(convertedColor)}`);
        return null;
    }
    return convertedColor;
}
export const generate = {
    genPaletteBox,
    genSelectedPalette,
    startPaletteGen,
    validateAndConvertColor
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcGFsZXR0ZS1nZW4vZ2VuZXJhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN4QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDOUMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEtBQUssTUFBTSxNQUFNLGlCQUFpQixDQUFDO0FBRzFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTlDLEtBQUssVUFBVSxhQUFhLENBQzNCLEtBQTRCLEVBQzVCLFFBQWdCLEVBQ2hCLE9BQWU7SUFFZixJQUFJLENBQUM7UUFDSixNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTFELElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNqQixPQUFPLENBQUMsS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7WUFFMUMsT0FBTztRQUNSLENBQUM7UUFFRCxVQUFVLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUUxQixNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztRQUVuRCxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxP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LEVBQUUsQ0FBQztRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQzlELENBQUM7QUFDRixDQUFDO0FBRUQsU0FBUyx1QkFBdUIsQ0FDL0IsS0FBK0M7SUFFL0MsSUFBSSxDQUFDLEtBQUs7UUFBRSxPQUFPLElBQUksQ0FBQztJQUV4QixNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQztRQUNqRCxDQUFDLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQztRQUNyQyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBRVQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDO1FBQ3pELE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xFLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVELE9BQU8sY0FBYyxDQUFDO0FBQ3ZCLENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQXVCO0lBQzNDLGFBQWE7SUFDYixrQkFBa0I7SUFDbEIsZUFBZTtJQUNmLHVCQUF1QjtDQUN2QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2VuUGFsZXR0ZSB9IGZyb20gJy4vcGFsZXR0ZXMnO1xuaW1wb3J0IHsgZGVmYXVsdHMgfSBmcm9tICcuLi9jb25maWcvZGVmYXVsdHMnO1xuaW1wb3J0IHsgZG9tRm4gfSBmcm9tICcuLi9kb20vZG9tLW1haW4nO1xuaW1wb3J0IHsgaWRiRm4gfSBmcm9tICcuLi9kb20vaWRiLWZuJztcbmltcG9ydCB7IGRvbUhlbHBlcnMgfSBmcm9tICcuLi9oZWxwZXJzL2RvbSc7XG5pbXBvcnQgeyBwYWxldHRlSGVscGVycyB9IGZyb20gJy4uL2hlbHBlcnMvcGFsZXR0ZSc7XG5pbXBvcnQgKiBhcyBjb2xvcnMgZnJvbSAnLi4vaW5kZXgvY29sb3JzJztcbmltcG9ydCAqIGFzIGZuT2JqZWN0cyBmcm9tICcuLi9pbmRleC9mbi1vYmplY3RzJztcbmltcG9ydCAqIGFzIHBhbGV0dGUgZnJvbSAnLi4vaW5kZXgvcGFsZXR0ZSc7XG5pbXBvcnQgeyBnZW5SYW5kb21Db2xvciB9IGZyb20gJy4uL3V0aWxzL2NvbG9yLXJhbmRvbWl6ZXInO1xuaW1wb3J0IHsgdHJhbnNmb3JtIH0gZnJvbSAnLi4vdXRpbHMvdHJhbnNmb3JtJztcbmltcG9ydCB7IGd1YXJkcyB9IGZyb20gJy4uL3V0aWxzL3R5cGUtZ3VhcmRzJztcblxuYXN5bmMgZnVuY3Rpb24gZ2VuUGFsZXR0ZUJveChcblx0aXRlbXM6IHBhbGV0dGUuUGFsZXR0ZUl0ZW1bXSxcblx0bnVtQm94ZXM6IG51bWJlcixcblx0dGFibGVJZDogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBwYWxldHRlUm93ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhbGV0dGUtcm93Jyk7XG5cblx0XHRpZiAoIXBhbGV0dGVSb3cpIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoJ3BhbGV0dGVSb3cgaXMgdW5kZWZpbmVkLicpO1xuXG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0cGFsZXR0ZVJvdy5pbm5lckhUTUwgPSAnJztcblxuXHRcdGNvbnN0IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO1xuXG5cdFx0aXRlbXMuc2xpY2UoMCwgbnVtQm94ZXMpLmZvckVhY2goKGl0ZW0sIGkpID0+IHtcblx0XHRcdGNvbnN0IHsgY29sb3IgfSA9IGl0ZW07XG5cdFx0XHRjb25zdCB7IGNvbG9yU3RyaXBlIH0gPSBkb21IZWxwZXJzLm1ha2VQYWxldHRlQm94KGNvbG9yLCBpICsgMSk7XG5cdFx0XHRmcmFnbWVudC5hcHBlbmRDaGlsZChjb2xvclN0cmlwZSk7XG5cdFx0XHRkb21Gbi5wb3B1bGF0ZUNvbG9yVGV4dE91dHB1dEJveChjb2xvciwgaSArIDEpO1xuXHRcdH0pO1xuXG5cdFx0cGFsZXR0ZVJvdy5hcHBlbmRDaGlsZChmcmFnbWVudCk7XG5cblx0XHRjb25zb2xlLmxvZygnUGFsZXR0ZSBib3hlcyBnZW5lcmF0ZWQgYW5kIHJlbmRlcmVkLicpO1xuXG5cdFx0YXdhaXQgaWRiRm4uc2F2ZURhdGEoJ3RhYmxlcycsIHRhYmxlSWQsIHsgcGFsZXR0ZTogaXRlbXMgfSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgRXJyb3IgZ2VuZXJhdGluZyBwYWxldHRlIGJveDogJHtlcnJvcn1gKTtcblx0fVxufVxuXG5mdW5jdGlvbiBnZW5TZWxlY3RlZFBhbGV0dGUoXG5cdG9wdGlvbnM6IGNvbG9ycy5QYWxldHRlT3B0aW9uc1xuKTogUHJvbWlzZTxwYWxldHRlLlBhbGV0dGU+IHtcblx0dHJ5IHtcblx0XHRjb25zdCB7IHBhbGV0dGVUeXBlLCBudW1Cb3hlcywgY3VzdG9tQ29sb3IsIGNvbG9yU3BhY2UgfSA9IG9wdGlvbnM7XG5cblx0XHRpZiAoY3VzdG9tQ29sb3IgPT09IG51bGwgfHwgY3VzdG9tQ29sb3IgPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0Y29uc29sZS5lcnJvcignQ3VzdG9tIGNvbG9yIGlzIG51bGwgb3IgdW5kZWZpbmVkLicpO1xuXG5cdFx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRlZmF1bHRzLmRlZmF1bHRQYWxldHRlKTtcblx0XHR9XG5cblx0XHRzd2l0Y2ggKHBhbGV0dGVUeXBlKSB7XG5cdFx0XHRjYXNlIDE6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlKCkucmFuZG9tKG51bUJveGVzLCBjdXN0b21Db2xvciwgY29sb3JTcGFjZSk7XG5cdFx0XHRjYXNlIDI6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlKCkuY29tcGxlbWVudGFyeShcblx0XHRcdFx0XHRudW1Cb3hlcyxcblx0XHRcdFx0XHRjdXN0b21Db2xvcixcblx0XHRcdFx0XHRjb2xvclNwYWNlXG5cdFx0XHRcdCk7XG5cdFx0XHRjYXNlIDM6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlKCkudHJpYWRpYyhudW1Cb3hlcywgY3VzdG9tQ29sb3IsIGNvbG9yU3BhY2UpO1xuXHRcdFx0Y2FzZSA0OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZSgpLnRldHJhZGljKG51bUJveGVzLCBjdXN0b21Db2xvciwgY29sb3JTcGFjZSk7XG5cdFx0XHRjYXNlIDU6XG5cdFx0XHRcdHJldHVybiBnZW5QYWxldHRlKCkuc3BsaXRDb21wbGVtZW50YXJ5KFxuXHRcdFx0XHRcdG51bUJveGVzLFxuXHRcdFx0XHRcdGN1c3RvbUNvbG9yLFxuXHRcdFx0XHRcdGNvbG9yU3BhY2Vcblx0XHRcdFx0KTtcblx0XHRcdGNhc2UgNjpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGUoKS5hbmFsb2dvdXMoXG5cdFx0XHRcdFx0bnVtQm94ZXMsXG5cdFx0XHRcdFx0Y3VzdG9tQ29sb3IsXG5cdFx0XHRcdFx0Y29sb3JTcGFjZVxuXHRcdFx0XHQpO1xuXHRcdFx0Y2FzZSA3OlxuXHRcdFx0XHRyZXR1cm4gZ2VuUGFsZXR0ZSgpLmhleGFkaWMobnVtQm94ZXMsIGN1c3RvbUNvbG9yLCBjb2xvclNwYWNlKTtcblx0XHRcdGNhc2UgODpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGUoKS5kaWFkaWMobnVtQm94ZXMsIGN1c3RvbUNvbG9yLCBjb2xvclNwYWNlKTtcblx0XHRcdGNhc2UgOTpcblx0XHRcdFx0cmV0dXJuIGdlblBhbGV0dGUoKS5tb25vY2hyb21hdGljKFxuXHRcdFx0XHRcdG51bUJveGVzLFxuXHRcdFx0XHRcdGN1c3RvbUNvbG9yLFxuXHRcdFx0XHRcdGNvbG9yU3BhY2Vcblx0XHRcdFx0KTtcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgcGFsZXR0ZSB0eXBlLicpO1xuXG5cdFx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoZGVmYXVsdHMuZGVmYXVsdFBhbGV0dGUpO1xuXHRcdH1cblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRjb25zb2xlLmVycm9yKGBFcnJvciBnZW5lcmF0aW5nIHBhbGV0dGU6ICR7ZXJyb3J9YCk7XG5cblx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRlZmF1bHRzLmRlZmF1bHRQYWxldHRlKTtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydFBhbGV0dGVHZW4ob3B0aW9uczogY29sb3JzLlBhbGV0dGVPcHRpb25zKTogUHJvbWlzZTx2b2lkPiB7XG5cdHRyeSB7XG5cdFx0Y29uc3QgeyBwYWxldHRlVHlwZSwgbnVtQm94ZXMsIGNvbG9yU3BhY2UsIGN1c3RvbUNvbG9yIH0gPSBvcHRpb25zO1xuXG5cdFx0aWYgKGN1c3RvbUNvbG9yID09PSBudWxsIHx8IGN1c3RvbUNvbG9yID09PSB1bmRlZmluZWQpIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoJ0N1c3RvbSBjb2xvciBpcyBudWxsIG9yIHVuZGVmaW5lZC4nKTtcblxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnN0IHZhbGlkYXRlZEN1c3RvbUNvbG9yID1cblx0XHRcdHZhbGlkYXRlQW5kQ29udmVydENvbG9yKGN1c3RvbUNvbG9yKSA/PyBnZW5SYW5kb21Db2xvcihjb2xvclNwYWNlKTtcblxuXHRcdGNvbnN0IHBhbGV0dGUgPSBhd2FpdCBnZW5TZWxlY3RlZFBhbGV0dGUoe1xuXHRcdFx0cGFsZXR0ZVR5cGUsXG5cdFx0XHRudW1Cb3hlcyxcblx0XHRcdGN1c3RvbUNvbG9yOiB2YWxpZGF0ZWRDdXN0b21Db2xvcixcblx0XHRcdGNvbG9yU3BhY2Vcblx0XHR9KTtcblxuXHRcdGlmIChwYWxldHRlLml0ZW1zLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0Y29uc29sZS5lcnJvcignQ29sb3JzIGFycmF5IGlzIGVtcHR5IG9yIGludmFsaWQuJyk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zb2xlLmxvZyhgQ29sb3JzIGFycmF5IGdlbmVyYXRlZDogJHtKU09OLnN0cmluZ2lmeShjb2xvcnMpfWApO1xuXG5cdFx0Y29uc3QgdGFibGVJZCA9IGF3YWl0IGlkYkZuLmdldE5leHRUYWJsZUlEKCk7XG5cblx0XHRhd2FpdCBnZW5QYWxldHRlQm94KHBhbGV0dGUuaXRlbXMsIG51bUJveGVzLCB0YWJsZUlkKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRjb25zb2xlLmVycm9yKGBFcnJvciBzdGFydGluZyBwYWxldHRlIGdlbmVyYXRpb246ICR7ZXJyb3J9YCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVBbmRDb252ZXJ0Q29sb3IoXG5cdGNvbG9yOiBjb2xvcnMuQ29sb3IgfCBjb2xvcnMuQ29sb3JTdHJpbmcgfCBudWxsXG4pOiBjb2xvcnMuQ29sb3IgfCBudWxsIHtcblx0aWYgKCFjb2xvcikgcmV0dXJuIG51bGw7XG5cblx0Y29uc3QgY29udmVydGVkQ29sb3IgPSBndWFyZHMuaXNDb2xvclN0cmluZyhjb2xvcilcblx0XHQ/IHRyYW5zZm9ybS5jb2xvclN0cmluZ1RvQ29sb3IoY29sb3IpXG5cdFx0OiBjb2xvcjtcblxuXHRpZiAoIXBhbGV0dGVIZWxwZXJzLnZhbGlkYXRlQ29sb3JWYWx1ZXMoY29udmVydGVkQ29sb3IpKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgSW52YWxpZCBjb2xvcjogJHtKU09OLnN0cmluZ2lmeShjb252ZXJ0ZWRDb2xvcil9YCk7XG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblxuXHRyZXR1cm4gY29udmVydGVkQ29sb3I7XG59XG5cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZTogZm5PYmplY3RzLkdlbmVyYXRlID0ge1xuXHRnZW5QYWxldHRlQm94LFxuXHRnZW5TZWxlY3RlZFBhbGV0dGUsXG5cdHN0YXJ0UGFsZXR0ZUdlbixcblx0dmFsaWRhdGVBbmRDb252ZXJ0Q29sb3Jcbn07XG4iXX0=