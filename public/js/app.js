// ColorGen - version 0.6.0-dev
import { core, utils } from './common/index.js';
import { data } from './data/index.js';
import { dom } from './dom/index.js';
import { IDBManager } from './idb/index.js';
import { logger } from './logger/index.js';
import { start } from './palette/index.js';
const buttonIDs = data.consts.dom.ids;
const consts = data.consts;
const mode = data.mode;
document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM content loaded - Initializing application');
    await dom.loadPartials();
    if (!mode.quiet)
        console.log('HTML partials loaded. Initializing UI...');
    const buttonElements = dom.defineUIElements();
    if (!buttonElements) {
        if (mode.errorLogs)
            console.error('Failed to initialize UI buttons');
        return;
    }
    await dom.initializeUI();
    if (!mode.quiet)
        console.log('UI successfully initialized');
    const idb = IDBManager.getInstance();
    if (!buttonElements) {
        console.error('Failed to initialize UI buttons');
        return;
    }
    const selectedColorOption = consts.dom.elements.selectedColorOption;
    if (mode.debug) {
        logger.debug.validateDOMElements();
        if (mode.verbose) {
            logger.verbose.validateDOMElements();
        }
    }
    else {
        if (!mode.quiet) {
            console.log('Skipping DOM element validation');
        }
    }
    const selectedColor = selectedColorOption
        ? parseInt(selectedColorOption.value, 10)
        : 0;
    if (!mode.quiet)
        console.log(`Selected color: ${selectedColor}`);
    try {
        dom.addConversionButtonEventListeners();
        if (!mode.quiet)
            console.log('Conversion button event listeners attached');
    }
    catch (error) {
        if (mode.errorLogs)
            console.error(`Unable to attach conversion button event listeners: ${error}`);
    }
    // show advanced menu
    dom.buttons.addEventListener(buttonIDs.advancedMenuButton, 'click', async (e) => {
        e.preventDefault();
        const advancedMenuContent = document.querySelector('.advanced-menu-content');
        if (advancedMenuContent) {
            const isHidden = getComputedStyle(advancedMenuContent).display === 'none';
            advancedMenuContent.style.display = isHidden ? 'flex' : 'none';
        }
        if (!mode.quiet)
            console.log('advancedMenuButton clicked');
    });
    // apply custom color
    dom.buttons.addEventListener(buttonIDs.applyCustomColorButton, 'click', async (e) => {
        e.preventDefault();
        const customHSLColor = dom.applyCustomColor();
        const customHSLColorClone = core.base.clone(customHSLColor);
        await idb.saveData('customColor', 'appSettings', customHSLColorClone);
        if (!mode.quiet)
            console.log('Custom color saved to IndexedDB');
        // *DEV-NOTE* unfinished
    });
    // clear custom color
    dom.buttons.addEventListener(buttonIDs.clearCustomColorButton, 'click', async (e) => {
        e.preventDefault();
        consts.dom.elements.customColorInput.value = '#ff0000';
        if (!mode.quiet)
            console.log('Custom color cleared');
    });
    // close custom color menu
    dom.buttons.addEventListener(buttonIDs.closeCustomColorMenuButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('closeCustomColorMenuButton clicked');
        consts.dom.elements.customColorMenu?.classList.add('hidden');
    });
    // close help menu
    dom.buttons.addEventListener(buttonIDs.closeHelpMenuButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('closeHelpMenuButton clicked');
        consts.dom.elements.advancedMenu?.classList.add('hidden');
    });
    // close history menu
    dom.buttons.addEventListener(buttonIDs.closeHistoryMenuButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('closeHistoryMenuButton clicked');
        consts.dom.elements.historyMenu?.classList.add('hidden');
    });
    if (!consts.dom.elements.customColorInput)
        throw new Error('Custom color input element not found');
    consts.dom.elements.customColorInput.addEventListener('input', () => {
        if (!consts.dom.elements.customColorDisplay)
            throw new Error('Custom color display element not found');
        consts.dom.elements.customColorDisplay.textContent =
            consts.dom.elements.customColorInput.value;
    });
    // display custom color menu
    dom.buttons.addEventListener(buttonIDs.customColorMenuButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('customColorMenuButton clicked');
        consts.dom.elements.customColorMenu?.classList.remove('hidden');
    });
    // desaturate Button
    dom.buttons.addEventListener(buttonIDs.desaturateButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('desaturateButton clicked');
        dom.desaturateColor(selectedColor);
    });
    // MAIN - generate palette
    dom.buttons.addEventListener(buttonIDs.generateButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('generateButton clicked');
        const { paletteType, numBoxes, enableAlpha, limitDarkness, limitGrayness, limitLightness } = dom.pullParamsFromUI();
        let customColor = (await idb.getCustomColor());
        if (!customColor) {
            if (!mode.quiet)
                console.info('No custom color found. Using a random color');
            customColor = utils.random.hsl(true);
        }
        const paletteOptions = {
            paletteType,
            numBoxes,
            customColor: core.base.clone(customColor),
            enableAlpha,
            limitDarkness,
            limitGrayness,
            limitLightness
        };
        await start.genPalette(paletteOptions);
    });
    // open Help Menu
    dom.buttons.addEventListener(buttonIDs.helpMenuButton, 'click', async (e) => {
        e.preventDefault();
        const helpMenuContent = document.querySelector('.help-menu-content');
        if (helpMenuContent) {
            const isHidden = getComputedStyle(helpMenuContent).display === 'none';
            helpMenuContent.style.display = isHidden ? 'flex' : 'none';
            if (!mode.quiet)
                console.log('helpMenuButton clicked');
        }
    });
    // open History Menu
    dom.buttons.addEventListener(buttonIDs.historyMenuButton, 'click', async (e) => {
        e.preventDefault();
        const historyMenuContent = document.querySelector('.history-menu-content');
        if (historyMenuContent) {
            const isHidden = getComputedStyle(historyMenuContent).display === 'none';
            historyMenuContent.style.display = isHidden ? 'flex' : 'none';
        }
        if (!mode.quiet)
            console.log('historyMenuToggleButton clicked');
    });
    // saturate selected color
    dom.buttons.addEventListener(buttonIDs.saturateButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('saturateButton clicked');
        dom.saturateColor(selectedColor);
    });
    dom.buttons.addEventListener(buttonIDs.showAsCMYKButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('showAsCMYKButton clicked');
        // *DEV-NOTE* unfinished
    });
    dom.buttons.addEventListener(buttonIDs.showAsHexButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('showAsHexButton clicked');
        // *DEV-NOTE* unfinished
    });
    dom.buttons.addEventListener(buttonIDs.showAsHSLButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('showAsHSLButton clicked');
        // *DEV-NOTE* unfinished
    });
    dom.buttons.addEventListener(buttonIDs.showAsHSVButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('showAsHSVButton clicked');
        // *DEV-NOTE* unfinished
    });
    dom.buttons.addEventListener(buttonIDs.showAsLABButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('showAsLABButton clicked');
        // *DEV-NOTE* unfinished
    });
    dom.buttons.addEventListener(buttonIDs.showAsRGBButton, 'click', async (e) => {
        e.preventDefault();
        if (!mode.quiet)
            console.log('showAsRGBButton clicked');
        // *DEV-NOTE* unfinished
    });
    // close Custom Color Menu when clicking outside the content
    window.addEventListener('click', async (e) => {
        if (consts.dom.elements.customColorMenu)
            if (e.target === consts.dom.elements.customColorMenu)
                consts.dom.elements.customColorMenu.classList.add('hidden');
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSwrQkFBK0I7QUFZL0IsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDdkMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRTNDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztBQUN0QyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO0FBQzNCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7QUFFdkIsUUFBUSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixFQUFFLEtBQUssSUFBSSxFQUFFO0lBQ3hELE9BQU8sQ0FBQyxHQUFHLENBQUMsK0NBQStDLENBQUMsQ0FBQztJQUU3RCxNQUFNLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUV6QixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUs7UUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7SUFFekUsTUFBTSxjQUFjLEdBQUcsR0FBRyxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFFOUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3JCLElBQUksSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7UUFFckUsT0FBTztJQUNSLENBQUM7SUFF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LGVBQWUsRUFDekIsT0FBTyxFQUNQLEtBQUssRUFBRSxDQUFhLEVBQUUsRUFBRTtRQUN2QixDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLO1lBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBRXhELHdCQUF3QjtJQUN6QixDQUFDLENBQ0QsQ0FBQztJQUVGLEdBQUcsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQzNCLFNBQVMsQ0FBQyxlQUFlLEVBQ3pCLE9BQU8sRUFDUCxLQUFLLEVBQUUsQ0FBYSxFQUFFLEVBQUU7UUFDdkIsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBRW5CLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSztZQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUV4RCx3QkFBd0I7SUFDekIsQ0FBQyxDQUNELENBQUM7SUFFRiw0REFBNEQ7SUFDNUQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBYSxFQUFFLEVBQUU7UUFDeEQsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxlQUFlO1lBQ3RDLElBQUksQ0FBQyxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxlQUFlO2dCQUNuRCxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvRCxDQUFDLENBQUMsQ0FBQztBQUNKLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29sb3JHZW4gLSB2ZXJzaW9uIDAuNi4wLWRldlxuXG4vLyBBdXRob3I6IFZpaWhuYSBMZXJhaW5lICh2aWlobmFAVmlpaG5hVGVjaC5jb20gLyB2aWlobmEuNzggKFNpZ25hbCkgLyBWaWlobmEtTGVocmFpbmUgKEdpdGh1YikpXG4vLyBMaWNlbnNlZCB1bmRlciBHTlUgR1BMdjMgKGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLTMuMC5odG1sKVxuXG4vLyBZb3UgbWF5IHVzZSB0aGlzIGNvZGUgZm9yIGFueSBwdXJwb3NlIEVYQ0VQVCBmb3IgdGhlIGNyZWF0aW9uIG9mIHByb3ByaWV0YXJ5IGRlcml2YXRpdmVzLiBJIGVuY291cmFnZSB5b3UgdG8gaW1wcm92ZSBvbiBteSBjb2RlIG9yIHRvIGluY2x1ZGUgaXQgaW4gb3RoZXIgcHJvamVjdHMgaWYgeW91IGZpbmQgaXQgaGVscGZ1bC4gUGxlYXNlIGNyZWRpdCBtZSBhcyB0aGUgb3JpZ2luYWwgYXV0aG9yLlxuXG4vLyBUaGlzIGFwcGxpY2F0aW9uIGNvbWVzIHdpdGggQUJTT0xVVEVMWSBOTyBXQVJSQU5UWSBPUiBHVUFSQU5URUUgT0YgQU5ZIEtJTkQuXG5cbi8vIEZpbGU6IHNyYy9hcHAuanNcblxuaW1wb3J0IHsgSFNMLCBQYWxldHRlT3B0aW9ucyB9IGZyb20gJy4vaW5kZXgvaW5kZXguanMnO1xuaW1wb3J0IHsgY29yZSwgdXRpbHMgfSBmcm9tICcuL2NvbW1vbi9pbmRleC5qcyc7XG5pbXBvcnQgeyBkYXRhIH0gZnJvbSAnLi9kYXRhL2luZGV4LmpzJztcbmltcG9ydCB7IGRvbSB9IGZyb20gJy4vZG9tL2luZGV4LmpzJztcbmltcG9ydCB7IElEQk1hbmFnZXIgfSBmcm9tICcuL2lkYi9pbmRleC5qcyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuL2xvZ2dlci9pbmRleC5qcyc7XG5pbXBvcnQgeyBzdGFydCB9IGZyb20gJy4vcGFsZXR0ZS9pbmRleC5qcyc7XG5cbmNvbnN0IGJ1dHRvbklEcyA9IGRhdGEuY29uc3RzLmRvbS5pZHM7XG5jb25zdCBjb25zdHMgPSBkYXRhLmNvbnN0cztcbmNvbnN0IG1vZGUgPSBkYXRhLm1vZGU7XG5cbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBhc3luYyAoKSA9PiB7XG5cdGNvbnNvbGUubG9nKCdET00gY29udGVudCBsb2FkZWQgLSBJbml0aWFsaXppbmcgYXBwbGljYXRpb24nKTtcblxuXHRhd2FpdCBkb20ubG9hZFBhcnRpYWxzKCk7XG5cblx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnSFRNTCBwYXJ0aWFscyBsb2FkZWQuIEluaXRpYWxpemluZyBVSS4uLicpO1xuXG5cdGNvbnN0IGJ1dHRvbkVsZW1lbnRzID0gZG9tLmRlZmluZVVJRWxlbWVudHMoKTtcblxuXHRpZiAoIWJ1dHRvbkVsZW1lbnRzKSB7XG5cdFx0aWYgKG1vZGUuZXJyb3JMb2dzKSBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gaW5pdGlhbGl6ZSBVSSBidXR0b25zJyk7XG5cblx0XHRyZXR1cm47XG5cdH1cblxuXHRhd2FpdCBkb20uaW5pdGlhbGl6ZVVJKCk7XG5cblx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnVUkgc3VjY2Vzc2Z1bGx5IGluaXRpYWxpemVkJyk7XG5cblx0Y29uc3QgaWRiID0gSURCTWFuYWdlci5nZXRJbnN0YW5jZSgpO1xuXG5cdGlmICghYnV0dG9uRWxlbWVudHMpIHtcblx0XHRjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gaW5pdGlhbGl6ZSBVSSBidXR0b25zJyk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0Y29uc3Qgc2VsZWN0ZWRDb2xvck9wdGlvbiA9IGNvbnN0cy5kb20uZWxlbWVudHMuc2VsZWN0ZWRDb2xvck9wdGlvbjtcblxuXHRpZiAobW9kZS5kZWJ1Zykge1xuXHRcdGxvZ2dlci5kZWJ1Zy52YWxpZGF0ZURPTUVsZW1lbnRzKCk7XG5cblx0XHRpZiAobW9kZS52ZXJib3NlKSB7XG5cdFx0XHRsb2dnZXIudmVyYm9zZS52YWxpZGF0ZURPTUVsZW1lbnRzKCk7XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdGlmICghbW9kZS5xdWlldCkge1xuXHRcdFx0Y29uc29sZS5sb2coJ1NraXBwaW5nIERPTSBlbGVtZW50IHZhbGlkYXRpb24nKTtcblx0XHR9XG5cdH1cblxuXHRjb25zdCBzZWxlY3RlZENvbG9yID0gc2VsZWN0ZWRDb2xvck9wdGlvblxuXHRcdD8gcGFyc2VJbnQoc2VsZWN0ZWRDb2xvck9wdGlvbi52YWx1ZSwgMTApXG5cdFx0OiAwO1xuXG5cdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coYFNlbGVjdGVkIGNvbG9yOiAke3NlbGVjdGVkQ29sb3J9YCk7XG5cblx0dHJ5IHtcblx0XHRkb20uYWRkQ29udmVyc2lvbkJ1dHRvbkV2ZW50TGlzdGVuZXJzKCk7XG5cblx0XHRpZiAoIW1vZGUucXVpZXQpXG5cdFx0XHRjb25zb2xlLmxvZygnQ29udmVyc2lvbiBidXR0b24gZXZlbnQgbGlzdGVuZXJzIGF0dGFjaGVkJyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0aWYgKG1vZGUuZXJyb3JMb2dzKVxuXHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0YFVuYWJsZSB0byBhdHRhY2ggY29udmVyc2lvbiBidXR0b24gZXZlbnQgbGlzdGVuZXJzOiAke2Vycm9yfWBcblx0XHRcdCk7XG5cdH1cblxuXHQvLyBzaG93IGFkdmFuY2VkIG1lbnVcblx0ZG9tLmJ1dHRvbnMuYWRkRXZlbnRMaXN0ZW5lcihcblx0XHRidXR0b25JRHMuYWR2YW5jZWRNZW51QnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0Y29uc3QgYWR2YW5jZWRNZW51Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXG5cdFx0XHRcdCcuYWR2YW5jZWQtbWVudS1jb250ZW50J1xuXHRcdFx0KSBhcyBIVE1MRWxlbWVudCB8IG51bGw7XG5cblx0XHRcdGlmIChhZHZhbmNlZE1lbnVDb250ZW50KSB7XG5cdFx0XHRcdGNvbnN0IGlzSGlkZGVuID1cblx0XHRcdFx0XHRnZXRDb21wdXRlZFN0eWxlKGFkdmFuY2VkTWVudUNvbnRlbnQpLmRpc3BsYXkgPT09ICdub25lJztcblxuXHRcdFx0XHRhZHZhbmNlZE1lbnVDb250ZW50LnN0eWxlLmRpc3BsYXkgPSBpc0hpZGRlbiA/ICdmbGV4JyA6ICdub25lJztcblx0XHRcdH1cblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnYWR2YW5jZWRNZW51QnV0dG9uIGNsaWNrZWQnKTtcblx0XHR9XG5cdCk7XG5cblx0Ly8gYXBwbHkgY3VzdG9tIGNvbG9yXG5cdGRvbS5idXR0b25zLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0YnV0dG9uSURzLmFwcGx5Q3VzdG9tQ29sb3JCdXR0b24sXG5cdFx0J2NsaWNrJyxcblx0XHRhc3luYyAoZTogTW91c2VFdmVudCkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0XHRjb25zdCBjdXN0b21IU0xDb2xvciA9IGRvbS5hcHBseUN1c3RvbUNvbG9yKCk7XG5cdFx0XHRjb25zdCBjdXN0b21IU0xDb2xvckNsb25lID0gY29yZS5iYXNlLmNsb25lKGN1c3RvbUhTTENvbG9yKTtcblxuXHRcdFx0YXdhaXQgaWRiLnNhdmVEYXRhKFxuXHRcdFx0XHQnY3VzdG9tQ29sb3InLFxuXHRcdFx0XHQnYXBwU2V0dGluZ3MnLFxuXHRcdFx0XHRjdXN0b21IU0xDb2xvckNsb25lXG5cdFx0XHQpO1xuXG5cdFx0XHRpZiAoIW1vZGUucXVpZXQpIGNvbnNvbGUubG9nKCdDdXN0b20gY29sb3Igc2F2ZWQgdG8gSW5kZXhlZERCJyk7XG5cblx0XHRcdC8vICpERVYtTk9URSogdW5maW5pc2hlZFxuXHRcdH1cblx0KTtcblxuXHQvLyBjbGVhciBjdXN0b20gY29sb3Jcblx0ZG9tLmJ1dHRvbnMuYWRkRXZlbnRMaXN0ZW5lcihcblx0XHRidXR0b25JRHMuY2xlYXJDdXN0b21Db2xvckJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGNvbnN0cy5kb20uZWxlbWVudHMuY3VzdG9tQ29sb3JJbnB1dCEudmFsdWUgPSAnI2ZmMDAwMCc7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ0N1c3RvbSBjb2xvciBjbGVhcmVkJyk7XG5cdFx0fVxuXHQpO1xuXG5cdC8vIGNsb3NlIGN1c3RvbSBjb2xvciBtZW51XG5cdGRvbS5idXR0b25zLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0YnV0dG9uSURzLmNsb3NlQ3VzdG9tQ29sb3JNZW51QnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnY2xvc2VDdXN0b21Db2xvck1lbnVCdXR0b24gY2xpY2tlZCcpO1xuXG5cdFx0XHRjb25zdHMuZG9tLmVsZW1lbnRzLmN1c3RvbUNvbG9yTWVudT8uY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XG5cdFx0fVxuXHQpO1xuXG5cdC8vIGNsb3NlIGhlbHAgbWVudVxuXHRkb20uYnV0dG9ucy5hZGRFdmVudExpc3RlbmVyKFxuXHRcdGJ1dHRvbklEcy5jbG9zZUhlbHBNZW51QnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnY2xvc2VIZWxwTWVudUJ1dHRvbiBjbGlja2VkJyk7XG5cblx0XHRcdGNvbnN0cy5kb20uZWxlbWVudHMuYWR2YW5jZWRNZW51Py5jbGFzc0xpc3QuYWRkKCdoaWRkZW4nKTtcblx0XHR9XG5cdCk7XG5cblx0Ly8gY2xvc2UgaGlzdG9yeSBtZW51XG5cdGRvbS5idXR0b25zLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0YnV0dG9uSURzLmNsb3NlSGlzdG9yeU1lbnVCdXR0b24sXG5cdFx0J2NsaWNrJyxcblx0XHRhc3luYyAoZTogTW91c2VFdmVudCkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0XHRpZiAoIW1vZGUucXVpZXQpIGNvbnNvbGUubG9nKCdjbG9zZUhpc3RvcnlNZW51QnV0dG9uIGNsaWNrZWQnKTtcblxuXHRcdFx0Y29uc3RzLmRvbS5lbGVtZW50cy5oaXN0b3J5TWVudT8uY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XG5cdFx0fVxuXHQpO1xuXG5cdGlmICghY29uc3RzLmRvbS5lbGVtZW50cy5jdXN0b21Db2xvcklucHV0KVxuXHRcdHRocm93IG5ldyBFcnJvcignQ3VzdG9tIGNvbG9yIGlucHV0IGVsZW1lbnQgbm90IGZvdW5kJyk7XG5cblx0Y29uc3RzLmRvbS5lbGVtZW50cy5jdXN0b21Db2xvcklucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKCkgPT4ge1xuXHRcdGlmICghY29uc3RzLmRvbS5lbGVtZW50cy5jdXN0b21Db2xvckRpc3BsYXkpXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0N1c3RvbSBjb2xvciBkaXNwbGF5IGVsZW1lbnQgbm90IGZvdW5kJyk7XG5cblx0XHRjb25zdHMuZG9tLmVsZW1lbnRzLmN1c3RvbUNvbG9yRGlzcGxheS50ZXh0Q29udGVudCA9XG5cdFx0XHRjb25zdHMuZG9tLmVsZW1lbnRzLmN1c3RvbUNvbG9ySW5wdXQhLnZhbHVlO1xuXHR9KTtcblxuXHQvLyBkaXNwbGF5IGN1c3RvbSBjb2xvciBtZW51XG5cdGRvbS5idXR0b25zLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0YnV0dG9uSURzLmN1c3RvbUNvbG9yTWVudUJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ2N1c3RvbUNvbG9yTWVudUJ1dHRvbiBjbGlja2VkJyk7XG5cblx0XHRcdGNvbnN0cy5kb20uZWxlbWVudHMuY3VzdG9tQ29sb3JNZW51Py5jbGFzc0xpc3QucmVtb3ZlKCdoaWRkZW4nKTtcblx0XHR9XG5cdCk7XG5cblx0Ly8gZGVzYXR1cmF0ZSBCdXR0b25cblx0ZG9tLmJ1dHRvbnMuYWRkRXZlbnRMaXN0ZW5lcihcblx0XHRidXR0b25JRHMuZGVzYXR1cmF0ZUJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ2Rlc2F0dXJhdGVCdXR0b24gY2xpY2tlZCcpO1xuXG5cdFx0XHRkb20uZGVzYXR1cmF0ZUNvbG9yKHNlbGVjdGVkQ29sb3IpO1xuXHRcdH1cblx0KTtcblxuXHQvLyBNQUlOIC0gZ2VuZXJhdGUgcGFsZXR0ZVxuXHRkb20uYnV0dG9ucy5hZGRFdmVudExpc3RlbmVyKFxuXHRcdGJ1dHRvbklEcy5nZW5lcmF0ZUJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ2dlbmVyYXRlQnV0dG9uIGNsaWNrZWQnKTtcblxuXHRcdFx0Y29uc3Qge1xuXHRcdFx0XHRwYWxldHRlVHlwZSxcblx0XHRcdFx0bnVtQm94ZXMsXG5cdFx0XHRcdGVuYWJsZUFscGhhLFxuXHRcdFx0XHRsaW1pdERhcmtuZXNzLFxuXHRcdFx0XHRsaW1pdEdyYXluZXNzLFxuXHRcdFx0XHRsaW1pdExpZ2h0bmVzc1xuXHRcdFx0fSA9IGRvbS5wdWxsUGFyYW1zRnJvbVVJKCk7XG5cblx0XHRcdGxldCBjdXN0b21Db2xvciA9IChhd2FpdCBpZGIuZ2V0Q3VzdG9tQ29sb3IoKSkgYXMgSFNMIHwgbnVsbDtcblxuXHRcdFx0aWYgKCFjdXN0b21Db2xvcikge1xuXHRcdFx0XHRpZiAoIW1vZGUucXVpZXQpXG5cdFx0XHRcdFx0Y29uc29sZS5pbmZvKCdObyBjdXN0b20gY29sb3IgZm91bmQuIFVzaW5nIGEgcmFuZG9tIGNvbG9yJyk7XG5cblx0XHRcdFx0Y3VzdG9tQ29sb3IgPSB1dGlscy5yYW5kb20uaHNsKHRydWUpO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBwYWxldHRlT3B0aW9uczogUGFsZXR0ZU9wdGlvbnMgPSB7XG5cdFx0XHRcdHBhbGV0dGVUeXBlLFxuXHRcdFx0XHRudW1Cb3hlcyxcblx0XHRcdFx0Y3VzdG9tQ29sb3I6IGNvcmUuYmFzZS5jbG9uZShjdXN0b21Db2xvciksXG5cdFx0XHRcdGVuYWJsZUFscGhhLFxuXHRcdFx0XHRsaW1pdERhcmtuZXNzLFxuXHRcdFx0XHRsaW1pdEdyYXluZXNzLFxuXHRcdFx0XHRsaW1pdExpZ2h0bmVzc1xuXHRcdFx0fTtcblxuXHRcdFx0YXdhaXQgc3RhcnQuZ2VuUGFsZXR0ZShwYWxldHRlT3B0aW9ucyk7XG5cdFx0fVxuXHQpO1xuXG5cdC8vIG9wZW4gSGVscCBNZW51XG5cdGRvbS5idXR0b25zLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0YnV0dG9uSURzLmhlbHBNZW51QnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0Y29uc3QgaGVscE1lbnVDb250ZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihcblx0XHRcdFx0Jy5oZWxwLW1lbnUtY29udGVudCdcblx0XHRcdCkgYXMgSFRNTEVsZW1lbnQgfCBudWxsO1xuXG5cdFx0XHRpZiAoaGVscE1lbnVDb250ZW50KSB7XG5cdFx0XHRcdGNvbnN0IGlzSGlkZGVuID1cblx0XHRcdFx0XHRnZXRDb21wdXRlZFN0eWxlKGhlbHBNZW51Q29udGVudCkuZGlzcGxheSA9PT0gJ25vbmUnO1xuXG5cdFx0XHRcdGhlbHBNZW51Q29udGVudC5zdHlsZS5kaXNwbGF5ID0gaXNIaWRkZW4gPyAnZmxleCcgOiAnbm9uZSc7XG5cblx0XHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnaGVscE1lbnVCdXR0b24gY2xpY2tlZCcpO1xuXHRcdFx0fVxuXHRcdH1cblx0KTtcblxuXHQvLyBvcGVuIEhpc3RvcnkgTWVudVxuXHRkb20uYnV0dG9ucy5hZGRFdmVudExpc3RlbmVyKFxuXHRcdGJ1dHRvbklEcy5oaXN0b3J5TWVudUJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGNvbnN0IGhpc3RvcnlNZW51Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXG5cdFx0XHRcdCcuaGlzdG9yeS1tZW51LWNvbnRlbnQnXG5cdFx0XHQpIGFzIEhUTUxFbGVtZW50IHwgbnVsbDtcblxuXHRcdFx0aWYgKGhpc3RvcnlNZW51Q29udGVudCkge1xuXHRcdFx0XHRjb25zdCBpc0hpZGRlbiA9XG5cdFx0XHRcdFx0Z2V0Q29tcHV0ZWRTdHlsZShoaXN0b3J5TWVudUNvbnRlbnQpLmRpc3BsYXkgPT09ICdub25lJztcblxuXHRcdFx0XHRoaXN0b3J5TWVudUNvbnRlbnQuc3R5bGUuZGlzcGxheSA9IGlzSGlkZGVuID8gJ2ZsZXgnIDogJ25vbmUnO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIW1vZGUucXVpZXQpIGNvbnNvbGUubG9nKCdoaXN0b3J5TWVudVRvZ2dsZUJ1dHRvbiBjbGlja2VkJyk7XG5cdFx0fVxuXHQpO1xuXG5cdC8vIHNhdHVyYXRlIHNlbGVjdGVkIGNvbG9yXG5cdGRvbS5idXR0b25zLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0YnV0dG9uSURzLnNhdHVyYXRlQnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnc2F0dXJhdGVCdXR0b24gY2xpY2tlZCcpO1xuXG5cdFx0XHRkb20uc2F0dXJhdGVDb2xvcihzZWxlY3RlZENvbG9yKTtcblx0XHR9XG5cdCk7XG5cblx0ZG9tLmJ1dHRvbnMuYWRkRXZlbnRMaXN0ZW5lcihcblx0XHRidXR0b25JRHMuc2hvd0FzQ01ZS0J1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ3Nob3dBc0NNWUtCdXR0b24gY2xpY2tlZCcpO1xuXG5cdFx0XHQvLyAqREVWLU5PVEUqIHVuZmluaXNoZWRcblx0XHR9XG5cdCk7XG5cblx0ZG9tLmJ1dHRvbnMuYWRkRXZlbnRMaXN0ZW5lcihcblx0XHRidXR0b25JRHMuc2hvd0FzSGV4QnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnc2hvd0FzSGV4QnV0dG9uIGNsaWNrZWQnKTtcblxuXHRcdFx0Ly8gKkRFVi1OT1RFKiB1bmZpbmlzaGVkXG5cdFx0fVxuXHQpO1xuXG5cdGRvbS5idXR0b25zLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0YnV0dG9uSURzLnNob3dBc0hTTEJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ3Nob3dBc0hTTEJ1dHRvbiBjbGlja2VkJyk7XG5cblx0XHRcdC8vICpERVYtTk9URSogdW5maW5pc2hlZFxuXHRcdH1cblx0KTtcblxuXHRkb20uYnV0dG9ucy5hZGRFdmVudExpc3RlbmVyKFxuXHRcdGJ1dHRvbklEcy5zaG93QXNIU1ZCdXR0b24sXG5cdFx0J2NsaWNrJyxcblx0XHRhc3luYyAoZTogTW91c2VFdmVudCkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0XHRpZiAoIW1vZGUucXVpZXQpIGNvbnNvbGUubG9nKCdzaG93QXNIU1ZCdXR0b24gY2xpY2tlZCcpO1xuXG5cdFx0XHQvLyAqREVWLU5PVEUqIHVuZmluaXNoZWRcblx0XHR9XG5cdCk7XG5cblx0ZG9tLmJ1dHRvbnMuYWRkRXZlbnRMaXN0ZW5lcihcblx0XHRidXR0b25JRHMuc2hvd0FzTEFCQnV0dG9uLFxuXHRcdCdjbGljaycsXG5cdFx0YXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0aWYgKCFtb2RlLnF1aWV0KSBjb25zb2xlLmxvZygnc2hvd0FzTEFCQnV0dG9uIGNsaWNrZWQnKTtcblxuXHRcdFx0Ly8gKkRFVi1OT1RFKiB1bmZpbmlzaGVkXG5cdFx0fVxuXHQpO1xuXG5cdGRvbS5idXR0b25zLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0YnV0dG9uSURzLnNob3dBc1JHQkJ1dHRvbixcblx0XHQnY2xpY2snLFxuXHRcdGFzeW5jIChlOiBNb3VzZUV2ZW50KSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdGlmICghbW9kZS5xdWlldCkgY29uc29sZS5sb2coJ3Nob3dBc1JHQkJ1dHRvbiBjbGlja2VkJyk7XG5cblx0XHRcdC8vICpERVYtTk9URSogdW5maW5pc2hlZFxuXHRcdH1cblx0KTtcblxuXHQvLyBjbG9zZSBDdXN0b20gQ29sb3IgTWVudSB3aGVuIGNsaWNraW5nIG91dHNpZGUgdGhlIGNvbnRlbnRcblx0d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGU6IE1vdXNlRXZlbnQpID0+IHtcblx0XHRpZiAoY29uc3RzLmRvbS5lbGVtZW50cy5jdXN0b21Db2xvck1lbnUpXG5cdFx0XHRpZiAoZS50YXJnZXQgPT09IGNvbnN0cy5kb20uZWxlbWVudHMuY3VzdG9tQ29sb3JNZW51KVxuXHRcdFx0XHRjb25zdHMuZG9tLmVsZW1lbnRzLmN1c3RvbUNvbG9yTWVudS5jbGFzc0xpc3QuYWRkKCdoaWRkZW4nKTtcblx0fSk7XG59KTtcbiJdfQ==